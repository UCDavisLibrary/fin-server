(window["webpackJsonp"] = window["webpackJsonp"] || []).push([["vendors~csl"],{

/***/ "../node_modules/webpack/buildin/module.js":
/*!*************************************************!*\
  !*** ../node_modules/webpack/buildin/module.js ***!
  \*************************************************/
/*! no static exports found */
/***/ (function(module, exports) {

module.exports = function(module) {
	if (!module.webpackPolyfill) {
		module.deprecate = function() {};
		module.paths = [];
		// module.parent = undefined by default
		if (!module.children) module.children = [];
		Object.defineProperty(module, "loaded", {
			enumerable: true,
			get: function() {
				return module.l;
			}
		});
		Object.defineProperty(module, "id", {
			enumerable: true,
			get: function() {
				return module.i;
			}
		});
		module.webpackPolyfill = 1;
	}
	return module;
};


/***/ }),

/***/ "./public/node_modules/citeproc/citeproc_commonjs.js":
/*!***********************************************************!*\
  !*** ./public/node_modules/citeproc/citeproc_commonjs.js ***!
  \***********************************************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

/* WEBPACK VAR INJECTION */(function(module) {/*
 * Copyright (c) 2009-2016 Frank Bennett
 * 
 * 	This program is free software: you can redistribute it and/or
 * 	modify it under EITHER
 * 
 *       * the terms of the Common Public Attribution License (CPAL) as
 * 	    published by the Open Source Initiative, either version 1 of
 * 	    the CPAL, or (at your option) any later version; OR
 * 
 *       * the terms of the GNU Affero General Public License (AGPL)
 *         as published by the Free Software Foundation, either version
 *         3 of the AGPL, or (at your option) any later version.
 * 
 * 	This program is distributed in the hope that it will be useful,
 * 	but WITHOUT ANY WARRANTY; without even the implied warranty of
 * 	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * 	Affero General Public License for more details.
 * 
 * 	You should have received copies of the Common Public Attribution
 *     License and of the GNU Affero General Public License along with
 *     this program.  If not, see <https://opensource.org/licenses/> or
 *     <http://www.gnu.org/licenses/> respectively.
 */

var CSL = {
    PROCESSOR_VERSION: "1.1.206",
    CONDITION_LEVEL_TOP: 1,
    CONDITION_LEVEL_BOTTOM: 2,
    PLAIN_HYPHEN_REGEX: /(?:[^\\]-|\u2013)/,
    LOCATOR_LABELS_REGEXP: new RegExp("^((art|ch|subch|col|fig|l|n|no|op|p|pp|para|subpara|pt|r|sec|subsec|sv|sch|tit|vrs|vol)\\.)\\s+(.*)"),
    STATUTE_SUBDIV_GROUPED_REGEX: /((?:^| )(?:art|bk|ch|subch|col|fig|fol|l|n|no|op|p|pp|para|subpara|pt|r|sec|subsec|sv|sch|tit|vrs|vol)\. *)/g,
    STATUTE_SUBDIV_PLAIN_REGEX: /(?:(?:^| )(?:art|bk|ch|subch|col|fig|fol|l|n|no|op|p|pp|para|subpara|pt|r|sec|subsec|sv|sch|tit|vrs|vol)\. *)/,
    STATUTE_SUBDIV_PLAIN_REGEX_FRONT: /(?:^\s*[.,;]*\s*(?:art|bk|ch|subch|col|fig|fol|l|n|no|op|p|pp|para|subpara|pt|r|sec|subsec|sv|sch|tit|vrs|vol)\. *)/,
    STATUTE_SUBDIV_STRINGS: {
        "art.": "article",
        "bk.": "book",
        "ch.": "chapter",
        "subch.": "subchapter",
        "p.": "page",
        "pp.": "page",
        "para.": "paragraph",
        "subpara.": "subparagraph",
        "pt.": "part",
        "r.": "rule",
        "sec.": "section",
        "subsec.": "subsection",
        "sch.": "schedule",
        "tit.": "title",
        "col.": "column",
        "fig.": "figure",
        "fol.": "folio",
        "l.": "line",
        "n.": "note",
        "no.": "issue",
        "op.": "opus",
        "sv.": "sub-verbo",
        "vrs.": "verse",
        "vol.": "volume"
    },
    STATUTE_SUBDIV_STRINGS_REVERSE: {
        "article": "art.",
        "book": "bk.",
        "chapter": "ch.",
        "subchapter": "subch.",
        "page": "p.",
        "paragraph": "para.",
        "subparagraph": "subpara.",
        "part": "pt.",
        "rule": "r.",
        "section": "sec.",
        "subsection": "subsec.",
        "schedule": "sch.",
        "title": "tit.",
        "column": "col.",
        "figure": "fig.",
        "folio": "fol.",
        "line": "l.",
        "note": "n.",
        "issue": "no.",
        "opus": "op.",
        "sub-verbo": "sv.",
        "sub verbo": "sv.",
        "verse": "vrs.",
        "volume": "vol."
    },
    LOCATOR_LABELS_MAP: {
        "art": "article",
        "bk": "book",
        "ch": "chapter",
        "subch": "subchapter",
        "col": "column",
        "fig": "figure",
        "fol": "folio",
        "l": "line",
        "n": "note",
        "no": "issue",
        "op": "opus",
        "p": "page",
        "pp": "page",
        "para": "paragraph",
        "subpara": "subparagraph",
        "pt": "part",
        "r": "rule",
		"sec": "section",
		"subsec": "subsection",
		"sv": "sub-verbo",
        "sch": "schedule",
        "tit": "title",
        "vrs": "verse",
        "vol": "volume"
    },
    MODULE_MACROS: {
        "juris-pretitle": true,
        "juris-title": true,
        "juris-pretitle-short": true,
        "juris-title-short": true,
        "juris-main": true,
        "juris-main-short": true,
        "juris-tail": true,
        "juris-tail-short": true,
        "juris-locator": true
    },
    MODULE_TYPES: {
        "legal_case": true,
        "legislation": true,
        "bill": true,
        "hearing": true,
        "gazette": true,
        "report": true,
        "regulation": true,
        "standard": true
    },
    NestedBraces: [
        ["(", "["],
        [")", "]"]
    ],
    checkNestedBrace: function(state) {
        if (state.opt.xclass === "note") {
            this.depth = 0;
            this.update = function(str) {
                var str = str ? str : '';
                var lst = str.split(/([\(\)])/);
                for (var i=1,ilen=lst.length;i<ilen;i += 2) {
                    if (lst[i] === '(') {
                        if (1 === (this.depth % 2)) {
                            lst[i] = '['
                        }
                        this.depth += 1;
                    } else if (lst[i] === ')') {
                        if (0 === (this.depth % 2)) {
                            lst[i] = ']'
                        }
                        this.depth -= 1;
                    }
                }
                var ret = lst.join("");
                return ret;
            }
        } else {
            this.update = function(str) {
                return str;
            }
        };
    },
    MULTI_FIELDS: ["event", "publisher", "publisher-place", "event-place", "title", "container-title", "collection-title", "authority","genre","title-short","medium","country","jurisdiction","archive","archive-place"],
    LangPrefsMap: {
        "title":"titles",
        "title-short":"titles",
        "event":"titles",
        "genre":"titles",
        "medium":"titles",
        "container-title":"journals",
        "collection-title":"journals",
        "archive":"journals",
        "publisher":"publishers",
        "authority":"publishers",
        "publisher-place": "places",
        "event-place": "places",
        "archive-place": "places",
        "jurisdiction": "places",
        "number": "number",
        "edition":"number",
        "issue":"number",
        "volume":"number"
    },
    AbbreviationSegments: function () {
        this["container-title"] = {};
        this["collection-title"] = {};
        this["institution-entire"] = {};
        this["institution-part"] = {};
        this.nickname = {};
        this.number = {};
        this.title = {};
        this.place = {};
        this.hereinafter = {};
        this.classic = {};
        this["container-phrase"] = {};
        this["title-phrase"] = {};
    },
    FIELD_CATEGORY_REMAP: {
        "title": "title",
        "container-title": "container-title",
        "collection-title": "collection-title",
        "country": "place",
        "number": "number",
        "place": "place",
        "archive": "collection-title",
        "title-short": "title",
        "genre": "title",
        "event": "title",
        "medium": "title",
		"archive-place": "place",
		"publisher-place": "place",
		"event-place": "place",
		"jurisdiction": "place",
		"language-name": "place",
		"language-name-original": "place",
        "call-number": "number",
        "chapter-number": "number",
        "collection-number": "number",
        "edition": "number",
        "page": "number",
        "issue": "number",
        "locator": "number",
        "number-of-pages": "number",
        "number-of-volumes": "number",
        "volume": "number",
        "citation-number": "number",
        "publisher": "institution-part"
    },
    parseLocator: function(item) {
        if (this.opt.development_extensions.locator_date_and_revision) {
            if (item.locator) {
                item.locator = "" + item.locator;
                var idx = item.locator.indexOf("|");
                if (idx > -1) {
                    var raw_locator = item.locator;
                    item.locator = raw_locator.slice(0, idx);
                    raw_locator = raw_locator.slice(idx + 1);
                    var m = raw_locator.match(/^([0-9]{4}-[0-9]{2}-[0-9]{2}).*/);
                    if (m) {
                        item["locator-date"] = this.fun.dateparser.parseDateToObject(m[1]);
                        raw_locator = raw_locator.slice(m[1].length);
                    }
                    item["locator-extra"] = raw_locator.replace(/^\s+/, "").replace(/\s+$/, "");
                }
            }
        }
        if (item.locator) {
            item.locator = ("" + item.locator).replace(/\s+$/, '');
        }
        return item;
    },
    normalizeLocaleStr: function(str) {
        if (!str) return;
        var lst = str.split('-');
        lst[0] = lst[0].toLowerCase();
        if (lst[1]) {
            lst[1] = lst[1].toUpperCase();
        }
        return lst.join("-");
    },
    isDatePart: function(str, less, more) {
        if (str.length > less && str.length < more && parseInt(str)) {
            return true
        } else {
            return false;
        }
    },
    isDateString: function(str) {
        if (!str) return false;
        var strLst = str.split("-");
        if (strLst.length > 0) {
            if (!isDatePart(strLst[0], 3, 5)) {
                return false;
            }
        }
        if (strLst.length > 1) {
            if (!isDatePart(strLst[1], 0, 3)) {
                return false
            }
        }
        if (strLst.length > 2) {
            if (!isDatePart(strLst[2], 0, 3)) {
                return false
            }
        }
        if (strLst.length > 3) {
            return false;
        }
        return true;
    },
    parseNoteFieldHacks: function(Item, validFieldsForType, allowDateOverride) {
        if ("string" !== typeof Item.note) return;
        var elems = [];
        var lines = Item.note.split('\n');
        var lastline = "";
        for (var i=0, ilen=lines.length; i<ilen; i++) {
            var line = lines[i];
            var elems = [];
            var m = line.match(CSL.NOTE_FIELDS_REGEXP);
            if (m) {
                var splt = line.split(CSL.NOTE_FIELDS_REGEXP);
                for (var j=0,jlen=(splt.length-1);j<jlen;j++) {
                    elems.push(splt[j]);
                    elems.push(m[j]);
                }
                elems.push(splt[splt.length-1])
                for (var j=1,jlen=elems.length;j<jlen;j += 2) {
                    if (elems[j-1].trim() && (i>0 || j>1) && !elems[j-1].match(CSL.NOTE_FIELD_REGEXP)) {
                        break
                    } else {
                        elems[j] = '\n' + elems[j].slice(2,-1).trim() + '\n';
                    }
                }
                lines[i] = elems.join('');
            }
        }
        lines = lines.join('\n').split('\n');
        var offset = 0;
        var names = {};
        for (var i=0,ilen=lines.length;i<ilen;i++) {
            var line = lines[i];
            var mm = line.match(CSL.NOTE_FIELD_REGEXP);
            if (!line.trim()) {
                continue;
            } else if (!mm) {
                if (i === 0) {
                    continue;
                } else {
                    offset = i;
                    break;
                }
            }
            var key = mm[1];
            var val = mm[2].replace(/^\s+/, "").replace(/\s+$/, "");
            if (key === "type") {
                Item.type = val;
                lines[i] = "";
            } else if (CSL.DATE_VARIABLES.indexOf(key) > -1) {
                if (allowDateOverride) {
                    Item[key] = {raw: val};
                    if (!validFieldsForType || (validFieldsForType[key] && isDateString(val))) {
                        lines[i] = "";
                    }
                }
            } else if (!Item[key]) {
                if (CSL.NAME_VARIABLES.indexOf(key) > -1) {
                    if (!names[key]) {
                        names[key] = [];
                    }
                    var lst = val.split(/\s*\|\|\s*/);
                    if (lst.length === 1) {
                        names[key].push({literal:lst[0]});
                    } else if (lst.length === 2) {
                        var name = {family:lst[0],given:lst[1]};
                        CSL.parseParticles(name);
                        names[key].push(name);
                    }
                } else {
                    Item[key] = val;
                }
                if (!validFieldsForType || validFieldsForType[key]) {
                    lines[i] = "";
                }
            }
        }
        for (var key in names) {
            Item[key] = names[key];
        }
        if (validFieldsForType) {
            if (lines[offset].trim()) {
                lines[offset] = '\n' + lines[offset]
            }
            for (var i=offset-1;i>-1;i--) {
                if (!lines[i].trim()) {
                    lines = lines.slice(0, i).concat(lines.slice(i + 1));
                }
            }
        }
        Item.note = lines.join("\n").trim();
    },
    GENDERS: ["masculine", "feminine"],
    ERROR_NO_RENDERED_FORM: 1,
    PREVIEW: "Just for laughs.",
    ASSUME_ALL_ITEMS_REGISTERED: 2,
    START: 0,
    END: 1,
    SINGLETON: 2,
    SEEN: 6,
    SUCCESSOR: 3,
    SUCCESSOR_OF_SUCCESSOR: 4,
    SUPPRESS: 5,
    SINGULAR: 0,
    PLURAL: 1,
    LITERAL: true,
    BEFORE: 1,
    AFTER: 2,
    DESCENDING: 1,
    ASCENDING: 2,
    ONLY_FIRST: 1,
    ALWAYS: 2,
    ONLY_LAST: 3,
    FINISH: 1,
    POSITION_FIRST: 0,
    POSITION_SUBSEQUENT: 1,
    POSITION_IBID: 2,
    POSITION_IBID_WITH_LOCATOR: 3,
    MARK_TRAILING_NAMES: true,
    POSITION_TEST_VARS: ["position", "first-reference-note-number", "near-note"],
    AREAS: ["citation", "citation_sort", "bibliography", "bibliography_sort"],
    CITE_FIELDS: ["first-reference-note-number", "locator", "locator-extra"],
    MINIMAL_NAME_FIELDS: ["literal", "family"],
    SWAPPING_PUNCTUATION: [".", "!", "?", ":", ","],
    TERMINAL_PUNCTUATION: [":", ".", ";", "!", "?", " "],
    NONE: 0,
    NUMERIC: 1,
    POSITION: 2,
    COLLAPSE_VALUES: ["citation-number", "year", "year-suffix"],
    DATE_PARTS: ["year", "month", "day"],
    DATE_PARTS_ALL: ["year", "month", "day", "season"],
    DATE_PARTS_INTERNAL: ["year", "month", "day", "year_end", "month_end", "day_end"],
    NAME_PARTS: ["non-dropping-particle", "family", "given", "dropping-particle", "suffix", "literal"],
    DECORABLE_NAME_PARTS: ["given", "family", "suffix"],
    DISAMBIGUATE_OPTIONS: [
        "disambiguate-add-names",
        "disambiguate-add-givenname",
        "disambiguate-add-year-suffix"
    ],
    GIVENNAME_DISAMBIGUATION_RULES: [
        "all-names",
        "all-names-with-initials",
        "primary-name",
        "primary-name-with-initials",
        "by-cite"
    ],
    NAME_ATTRIBUTES: [
        "and",
        "delimiter-precedes-last",
        "delimiter-precedes-et-al",
        "initialize-with",
        "initialize",
        "name-as-sort-order",
        "sort-separator",
        "et-al-min",
        "et-al-use-first",
        "et-al-subsequent-min",
        "et-al-subsequent-use-first",
        "form",
        "prefix",
        "suffix",
        "delimiter"
    ],
    PARALLEL_MATCH_VARS: ["container-title"],
    PARALLEL_TYPES: ["bill","gazette","regulation","legislation","legal_case","treaty","article-magazine","article-journal"],
    PARALLEL_COLLAPSING_MID_VARSET: ["volume", "issue", "container-title", "section", "collection-number"],
    LOOSE: 0,
    STRICT: 1,
    TOLERANT: 2,
    PREFIX_PUNCTUATION: /[.;:]\s*$/,
    SUFFIX_PUNCTUATION: /^\s*[.;:,\(\)]/,
    NUMBER_REGEXP: /(?:^\d+|\d+$)/,
    NAME_INITIAL_REGEXP: /^([A-Z\u00c0-\u017f\u0400-\u042f\u0590-\u05d4\u05d6-\u05ff\u0600-\u06ff\u0370\u0372\u0376\u0386\u0388-\u03ab\u03e2\u03e4\u03e6\u03e8\u03ea\u03ec\u03ee\u03f4\u03f7\u03fd-\u03ff])([a-zA-Z\u00c0-\u017f\u0400-\u052f\u0600-\u06ff\u0370-\u03ff\u1f00-\u1fff]*|)/,
    ROMANESQUE_REGEXP: /[-0-9a-zA-Z\u00c0-\u017f\u0370-\u03ff\u0400-\u052f\u0590-\u05d4\u05d6-\u05ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/,
    ROMANESQUE_NOT_REGEXP: /[^a-zA-Z\u00c0-\u017f\u0370-\u03ff\u0400-\u052f\u0590-\u05d4\u05d6-\u05ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/g,
    STARTSWITH_ROMANESQUE_REGEXP: /^[&a-zA-Z\u00c0-\u017f\u0370-\u03ff\u0400-\u052f\u0590-\u05d4\u05d6-\u05ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/,
    ENDSWITH_ROMANESQUE_REGEXP: /[.;:&a-zA-Z\u00c0-\u017f\u0370-\u03ff\u0400-\u052f\u0590-\u05d4\u05d6-\u05ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]$/,
    ALL_ROMANESQUE_REGEXP: /^[a-zA-Z\u00c0-\u017f\u0370-\u03ff\u0400-\u052f\u0590-\u05d4\u05d6-\u05ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]+$/,
    VIETNAMESE_SPECIALS: /[\u00c0-\u00c3\u00c8-\u00ca\u00cc\u00cd\u00d2-\u00d5\u00d9\u00da\u00dd\u00e0-\u00e3\u00e8-\u00ea\u00ec\u00ed\u00f2-\u00f5\u00f9\u00fa\u00fd\u0101\u0103\u0110\u0111\u0128\u0129\u0168\u0169\u01a0\u01a1\u01af\u01b0\u1ea0-\u1ef9]/,
    VIETNAMESE_NAMES: /^(?:(?:[.AaBbCcDdEeGgHhIiKkLlMmNnOoPpQqRrSsTtUuVvXxYy \u00c0-\u00c3\u00c8-\u00ca\u00cc\u00cd\u00d2-\u00d5\u00d9\u00da\u00dd\u00e0-\u00e3\u00e8-\u00ea\u00ec\u00ed\u00f2-\u00f5\u00f9\u00fa\u00fd\u0101\u0103\u0110\u0111\u0128\u0129\u0168\u0169\u01a0\u01a1\u01af\u01b0\u1ea0-\u1ef9]{2,6})(\s+|$))+$/,
    NOTE_FIELDS_REGEXP: /\{:(?:[\-_a-z]+|[A-Z]+):[^\}]+\}/g,
    NOTE_FIELD_REGEXP: /^([\-_a-z]+|[A-Z]+):\s*([^\}]+)$/,
	PARTICLE_GIVEN_REGEXP: /^([^ ]+(?:\u02bb |\u2019 | |\' ) *)(.+)$/,
	PARTICLE_FAMILY_REGEXP: /^([^ ]+(?:\-|\u02bb|\u2019| |\') *)(.+)$/,
    DISPLAY_CLASSES: ["block", "left-margin", "right-inline", "indent"],
    NAME_VARIABLES: [
        "author",
        "editor",
        "translator",
        "contributor",
        "collection-editor",
        "composer",
        "container-author",
        "director",
        "editorial-director",
        "interviewer",
        "original-author",
        "recipient"
    ],
    NUMERIC_VARIABLES: [
        "call-number",
        "chapter-number",
        "collection-number",
        "edition",
        "page",
        "issue",
        "locator",
        "number",
        "number-of-pages",
        "number-of-volumes",
        "volume",
        "citation-number"
    ],
    DATE_VARIABLES: [
        "locator-date", 
        "issued", 
        "event-date", 
        "accessed", 
        "container", 
        "original-date",
        "publication-date",
        "original-date",
        "available-date",
        "submitted"
    ],
    TITLE_FIELD_SPLITS: function(seg) {
        var keys = ["title", "short", "main", "sub"];
        var ret = {};
        for (var i=0,ilen=keys.length;i<ilen;i++) {
            ret[keys[i]] = seg + "title" + (keys[i] === "title" ? "" : "-" + keys[i]);
        }
        return ret;
    },
    TAG_USEALL: function (str) {
        var ret, open, close, end;
        ret = [""];
        open = str.indexOf("<");
        close = str.indexOf(">");
        while (open > -1 && close > -1) {
            if (open > close) {
                end = open + 1;
            } else {
                end = close + 1;
            }
            if (open < close && str.slice(open + 1, close).indexOf("<") === -1) {
                ret[ret.length - 1] += str.slice(0, open);
                ret.push(str.slice(open, close + 1));
                ret.push("");
                str = str.slice(end);
            } else {
                ret[ret.length - 1] += str.slice(0, close + 1);
                str = str.slice(end);
            }
            open = str.indexOf("<");
            close = str.indexOf(">");
        }
        ret[ret.length - 1] += str;
        return ret;
    },
    demoteNoiseWords: function (state, fld, drop_or_demote) {
        var SKIP_WORDS = state.locale[state.opt.lang].opts["leading-noise-words"];
        if (fld && drop_or_demote) {
            fld = fld.split(/\s+/);
            fld.reverse();
            var toEnd = [];
            for (var j  = fld.length - 1; j > -1; j += -1) {
                if (SKIP_WORDS.indexOf(fld[j].toLowerCase()) > -1) {
                    toEnd.push(fld.pop());
                } else {
                    break;
                }
            }
            fld.reverse();
            var start = fld.join(" ");
            var end = toEnd.join(" ");
            if ("drop" === drop_or_demote || !end) {
                fld = start;
            } else if ("demote" === drop_or_demote) {
                fld = [start, end].join(", ");
            }
        }
        return fld;
    },
    extractTitleAndSubtitle: function (Item) {
        var segments = ["", "container-"];
        for (var i=0,ilen=segments.length;i<ilen;i++) {
            var seg = segments[i];
            var title = CSL.TITLE_FIELD_SPLITS(seg);
            var langs = [false];
            if (Item.multi) {
                for (var lang in Item.multi._keys[title.short]) {
                    langs.push(lang);
                }
            }
            for (var j=0,jlen=langs.length;j<ilen;j++) {
                var lang = langs[j];
                var vals = {};
                if (lang) {
                    if (Item.multi._keys[title.title]) {
                        vals[title.title] = Item.multi._keys[title.title][lang];
                    }
                    if (Item.multi._keys[title["short"]]) {
                        vals[title["short"]] = Item.multi._keys[title["short"]][lang];
                    }
                } else {
                    vals[title.title] = Item[title.title];
                    vals[title["short"]] = Item[title["short"]];
                }
                vals[title.main] = vals[title.title];
                vals[title.sub] = false;
                if (vals[title.title] && vals[title["short"]]) {
                    var shortTitle = vals[title["short"]];
                    var offset = shortTitle.length;
                    if (vals[title.title].slice(0,offset) === shortTitle && vals[title.title].slice(offset).match(/^\s*:/)) {
                        vals[title.main] = vals[title.title].slice(0,offset).replace(/\s+$/,"");
                        vals[title.sub] = vals[title.title].slice(offset).replace(/^\s*:\s*/,"");
                    }
                }
                if (lang) {
                    for (var key in vals) {
                        if (!Item.multi._keys[key]) {
                            Item.multi._keys[key] = {};
                        }
                        Item.multi._keys[key][lang] = vals[key];
                    }
                } else {
                    for (var key in vals) {
                        Item[key] = vals[key];
                    }
                }
            }
        }
    },
    titlecaseSentenceOrNormal: function(state, Item, seg, lang, sentenceCase) {
        var title = CSL.TITLE_FIELD_SPLITS(seg);
        var vals = {};
        if (lang && Item.multi) {
            if (Item.multi._keys[title.title]) {
                vals[title.title] = Item.multi._keys[title.title][lang];
            }
            if (Item.multi._keys[title.main]) {
                vals[title.main] = Item.multi._keys[title.main][lang];
            }
            if (Item.multi._keys[title.sub]) {
                vals[title.sub] = Item.multi._keys[title.sub][lang];
            }
        } else {
            vals[title.title] = Item[title.title];
            vals[title.main] = Item[title.main];
            vals[title.sub] = Item[title.sub];
        }
        if (vals[title.main] && vals[title.sub]) {
            var mainTitle = vals[title.main];
            var subTitle = vals[title.sub];
            if (sentenceCase) {
                mainTitle = CSL.Output.Formatters.sentence(state, mainTitle);
                subTitle = CSL.Output.Formatters.sentence(state, subTitle);
            } else {
                subTitle = CSL.Output.Formatters["capitalize-first"](state, subTitle);
            }
            return [mainTitle, subTitle].join(vals[title.title].slice(mainTitle.length, -1 * subTitle.length));
        } else {
            if (sentenceCase) {
                return CSL.Output.Formatters.sentence(state, vals[title.title]);
            } else {
                return vals[title.title];
            }
        }
    },
    getSafeEscape: function(state) {
        if (["bibliography", "citation"].indexOf(state.tmp.area) > -1) {
            var callbacks = [];
            if (state.opt.development_extensions.thin_non_breaking_space_html_hack && state.opt.mode === "html") {
                callbacks.push(function (txt) {
                    return txt.replace(/\u202f/g, '<span style="white-space:nowrap">&thinsp;</span>');
                });
            }
            if (callbacks.length) {
                return function (txt) {
                    for (var i = 0, ilen = callbacks.length; i < ilen; i += 1) {
                        txt = callbacks[i](txt);
                    }
                    return CSL.Output.Formats[state.opt.mode].text_escape(txt);
                }
            } else {
                return CSL.Output.Formats[state.opt.mode].text_escape;
            }
        } else {
            return function (txt) { return txt; };
        }
    },
    SKIP_WORDS: ["about","above","across","afore","after","against","along","alongside","amid","amidst","among","amongst","anenst","apropos","apud","around","as","aside","astride","at","athwart","atop","barring","before","behind","below","beneath","beside","besides","between","beyond","but","by","circa","despite","down","during","except","for","forenenst","from","given","in","inside","into","lest","like","modulo","near","next","notwithstanding","of","off","on","onto","out","over","per","plus","pro","qua","sans","since","than","through"," thru","throughout","thruout","till","to","toward","towards","under","underneath","until","unto","up","upon","versus","vs.","v.","vs","v","via","vis-à-vis","with","within","without","according to","ahead of","apart from","as for","as of","as per","as regards","aside from","back to","because of","close to","due to","except for","far from","inside of","instead of","near to","next to","on to","out from","out of","outside of","prior to","pursuant to","rather than","regardless of","such as","that of","up to","where as","or", "yet", "so", "for", "and", "nor", "a", "an", "the", "de", "d'", "von", "van", "c", "et", "ca"],
    FORMAT_KEY_SEQUENCE: [
        "@strip-periods",
        "@font-style",
        "@font-variant",
        "@font-weight",
        "@text-decoration",
        "@vertical-align",
        "@quotes"
    ],
    INSTITUTION_KEYS: [
        "font-style",
        "font-variant",
        "font-weight",
        "text-decoration",
        "text-case"
    ],
    SUFFIX_CHARS: "a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z",
    ROMAN_NUMERALS: [
        [ "", "i", "ii", "iii", "iv", "v", "vi", "vii", "viii", "ix" ],
        [ "", "x", "xx", "xxx", "xl", "l", "lx", "lxx", "lxxx", "xc" ],
        [ "", "c", "cc", "ccc", "cd", "d", "dc", "dcc", "dccc", "cm" ],
        [ "", "m", "mm", "mmm", "mmmm", "mmmmm"]
    ],
    CREATORS: [
        "author",
        "editor",
        "contributor",
        "translator",
        "recipient",
        "interviewer",
        "composer",
        "original-author",
        "container-author",
        "collection-editor"
    ],
    LANGS: {
        "af-ZA":"Afrikaans",
        "ar":"Arabic",
        "bg-BG":"Bulgarian",
        "ca-AD":"Catalan",
        "cs-CZ":"Czech",
        "da-DK":"Danish",
        "de-AT":"Austrian",
        "de-CH":"German (CH)",
        "de-DE":"German (DE)",
        "el-GR":"Greek",
        "en-GB":"English (GB)",
        "en-US":"English (US)",
        "es-ES":"Spanish",
        "et-EE":"Estonian",
        "eu":"European",
        "fa-IR":"Persian",
        "fi-FI":"Finnish",
        "fr-CA":"French (CA)",
        "fr-FR":"French (FR)",
        "he-IL":"Hebrew",
        "hr-HR":"Croatian",
        "hu-HU":"Hungarian",
        "is-IS":"Icelandic",
        "it-IT":"Italian",
        "ja-JP":"Japanese",
        "km-KH":"Khmer",
        "ko-KR":"Korean",
        "lt-LT":"Lithuanian",
        "lv-LV":"Latvian",
        "mn-MN":"Mongolian",
        "nb-NO":"Norwegian (Bokmål)",
        "nl-NL":"Dutch",
        "nn-NO":"Norwegian (Nynorsk)",
        "pl-PL":"Polish",
        "pt-BR":"Portuguese (BR)",
        "pt-PT":"Portuguese (PT)",
        "ro-RO":"Romanian",
        "ru-RU":"Russian",
        "sk-SK":"Slovak",
        "sl-SI":"Slovenian",
        "sr-RS":"Serbian",
        "sv-SE":"Swedish",
        "th-TH":"Thai",
        "tr-TR":"Turkish",
        "uk-UA":"Ukranian",
        "vi-VN":"Vietnamese",
        "zh-CN":"Chinese (CN)",
        "zh-TW":"Chinese (TW)"
    },
    LANG_BASES: {
        af: "af_ZA",
        ar: "ar",
        bg: "bg_BG",
        ca: "ca_AD",
        cs: "cs_CZ",
        da: "da_DK",
        de: "de_DE",
        el: "el_GR",
        en: "en_US",
        es: "es_ES",
        et: "et_EE",
        eu: "eu",
        fa: "fa_IR",
        fi: "fi_FI",
        fr: "fr_FR",
        he: "he_IL",
        hr: "hr-HR",
        hu: "hu_HU",
        is: "is_IS",
        it: "it_IT",
        ja: "ja_JP",
        km: "km_KH",
        ko: "ko_KR",
        lt: "lt_LT",
        lv: "lv-LV",
        mn: "mn_MN",
        nb: "nb_NO",
        nl: "nl_NL",
        nn: "nn-NO",
        pl: "pl_PL",
        pt: "pt_PT",
        ro: "ro_RO",
        ru: "ru_RU",
        sk: "sk_SK",
        sl: "sl_SI",
        sr: "sr_RS",
        sv: "sv_SE",
        th: "th_TH",
        tr: "tr_TR",
        uk: "uk_UA",
        vi: "vi_VN",
        zh: "zh_CN"
    },
    SUPERSCRIPTS: {
        "\u00AA": "\u0061",
        "\u00B2": "\u0032",
        "\u00B3": "\u0033",
        "\u00B9": "\u0031",
        "\u00BA": "\u006F",
        "\u02B0": "\u0068",
        "\u02B1": "\u0266",
        "\u02B2": "\u006A",
        "\u02B3": "\u0072",
        "\u02B4": "\u0279",
        "\u02B5": "\u027B",
        "\u02B6": "\u0281",
        "\u02B7": "\u0077",
        "\u02B8": "\u0079",
        "\u02E0": "\u0263",
        "\u02E1": "\u006C",
        "\u02E2": "\u0073",
        "\u02E3": "\u0078",
        "\u02E4": "\u0295",
        "\u1D2C": "\u0041",
        "\u1D2D": "\u00C6",
        "\u1D2E": "\u0042",
        "\u1D30": "\u0044",
        "\u1D31": "\u0045",
        "\u1D32": "\u018E",
        "\u1D33": "\u0047",
        "\u1D34": "\u0048",
        "\u1D35": "\u0049",
        "\u1D36": "\u004A",
        "\u1D37": "\u004B",
        "\u1D38": "\u004C",
        "\u1D39": "\u004D",
        "\u1D3A": "\u004E",
        "\u1D3C": "\u004F",
        "\u1D3D": "\u0222",
        "\u1D3E": "\u0050",
        "\u1D3F": "\u0052",
        "\u1D40": "\u0054",
        "\u1D41": "\u0055",
        "\u1D42": "\u0057",
        "\u1D43": "\u0061",
        "\u1D44": "\u0250",
        "\u1D45": "\u0251",
        "\u1D46": "\u1D02",
        "\u1D47": "\u0062",
        "\u1D48": "\u0064",
        "\u1D49": "\u0065",
        "\u1D4A": "\u0259",
        "\u1D4B": "\u025B",
        "\u1D4C": "\u025C",
        "\u1D4D": "\u0067",
        "\u1D4F": "\u006B",
        "\u1D50": "\u006D",
        "\u1D51": "\u014B",
        "\u1D52": "\u006F",
        "\u1D53": "\u0254",
        "\u1D54": "\u1D16",
        "\u1D55": "\u1D17",
        "\u1D56": "\u0070",
        "\u1D57": "\u0074",
        "\u1D58": "\u0075",
        "\u1D59": "\u1D1D",
        "\u1D5A": "\u026F",
        "\u1D5B": "\u0076",
        "\u1D5C": "\u1D25",
        "\u1D5D": "\u03B2",
        "\u1D5E": "\u03B3",
        "\u1D5F": "\u03B4",
        "\u1D60": "\u03C6",
        "\u1D61": "\u03C7",
        "\u2070": "\u0030",
        "\u2071": "\u0069",
        "\u2074": "\u0034",
        "\u2075": "\u0035",
        "\u2076": "\u0036",
        "\u2077": "\u0037",
        "\u2078": "\u0038",
        "\u2079": "\u0039",
        "\u207A": "\u002B",
        "\u207B": "\u2212",
        "\u207C": "\u003D",
        "\u207D": "\u0028",
        "\u207E": "\u0029",
        "\u207F": "\u006E",
        "\u2120": "\u0053\u004D",
        "\u2122": "\u0054\u004D",
        "\u3192": "\u4E00",
        "\u3193": "\u4E8C",
        "\u3194": "\u4E09",
        "\u3195": "\u56DB",
        "\u3196": "\u4E0A",
        "\u3197": "\u4E2D",
        "\u3198": "\u4E0B",
        "\u3199": "\u7532",
        "\u319A": "\u4E59",
        "\u319B": "\u4E19",
        "\u319C": "\u4E01",
        "\u319D": "\u5929",
        "\u319E": "\u5730",
        "\u319F": "\u4EBA",
        "\u02C0": "\u0294",
        "\u02C1": "\u0295",
        "\u06E5": "\u0648",
        "\u06E6": "\u064A"
    },
    SUPERSCRIPTS_REGEXP: new RegExp("[\u00AA\u00B2\u00B3\u00B9\u00BA\u02B0\u02B1\u02B2\u02B3\u02B4\u02B5\u02B6\u02B7\u02B8\u02E0\u02E1\u02E2\u02E3\u02E4\u1D2C\u1D2D\u1D2E\u1D30\u1D31\u1D32\u1D33\u1D34\u1D35\u1D36\u1D37\u1D38\u1D39\u1D3A\u1D3C\u1D3D\u1D3E\u1D3F\u1D40\u1D41\u1D42\u1D43\u1D44\u1D45\u1D46\u1D47\u1D48\u1D49\u1D4A\u1D4B\u1D4C\u1D4D\u1D4F\u1D50\u1D51\u1D52\u1D53\u1D54\u1D55\u1D56\u1D57\u1D58\u1D59\u1D5A\u1D5B\u1D5C\u1D5D\u1D5E\u1D5F\u1D60\u1D61\u2070\u2071\u2074\u2075\u2076\u2077\u2078\u2079\u207A\u207B\u207C\u207D\u207E\u207F\u2120\u2122\u3192\u3193\u3194\u3195\u3196\u3197\u3198\u3199\u319A\u319B\u319C\u319D\u319E\u319F\u02C0\u02C1\u06E5\u06E6]", "g"),
    UPDATE_GROUP_CONTEXT_CONDITION: function (state, termtxt, valueTerm) {
        if (state.tmp.group_context.tip.condition) {
            if (state.tmp.group_context.tip.condition.test) {
                var testres;
                if (state.tmp.group_context.tip.condition.test === "empty-label") {
                    testres = !termtxt;
                } else if (state.tmp.group_context.tip.condition.test === "empty-label-no-decor") {
                    testres = !termtxt || termtxt.indexOf("%s") > -1;
                } else if (state.tmp.group_context.tip.condition.test === "comma-safe") {
                    var empty = !termtxt;
                    var alpha = termtxt.slice(0,1).match(CSL.ALL_ROMANESQUE_REGEXP);
                    var num = state.tmp.just_did_number;
                    if (empty) {
                        testres = true;
                    } else if (num) {
                        if (alpha && !valueTerm) {
                            testres = true;
                        } else {
                            testres = false;
                        }
                    } else {
                        if (alpha && !valueTerm) {
                            testres = true;
                        } else {
                            testres = false;
                        }
                    }
                }
                if (testres) {
                    state.tmp.group_context.tip.force_suppress = false;
                } else {
                    state.tmp.group_context.tip.force_suppress = true;
                }
                if (state.tmp.group_context.tip.condition.not) {
                    state.tmp.group_context.tip.force_suppress = !state.tmp.group_context.tip.force_suppress;
                }
            }
        } else {
            if (termtxt.slice(-1).match(/[0-9]/)) {
                state.tmp.just_did_number = true;
            } else {
                state.tmp.just_did_number = false;
            }
        }
    },
    locale: {},
    locale_opts: {},
    locale_dates: {}
};
if ("function" !== "undefined" && typeof module !== 'undefined' && "exports" in module) {
    var CSL_IS_NODEJS = true;
    exports.CSL = CSL;
}
CSL.TERMINAL_PUNCTUATION_REGEXP = new RegExp("^([" + CSL.TERMINAL_PUNCTUATION.slice(0, -1).join("") + "])(.*)");
CSL.CLOSURES = new RegExp(".*[\\]\\)]");
module.exports = CSL;
if ("undefined" === typeof console) {
    CSL.debug = function (str) {
        dump("CSL: " + str + "\n");
    };
    CSL.error = function (str) {
        dump("CSL error: " + str + "\n");
    };
} else {
    CSL.debug = function (str) {
        console.log("CSL: " + str);
    };
    CSL.error = function (str) {
        console.log("CSL error: " + str);
    };
}
module.exports = CSL;
CSL.XmlJSON = function (dataObj) {
    this.dataObj = dataObj;
    this.institution = {
        name:"institution",
        attrs:{
            "institution-parts":"long",
            "delimiter":", ",
            "substitute-use-first":"1",
            "use-last":"1"
        },
        children:[
            {
                name:"institution-part",
                attrs:{
                    name:"long"
                },
                children:[]
            }
        ]
    };
};
CSL.XmlJSON.prototype.clean = function (json) {
    return json;
};
CSL.XmlJSON.prototype.getStyleId = function (myjson, styleName) {
    var tagName = 'id';
    if (styleName) {
        tagName = 'title';
    }
    var ret = "";
    var children = myjson.children;
    for (var i=0,ilen=children.length;i<ilen;i++) {
        if (children[i].name === 'info') {
            var grandkids = children[i].children;
            for (var j=0,jlen=grandkids.length;j<jlen;j++) {
                if (grandkids[j].name === tagName) {
                    ret = grandkids[j].children[0];
                }
            }
        }
    }
    return ret;
};
CSL.XmlJSON.prototype.children = function (myjson) {
    if (myjson && myjson.children.length) {
        return myjson.children.slice();
    } else {
        return false;
    }
};
CSL.XmlJSON.prototype.nodename = function (myjson) {
    return myjson ? myjson.name : null;
};
CSL.XmlJSON.prototype.attributes = function (myjson) {
    var ret = {};
    for (var attrname in myjson.attrs) {
        ret["@"+attrname] = myjson.attrs[attrname];
    }
    return ret;
};
CSL.XmlJSON.prototype.content = function (myjson) {
    var ret = "";
    if (!myjson || !myjson.children) {
        return ret;
    }
    for (var i=0, ilen=myjson.children.length; i < ilen; i += 1) {
        if ("string" === typeof myjson.children[i]) {
            ret += myjson.children[i];
        }
    }
    return ret;
};
CSL.XmlJSON.prototype.namespace = {}
CSL.XmlJSON.prototype.numberofnodes = function (myjson) {
    if (myjson && "number" == typeof myjson.length) {
        return myjson.length;
    } else {
        return 0;
    }
};
CSL.XmlJSON.prototype.getAttributeValue = function (myjson,name,namespace) {
    var ret = "";
    if (namespace) {
        name = namespace+":"+name;
    }
    if (myjson) {
        if (myjson.attrs) {
            if (myjson.attrs[name]) {
                ret = myjson.attrs[name];
            } else {
                ret = "";
            }
        }
    }
    return ret;
}
CSL.XmlJSON.prototype.getNodeValue = function (myjson,name) {
    var ret = "";
    if (name){
        for (var i=0, ilen=myjson.children.length; i < ilen; i += 1) {
            if (myjson.children[i].name === name) {
                if (myjson.children[i].children.length) {
                    ret = myjson.children[i];
                } else {
                    ret = "";
                }
            }
        }
    } else if (myjson) {
        ret = myjson;
    }
    if (ret && ret.children && ret.children.length == 1 && "string" === typeof ret.children[0]) {
        ret = ret.children[0];
    }
    return ret;
}
CSL.XmlJSON.prototype.setAttributeOnNodeIdentifiedByNameAttribute = function (myjson,nodename,partname,attrname,val) {
    var pos, len, xml, nodes, node;
    if (attrname.slice(0,1) === '@'){
        attrname = attrname.slice(1);
    }
    for (var i=0,ilen=myjson.children.length; i<ilen; i += 1) {
        if (myjson.children[i].name === nodename && myjson.children[i].attrs.name === partname) {
            myjson.children[i].attrs[attrname] = val;
        }
    }
}
CSL.XmlJSON.prototype.deleteNodeByNameAttribute = function (myjson,val) {
    var i, ilen;
    for (i = 0, ilen = myjson.children.length; i < ilen; i += 1) {
        if (!myjson.children[i] || "string" === typeof myjson.children[i]) {
            continue;
        }
        if (myjson.children[i].attrs.name == val) {
            myjson.children = myjson.children.slice(0,i).concat(myjson.children.slice(i+1));
        }
    }
}
CSL.XmlJSON.prototype.deleteAttribute = function (myjson,attrname) {
    var i, ilen;
    if ("undefined" !== typeof myjson.attrs[attrname]) {
        myjson.attrs.pop(attrname);
    }
}
CSL.XmlJSON.prototype.setAttribute = function (myjson,attr,val) {
    myjson.attrs[attr] = val;
    return false;
}
CSL.XmlJSON.prototype.nodeCopy = function (myjson,clone) {
    if (!clone) {
        var clone = {};
    }
    if ("object" === typeof clone && "undefined" === typeof clone.length) {
        for (var key in myjson) {
            if ("string" === typeof myjson[key]) {
                clone[key] = myjson[key];
            } else if ("object" === typeof myjson[key]) {
                if ("undefined" === typeof myjson[key].length) {
                    clone[key] = this.nodeCopy(myjson[key],{});
                } else {
                    clone[key] = this.nodeCopy(myjson[key],[]);
                }
            }
        }
    } else {
        for (var i=0,ilen=myjson.length;i<ilen; i += 1) {
            if ("string" === typeof myjson[i]) {
                clone[i] = myjson[i];
            } else {
                clone[i] = this.nodeCopy(myjson[i],{});
            }
        }
    }
    return clone;
}
CSL.XmlJSON.prototype.getNodesByName = function (myjson,name,nameattrval,ret) {
    var nodes, node, pos, len;
    if (!ret) {
        var ret = [];
    }
    if (!myjson || !myjson.children) {
        return ret;
    }
    if (name === myjson.name) {
        if (nameattrval) {
            if (nameattrval === myjson.attrs.name) {
                ret.push(myjson);
            }
        } else {
            ret.push(myjson);
        }
    }
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1){
        if ("object" !== typeof myjson.children[i]) {
            continue;
        }
        this.getNodesByName(myjson.children[i],name,nameattrval,ret);
    }
    return ret;
}
CSL.XmlJSON.prototype.nodeNameIs = function (myjson,name) {
    if (typeof myjson === "undefined") {
        return false;
    }
    if (name == myjson.name) {
        return true;
    }
    return false;
}
CSL.XmlJSON.prototype.makeXml = function (myjson) {
    if ("string" === typeof myjson) {
        if (myjson.slice(0, 1) === "<") {
            myjson = this.jsonStringWalker.walkToObject(myjson);
        } else {
            myjson = JSON.parse(myjson);
        }
    }
    return myjson;
};
CSL.XmlJSON.prototype.insertChildNodeAfter = function (parent,node,pos,datejson) {
    for (var i=0,ilen=parent.children.length;i<ilen;i+=1) {
        if (node === parent.children[i]) {
            parent.children = parent.children.slice(0,i).concat([datejson]).concat(parent.children.slice(i+1));
            break;
        }
    }
    return parent;
};
CSL.XmlJSON.prototype.insertPublisherAndPlace = function(myjson) {
    if (myjson.name === "group") {
        var useme = true;
        var mustHaves = ["publisher","publisher-place"];
        for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
            var haveVarname = mustHaves.indexOf(myjson.children[i].attrs.variable);
            var isText = myjson.children[i].name === "text";
            if (isText && haveVarname > -1 && !myjson.children[i].attrs.prefix && !myjson.children[i].attrs.suffix) {
                mustHaves = mustHaves.slice(0,haveVarname).concat(mustHaves.slice(haveVarname+1));
            } else {
                useme = false;
                break;
            }
        }
        if (useme && !mustHaves.length) {
            myjson.attrs["has-publisher-and-publisher-place"] = true;
       }
    }
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
        if ("object" === typeof myjson.children[i]) {
            this.insertPublisherAndPlace(myjson.children[i]);
        }
    }    
}
CSL.XmlJSON.prototype.isChildOfSubstitute = function(parents) {
    if (parents.length > 0) {
        var myparents = parents.slice();
        var parent = myparents.pop();
        if (parent === "substitute") {
            return true;
        } else {
            return this.isChildOfSubstitute(myparents);
        }
    }
    return false;
};
CSL.XmlJSON.prototype.addMissingNameNodes = function(myjson,parents) {
    if (!parents) {
        parents = [];
    }
    if (myjson.name === "names") {
        if (!this.isChildOfSubstitute(parents)) {
            var addName = true;
            for (var i=0,ilen=myjson.children.length;i<ilen;i++) {
                if (myjson.children[i].name === "name") {
                    addName = false;
                    break;
                }
            }
            if (addName) {
                myjson.children = [{name:"name",attrs:{},children:[]}].concat(myjson.children);
            }
        }
    }
    parents.push(myjson.name);
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
        if ("object" === typeof myjson.children[i]) {
            this.addMissingNameNodes(myjson.children[i],parents);
        }
    }
    parents.pop();
}
CSL.XmlJSON.prototype.addInstitutionNodes = function(myjson) {
    var names, thenames, institution, theinstitution, name, thename, xml, pos, len;
    if (myjson.name === "names") {
        var attributes = {};
        var insertPos = -1;
        for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
            if (myjson.children[i].name == "name") {
                for (var key in myjson.children[i].attrs) {
                    attributes[key] = myjson.children[i].attrs[key];
                }
                attributes.delimiter = myjson.children[i].attrs.delimiter;
                attributes.and = myjson.children[i].attrs.and;
                insertPos = i;
                for (var k=0,klen=myjson.children[i].children.length;k<klen;k+=1) {
                    if (myjson.children[i].children[k].attrs.name !== 'family') {
                        continue;
                    }
                    for (var key in myjson.children[i].children[k].attrs) {
                        attributes[key] = myjson.children[i].children[k].attrs[key];
                    }
                }
            }
            if (myjson.children[i].name == "institution") {
                insertPos = -1;
                break;
            }
        }
        if (insertPos > -1) {
            var institution = this.nodeCopy(this.institution);
            for (var i=0,ilen = CSL.INSTITUTION_KEYS.length;i<ilen;i+=1) {
                var attrname = CSL.INSTITUTION_KEYS[i];
                if ("undefined" !== typeof attributes[attrname]) {
                    institution.children[0].attrs[attrname] = attributes[attrname];
                }
                if (attributes.delimiter) {
                    institution.attrs.delimiter = attributes.delimiter;
                }
                if (attributes.and) {
                    institution.attrs.and = "text";
                }
            }
            myjson.children = myjson.children.slice(0,insertPos+1).concat([institution]).concat(myjson.children.slice(insertPos+1));
        }
    }
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
        if ("string" === typeof myjson.children[i]) {
            continue;
        }
        this.addInstitutionNodes(myjson.children[i]);
    }
}
CSL.XmlJSON.prototype.flagDateMacros = function(myjson) {
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
        if (myjson.children[i].name === "macro") {
            if (this.inspectDateMacros(myjson.children[i])) {
                myjson.children[i].attrs["macro-has-date"] = "true";
            }
        }
    }
}
CSL.XmlJSON.prototype.inspectDateMacros = function(myjson) {
    if (!myjson || !myjson.children) {
        return false;
    }
    if (myjson.name === "date") {
        return true;
    } else {
        for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
            if (this.inspectDateMacros(myjson.children[i])) {
                return true;
            }
        }
    }
    return false;
}
CSL.stripXmlProcessingInstruction = function (xml) {
    if (!xml) {
        return xml;
    }
    xml = xml.replace(/^<\?[^?]+\?>/, "");
    xml = xml.replace(/<!--[^>]+-->/g, "");
    xml = xml.replace(/^\s+/g, "");
    xml = xml.replace(/\s+$/g, "");
    return xml;
};
CSL.parseXml = function(str) {
    var _pos = 0;
    var _obj = {children:[]};
    var _stack = [_obj.children];
    function _listifyString(str) {
        str = str.split(/(?:\r\n|\n|\r)/).join(" ").replace(/>[	 ]+</g, "><").replace(/<\!--.*?-->/g, "");
        var lst = str.split("><");
        var stylePos = null;
        for (var i=0,ilen=lst.length;i<ilen;i++) {
            if (i > 0) {
                lst[i] = "<" + lst[i];
            }
            if (i < (lst.length-1)) {
                lst[i] = lst[i] + ">";
            }
            if ("number" != typeof stylePos) {
                if (lst[i].slice(0, 7) === "<style " || lst[i].slice(0, 8) == "<locale ") {
                    stylePos = i;
                }
            }
        }
        lst = lst.slice(stylePos);
        for (var i=lst.length-2;i>-1;i--) {
            if (lst[i].slice(1).indexOf("<") === -1) {
                var stub = lst[i].slice(0, 5);
                if (lst[i].slice(-2) !== "/>") {
                    if (stub === "<term") {
                        if (lst[i+1].slice(0, 6) === "</term") {
                            lst[i] = lst[i] + lst[i+1];
                            lst = lst.slice(0, i+1).concat(lst.slice(i+2));
                        }
                    } else if (["<sing", "<mult"].indexOf(stub) > -1) {
                        if (lst[i].slice(-2) !== "/>" && lst[i+1].slice(0, 1) === "<") {
                            lst[i] = lst[i] + lst[i+1];
                            lst = lst.slice(0, i+1).concat(lst.slice(i+2));
                        }
                    }
                }
            }
        }
        return lst;
    }
    function _decodeHtmlEntities(str) {
        return str
            .split("&amp;").join("&")
            .split("&quot;").join("\"")
            .split("&gt;").join(">").split("&lt;").join("<")
            .replace(/&#([0-9]{1,6});/gi, function(match, numStr) {
                var num = parseInt(numStr, 10); // read num as normal number
                return String.fromCharCode(num);
            })
            .replace(/&#x([a-f0-9]{1,6});/gi, function(match, numStr){
                var num = parseInt(numStr, 16); // read num as hex
                return String.fromCharCode(num);
            });
    }
    function _getAttributes(elem) {
        var m = elem.match(/([^\'\"=	 ]+)=(?:\"[^\"]*\"|\'[^\']*\')/g);
        if (m) {
            for (var i=0,ilen=m.length;i<ilen;i++) {
                m[i] = m[i].replace(/=.*/, "");
            }
        }
        return m;
    }
    function _getAttribute(elem, attr) {
        var rex = RegExp('^.*[	 ]+' + attr + '=(\"(?:[^\"]*)\"|\'(?:[^\']*)\').*$');
        var m = elem.match(rex);
        return m ? m[1].slice(1, -1) : null;
    }
    function _getTagName(elem) {
        var rex = RegExp("^<([^	 />]+)");
        var m = elem.match(rex);
        return m ? m[1] : null;
    }
    function _castObjectFromOpeningTag(elem) {
        var obj = {};
        obj.name = _getTagName(elem);
        obj.attrs = {};
        var attributes = _getAttributes(elem);
        if (attributes) {
            for (var i=0,ilen=attributes.length;i<ilen;i++) {
                var attr = {
                    name: attributes[i],
                    value: _getAttribute(elem, attributes[i])
                }
                obj.attrs[attr.name] = _decodeHtmlEntities(attr.value);
            }
        }
        obj.children = [];
        return obj;
    }
    function _extractTextFromCompositeElement(elem) {
        var m = elem.match(/^.*>([^<]*)<.*$/);
        return _decodeHtmlEntities(m[1]);
    }
    function _appendToChildren(obj) {
        _stack.slice(-1)[0].push(obj);
    }
    function _extendStackWithNewChildren(obj) {
        _stack.push(obj.children);
    }
    function processElement(elem) {
        var obj;
        if (elem.slice(1).indexOf('<') > -1) {
            var tag = elem.slice(0, elem.indexOf('>')+1);
            obj = _castObjectFromOpeningTag(tag);
            obj.children = [_extractTextFromCompositeElement(elem)];
            _appendToChildren(obj);
        } else if (elem.slice(-2) === '/>') {
            obj = _castObjectFromOpeningTag(elem);
            if (_getTagName(elem) === 'term') {
                obj.children.push('');
            }
            _appendToChildren(obj);
        } else if (elem.slice(0, 2) === '</') {
            _stack.pop();
        } else {
            obj = _castObjectFromOpeningTag(elem);
            _appendToChildren(obj)
            _extendStackWithNewChildren(obj);
        }
    }
    var lst = _listifyString(str);
    for (var i=0,ilen=lst.length;i<ilen;i++) {
        var elem = lst[i];
        processElement(elem);
    }
    return _obj.children[0];
}
module.exports = CSL;
CSL.XmlDOM = function (dataObj) {
    this.dataObj = dataObj;
    if ("undefined" == typeof DOMParser) {
        DOMParser = function() {};
        DOMParser.prototype.parseFromString = function(str, contentType) {
            if ("undefined" != typeof ActiveXObject) {
                var xmldata = new ActiveXObject('MSXML.DomDocument');
                xmldata.async = false;
                xmldata.loadXML(str);
                return xmldata;
            } else if ("undefined" != typeof XMLHttpRequest) {
                var xmldata = new XMLHttpRequest;
                if (!contentType) {
                    contentType = 'text/xml';
                }
                xmldata.open('GET', 'data:' + contentType + ';charset=utf-8,' + encodeURIComponent(str), false);
                if(xmldata.overrideMimeType) {
                    xmldata.overrideMimeType(contentType);
                }
                xmldata.send(null);
                return xmldata.responseXML;
            } else if ("undefined" != typeof marknote) {
                var parser = new marknote.Parser();
                return parser.parse(str);
            }
        };
        this.hasAttributes = function (node) {
            var ret;
            if (node.attributes && node.attributes.length) {
                ret = true;
            } else {
                ret = false;
            }
            return ret;
        };
    } else {
        this.hasAttributes = function (node) {
            var ret;
            if (node.attributes && node.attributes.length) {
                ret = true;
            } else {
                ret = false;
            }
            return ret;
        };
    }
    this.importNode = function (doc, srcElement) {
        if ("undefined" == typeof doc.importNode) {
            var ret = this._importNode(doc, srcElement, true);
        } else {
            var ret = doc.importNode(srcElement, true);
        }
        return ret;
    };
    this._importNode = function(doc, node, allChildren) {
        switch (node.nodeType) {
            case 1:
                var newNode = doc.createElement(node.nodeName);
                if (node.attributes && node.attributes.length > 0)
                    for (var i = 0, il = node.attributes.length; i < il;)
                        newNode.setAttribute(node.attributes[i].nodeName, node.getAttribute(node.attributes[i++].nodeName));
                    if (allChildren && node.childNodes && node.childNodes.length > 0)
                        for (var i = 0, il = node.childNodes.length; i < il;)
                            newNode.appendChild(this._importNode(doc, node.childNodes[i++], allChildren));
                return newNode;
                break;
            case 3:
            case 4:
            case 8:
        }
    };
    this.parser = new DOMParser();
    var str = "<docco><institution institution-parts=\"long\" delimiter=\", \" substitute-use-first=\"1\" use-last=\"1\"><institution-part name=\"long\"/></institution></docco>";
    var inst_doc = this.parser.parseFromString(str, "text/xml");
    var inst_node = inst_doc.getElementsByTagName("institution");
    this.institution = inst_node.item(0);
    var inst_part_node = inst_doc.getElementsByTagName("institution-part");
    this.institutionpart = inst_part_node.item(0);
    this.ns = "http://purl.org/net/xbiblio/csl";
};
CSL.XmlDOM.prototype.clean = function (xml) {
    xml = xml.replace(/<\?[^?]+\?>/g, "");
    xml = xml.replace(/<![^>]+>/g, "");
    xml = xml.replace(/^\s+/, "");
    xml = xml.replace(/\s+$/, "");
    xml = xml.replace(/^\n*/, "");
    return xml;
};
CSL.XmlDOM.prototype.getStyleId = function (myxml, styleName) {
    var text = "";
    var tagName = "id";
    if (styleName) {
        tagName = "title";
    }
    var node = myxml.getElementsByTagName(tagName);
    if (node && node.length) {
        node = node.item(0);
    }
    if (node) {
        text = node.textContent;
    }
    if (!text) {
        text = node.innerText;
    }
    if (!text) {
        text = node.innerHTML;
    }
    return text;
};
CSL.XmlDOM.prototype.children = function (myxml) {
    var children, pos, len, ret;
    if (myxml) {
        ret = [];
        children = myxml.childNodes;
        for (pos = 0, len = children.length; pos < len; pos += 1) {
            if (children[pos].nodeName != "#text") {
                ret.push(children[pos]);
            }
        }
        return ret;
    } else {
        return [];
    }
};
CSL.XmlDOM.prototype.nodename = function (myxml) {
    var ret = myxml.nodeName;
    return ret;
};
CSL.XmlDOM.prototype.attributes = function (myxml) {
    var ret, attrs, attr, key, xml, pos, len;
    ret = new Object();
    if (myxml && this.hasAttributes(myxml)) {
        attrs = myxml.attributes;
        for (pos = 0, len=attrs.length; pos < len; pos += 1) {
            attr = attrs[pos];
            ret["@" + attr.name] = attr.value;
        }
    }
    return ret;
};
CSL.XmlDOM.prototype.content = function (myxml) {
    var ret;
    if ("undefined" != typeof myxml.textContent) {
        ret = myxml.textContent;
    } else if ("undefined" != typeof myxml.innerText) {
        ret = myxml.innerText;
    } else {
        ret = myxml.txt;
    }
    return ret;
};
CSL.XmlDOM.prototype.namespace = {
    "xml":"http://www.w3.org/XML/1998/namespace"
}
CSL.XmlDOM.prototype.numberofnodes = function (myxml) {
    if (myxml) {
        return myxml.length;
    } else {
        return 0;
    }
};
CSL.XmlDOM.prototype.getAttributeName = function (attr) {
    var ret = attr.name;
    return ret;
}
CSL.XmlDOM.prototype.getAttributeValue = function (myxml,name,namespace) {
    var ret = "";
    if (namespace) {
        name = namespace+":"+name;
    }
    if (myxml && this.hasAttributes(myxml) && myxml.getAttribute(name)) {
        ret = myxml.getAttribute(name);
    }
    return ret;
}
CSL.XmlDOM.prototype.getNodeValue = function (myxml,name) {
    var ret = null;
    if (name){
        var vals = myxml.getElementsByTagName(name);
        if (vals.length > 0) {
            if ("undefined" != typeof vals[0].textContent) {
                ret = vals[0].textContent;
            } else if ("undefined" != typeof vals[0].innerText) {
                ret = vals[0].innerText;
            } else {
                ret = vals[0].text;
            }
        }
    }
    if (ret === null && myxml && myxml.childNodes && (myxml.childNodes.length == 0 || (myxml.childNodes.length == 1 && myxml.firstChild.nodeName == "#text"))) {
        if ("undefined" != typeof myxml.textContent) {
            ret = myxml.textContent;
        } else if ("undefined" != typeof myxml.innerText) {
            ret = myxml.innerText;
        } else {
            ret = myxml.text;
        }
    }
    if (ret === null) {
        ret = myxml;
    }
    return ret;
}
CSL.XmlDOM.prototype.setAttributeOnNodeIdentifiedByNameAttribute = function (myxml,nodename,partname,attrname,val) {
    var pos, len, xml, nodes, node;
    if (attrname.slice(0,1) === '@'){
        attrname = attrname.slice(1);
    }
    nodes = myxml.getElementsByTagName(nodename);
    for (pos = 0, len = nodes.length; pos < len; pos += 1) {
        node = nodes[pos];
        if (node.getAttribute("name") != partname) {
            continue;
        }
        node.setAttribute(attrname, val);
    }
}
CSL.XmlDOM.prototype.deleteNodeByNameAttribute = function (myxml,val) {
    var pos, len, node, nodes;
    nodes = myxml.childNodes;
    for (pos = 0, len = nodes.length; pos < len; pos += 1) {
        node = nodes[pos];
        if (!node || node.nodeType == node.TEXT_NODE) {
            continue;
        }
        if (this.hasAttributes(node) && node.getAttribute("name") == val) {
            myxml.removeChild(nodes[pos]);
        }
    }
}
CSL.XmlDOM.prototype.deleteAttribute = function (myxml,attr) {
    myxml.removeAttribute(attr);
}
CSL.XmlDOM.prototype.setAttribute = function (myxml,attr,val) {
    if (!myxml.ownerDocument) {
        myxml = myxml.firstChild;
    }
    if (["function", "unknown"].indexOf(typeof myxml.setAttribute) > -1) {
        myxml.setAttribute(attr, val);
    }
    return false;
}
CSL.XmlDOM.prototype.nodeCopy = function (myxml) {
    var cloned_node = myxml.cloneNode(true);
    return cloned_node;
}
CSL.XmlDOM.prototype.getNodesByName = function (myxml,name,nameattrval) {
    var ret, nodes, node, pos, len;
    ret = [];
    nodes = myxml.getElementsByTagName(name);
    for (pos = 0, len = nodes.length; pos < len; pos += 1) {
        node = nodes.item(pos);
        if (nameattrval && !(this.hasAttributes(node) && node.getAttribute("name") == nameattrval)) {
            continue;
        }
        ret.push(node);
    }
    return ret;
}
CSL.XmlDOM.prototype.nodeNameIs = function (myxml,name) {
    if (name == myxml.nodeName) {
        return true;
    }
    return false;
}
CSL.XmlDOM.prototype.makeXml = function (myxml) {
    var ret, topnode;
    if (!myxml) {
        myxml = "<docco><bogus/></docco>";
    }
    myxml = myxml.replace(/\s*<\?[^>]*\?>\s*\n*/g, "");
    var nodetree = this.parser.parseFromString(myxml, "application/xml");
    return nodetree.firstChild;
};
CSL.XmlDOM.prototype.insertChildNodeAfter = function (parent,node,pos,datexml) {
    var myxml, xml;
    myxml = this.importNode(node.ownerDocument, datexml);
    parent.replaceChild(myxml, node);
     return parent;
};
CSL.XmlDOM.prototype.insertPublisherAndPlace = function(myxml) {
    var group = myxml.getElementsByTagName("group");
    for (var i = 0, ilen = group.length; i < ilen; i += 1) {
        var node = group.item(i);
        var skippers = [];
        for (var j = 0, jlen = node.childNodes.length; j < jlen; j += 1) {
            if (node.childNodes.item(j).nodeType !== 1) {
                skippers.push(j);
            }
        }
        if (node.childNodes.length - skippers.length === 2) {
            var twovars = [];
            for (var j = 0, jlen = 2; j < jlen; j += 1) {
                if (skippers.indexOf(j) > -1) {
                    continue;
                }
                var child = node.childNodes.item(j);                    
                var subskippers = [];
                for (var k = 0, klen = child.childNodes.length; k < klen; k += 1) {
                    if (child.childNodes.item(k).nodeType !== 1) {
                        subskippers.push(k);
                    }
                }
                if (child.childNodes.length - subskippers.length === 0) {
                    twovars.push(child.getAttribute('variable'));
                    if (child.getAttribute('suffix')
                        || child.getAttribute('prefix')) {
                        twovars = [];
                        break;
                    }
                }
            }
            if (twovars.indexOf("publisher") > -1 && twovars.indexOf("publisher-place") > -1) {
                node.setAttribute('has-publisher-and-publisher-place', true);
            }
        }
    }
};
CSL.XmlDOM.prototype.isChildOfSubstitute = function(node) {
    if (node.parentNode) {
        if (node.parentNode.tagName.toLowerCase() === "substitute") {
            return true;
        } else {
            return this.isChildOfSubstitute(node.parentNode);
        }
    }
    return false;
};
CSL.XmlDOM.prototype.addMissingNameNodes = function(myxml) {
    var nameslist = myxml.getElementsByTagName("names");
    for (var i = 0, ilen = nameslist.length; i < ilen; i += 1) {
        var names = nameslist.item(i);
        var namelist = names.getElementsByTagName("name");
        if ((!namelist || namelist.length === 0)
            && !this.isChildOfSubstitute(names)) {
            var doc = names.ownerDocument;
            var name = doc.createElement("name");
            names.appendChild(name);
        }
    }
};
CSL.XmlDOM.prototype.addInstitutionNodes = function(myxml) {
    var names, thenames, institution, theinstitution, name, thename, xml, pos, len;
    names = myxml.getElementsByTagName("names");
    for (pos = 0, len = names.length; pos < len; pos += 1) {
        thenames = names.item(pos);
        name = thenames.getElementsByTagName("name");
        if (name.length == 0) {
            continue;
        }
        institution = thenames.getElementsByTagName("institution");
        if (institution.length == 0) {
            theinstitution = this.importNode(myxml.ownerDocument, this.institution);
            theinstitutionpart = theinstitution.getElementsByTagName("institution-part").item(0);
            thename = name.item(0);
            thenames.insertBefore(theinstitution, thename.nextSibling);
            for (var j = 0, jlen = CSL.INSTITUTION_KEYS.length; j < jlen; j += 1) {
                var attrname = CSL.INSTITUTION_KEYS[j];
                var attrval = thename.getAttribute(attrname);
                if (attrval) {
                    theinstitutionpart.setAttribute(attrname, attrval);
                }
            }
            var nameparts = thename.getElementsByTagName("name-part");
            for (var j = 0, jlen = nameparts.length; j < jlen; j += 1) {
                if ('family' === nameparts[j].getAttribute('name')) {
                    for (var k = 0, klen = CSL.INSTITUTION_KEYS.length; k < klen; k += 1) {
                        var attrname = CSL.INSTITUTION_KEYS[k];
                        var attrval = nameparts[j].getAttribute(attrname);
                        if (attrval) {
                            theinstitutionpart.setAttribute(attrname, attrval);
                        }
                    }
                }
            }
        }
    }
};
CSL.XmlDOM.prototype.flagDateMacros = function(myxml) {
    var pos, len, thenode, thedate;
    nodes = myxml.getElementsByTagName("macro");
    for (pos = 0, len = nodes.length; pos < len; pos += 1) {
        thenode = nodes.item(pos);
        thedate = thenode.getElementsByTagName("date");
        if (thedate.length) {
            thenode.setAttribute('macro-has-date', 'true');
        }
    }
};
module.exports = CSL;
if ("undefined" !== typeof XML) {
    try {
    } catch (e) {
        throw "OOPS: "+e;
    }
}
module.exports = CSL;
CSL.setupXml = function(xmlObject) {
    var dataObj = {};
    var parser = null;
    if ("undefined" !== typeof xmlObject) {
        if ("string" === typeof xmlObject) {
            xmlObject = xmlObject.replace("^\uFEFF", "")
                .replace(/^\s+/, "");
            if (xmlObject.slice(0, 1) === "<") {
                dataObj = CSL.parseXml(xmlObject);
            } else {
                dataObj = JSON.parse(xmlObject);
            }
            parser = new CSL.XmlJSON(dataObj);
        } else if ("undefined" !== typeof xmlObject.getAttribute) {
            parser = new CSL.XmlDOM(xmlObject);
        } else if ("undefined" !== typeof xmlObject.toXMLString) {
            parser = new CSL.XmlE4X(xmlObject);
        } else {
            parser = new CSL.XmlJSON(xmlObject);
        }
    } else {
        CSL.error("unable to parse XML input");
    }
    if (!parser) {
        throw "citeproc-js error: unable to parse CSL style or locale object";
    }
    return parser;
}
module.exports = CSL;
CSL.getSortCompare = function (default_locale) {
    if (CSL.stringCompare) {
        return CSL.stringCompare;
    }
    var strcmp;
    var strcmp_opts = {
        sensitivity:"base",
        ignorePunctuation:true,
        numeric:true
   }
    if (!default_locale) {
        default_locale = "en-US";
    }
    strcmp = function (a, b) {
        return a.toLocaleLowerCase().localeCompare(b.toLocaleLowerCase(),default_locale,strcmp_opts);
    };
    var stripPunct = function (str) {
        return str.replace(/^[\[\]\'\"]*/g, "");
    }
    var getBracketPreSort = function () {
        if (!strcmp("[x","x")) {
            return false;
        } else {
            return function (a, b) {
                return strcmp(stripPunct(a), stripPunct(b));
            }
        }
    }
    var bracketPreSort = getBracketPreSort();
    var sortCompare = function (a, b) {
        if (bracketPreSort) {
            return bracketPreSort(a, b);
        } else {
            return strcmp(a, b);
        }
    }
    return sortCompare;
};
module.exports = CSL;
CSL.ambigConfigDiff = function(a, b) {
    var ret, pos, len, ppos, llen;
    if (a.names.length !== b.names.length) {
        return 1;
    } else {
        for (pos = 0, len = a.names.length; pos < len; pos += 1) {
            if (a.names[pos] !== b.names[pos]) {
                return 1;
            } else {
                for (ppos = 0, llen = a.givens[pos]; ppos < llen; ppos += 1) {
                    if (a.givens[pos][ppos] !== b.givens[pos][ppos]) {
                        return 1;
                    }
                }
            }
        }
    }
    if (a.disambiguate != b.disambiguate) {
        return 1;
    }
    if (a.year_suffix !== b.year_suffix) {
        return 1;
    }
    return 0;
};
CSL.cloneAmbigConfig = function (config, oldconfig, tainters) {
    var i, ilen, j, jlen, k, klen, param;
    var ret = {};
    ret.names = [];
    ret.givens = [];
    ret.year_suffix = false;
    ret.disambiguate = false;
    for (i = 0, ilen = config.names.length; i < ilen; i += 1) {
        param = config.names[i];
        ret.names[i] = param;
    }
    for (i  = 0, ilen = config.givens.length; i < ilen; i += 1) {
        param = [];
        for (j = 0, jlen = config.givens[i].length; j < jlen; j += 1) {
            param.push(config.givens[i][j]);
        }
        ret.givens.push(param);
    }
    if (oldconfig) {
        ret.year_suffix = oldconfig.year_suffix;
        ret.disambiguate = oldconfig.disambiguate;
    } else {
        ret.year_suffix = config.year_suffix;
        ret.disambiguate = config.disambiguate;
    }
    return ret;
};
CSL.getAmbigConfig = function () {
    var config, ret;
    config = this.tmp.disambig_request;
    if (!config) {
        config = this.tmp.disambig_settings;
    }
    var ret = CSL.cloneAmbigConfig(config);
    return ret;
};
CSL.getMaxVals = function () {
    return this.tmp.names_max.mystack.slice();
};
CSL.getMinVal = function () {
    return this.tmp["et-al-min"];
};
module.exports = CSL;
CSL.tokenExec = function (token, Item, item) {
    var next, maybenext, exec, debug;
    debug = false;
    next = token.next;
    maybenext = false;
    var record = function (result) {
        if (result) {
            this.tmp.jump.replace("succeed");
            return token.succeed;
        } else {
            this.tmp.jump.replace("fail");
            return token.fail;
        }
    }
    if (token.test) {
        next = record.call(this,token.test(Item, item));
    }
    for (var i=0,ilen=token.execs.length;i<ilen;i++) {
        exec = token.execs[i];
        maybenext = exec.call(token, this, Item, item);
        if (maybenext) {
            next = maybenext;
        }
    }
    return next;
};
CSL.expandMacro = function (macro_key_token, target) {
    var mkey, start_token, key, end_token, navi, macro_nodes, newoutput, mergeoutput, end_of_macro, func;
    mkey = macro_key_token.postponed_macro;
    macro_key_token = new CSL.Token("group", CSL.START);
    var hasDate = false;
    var macroid = false;
    macro_nodes = this.cslXml.getNodesByName(this.cslXml.dataObj, 'macro', mkey);
    if (macro_nodes.length) {
        macroid = this.cslXml.getAttributeValue(macro_nodes[0],'cslid');
        hasDate = this.cslXml.getAttributeValue(macro_nodes[0], "macro-has-date");
    }
    if (hasDate) {
        mkey = mkey + "@" + this.build.current_default_locale;
        func = function (state, Item) {
            if (state.tmp.extension) {
                state.tmp["doing-macro-with-date"] = true;
            }
        };
        macro_key_token.execs.push(func);
    }
    if (this.build.macro_stack.indexOf(mkey) > -1) {
        throw "CSL processor error: call to macro \"" + mkey + "\" would cause an infinite loop";
    } else {
        this.build.macro_stack.push(mkey);
    }
    macro_key_token.cslid = macroid;
    if (CSL.MODULE_MACROS[mkey]) {
        macro_key_token.juris = mkey;
        this.opt.update_mode = CSL.POSITION;
    }
    CSL.Node.group.build.call(macro_key_token, this, target, true);
    if (!this.cslXml.getNodeValue(macro_nodes)) {
        throw "CSL style error: undefined macro \"" + mkey + "\"";
    }
    var mytarget = CSL.getMacroTarget.call(this, mkey);
    if (mytarget) {
        CSL.buildMacro.call(this, mytarget, macro_nodes);
        CSL.configureMacro.call(this, mytarget);
    }
    if (!this.build.extension) {
        var func = function(macro_name) {
            return function (state, Item, item) {
                var next = 0;
                while (next < state.macros[macro_name].length) {
                    next = CSL.tokenExec.call(state, state.macros[macro_name][next], Item, item);
                }
            }
        }(mkey);
        var text_node = new CSL.Token("text", CSL.SINGLETON);
        text_node.execs.push(func);
        target.push(text_node);
    }
    end_of_macro = new CSL.Token("group", CSL.END);
    if (hasDate) {
        func = function (state, Item) {
            if (state.tmp.extension) {
                state.tmp["doing-macro-with-date"] = false;
            }
        };
        end_of_macro.execs.push(func);
    }
    if (macro_key_token.juris) {
        end_of_macro.juris = mkey;
     }
    CSL.Node.group.build.call(end_of_macro, this, target, true);
    this.build.macro_stack.pop();
};
CSL.getMacroTarget = function (mkey) {
    var mytarget = false;
    if (this.build.extension) {
        mytarget = this[this.build.root + this.build.extension].tokens;
    } else if (!this.macros[mkey]) {
        mytarget = [];
        this.macros[mkey] = mytarget;
    }
    return mytarget;
}
CSL.buildMacro = function (mytarget, macro_nodes) {
    var builder = CSL.makeBuilder(this, mytarget);
    var mynode;
    if ("undefined" === typeof macro_nodes.length) {
        mynode = macro_nodes;
    } else {
        mynode = macro_nodes[0];
    }
    builder(mynode);
}
CSL.configureMacro = function (mytarget) {
    if (!this.build.extension) {
        this.configureTokenList(mytarget);
    }
}
CSL.XmlToToken = function (state, tokentype, explicitTarget, var_stack) {
    var name, txt, attrfuncs, attributes, decorations, token, key, target;
    name = state.cslXml.nodename(this);
    if (state.build.skip && state.build.skip !== name) {
        return;
    }
    if (!name) {
        txt = state.cslXml.content(this);
        if (txt) {
            state.build.text = txt;
        }
        return;
    }
    if (!CSL.Node[state.cslXml.nodename(this)]) {
        throw "Undefined node name \"" + name + "\".";
    }
    attrfuncs = [];
    attributes = state.cslXml.attributes(this);
    decorations = CSL.setDecorations.call(this, state, attributes);
    token = new CSL.Token(name, tokentype);
    if (tokentype !== CSL.END || name === "if" || name === "else-if" || name === "layout") {
        for (var key in attributes) {
            if (attributes.hasOwnProperty(key)) {
                if (tokentype === CSL.END && key !== "@language" && key !== "@locale") {
                    continue;
                }
                if (attributes.hasOwnProperty(key)) {
                    if (CSL.Attributes[key]) {
                        try {
                            CSL.Attributes[key].call(token, state, "" + attributes[key]);
                        } catch (e) {
                            CSL.error(e);
                            throw "CSL processor error, " + key + " attribute: " + e;
                        }
                    } else {
                        CSL.debug("warning: undefined attribute \""+key+"\" in style");
                    }
                }
            }
        }
        token.decorations = decorations;
        if (CSL.DATE_VARIABLES.indexOf(attributes['@variable']) > -1) {
            var_stack.push(token.variables);
        }
    } else if (tokentype === CSL.END && attributes['@variable']) {
        token.hasVariable = true;
        if (CSL.DATE_VARIABLES.indexOf(attributes['@variable']) > -1) {
            token.variables = var_stack.pop();
        }
    }
    if (explicitTarget) {
        target = explicitTarget;
    } else {
        target = state[state.build.area].tokens;
    }
    CSL.Node[name].build.call(token, state, target, true);
};
module.exports = CSL;
CSL.DateParser = new function () {
    var epochPairs = [
        ["\u660E\u6CBB", 1867],
        ["\u5927\u6B63", 1911],
        ["\u662D\u548C", 1925],
        ["\u5E73\u6210", 1988]
    ];
    var epochYearByName = {};
    for (var i=0,ilen=epochPairs.length; i<ilen; i++) {
        var key = epochPairs[i][0];
        var val = epochPairs[i][1];
        epochYearByName[key] = val;
    }
    var epochMatchStrings = [];
    for (var i=0,ilen=epochPairs.length; i<ilen; i++) {
        var val = epochPairs[i][0];
        epochMatchStrings.push(val);
    }
    var epochMatchString = epochMatchStrings.join("|");
    var epochSplitter = new RegExp("(?:" + epochMatchString + ")(?:[0-9]+)");
    var epochMatcher = new RegExp("(?:" + epochMatchString + ")(?:[0-9]+)", "g");
    var kanjiMonthDay = /(\u6708|\u5E74)/g;
    var kanjiYear = /\u65E5/g;
    var kanjiRange = /\u301c/g;
    var yearLast = "(?:[?0-9]{1,2}%%NUMD%%){0,2}[?0-9]{4}(?![0-9])";
    var yearFirst = "[?0-9]{4}(?:%%NUMD%%[?0-9]{1,2}){0,2}(?![0-9])";
    var numberVal = "[?0-9]{1,3}";
    var rangeSeparator = "[%%DATED%%]";
    var fuzzyChar = "[?~]";
    var chars = "[^\-\/\~\?0-9]+";
    var rexString = "(" + yearFirst + "|" + yearLast + "|" + numberVal + "|" + rangeSeparator + "|" + fuzzyChar + "|" + chars + ")";
    var rexDash = new RegExp(rexString.replace(/%%NUMD%%/g, "-").replace(/%%DATED%%/g, "-"));
    var rexDashSlash = new RegExp(rexString.replace(/%%NUMD%%/g, "-").replace(/%%DATED%%/g, "\/"));
    var rexSlashDash = new RegExp(rexString.replace(/%%NUMD%%/g, "\/").replace(/%%DATED%%/g, "-"));
    var monthString = "january february march april may june july august september october november december spring summer fall winter spring summer";
    this.monthStrings = monthString.split(" ");
    this.setOrderDayMonth = function() {
        this.monthGuess = 1;
        this.dayGuess = 0;
    };
    this.setOrderMonthDay = function() {
        this.monthGuess = 0;
        this.dayGuess = 1;
    };
    this.resetDateParserMonths = function() {
        this.monthSets = [];
        for (var i=0,ilen=this.monthStrings.length; i<ilen; i++) {
            this.monthSets.push([this.monthStrings[i]]);
        }
        this.monthAbbrevs = [];
        for (var i=0,ilen=this.monthSets.length; i<ilen; i++) {
            this.monthAbbrevs.push([]);
            for (var j=0,jlen=this.monthSets[i].length; j<jlen; j++) {
                this.monthAbbrevs[i].push(this.monthSets[i][0].slice(0, 3));
            }
        }
        this.monthRexes = [];
        for (var i=0,ilen=this.monthAbbrevs.length; i<ilen; i++) {
            this.monthRexes.push(new RegExp("(?:" + this.monthAbbrevs[i].join("|") + ")"));
        }
    };
    this.addDateParserMonths = function(lst) {
        if ("string" === typeof lst) {
            lst = lst.split(/\s+/);
        }
        if (lst.length !== 12 && lst.length !== 16) {
            CSL.debug("month [+season] list of "+lst.length+", expected 12 or 16. Ignoring.");
            return;
        }
        var otherMatch = [];
        var thisMatch = [];
        for (var i=0,ilen=lst.length; i<ilen; i++) {
            var abbrevLength = null;
            var skip = false;
            var insert = 3;
            var extendedSets = {};
            for (var j=0,jlen=this.monthAbbrevs.length; j<jlen; j++) {
                extendedSets[j] = {};
                if (j === i) {
                    for (var k=0,klen=this.monthAbbrevs[i].length; k<klen; k++) {
                        if (this.monthAbbrevs[i][k] === lst[i].slice(0, this.monthAbbrevs[i][k].length)) {
                            skip = true;
                            break;
                        }
                    }
                } else {
                    for (var k=0,klen=this.monthAbbrevs[j].length; k<klen; k++) {
                        abbrevLength = this.monthAbbrevs[j][k].length;
                        if (this.monthAbbrevs[j][k] === lst[i].slice(0, abbrevLength)) {
                            while (this.monthSets[j][k].slice(0, abbrevLength) === lst[i].slice(0, abbrevLength)) {
                                if (abbrevLength > lst[i].length || abbrevLength > this.monthSets[j][k].length) {
                                    CSL.debug("unable to disambiguate month string in date parser: "+lst[i]);
                                    break;
                                } else {
                                    abbrevLength += 1;
                                }
                            }
                            insert = abbrevLength;
                            extendedSets[j][k] = abbrevLength;
                        }
                    }
                }
                for (var jKey in extendedSets) {
                    for (kKey in extendedSets[jKey]) {
                        abbrevLength = extendedSets[jKey][kKey];
                        jKey = parseInt(jKey, 10);
                        kKey = parseInt(kKey, 10);
                        this.monthAbbrevs[jKey][kKey] = this.monthSets[jKey][kKey].slice(0, abbrevLength);
                    }
                }
            }
            if (!skip) {
                this.monthSets[i].push(lst[i]);
                this.monthAbbrevs[i].push(lst[i].slice(0, insert));
            }
        }
        this.monthRexes = [];
        this.monthRexStrs = [];
        for (var i=0,ilen=this.monthAbbrevs.length; i<ilen; i++) {
            this.monthRexes.push(new RegExp("^(?:" + this.monthAbbrevs[i].join("|") + ")"));
            this.monthRexStrs.push("^(?:" + this.monthAbbrevs[i].join("|") + ")");
        }
        if (this.monthAbbrevs.length === 18) {
            for (var i=12,ilen=14; i<ilen; i++) {
                this.monthRexes[i+4] = new RegExp("^(?:" + this.monthAbbrevs[i].join("|") + ")");
                this.monthRexStrs[i+4] = "^(?:" + this.monthAbbrevs[i].join("|") + ")";
            }
        }
    };
    this.convertDateObjectToArray = function (thedate) {
        thedate["date-parts"] = [];
        thedate["date-parts"].push([]);
        var slicelen = 0;
        for (var i=0,ilen=3; i<ilen; i++) {
            var part = ["year", "month", "day"][i];
            if (!thedate[part]) {
                break;
            }
            slicelen += 1;
            thedate["date-parts"][0].push(thedate[part]);
            delete thedate[part];
        }
        thedate["date-parts"].push([]);
        for (var i=0, ilen=slicelen; i<ilen; i++) {
            part = ["year_end", "month_end", "day_end"][i];
            if (!thedate[part]) {
                break;
            }
            thedate["date-parts"][1].push(thedate[part]);
            delete thedate[part];
        }
        if (thedate["date-parts"][0].length !== thedate["date-parts"][1].length) {
            thedate["date-parts"].pop();
        }
        return thedate;
    };
    this.convertDateObjectToString = function(thedate) {
        var ret = [];
        for (var i = 0, ilen = 3; i < ilen; i += 1) {
            if (thedate[DATE_PARTS_ALL[i]]) {
                ret.push(thedate[DATE_PARTS_ALL[i]]);
            } else {
                break;
            }
        }
        return ret.join("-");
    }
    this._parseNumericDate = function (ret, delim, suff, txt) {
        if (!suff) suff = "";
        var lst = txt.split(delim);
        for (var i=0, ilen=lst.length; i<ilen; i++) {
            if (lst[i].length === 4) {
                ret[("year" + suff)] = lst[i].replace(/^0*/, "");
                if (!i) {
                    lst = lst.slice(1);
                } else {
                    lst = lst.slice(0, i);
                }
                break;
            }
        }
        for (var i=0,ilen=lst.length; i<ilen; i++) {
            lst[i] = parseInt(lst[i], 10);
        }
        if (lst.length === 1 || (lst.length === 2 && !lst[1])) {
            ret[("month" + suff)] = "" + lst[0];
        } else if (lst.length === 2) {
            if (lst[this.monthGuess] > 12) {
                ret[("month" + suff)] = "" + lst[this.dayGuess];
                ret[("day" + suff)] = "" + lst[this.monthGuess];
            } else {
                ret[("month" + suff)] = "" + lst[this.monthGuess];
                ret[("day" + suff)] = "" + lst[this.dayGuess];
            }
        }
    };
    this.parseDateToObject = function (txt) {
        var orig = txt;
        var slashPos = -1;
        var dashPos = -1;
        var yearIsNegative = false;
        var lst;
        if (txt) {
            if (txt.slice(0, 1) === "-") {
                yearIsNegative = true;
                txt = txt.slice(1);
            }
            if (txt.match(/^[0-9]{1,3}$/)) {
                while (txt.length < 4) {
                    txt = "0" + txt;
                }
            }
            txt = "" + txt;
            txt = txt.replace(/\s*[0-9]{2}:[0-9]{2}(?::[0-9]+)/,"");
            var m = txt.match(kanjiMonthDay);
            if (m) {
                txt = txt.replace(/\s+/g, "");
                txt = txt.replace(kanjiYear, "");
                txt = txt.replace(kanjiMonthDay, "-");
                txt = txt.replace(kanjiRange, "/");
                txt = txt.replace(/\-\//g, "/");
                txt = txt.replace(/-$/g,"");
                var slst = txt.split(epochSplitter);
                lst = [];
                var mm = txt.match(epochMatcher);
                if (mm) {
                    var mmx = [];
                    for (var i=0,ilen=mm.length; i<ilen; i++) {
                        mmx = mmx.concat(mm[i].match(/([^0-9]+)([0-9]+)/).slice(1));
                    }
                    for (var i=0,ilen=slst.length; i<ilen; i++) {
                        lst.push(slst[i]);
                        if (i !== (len - 1)) {
                            var mmpos = (pos * 2);
                            lst.push(mmx[mmpos]);
                            lst.push(mmx[mmpos + 1]);
                        }
                    }
                } else {
                    lst = slst;
                }
                for (var i=1,ilen=lst.length; i<ilen; i+=3) {
                    lst[i + 1] = jiy[lst[i]] + parseInt(lst[i + 1], 10);
                    lst[i] = "";
                }
                txt = lst.join("");
                txt = txt.replace(/\s*-\s*$/, "").replace(/\s*-\s*\//, "/");
                txt = txt.replace(/\.\s*$/, "");
                txt = txt.replace(/\.(?! )/, "");
                slashPos = txt.indexOf("/");
                dashPos = txt.indexOf("-");
            }
        }
        txt = txt.replace(/([A-Za-z])\./g, "$1");
        var number = "";
        var note = "";
        var thedate = {};
        var rangeDelim;
        var dateDelim;
        if (txt.slice(0, 1) === "\"" && txt.slice(-1) === "\"") {
            thedate.literal = txt.slice(1, -1);
            return thedate;
        }
        if (slashPos > -1 && dashPos > -1) {
            var slashCount = txt.split("/");
            if (slashCount.length > 3) {
                rangeDelim = "-";
                txt = txt.replace(/\_/g, "-");
                dateDelim = "/";
                lst = txt.split(rexSlashDash);
            } else {
                rangeDelim = "/";
                txt = txt.replace(/\_/g, "/");
                dateDelim = "-";
                lst = txt.split(rexDashSlash);
            }
        } else {
            txt = txt.replace(/\//g, "-");
            txt = txt.replace(/\_/g, "-");
            rangeDelim = "-";
            dateDelim = "-";
            lst = txt.split(rexDash);
        }
        var ret = [];
        for (var i=0,ilen=lst.length; i<ilen; i++) {
            var m = lst[i].match(/^\s*([\-\/]|[^\-\/\~\?0-9]+|[\-~?0-9]+)\s*$/);
            if (m) {
                ret.push(m[1]);
            }
        }
        var delimPos = ret.indexOf(rangeDelim);
        var delims = [];
        var isRange = false;
        if (delimPos > -1) {
            delims.push([0, delimPos]);
            delims.push([(delimPos + 1), ret.length]);
            isRange = true;
        } else {
            delims.push([0, ret.length]);
        }
        var suff = "";
        for (var i=0,ilen=delims.length; i<ilen; i++) {
            var delim = delims[i];
            var date = ret.slice(delim[0], delim[1]);
            outer: 
            for (var j=0,jlen=date.length; j<jlen; j++) {
                var element = date[j];
                if (element.indexOf(dateDelim) > -1) {
                    this._parseNumericDate(thedate, dateDelim, suff, element);
                    continue;
                }
                if (element.match(/[0-9]{4}/)) {
                    thedate[("year" + suff)] = element.replace(/^0*/, "");
                    continue;
                }
                for (var k=0,klen=this.monthRexes.length; k<klen; k++) {
                    if (element.toLocaleLowerCase().match(this.monthRexes[k])) {
                        thedate[("month" + suff)] = "" + (parseInt(k, 10) + 1);
                        continue outer;
                    }
                }
                if (element.match(/^[0-9]+$/)) {
                    number = element;
                }
                if (element.toLocaleLowerCase().match(/^bc/) && number) {
                    thedate[("year" + suff)] = "" + (number * -1);
                    number = "";
                    continue;
                }
                if (element.toLocaleLowerCase().match(/^ad/) && number) {
                    thedate[("year" + suff)] = "" + number;
                    number = "";
                    continue;
                }
                if (element === "~" || element === "?" || element === "c" || element.match(/^cir/)) {
                    thedate.circa = "" + 1;
                    continue;
                }
                if (element.toLocaleLowerCase().match(/(?:mic|tri|hil|eas)/) && !thedate[("season" + suff)]) {
                    note = element;
                    continue;
                }
            }
            if (number) {
                thedate[("day" + suff)] = number;
                number = "";
            }
            if (note && !thedate[("season" + suff)]) {
                thedate[("season" + suff)] = note;
                note = "";
            }
            suff = "_end";
        }
        if (isRange) {
            for (var j=0,jlen=CSL.DATE_PARTS_ALL.length; j<jlen; j++) {
                var item = CSL.DATE_PARTS_ALL[j];
                if (thedate[item] && !thedate[(item + "_end")]) {
                    thedate[(item + "_end")] = thedate[item];
                } else if (!thedate[item] && thedate[(item + "_end")]) {
                    thedate[item] = thedate[(item + "_end")];
                }
            }
        }
        if (!thedate.year || (thedate.year && thedate.day && !thedate.month)) {
            thedate = { "literal": orig };
        }
        var parts = ["year", "month", "day", "year_end", "month_end", "day_end"];
        for (var i=0,ilen=parts.length; i<ilen; i++) {
            var part = parts[i];
            if ("string" === typeof thedate[part] && thedate[part].match(/^[0-9]+$/)) {
                thedate[part] = parseInt(thedate[part], 10);
            }
        }
        if (yearIsNegative && Object.keys(thedate).indexOf("year") > -1) {
            thedate.year = (thedate.year * -1);
        }
        return thedate;
    };
    this.parseDateToArray = function(txt) {
        return this.convertDateObjectToArray(this.parseDateToObject(txt));            
    }
    this.parseDateToString = function(txt) {
        return this.convertDateObjectToString(this.parseDateToObject(txt));
    }
    this.parse = function(txt) {
        return this.parseDateToObject(txt);
    }
    this.setOrderMonthDay();
    this.resetDateParserMonths();
};
module.exports = CSL;
CSL.Engine = function (sys, style, lang, forceLang) {
    var attrs, langspec, localexml, locale;
    this.processor_version = CSL.PROCESSOR_VERSION;
    this.csl_version = "1.0";
    this.sys = sys;
    if (sys.variableWrapper) {
        CSL.VARIABLE_WRAPPER_PREPUNCT_REX = new RegExp('^([' + [" "].concat(CSL.SWAPPING_PUNCTUATION).join("") + ']*)(.*)');
    }
    if (CSL.retrieveStyleModule) {
        this.sys.retrieveStyleModule = CSL.retrieveStyleModule;
    }
    if (CSL.getAbbreviation) {
        this.sys.getAbbreviation = CSL.getAbbreviation;
    }
    if (this.sys.stringCompare) {
        CSL.stringCompare = this.sys.stringCompare;
    }
    this.sys.AbbreviationSegments = CSL.AbbreviationSegments;
    this.parallel = new CSL.Parallel(this);
    this.transform = new CSL.Transform(this);
    this.setParseNames = function (val) {
        this.opt['parse-names'] = val;
    };
    this.opt = new CSL.Engine.Opt();
    this.tmp = new CSL.Engine.Tmp();
    this.build = new CSL.Engine.Build();
    this.fun = new CSL.Engine.Fun(this);
    this.configure = new CSL.Engine.Configure();
    this.citation_sort = new CSL.Engine.CitationSort();
    this.bibliography_sort = new CSL.Engine.BibliographySort();
    this.citation = new CSL.Engine.Citation(this);
    this.bibliography = new CSL.Engine.Bibliography();
    this.output = new CSL.Output.Queue(this);
    this.dateput = new CSL.Output.Queue(this);
    this.cslXml = CSL.setupXml(style);
    if (this.opt.development_extensions.csl_reverse_lookup_support || this.sys.csl_reverse_lookup_support) {
        this.build.cslNodeId = 0;
        this.setCslNodeIds = function(myxml, nodename) {
            var children = this.cslXml.children(myxml);
            this.cslXml.setAttribute(myxml, 'cslid', this.build.cslNodeId);
            this.opt.nodenames.push(nodename);
            this.build.cslNodeId += 1;
            for (var i = 0, ilen = this.cslXml.numberofnodes(children); i < ilen; i += 1) {
                nodename = this.cslXml.nodename(children[i]);
                if (nodename) {
                    this.setCslNodeIds(children[i], nodename);
                }
            }
        };
        this.setCslNodeIds(this.cslXml.dataObj, "style");
    }
    this.cslXml.addMissingNameNodes(this.cslXml.dataObj);
    this.cslXml.addInstitutionNodes(this.cslXml.dataObj);
    this.cslXml.insertPublisherAndPlace(this.cslXml.dataObj);
    this.cslXml.flagDateMacros(this.cslXml.dataObj);
    attrs = this.cslXml.attributes(this.cslXml.dataObj);
    if ("undefined" === typeof attrs["@sort-separator"]) {
        this.cslXml.setAttribute(this.cslXml.dataObj, "sort-separator", ", ");
    }
    this.opt["initialize-with-hyphen"] = true;
    this.setStyleAttributes();
    this.opt.xclass = this.cslXml.getAttributeValue(this.cslXml.dataObj, "class");
    this.opt["class"] = this.opt.xclass;
    this.opt.styleID = this.cslXml.getStyleId(this.cslXml.dataObj);
    this.opt.styleName = this.cslXml.getStyleId(this.cslXml.dataObj, true);
    if (this.opt.version.slice(0,4) === "1.1m") {
        this.opt.development_extensions.static_statute_locator = true;
        this.opt.development_extensions.handle_parallel_articles = true;
        this.opt.development_extensions.main_title_from_short_title = true;
        this.opt.development_extensions.rtl_support = true;
        this.opt.development_extensions.expect_and_symbol_form = true;
        this.opt.development_extensions.require_explicit_legal_case_title_short = true;
        this.opt.development_extensions.force_jurisdiction = true;
    }
    if (lang) {
        lang = lang.replace("_", "-");
        lang = CSL.normalizeLocaleStr(lang);
    }
    if (this.opt["default-locale"][0]) {
        this.opt["default-locale"][0] = this.opt["default-locale"][0].replace("_", "-");
        this.opt["default-locale"][0] = CSL.normalizeLocaleStr(this.opt["default-locale"][0]);
    }
    if (lang && forceLang) {
        this.opt["default-locale"] = [lang];
    }
    if (lang && !forceLang && this.opt["default-locale"][0]) {
        lang = this.opt["default-locale"][0];
    }
    if (this.opt["default-locale"].length === 0) {
        if (!lang) {
            lang = "en-US";
        }
        this.opt["default-locale"].push("en-US");
    }
    if (!lang) {
        lang = this.opt["default-locale"][0];
    }
    langspec = CSL.localeResolve(lang);
    this.opt.lang = langspec.best;
    this.opt["default-locale"][0] = langspec.best;
    this.locale = {};
    if (!this.opt["default-locale-sort"]) {
        this.opt["default-locale-sort"] = this.opt["default-locale"][0];
    }
    if ('dale|'.localeCompare('daleb', this.opt["default-locale-sort"]) > -1) {
        this.opt.sort_sep = "@";
    } else {
        this.opt.sort_sep = "|";
    }
    this.localeConfigure(langspec);
    function makeRegExp(lst) {
        var lst = lst.slice();
        var ret = new RegExp( "(?:(?:[?!:]*\\s+|-|^)(?:" + lst.join("|") + ")(?=[!?:]*\\s+|-|$))", "g");
        return ret;
    }
    this.locale[this.opt.lang].opts["skip-words-regexp"] = makeRegExp(this.locale[this.opt.lang].opts["skip-words"]);
    this.output.adjust = new CSL.Output.Queue.adjust(this.getOpt('punctuation-in-quote'));
    this.registry = new CSL.Registry(this);
    this.macros = {};
    this.build.area = "citation";
    var area_nodes = this.cslXml.getNodesByName(this.cslXml.dataObj, this.build.area);
    this.buildTokenLists(area_nodes, this[this.build.area].tokens);
    this.build.area = "bibliography";
    var area_nodes = this.cslXml.getNodesByName(this.cslXml.dataObj, this.build.area);
    this.buildTokenLists(area_nodes, this[this.build.area].tokens);
    this.juris = {};
    this.configureTokenLists();
    this.disambiguate = new CSL.Disambiguation(this);
    this.splice_delimiter = false;
    this.fun.dateparser = CSL.DateParser;
    this.fun.flipflopper = new CSL.Util.FlipFlopper(this);
    this.setCloseQuotesArray();
    this.fun.ordinalizer.init(this);
    this.fun.long_ordinalizer.init(this);
    this.fun.page_mangler = CSL.Util.PageRangeMangler.getFunction(this, "page");
    this.fun.year_mangler = CSL.Util.PageRangeMangler.getFunction(this, "year");
    this.setOutputFormat("html");
};
CSL.Engine.prototype.setCloseQuotesArray = function () {
    var ret;
    ret = [];
    ret.push(this.getTerm("close-quote"));
    ret.push(this.getTerm("close-inner-quote"));
    ret.push('"');
    ret.push("'");
    this.opt.close_quotes_array = ret;
};
CSL.makeBuilder = function (me, target) {
    var var_stack = [];
    function enterFunc (node) {
        CSL.XmlToToken.call(node, me, CSL.START, target, var_stack);
    };
    function leaveFunc (node) {
        CSL.XmlToToken.call(node, me, CSL.END, target, var_stack);
    };
    function singletonFunc (node) {
        CSL.XmlToToken.call(node, me, CSL.SINGLETON, target, var_stack);
    };
    function buildStyle (node) {
        var starttag, origparent;
        if (me.cslXml.numberofnodes(me.cslXml.children(node))) {
            origparent = node;
            enterFunc(origparent);
            for (var i=0;i<me.cslXml.numberofnodes(me.cslXml.children(origparent));i+=1) {
                node = me.cslXml.children(origparent)[i];
                if (me.cslXml.nodename(node) === null) {
                    continue;
                }
                if (me.cslXml.nodename(node) === "date") {
                    CSL.Util.fixDateNode.call(me, origparent, i, node)
                    node = me.cslXml.children(origparent)[i];
                }
                buildStyle(node, enterFunc, leaveFunc, singletonFunc);
            }
            leaveFunc(origparent);
        } else {
            singletonFunc(node);
        }
    }
    return buildStyle;
};
CSL.Engine.prototype.buildTokenLists = function (area_nodes, target) {
    if (!this.cslXml.getNodeValue(area_nodes)) return;
    var builder = CSL.makeBuilder(this, target);
    var mynode;
    if ("undefined" === typeof area_nodes.length) {
        mynode = area_nodes;
    } else {
        mynode = area_nodes[0];
    }
    builder(mynode);
};
CSL.Engine.prototype.setStyleAttributes = function () {
    var dummy, attr, key, attributes, attrname;
    var dummy = {};
    dummy.name = this.cslXml.nodename(this.cslXml.dataObj);
    attributes = this.cslXml.attributes(this.cslXml.dataObj);
    for (attrname in attributes) {
        if (attributes.hasOwnProperty(attrname)) {
            CSL.Attributes[attrname].call(dummy, this, attributes[attrname]);
        }
    }
};
CSL.Engine.prototype.getTerm = function (term, form, plural, gender, mode, forceDefaultLocale) {
    if (term && term.match(/[A-Z]/) && term === term.toUpperCase()) {
        CSL.debug("Warning: term key is in uppercase form: "+term);
        term = term.toLowerCase();
    }
    var lang;
    if (forceDefaultLocale) {
        lang = this.opt["default-locale"][0];
    } else {
        lang = this.opt.lang;
    }
    var ret = CSL.Engine.getField(CSL.LOOSE, this.locale[lang].terms, term, form, plural, gender);
    if (!ret && term === "range-delimiter") {
        ret = "\u2013";
    }
    if (typeof ret === "undefined") {
        if (mode === CSL.STRICT) {
            throw "Error in getTerm: term \"" + term + "\" does not exist.";
        } else if (mode === CSL.TOLERANT) {
            ret = "";
        }
    }
    if (ret) {
        this.tmp.cite_renders_content = true;
    }
    return ret;
};
CSL.Engine.prototype.getDate = function (form, forceDefaultLocale) {
    var lang;
    if (forceDefaultLocale) {
        lang = this.opt["default-locale"];
    } else {
        lang = this.opt.lang;
    }
    if (this.locale[lang].dates[form]) {
        return this.locale[lang].dates[form];
    } else {
        return false;
    }
};
CSL.Engine.prototype.getOpt = function (arg) {
    if ("undefined" !== typeof this.locale[this.opt.lang].opts[arg]) {
        return this.locale[this.opt.lang].opts[arg];
    } else {
        return false;
    }
};
CSL.Engine.prototype.getVariable = function (Item, varname, form, plural) {
    return CSL.Engine.getField(CSL.LOOSE, Item, varname, form, plural);
};
CSL.Engine.prototype.getDateNum = function (ItemField, partname) {
    if ("undefined" === typeof ItemField) {
        return 0;
    } else {
        return ItemField[partname];
    }
};
CSL.Engine.getField = function (mode, hash, term, form, plural, gender) {
    var ret, forms, f, pos, len, hashterm;
    ret = "";
    if ("undefined" === typeof hash[term]) {
        if (mode === CSL.STRICT) {
            throw "Error in getField: term \"" + term + "\" does not exist.";
        } else {
            return undefined;
        }
    }
    if (gender && hash[term][gender]) {
        hashterm = hash[term][gender];
    } else {
        hashterm = hash[term];
    }
    forms = [];
    if (form === "symbol") {
        forms = ["symbol", "short"];
    } else if (form === "verb-short") {
        forms = ["verb-short", "verb"];
    } else if (form !== "long") {
        forms = [form];
    }
    forms = forms.concat(["long"]);
    len = forms.length;
    for (pos = 0; pos < len; pos += 1) {
        f = forms[pos];
        if ("string" === typeof hashterm || "number" === typeof hashterm) {
            ret = hashterm;
        } else if ("undefined" !== typeof hashterm[f]) {
            if ("string" === typeof hashterm[f] || "number" === typeof hashterm[f]) {
                ret = hashterm[f];
            } else {
                if ("number" === typeof plural) {
                    ret = hashterm[f][plural];
                } else {
                    ret = hashterm[f][0];
                }
            }
            break;
        }
    }
    return ret;
};
CSL.Engine.prototype.configureTokenLists = function () {
    var dateparts_master, area, pos, token, dateparts, part, ppos, pppos, len, llen, lllen;
    len = CSL.AREAS.length;
    for (pos = 0; pos < len; pos += 1) {
        area = CSL.AREAS[pos];
        var tokens = this[area].tokens;
        this.configureTokenList(tokens);
    }
    this.version = CSL.version;
    return this.state;
};
CSL.Engine.prototype.configureTokenList = function (tokens) {
    var dateparts_master, area, pos, token, dateparts, part, ppos, pppos, len, llen, lllen;
    dateparts_master = ["year", "month", "day"];
    llen = tokens.length - 1;
    for (ppos = llen; ppos > -1; ppos += -1) {
        token = tokens[ppos];
        if ("date" === token.name && CSL.END === token.tokentype) {
            dateparts = [];
        }
        if ("date-part" === token.name && token.strings.name) {
            lllen = dateparts_master.length;
            for (pppos = 0; pppos < lllen; pppos += 1) {
                part = dateparts_master[pppos];
                if (part === token.strings.name) {
                    dateparts.push(token.strings.name);
                }
            }
        }
        if ("date" === token.name && CSL.START === token.tokentype) {
            dateparts.reverse();
            token.dateparts = dateparts;
        }
        token.next = (ppos + 1);
        if (token.name && CSL.Node[token.name].configure) {
            CSL.Node[token.name].configure.call(token, this, ppos);
        }
    }
}
CSL.Engine.prototype.retrieveItems = function (ids) {
    var ret, pos, len;
    ret = [];
    for (var i = 0, ilen = ids.length; i < ilen; i += 1) {
        ret.push(this.retrieveItem("" + ids[i]));
    }
    return ret;
};
CSL.ITERATION = 0;
CSL.Engine.prototype.retrieveItem = function (id) {
    var Item, m, pos, len, mm, i;
    if (!this.tmp.loadedItemIDs[id]) {
        this.tmp.loadedItemIDs[id] = true;
    } else {
        return this.registry.refhash[id];
    }
    if (this.opt.development_extensions.normalize_lang_keys_to_lowercase &&
        "boolean" === typeof this.opt.development_extensions.normalize_lang_keys_to_lowercase) {
        for (var i=0,ilen=this.opt["default-locale"].length; i<ilen; i+=1) {
            this.opt["default-locale"][i] = this.opt["default-locale"][i].toLowerCase();
        }
        for (var i=0,ilen=this.opt["locale-translit"].length; i<ilen; i+=1) {
            this.opt["locale-translit"][i] = this.opt["locale-translit"][i].toLowerCase();
        }
        for (var i=0,ilen=this.opt["locale-translat"].length; i<ilen; i+=1) {
            this.opt["locale-translat"][i] = this.opt["locale-translat"][i].toLowerCase();
        }
        this.opt.development_extensions.normalize_lang_keys_to_lowercase = 100;
    }
    CSL.ITERATION += 1;
    Item = JSON.parse(JSON.stringify(this.sys.retrieveItem("" + id)));
    if (this.opt.development_extensions.normalize_lang_keys_to_lowercase) {
        if (Item.multi) {
            if (Item.multi._keys) {
                for (var field in Item.multi._keys) {
                    for (var key in Item.multi._keys[field]) {
                        if (key !== key.toLowerCase()) {
                            Item.multi._keys[field][key.toLowerCase()] = Item.multi._keys[field][key];
                            delete Item.multi._keys[field][key];
                        }
                    }
                }
            }
            if (Item.multi.main) {
                for (var field in Item.multi.main) {
                    Item.multi.main[field] = Item.multi.main[field].toLowerCase();
                }
            }
        }
        for (var i=0, ilen=CSL.CREATORS.length; i>ilen; i+=1) {
            var ctype = CSL.CREATORS[i];
            if (Item[ctype] && Item[ctype].multi) {
                for (var j=0, jlen=Item[ctype].length; j<jlen; j+=1) {
                    var creator = Item[ctype][j];
                    if (creator.multi) {
                        if (creator.multi._key) {
                            for (var key in creator.multi._key) {
                                if (key !== key.toLowerCase()) {
                                    creator.multi._key[key.toLowerCase()] = creator.multi._key[key];
                                    delete creator.multi._key[key];
                                }
                            }
                        }
                        if (creator.multi.main) {
                            creator.multi.main = creator.multi.main.toLowerCase();
                        }
                    }
                }
            }
        }
    }
    if (Item.language) {
        var lst = Item.language.split("<");
        if (lst.length > 0) {
            Item["language-name"] = lst[0];
        }
        if (lst.length === 2) {
            Item["language-name-original"] = lst[1];
        }
    }
    if (Item.page) {
        Item["page-first"] = Item.page;
        var num = "" + Item.page;
        var m = num.split(/\s*(?:&|, |-|\u2013)\s*/);
        if (m[0].slice(-1) !== "\\") {
            Item["page-first"] = m[0];
        }
    }
    if (this.opt.development_extensions.field_hack && Item.note) {
        CSL.parseNoteFieldHacks(Item, false, this.opt.development_extensions.allow_field_hack_date_override);
    }
    for (var i = 1, ilen = CSL.DATE_VARIABLES.length; i < ilen; i += 1) {
        var dateobj = Item[CSL.DATE_VARIABLES[i]];
        if (dateobj) {
            if (this.opt.development_extensions.raw_date_parsing) {
                if (dateobj.raw) {
                    dateobj = this.fun.dateparser.parseDateToObject(dateobj.raw);
                }
            }
            Item[CSL.DATE_VARIABLES[i]] = this.dateParseArray(dateobj);
        }
    }
    if (this.opt.development_extensions.static_statute_locator) {
        if (Item.type && ["bill","gazette","legislation","regulation","treaty"].indexOf(Item.type) > -1) {
            var varname;
            var elements = ["type", "title", "jurisdiction", "genre", "volume", "container-title"];
            var legislation_id = [];
            for (i = 0, ilen = elements.length; i < ilen; i += 1) {
                varname = elements[i];
				if (Item[varname]) {
					legislation_id.push(Item[varname]);
				}
			}
            elements = ["original-date", "issued"];
			for (i = 0, elements.length; i < ilen; i += 1) {
                varname = elements[i];
				if (Item[varname] && Item[varname].year) {
					var value = Item[varname].year;
					legislation_id.push(value);
					break;
				}
			}
			Item.legislation_id = legislation_id.join("::");
        }
    }
    if (this.opt.development_extensions.force_jurisdiction) {
        if ("string" === typeof Item.authority) {
            Item.authority = [
                {
                    literal: Item.authority
                }
            ]
        }
    }
    if (!Item["title-short"]) {
        Item["title-short"] = Item.shortTitle;
    }
    if (this.opt.development_extensions.main_title_from_short_title) {
        CSL.extractTitleAndSubtitle(Item);
    }
    var isLegalType = ["bill","legal_case","legislation","gazette","regulation"].indexOf(Item.type) > -1;
    if (this.opt.development_extensions.force_jurisdiction && isLegalType) {
        if (!Item.jurisdiction) {
            Item.jurisdiction = "us";
        }
    }
    if (!isLegalType && Item.title && this.sys.getAbbreviation) {
        var noHints = false;
        if (!Item.jurisdiction) {
            noHints = true;
        }
        if (this.sys.normalizeAbbrevsKey) {
            var normalizedKey = this.sys.normalizeAbbrevsKey(Item.title);
        } else {
            var normalizedKey = Item.title;
        }
        var jurisdiction = this.transform.loadAbbreviation(Item.jurisdiction, "title", normalizedKey, Item.type);
        if (this.transform.abbrevs[jurisdiction]["title"]) {
            if (this.transform.abbrevs[jurisdiction]["title"][normalizedKey]) {
                Item["title-short"] = this.transform.abbrevs[jurisdiction]["title"][normalizedKey];
            }
        }
    }
    if (!Item["container-title-short"]) {
        Item["container-title-short"] = Item.journalAbbreviation;
    }
    if (Item["container-title"] && this.sys.getAbbreviation) {
        if (this.sys.normalizeAbbrevsKey) {
            var normalizedKey = this.sys.normalizeAbbrevsKey(Item["container-title"]);
        } else {
            var normalizedKey = Item["container-title"];
        }
        var jurisdiction = this.transform.loadAbbreviation(Item.jurisdiction, "container-title", normalizedKey);
        if (this.transform.abbrevs[jurisdiction]["container-title"]) {
            if (this.transform.abbrevs[jurisdiction]["container-title"][normalizedKey]) {
                Item["container-title-short"] = this.transform.abbrevs[jurisdiction]["container-title"][normalizedKey];
            }
        }
    }
    if (Item["jurisdiction"]) {
        Item["country"] = Item["jurisdiction"].split(":")[0];
    }
    this.registry.refhash[id] = Item;
    return Item;
};
CSL.Engine.prototype.setOpt = function (token, name, value) {
    if (token.name === "style" || token.name === "cslstyle") {
        this.opt.inheritedAttributes[name] = value;
        this.citation.opt.inheritedAttributes[name] = value;
        this.bibliography.opt.inheritedAttributes[name] = value;
    } else if (["citation", "bibliography"].indexOf(token.name) > -1) {
        this[token.name].opt.inheritedAttributes[name] = value;
    } else {
        token.strings[name] = value;
    }
};
CSL.Engine.prototype.inheritOpt = function (token, attrname, parentname, defaultValue) {
    if ("undefined" !== typeof token.strings[attrname]) {
        return token.strings[attrname];
    } else {
        var parentValue = this[this.tmp.root].opt.inheritedAttributes[parentname ? parentname : attrname];
        if ("undefined" !== typeof parentValue) {
            return parentValue;
        } else {
            return defaultValue;
        }
    }
};
module.exports = CSL;
CSL.Engine.prototype.remapSectionVariable = function (inputList) {
    for (var i = 0, ilen = inputList.length; i < ilen; i += 1) {
        var Item = inputList[i][0];
        var item = inputList[i][1];
        if (["bill","gazette","legislation","regulation","treaty"].indexOf(Item.type) > -1) {
            if (item.locator) {
                item.locator = item.locator.trim();
                var m = item.locator.match(CSL.STATUTE_SUBDIV_PLAIN_REGEX_FRONT);
                if (!m) {
                    if (item.label) {
                        item.locator = CSL.STATUTE_SUBDIV_STRINGS_REVERSE[item.label] + " " + item.locator;
                    } else {
                        item.locator = "p. " + item.locator;
                    }
                }
            }
            var sectionMasterLabel = null;
            if (Item.section) {
                Item.section = Item.section.trim();
                var m = Item.section.match(CSL.STATUTE_SUBDIV_PLAIN_REGEX_FRONT);
                if (!m) {
                    Item.section = "sec. " + Item.section;
                    sectionMasterLabel = "sec.";
                } else {
                    sectionMasterLabel = m[0].trim();
                }
            }
            if (Item.section) {
                if (!item.locator) {
                    item.locator = Item.section;
                } else {
                    var m = item.locator.match(/^([^ ]*)\s*(.*)/);
                    var space = " ";
                    if (m) {
                        if (m[1] === "p." && sectionMasterLabel !== "p.") {
                            item.locator = m[2];
                        }
                        if (["[", "(", ".", ",", ";", ":", "?"].indexOf(item.locator.slice(0, 1)) > -1) {
                            space = "";
                        }
                    } else {
                       space = ""; 
                    }
                    item.locator = Item.section + space + item.locator;
                }
            }
            item.label = "";
        }
    }
}
CSL.Engine.prototype.setNumberLabels = function (Item) {
     if (Item.number
        && ["bill", "gazette", "legislation","regulation","treaty"].indexOf(Item.type) > -1
        && this.opt.development_extensions.static_statute_locator
        && !this.tmp.shadow_numbers["number"]) {
        this.tmp.shadow_numbers["number"] = {};
        this.tmp.shadow_numbers["number"].values = [];
        this.tmp.shadow_numbers["number"].plural = 0;
        this.tmp.shadow_numbers["number"].numeric = false;
        this.tmp.shadow_numbers["number"].label = false;
        var value = "" + Item.number;
        value = value.split("\\").join("");
        var firstword = value.split(/\s+/)[0];
        var firstlabel = CSL.STATUTE_SUBDIV_STRINGS[firstword];
        if (firstlabel) {
            var m = value.match(CSL.STATUTE_SUBDIV_GROUPED_REGEX);
            var splt = value.split(CSL.STATUTE_SUBDIV_PLAIN_REGEX);
            if (splt.length > 1) {
                var lst = [];
                for (var j=1, jlen=splt.length; j < jlen; j += 1) {
                    var subdiv = m[j - 1].replace(/^\s*/, "");
                    lst.push(splt[j].replace(/\s*$/, "").replace(/^\s*/, ""));
                }
                value = lst.join(" ");
            } else {
                value = splt[0];
            }
            this.tmp.shadow_numbers["number"].label = firstlabel;
            this.tmp.shadow_numbers["number"].values.push(["Blob", value, false]);
            this.tmp.shadow_numbers["number"].numeric = false;
        } else {
            this.tmp.shadow_numbers["number"].values.push(["Blob", value, false]);
            this.tmp.shadow_numbers["number"].numeric = true;
        }
    }
}
module.exports = CSL;
CSL.substituteOne = function (template) {
    return function (state, list) {
        if (!list) {
            return "";
        } else {
            return template.replace("%%STRING%%", list);
        }
    };
};
CSL.substituteTwo = function (template) {
    return function (param) {
        var template2 = template.replace("%%PARAM%%", param);
        return function (state, list) {
            if (!list) {
                return "";
            } else {
                return template2.replace("%%STRING%%", list);
            }
        };
    };
};
CSL.Mode = function (mode) {
    var decorations, params, param, func, val, args;
    decorations = {};
    params = CSL.Output.Formats[mode];
    for (param in params) {
        if (true) {
            if ("@" !== param.slice(0, 1)) {
                decorations[param] = params[param];
                continue;
            }
            func = false;
            val = params[param];
            args = param.split('/');
            if (typeof val === "string" && val.indexOf("%%STRING%%") > -1)  {
                if (val.indexOf("%%PARAM%%") > -1) {
                    func = CSL.substituteTwo(val);
                } else {
                    func = CSL.substituteOne(val);
                }
            } else if (typeof val === "boolean" && !val) {
                func = CSL.Output.Formatters.passthrough;
            } else if (typeof val === "function") {
                func = val;
            } else {
                throw "CSL.Compiler: Bad " + mode + " config entry for " + param + ": " + val;
            }
            if (args.length === 1) {
                decorations[args[0]] = func;
            } else if (args.length === 2) {
                if (!decorations[args[0]]) {
                    decorations[args[0]] = {};
                }
                decorations[args[0]][args[1]] = func;
            }
        }
    }
    return decorations;
};
CSL.setDecorations = function (state, attributes) {
    var ret, key, pos;
    ret = [];
    for (pos in CSL.FORMAT_KEY_SEQUENCE) {
        if (true) {
            var key = CSL.FORMAT_KEY_SEQUENCE[pos];
            if (attributes[key]) {
                ret.push([key, attributes[key]]);
                delete attributes[key];
            }
        }
    }
    return ret;
};
CSL.Doppeler = function(rexStr, stringMangler) {
    var mx, lst, len, pos, m, buf1, buf2, idx, ret, myret;
    this.split = split;
    this.join = join;
    var matchRex = new RegExp("(" + rexStr + ")", "g");
    var splitRex = new RegExp(rexStr, "g");
    function split(str) {
        if (stringMangler) {
            str = stringMangler(str);
        }
        var match = str.match(matchRex);
        if (!match) {
            return {
                tags: [],
                strings: [str]
            };
        }
        var split = str.split(splitRex);
        for (var i=match.length-1; i> -1; i--) {
            var tag = match[i];
            if (tag === "\'" && split[i+1].length > 0) {
                split[i+1] = match[i] + split[i+1];
                match[i] = "";
            }
        }
        return {
            tags: match,
            strings: split,
            origStrings: split.slice()
        }
    }
    function join(obj) {
        var lst = obj.strings.slice(-1);
        for (var i=obj.tags.length-1; i>-1; i--) {
            lst.push(obj.tags[i]);
            lst.push(obj.strings[i]);
        }
        lst.reverse();
        return lst.join("");
    }
}
CSL.Engine.prototype.normalDecorIsOrphan = function (blob, params) {
    if (params[1] === "normal") {
        var use_param = false;
        var all_the_decor;
        if (this.tmp.area === "citation") {
            all_the_decor = [this.citation.opt.layout_decorations].concat(blob.alldecor);
        } else {
            all_the_decor = blob.alldecor;
        }
        for (var k = all_the_decor.length - 1; k > -1; k += -1) {
            for (var n = all_the_decor[k].length - 1; n > -1; n += -1) {
                if (all_the_decor[k][n][0] === params[0]) {
                    if (all_the_decor[k][n][1] !== "normal") {
                        use_param = true;
                    }
                }
            }
        }
        if (!use_param) {
            return true;
        }
    }
    return false;
};
module.exports = CSL;
CSL.Engine.prototype.getCitationLabel = function (Item) {
    var label = "";
    var params = this.getTrigraphParams();
    var config = params[0];
    var myname = this.getTerm("reference", "short", 0);
    if ("undefined" === typeof myname) {
        myname = "reference";
    }
    myname = myname.replace(".", "");
    myname = myname.slice(0, 1).toUpperCase() + myname.slice(1);
    for (var i = 0, ilen = CSL.CREATORS.length; i < ilen; i += 1) {
        var n = CSL.CREATORS[i];
        if (Item[n]) {
            var names = Item[n];
            if (names.length > params.length) {
                config = params[params.length - 1];
            } else {
                config = params[names.length - 1];
            }
            for (var j = 0, jlen = names.length; j < jlen; j += 1) {
                if (j === config.authors.length) {
                    break;
                }
                var res = this.nameOutput.getName(names[j], "locale-translit", true);
                var name = res.name;
                if (name && name.family) {
                    myname = name.family;
                    myname = myname.replace(/^([ \'\u2019a-z]+\s+)/, "");
                } else if (name && name.literal) {
                    myname = name.literal;
                }
                var m = myname.toLowerCase().match(/^(a\s+|the\s+|an\s+)/);
                if (m) {
                    myname = myname.slice(m[1].length);
                }
                myname = myname.replace(CSL.ROMANESQUE_NOT_REGEXP, "");
                if (!myname) {
                    break;
                }
                myname = myname.slice(0, config.authors[j]);
                if (myname.length > 1) {
                    myname = myname.slice(0, 1).toUpperCase() + myname.slice(1).toLowerCase();
                } else if (myname.length === 1) {
                    myname = myname.toUpperCase();
                }
                label += myname;
            }
            break;
        }
    }
    if (!label) {
        if (Item.title) {
            var skipWords = this.locale[this.opt.lang].opts["skip-words"];
            var lst = Item.title.split(/\s+/);
            for (var i = lst.length - 1; i > -1; i--) {
                if (skipWords.indexOf(lst[i]) > -1) {
                    lst = lst.slice(0, i).concat(lst.slice(i + 1));
                }
            }
            var str = lst.join('');
            str = str.slice(0, params[0].authors[0]);
            if (str.length > 1) {
                str = str.slice(0, 1).toUpperCase() + str.slice(1).toLowerCase();
            } else if (str.length === 1) {
                str = str.toUpperCase();
            }
            label = str;
        }
    }
    var year = "0000";
    if (Item.issued) {
        if (Item.issued.year) {
            year = "" + Item.issued.year;
        }
    }
    year = year.slice((config.year * -1));
    label = label + year;
    return label;
};
CSL.Engine.prototype.getTrigraphParams = function () {
    var params = [];
    var ilst = this.opt.trigraph.split(":");
    if (!this.opt.trigraph || this.opt.trigraph.slice(0,1) !== "A") {
        throw "Bad trigraph definition: "+this.opt.trigraph;
    }
    for (var i = 0, ilen = ilst.length; i < ilen; i += 1) {
        var str = ilst[i];
        var config = {authors:[], year:0};
        for (var j = 0, jlen = str.length; j < jlen; j += 1) {
            switch (str.slice(j,j+1)) {
            case "A":
                config.authors.push(1);
                break;
            case "a":
                config.authors[config.authors.length - 1] += 1;
                break;
            case "0":
                config.year += 1;
                break;
            default:
                throw "Invalid character in trigraph definition: "+this.opt.trigraph;
            }
        }
        params.push(config);
    }
    return params;
};
module.exports = CSL;
CSL.Engine.prototype.setOutputFormat = function (mode) {
    this.opt.mode = mode;
    this.fun.decorate = CSL.Mode(mode);
    if (!this.output[mode]) {
        this.output[mode] = {};
        this.output[mode].tmp = {};
    }
};
CSL.Engine.prototype.getSortFunc = function () {
    return function (a,b) {
        a = a.split("-");
        b = b.split("-");
        if (a.length < b.length) {
            return 1
        } else if (a.length > b.length) {
            return -1
        } else {
            a = a.slice(-1)[0];
            b = b.slice(-1)[0];
            if (a.length < b.length) {
                return 1;
            } else if (a.length > b.length) {
                return -1;
            } else {
                return 0;
            }
        }
    };
};
CSL.Engine.prototype.setLangTagsForCslSort = function (tags) {
    var i, ilen;
    if (tags) {
        this.opt['locale-sort'] = [];
        for (i = 0, ilen = tags.length; i < ilen; i += 1) {
            this.opt['locale-sort'].push(tags[i]);
        }
    }
    this.opt['locale-sort'].sort(this.getSortFunc());
};
CSL.Engine.prototype.setLangTagsForCslTransliteration = function (tags) {
    var i, ilen;
    this.opt['locale-translit'] = [];
    if (tags) {
        for (i = 0, ilen = tags.length; i < ilen; i += 1) {
            this.opt['locale-translit'].push(tags[i]);
        }
    }
    this.opt['locale-translit'].sort(this.getSortFunc());
};
CSL.Engine.prototype.setLangTagsForCslTranslation = function (tags) {
    var i, ilen;
    this.opt['locale-translat'] = [];
    if (tags) {
        for (i = 0, ilen = tags.length; i < ilen; i += 1) {
            this.opt['locale-translat'].push(tags[i]);
        }
    }
    this.opt['locale-translat'].sort(this.getSortFunc());
};
CSL.Engine.prototype.setLangPrefsForCites = function (obj, conv) {
    var opt = this.opt['cite-lang-prefs'];
    if (!conv) {
        conv = function (key) {
            return key.toLowerCase();
        };
    }
    var segments = ['Persons', 'Institutions', 'Titles', 'Journals', 'Publishers', 'Places'];
    for (var i = 0, ilen = segments.length; i < ilen; i += 1) {
        var clientSegment = conv(segments[i]);
        var citeprocSegment = segments[i].toLowerCase();
        if (!obj[clientSegment]) {
            continue;
        }
        var supplements = [];
        while (obj[clientSegment].length > 1) {
            supplements.push(obj[clientSegment].pop());
        }
        var sortval = {orig:1,translit:2,translat:3};
        if (supplements.length === 2 && sortval[supplements[0]] < sortval[supplements[1]]) {
            supplements.reverse();
        }
        while (supplements.length) {
            obj[clientSegment].push(supplements.pop());
        }
        var lst = opt[citeprocSegment];
        while (lst.length) {
            lst.pop();
        }
        for (var j = 0, jlen = obj[clientSegment].length; j < jlen; j += 1) {
            lst.push(obj[clientSegment][j]);
        }
    }
};
CSL.Engine.prototype.setLangPrefsForCiteAffixes = function (affixList) {
    if (affixList && affixList.length === 48) {
        var affixes = this.opt.citeAffixes;
        var count = 0;
        var settings = ["persons", "institutions", "titles", "journals", "publishers", "places"];
        var forms = ["translit", "orig", "translit", "translat"];
        var value;
        for (var i = 0, ilen = settings.length; i < ilen; i += 1) {
            for (var j = 0, jlen = forms.length; j < jlen; j += 1) {
                value = "";
                if ((count % 8) === 4) {
                    if (!affixes[settings[i]]["locale-"+forms[j]].prefix
                        && !affixes[settings[i]]["locale-"+forms[j]].suffix) {
                        value = affixList[count] ? affixList[count] : "";
                        affixes[settings[i]]["locale-" + forms[j]].prefix = value;
                        value = affixList[count] ? affixList[count + 1] : "";
                        affixes[settings[i]]["locale-" + forms[j]].suffix = value;
                    }
                } else {
                    value = affixList[count] ? affixList[count] : "";
                    affixes[settings[i]]["locale-" + forms[j]].prefix = value;
                    value = affixList[count] ? affixList[count + 1] : "";
                    affixes[settings[i]]["locale-" + forms[j]].suffix = value;
                }
                count += 2;
            }
        }
        this.opt.citeAffixes = affixes;
    }
};
CSL.Engine.prototype.setAutoVietnameseNamesOption = function (arg) {
    if (arg) {
        this.opt["auto-vietnamese-names"] = true;
    } else {
        this.opt["auto-vietnamese-names"] = false;
    }
};
CSL.Engine.prototype.setAbbreviations = function (arg) {
    if (this.sys.setAbbreviations) {
        this.sys.setAbbreviations(arg);
    }
};
CSL.Engine.prototype.setSuppressTrailingPunctuation = function (arg) {
    this.citation.opt.suppressTrailingPunctuation = !!arg;
};
module.exports = CSL;
CSL.Output = {};
CSL.Output.Queue = function (state) {
    this.levelname = ["top"];
    this.state = state;
    this.queue = [];
    this.empty = new CSL.Token("empty");
    var tokenstore = {};
    tokenstore.empty = this.empty;
    this.formats = new CSL.Stack(tokenstore);
    this.current = new CSL.Stack(this.queue);
};
CSL.Output.Queue.prototype.pop = function () {
    var drip = this.current.value();
    if (drip.length) {
        return drip.pop();
    } else {
        return drip.blobs.pop();
    }
};
CSL.Output.Queue.prototype.getToken = function (name) {
    var ret = this.formats.value()[name];
    return ret;
};
CSL.Output.Queue.prototype.mergeTokenStrings = function (base, modifier) {
    var base_token, modifier_token, ret, key;
    base_token = this.formats.value()[base];
    modifier_token = this.formats.value()[modifier];
    ret = base_token;
    if (modifier_token) {
        if (!base_token) {
            base_token = new CSL.Token(base, CSL.SINGLETON);
            base_token.decorations = [];
        }
        ret = new CSL.Token(base, CSL.SINGLETON);
        var key = "";
        for (var key in base_token.strings) {
            if (base_token.strings.hasOwnProperty(key)) {
                ret.strings[key] = base_token.strings[key];
            }
        }
        for (var key in modifier_token.strings) {
            if (modifier_token.strings.hasOwnProperty(key)) {
                ret.strings[key] = modifier_token.strings[key];
            }
        }
        ret.decorations = base_token.decorations.concat(modifier_token.decorations);
    }
    return ret;
};
CSL.Output.Queue.prototype.addToken = function (name, modifier, token) {
    var newtok, attr;
    newtok = new CSL.Token("output");
    if ("string" === typeof token) {
        token = this.formats.value()[token];
    }
    if (token && token.strings) {
        for (attr in token.strings) {
            if (token.strings.hasOwnProperty(attr)) {
                newtok.strings[attr] = token.strings[attr];
            }
        }
        newtok.decorations = token.decorations;
    }
    if ("string" === typeof modifier) {
        newtok.strings.delimiter = modifier;
    }
    this.formats.value()[name] = newtok;
};
CSL.Output.Queue.prototype.pushFormats = function (tokenstore) {
    if (!tokenstore) {
        tokenstore = {};
    }
    tokenstore.empty = this.empty;
    this.formats.push(tokenstore);
};
CSL.Output.Queue.prototype.popFormats = function (tokenstore) {
    this.formats.pop();
};
CSL.Output.Queue.prototype.startTag = function (name, token) {
    var tokenstore = {};
    if (this.state.tmp["doing-macro-with-date"] && this.state.tmp.extension) {
        token = this.empty;
        name = "empty";
    }
    tokenstore[name] = token;
    this.pushFormats(tokenstore);
    this.openLevel(name);
};
CSL.Output.Queue.prototype.endTag = function (name) {
    this.closeLevel(name);
    this.popFormats();
};
CSL.Output.Queue.prototype.openLevel = function (token, ephemeral) {
    var blob, curr, x, has_ephemeral;
    if ("object" === typeof token) {
        blob = new CSL.Blob(undefined, token);
    } else if ("undefined" === typeof token) {
        blob = new CSL.Blob(undefined, this.formats.value().empty, "empty");
    } else {
        if (!this.formats.value() || !this.formats.value()[token]) {
            throw "CSL processor error: call to nonexistent format token \"" + token + "\"";
        }
        blob = new CSL.Blob(undefined, this.formats.value()[token], token);
    }
    curr = this.current.value();
    if (!this.state.tmp.just_looking && this.checkNestedBrace) {
        blob.strings.prefix = this.checkNestedBrace.update(blob.strings.prefix);
    }
    curr.push(blob);
    this.current.push(blob);
};
CSL.Output.Queue.prototype.closeLevel = function (name) {
    if (name && name !== this.current.value().levelname) {
        CSL.error("Level mismatch error:  wanted " + name + " but found " + this.current.value().levelname);
    }
    var blob = this.current.pop();
    if (!this.state.tmp.just_looking && this.checkNestedBrace) {
        blob.strings.suffix = this.checkNestedBrace.update(blob.strings.suffix);
    }
};
CSL.Output.Queue.prototype.append = function (str, tokname, notSerious, ignorePredecessor, noStripPeriods) {
    var token, blob, curr;
    var useblob = true;
    if (notSerious) {
        ignorePredecessor = true;
    }
    if (this.state.tmp["doing-macro-with-date"] && !notSerious) {
        if (tokname !== "macro-with-date") {
            return false;
        }
        if (tokname === "macro-with-date") {
            tokname = "empty";
        }
    }
    if ("undefined" === typeof str) {
        return false;
    }
    if ("number" === typeof str) {
        str = "" + str;
    }
    if (!notSerious 
        && this.state.tmp.element_trace 
        && this.state.tmp.element_trace.value() === "suppress-me") {
        return false;
    }
    blob = false;
    if (!tokname) {
        token = this.formats.value().empty;
    } else if (tokname === "literal") {
        token = true;
        useblob = false;
    } else if ("string" === typeof tokname) {
        token = this.formats.value()[tokname];
    } else {
        token = tokname;
    }
    if (!token) {
        throw "CSL processor error: unknown format token name: " + tokname;
    }
    if (token.strings && "undefined" === typeof token.strings.delimiter) {
        token.strings.delimiter = "";
    }
    if ("string" === typeof str && str.length) {
        str = str.replace(/ ([:;?!\u00bb])/g, "\u202f$1").replace(/\u00ab /g, "\u00ab\u202f");
        this.last_char_rendered = str.slice(-1);
        str = str.replace(/\s+'/g, " \'");
        if (!notSerious) {
            str = str.replace(/^'/g, " \'");
        }
        if (!ignorePredecessor) {
            this.state.tmp.term_predecessor = true;
            this.state.tmp.in_cite_predecessor = true;
        } else if (notSerious) {
            this.state.tmp.term_predecessor_name = true;
        }
    }
    blob = new CSL.Blob(str, token);
    curr = this.current.value();
    if ("undefined" === typeof curr && this.current.mystack.length === 0) {
        this.current.mystack.push([]);
        curr = this.current.value();
    }
    if ("string" === typeof blob.blobs) {
        if (!ignorePredecessor) {
            this.state.tmp.term_predecessor = true;
            this.state.tmp.in_cite_predecessor = true;
        } else if (notSerious) {
            this.state.tmp.term_predecessor_name = true;
        }
    }
    if (!notSerious) {
        this.state.parallel.AppendBlobPointer(curr);
    }
    if ("string" === typeof str) {
        if ("string" === typeof blob.blobs) {
            if (blob.blobs.slice(0, 1) !== " ") {
                var blobPrefix = "";
                var blobBlobs = blob.blobs;
                while (CSL.TERMINAL_PUNCTUATION.indexOf(blobBlobs.slice(0, 1)) > -1) {
                    blobPrefix = blobPrefix + blobBlobs.slice(0, 1);
                    blobBlobs = blobBlobs.slice(1);
                }
                if (blobBlobs && blobPrefix) {
                    blob.strings.prefix = blob.strings.prefix + blobPrefix;
                    blob.blobs = blobBlobs;
                }
            }
        }
        if (blob.strings["text-case"]) {
            blob.blobs = CSL.Output.Formatters[blob.strings["text-case"]](this.state, str);
        }
        if (this.state.tmp.strip_periods && !noStripPeriods) {
            blob.blobs = blob.blobs.replace(/\.([^a-z]|$)/g, "$1");
        }
        for (var i = blob.decorations.length - 1; i > -1; i += -1) {
            if (blob.decorations[i][0] === "@quotes" && blob.decorations[i][1] !== "false") {
                blob.punctuation_in_quote = this.state.getOpt("punctuation-in-quote");
            }
            if (!blob.blobs.match(CSL.ROMANESQUE_REGEXP)) {
                if (blob.decorations[i][0] === "@font-style") {
                    blob.decorations = blob.decorations.slice(0, i).concat(blob.decorations.slice(i + 1));
                }
            }
        }
        curr.push(blob);
        this.state.fun.flipflopper.processTags(blob);
    } else if (useblob) {
        curr.push(blob);
    } else {
        curr.push(str);
    }
    return true;
};
CSL.Output.Queue.prototype.string = function (state, myblobs, blob) {
    var i, ilen, j, jlen, b;
    var txt_esc = CSL.getSafeEscape(this.state);
    var blobs = myblobs.slice();
    var ret = [];
    if (blobs.length === 0) {
        return ret;
    }
    var blob_delimiter = "";
    if (blob) {
        blob_delimiter = blob.strings.delimiter;
    } else {
        state.tmp.count_offset_characters = false;
        state.tmp.offset_characters = 0;
    }
    if (blob && blob.new_locale) {
        blob.old_locale = state.opt.lang;
        state.opt.lang = blob.new_locale;
    }
    var blobjr, use_suffix, use_prefix, params;
    for (var i = 0, ilen = blobs.length; i < ilen; i += 1) {
        blobjr = blobs[i];
        if (blobjr.strings.first_blob) {
            state.tmp.count_offset_characters = blobjr.strings.first_blob;
        }
        if ("string" === typeof blobjr.blobs) {
            if ("number" === typeof blobjr.num) {
                ret.push(blobjr);
            } else if (blobjr.blobs) {
                if (blobjr.particle) {
                    blobjr.blobs = blobjr.particle + blobjr.blobs;
                    blobjr.particle = "";
                }
                b = txt_esc(blobjr.blobs);
                var blen = b.length;
                if (!state.tmp.suppress_decorations) {
                    for (j = 0, jlen = blobjr.decorations.length; j < jlen; j += 1) {
                        params = blobjr.decorations[j];
                        if (params[0] === "@showid") {
                            continue;
                        }
                        if (state.normalDecorIsOrphan(blobjr, params)) {
                            continue;
                        }
                        b = state.fun.decorate[params[0]][params[1]].call(blobjr, state, b, params[2]);
                    }
                }
                if (b && b.length) {
                    b = txt_esc(blobjr.strings.prefix) + b + txt_esc(blobjr.strings.suffix);
                    if ((state.opt.development_extensions.csl_reverse_lookup_support || state.sys.csl_reverse_lookup_support) && !state.tmp.suppress_decorations) {
                        for (j = 0, jlen = blobjr.decorations.length; j < jlen; j += 1) {
                            params = blobjr.decorations[j];
                            if (params[0] === "@showid") {
                                b = state.fun.decorate[params[0]][params[1]].call(blobjr, state, b, params[2]);
                            }
                        }
                    }
                    ret.push(b);
                    if (state.tmp.count_offset_characters) {
                        state.tmp.offset_characters += (blen + blobjr.strings.suffix.length + blobjr.strings.prefix.length);
                    }
                }
            }
        } else if (blobjr.blobs.length) {
            var addtoret = state.output.string(state, blobjr.blobs, blobjr);
            if (blob) {
                if ("string" !== addtoret && addtoret.length > 1 && blobjr.strings.delimiter) {
                    var numberSeen = false;
                    for (var j=0,jlen=addtoret.length;j<jlen;j++) {
                        if ("string" !== typeof addtoret[j]) {
                            numberSeen = true;
                        } else if (numberSeen) {
                            addtoret[j] = (blobjr.strings.delimiter + addtoret[j]);
                        }
                    }
                }
            }
            ret = ret.concat(addtoret);
        }
        if (blobjr.strings.first_blob && state.registry.registry[blobjr.strings.first_blob]) {
            state.registry.registry[blobjr.strings.first_blob].offset = state.tmp.offset_characters;
            state.tmp.count_offset_characters = false;
        }
    }
    for (i=0,ilen=ret.length - 1;i<ilen;i+=1) {
        if ("number" === typeof ret[i].num && "number" === typeof ret[i+1].num && !ret[i+1].UGLY_DELIMITER_SUPPRESS_HACK) {
            ret[i].strings.suffix = ret[i].strings.suffix + (blob_delimiter ? blob_delimiter : "");
            ret[i+1].successor_prefix = "";
            ret[i+1].UGLY_DELIMITER_SUPPRESS_HACK = true;
        }
    }
    var span_split = 0;
    for (var i = 0, ilen = ret.length; i < ilen; i += 1) {
        if ("string" === typeof ret[i]) {
            span_split = (parseInt(i, 10) + 1);
            if (i < ret.length - 1  && "object" === typeof ret[i + 1]) {
                if (blob_delimiter && !ret[i + 1].UGLY_DELIMITER_SUPPRESS_HACK) {
                    ret[i] += txt_esc(blob_delimiter);
                }
                ret[i + 1].UGLY_DELIMITER_SUPPRESS_HACK = true;
            }
        }
    }
    if (blob && (blob.decorations.length || blob.strings.suffix)) {
        span_split = ret.length;
    } else if (blob && blob.strings.prefix) {
        for (var i=0,ilen=ret.length;i<ilen;i++) {
            if ("undefined" !== typeof ret[i].num) {
                span_split = i;
                if (i === 0) {
                    ret[i].strings.prefix = blob.strings.prefix + ret[i].strings.prefix;
                }
                break;
            }
        }
    }
    var blobs_start = state.output.renderBlobs(ret.slice(0, span_split), blob_delimiter, false, blob);
    if (blobs_start && blob && (blob.decorations.length || blob.strings.suffix || blob.strings.prefix)) {
        if (!state.tmp.suppress_decorations) {
            for (var i = 0, ilen = blob.decorations.length; i < ilen; i += 1) {
                params = blob.decorations[i];
                if (["@cite","@bibliography", "@display", "@showid"].indexOf(params[0]) > -1) {
                    continue;
                }
                if (state.normalDecorIsOrphan(blobjr, params)) {
                    continue;
                }
                if ("string" === typeof blobs_start) {
                    blobs_start = state.fun.decorate[params[0]][params[1]].call(blob, state, blobs_start, params[2]);
                }
            }
        }
        b = blobs_start;
        use_suffix = blob.strings.suffix;
        if (b && b.length) {
            use_prefix = blob.strings.prefix;
            b = txt_esc(use_prefix) + b + txt_esc(use_suffix);
            if (state.tmp.count_offset_characters) {
                state.tmp.offset_characters += (use_prefix.length + use_suffix.length);
            }
        }
        blobs_start = b;
        if (!state.tmp.suppress_decorations) {
            for (var i = 0, ilen = blob.decorations.length; i < ilen; i += 1) {
                params = blob.decorations[i];
                if (["@cite","@bibliography", "@display", "@showid"].indexOf(params[0]) === -1) {
                    continue;
                }
                if ("string" === typeof blobs_start) {
                    blobs_start = state.fun.decorate[params[0]][params[1]].call(blob, state, blobs_start, params[2]);
                }
            }
        }
    }
    var blobs_end = ret.slice(span_split, ret.length);
    if (!blobs_end.length && blobs_start) {
        ret = [blobs_start];
    } else if (blobs_end.length && !blobs_start) {
        ret = blobs_end;
    } else if (blobs_start && blobs_end.length) {
        ret = [blobs_start].concat(blobs_end);
    }
    if ("undefined" === typeof blob) {
        this.queue = [];
        this.current.mystack = [];
        this.current.mystack.push(this.queue);
        if (state.tmp.suppress_decorations) {
            ret = state.output.renderBlobs(ret, undefined, false);
        }
    } else if ("boolean" === typeof blob) {
        ret = state.output.renderBlobs(ret, undefined, true);
    }
    if (blob && blob.new_locale) {
        state.opt.lang = blob.old_locale;
    }
    return ret;
};
CSL.Output.Queue.prototype.clearlevel = function () {
    var blob, pos, len;
    blob = this.current.value();
    len = blob.blobs.length;
    for (pos = 0; pos < len; pos += 1) {
        blob.blobs.pop();
    }
};
CSL.Output.Queue.prototype.renderBlobs = function (blobs, delim, in_cite, parent) {
    var state, ret, ret_last_char, use_delim, i, blob, pos, len, ppos, llen, pppos, lllen, res, str, params, txt_esc;
    txt_esc = CSL.getSafeEscape(this.state);
    if (!delim) {
        delim = "";
    }
    state = this.state;
    ret = "";
    ret_last_char = [];
    use_delim = "";
    len = blobs.length;
    if (this.state.tmp.area === "citation" && !this.state.tmp.just_looking && len === 1 && typeof blobs[0] === "object" && parent) {
        blobs[0].strings.prefix = parent.strings.prefix + blobs[0].strings.prefix;
        blobs[0].strings.suffix = blobs[0].strings.suffix + parent.strings.suffix;
        blobs[0].decorations = blobs[0].decorations.concat(parent.decorations);
        blobs[0].params = parent.params;
        return blobs[0];
    }
    var start = true;
    for (pos = 0; pos < len; pos += 1) {
        if (blobs[pos].checkNext) {
            blobs[pos].checkNext(blobs[pos + 1],start);
            start = false;
        } else if (blobs[pos+1] && blobs[pos+1].splice_prefix) {
            start = false;
        } else {
            start = true;
        }
    }
    var doit = true;
    for (pos = blobs.length - 1; pos > 0; pos += -1) {
        if (blobs[pos].checkLast) {
            if (doit && blobs[pos].checkLast(blobs[pos - 1])) {
                doit = false;
            }
        } else {
            doit = true;
        }
    }
    len = blobs.length;
    for (pos = 0; pos < len; pos += 1) {
        blob = blobs[pos];
        if (ret) {
            use_delim = delim;
        }
        if ("string" === typeof blob) {
            ret += txt_esc(use_delim);
            ret += blob;
            if (state.tmp.count_offset_characters) {
                state.tmp.offset_characters += (use_delim.length);
            }
        } else if (in_cite) {
            if (ret) {
                ret = [ret, blob];
            } else {
                ret = [blob];
            }
        } else if (blob.status !== CSL.SUPPRESS) {
            if (blob.particle) {
                str = blob.particle + blob.num;
            } else {
                str = blob.formatter.format(blob.num, blob.gender);
            }
            var strlen = str.replace(/<[^>]*>/g, "").length;
            this.append(str, "empty", true);
            var str_blob = this.pop();
            var count_offset_characters = state.tmp.count_offset_characters;
            str = this.string(state, [str_blob], false);
            state.tmp.count_offset_characters = count_offset_characters;
            if (blob.strings["text-case"]) {
                str = CSL.Output.Formatters[blob.strings["text-case"]](this.state, str);
            }
            if (str && this.state.tmp.strip_periods) {
                str = str.replace(/\.([^a-z]|$)/g, "$1");
            }
            if (!state.tmp.suppress_decorations) {
                llen = blob.decorations.length;
                for (ppos = 0; ppos < llen; ppos += 1) {
                    params = blob.decorations[ppos];
                    if (state.normalDecorIsOrphan(blob, params)) {
                        continue;
                    }
                    str = state.fun.decorate[params[0]][params[1]].call(blob, state, str, params[2]);
                }
            }
            str = txt_esc(blob.strings.prefix) + str + txt_esc(blob.strings.suffix);
            var addme = "";
            if (blob.status === CSL.END) {
                addme = txt_esc(blob.range_prefix);
            } else if (blob.status === CSL.SUCCESSOR) {
                addme = txt_esc(blob.successor_prefix);
            } else if (blob.status === CSL.START) {
                if (pos > 0 && !blob.suppress_splice_prefix) {
                    addme = txt_esc(blob.splice_prefix);
                } else {
                    addme = "";
                }
            } else if (blob.status === CSL.SEEN) {
                addme = txt_esc(blob.splice_prefix);
            }
            ret += addme;
            ret += str;
            if (state.tmp.count_offset_characters) {
                state.tmp.offset_characters += (addme.length + blob.strings.prefix.length + strlen + blob.strings.suffix.length);
            }
        }
    }
    return ret;
};
CSL.Output.Queue.purgeEmptyBlobs = function (parent) {
    if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
        return;
    }
    for (var i=parent.blobs.length-1;i>-1;i--) {
        CSL.Output.Queue.purgeEmptyBlobs(parent.blobs[i]);
        var child = parent.blobs[i];
        if (!child || !child.blobs || !child.blobs.length) {
            var buf = [];
            while ((parent.blobs.length-1) > i) {
                buf.push(parent.blobs.pop());
            }
            parent.blobs.pop();
            while (buf.length) {
                parent.blobs.push(buf.pop());
            }
        }
    }
};
CSL.Output.Queue.adjust = function (punctInQuote) {
    var NO_SWAP_IN = {
        ";": true,
        ":": true
    }
    var NO_SWAP_OUT = {
        ".": true,
        "!": true,
        "?": true
    }
    this.upward = upward;
    this.leftward = leftward;
    this.downward = downward;
    this.fix = fix;
    var LtoR_MAP = {
        "!": {
            ".": "!",
            "?": "!?",
            ":": "!",
            ",": "!,",
            ";": "!;"
        },
        "?": {
            "!": "?!",
            ".": "?",
            ":": "?",
            ",": "?,",
            ";": "?;"
        },
        ".": {
            "!": ".!",
            "?": ".?",
            ":": ".:",
            ",": ".,",
            ";": ".;"
        },
        ":": {
            "!": "!",
            "?": "?",
            ".": ":",
            ",": ":,",
            ";": ":;"
        },
        ",": {
            "!": ",!",
            "?": ",?",
            ":": ",:",
            ".": ",.",
            ";": ",;"
        },
        ";": {
            "!": "!",
            "?": "?",
            ":": ";",
            ",": ";,",
            ".": ";"
        }
    }
    var SWAP_IN = {};
    var SWAP_OUT = {};
    var PUNCT = {};
    var PUNCT_OR_SPACE = {};
    for (var key in LtoR_MAP) {
        PUNCT[key] = true;
        PUNCT_OR_SPACE[key] = true;
        if (!NO_SWAP_IN[key]) {
            SWAP_IN[key] = true;
        }
        if (!NO_SWAP_OUT[key]) {
            SWAP_OUT[key] = true;
        }
    }
    PUNCT_OR_SPACE[" "] = true;
    PUNCT_OR_SPACE[" "] = true;
    var RtoL_MAP = {};
    for (var key in LtoR_MAP) {
        for (var subkey in LtoR_MAP[key]) {
            if (!RtoL_MAP[subkey]) {
                RtoL_MAP[subkey] = {};
            }
            RtoL_MAP[subkey][key] = LtoR_MAP[key][subkey];
        }
    }
    function blobIsNumber(blob) {
        return ("number" === typeof blob.num || (blob.blobs && blob.blobs.length === 1 && "number" === typeof blob.blobs[0].num));
    };
    function blobEndsInNumber(blob) {
        if ("number" === typeof blob.num) {
            return true;
        }
        if (!blob.blobs || "object" !==  typeof blob.blobs) return false;
        if (blobEndsInNumber(blob.blobs[blob.blobs.length-1])) return true;
    }
    function blobHasDecorations(blob,includeQuotes) {
        var ret = false;
        var decorlist = ['@font-style','@font-variant','@font-weight','@text-decoration','@vertical-align'];
        if (includeQuotes) {
            decorlist.push('@quotes');
        }
        if (blob.decorations) {
            for (var i=0,ilen=blob.decorations.length;i<ilen;i++) {
                if (decorlist.indexOf(blob.decorations[i][0]) > -1) {
                    ret = true;
                    break;
                }
            }
        }
        return ret;
    };
    function blobHasDescendantQuotes(blob) {
        if (blob.decorations) {
            for (var i=0,ilen=blob.decorations.length;i<ilen;i++) {
                if (blob.decorations[i][0] === '@quotes' && blob.decorations[i][1] !== "false") {
                    return true;
                }
            }
        }
        if ("object" !== typeof blob.blobs) {
            return false
        };
        return blobHasDescendantQuotes(blob.blobs[blob.blobs.length-1]);
    }
    function blobHasDescendantMergingPunctuation(parentChar,blob) {
        var childChar = blob.strings.suffix.slice(-1);
        if (!childChar && "string" === typeof blob.blobs) {
            childChar = blob.blobs.slice(-1);
        }
        var mergedChars = RtoL_MAP[parentChar][childChar];
        if (mergedChars && mergedChars.length === 1) {
            return true;
        }
        if ("object" !== typeof blob.blobs) return false;
        if (blobHasDescendantMergingPunctuation(parentChar,blob.blobs[blob.blobs.length-1])) return true;
        return false;
    }
    function matchLastChar(blob, chr) {
        if (!PUNCT[chr]) {
            return false;
        }
        if ("string" === typeof blob.blobs) {
            if (blob.blobs.slice(-1) === chr) {
                return true;
            } else {
                return false;
            }
        } else {
            var child = blob.blobs[blob.blobs.length-1];
            if (child) {
                var childChar = child.strings.suffix.slice(-1);
                if (!childChar) {
                    return matchLastChar(child,chr);
                } else if (child.strings.suffix.slice(-1) == chr) {
                    return true;
                } else {
                    return false;
                }
            } else {
                return false;
            }
        }
    };
    function mergeChars (First, first, Second, second, merge_right) {
        var FirstStrings = "blobs" === first ? First : First.strings;
        var SecondStrings = "blobs" === second ? Second: Second.strings;
        var firstChar = FirstStrings[first].slice(-1);
        var secondChar = SecondStrings[second].slice(0,1);
        function cullRight () {
            SecondStrings[second] = SecondStrings[second].slice(1);
        };
        function cullLeft () {
            FirstStrings[first] = FirstStrings[first].slice(0,-1);
        };
        function addRight (chr) {
            SecondStrings[second] = chr + SecondStrings[second];
        }
        function addLeft (chr) {
            FirstStrings[first] += chr;
        }
        var cull = merge_right ? cullLeft : cullRight;
        function matchOnRight () {
            return RtoL_MAP[secondChar];
        }
        function matchOnLeft () {
            return LtoR_MAP[firstChar];
        }
        var match = merge_right ? matchOnLeft : matchOnRight;
        function mergeToRight () {
            var chr = LtoR_MAP[firstChar][secondChar];
            if ("string" === typeof chr) {
                cullLeft();
                cullRight();
                addRight(chr);
            } else {
                addRight(firstChar);
                cullLeft();
            }
        }
        function mergeToLeft () {
            var chr = RtoL_MAP[secondChar][firstChar];
            if ("string" === typeof chr) {
                cullLeft();
                cullRight();
                addLeft(chr);
            } else {
                addLeft(secondChar);
                cullRight();
            }
        }
        var merge = merge_right ? mergeToRight: mergeToLeft;
        var isDuplicate = firstChar === secondChar;
        if (isDuplicate) {
            cull();
        } else {
            if (match()) {
                merge();
            }
        }
    };
    function upward (parent) {
        if (parent.blobs && "string" == typeof parent.blobs) {
            if (PUNCT[parent.strings.suffix.slice(0,1)]
                && parent.strings.suffix.slice(0,1) === parent.blobs.slice(-1)) {
                parent.strings.suffix = parent.strings.suffix.slice(1);
            }
            return;
        } else if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
            return;
        }
        var parentDecorations = blobHasDecorations(parent,true);
        for (var i=parent.blobs.length-1;i>-1;i--) {
            var endFlag = i === (parent.blobs.length-1);
            this.upward(parent.blobs[i]);
            var parentStrings = parent.strings;
            var childStrings = parent.blobs[i].strings;
            if (i === 0) {
                if (" " === parentStrings.prefix.slice(-1) && " " === childStrings.prefix.slice(0, 1)) {
                    childStrings.prefix = childStrings.prefix.slice(1);
                }
                var childChar = childStrings.prefix.slice(0, 1);
                if (!parentDecorations && PUNCT_OR_SPACE[childChar] && !parentStrings.prefix) {
                    parentStrings.prefix += childChar;
                    childStrings.prefix = childStrings.prefix.slice(1);
                }
            }
            if (i === (parent.blobs.length - 1)) {
                var childChar = childStrings.suffix.slice(-1);
                if (!parentDecorations && [" "].indexOf(childChar) > -1) {
                    if (parentStrings.suffix.slice(0,1) !== childChar) {
                        parentStrings.suffix = childChar + parentStrings.suffix;
                    }
                    childStrings.suffix = childStrings.suffix.slice(0, -1);
                }
            }
            if (parentStrings.delimiter && i > 0) {
                if (PUNCT_OR_SPACE[parentStrings.delimiter.slice(-1)]
                    && parentStrings.delimiter.slice(-1) === childStrings.prefix.slice(0, 1)) {
                    childStrings.prefix = childStrings.prefix.slice(1);
                }
            }
        }
    };
    function leftward (parent) {
        if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
            return;
        }
        for (var i=parent.blobs.length-1;i>-1;i--) {
            this.leftward(parent.blobs[i]);
            if ((i < parent.blobs.length -1) && !parent.strings.delimiter) {
                var child = parent.blobs[i];
                var childChar = child.strings.suffix.slice(-1);
                var sibling = parent.blobs[i+1];
                var siblingChar = sibling.strings.prefix.slice(0, 1);
                var hasDecorations = blobHasDecorations(child) || blobHasDecorations(sibling);
                var hasNumber = "number" === typeof childChar || "number" === typeof siblingChar;
                if (!hasDecorations && !hasNumber && PUNCT[siblingChar] && !hasNumber) {
                    var suffixAndPrefixMatch = siblingChar === child.strings.suffix.slice(-1);
                    var suffixAndFieldMatch = (!child.strings.suffix && "string" === typeof child.blobs && child.blobs.slice(-1) === siblingChar);
                    if (!suffixAndPrefixMatch && !suffixAndFieldMatch) {
                        mergeChars(child, 'suffix', sibling, 'prefix');
                    } else {
                        sibling.strings.prefix = sibling.strings.prefix.slice(1);
                    }
                }
            }
        }
    };
    function downward (parent, top) {
        if (parent.blobs && "string" == typeof parent.blobs) {
            if (PUNCT[parent.strings.suffix.slice(0,1)]
                && parent.strings.suffix.slice(0,1) === parent.blobs.slice(-1)) {
                parent.strings.suffix = parent.strings.suffix.slice(1);
            }
            return;
        } else if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
            return;
        }
        var parentStrings = parent.strings;
        var someChildrenAreNumbers = false;
        for (var i=0,ilen=parent.blobs.length;i<ilen;i++) {
            if (blobIsNumber(parent.blobs[i])) {
                someChildrenAreNumbers = true;
                break;
            }
        }
        if (true) {
            if (parentStrings.delimiter && PUNCT[parentStrings.delimiter.slice(0, 1)]) {
                var delimChar = parentStrings.delimiter.slice(0, 1);
                for (var i=parent.blobs.length-2;i>-1;i--) {
                    var childStrings = parent.blobs[i].strings;
                    if (childStrings.suffix.slice(-1) !== delimChar) {
                        childStrings.suffix += delimChar;
                    }
                }
                parentStrings.delimiter = parentStrings.delimiter.slice(1);
            }
        }
        var parentDecorations = blobHasDecorations(parent, true);
        var parentIsNumber = blobIsNumber(parent);
        for (var i=parent.blobs.length-1;i>-1;i--) {
            var child = parent.blobs[i];
            var childStrings = parent.blobs[i].strings;
            var childDecorations = blobHasDecorations(child, true);
            var childIsNumber = blobIsNumber(child);
            if (i === (parent.blobs.length - 1)) {
                if (true) {
                    var parentChar = parentStrings.suffix.slice(0, 1);
                    var allowMigration = false;
                    if (PUNCT[parentChar]) {
                        allowMigration = blobHasDescendantMergingPunctuation(parentChar,child);
                        if (!allowMigration && punctInQuote) {
                            allowMigration = blobHasDescendantQuotes(child);
                        }
                    }
                    if (allowMigration) {
                        if (PUNCT[parentChar]) {
                            if (!blobEndsInNumber(child)) {
                                if ("string" === typeof child.blobs) {
                                    mergeChars(child, 'blobs', parent, 'suffix');
                                } else {
                                    mergeChars(child, 'suffix', parent, 'suffix');
                                }
                                if (parentStrings.suffix.slice(0,1) === ".") {
                                    childStrings.suffix += parentStrings.suffix.slice(0,1);
                                    parentStrings.suffix = parentStrings.suffix.slice(1);
                                }
                            }
                        }
                    }
                    if (childStrings.suffix.slice(-1) === " " && parentStrings.suffix.slice(0,1) === " ") {
                        parentStrings.suffix = parentStrings.suffix.slice(1);
                    }
                    if (PUNCT_OR_SPACE[childStrings.suffix.slice(0,1)]) {
                        if ("string" === typeof child.blobs && child.blobs.slice(-1) === childStrings.suffix.slice(0,1)) {
                            childStrings.suffix = childStrings.suffix.slice(1);
                        }
                        if (childStrings.suffix.slice(-1) === parentStrings.suffix.slice(0, 1)) {
                            parentStrings.suffix = parentStrings.suffix.slice(0, -1);
                        }
                    }
                }
                if (matchLastChar(parent,parent.strings.suffix.slice(0,1))) {
                    parent.strings.suffix = parent.strings.suffix.slice(1);
                }
            } else if (parentStrings.delimiter) {
                if (PUNCT_OR_SPACE[parentStrings.delimiter.slice(0,1)]
                    && parentStrings.delimiter.slice(0, 1) === childStrings.suffix.slice(-1)) {
                    parent.blobs[i].strings.suffix = parent.blobs[i].strings.suffix.slice(0, -1);
                }
            } else {
                var siblingStrings = parent.blobs[i+1].strings;
                if (!blobIsNumber(child) 
                    && !childDecorations
                    && PUNCT_OR_SPACE[childStrings.suffix.slice(-1)]
                    && childStrings.suffix.slice(-1) === siblingStrings.prefix.slice(0, 1)) {
                    siblingStrings.prefix = siblingStrings.prefix.slice(1);
                }
            }
            if (!childIsNumber && !childDecorations && PUNCT[childStrings.suffix.slice(0,1)]
                && "string" === typeof child.blobs) {
                mergeChars(child, 'blobs', child, 'suffix')
            }
            this.downward(parent.blobs[i]);
        }
    };
    function swapToTheLeft (child) {
        var childChar = child.strings.suffix.slice(0,1);
        if ("string" === typeof child.blobs) {
            while (SWAP_IN[childChar]) {
                mergeChars(child, 'blobs', child, 'suffix');
                childChar = child.strings.suffix.slice(0,1);
            }                                
        } else {
            while (SWAP_IN[childChar]) {
                mergeChars(child.blobs[child.blobs.length-1], 'suffix', child, 'suffix');
                childChar = child.strings.suffix.slice(0,1);
            }
        }
    }
    function swapToTheRight (child) {
        if ("string" === typeof child.blobs) {
            var childChar = child.blobs.slice(-1);
            while (SWAP_OUT[childChar]) {
                mergeChars(child, 'blobs', child, 'suffix', true);
                childChar = child.blobs.slice(-1);
            }
        } else {
            var childChar = child.blobs[child.blobs.length-1].strings.suffix.slice(-1);
            while (SWAP_OUT[childChar]) {
                mergeChars(child.blobs[child.blobs.length-1], 'suffix', child, 'suffix', true);
                childChar = child.blobs[child.blobs.length-1].strings.suffix.slice(-1);
            }
        }
    }
    function fix (parent) {
        if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
            return;
        }
        var lastChar;
        for (var i=0,ilen=parent.blobs.length;i<ilen;i++) {
            var child = parent.blobs[i];
            var quoteSwap = false;
            for (var j=0,jlen=child.decorations.length;j<jlen;j++) {
                var decoration = child.decorations[j];
                if (decoration[0] === "@quotes" && decoration[1] !== "false") {
                    quoteSwap = true;
                }
            }
            if (quoteSwap) {
                if (punctInQuote) {
                    swapToTheLeft(child);
                } else {
                    swapToTheRight(child);
                }
            }
            lastChar = this.fix(parent.blobs[i]);
            if (child.blobs && "string" === typeof child.blobs) {
                lastChar = child.blobs.slice(-1);
            }
        }
        return lastChar;
    };
}
module.exports = CSL;
CSL.Engine.Opt = function () {
    this.has_disambiguate = false;
    this.mode = "html";
    this.dates = {};
    this.jurisdictions_seen = {};
    this.suppressedJurisdictions = {};
    this.inheritedAttributes = {};
    this["locale-sort"] = [];
    this["locale-translit"] = [];
    this["locale-translat"] = [];
    this.citeAffixes = {
        persons:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        institutions:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        titles:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        journals:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        publishers:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        places:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        }
    };
    this["default-locale"] = [];
    this.update_mode = CSL.NONE;
    this.bib_mode = CSL.NONE;
    this.sort_citations = false;
    this["et-al-min"] = 0;
    this["et-al-use-first"] = 1;
    this["et-al-use-last"] = false;
    this["et-al-subsequent-min"] = false;
    this["et-al-subsequent-use-first"] = false;
    this["demote-non-dropping-particle"] = "display-and-sort";
    this["parse-names"] = true;
    this.citation_number_slug = false;
    this.trigraph = "Aaaa00:AaAa00:AaAA00:AAAA00";
    this.nodenames = [];
    this.gender = {};
    this['cite-lang-prefs'] = {
        persons:['orig'],
        institutions:['orig'],
        titles:['orig'],
        journals:['orig'],
        publishers:['orig'],
        places:['orig'],
        number:['orig']
    };
    this.has_layout_locale = false;
    this.development_extensions = {};
    this.development_extensions.field_hack = true;
    this.development_extensions.allow_field_hack_date_override = true;
    this.development_extensions.locator_date_and_revision = true;
    this.development_extensions.locator_parsing_for_plurals = true;
    this.development_extensions.locator_label_parse = true;
    this.development_extensions.raw_date_parsing = true;
    this.development_extensions.clean_up_csl_flaws = true;
    this.development_extensions.flip_parentheses_to_braces = true;
    this.development_extensions.jurisdiction_subfield = true;
    this.development_extensions.static_statute_locator = false;
    this.development_extensions.csl_reverse_lookup_support = false;
    this.development_extensions.clobber_locator_if_no_statute_section = false;
    this.development_extensions.wrap_url_and_doi = false;
    this.development_extensions.allow_force_lowercase = false;
    this.development_extensions.handle_parallel_articles = false;
    this.development_extensions.thin_non_breaking_space_html_hack = false;
    this.development_extensions.apply_citation_wrapper = false;
    this.development_extensions.main_title_from_short_title = false;
    this.development_extensions.uppercase_subtitles = false;
    this.development_extensions.normalize_lang_keys_to_lowercase = false;
    this.development_extensions.strict_text_case_locales = false;
    this.development_extensions.rtl_support = false;
    this.development_extensions.expect_and_symbol_form = false;
    this.development_extensions.require_explicit_legal_case_title_short = false;
    this.development_extensions.spoof_institutional_affiliations = false;
    this.development_extensions.force_jurisdiction = false;
    this.development_extensions.parse_names = true;
};
CSL.Engine.Tmp = function () {
    this.names_max = new CSL.Stack();
    this.names_base = new CSL.Stack();
    this.givens_base = new CSL.Stack();
    this.value = [];
    this.namepart_decorations = {};
    this.namepart_type = false;
    this.area = "citation";
    this.root = "citation";
    this.extension = "";
    this.can_substitute = new CSL.Stack(0, CSL.LITERAL);
    this.element_rendered_ok = false;
    this.element_trace = new CSL.Stack("style");
    this.nameset_counter = 0;
    this.group_context = new CSL.Stack({
        term_intended: false,
        variable_attempt: false,
        variable_success: false,
        output_tip: undefined,
        label_form:  undefined,
        parallel_conditions: undefined,
        condition: false,
        force_suppress: false,
        done_vars: []
    });
    this.term_predecessor = false;
    this.in_cite_predecessor = false;
    this.jump = new CSL.Stack(0, CSL.LITERAL);
    this.decorations = new CSL.Stack();
    this.tokenstore_stack = new CSL.Stack();
    this.last_suffix_used = "";
    this.last_names_used = [];
    this.last_years_used = [];
    this.years_used = [];
    this.names_used = [];
    this.taintedItemIDs = {};
    this.taintedCitationIDs = {};
    this.initialize_with = new CSL.Stack();
    this.disambig_request = false;
    this["name-as-sort-order"] = false;
    this.suppress_decorations = false;
    this.disambig_settings = new CSL.AmbigConfig();
    this.bib_sort_keys = [];
    this.prefix = new CSL.Stack("", CSL.LITERAL);
    this.suffix = new CSL.Stack("", CSL.LITERAL);
    this.delimiter = new CSL.Stack("", CSL.LITERAL);
    this.cite_locales = [];
    this.cite_affixes = {
        citation: false, 
        bibliography: false,
        citation_sort: false, 
        bibliography_sort: false
    };
    this.strip_periods = 0;
    this.shadow_numbers = {};
    this.authority_stop_last = 0;
    this.loadedItemIDs = {};
};
CSL.Engine.Fun = function (state) {
    this.match = new CSL.Util.Match;
    this.suffixator = new CSL.Util.Suffixator(CSL.SUFFIX_CHARS);
    this.romanizer = new CSL.Util.Romanizer();
    this.ordinalizer = new CSL.Util.Ordinalizer(state);
    this.long_ordinalizer = new CSL.Util.LongOrdinalizer();
};
CSL.Engine.Build = function () {
    this["alternate-term"] = false;
    this.in_bibliography = false;
    this.in_style = false;
    this.skip = false;
    this.postponed_macro = false;
    this.layout_flag = false;
    this.name = false;
    this.form = false;
    this.term = false;
    this.macro = {};
    this.macro_stack = [];
    this.text = false;
    this.lang = false;
    this.area = "citation";
    this.root = "citation";
    this.extension = "";
    this.substitute_level = new CSL.Stack(0, CSL.LITERAL);
    this.names_level = 0;
    this.render_nesting_level = 0;
    this.render_seen = false;
};
CSL.Engine.Configure = function () {
    this.fail = [];
    this.succeed = [];
};
CSL.Engine.Citation = function (state) {
    this.opt = {
        inheritedAttributes: {}
    };
    this.tokens = [];
    this.srt = new CSL.Registry.Comparifier(state, "citation_sort");
    this.opt.collapse = [];
    this.opt["disambiguate-add-names"] = false;
    this.opt["disambiguate-add-givenname"] = false;
    this.opt["disambiguate-add-year-suffix"] = false;
    this.opt["givenname-disambiguation-rule"] = "by-cite";
    this.opt["near-note-distance"] = 5;
    this.opt.topdecor = [];
    this.opt.layout_decorations = [];
    this.opt.layout_prefix = "";
    this.opt.layout_suffix = "";
    this.opt.layout_delimiter = "";
    this.opt.sort_locales = [];
    this.opt.max_number_of_names = 0;
    this.root = "citation";
};
CSL.Engine.Bibliography = function () {
    this.opt = {
        inheritedAttributes: {}
    };
    this.tokens = [];
    this.opt.collapse = [];
    this.opt.topdecor = [];
    this.opt.layout_decorations = [];
    this.opt.layout_prefix = "";
    this.opt.layout_suffix = "";
    this.opt.layout_delimiter = "";
    this.opt["line-spacing"] = 1;
    this.opt["entry-spacing"] = 1;
    this.opt.sort_locales = [];
    this.opt.max_number_of_names = 0;
    this.root = "bibliography";
};
CSL.Engine.BibliographySort = function () {
    this.tokens = [];
    this.opt = {};
    this.opt.sort_directions = [];
    this.keys = [];
    this.opt.topdecor = [];
    this.root = "bibliography";
};
CSL.Engine.CitationSort = function () {
    this.tokens = [];
    this.opt = {};
    this.opt.sort_directions = [];
    this.keys = [];
    this.opt.topdecor = [];
    this.root = "citation";
};
module.exports = CSL;
CSL.Engine.prototype.previewCitationCluster = function (citation, citationsPre, citationsPost, newMode) {
    var oldMode = this.opt.mode;
    this.setOutputFormat(newMode);
    var ret = this.processCitationCluster(citation, citationsPre, citationsPost, CSL.PREVIEW);
    this.setOutputFormat(oldMode);
    return ret[1];
};
CSL.Engine.prototype.appendCitationCluster = function (citation) {
    var citationsPre = [];
    var len = this.registry.citationreg.citationByIndex.length;
    for (var pos = 0; pos < len; pos += 1) {
        var c = this.registry.citationreg.citationByIndex[pos];
        citationsPre.push(["" + c.citationID, c.properties.noteIndex]);
    }
    return this.processCitationCluster(citation, citationsPre, [])[1];
};
CSL.Engine.prototype.processCitationCluster = function (citation, citationsPre, citationsPost, flag) {
    var c, i, ilen, j, jlen, k, klen, n, nlen, key, Item, item, noteCitations, textCitations, m, citationsInNote;
    this.debug = false;
    this.tmp.loadedItemIDs = {};
    this.tmp.citation_errors = [];
    var return_data = {"bibchange": false};
    this.setCitationId(citation);
    var oldCitationList;
    var oldItemList;
    var oldAmbigs;
    if (flag === CSL.PREVIEW) {
        oldCitationList = this.registry.citationreg.citationByIndex.slice();
        oldItemList = this.registry.reflist.slice();
        var newCitationList = citationsPre.concat([["" + citation.citationID, citation.properties.noteIndex]]).concat(citationsPost);
        var newItemIds = {};
        var newItemIdsList = [];
        for (var i = 0, ilen = newCitationList.length; i < ilen; i += 1) {
            c = this.registry.citationreg.citationById[newCitationList[i][0]];
            for (j = 0, jlen = c.citationItems.length; j < jlen; j += 1) {
                newItemIds[c.citationItems[j].id] = true;
                newItemIdsList.push("" + c.citationItems[j].id);
            }
        }
        oldAmbigs = {};
        for (var i = 0, ilen = oldItemList.length; i < ilen; i += 1) {
            if (!newItemIds[oldItemList[i].id]) {
                var oldAkey = this.registry.registry[oldItemList[i].id].ambig;
                var ids = this.registry.ambigcites[oldAkey];
                if (ids) {
                    for (j = 0, jlen = ids.length; j < jlen; j += 1) {
                        oldAmbigs[ids[j]] = CSL.cloneAmbigConfig(this.registry.registry[ids[j]].disambig);
                    }
                }
            }
        }
    }
    this.tmp.taintedCitationIDs = {};
    var sortedItems = [];
    var rerunAkeys = {};
    for (var i = 0, ilen = citation.citationItems.length; i < ilen; i += 1) {
        item = {};
        for (var key in citation.citationItems[i]) {
            item[key] = citation.citationItems[i][key];
        }
        Item = this.retrieveItem("" + item.id);
        if (Item.id) {
            this.transform.loadAbbreviation("default", "hereinafter", Item.id);
        }
        item = CSL.parseLocator.call(this, item);
        if (this.opt.development_extensions.static_statute_locator) {
            this.remapSectionVariable([[Item,item]]);
        }
        if (this.opt.development_extensions.locator_label_parse) {
            if (item.locator && ["bill","gazette","legislation","regulation","treaty"].indexOf(Item.type) === -1 && (!item.label || item.label === 'page')) {
                var m = CSL.LOCATOR_LABELS_REGEXP.exec(item.locator);
                if (m) {
                    var tryLabel = CSL.LOCATOR_LABELS_MAP[m[2]];
                    if (this.getTerm(tryLabel)) {
                        item.label = tryLabel;
                        item.locator = m[3];
                    }
                }
            }
        }
        var newitem = [Item, item];
        sortedItems.push(newitem);
        citation.citationItems[i].item = Item;
    }
    citation.sortedItems = sortedItems;
    var citationByIndex = [];
    for (var i = 0, ilen = citationsPre.length; i < ilen; i += 1) {
        c = citationsPre[i];
        try {
            this.registry.citationreg.citationById[c[0]].properties.noteIndex = c[1];
        } catch (e) {
            var err = "CSL error\n";
            err += "  " + e + "\n";
            err += "  citationID=" + c[0] + "\n";
            err += "  noteIndex=" + c[1] + "\n";
            err += "  atarray citationsPre index " + i + ", from citation at document position " + citationsPre.length;
            throw err;
        }
        citationByIndex.push(this.registry.citationreg.citationById[c[0]]);
    }
    citationByIndex.push(citation);
    for (var i = 0, ilen = citationsPost.length; i < ilen; i += 1) {
        c = citationsPost[i];
        try {
            this.registry.citationreg.citationById[c[0]].properties.noteIndex = c[1];
        } catch (e) {
            var err = "CSL error\n";
            err += "  " + e + "\n";
            err += "  citationID=" + c[0] + "\n";
            err += "  noteIndex=" + c[1] + "\n";
            err += "  at array citationsPost index " + i + ", from citation at document position " + citationsPre.length;
            throw err;
        }
        citationByIndex.push(this.registry.citationreg.citationById[c[0]]);
    }
    this.registry.citationreg.citationByIndex = citationByIndex;
    this.registry.citationreg.citationsByItemId = {};
    if (this.opt.update_mode === CSL.POSITION) {
        textCitations = [];
        noteCitations = [];
        citationsInNote = {};
    }
    var update_items = [];
    for (var i = 0, ilen = citationByIndex.length; i < ilen; i += 1) {
        if (!citationByIndex[i].properties) {
            citationByIndex[i].properties = {};
        }
        citationByIndex[i].properties.index = i;
        for (j = 0, jlen = citationByIndex[i].sortedItems.length; j < jlen; j += 1) {
            item = citationByIndex[i].sortedItems[j];
            if (!this.registry.citationreg.citationsByItemId[item[1].id]) {
                this.registry.citationreg.citationsByItemId[item[1].id] = [];
                update_items.push("" + item[1].id);
            }
            if (this.registry.citationreg.citationsByItemId[item[1].id].indexOf(citationByIndex[i]) === -1) {
                this.registry.citationreg.citationsByItemId[item[1].id].push(citationByIndex[i]);
            }
        }
        if (this.opt.update_mode === CSL.POSITION) {
            if (citationByIndex[i].properties.noteIndex) {
                noteCitations.push(citationByIndex[i]);
            } else {
                citationByIndex[i].properties.noteIndex = 0;
                textCitations.push(citationByIndex[i]);
            }
        }
    }
    if (flag !== CSL.ASSUME_ALL_ITEMS_REGISTERED) {
        this.updateItems(update_items, null, null, true);
    }
    if (!this.opt.citation_number_sort && sortedItems && sortedItems.length > 1 && this.citation_sort.tokens.length > 0) {
        for (var i = 0, ilen = sortedItems.length; i < ilen; i += 1) {
            sortedItems[i][1].sortkeys = CSL.getSortKeys.call(this, sortedItems[i][0], "citation_sort");
        }
        if (this.opt.grouped_sort &&  !citation.properties.unsorted) {
            for (var i = 0, ilen = sortedItems.length; i < ilen; i += 1) {
                var sortkeys = sortedItems[i][1].sortkeys;
                this.tmp.authorstring_request = true;
                var mydisambig = this.registry.registry[sortedItems[i][0].id].disambig;
                this.tmp.authorstring_request = true;
                CSL.getAmbiguousCite.call(this, sortedItems[i][0], mydisambig);
                var authorstring = this.registry.authorstrings[sortedItems[i][0].id];
                this.tmp.authorstring_request = false;
                sortedItems[i][1].sortkeys = [authorstring].concat(sortkeys);
            }
            sortedItems.sort(this.citation.srt.compareCompositeKeys);
            var lastauthor = false;
            var thiskey = false;
            var thisauthor = false;
            for (var i = 0, ilen = sortedItems.length; i < ilen; i += 1) {
                if (sortedItems[i][1].sortkeys[0] !== lastauthor) {
                    thisauthor = sortedItems[i][1].sortkeys[0];
                    thiskey =  sortedItems[i][1].sortkeys[1];
                }
                sortedItems[i][1].sortkeys[0] = "" + thiskey + i;
                lastauthor = thisauthor;
            }
        }
        if (!citation.properties.unsorted) {
            sortedItems.sort(this.citation.srt.compareCompositeKeys);
        }
    }
    var citations;
    if (this.opt.update_mode === CSL.POSITION) {
        for (var i = 0; i < 2; i += 1) {
            citations = [textCitations, noteCitations][i];
            var first_ref = {};
            var last_ref = {};
            for (j = 0, jlen = citations.length; j < jlen; j += 1) {
                var onecitation = citations[j];
                if (!citations[j].properties.noteIndex) {
                    citations[j].properties.noteIndex = 0;
                }
                citations[j].properties.noteIndex = parseInt(citations[j].properties.noteIndex, 10);
                if (j > 0 && citations[j - 1].properties.noteIndex > citations[j].properties.noteIndex) {
                    citationsInNote = {};
                    first_ref = {};
                    last_ref = {};
                }
                for (k = 0, klen = onecitation.sortedItems.length; k < klen; k += 1) {
                    if (!this.registry.registry[onecitation.sortedItems[k][1].id].parallel) {
                        if (!citationsInNote[onecitation.properties.noteIndex]) {
                            citationsInNote[onecitation.properties.noteIndex] = 1;
                        } else {
                            citationsInNote[onecitation.properties.noteIndex] += 1;
                        }
                    }
                }
                for (k = 0, klen = citations[j].sortedItems.length; k < klen; k += 1) {
                    item = citations[j].sortedItems[k];
                    var myid = item[0].id;
                    var mylocator = item[1].locator;
                    var mylabel = item[1].label;
                    if (item[0].legislation_id) {
                        myid = item[0].legislation_id;
                    }
                    var incitationid;
                    if (k > 0) {
                        if (onecitation.sortedItems[k - 1][0].legislation_id) {
                            incitationid = onecitation.sortedItems[k - 1][0].legislation_id;
                        } else {
                            incitationid = onecitation.sortedItems[k - 1][1].id;
                        }
                    }
                    if (flag === CSL.PREVIEW) {
                        if (onecitation.citationID != citation.citationID) {
                            if ("undefined" === typeof first_ref[item[1].id]) {
                                first_ref[myid] = onecitation.properties.noteIndex;
                                last_ref[myid] = onecitation.properties.noteIndex;
                            } else {
                                last_ref[myid] = onecitation.properties.noteIndex;
                            }
                            continue;
                        }
                    }
                    var oldvalue = {};
                    oldvalue.position = item[1].position;
                    oldvalue["first-reference-note-number"] = item[1]["first-reference-note-number"];
                    oldvalue["near-note"] = item[1]["near-note"];
                    item[1]["first-reference-note-number"] = 0;
                    item[1]["near-note"] = false;
                    if (this.registry.citationreg.citationsByItemId[myid]) {
                        if (this.opt.xclass === 'note' && this.opt.has_disambiguate) {
                            var oldCount = this.registry.registry[myid]["citation-count"]
                            var newCount = this.registry.citationreg.citationsByItemId[myid].length;
                            this.registry.registry[myid]["citation-count"] = this.registry.citationreg.citationsByItemId[myid].length;
                            if ("number" === typeof oldCount) {
                                var oldCountCheck = (oldCount < 2);
                                var newCountCheck = (newCount < 2);
                                if (oldCountCheck !== newCountCheck) {
                                    for (var l=0,llen=this.registry.citationreg.citationsByItemId[myid].length;l<llen;l++) {
                                        rerunAkeys[this.registry.registry[myid].ambig] = true;
                                        this.tmp.taintedCitationIDs[this.registry.citationreg.citationsByItemId[myid][l].citationID] = true;
                                    }
                                }
                            } else {
                                for (var l=0,llen=this.registry.citationreg.citationsByItemId[myid].length;l<llen;l++) {
                                    rerunAkeys[this.registry.registry[myid].ambig] = true;
                                    this.tmp.taintedCitationIDs[this.registry.citationreg.citationsByItemId[myid][l].citationID] = true;
                                }
                            }
                        }
                    }
                    var oldlastid;
                    if ("undefined" === typeof first_ref[myid]) {
                        first_ref[myid] = onecitation.properties.noteIndex;
                        if (this.registry.registry[myid]) {
                            this.registry.registry[myid]['first-reference-note-number'] = onecitation.properties.noteIndex;
                        }
                        last_ref[myid] = onecitation.properties.noteIndex;
                        item[1].position = CSL.POSITION_FIRST;
                    } else {
                        var ibidme = false;
                        var suprame = false;
                        if (j > 0) {
                            try {
                                oldlastid =  citations[j - 1].sortedItems.slice(-1)[0][1].id;
                            } catch (e) {
                                var err = "CSL Error\n";
                                err += "  " + e;
                                err += "  in citation object " + citations[j - 1].citationID + " at index " + (j - 1);
                                throw err;
                            }
                            if (citations[j - 1].sortedItems[0].slice(-1)[0].legislation_id) {
                                oldlastid = citations[j - 1].sortedItems[0].slice(-1)[0].legislation_id;
                            }
                        }
                        if (j > 0 && parseInt(k, 10) === 0 && citations[j - 1].properties.noteIndex !== citations[j].properties.noteIndex) {
                            var items = citations[(j - 1)].sortedItems;
                            var useme = false;
                            var oldid = citations[j - 1].sortedItems[0][0].id;
                            if (citations[j - 1].sortedItems[0][0].legislation_id) {
                                oldid = citations[j - 1].sortedItems[0][0].legislation_id;
                            }
                            if ((oldid  == myid && citations[j - 1].properties.noteIndex >= (citations[j].properties.noteIndex - 1)) || citations[j - 1].sortedItems[0][1].id == this.registry.registry[item[1].id].parallel) {
                                if (citationsInNote[citations[j - 1].properties.noteIndex] === 1 || citations[j - 1].properties.noteIndex === 0) {
                                    useme = true;
                                }
                            }
                            for (n = 0, nlen = items.slice(1).length; n < nlen; n += 1) {
                                var itmp = items.slice(1)[n];
                                if (!this.registry.registry[itmp[1].id].parallel || this.registry.registry[itmp[1].id].parallel == this.registry.registry[itmp[1].id]) {
                                    useme = false;
                                }
                            }
                            if (useme) {
                                ibidme = true;
                            } else {
                                suprame = true;
                            }
                        } else if (k > 0 && incitationid == myid) {
                            ibidme = true;
                        } else if (k === 0 && citations[j - 1].properties.noteIndex == citations[j].properties.noteIndex
                                   && citations[j - 1].sortedItems.length 
                                   && oldlastid == myid) {
                            ibidme = true;
                        } else {
                            suprame = true;
                        }
                        var prev, prev_locator, prev_label, curr_locator, curr_label;
                        if (ibidme) {
                            if (k > 0) {
                                prev = onecitation.sortedItems[(k - 1)][1];
                            } else {
                                prev = citations[(j - 1)].sortedItems[0][1];
                            }
                            if (prev.locator) {
                                if (prev.label) {
                                    prev_label = prev.label;
                                } else {
                                    prev_label = "";
                                }
                                prev_locator = "" + prev.locator + prev_label;
                            } else {
                                prev_locator = prev.locator;
                            }
                            if (mylocator) {
                                if (mylabel) {
                                    curr_label = mylabel;
                                } else {
                                    curr_label = "";
                                }
                                curr_locator = "" + mylocator + curr_label;
                            } else {
                                curr_locator = mylocator;
                            }
                        }
                        if (ibidme && prev_locator && !curr_locator) {
                            ibidme = false;
                            suprame = true;
                        }
                        if (ibidme) {
                            if (!prev_locator && curr_locator) {
                                item[1].position = CSL.POSITION_IBID_WITH_LOCATOR;
                            } else if (!prev_locator && !curr_locator) {
                                item[1].position = CSL.POSITION_IBID;
                            } else if (prev_locator && curr_locator === prev_locator) {
                                item[1].position = CSL.POSITION_IBID;
                            } else if (prev_locator && curr_locator && curr_locator !== prev_locator) {
                                item[1].position = CSL.POSITION_IBID_WITH_LOCATOR;
                            } else {
                                ibidme = false; // just to be clear
                                suprame = true;
                            }
                        }
                        if (suprame) {
                            item[1].position = CSL.POSITION_SUBSEQUENT;
                        }
                        if (suprame || ibidme) {
                            if (first_ref[myid] != onecitation.properties.noteIndex) {
                                item[1]["first-reference-note-number"] = first_ref[myid];
                                if (this.registry.registry[myid]) {
                                    var oldFirst = this.registry.citationreg.citationsByItemId[myid][0].properties.noteIndex;
                                    var newFirst = onecitation.properties.noteIndex;
                                    this.registry.registry[myid]['first-reference-note-number'] = newFirst < oldFirst ? newFirst: oldFirst;
                                }
                            }
                        }
                    }
                    if (onecitation.properties.noteIndex) {
                        var note_distance = parseInt(onecitation.properties.noteIndex, 10) - parseInt(last_ref[myid], 10);
                        if (item[1].position !== CSL.POSITION_FIRST 
                            && note_distance <= this.citation.opt["near-note-distance"]) {
                            item[1]["near-note"] = true;
                        }
                        last_ref[myid] = onecitation.properties.noteIndex;
                    }
                    if (onecitation.citationID != citation.citationID) {
                        for (n = 0, nlen = CSL.POSITION_TEST_VARS.length; n < nlen; n += 1) {
                            var param = CSL.POSITION_TEST_VARS[n];
                            if (item[1][param] !== oldvalue[param]) {
                                if (this.registry.registry[myid]) {
                                    if (param === 'first-reference-note-number') {
                                        rerunAkeys[this.registry.registry[myid].ambig] = true;
                                        this.tmp.taintedItemIDs[myid] = true;
                                    }
                                }
                                this.tmp.taintedCitationIDs[onecitation.citationID] = true;
                            }
                        }
                    }
                    if (this.sys.variableWrapper) {
                        item[1].index = onecitation.properties.index;
                        item[1].noteIndex = onecitation.properties.noteIndex;
                    }
                }
            }
        }
    }
    if (this.opt.citation_number_sort && sortedItems && sortedItems.length > 1 && this.citation_sort.tokens.length > 0) {
        if (!citation.properties.unsorted) {
            for (var i = 0, ilen = sortedItems.length; i < ilen; i += 1) {
                sortedItems[i][1].sortkeys = CSL.getSortKeys.call(this, sortedItems[i][0], "citation_sort");
            }
            sortedItems.sort(this.citation.srt.compareCompositeKeys);
        }
    }
    for (var key in this.tmp.taintedItemIDs) {
        if (this.tmp.taintedItemIDs.hasOwnProperty(key)) {
            citations = this.registry.citationreg.citationsByItemId[key];
            if (citations) {
                for (var i = 0, ilen = citations.length; i < ilen; i += 1) {
                    this.tmp.taintedCitationIDs[citations[i].citationID] = true;
                }
            }
        }
    }
    var ret = [];
    if (flag === CSL.PREVIEW) {
        try {
            ret = this.process_CitationCluster.call(this, citation.sortedItems, citation.citationID);
        } catch (e) {
            CSL.error("Error running CSL processor for preview: "+e);
        }
        this.registry.citationreg.citationByIndex = oldCitationList;
        this.registry.citationreg.citationById = {};
        for (var i = 0, ilen = oldCitationList.length; i < ilen; i += 1) {
            this.registry.citationreg.citationById[oldCitationList[i].citationID] = oldCitationList[i];
        }
        var oldItemIds = [];
        for (var i = 0, ilen = oldItemList.length; i < ilen; i += 1) {
            oldItemIds.push("" + oldItemList[i].id);
        }
        this.updateItems(oldItemIds, null, null, true);
        for (var key in oldAmbigs) {
            if (oldAmbigs.hasOwnProperty(key)) {
                this.registry.registry[key].disambig = oldAmbigs[key];
            }
        }
    } else {
        for (var rerunAkey in rerunAkeys) {
            this.disambiguate.run(rerunAkey, citation);
        }
        var obj;
        for (var key in this.tmp.taintedCitationIDs) {
            if (key == citation.citationID) {
                continue;
            }
            var mycitation = this.registry.citationreg.citationById[key];
            if (!mycitation.properties.unsorted) {
                for (var i = 0, ilen = mycitation.sortedItems.length; i < ilen; i += 1) {
                    mycitation.sortedItems[i][1].sortkeys = CSL.getSortKeys.call(this, mycitation.sortedItems[i][0], "citation_sort");
                }
                mycitation.sortedItems.sort(this.citation.srt.compareCompositeKeys);
            }
            this.tmp.citation_pos = mycitation.properties.index;
            this.tmp.citation_note_index = mycitation.properties.noteIndex;
            this.tmp.citation_id = "" + mycitation.citationID;
            obj = [];
            obj.push(mycitation.properties.index);
            obj.push(this.process_CitationCluster.call(this, mycitation.sortedItems, mycitation.citationID));
            obj.push(mycitation.citationID);
            ret.push(obj);
        }
        this.tmp.taintedItemIDs = {};
        this.tmp.taintedCitationIDs = {};
        this.tmp.citation_pos = citation.properties.index;
        this.tmp.citation_note_index = citation.properties.noteIndex;
        this.tmp.citation_id = "" + citation.citationID;
        obj = [];
        obj.push(citationsPre.length);
        obj.push(this.process_CitationCluster.call(this, sortedItems, citation.citationID));
        obj.push(citation.citationID);
        ret.push(obj);
        ret.sort(function (a, b) {
            if (a[0] > b[0]) {
                return 1;
            } else if (a[0] < b[0]) {
                return -1;
            } else {
                return 0;
            }
        });
    }
    return_data.citation_errors = this.tmp.citation_errors.slice();
    return [return_data, ret];
};
CSL.Engine.prototype.process_CitationCluster = function (sortedItems, citationID) {
    var str;
    this.parallel.StartCitation(sortedItems);
    str = CSL.getCitationCluster.call(this, sortedItems, citationID);
    return str;
};
CSL.Engine.prototype.makeCitationCluster = function (rawList) {
    var inputList, newitem, str, pos, len, item, Item;
    inputList = [];
    len = rawList.length;
    for (pos = 0; pos < len; pos += 1) {
        item = {};
        for (var key in rawList[pos]) {
            item[key] = rawList[pos][key];
        }
        Item = this.retrieveItem("" + item.id);
        if (this.opt.development_extensions.locator_label_parse) {
            if (item.locator && ["bill","gazette","legislation","regulation","treaty"].indexOf(Item.type) === -1 && (!item.label || item.label === 'page')) {
                var m = CSL.LOCATOR_LABELS_REGEXP.exec(item.locator);
                if (m) {
                    var tryLabel = CSL.LOCATOR_LABELS_MAP[m[2]];
                    if (this.getTerm(tryLabel)) {
                        item.label = tryLabel;
                        item.locator = m[3];
                    }
                }
            }
        }
        if (item.locator) {
            item.locator = ("" + item.locator).replace(/\s+$/, '');
        }
        newitem = [Item, item];
        inputList.push(newitem);
    }
    if (this.opt.development_extensions.static_statute_locator) {
        this.remapSectionVariable(inputList);
    }
    if (inputList && inputList.length > 1 && this.citation_sort.tokens.length > 0) {
        len = inputList.length;
        for (pos = 0; pos < len; pos += 1) {
            inputList[pos][1].sortkeys = CSL.getSortKeys.call(this, inputList[pos][0], "citation_sort");
        }
        inputList.sort(this.citation.srt.compareCompositeKeys);
    }
    this.tmp.citation_errors = [];
    this.parallel.StartCitation(inputList);
    str = CSL.getCitationCluster.call(this, inputList);
    return str;
};
CSL.getAmbiguousCite = function (Item, disambig, visualForm, item) {
    var use_parallels, ret;
    var flags = this.tmp.group_context.tip;
    var oldTermSiblingLayer = {
        term_intended: flags.term_intended,
        variable_attempt: flags.variable_attempt,
        variable_success: flags.variable_success,
        output_tip: flags.output_tip,
        label_form: flags.label_form,
        parallel_conditions: flags.parallel_conditions,
        condition: flags.condition,
        force_suppress: flags.force_suppress,
        done_vars: flags.done_vars.slice()
    }
    if (disambig) {
        this.tmp.disambig_request = disambig;
    } else {
        this.tmp.disambig_request = false;
    }
    var itemSupp = {
        position: 1,
        "near-note": true
    };
    if (item) {
        itemSupp.locator = item.locator;
        itemSupp.label = item.label;
    }
    if (this.registry.registry[Item.id] 
        && this.registry.citationreg.citationsByItemId
        && this.registry.citationreg.citationsByItemId[Item.id]
        && this.registry.citationreg.citationsByItemId[Item.id].length 
        && visualForm) {
        if (this.citation.opt["givenname-disambiguation-rule"] === "by-cite") {
            itemSupp['first-reference-note-number'] = this.registry.registry[Item.id]['first-reference-note-number'];
        }
    }
    this.tmp.area = "citation";
    this.tmp.root = "citation";
    this.parallel.use_parallels = (this.parallel.use_parallels === true || this.parallel.use_parallels === null) ? null : false;
    this.tmp.suppress_decorations = true;
    this.tmp.just_looking = true;
    CSL.getCite.call(this, Item, itemSupp, null, false);
    for (var i=0,ilen=this.output.queue.length;i<ilen;i+=1) {
        CSL.Output.Queue.purgeEmptyBlobs(this.output.queue[i]);
    }
    if (this.opt.development_extensions.clean_up_csl_flaws) {
        for (var j=0,jlen=this.output.queue.length;j<jlen;j+=1) {
            this.output.adjust.upward(this.output.queue[j]);
            this.output.adjust.leftward(this.output.queue[j]);
            this.output.adjust.downward(this.output.queue[j]);
            this.output.adjust.fix(this.output.queue[j]);
        }
    }
    var ret = this.output.string(this, this.output.queue);
    this.tmp.just_looking = false;
    this.tmp.suppress_decorations = false;
    this.parallel.use_parallels = this.parallel.use_parallels === null ? true : false;
    this.tmp.group_context.replace(oldTermSiblingLayer);
    return ret;
};
CSL.getSpliceDelimiter = function (last_locator, last_collapsed, pos) {
    if (undefined !== this.citation.opt["after-collapse-delimiter"]) {
        if (last_locator) {
            this.tmp.splice_delimiter = this.citation.opt["after-collapse-delimiter"];
        } else if (last_collapsed && !this.tmp.have_collapsed) {
            this.tmp.splice_delimiter = this.citation.opt["after-collapse-delimiter"];
        } else if (!last_collapsed && !this.tmp.have_collapsed && this.citation.opt.collapse !== "year-suffix") {
            this.tmp.splice_delimiter = this.citation.opt["after-collapse-delimiter"];
        } else {
            this.tmp.splice_delimiter = this.citation.opt.layout_delimiter;
        }
    } else if (this.tmp.use_cite_group_delimiter) {
        this.tmp.splice_delimiter = this.citation.opt.cite_group_delimiter;
    } else {
        if (this.tmp.have_collapsed && this.opt.xclass === "in-text" && this.opt.update_mode !== CSL.NUMERIC) {
            this.tmp.splice_delimiter = ", ";
        } else if (this.tmp.cite_locales[pos - 1]) {
            var alt_affixes = this.tmp.cite_affixes[this.tmp.area][this.tmp.cite_locales[pos - 1]];
            if (alt_affixes && alt_affixes.delimiter) {
                this.tmp.splice_delimiter = alt_affixes.delimiter;
            }
        } else if (!this.tmp.splice_delimiter) {
            this.tmp.splice_delimiter = "";
        }
    }
    return this.tmp.splice_delimiter;
};
CSL.getCitationCluster = function (inputList, citationID) {
    var result, objects, myparams, len, pos, item, last_collapsed, params, empties, composite, compie, myblobs, Item, llen, ppos, obj, preceding_item, txt_esc, error_object;
    inputList = inputList ? inputList : [];
    this.tmp.last_primary_names_string = false;
    txt_esc = CSL.getSafeEscape(this);
    this.tmp.area = "citation";
    this.tmp.root = "citation";
    result = "";
    objects = [];
    this.tmp.last_suffix_used = "";
    this.tmp.last_names_used = [];
    this.tmp.last_years_used = [];
    this.tmp.backref_index = [];
    this.tmp.cite_locales = [];
    this.output.checkNestedBrace = new CSL.checkNestedBrace(this);
    var use_layout_prefix = this.output.checkNestedBrace.update(this.citation.opt.layout_prefix);
    var suppressTrailingPunctuation = false;
    if (this.opt.xclass === "note" && this.citation.opt.suppressTrailingPunctuation) {
        suppressTrailingPunctuation = true;
    }
    if (citationID) {
        if (this.registry.citationreg.citationById[citationID].properties["suppress-trailing-punctuation"]) {
            suppressTrailingPunctuation = true;
        }
    }
    if (this.opt.xclass === "note") {
        var parasets = [];
        var lastTitle = false;
        var lastPosition = false;
        var lastID = false;
        var lst = [];
        for (var i=0, ilen = inputList.length; i < ilen; i += 1) {
            var type = inputList[i][0].type;
            var title = inputList[i][0].title;
            var position = inputList[i][1].position;
            var id = inputList[i][0].id;
            if (title && type === "legal_case" && id !== lastID && position) {
                if (title !== lastTitle || parasets.length === 0) {
                    lst = [];
                    parasets.push(lst);
                }
                lst.push(inputList[i][1]);
            }
            lastTitle = title;
            lastPosition = position;
            lastID = id;
        }
        for (i=0, ilen=parasets.length; i < ilen; i += 1) {
            lst = parasets[i];
            if (lst.length < 2) {
                continue;
            }
            var locatorInLastPosition = lst.slice(-1)[0].locator;
            if (locatorInLastPosition) {
                for (var j=0, jlen=lst.length - 1; j < jlen; j += 1) {
                    if (lst[j].locator) {
                        locatorInLastPosition = false;
                    }
                }
            }
            if (locatorInLastPosition) {
                lst[0].locator = locatorInLastPosition;
                delete lst.slice(-1)[0].locator;
                lst[0].label = lst.slice(-1)[0].label;
                if (lst.slice(-1)[0].label) {
                    delete lst.slice(-1)[0].label;
                }
            }
       }
    }
    myparams = [];
    len = inputList.length;
    for (pos = 0; pos < len; pos += 1) {
        Item = inputList[pos][0];
        item = inputList[pos][1];
        item = CSL.parseLocator.call(this, item);
        last_collapsed = this.tmp.have_collapsed;
        var last_locator = false;
        if (pos > 0 && inputList[pos-1][1]) {
            last_locator = !!inputList[pos-1][1].locator;
        }
        params = {};
        this.tmp.shadow_numbers = {};
        if (!this.tmp.just_looking && this.opt.hasPlaceholderTerm) {
            var output = this.output;
            this.output = new CSL.Output.Queue(this);
            this.output.adjust = new CSL.Output.Queue.adjust();
            CSL.getAmbiguousCite.call(this, Item, null, false, item);
            this.output = output;
        }
        this.tmp.in_cite_predecessor = false;
        if (pos > 0) {
            CSL.getCite.call(this, Item, item, "" + inputList[(pos - 1)][0].id, true);
        } else {
            this.tmp.term_predecessor = false;
            CSL.getCite.call(this, Item, item, null, true);
        }
        if (!this.tmp.cite_renders_content) {
            error_object = {
                citationID: "" + this.tmp.citation_id,
                index: this.tmp.citation_pos,
                noteIndex: this.tmp.citation_note_index,
                itemID: "" + Item.id,
                citationItems_pos: pos,
                error_code: CSL.ERROR_NO_RENDERED_FORM
            };
            this.tmp.citation_errors.push(error_object);
        }
        if (pos === (inputList.length - 1)) {
            this.parallel.ComposeSet();
        }
        params.splice_delimiter = CSL.getSpliceDelimiter.call(this, last_locator, last_collapsed, pos);
        if (item && item["author-only"]) {
            this.tmp.suppress_decorations = true;
        }
        if (pos > 0) {
            preceding_item = inputList[pos - 1][1];
            var precedingEndsInPeriodOrComma = preceding_item.suffix && [".", ","].indexOf(preceding_item.suffix.slice(-1)) > -1;
            var currentStartsWithPeriodOrComma = !preceding_item.suffix && item.prefix && [".", ","].indexOf(item.prefix.slice(0, 1)) > -1;
            if (precedingEndsInPeriodOrComma || currentStartsWithPeriodOrComma) {
                var spaceidx = params.splice_delimiter.indexOf(" ");
                if (spaceidx > -1 && !currentStartsWithPeriodOrComma) {
                    params.splice_delimiter = params.splice_delimiter.slice(spaceidx);
                } else {
                    params.splice_delimiter = "";
                }
            }
        }
        params.suppress_decorations = this.tmp.suppress_decorations;
        params.have_collapsed = this.tmp.have_collapsed;
        myparams.push(params);
    }
    this.tmp.has_purged_parallel = false;
    this.parallel.PruneOutputQueue(this);
    empties = 0;
    myblobs = this.output.queue.slice();
    var fakeblob = {
        strings: {
            suffix: this.citation.opt.layout_suffix,
            delimiter: this.citation.opt.layout_delimiter                
        }
    };
    var suffix = this.citation.opt.layout_suffix;
    var last_locale = this.tmp.cite_locales[this.tmp.cite_locales.length - 1];
    if (last_locale && this.tmp.cite_affixes[this.tmp.area][last_locale] && this.tmp.cite_affixes[this.tmp.area][last_locale].suffix) {
        suffix = this.tmp.cite_affixes[this.tmp.area][last_locale].suffix;
    }
    if (CSL.TERMINAL_PUNCTUATION.slice(0, -1).indexOf(suffix.slice(0, 1)) > -1) {
        suffix = suffix.slice(0, 1);
    }
    var delimiter = this.citation.opt.layout_delimiter;
    if (!delimiter) {
        delimiter = "";
    }
    if (CSL.TERMINAL_PUNCTUATION.slice(0, -1).indexOf(delimiter.slice(0, 1)) > -1) {
        delimiter = delimiter.slice(0, 1);
    }
    suffix = this.output.checkNestedBrace.update(suffix);
    for (var i=0,ilen=this.output.queue.length;i<ilen;i+=1) {
        CSL.Output.Queue.purgeEmptyBlobs(this.output.queue[i]);
    }
    if (!this.tmp.suppress_decorations && this.output.queue.length) {
        if (!(this.opt.development_extensions.apply_citation_wrapper
              && this.sys.wrapCitationEntry
               && !this.tmp.just_looking
              && this.tmp.area === "citation")) { 
            if (!suppressTrailingPunctuation) {
                this.output.queue[this.output.queue.length - 1].strings.suffix = suffix;
            }
            this.output.queue[0].strings.prefix = use_layout_prefix;
        }
    }
    if (this.opt.development_extensions.clean_up_csl_flaws) {
        for (var j=0,jlen=this.output.queue.length;j<jlen;j+=1) {
            this.output.adjust.upward(this.output.queue[j]);
            this.output.adjust.leftward(this.output.queue[j]);
            this.output.adjust.downward(this.output.queue[j]);
            this.tmp.last_chr = this.output.adjust.fix(this.output.queue[j]);
        }
    }
    for (pos = 0, len = myblobs.length; pos < len; pos += 1) {
        var buffer = [];
        this.output.queue = [myblobs[pos]];
        this.tmp.suppress_decorations = myparams[pos].suppress_decorations;
        this.tmp.splice_delimiter = myparams[pos].splice_delimiter;
        if (myblobs[pos].parallel_delimiter) {
            this.tmp.splice_delimiter = myblobs[pos].parallel_delimiter;
        }
        this.tmp.have_collapsed = myparams[pos].have_collapsed;
        composite = this.output.string(this, this.output.queue);
        this.tmp.suppress_decorations = false;
        if ("string" === typeof composite) {
            this.tmp.suppress_decorations = false;
            return composite;
        }
        if ("object" === typeof composite && composite.length === 0 && !item["suppress-author"]) {
            if (this.tmp.has_purged_parallel) {
                composite.push("");
            } else {
                var errStr = "[CSL STYLE ERROR: reference with no printed form.]";
                var preStr = pos === 0 ? txt_esc(this.citation.opt.layout_prefix) : "";
                var sufStr = pos === (myblobs.length - 1) ? txt_esc(this.citation.opt.layout_suffix) : "";
                composite.push(preStr + errStr + sufStr);
            }
        }
        if (buffer.length && "string" === typeof composite[0]) {
            composite.reverse();
            var tmpstr = composite.pop();
            if (tmpstr && tmpstr.slice(0, 1) === ",") {
                buffer.push(tmpstr);
            } else if ("string" == typeof buffer.slice(-1)[0] && buffer.slice(-1)[0].slice(-1) === ",") {
                buffer.push(" " + tmpstr);
            } else if (tmpstr) {
                buffer.push(txt_esc(this.tmp.splice_delimiter) + tmpstr);
            }
        } else {
            composite.reverse();
            compie = composite.pop();
            if ("undefined" !== typeof compie) {
                if (buffer.length && "string" === typeof buffer[buffer.length - 1]) {
                    buffer[buffer.length - 1] += compie.successor_prefix;
                }
                buffer.push(compie);
            }
        }
        llen = composite.length;
        for (ppos = 0; ppos < llen; ppos += 1) {
            obj = composite[ppos];
            if ("string" === typeof obj) {
                buffer.push(txt_esc(this.tmp.splice_delimiter) + obj);
                continue;
            }
            compie = composite.pop();
            if ("undefined" !== typeof compie) {
                buffer.push(compie);
            }
        }
        if (buffer.length === 0 && !inputList[pos][1]["suppress-author"]) {
            empties += 1;
        }
        if (buffer.length > 1 && typeof buffer[0] !== "string") {
            buffer = [this.output.renderBlobs(buffer)];
        }
        if (buffer.length) {
            if ("string" === typeof buffer[0]) {
                if (pos > 0) {
                    buffer[0] = txt_esc(this.tmp.splice_delimiter) + buffer[0];
                }
            } else {
                if (pos > 0) {
                    buffer[0].splice_prefix = this.tmp.splice_delimiter;
                } else {
                    buffer[0].splice_prefix = "";
                }
            }
        }
        objects = objects.concat(buffer);
    }
    result += this.output.renderBlobs(objects);
    if (result) {
        if (!this.tmp.suppress_decorations) {
            len = this.citation.opt.layout_decorations.length;
            for (pos = 0; pos < len; pos += 1) {
                params = this.citation.opt.layout_decorations[pos];
                if (params[1] === "normal") {
                    continue;
                }
                if (!item || !item["author-only"]) {
                    result = this.fun.decorate[params[0]][params[1]](this, result);
                }
            }
        }
    }
    this.tmp.suppress_decorations = false;
    return result;
};
CSL.getCite = function (Item, item, prevItemID, blockShadowNumberReset) {
    var next, error_object;
    this.tmp.cite_renders_content = false;
    this.parallel.StartCite(Item, item, prevItemID);
    CSL.citeStart.call(this, Item, item, blockShadowNumberReset);
    next = 0;
    this.tmp.name_node = {};
    this.nameOutput = new CSL.NameOutput(this, Item, item);
    while (next < this[this.tmp.area].tokens.length) {
        next = CSL.tokenExec.call(this, this[this.tmp.area].tokens[next], Item, item);
    }
    CSL.citeEnd.call(this, Item, item);
    this.parallel.CloseCite(this);
    if (!this.tmp.cite_renders_content && !this.tmp.just_looking) {
        if (this.tmp.area === "bibliography") {
            error_object = {
                index: this.tmp.bibliography_pos,
                itemID: "" + Item.id,
                error_code: CSL.ERROR_NO_RENDERED_FORM
            };
            this.tmp.bibliography_errors.push(error_object);
        }
    }
    return "" + Item.id;
};
CSL.citeStart = function (Item, item, blockShadowNumberReset) {
    if (!blockShadowNumberReset) {
        this.tmp.shadow_numbers = {};
    }
    this.tmp.disambiguate_count = 0;
    this.tmp.disambiguate_maxMax = 0;
    this.tmp.same_author_as_previous_cite = false;
    if (!this.tmp.suppress_decorations) {
        this.tmp.subsequent_author_substitute_ok = true;
    } else {
        this.tmp.subsequent_author_substitute_ok = false;
    }
    this.tmp.lastchr = "";
    if (this.tmp.area === "citation" && this.citation.opt.collapse && this.citation.opt.collapse.length) {
        this.tmp.have_collapsed = true;
    } else {
        this.tmp.have_collapsed = false;
    }
    this.tmp.render_seen = false;
    if (this.tmp.disambig_request  && ! this.tmp.disambig_override) {
        this.tmp.disambig_settings = this.tmp.disambig_request;
    } else if (this.registry.registry[Item.id] && ! this.tmp.disambig_override) {
        this.tmp.disambig_request = this.registry.registry[Item.id].disambig;
        this.tmp.disambig_settings = this.registry.registry[Item.id].disambig;
    } else {
        this.tmp.disambig_settings = new CSL.AmbigConfig();
    }
    if (this.tmp.area !== 'citation') {
        if (!this.registry.registry[Item.id]) {
            this.tmp.disambig_restore = new CSL.AmbigConfig();
        } else {
            this.tmp.disambig_restore = CSL.cloneAmbigConfig(this.registry.registry[Item.id].disambig);
            if (this.tmp.area === 'bibliography' && this.tmp.disambig_settings && this.tmp.disambig_override) {
                if (this.opt["disambiguate-add-names"]) {
                    this.tmp.disambig_settings.names = this.registry.registry[Item.id].disambig.names.slice();
                    if (this.tmp.disambig_request) {
                        this.tmp.disambig_request.names = this.registry.registry[Item.id].disambig.names.slice();
                    }
                }
                if (this.opt["disambiguate-add-givenname"]) {
                    this.tmp.disambig_request = this.tmp.disambig_settings;
                    this.tmp.disambig_settings.givens = this.registry.registry[Item.id].disambig.givens.slice();
                    this.tmp.disambig_request.givens = this.registry.registry[Item.id].disambig.givens.slice();
                    for (var i=0,ilen=this.tmp.disambig_settings.givens.length;i<ilen;i+=1) {
                        this.tmp.disambig_settings.givens[i] = this.registry.registry[Item.id].disambig.givens[i].slice();
                    }
                    for (var i=0,ilen=this.tmp.disambig_request.givens.length;i<ilen;i+=1) {
                        this.tmp.disambig_request.givens[i] = this.registry.registry[Item.id].disambig.givens[i].slice();
                    }
                }
            }
        }
    }
    this.tmp.names_used = [];
    this.tmp.nameset_counter = 0;
    this.tmp.years_used = [];
    this.tmp.names_max.clear();
    this.tmp.splice_delimiter = this[this.tmp.area].opt.layout_delimiter;
    this.bibliography_sort.keys = [];
    this.citation_sort.keys = [];
    this.tmp.has_done_year_suffix = false;
    this.tmp.last_cite_locale = false;
    if (!this.tmp.just_looking && item && !item.position && this.registry.registry[Item.id]) {
        this.tmp.disambig_restore = CSL.cloneAmbigConfig(this.registry.registry[Item.id].disambig);
    }
    this.tmp.first_name_string = false;
    this.tmp.authority_stop_last = 0;
};
CSL.citeEnd = function (Item, item) {
    if (this.tmp.disambig_restore && this.registry.registry[Item.id]) {
        this.registry.registry[Item.id].disambig.names = this.tmp.disambig_restore.names.slice();
        this.registry.registry[Item.id].disambig.givens = this.tmp.disambig_restore.givens.slice();
        for (var i=0,ilen=this.registry.registry[Item.id].disambig.givens.length;i<ilen;i+=1) {
            this.registry.registry[Item.id].disambig.givens[i] = this.tmp.disambig_restore.givens[i].slice();
        }
    }
    this.tmp.disambig_restore = false;
    if (item && item.suffix) {
        this.tmp.last_suffix_used = item.suffix;
    } else {
        this.tmp.last_suffix_used = "";
    }
    this.tmp.last_years_used = this.tmp.years_used.slice();
    this.tmp.last_names_used = this.tmp.names_used.slice();
    this.tmp.cut_var = false;
    this.tmp.disambig_request = false;
    this.tmp.cite_locales.push(this.tmp.last_cite_locale);
    if (this.tmp.issued_date && this.tmp.renders_collection_number) {
        var buf = [];
        for (var i = this.tmp.issued_date.list.length - 1; i > this.tmp.issued_date.pos; i += -1) {
            buf.push(this.tmp.issued_date.list.pop());
        }
        this.tmp.issued_date.list.pop();
        for (i = buf.length - 1; i > -1; i += -1) {
            this.tmp.issued_date.list.push(buf.pop());
        }
        if (this.parallel.use_parallels) {
            this.parallel.cite["issued"] = false;
        }
    }
    this.tmp.issued_date = false;
    this.tmp.renders_collection_number = false;
};
module.exports = CSL;
CSL.Engine.prototype.makeBibliography = function (bibsection) {
    var debug, ret, params, maxoffset, item, len, pos, tok, tokk, tokkk, entry_ids, entry_strings, bibliography_errors;
    debug = false;
    if (!this.bibliography.tokens.length) {
        return false;
    }
    if ("string" === typeof bibsection) {
        this.opt.citation_number_slug = bibsection;
        bibsection = false;
    }
    ret = CSL.getBibliographyEntries.call(this, bibsection);
    entry_ids = ret[0];
    entry_strings = ret[1];
    var done = ret[2];
    params = {
        "maxoffset": 0,
        "entryspacing": this.bibliography.opt["entry-spacing"],
        "linespacing": this.bibliography.opt["line-spacing"],
        "second-field-align": false,
        "entry_ids": entry_ids,
        "bibliography_errors": this.tmp.bibliography_errors.slice(),
        "done": done
    };
    if (this.bibliography.opt["second-field-align"]) {
        params["second-field-align"] = this.bibliography.opt["second-field-align"];
    }
    maxoffset = 0;
    len = this.registry.reflist.length;
    for (pos = 0; pos < len; pos += 1) {
        item = this.registry.reflist[pos];
        if (item.offset > params.maxoffset) {
            params.maxoffset = item.offset;
        }
    }
    if (this.bibliography.opt.hangingindent) {
        params.hangingindent = this.bibliography.opt.hangingindent;
    }
    params.bibstart = this.fun.decorate.bibstart;
    params.bibend = this.fun.decorate.bibend;
    this.opt.citation_number_slug = false;
    return [params, entry_strings];
};
CSL.getBibliographyEntries = function (bibsection) {
    var ret, input, include, anymatch, allmatch, bib_entry, res, len, pos, item, llen, ppos, spec, lllen, pppos, bib_layout, topblobs, all_item_ids, entry_item_ids, debug, collapse_parallel, i, ilen, siblings, skips, sortedItems, eyetem, chr, entry_item_data, j, jlen, newIDs, originalIDs;
    ret = [];
    entry_item_data = [];
    this.tmp.area = "bibliography";
    this.tmp.root = "bibliography";
    this.tmp.last_rendered_name = false;
    this.tmp.bibliography_errors = [];
    this.tmp.bibliography_pos = 0;
    if (bibsection && bibsection.page_start && bibsection.page_length) {
        input = this.registry.getSortedIds();        
    } else {
        input = this.retrieveItems(this.registry.getSortedIds());
    }
    this.tmp.disambig_override = true;
    function eval_string(a, b) {
        if (a === b) {
            return true;
        }
        return false;
    }
    function eval_list(a, lst) {
        lllen = lst.length;
        for (pppos = 0; pppos < lllen; pppos += 1) {
            if (eval_string(a, lst[pppos])) {
                return true;
            }
        }
        return false;
    }
    function eval_spec(a, b) {
        if ((a === "none" || !a) && !b) {
            return true;
        }
        if ("string" === typeof b) {
            return eval_string(a, b);
        } else if (!b) {
            return false;
        } else {
            return eval_list(a, b);
        }
    }
    skips = {};
    var page_item_count;
    if (bibsection && bibsection.page_start && bibsection.page_length) {
        page_item_count = 0;
        if (bibsection.page_start !== true) {
            for (var i = 0, ilen = input.length; i < ilen; i += 1) {
                skips[input[i]] = true;
                if (bibsection.page_start == input[i]) {
                    break;
                }
            }
        }
    }
    var processed_item_ids = [];
    for (var i = 0, ilen = input.length; i < ilen; i += 1) {
        if (bibsection && bibsection.page_start && bibsection.page_length) {
            if (skips[input[i]]) {
                continue;
            }
            item = this.retrieveItem(input[i]);
            if (page_item_count === bibsection.page_length) {
                break;
            }
        } else {
            item = input[i];
            if (skips[item.id]) {
                continue;
            }
        }
        if (bibsection) {
            include = true;
            if (bibsection.include) {
                include = false;
                for (j = 0, jlen = bibsection.include.length; j < jlen; j += 1) {
                    spec = bibsection.include[j];
                    if (eval_spec(spec.value, item[spec.field])) {
                        include = true;
                        break;
                    }
                }
            } else if (bibsection.exclude) {
                anymatch = false;
                for (j = 0, jlen = bibsection.exclude.length; j < jlen; j += 1) {
                    spec = bibsection.exclude[j];
                    if (eval_spec(spec.value, item[spec.field])) {
                        anymatch = true;
                        break;
                    }
                }
                if (anymatch) {
                    include = false;
                }
            } else if (bibsection.select) {
                include = false;
                allmatch = true;
                for (j = 0, jlen = bibsection.select.length; j < jlen; j += 1) {
                    spec = bibsection.select[j];
                    if (!eval_spec(spec.value, item[spec.field])) {
                        allmatch = false;
                    }
                }
                if (allmatch) {
                    include = true;
                }
            }
            if (bibsection.quash) {
                allmatch = true;
                for (j = 0, jlen = bibsection.quash.length; j < jlen; j += 1) {
                    spec = bibsection.quash[j];
                    if (!eval_spec(spec.value, item[spec.field])) {
                        allmatch = false;
                    }
                }
                if (allmatch) {
                    include = false;
                }
            }
            if (!include) {
                continue;
            }
        }
        bib_entry = new CSL.Token("group", CSL.START);
        bib_entry.decorations = [["@bibliography", "entry"]].concat(this.bibliography.opt.layout_decorations);
        this.output.startTag("bib_entry", bib_entry);
        if (item.system_id && this.sys.embedBibliographyEntry) {
            this.output.current.value().item_id = item.system_id;
        } else {
            this.output.current.value().system_id = item.id;
        }
        sortedItems = [[{id: "" + item.id}, item]];
        entry_item_ids = [];
        if (this.registry.registry[item.id].master 
            && !(bibsection && bibsection.page_start && bibsection.page_length)) {
            collapse_parallel = true;
            this.parallel.StartCitation(sortedItems);
            this.output.queue[0].strings.delimiter = ", ";
            this.tmp.term_predecessor = false;
            entry_item_ids.push("" + CSL.getCite.call(this, item));
            skips[item.id] = true;
            siblings = this.registry.registry[item.id].siblings;
            for (j = 0, jlen = siblings.length; j < jlen; j += 1) {
                var k = this.registry.registry[item.id].siblings[j];
                eyetem = this.retrieveItem(k);
                entry_item_ids.push("" + CSL.getCite.call(this, eyetem));
                skips[eyetem.id] = true;
            }
            this.parallel.ComposeSet();
            this.parallel.PruneOutputQueue();
        } else if (!this.registry.registry[item.id].siblings) {
            this.parallel.StartCitation(sortedItems);
            this.tmp.term_predecessor = false;
            entry_item_ids.push("" + CSL.getCite.call(this, item));
            if (bibsection && bibsection.page_start && bibsection.page_length) {
                page_item_count += 1;
            }
        }
        entry_item_data.push("");
        this.tmp.bibliography_pos += 1;
        processed_item_ids.push(entry_item_ids);
        this.output.endTag("bib_entry");
        if (this.output.queue[0].blobs.length && this.output.queue[0].blobs[0].blobs.length) {
            if (collapse_parallel || !this.output.queue[0].blobs[0].blobs[0].strings) {
                topblobs = this.output.queue[0].blobs;
                collapse_parallel = false;
            } else {
                topblobs = this.output.queue[0].blobs[0].blobs;
            }
            topblobs[0].strings.prefix = this.bibliography.opt.layout_prefix + topblobs[0].strings.prefix;
        }
        for (var j=0,jlen=this.output.queue.length;j<jlen;j+=1) {
            CSL.Output.Queue.purgeEmptyBlobs(this.output.queue[j]);
        }
        for (var j=0,jlen=this.output.queue.length;j<jlen;j+=1) {
            this.output.adjust.upward(this.output.queue[j]);
            this.output.adjust.leftward(this.output.queue[j]);
            this.output.adjust.downward(this.output.queue[j],true);
            this.output.adjust.fix(this.output.queue[j]);
        }
        var res = this.output.string(this, this.output.queue)[0];
        if (!res && this.opt.update_mode === CSL.NUMERIC) {
            var err = (ret.length + 1) + ". [CSL STYLE ERROR: reference with no printed form.]"
            res = CSL.Output.Formats[this.opt.mode]["@bibliography/entry"](this, err) 
        }
        if (res) {
            ret.push(res);
        }
    }
    var done = false;
    if (bibsection && bibsection.page_start && bibsection.page_length) {
        var last_expected_id = input.slice(-1)[0];
        var last_seen_id = processed_item_ids.slice(-1)[0];
        if (!last_expected_id || !last_seen_id || last_expected_id == last_seen_id) {
            done = true;
        }
    }
    this.tmp.disambig_override = false;
    return [processed_item_ids, ret, done];
};
module.exports = CSL;
CSL.Engine.prototype.setCitationId = function (citation, force) {
    var ret, id, direction;
    ret = false;
    if (!citation.citationID || force) {
        id = Math.floor(Math.random() * 100000000000000);
        while (true) {
            direction = 0;
            if (!this.registry.citationreg.citationById[id]) {
                citation.citationID = "a" + id.toString(32);
                break;
            } else if (!direction && id < 50000000000000) {
                direction = 1;
            } else {
                direction = -1;
            }
            if (direction === 1) {
                id += 1;
            } else {
                id += -1;
            }
        }
        ret = "" + id;
    }
    this.registry.citationreg.citationById[citation.citationID] = citation;
    return ret;
};
module.exports = CSL;
CSL.Engine.prototype.rebuildProcessorState = function (citations, mode, uncitedItemIDs) {
    if (!citations) {
        citations = [];
    }
    if (!mode) {
        mode = 'html';
    }
    var doneIDs = {};
    var itemIDs = [];
    for (var i=0,ilen=citations.length;i<ilen;i+=1) {
        for (var j=0,jlen=citations[i].citationItems.length;j<jlen;j+=1) {
            var itemID = "" + citations[i].citationItems[j].id;
            if (!doneIDs[itemID]) {
                itemIDs.push(itemID);
            }
            doneIDs[itemID] = true;
        }
    }
    this.updateItems(itemIDs);
    var pre = [];
    var post = [];
    var ret = [];
    var oldMode = this.opt.mode;
    this.setOutputFormat(mode);
    for (var i=0,ilen=citations.length;i<ilen;i+=1) {
        var res = this.processCitationCluster(citations[i],pre,post,CSL.ASSUME_ALL_ITEMS_REGISTERED);
        pre.push([citations[i].citationID,citations[i].properties.noteIndex]);
        for (var j=0,jlen=res[1].length;j<jlen;j+=1) {
            var index = res[1][j][0];
            ret[index] = [
                pre[index][0],
                pre[index][1],
                res[1][j][1]
            ];
        }
    }
    this.updateUncitedItems(uncitedItemIDs);
    this.setOutputFormat(oldMode);
    return ret;
}
CSL.Engine.prototype.restoreProcessorState = function (citations) {
    var i, ilen, j, jlen, item, Item, newitem, citationList, itemList, sortedItems;
    citationList = [];
    itemList = [];
    if (!citations) {
        citations = [];
    }
    var indexNumbers = [];
    var citationIds = {};
    for (i = 0, ilen = citations.length; i < ilen; i += 1) {
        if (citationIds[citations[i].citationID]) {
            this.setCitationId(citations[i], true);
        }
        citationIds[citations[i].citationID] = true;
        indexNumbers.push(citations[i].properties.index);
    }
    var oldCitations = citations.slice();
    oldCitations.sort(
        function (a,b) {
            if (a.properties.index < b.properties.index) {
                return -1;
            } else if (a.properties.index > b.properties.index) {
                return 1;
            } else {
                return 0;
            }
        }
    );
    for (i = 0, ilen = oldCitations.length; i < ilen; i += 1) {
        oldCitations[i].properties.index = i;
    }
    for (i = 0, ilen = oldCitations.length; i < ilen; i += 1) {
        sortedItems = [];
        for (j = 0, jlen = oldCitations[i].citationItems.length; j < jlen; j += 1) {
            item = oldCitations[i].citationItems[j];
            if ("undefined" === typeof item.sortkeys) {
                item.sortkeys = [];
            }
            Item = this.retrieveItem("" + item.id);
            newitem = [Item, item];
            sortedItems.push(newitem);
            oldCitations[i].citationItems[j].item = Item;
            itemList.push("" + item.id);
        }
        if (!oldCitations[i].properties.unsorted) {
            sortedItems.sort(this.citation.srt.compareCompositeKeys);
        }
        oldCitations[i].sortedItems = sortedItems;
        this.registry.citationreg.citationById[oldCitations[i].citationID] = oldCitations[i];
    }
    this.updateItems(itemList);
    for (i = 0, ilen = citations.length; i < ilen; i += 1) {
        citationList.push(["" + citations[i].citationID, citations[i].properties.noteIndex]);
    }
    var ret = [];
    if (citations && citations.length) {
        ret = this.processCitationCluster(citations[0], [], citationList.slice(1));
    } else {
        this.registry = new CSL.Registry(this);
        this.tmp = new CSL.Engine.Tmp();
        this.disambiguate = new CSL.Disambiguation(this);
    }
    return ret;
};
CSL.Engine.prototype.updateItems = function (idList, nosort, rerun_ambigs, implicitUpdate) {
    var debug = false;
    var oldArea = this.tmp.area;
    var oldRoot = this.tmp.root;
    var oldExtension = this.tmp.extension;
    this.tmp.area = "citation";
    this.tmp.root = "citation";
    this.tmp.extension = "";
    if (!implicitUpdate) {
        this.tmp.loadedItemIDs = {};
    }
    this.registry.init(idList);
	if (rerun_ambigs) {
		for (var ambig in this.registry.ambigcites) {
			this.registry.ambigsTouched[ambig] = true;
		}
	}
    this.registry.dodeletes(this.registry.myhash);
    this.registry.doinserts(this.registry.mylist);
    this.registry.dorefreshes();
    this.registry.rebuildlist();
    this.registry.setsortkeys();
    this.registry.setdisambigs();
    if (!nosort) {
        this.registry.sorttokens();
    }
    this.registry.renumber();
    this.tmp.extension = oldExtension;
    this.tmp.area = oldArea;
    this.tmp.root = oldRoot;
    return this.registry.getSortedIds();
};
CSL.Engine.prototype.updateUncitedItems = function (idList, nosort) {
    var debug = false;
    var oldArea = this.tmp.area;
    var oldRoot = this.tmp.root;
    var oldExtension = this.tmp.extension;
    this.tmp.area = "citation";
    this.tmp.root = "citation"
    this.tmp.extension = ""
    this.tmp.loadedItemIDs = {};
    if (!idList) {
        idList = [];
    }
    if ("object" == typeof idList) {
        if ("undefined" == typeof idList.length) {
            var idHash = idList;
            idList = [];
            for (var key in idHash) {
                idList.push(key);
            }
        } else if ("number" == typeof idList.length) {
            var idHash = {};
            for (var i=0,ilen=idList.length;i<ilen;i+=1) {
                idHash[idList[i]] = true;
            }
        }
    }
    this.registry.init(idList, true);
    this.registry.dopurge(idHash);
    this.registry.doinserts(this.registry.mylist);
    this.registry.dorefreshes();
    this.registry.rebuildlist();
    this.registry.setsortkeys();
    this.registry.setdisambigs();
    if (!nosort) {
        this.registry.sorttokens();
    }
    this.registry.renumber();
    this.tmp.extension = oldExtension;
    this.tmp.area = oldArea;
    this.tmp.root = oldRoot;
    return this.registry.getSortedIds();
};
module.exports = CSL;
CSL.localeResolve = function (langstr, defaultLocale) {
    var ret, langlst;
    if (!defaultLocale) {
        defaultLocale = "en-US";
    }
    if (!langstr) {
        langstr = defaultLocale;
    }
    ret = {};
    langlst = langstr.split(/[\-_]/);
    ret.base = CSL.LANG_BASES[langlst[0]];
    if ("undefined" === typeof ret.base) {
        return {base:defaultLocale, best:langstr, bare:langlst[0]};
    }
    if (langlst.length === 1) {
        ret.generic = true;
    }
    if (langlst.length === 1 || langlst[1] === "x") {
        ret.best = ret.base.replace("_", "-");
    } else {
        ret.best = langlst.slice(0, 2).join("-");
    }
    ret.base = ret.base.replace("_", "-");
    ret.bare = langlst[0];
    return ret;
};
CSL.Engine.prototype.localeConfigure = function (langspec, beShy) {
    var localexml;
    if (beShy && this.locale[langspec.best]) {
        return;
    }
    if (langspec.best === "en-US") {
        localexml = CSL.setupXml(this.sys.retrieveLocale("en-US"));
        this.localeSet(localexml, "en-US", langspec.best);
    } else if (langspec.best !== "en-US") {
        if (langspec.base !== langspec.best) {
            localexml = CSL.setupXml(this.sys.retrieveLocale(langspec.base));
            this.localeSet(localexml, langspec.base, langspec.best);
        }
        localexml = CSL.setupXml(this.sys.retrieveLocale(langspec.best));
        this.localeSet(localexml, langspec.best, langspec.best);        
    }
    this.localeSet(this.cslXml, "", langspec.best);
    this.localeSet(this.cslXml, langspec.bare, langspec.best);
    if (langspec.base !== langspec.best) {
        this.localeSet(this.cslXml, langspec.base, langspec.best);
    }
    this.localeSet(this.cslXml, langspec.best, langspec.best);
    if ("undefined" === typeof this.locale[langspec.best].terms["page-range-delimiter"]) {
        if (["fr", "pt"].indexOf(langspec.best.slice(0, 2).toLowerCase()) > -1) {
            this.locale[langspec.best].terms["page-range-delimiter"] = "-";
        } else {
            this.locale[langspec.best].terms["page-range-delimiter"] = "\u2013";
        }
    }
    if ("undefined" === typeof this.locale[langspec.best].terms["year-range-delimiter"]) {
        this.locale[langspec.best].terms["year-range-delimiter"] = "\u2013";
    }
    if ("undefined" === typeof this.locale[langspec.best].terms["citation-range-delimiter"]) {
        this.locale[langspec.best].terms["citation-range-delimiter"] = "\u2013";
    }
    if (this.opt.development_extensions.normalize_lang_keys_to_lowercase) {
        var localeLists = ["default-locale","locale-sort","locale-translit","locale-translat"];
        for (var i=0,ilen=localeLists.length;i<ilen;i+=1) {
            for (var j=0,jlen=this.opt[localeLists[i]].length;j<jlen;j+=1) {
                this.opt[localeLists[i]][j] = this.opt[localeLists[i]][j].toLowerCase();
            }
        }
        this.opt.lang = this.opt.lang.toLowerCase();
    }
};
CSL.Engine.prototype.localeSet = function (myxml, lang_in, lang_out) {
    var blob, locale, nodes, attributes, pos, ppos, term, form, termname, styleopts, attr, date, attrname, len, genderform, target, i, ilen;
    lang_in = lang_in.replace("_", "-");
    lang_out = lang_out.replace("_", "-");
    if (this.opt.development_extensions.normalize_lang_keys_to_lowercase) {
        lang_in = lang_in.toLowerCase();
        lang_out = lang_out.toLowerCase();
    }
    if (!this.locale[lang_out]) {
        this.locale[lang_out] = {};
        this.locale[lang_out].terms = {};
        this.locale[lang_out].opts = {};
        this.locale[lang_out].opts["skip-words"] = CSL.SKIP_WORDS;
        if (!this.locale[lang_out].opts["leading-noise-words"]) {
            this.locale[lang_out].opts["leading-noise-words"] = [];
        }
        this.locale[lang_out].dates = {};
        this.locale[lang_out].ord = {'1.0.1':false,keys:{}};
        this.locale[lang_out]["noun-genders"] = {};
    }
    locale = myxml.makeXml();
    if (myxml.nodeNameIs(myxml.dataObj, 'locale')) {
        locale = myxml.dataObj;
    } else {
        nodes = myxml.getNodesByName(myxml.dataObj, "locale");
        for (pos = 0, len = myxml.numberofnodes(nodes); pos < len; pos += 1) {
            blob = nodes[pos];
            if (myxml.getAttributeValue(blob, 'lang', 'xml') === lang_in) {
                locale = blob;
                break;
            }
        }
    }
    nodes = myxml.getNodesByName(locale, 'type');
    for (i = 0, ilen = myxml.numberofnodes(nodes); i < ilen; i += 1) {
        var typenode = nodes[i];
        var type = myxml.getAttributeValue(typenode, 'name');
        var gender = myxml.getAttributeValue(typenode, 'gender');
        this.opt.gender[type] = gender;
    }
    var hasCslOrdinals101 = myxml.getNodesByName(locale, 'term', 'ordinal').length;
    if (hasCslOrdinals101) {
        for (var key in this.locale[lang_out].ord.keys) {
            delete this.locale[lang_out].terms[key];
        }
        this.locale[lang_out].ord = {"1.0.1":false,keys:{}};
    }
    nodes = myxml.getNodesByName(locale, 'term');
    var ordinals101 = {"last-digit":{},"last-two-digits":{},"whole-number":{}};
    var ordinals101_toggle = false;
    var genderized_terms = {};
    for (pos = 0, len = myxml.numberofnodes(nodes); pos < len; pos += 1) {
        term = nodes[pos];
        termname = myxml.getAttributeValue(term, 'name');
        if (termname === "sub verbo") {
            termname = "sub-verbo";
        }
        if (termname.slice(0,7) === "ordinal") {
            var termstring = myxml.getNodeValue(term);
            if (termname === "ordinal") {
                ordinals101_toggle = true;
            } else {
                var match = myxml.getAttributeValue(term, 'match');
                var termstub = termname.slice(8);
                var genderform = myxml.getAttributeValue(term, 'gender-form');
                if (!genderform) {
                    genderform = "neuter";
                }
                if (!match) {
                    match = "last-two-digits";
                    if (termstub.slice(0,1) === "0") {
                        match = "last-digit";
                    }
                }
                if (termstub.slice(0,1) === "0") {
                    termstub = termstub.slice(1);
                }
                if (!ordinals101[match][termstub]) {
                    ordinals101[match][termstub] = {};
                }
                ordinals101[match][termstub][genderform] = termname;
            }
            this.locale[lang_out].ord.keys[termname] = true;
        }
        if ("undefined" === typeof this.locale[lang_out].terms[termname]) {
            this.locale[lang_out].terms[termname] = {};
        }
        form = "long";
        genderform = false;
        if (myxml.getAttributeValue(term, 'form')) {
            form = myxml.getAttributeValue(term, 'form');
        }
        if (myxml.getAttributeValue(term, 'gender-form')) {
            genderform = myxml.getAttributeValue(term, 'gender-form');
        }
        if (myxml.getAttributeValue(term, 'gender')) {
            this.locale[lang_out]["noun-genders"][termname] = myxml.getAttributeValue(term, 'gender');
        }
        if (genderform) {
            this.locale[lang_out].terms[termname][genderform] = {};
            this.locale[lang_out].terms[termname][genderform][form] = [];
            target = this.locale[lang_out].terms[termname][genderform];
            genderized_terms[termname] = true;
        } else {
            this.locale[lang_out].terms[termname][form] = [];
            target = this.locale[lang_out].terms[termname];
        }
        if (myxml.numberofnodes(myxml.getNodesByName(term, 'multiple'))) {
            target[form][0] = myxml.getNodeValue(term, 'single');
            if (target[form][0].indexOf("%s") > -1) {
                this.opt.hasPlaceholderTerm = true;
            }
            target[form][1] = myxml.getNodeValue(term, 'multiple');
            if (target[form][1].indexOf("%s") > -1) {
                this.opt.hasPlaceholderTerm = true;
            }
        } else {
            target[form] = myxml.getNodeValue(term);
            if (target[form].indexOf("%s") > -1) {
                this.opt.hasPlaceholderTerm = true;
            }
        }
    }
    if (ordinals101_toggle) {
        for (var ikey in genderized_terms) {
            var gender_segments = {};
            var form_segments = 0;
            for (var jkey in this.locale[lang_out].terms[ikey]) {
                if (["masculine","feminine"].indexOf(jkey) > -1) {
                    gender_segments[jkey] = this.locale[lang_out].terms[ikey][jkey];
                } else {
                    form_segments += 1;
                }
            }
            if (!form_segments) {
                if (gender_segments.feminine) {
                    for (var jkey in gender_segments.feminine) {
                        this.locale[lang_out].terms[ikey][jkey] = gender_segments.feminine[jkey];
                    }
                } else if (gender_segments.masculine) {
                    for (var jkey in gender_segments.masculine) {
                        this.locale[lang_out].terms[ikey][jkey] = gender_segments.masculine[jkey];
                    }
                }
            }
        }
        this.locale[lang_out].ord['1.0.1'] = ordinals101;
    }
    for (termname in this.locale[lang_out].terms) {
        for (i = 0, ilen = 2; i < ilen; i += 1) {
            genderform = CSL.GENDERS[i];
            if (this.locale[lang_out].terms[termname][genderform]) {
                for (form in this.locale[lang_out].terms[termname]) {
                    if (!this.locale[lang_out].terms[termname][genderform][form]) {
                        this.locale[lang_out].terms[termname][genderform][form] = this.locale[lang_out].terms[termname][form];
                    }
                }
            }
        }
    }
    nodes = myxml.getNodesByName(locale, 'style-options');
    for (pos = 0, len = myxml.numberofnodes(nodes); pos < len; pos += 1) {
        if (true) {
            styleopts = nodes[pos];
            attributes = myxml.attributes(styleopts);
            for (attrname in attributes) {
                if (attributes.hasOwnProperty(attrname)) {
                    if (attrname === "@punctuation-in-quote" || attrname === "@limit-day-ordinals-to-day-1") {
                        if (attributes[attrname] === "true") {
                            this.locale[lang_out].opts[attrname.slice(1)] = true;
                        } else {
                            this.locale[lang_out].opts[attrname.slice(1)] = false;
                        }
                    } else if (attrname === "@jurisdiction-preference") {
                        var jurisdiction_preference = attributes[attrname].split(/\s*,\s*/);
                        this.locale[lang_out].opts[attrname.slice(1)] = jurisdiction_preference;
                    } else if (attrname === "@skip-words") {
                        var skip_words = attributes[attrname].split(/\s*,\s*/);
                        this.locale[lang_out].opts[attrname.slice(1)] = skip_words;
                    } else if (attrname === "@leading-noise-words") {
                        var val = attributes[attrname].split(/\s*,\s*/);
                        this.locale[lang_out].opts["leading-noise-words"] = val;
                    } else if (attrname === "@name-as-sort-order") {
                        this.locale[lang_out].opts["name-as-sort-order"] = {};
                        var lst = attributes[attrname].split(/\s+/);
                        for (var i=0,ilen=lst.length;i<ilen;i+=1) {
                            this.locale[lang_out].opts["name-as-sort-order"][lst[i]] = true;
                        }
                    } else if (attrname === "@name-as-reverse-order") {
                        this.locale[lang_out].opts["name-as-reverse-order"] = {};
                        var lst = attributes[attrname].split(/\s+/);
                        for (var i=0,ilen=lst.length;i<ilen;i+=1) {
                            this.locale[lang_out].opts["name-as-reverse-order"][lst[i]] = true;
                        }
                    } else if (attrname === "@name-never-short") {
                        this.locale[lang_out].opts["name-never-short"] = {};
                        var lst = attributes[attrname].split(/\s+/);
                        for (var i=0,ilen=lst.length;i<ilen;i+=1) {
                            this.locale[lang_out].opts["name-never-short"][lst[i]] = true;
                        }
                    }
                }
            }
        }
    }
    nodes = myxml.getNodesByName(locale, 'date');
    for (pos = 0, len = myxml.numberofnodes(nodes); pos < len; pos += 1) {
        if (true) {
            var date = nodes[pos];
            this.locale[lang_out].dates[myxml.getAttributeValue(date, "form")] = date;
        }
    }
};
module.exports = CSL;
CSL.getLocaleNames = function (myxml, preferredLocale) {
    var stylexml = CSL.setupXml(myxml);
    function extendLocaleList(localeList, locale) {
        var forms = ["base", "best"];
        if (locale) {
            normalizedLocale = CSL.localeResolve(locale);
            for (var i=0,ilen=forms.length;i<ilen;i++) {
                if (normalizedLocale[forms[i]] && localeList.indexOf(normalizedLocale[forms[i]]) === -1) {
                    localeList.push(normalizedLocale[forms[i]]);
                }
            }
        }
    }
    function sniffLocaleOnOneNodeName(nodeName) {
        var nodes = stylexml.getNodesByName(stylexml.dataObj, nodeName);
        for (var i=0,ilen=nodes.length;i<ilen;i++) {
            var nodeLocales = stylexml.getAttributeValue(nodes[i], "locale");
            if (nodeLocales) {
                nodeLocales = nodeLocales.split(/ +/);
                for (var j=0,jlen=nodeLocales.length;j<jlen;j++) {
                    this.extendLocaleList(localeIDs, nodeLocales[j]);
                }
            }
        }
    }
    var localeIDs = ["en-US"];
    extendLocaleList(localeIDs, preferredLocale);
    var styleNode = stylexml.getNodesByName(stylexml.dataObj, "style")[0];
    var defaultLocale = stylexml.getAttributeValue(styleNode, "default-locale");
    extendLocaleList(localeIDs, defaultLocale);
    var nodeNames = ["layout", "if", "else-if", "condition"];
    for (var i=0,ilen=nodeNames.length;i<ilen;i++) {
        sniffLocaleOnOneNodeName(stylexml, localeIDs, nodeNames[i]);
    }
    return localeIDs;
};
module.exports = CSL;
CSL.Node = {};
CSL.Node.bibliography = {
    build: function (state, target) {
        if (this.tokentype === CSL.START) {
            state.build.area = "bibliography";
            state.build.root = "bibliography";
            state.build.extension = "";
            var func = function(state, Item) {
                state.tmp.area = "bibliography";
                state.tmp.root = "bibliography";
                state.tmp.extension = "";
            }
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.choose = {
    build: function (state, target) {
        var func;
        if (this.tokentype === CSL.START) {
            func = function (state, Item) {
                state.tmp.jump.push(undefined, CSL.LITERAL);
            };
        }
        if (this.tokentype === CSL.END) {
            func = function (state, Item) {
                state.tmp.jump.pop();
            };
        }
        this.execs.push(func);
        target.push(this);
    },
    configure: function (state, pos) {
        if (this.tokentype === CSL.END) {
            state.configure.fail.push((pos));
            state.configure.succeed.push((pos));
        } else {
            state.configure.fail.pop();
            state.configure.succeed.pop();
        }
    }
};
module.exports = CSL;
CSL.Node.citation = {
    build: function (state, target) {
        if (this.tokentype === CSL.START) {
            state.build.area = "citation";
            state.build.root = "citation";
            state.build.extension = "";
            var func = function(state, Item) {
                state.tmp.area = "citation";
                state.tmp.root = "citation";
                state.tmp.extension = "";
            }
            this.execs.push(func);
        }
        if (this.tokentype === CSL.END) {
            state.opt.grouped_sort = state.opt.xclass === "in-text" 
                && (state.citation.opt.collapse 
                    && state.citation.opt.collapse.length)
                || (state.citation.opt.cite_group_delimiter
                    && state.citation.opt.cite_group_delimiter.length)
                && state.opt.update_mode !== CSL.POSITION
                && state.opt.update_mode !== CSL.NUMERIC;
            if (state.opt.grouped_sort 
                && state.citation_sort.opt.sort_directions.length) {
                var firstkey = state.citation_sort.opt.sort_directions[0].slice();
                state.citation_sort.opt.sort_directions = [firstkey].concat(state.citation_sort.opt.sort_directions);
            }
            state.citation.srt = new CSL.Registry.Comparifier(state, "citation_sort");
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node["#comment"] = {
       build: function (state, target) {
       }
};
module.exports = CSL;
CSL.Node.date = {
    build: function (state, target) {
        var func, date_obj, tok, len, pos, part, dpx, parts, mypos, start, end;
        if (this.tokentype === CSL.START || this.tokentype === CSL.SINGLETON) {
            state.build.date_parts = [];
            state.build.date_variables = this.variables;
            if (!state.build.extension) {
                CSL.Util.substituteStart.call(this, state, target);
            }
            if (state.build.extension) {
                func = CSL.dateMacroAsSortKey;
            } else {
                func = function (state, Item, item) {
                    var key, dp;
                    state.tmp.element_rendered_ok = false;
                    state.tmp.donesies = [];
                    state.tmp.dateparts = [];
                    dp = [];
                    if (this.variables.length
                        && !(state.tmp.just_looking
                             && this.variables[0] === "accessed")) {
                        date_obj = Item[this.variables[0]];
                        if ("undefined" === typeof date_obj) {
                            date_obj = {"date-parts": [[0]] };
                            if (state.opt.development_extensions.locator_date_and_revision) {
                                if (item && this.variables[0] === "locator-date" && item["locator-date"]) {
                                    date_obj = item["locator-date"];
                                }
                            }
                        }
                        state.tmp.date_object = date_obj;
                        len = this.dateparts.length;
                        for (pos = 0; pos < len; pos += 1) {
                            part = this.dateparts[pos];
                            if ("undefined" !== typeof state.tmp.date_object[(part +  "_end")]) {
                                dp.push(part);
                            } else if (part === "month" && "undefined" !== typeof state.tmp.date_object.season_end) {
                                dp.push(part);
                            }
                        }
                        dpx = [];
                        parts = ["year", "month", "day"];
                        len = parts.length;
                        for (pos = 0; pos < len; pos += 1) {
                            if (dp.indexOf(parts[pos]) > -1) {
                                dpx.push(parts[pos]);
                            }
                        }
                        dp = dpx.slice();
                        mypos = 2;
                        len = dp.length;
                        for (pos = 0; pos < len; pos += 1) {
                            part = dp[pos];
                            start = state.tmp.date_object[part];
                            end = state.tmp.date_object[(part + "_end")];
                            if (start !== end) {
                                mypos = pos;
                                break;
                            }
                        }
                        state.tmp.date_collapse_at = dp.slice(mypos);
                    } else {
                        state.tmp.date_object = false;
                    }
                };
            }
            this.execs.push(func);
            func = function (state, Item) {
                if (!Item[this.variables[0]]) return;
                state.parallel.StartVariable(this.variables[0]);
                state.output.startTag("date", this);
                if (this.variables[0] === "issued"
                    && Item.type === "legal_case"
                    && !state.tmp.extension
                    && "" + Item["collection-number"] === "" + state.tmp.date_object.year
                    && this.dateparts.length === 1
                    && this.dateparts[0] === "year") {
                    for (var key in state.tmp.date_object) {
                        if (state.tmp.date_object.hasOwnProperty(key)) {
                            if (key.slice(0, 4) === "year") {
                                state.tmp.issued_date = {};
                                var lst = state.output.current.mystack.slice(-2)[0].blobs;
                                state.tmp.issued_date.list = lst;
                                state.tmp.issued_date.pos = lst.length - 1;
                            }
                        }
                    }
                }
            };
            this.execs.push(func);
        }
        if (!state.build.extension && (this.tokentype === CSL.END || this.tokentype === CSL.SINGLETON)) {
            func = function (state, Item) {
                if (!Item[this.variables[0]]) return;
                state.output.endTag();
                state.parallel.CloseVariable(this.variables[0]);
            };
            this.execs.push(func);
        }
        target.push(this);
        if (this.tokentype === CSL.END || this.tokentype === CSL.SINGLETON) {
            if (!state.build.extension) {
                CSL.Util.substituteEnd.call(this, state, target);
            }
        }
    }
};
module.exports = CSL;
CSL.Node["date-part"] = {
    build: function (state, target) {
        var func, pos, len, decor, first_date, value, value_end, real, have_collapsed, invoked, precondition, known_year, bc, ad, bc_end, ad_end, ready, curr, dcurr, number, num, formatter, item, i, ilen;
        if (!this.strings.form) {
            this.strings.form = "long";
        }
        state.build.date_parts.push(this.strings.name);
        var date_variable = state.build.date_variables[0];
        func = function (state, Item) {
            if (!state.tmp.date_object) {
                return;
            }
            first_date = true;
            value = "";
            value_end = "";
            state.tmp.donesies.push(this.strings.name);
            if (state.tmp.date_object.literal && "year" === this.strings.name) {
                state.parallel.AppendToVariable(state.tmp.date_object.literal);
                state.output.append(state.tmp.date_object.literal, this);
            }
            if (state.tmp.date_object) {
                value = state.tmp.date_object[this.strings.name];
                value_end = state.tmp.date_object[(this.strings.name + "_end")];
            }
            if ("year" === this.strings.name && value === 0 && !state.tmp.suppress_decorations) {
                value = false;
            }
            real = !state.tmp.suppress_decorations;
            have_collapsed = state.tmp.have_collapsed;
            invoked = state[state.tmp.area].opt.collapse === "year-suffix" || state[state.tmp.area].opt.collapse === "year-suffix-ranged";
            precondition = state.opt["disambiguate-add-year-suffix"];
            if (real && precondition && invoked) {
                state.tmp.years_used.push(value);
                known_year = state.tmp.last_years_used.length >= state.tmp.years_used.length;
                if (known_year && have_collapsed) {
                    if (state.tmp.last_years_used[(state.tmp.years_used.length - 1)] === value) {
                        value = false;
                    }
                }
            }
            if ("undefined" !== typeof value) {
                bc = false;
                ad = false;
                bc_end = false;
                ad_end = false;
                if ("year" === this.strings.name) {
                    if (parseInt(value, 10) < 500 && parseInt(value, 10) > 0) {
                        ad = state.getTerm("ad");
                    }
                    if (parseInt(value, 10) < 0) {
                        bc = state.getTerm("bc");
                        value = (parseInt(value, 10) * -1);
                    }
                    if (value_end) {
                        if (parseInt(value_end, 10) < 500 && parseInt(value_end, 10) > 0) {
                            ad_end = state.getTerm("ad");
                        }
                        if (parseInt(value_end, 10) < 0) {
                            bc_end = state.getTerm("bc");
                            value_end = (parseInt(value_end, 10) * -1);
                        }
                    }
                }
                state.parallel.AppendToVariable(value);
                var monthnameid = ""+state.tmp.date_object.month;
                while (monthnameid.length < 2) {
                    monthnameid = "0"+monthnameid;
                }
                monthnameid = "month-"+monthnameid;
                var gender = state.locale[state.opt.lang]["noun-genders"][monthnameid];
                if (this.strings.form) {
                    var myform = this.strings.form;
                    if (this.strings.name === "day") {
                        if (myform === "ordinal"
                            && state.locale[state.opt.lang].opts["limit-day-ordinals-to-day-1"]
                            && ("" + value) !== "1") {
                            myform = "numeric";
                        }
                    }
                    value = CSL.Util.Dates[this.strings.name][myform](state, value, gender, this.default_locale);
                    if ("month" === this.strings.name) {
                        if (state.tmp.strip_periods) {
                            value = value.replace(/\./g, "");
                        } else {
                            for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
                                if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                                    value = value.replace(/\./g, "");
                                    break;
                                }
                            }
                        }
                    }
                    if (value_end) {
                        value_end = CSL.Util.Dates[this.strings.name][myform](state, value_end, gender, ("accessed" === date_variable), "_end");
                        if (state.tmp.strip_periods) {
                            value_end = value_end.replace(/\./g, "");
                        } else {
                            for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
                                if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                                    value_end = value_end.replace(/\./g, "");
                                    break;
                                }
                            }
                        }
                    }
                }
                state.output.openLevel("empty");
                if (state.tmp.date_collapse_at.length) {
                    ready = true;
                    len = state.tmp.date_collapse_at.length;
                    for (pos = 0; pos < len; pos += 1) {
                        item = state.tmp.date_collapse_at[pos];
                        if (state.tmp.donesies.indexOf(item) === -1) {
                            ready = false;
                            break;
                        }
                    }
                    if (ready) {
                        if ("" + value_end !== "0") {
                            if (state.dateput.queue.length === 0) {
                                first_date = true;
                            }
                            if (state.opt["year-range-format"]
                                && state.opt["year-range-format"] !== "expanded"
                                && !state.tmp.date_object.day
                                && !state.tmp.date_object.month
                                && !state.tmp.date_object.season
                                && this.strings.name === "year"
                                && value && value_end) {
                                value_end = state.fun.year_mangler(value + "-" + value_end, true);
                                var range_delimiter = state.getTerm("year-range-delimiter");
                                value_end = value_end.slice(value_end.indexOf(range_delimiter) + 1);
                            }
                            state.dateput.append(value_end, this);
                            if (first_date) {
                                state.dateput.current.value()[0].strings.prefix = "";
                            }
                        }
                        state.output.append(value, this);
                        curr = state.output.current.value();
                        curr.blobs[(curr.blobs.length - 1)].strings.suffix = "";
                        state.output.append(state.getTerm("year-range-delimiter"), "empty");
                        dcurr = state.dateput.current.value();
                        curr.blobs = curr.blobs.concat(dcurr);
                        state.dateput.string(state, state.dateput.queue);
                        state.tmp.date_collapse_at = [];
                    } else {
                        state.output.append(value, this);
                        if (state.tmp.date_collapse_at.indexOf(this.strings.name) > -1) {
                            if ("" + value_end !== "0") {
                                if (state.dateput.queue.length === 0) {
                                    first_date = true;
                                }
                                state.dateput.openLevel("empty");
                                state.dateput.append(value_end, this);
                                if (first_date) {
                                    state.dateput.current.value().blobs[0].strings.prefix = "";
                                }
                                if (bc) {
                                    state.dateput.append(bc);
                                }
                                if (ad) {
                                    state.dateput.append(ad);
                                }
                                state.dateput.closeLevel();
                            }
                        }
                    }
                } else {
                    state.output.append(value, this);
                }
                if (bc) {
                    state.output.append(bc);
                }
                if (ad) {
                    state.output.append(ad);
                }
                state.output.closeLevel();
            } else if ("month" === this.strings.name) {
                if (state.tmp.date_object.season) {
                    value = "" + state.tmp.date_object.season;
                    if (value && value.match(/^[1-4]$/)) {
                        state.tmp.group_context.tip.variable_success = true;
                        state.output.append(state.getTerm(("season-0" + value)), this);
                    } else if (value) {
                        state.output.append(value, this);
                    }
                }
            }
            state.tmp.value = [];
            if (Item[date_variable] && (value || state.tmp.have_collapsed) && !state.opt.has_year_suffix && "year" === this.strings.name && !state.tmp.just_looking) {
                if (state.registry.registry[Item.id] && state.registry.registry[Item.id].disambig.year_suffix !== false && !state.tmp.has_done_year_suffix) {
                    state.tmp.has_done_year_suffix = true;
                    num = parseInt(state.registry.registry[Item.id].disambig.year_suffix, 10);
                    number = new CSL.NumericBlob(false, num, this, Item.id);
                    this.successor_prefix = state[state.build.area].opt.layout_delimiter;
                    this.splice_prefix = state[state.build.area].opt.layout_delimiter;
                    formatter = new CSL.Util.Suffixator(CSL.SUFFIX_CHARS);
                    number.setFormatter(formatter);
                    if (state[state.tmp.area].opt.collapse === "year-suffix-ranged") {
                        number.range_prefix = state.getTerm("citation-range-delimiter");
                    }
                    if (state[state.tmp.area].opt.cite_group_delimiter) {
                        number.successor_prefix = state[state.tmp.area].opt.cite_group_delimiter;
                    } else if (state[state.tmp.area].opt["year-suffix-delimiter"]) {
                        number.successor_prefix = state[state.tmp.area].opt["year-suffix-delimiter"];
                    } else {
                        number.successor_prefix = state[state.tmp.area].opt.layout_delimiter;
                    }
                    number.UGLY_DELIMITER_SUPPRESS_HACK = true;
                    state.output.append(number, "literal");
                }
            }
        };
        this.execs.push(func);
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node["else-if"] = {
    build: function (state, target) {
        CSL.Conditions.TopNode.call(this, state, target);
        target.push(this);
    },
    configure: function (state, pos) {
        CSL.Conditions.Configure.call(this, state, pos);
    }
};
module.exports = CSL;
CSL.Node["else"] = {
    build: function (state, target) {
        target.push(this);
    },
    configure: function (state, pos) {
        if (this.tokentype === CSL.START) {
            state.configure.fail[(state.configure.fail.length - 1)] = pos;
        }
    }
};
module.exports = CSL;
CSL.Node["et-al"] = {
    build: function (state, target) {
        if (state.build.area === "citation" || state.build.area === "bibliography") {
            var func = function (state, Item, item) {
                state.tmp.etal_node = this;
                if ("string" === typeof this.strings.term) {
                    state.tmp.etal_term = this.strings.term;
                }
            }
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.group = {
    build: function (state, target, realGroup) {
        var func, execs, done_vars;
        this.realGroup = realGroup;
        if (this.tokentype === CSL.START) {
            CSL.Util.substituteStart.call(this, state, target);
            if (state.build.substitute_level.value()) {
                state.build.substitute_level.replace((state.build.substitute_level.value() + 1));
            }
            if (!this.juris) {
                target.push(this);
            }
            func = function (state, Item) {
                state.output.startTag("group", this);
                if (this.strings.label_form_override) {
                    if (!state.tmp.group_context.tip.label_form) {
                        state.tmp.group_context.tip.label_form = this.strings.label_form_override;
                    }
                }
                if (this.strings.label_capitalize_if_first_override) {
                    if (!state.tmp.group_context.tip.label_capitalize_if_first) {
                        state.tmp.group_context.tip.label_capitalize_if_first = this.strings.label_capitalize_if_first_override;
                    }
                }
                if (this.realGroup) {
                    var condition = false;
                    var force_suppress = false;
                    if (state.tmp.group_context.mystack.length) {
                        state.output.current.value().parent = state.tmp.group_context.tip.output_tip;
                    }
                    var label_form = state.tmp.group_context.tip.label_form;
                    if (!label_form) {
                        label_form = this.strings.label_form_override;
                    }
                    var label_capitalize_if_first = state.tmp.group_context.tip.label_capitalize_if_first;
                    if (!label_capitalize_if_first) {
                        label_capitalize_if_first = this.strings.label_capitalize_if_first;
                    }
                    if (state.tmp.group_context.tip.condition) {
                        condition = state.tmp.group_context.tip.condition;
                        force_suppress = state.tmp.group_context.tip.force_suppress;
                    } else if (this.strings.reject) {
                        condition = {
                            test: this.strings.reject,
                            not: true
                        }
                        force_suppress = true;
                        done_vars = [];
                    } else if (this.strings.require) {
                        condition = {
                            test: this.strings.require,
                            not: false
                        }
                        done_vars = [];
                    }
                    state.tmp.group_context.push({
                        old_term_predecessor: state.tmp.term_predecessor,
                        term_intended: false,
                        variable_attempt: false,
                        variable_success: false,
                        variable_success_parent: state.tmp.group_context.tip.variable_success,
                        output_tip: state.output.current.tip,
                        label_form: label_form,
                        label_capitalize_if_first: label_capitalize_if_first,
                        parallel_conditions: this.strings.set_parallel_condition,
                        condition: condition,
                        force_suppress: force_suppress,
                        done_vars: state.tmp.group_context.tip.done_vars.slice()
                    });
                }
            };
            execs = [];
            execs.push(func);
            this.execs = execs.concat(this.execs);
            if (this.strings["has-publisher-and-publisher-place"]) {
                state.build["publisher-special"] = true;
                func = function (state, Item) {
                    if (this.strings["subgroup-delimiter"]
                        && Item.publisher && Item["publisher-place"]) {
                        var publisher_lst = Item.publisher.split(/;\s*/);
                        var publisher_place_lst = Item["publisher-place"].split(/;\s*/);
                        if (publisher_lst.length > 1
                            && publisher_lst.length === publisher_place_lst.length) {
                            state.publisherOutput = new CSL.PublisherOutput(state, this);
                            state.publisherOutput["publisher-list"] = publisher_lst;
                            state.publisherOutput["publisher-place-list"] = publisher_place_lst;
                        }
                    }
                };
                this.execs.push(func);
            }
            if (this.juris) {
                for (var x=0,xlen=target.length;x<xlen;x++) {
                    var token = target[x];
                }
                var choose_start = new CSL.Token("choose", CSL.START);
                CSL.Node.choose.build.call(choose_start, state, target);
                var if_start = new CSL.Token("if", CSL.START);
                func = function (macroName) {
                    return function (Item) {
                        if (!state.sys.retrieveStyleModule || !CSL.MODULE_MACROS[macroName] || !Item.jurisdiction) return false;
                        var jurisdictionList = state.getJurisdictionList(Item.jurisdiction);
                        if (!state.opt.jurisdictions_seen[jurisdictionList[0]]) {
                            var res = state.retrieveAllStyleModules(jurisdictionList);
                            for (var jurisdiction in res) {
                                var macroCount = 0;
                                state.juris[jurisdiction] = {};
                                var myXml = CSL.setupXml(res[jurisdiction]);
                                var myNodes = myXml.getNodesByName(myXml.dataObj, "law-module");
                                for (var i=0,ilen=myNodes.length;i<ilen;i++) {
                                    var myTypes = myXml.getAttributeValue(myNodes[i],"types");
                                    if (myTypes) {
                                        state.juris[jurisdiction].types = {};
                                        myTypes =  myTypes.split(/\s+/);
                                        for (var j=0,jlen=myTypes.length;j<jlen;j++) {
                                            state.juris[jurisdiction].types[myTypes[j]] = true;
                                        }
                                    }
                                }
                                if (!state.juris[jurisdiction].types) {
                                    state.juris[jurisdiction].types = CSL.MODULE_TYPES;
                                }
                                var myNodes = myXml.getNodesByName(myXml.dataObj, "macro");
                                for (var i=0,ilen=myNodes.length;i<ilen;i++) {
                                    var myName = myXml.getAttributeValue(myNodes[i], "name");
                                    if (!CSL.MODULE_MACROS[myName]) {
                                        CSL.debug("CSL: skipping non-modular macro name \"" + myName + "\" in module context");
                                        continue;
                                    };
                                    macroCount++;
                                    state.juris[jurisdiction][myName] = [];
                                    state.buildTokenLists(myNodes[i], state.juris[jurisdiction][myName]);
                                    state.configureTokenList(state.juris[jurisdiction][myName]);
                                }
                            }
                        }
                        for (var i=0,ilen=jurisdictionList.length;i<ilen;i++) {
                            var jurisdiction = jurisdictionList[i];
                            if(state.juris[jurisdiction] && state.juris[jurisdiction].types[Item.type]) {
                                Item["best-jurisdiction"] = jurisdiction;
                                return true;
                            }
                        }
                        return false;
                    };
                }(this.juris);
                if_start.tests.push(func);
                if_start.test = state.fun.match.any(if_start, state, if_start.tests);
                target.push(if_start);
                var text_node = new CSL.Token("text", CSL.SINGLETON);
                func = function (state, Item, item) {
                    var next = 0;
                    if (state.juris[Item["best-jurisdiction"]][this.juris]) {
                        while (next < state.juris[Item["best-jurisdiction"]][this.juris].length) {
                            next = CSL.tokenExec.call(state, state.juris[Item["best-jurisdiction"]][this.juris][next], Item, item);
                        }
                    }
                }
                text_node.juris = this.juris;
                text_node.execs.push(func);
                target.push(text_node);
                var if_end = new CSL.Token("if", CSL.END);
                CSL.Node["if"].build.call(if_end, state, target);
                var else_start = new CSL.Token("else", CSL.START);
                CSL.Node["else"].build.call(else_start, state, target);
            }
        }
        if (this.tokentype === CSL.END) {
            if (state.build["publisher-special"]) {
                state.build["publisher-special"] = false;
                if ("string" === typeof state[state.build.root].opt["name-delimiter"]) {
                    func = function (state, Item) {
                        if (state.publisherOutput) {
                            state.publisherOutput.render();
                            state.publisherOutput = false;
                        }
                    };
                    this.execs.push(func);
                }
            }
            func = function (state, Item) {
                state.output.endTag();
                if (this.realGroup) {
                    var flags = state.tmp.group_context.pop();
                    if (state.tmp.group_context.tip.condition) {
                        state.tmp.group_context.tip.force_suppress = flags.force_suppress;
                    }
                    if (!flags.force_suppress && (flags.variable_success || (flags.term_intended && !flags.variable_attempt))) {
                        if (!this.isJurisLocatorLabel) {
                            state.tmp.group_context.tip.variable_success = true;
                        }
                        var blobs = state.output.current.value().blobs;
                        var pos = state.output.current.value().blobs.length - 1;
                        if (!state.tmp.just_looking && "undefined" !== typeof flags.parallel_conditions) {
                            var parallel_condition_object = {
                                blobs: blobs,
                                conditions: flags.parallel_conditions,
                                id: Item.id,
                                pos: pos
                            };
                            state.parallel.parallel_conditional_blobs_list.push(parallel_condition_object);
                        }
                    } else {
                        state.tmp.term_predecessor = flags.old_term_predecessor;
                        state.tmp.group_context.tip.variable_attempt = flags.variable_attempt;
                        if (flags.force_suppress && !state.tmp.group_context.tip.condition) {
                            state.tmp.group_context.tip.variable_attempt = true;
                            state.tmp.group_context.tip.variable_success = flags.variable_success_parent;
                            for (var i=0,ilen=flags.done_vars.length;i<ilen;i++) {
                                if (state.tmp.done_vars.indexOf(flags.done_vars[i]) > -1) {
                                    state.tmp.done_vars = state.tmp.done_vars.slice(0, i).concat(state.tmp.done_vars.slice(i+1));
                                }
                            }
                        }
                        if (state.output.current.value().blobs) {
                            state.output.current.value().blobs.pop();
                        }
                    }
                }
            };
            this.execs.push(func);
            if (this.juris) {
                var else_end = new CSL.Token("else", CSL.END);
                CSL.Node["else"].build.call(else_end, state, target);
                var choose_end = new CSL.Token("choose", CSL.END);
                CSL.Node.choose.build.call(choose_end, state, target);
            }
        }
        if (this.tokentype === CSL.END) {
            if (!this.juris) {
                target.push(this);
            }
            if (state.build.substitute_level.value()) {
                state.build.substitute_level.replace((state.build.substitute_level.value() - 1));
            }
            CSL.Util.substituteEnd.call(this, state, target);
        }
    }
};
module.exports = CSL;
CSL.Node["if"] = {
    build: function (state, target) {
        CSL.Conditions.TopNode.call(this, state, target);
        target.push(this);
    },
    configure: function (state, pos) {
        CSL.Conditions.Configure.call(this, state, pos);
    }
};
module.exports = CSL;
CSL.Node["conditions"] = {
    build: function (state, target) {
        if (this.tokentype === CSL.START) {
            state.tmp.conditions.addMatch(this.match);
        }
        if (this.tokentype === CSL.END) {
            state.tmp.conditions.matchCombine();
        }
    }
};
module.exports = CSL;
CSL.Node["condition"] = {
    build: function (state, target) {
        if (this.tokentype === CSL.SINGLETON) {
            var test = state.fun.match[this.match](this, state, this.tests);
            state.tmp.conditions.addTest(test);
        }
    }
};
module.exports = CSL;
CSL.Conditions = {};
CSL.Conditions.TopNode = function (state, target) {
    var func;
    if (this.tokentype === CSL.START || this.tokentype === CSL.SINGLETON) {
        if (this.locale) {
            state.opt.lang = this.locale;
        }
        if (!this.tests || !this.tests.length) {
            state.tmp.conditions = new CSL.Conditions.Engine(state, this);
        } else {
            this.test = state.fun.match[this.match](this, state, this.tests);
        }
    }
    if (this.tokentype === CSL.END || this.tokentype === CSL.SINGLETON) {
        func = function (state, Item) {
            if (this.locale_default) {
                state.output.current.value().old_locale = this.locale_default;
                state.output.closeLevel("empty");
                state.opt.lang = this.locale_default;
            }
            var next = this[state.tmp.jump.value()];
            return next;
        };
        this.execs.push(func);
        if (this.locale_default) {
            state.opt.lang = this.locale_default;
        }
    }
};
CSL.Conditions.Configure = function (state, pos) {
    if (this.tokentype === CSL.START) {
        this.fail = state.configure.fail.slice(-1)[0];
        this.succeed = this.next;
        state.configure.fail[(state.configure.fail.length - 1)] = pos;
    } else if (this.tokentype === CSL.SINGLETON) {
        this.fail = this.next;
        this.succeed = state.configure.succeed.slice(-1)[0];
        state.configure.fail[(state.configure.fail.length - 1)] = pos;
    } else {
        this.succeed = state.configure.succeed.slice(-1)[0];
        this.fail = this.next;
    }
};
CSL.Conditions.Engine = function (state, token) {
    this.token = token;
    this.state = state;
};
CSL.Conditions.Engine.prototype.addTest = function (test) {
    this.token.tests.push(test);
};
CSL.Conditions.Engine.prototype.addMatch = function (match) {
    this.token.match = match;
};
CSL.Conditions.Engine.prototype.matchCombine = function () {
    this.token.test = this.state.fun.match[this.token.match](this.token, this.state, this.token.tests);
};
module.exports = CSL;
CSL.Node.info = {
    build: function (state, target) {
        if (this.tokentype === CSL.START) {
            state.build.skip = "info";
        } else {
            state.build.skip = false;
        }
    }
};
module.exports = CSL;
CSL.Node.institution = {
    build: function (state, target) {
        if ([CSL.SINGLETON, CSL.START].indexOf(this.tokentype) > -1) {
            var func = function (state, Item) {
                if ("string" === typeof this.strings.delimiter) {
                    state.tmp.institution_delimiter = this.strings.delimiter;
                } else {
                    state.tmp.institution_delimiter = state.tmp.name_delimiter;
                }
                var myand, and_default_prefix, and_suffix;
                if ("text" === state.inheritOpt(this, "and")) {
                    this.and_term = state.getTerm("and", "long", 0);
                } else if ("symbol" === state.inheritOpt(this, "and")) {
                    if (state.opt.development_extensions.expect_and_symbol_form) {
                        this.and_term = state.getTerm("and", "symbol", 0);
                    } else {
                        this.and_term = "&";
                    }
                } else if ("none" === state.inheritOpt(this, "and")) {
                    this.and_term = state.tmp.institution_delimiter;
                }
                if ("undefined" === typeof this.and_term && state.tmp.and_term) {
                    this.and_term = state.getTerm("and", "long", 0);
                }
                if (CSL.STARTSWITH_ROMANESQUE_REGEXP.test(this.and_term)) {
                    this.and_prefix_single = " ";
                    this.and_prefix_multiple = ", ";
                    if ("string" === typeof state.tmp.institution_delimiter) {
                        this.and_prefix_multiple = state.tmp.institution_delimiter;
                    }
                    this.and_suffix = " ";
                } else {
                    this.and_prefix_single = "";
                    this.and_prefix_multiple = "";
                    this.and_suffix = "";
                }
                if (state.inheritOpt(this, "delimiter-precedes-last") === "always") {
                    this.and_prefix_single = state.tmp.institution_delimiter;
                } else if (state.inheritOpt(this, "delimiter-precedes-last") === "never") {
                    if (this.and_prefix_multiple) {
                        this.and_prefix_multiple = " ";
                    }
                }
                this.and = {};
                if ("undefined" !== typeof this.and_term) {
                    state.output.append(this.and_term, "empty", true);
                    this.and.single = state.output.pop();
                    this.and.single.strings.prefix = this.and_prefix_single;
                    this.and.single.strings.suffix = this.and_suffix;
                    state.output.append(this.and_term, "empty", true);
                    this.and.multiple = state.output.pop();
                    this.and.multiple.strings.prefix = this.and_prefix_multiple;
                    this.and.multiple.strings.suffix = this.and_suffix;
                } else if ("undefined" !== this.strings.delimiter) {
                    this.and.single = new CSL.Blob(state.tmp.institution_delimiter);
                    this.and.single.strings.prefix = "";
                    this.and.single.strings.suffix = "";
                    this.and.multiple = new CSL.Blob(state.tmp.institution_delimiter);
                    this.and.multiple.strings.prefix = "";
                    this.and.multiple.strings.suffix = "";
                }
                state.nameOutput.institution = this;
            };
            this.execs.push(func);
        }
        target.push(this);
    },
    configure: function (state, pos) {
        if ([CSL.SINGLETON, CSL.START].indexOf(this.tokentype) > -1) {
            state.build.has_institution = true;
        }
    }
};
module.exports = CSL;
CSL.Node["institution-part"] = {
    build: function (state, target) {
        var func;
        if ("long" === this.strings.name) {
            if (this.strings["if-short"]) {
                func = function (state, Item) {
                    state.nameOutput.institutionpart["long-with-short"] = this;
                };
            } else {
                func = function (state, Item) {
                    state.nameOutput.institutionpart["long"] = this;
                };
            }
        } else if ("short" === this.strings.name) {
            func = function (state, Item) {
                state.nameOutput.institutionpart["short"] = this;
            };
        }
        this.execs.push(func);
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.key = {
    build: function (state, target) {
        target = state[state.build.root + "_sort"].tokens;
        var func, i, ilen;
        var debug = false;
        var start_key = new CSL.Token("key", CSL.START);
        state.tmp.root = state.build.root;
        start_key.strings["et-al-min"] = state.inheritOpt(this, "et-al-min");
        start_key.strings["et-al-use-first"] = state.inheritOpt(this, "et-al-use-first");
        start_key.strings["et-al-use-last"] = state.inheritOpt(this, "et-al-use-last");
        func = function (state, Item) {
            state.tmp.done_vars = [];
        };
        start_key.execs.push(func);
        state.opt.citation_number_sort_direction = this.strings.sort_direction;
        func = function (state, Item) {
            state.output.openLevel("empty");
        };
        start_key.execs.push(func);
        var sort_direction = [];
        if (this.strings.sort_direction === CSL.DESCENDING) {
            sort_direction.push(1);
            sort_direction.push(-1);
        } else {
            sort_direction.push(-1);
            sort_direction.push(1);
        }
        state[state.build.area].opt.sort_directions.push(sort_direction);
        if (CSL.DATE_VARIABLES.indexOf(this.variables[0]) > -1) {
            state.build.date_key = true;
        }
        func = function (state, Item) {
            state.tmp.sort_key_flag = true;
            if (state.inheritOpt(this, "et-al-min")) {
                state.tmp["et-al-min"] = state.inheritOpt(this, "et-al-min");
            }
            if (state.inheritOpt(this, "et-al-use-first")) {
                state.tmp["et-al-use-first"] = state.inheritOpt(this, "et-al-use-first");
            }
            if ("boolean" === typeof state.inheritOpt(this, "et-al-use-last")) {
                state.tmp["et-al-use-last"] = state.inheritOpt(this, "et-al-use-last");
            }
        };
        start_key.execs.push(func);
        target.push(start_key);
        if (this.variables.length) {
            var variable = this.variables[0];
            if (variable === "citation-number") {
                if (state.build.area === "citation" && state.build.extension === "_sort") {
                    state.opt.citation_number_sort = false;
                }
                if (state.build.root === "bibliography" && state.build.extension === "_sort") {
                    state.opt.citation_number_sort_used = false;
                }
            }
            if (CSL.CREATORS.indexOf(variable) > -1) {
                var names_start_token = new CSL.Token("names", CSL.START);
                names_start_token.tokentype = CSL.START;
                names_start_token.variables = this.variables;
                CSL.Node.names.build.call(names_start_token, state, target);
                var name_token = new CSL.Token("name", CSL.SINGLETON);
                name_token.tokentype = CSL.SINGLETON;
                name_token.strings["name-as-sort-order"] = "all";
                name_token.strings["sort-separator"] = " ";
                name_token.strings["et-al-use-last"] = state.inheritOpt(this, "et-al-use-last");
                name_token.strings["et-al-min"] = state.inheritOpt(this, "et-al-min");
                name_token.strings["et-al-use-first"] = state.inheritOpt(this, "et-al-use-first");
                CSL.Node.name.build.call(name_token, state, target);
                var institution_token = new CSL.Token("institution", CSL.SINGLETON);
                institution_token.tokentype = CSL.SINGLETON;
                CSL.Node.institution.build.call(institution_token, state, target);
                var names_end_token = new CSL.Token("names", CSL.END);
                names_end_token.tokentype = CSL.END;
                CSL.Node.names.build.call(names_end_token, state, target);
            } else {
                var single_text = new CSL.Token("text", CSL.SINGLETON);
                single_text.dateparts = this.dateparts;
                if (CSL.NUMERIC_VARIABLES.indexOf(variable) > -1) {
                    func = function (state, Item) {
                        var num, m;
                        num = false;
                        if ("citation-number" === variable) {
                            num = state.registry.registry[Item.id].seq.toString();
                        } else {
                            num = Item[variable];
                        }
                        if (num) {
                            num = CSL.Util.padding(num);
                        }
                        state.output.append(num, this);
                    };
                } else if (variable === "citation-label") {
                    func = function (state, Item) {
                        var trigraph = state.getCitationLabel(Item);
                        state.output.append(trigraph, this);
                    };
                } else if (CSL.DATE_VARIABLES.indexOf(variable) > -1) {
                    func = CSL.dateAsSortKey;
                    single_text.variables = this.variables;
                } else if ("title" === variable) {
                    var abbrevfam = "title";
                    var abbrfall = false;
                    var altvar = false;
                    var transfall = true;
                    func = state.transform.getOutputFunction(this.variables, abbrevfam, abbrfall, altvar, transfall);
                } else {
                    func = function (state, Item) {
                        var varval = Item[variable];
                        state.output.append(varval, "empty");
                    };
                }
                single_text.execs.push(func);
                target.push(single_text);
            }
        } else { // macro
            var token = new CSL.Token("text", CSL.SINGLETON);
            token.postponed_macro = this.postponed_macro;
            CSL.expandMacro.call(state, token, target);
        }
        var end_key = new CSL.Token("key", CSL.END);
        func = function (state, Item) {
            var keystring = state.output.string(state, state.output.queue);
            if (state.sys.normalizeUnicode) {
                keystring = state.sys.normalizeUnicode(keystring);
            }
            keystring = keystring ? (keystring.split(" ").join(state.opt.sort_sep) + state.opt.sort_sep) : "";
            if ("" === keystring) {
                keystring = undefined;
            }
            if ("string" !== typeof keystring || state.tmp.empty_date) {
                keystring = undefined;
                state.tmp.empty_date = false;
            }
            state[state[state.tmp.area].root + "_sort"].keys.push(keystring);
            state.tmp.value = [];
        };
        end_key.execs.push(func);
        if (state.build.date_key) {
            if (state.build.area === "citation" && state.build.extension === "_sort") {
                state[state.build.area].opt.sort_directions.push([-1,1]);
                func = function (state, Item) {
                    var year_suffix = state.registry.registry[Item.id].disambig.year_suffix;
                    if (!year_suffix) {
                        year_suffix = 0;
                    }
                    var key = CSL.Util.padding("" + year_suffix);
                    state[state.tmp.area].keys.push(key);
                }
                end_key.execs.push(func);
            }
            state.build.date_key = false;
        }
        func = function (state, Item) {
            state.tmp["et-al-min"] = undefined;
            state.tmp["et-al-use-first"] = undefined;
            state.tmp["et-al-use-last"] = undefined;
            state.tmp.sort_key_flag = false;
        };
        end_key.execs.push(func);
        target.push(end_key);
    }
};
module.exports = CSL;
CSL.Node.label = {
    build: function (state, target) {
        var debug = false;
        if (this.strings.term) {
            var plural = false;
            if (!this.strings.form) {
            }
            var func = function (state, Item, item) {
                var termtxt = CSL.evaluateLabel(this, state, Item, item);
                if (item && this.strings.term === "locator") {
                    state.parallel.StartVariable("label");
                    state.parallel.AppendToVariable(item.label);
                    item.section_form_override = this.strings.form;
                }
                if (termtxt) {
                    state.tmp.group_context.tip.term_intended = true;
                }
                CSL.UPDATE_GROUP_CONTEXT_CONDITION(state, termtxt);
                if (termtxt.indexOf("%s") === -1) {
                    if (this.strings.capitalize_if_first) {
                        if (!state.tmp.term_predecessor && !(state.opt["class"] === "in-text" && state.tmp.area === "citation")) {
                            termtxt = CSL.Output.Formatters["capitalize-first"](state, termtxt);
                        }
                    }
                    state.output.append(termtxt, this);
                }
                if (item && this.strings.term === "locator") {
                    state.parallel.CloseVariable();
                }
            };
            this.execs.push(func);
        } else {
            var namevars = state.build.names_variables.slice(-1)[0];
            if (!state.build.name_label) {
                state.build.name_label = {};
            }
            for (var i = 0, ilen = namevars.length; i < ilen; i += 1) {
                if (!state.build.name_label[namevars[i]]) {
                    state.build.name_label[namevars[i]] = {};
                }
            }
            if (!state.build.name_flag) {
                for (var i = 0, ilen = namevars.length; i < ilen; i += 1) {
                    state.build.name_label[namevars[i]].before = this;
                }
            } else {
                for (var i = 0, ilen = namevars.length; i < ilen; i += 1) {
                    state.build.name_label[namevars[i]].after = this;
                }
            }
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.layout = {
    build: function (state, target) {
        var func, prefix_token, suffix_token, tok;
        function setSuffix() {
            if (state.build.area === "bibliography") {
                suffix_token = new CSL.Token("text", CSL.SINGLETON);
                func = function(state, Item, item) {
                    var last_locale = state.tmp.cite_locales[state.tmp.cite_locales.length - 1];
                    var suffix;
                    if (state.tmp.cite_affixes[state.tmp.area][state.tmp.last_cite_locale]) {
                        suffix = state.tmp.cite_affixes[state.tmp.area][state.tmp.last_cite_locale].suffix;
                    } else {
                        suffix = state.bibliography.opt.layout_suffix;
                    }
                    var topblob = state.output.current.value();
                    if (state.opt.using_display) {
                        topblob.blobs[topblob.blobs.length-1].strings.suffix = suffix;
                    } else {
                        topblob.strings.suffix = suffix;
                    }
                    if (state.bibliography.opt["second-field-align"]) {
                        state.output.endTag("bib_other");
                    }
                };
                suffix_token.execs.push(func);
                target.push(suffix_token);
            }
        }
        if (this.tokentype === CSL.START) {
            if (this.locale_raw) {
                state.build.current_default_locale = this.locale_raw;
            } else {
                state.build.current_default_locale = state.opt["default-locale"];
            }
            func = function (state, Item, item) {
                if (state.opt.development_extensions.apply_citation_wrapper
                    && state.sys.wrapCitationEntry
                    && !state.tmp.just_looking
                    && Item.system_id 
                    && state.tmp.area === "citation") { 
                    cite_entry = new CSL.Token("group", CSL.START);
                    cite_entry.decorations = [["@cite", "entry"]];
                    state.output.startTag("cite_entry", cite_entry);
                    state.output.current.value().item_id = Item.system_id;
                    if (item) {
                        state.output.current.value().locator_txt = item.locator_txt;
                        state.output.current.value().suffix_txt = item.suffix_txt;
                    }
                }
            }
            this.execs.push(func);
        }
        if (this.tokentype === CSL.START && !state.tmp.cite_affixes[state.build.area]) {
            func = function (state, Item) {
                state.tmp.done_vars = [];
                if (state.opt.suppressedJurisdictions[Item["country"]]
                    && Item["country"]
                    && ["treaty", "patent"].indexOf(Item.type) === -1) {
                    state.tmp.done_vars.push("country");
                }
                if (!state.tmp.just_looking && state.registry.registry[Item.id] && state.registry.registry[Item.id].parallel) {
                    state.tmp.done_vars.push("first-reference-note-number");
                }
                state.tmp.rendered_name = false;
            };
            this.execs.push(func);
            func = function (state, Item) {
                state.tmp.sort_key_flag = false;
            };
            this.execs.push(func);
            func = function (state, Item) {
                state.tmp.nameset_counter = 0;
            };
            this.execs.push(func);
            func = function (state, Item) {
                var tok = new CSL.Token();
                if (state.opt.development_extensions.rtl_support) {
                    if (["ar", "he", "fa", "ur", "yi", "ps", "syr"].indexOf(Item.language) > -1) {
                        tok = new CSL.Token();
                        tok.strings.prefix = "\u202b";
                        tok.strings.suffix = "\u202c";
                    }
                }
                state.output.openLevel(tok);
            }
            this.execs.push(func);
            target.push(this);
            if (state.opt.development_extensions.rtl_support && false) {
                this.strings.prefix = this.strings.prefix.replace(/\((.|$)/g,"(\u200e$1");
                this.strings.suffix = this.strings.suffix.replace(/\)(.|$)/g,")\u200e$1");
            }
            if (state.build.area === "citation") {
                prefix_token = new CSL.Token("text", CSL.SINGLETON);
                func = function (state, Item, item) {
                    var sp;
                    if (item && item.prefix) {
                        sp = "";
                        var test_prefix = item.prefix.replace(/<[^>]+>/g, "").replace(/["'\u201d\u2019\u00bb\u202f\u00a0 ]+$/g,"");
                        var test_char = test_prefix.slice(-1);
                        if (test_prefix.match(CSL.ENDSWITH_ROMANESQUE_REGEXP)) {
                            sp = " ";
                        } else if (CSL.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(test_char) > -1) {
                            sp = " ";
                        } else if (test_char.match(/[\)\],0-9]/)) {
                            sp = " ";
                        }
                        var ignorePredecessor = false;
                        if (CSL.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(test_char) > -1 && item.prefix.trim().indexOf(" ") > -1) {
                            state.tmp.term_predecessor = false;
                            ignorePredecessor = true;
                        }
                        var prefix = (item.prefix + sp).replace(/\s+/g, " ");
                        if (!state.tmp.just_looking) {
                            prefix = state.output.checkNestedBrace.update(prefix);
                        }
                        state.output.append(prefix, this, false, ignorePredecessor);
                    }
                };
                prefix_token.execs.push(func);
                target.push(prefix_token);
            }
        }
        var my_tok;
        if (this.locale_raw) {
            my_tok = new CSL.Token("dummy", CSL.START);
            my_tok.locale = this.locale_raw;
            my_tok.strings.delimiter = this.strings.delimiter;
            my_tok.strings.suffix = this.strings.suffix;
            if (!state.tmp.cite_affixes[state.build.area]) {
                state.tmp.cite_affixes[state.build.area] = {};
            }
        }
        if (this.tokentype === CSL.START) {
            state.build.layout_flag = true;
            if (!this.locale_raw) {
                state[state.tmp.area].opt.topdecor = [this.decorations];
                state[(state.tmp.area + "_sort")].opt.topdecor = [this.decorations];
                state[state.build.area].opt.layout_prefix = this.strings.prefix;
                state[state.build.area].opt.layout_suffix = this.strings.suffix;
                state[state.build.area].opt.layout_delimiter = this.strings.delimiter;
                state[state.build.area].opt.layout_decorations = this.decorations;
                if (state.tmp.cite_affixes[state.build.area]) {
                    tok = new CSL.Token("else", CSL.START);
                    CSL.Node["else"].build.call(tok, state, target);
                }
            } // !this.locale_raw
            if (this.locale_raw) {
                if (!state.build.layout_locale_flag) {
                    var choose_tok = new CSL.Token("choose", CSL.START);
                    CSL.Node.choose.build.call(choose_tok, state, target);
                    my_tok.name = "if";
                    CSL.Attributes["@locale-internal"].call(my_tok, state, this.locale_raw);
                    CSL.Node["if"].build.call(my_tok, state, target);
                } else {
                    my_tok.name = "else-if";
                    CSL.Attributes["@locale-internal"].call(my_tok, state, this.locale_raw);
                    CSL.Node["else-if"].build.call(my_tok, state, target);
                }
                state.tmp.cite_affixes[state.build.area][my_tok.locale] = {};
                state.tmp.cite_affixes[state.build.area][my_tok.locale].delimiter = this.strings.delimiter;
                state.tmp.cite_affixes[state.build.area][my_tok.locale].suffix = this.strings.suffix;
            }
        }
        if (this.tokentype === CSL.END) {
            if (this.locale_raw) {
                setSuffix();
                if (!state.build.layout_locale_flag) {
                    my_tok.name = "if";
                    my_tok.tokentype = CSL.END;
                    CSL.Attributes["@locale-internal"].call(my_tok, state, this.locale_raw);
                    CSL.Node["if"].build.call(my_tok, state, target);
                    state.build.layout_locale_flag = true;
                } else {
                    my_tok.name = "else-if";
                    my_tok.tokentype = CSL.END;
                    CSL.Attributes["@locale-internal"].call(my_tok, state, this.locale_raw);
                    CSL.Node["else-if"].build.call(my_tok, state, target);
                }
            }
            if (!this.locale_raw) {
                setSuffix();
                if (state.tmp.cite_affixes[state.build.area]) {
                    if (state.build.layout_locale_flag) {
                        tok = new CSL.Token("else", CSL.END);
                        CSL.Node["else"].build.call(tok, state, target);
                        tok = new CSL.Token("choose", CSL.END);
                        CSL.Node.choose.build.call(tok, state, target);
                    }
                }
                state.build_layout_locale_flag = true;
                if (state.build.area === "citation") {
                    suffix_token = new CSL.Token("text", CSL.SINGLETON);
                    func = function (state, Item, item) {
                        var sp;
                        if (item && item.suffix) {
                            sp = "";
                            if (item.suffix.match(CSL.STARTSWITH_ROMANESQUE_REGEXP)
                                || ['[','('].indexOf(item.suffix.slice(0,1)) > -1) {
                                sp = " ";
                            }
                            var suffix = item.suffix;
                            if (!state.tmp.just_looking) {
                                suffix = state.output.checkNestedBrace.update(suffix);
                            }
                            state.output.append((sp + suffix), this);
                        }
                    };
                    suffix_token.execs.push(func);
                    target.push(suffix_token);
                }
                func = function (state, Item) {
                    state.output.closeLevel();
                };
                this.execs.push(func);
                func = function (state, Item) {
                    if (state.opt.development_extensions.apply_citation_wrapper
                        && state.sys.wrapCitationEntry
                        && !state.tmp.just_looking
                        && Item.system_id 
                        && state.tmp.area === "citation") { 
                        state.output.endTag(); // closes citation link wrapper
                    }
                }
                this.execs.push(func);
                target.push(this);
                state.build.layout_flag = false;
                state.build.layout_locale_flag = false;
            } // !this.layout_raw
        }
    }
};
module.exports = CSL;
CSL.Node.macro = {
    build: function (state, target) {}
};
module.exports = CSL;
CSL.NameOutput = function(state, Item, item, variables) {
    this.debug = false;
    this.state = state;
    this.Item = Item;
    this.item = item;
    this.nameset_base = 0;
    this.etal_spec = {};
    this._first_creator_variable = false;
    this._please_chop = false;
};
CSL.NameOutput.prototype.init = function (names) {
    if (this.state.tmp.term_predecessor) {
        this.state.tmp.subsequent_author_substitute_ok = false;
    }
    if (this.nameset_offset) {
        this.nameset_base = this.nameset_base + this.nameset_offset;
    }
    this.nameset_offset = 0;
    this.names = names;
    this.variables = names.variables;
    this.state.tmp.value = [];
    this.state.tmp.rendered_name = [];
    this.state.tmp.label_blob = false;
    this.state.tmp.etal_node = false;
    this.state.tmp.etal_term = false;
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        if (this.Item[this.variables[i]] && this.Item[this.variables[i]].length) {
            this.state.tmp.value = this.state.tmp.value.concat(this.Item[this.variables[i]]);
        }
    }
    this["et-al"] = undefined;
    this["with"] = undefined;
    this.name = undefined;
    this.institutionpart = {};
    this.state.tmp.group_context.tip.variable_attempt = true;
    this.labelVariable = this.variables[0];
    if (!this.state.tmp.value.length) {
        return;
    }
};
CSL.NameOutput.prototype.reinit = function (names, labelVariable) {
    this.labelVariable = labelVariable;
    if (this.state.tmp.can_substitute.value()) {
        this.nameset_offset = 0;
        this.variables = names.variables;
        var oldval = this.state.tmp.value.slice();
        this.state.tmp.value = [];
        for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
            if (this.Item[this.variables[i]] && this.Item[this.variables[i]].length) {
                this.state.tmp.value = this.state.tmp.value.concat(this.Item[this.variables[i]]);
            }
        }
        if (this.state.tmp.value.length) {
            this.state.tmp.can_substitute.replace(false, CSL.LITERAL);
        }
        this.state.tmp.value = oldval;
    }
};
CSL.NameOutput.prototype.outputNames = function () {
    var i, ilen;
    var variables = this.variables;
    if (this.institution.and) {
        if (!this.institution.and.single.blobs || !this.institution.and.single.blobs.length) {
            this.institution.and.single.blobs = this.name.and.single.blobs;
        }
        if (!this.institution.and.multiple.blobs || !this.institution.and.multiple.blobs.length) {
            this.institution.and.multiple.blobs = this.name.and.multiple.blobs;
        }
    }
    this.variable_offset = {};
    if (this.family) {
        this.family_decor = CSL.Util.cloneToken(this.family);
        this.family_decor.strings.prefix = "";
        this.family_decor.strings.suffix = "";
        for (i = 0, ilen = this.family.execs.length; i < ilen; i += 1) {
            this.family.execs[i].call(this.family_decor, this.state, this.Item);
        }
    } else {
        this.family_decor = false;
    }
    if (this.given) {
        this.given_decor = CSL.Util.cloneToken(this.given);
        this.given_decor.strings.prefix = "";
        this.given_decor.strings.suffix = "";
        for (i = 0, ilen = this.given.execs.length; i < ilen; i += 1) {
            this.given.execs[i].call(this.given_decor, this.state, this.Item);
        }
    } else {
        this.given_decor = false;
    }
    this.getEtAlConfig();
    this.divideAndTransliterateNames();
    this.truncatePersonalNameLists();
    this.disambigNames();
    this.constrainNames();
    if (this.name.strings.form === "count") {
        if (this.state.tmp.extension || this.names_count != 0) {
            this.state.output.append(this.names_count, "empty");
            this.state.tmp.group_context.tip.variable_success = true;
        }
        return;
    }
    this.setEtAlParameters();
    this.setCommonTerm();
    this.state.tmp.name_node = {};
    this.state.tmp.name_node.children = [];
    this.renderAllNames();
    var blob_list = [];
    for (i = 0, ilen = variables.length; i < ilen; i += 1) {
        var v = variables[i];
        var institution_sets = [];
        var institutions = false;
        var varblob = null;
        if (!this.state.opt.development_extensions.spoof_institutional_affiliations) {
            varblob = this._join([this.freeters[v]], "");
        } else {
            for (var j = 0, jlen = this.institutions[v].length; j < jlen; j += 1) {
                institution_sets.push(this.joinPersonsAndInstitutions([this.persons[v][j], this.institutions[v][j]]));
            }
            if (this.institutions[v].length) {
                var pos = this.nameset_base + this.variable_offset[v];
                if (this.freeters[v].length) {
                    pos += 1;
                }
                institutions = this.joinInstitutionSets(institution_sets, pos);
            }
            var varblob = this.joinFreetersAndInstitutionSets([this.freeters[v], institutions]);
        }
        if (varblob) {
            if (!this.state.tmp.extension) {
                varblob = this._applyLabels(varblob, v);
            }
            blob_list.push(varblob);
        }
        if (this.common_term) {
            break;
        }
    }
    this.state.output.openLevel("empty");
    this.state.output.current.value().strings.delimiter = this.state.inheritOpt(this.names, "delimiter", "names-delimiter");
    for (i = 0, ilen = blob_list.length; i < ilen; i += 1) {
        this.state.output.append(blob_list[i], "literal", true);
    }
    this.state.output.closeLevel("empty");
    var blob = this.state.output.pop();
    var namesToken = CSL.Util.cloneToken(this.names);
    this.state.output.append(blob, namesToken);
    if (this.state.tmp.term_predecessor_name) {
        this.state.tmp.term_predecessor = true;
    }
    this.state.tmp.name_node.top = this.state.output.current.value();
    if (variables[0] !== "authority") {
        var name_node_string = [];
        var nameobjs = this.Item[variables[0]];
        if (nameobjs) {
            for (var i = 0, ilen = nameobjs.length; i < ilen; i += 1) {
                var substring = CSL.Util.Names.getRawName(nameobjs[i]);
                if (substring) {
                    name_node_string.push(substring);
                }
            }
        }
        name_node_string = name_node_string.join(", ");
        if (name_node_string) {
            this.state.tmp.name_node.string = name_node_string;
        }
    }
    if (this.state.tmp.name_node.string && !this.state.tmp.first_name_string) {
        this.state.tmp.first_name_string = this.state.tmp.name_node.string;
    }
    if ("classic" === this.Item.type) {
        var author_title = [];
        if (this.state.tmp.first_name_string) {
            author_title.push(this.state.tmp.first_name_string);
        }
        if (this.Item.title) {
            author_title.push(this.Item.title);
        }
        author_title = author_title.join(", ");
        if (author_title && this.state.sys.getAbbreviation) {
            this.state.transform.loadAbbreviation("default", "classic", author_title);
            if (this.state.transform.abbrevs["default"].classic[author_title]) {
                this.state.tmp.done_vars.push("title");
                this.state.output.append(this.state.transform.abbrevs["default"].classic[author_title], "empty", true);
                blob = this.state.output.pop();
				this.state.tmp.name_node.top.blobs.pop();
                this.state.tmp.name_node.top.blobs.push(blob);
            }
        }
    }
    this._collapseAuthor();
    this.variables = [];
};
CSL.NameOutput.prototype._applyLabels = function (blob, v) {
    var txt;
    if (!this.label || !this.label[this.labelVariable]) {
        return blob;
    }
    var plural = 0;
    var num = this.freeters_count[v] + this.institutions_count[v];
    if (num > 1) {
        plural = 1;
    } else {
        for (var i = 0, ilen = this.persons[v].length; i < ilen; i += 1) {
            num += this.persons_count[v][i];
        }
        if (num > 1) {
            plural = 1;
        }
    }
    if (this.label[this.labelVariable].before) {
        if ("number" === typeof this.label[this.labelVariable].before.strings.plural) {
            plural = this.label[this.labelVariable].before.strings.plural;
        }
        txt = this._buildLabel(v, plural, "before", this.labelVariable);
        this.state.output.openLevel("empty");
        this.state.output.append(txt, this.label[this.labelVariable].before, true);
        this.state.output.append(blob, "literal", true);
        this.state.output.closeLevel("empty");
        blob = this.state.output.pop();
    } else if (this.label[this.labelVariable].after) {
        if ("number" === typeof this.label[this.labelVariable].after.strings.plural) {
            plural = this.label[this.labelVariable].after.strings.plural;
        }
        txt = this._buildLabel(v, plural, "after", this.labelVariable);
        this.state.output.openLevel("empty");
        this.state.output.append(blob, "literal", true);
        this.state.output.append(txt, this.label[this.labelVariable].after, true);
        this.state.tmp.label_blob = this.state.output.pop();
        this.state.output.append(this.state.tmp.label_blob,"literal",true);
        this.state.output.closeLevel("empty");
        blob = this.state.output.pop();
    }
    return blob;
};
CSL.NameOutput.prototype._buildLabel = function (term, plural, position, v) {
    if (this.common_term) {
        term = this.common_term;
    }
    var ret = false;
    var node = this.label[v][position];
    if (node) {
        ret = CSL.castLabel(this.state, node, term, plural, CSL.TOLERANT);
    }
    return ret;
};
CSL.NameOutput.prototype._collapseAuthor = function () {
    var myqueue, mystr, oldchars;
    if (this.nameset_base === 0 && this.Item[this.variables[0]] && !this._first_creator_variable) {
        this._first_creator_variable = this.variables[0];
    }
    if ((this.item && this.item["suppress-author"] && this._first_creator_variable == this.variables[0])
        || (this.state[this.state.tmp.area].opt.collapse 
            && this.state[this.state.tmp.area].opt.collapse.length)
        || (this.state[this.state.tmp.area].opt.cite_group_delimiter 
            && this.state[this.state.tmp.area].opt.cite_group_delimiter.length)) {
        if (this.state.tmp.authorstring_request) {
            mystr = "";
            myqueue = this.state.tmp.name_node.top.blobs.slice(-1)[0].blobs;
            oldchars = this.state.tmp.offset_characters;
            if (myqueue) {
                mystr = this.state.output.string(this.state, myqueue, false);
            }
            this.state.tmp.offset_characters = oldchars;
            this.state.registry.authorstrings[this.Item.id] = mystr;
        } else if (!this.state.tmp.just_looking
                   && !this.state.tmp.suppress_decorations && (this.item["suppress-author"] || (this.state[this.state.tmp.area].opt.collapse && this.state[this.state.tmp.area].opt.collapse.length) || this.state[this.state.tmp.area].opt.cite_group_delimiter && this.state[this.state.tmp.area].opt.cite_group_delimiter)) {
            mystr = "";
            myqueue = this.state.tmp.name_node.top.blobs.slice(-1)[0].blobs;
            oldchars = this.state.tmp.offset_characters;
            if (myqueue) {
                mystr = this.state.output.string(this.state, myqueue, false);
            }
            if (mystr === this.state.tmp.last_primary_names_string) {
                if (this.item["suppress-author"] || (this.state[this.state.tmp.area].opt.collapse && this.state[this.state.tmp.area].opt.collapse.length)) {
                    this.state.tmp.name_node.top.blobs.pop();
                    this.state.tmp.name_node.children = [];
                    this.state.tmp.offset_characters = oldchars;
                }
                if (this.state[this.state.tmp.area].opt.cite_group_delimiter && this.state[this.state.tmp.area].opt.cite_group_delimiter) {
                    this.state.tmp.use_cite_group_delimiter = true;
                }
            } else {
                this.state.tmp.last_primary_names_string = mystr;
                if (this.variables.indexOf(this._first_creator_variable) > -1 && this.item && this.item["suppress-author"] && this.Item.type !== "legal_case") {
                    this.state.tmp.name_node.top.blobs.pop();
                    this.state.tmp.name_node.children = [];
                    this.state.tmp.offset_characters = oldchars;
                    this.state.tmp.term_predecessor = false;
                }
                this.state.tmp.have_collapsed = false;
                if (this.state[this.state.tmp.area].opt.cite_group_delimiter && this.state[this.state.tmp.area].opt.cite_group_delimiter) {
                    this.state.tmp.use_cite_group_delimiter = false;
                }
            }
        }
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.isPerson = function (value) {
    if (value.literal
        || (!value.given && value.family && value.isInstitution)) {
        return false;
    } else {
        return true;
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.truncatePersonalNameLists = function () {
    var v, i, ilen, j, jlen, chopvar, values;
    this.freeters_count = {};
    this.persons_count = {};
    this.institutions_count = {};
    for (v in this.freeters) {
        if (this.freeters.hasOwnProperty(v)) {
            this.freeters_count[v] = this.freeters[v].length;
            this.freeters[v] = this._truncateNameList(this.freeters, v);
        }
    }
    for (v in this.persons) {
        if (this.persons.hasOwnProperty(v)) {
            this.institutions_count[v] = this.institutions[v].length;
            this._truncateNameList(this.institutions, v);
            this.persons[v] = this.persons[v].slice(0, this.institutions[v].length);
            this.persons_count[v] = [];
            for (j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
                this.persons_count[v][j] = this.persons[v][j].length;
                this.persons[v][j] = this._truncateNameList(this.persons, v, j);
            }
        }
    }
    if (this.etal_min === 1 && this.etal_use_first === 1 
        && !(this.state.tmp.extension
             || this.state.tmp.just_looking)) {
        chopvar = v;
    } else {
        chopvar = false;
    }
    if (chopvar || this._please_chop) {
        for (i = 0, ilen = this.variables.length; i < ilen; i += 1) {
            v = this.variables[i];
            if (this.freeters[v].length) {
                if (this._please_chop === v) {
                    this.freeters[v] = this.freeters[v].slice(1);
                    this.freeters_count[v] += -1;
                    this._please_chop = false;
                } else if (chopvar && !this._please_chop) {
                    this.freeters[v] = this.freeters[v].slice(0, 1);
                    this.freeters_count[v] = 1;
                    this.institutions[v] = [];
                    this.persons[v] = [];
                    this._please_chop = chopvar;
                }
            }
            for (var j=0,jlen = this.persons[v].length;j<jlen;j++) {
                if (this.persons[v][j].length) {
                    if (this._please_chop === v) {
                        this.persons[v][j] = this.persons[v][j].slice(1);
                        this.persons_count[v][j] += -1;
                        this._please_chop = false;
                        break;
                    } else if (chopvar && !this._please_chop) {
                        this.freeters[v] = this.persons[v][j].slice(0, 1);
                        this.freeters_count[v] = 1;
                        this.institutions[v] = [];
                        this.persons[v] = [];
                        values = [];
                        this._please_chop = chopvar;
                        break;
                    }
                }
            }
            if (this.institutions[v].length) {
                if (this._please_chop === v) {
                    this.institutions[v] = this.institutions[v].slice(1);
                    this.institutions_count[v] += -1;
                    this._please_chop = false;
                } else if (chopvar && !this._please_chop) {
                    this.institutions[v] = this.institutions[v].slice(0, 1);
                    this.institutions_count[v] = 1;
                    values = [];
                    this._please_chop = chopvar;
                }
            }
        }
    }
    for (i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        if (this.institutions[v].length) {
            this.nameset_offset += 1;
        }
        for (var j=0,jlen=this.persons[v].length;j<jlen;j++) {
            if (this.persons[v][j].length) {
                this.nameset_offset += 1;
            }
        }
    }
};
CSL.NameOutput.prototype._truncateNameList = function (container, variable, index) {
    var lst;
    if ("undefined" === typeof index) {
        lst = container[variable];
    } else {
        lst = container[variable][index];
    }
    if (this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names 
        && lst.length > 50 
        && lst.length > (this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names + 2)) {
        var limit = this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names;
        lst = lst.slice(0, limit+1).concat(lst.slice(-1));
    }
    return lst;
};
module.exports = CSL;
CSL.NameOutput.prototype.divideAndTransliterateNames = function () {
    var i, ilen, j, jlen;
    var Item = this.Item;
    var variables = this.variables;
    this.varnames = variables.slice();
    this.freeters = {};
    this.persons = {};
    this.institutions = {};
    for (i = 0, ilen = variables.length; i < ilen; i += 1) {
        var v = variables[i];
        this.variable_offset[v] = this.nameset_offset;
        var values = this._normalizeVariableValue(Item, v);
        if (this.name.strings["suppress-min"] && values.length >= this.name.strings["suppress-min"]) {
            values = [];
        }
        if (this.name.strings["suppress-max"] && values.length <= this.name.strings["suppress-max"]) {
            values = [];
        }
        this._getFreeters(v, values);
        this._getPersonsAndInstitutions(v, values);
        if (this.state.opt.development_extensions.spoof_institutional_affiliations) {
            if (this.name.strings["suppress-min"] === 0) {
                this.freeters[v] = [];
                for (j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
                    this.persons[v][j] = [];
                }
            } else if (this.institution.strings["suppress-min"] === 0) {
                this.institutions[v] = [];
                this.freeters[v] = this.freeters[v].concat(this.persons[v]);
                for (j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
                    for (var k = 0, klen = this.persons[v][j].length; k < klen; k += 1) {
                        this.freeters[v].push(this.persons[v][j][k]);
                    }
                }
                this.persons[v] = [];
            }
        }
    }
};
CSL.NameOutput.prototype._normalizeVariableValue = function (Item, variable) {
    var names, name, i, ilen;
    if ("string" === typeof Item[variable] || "number" === typeof Item[variable]) {
        CSL.debug("name variable \"" + variable + "\" is string or number, not array. Attempting to fix.");
        names = [{literal: Item[variable] + ""}];
    } else if (!Item[variable]) {
        names = [];
    } else if ("number" !== typeof Item[variable].length) {
        CSL.debug("name variable \"" + variable + "\" is object, not array. Attempting to fix.");
        Item[variable] = [Item[variable]];
        names = Item[variable].slice();
    } else {
        names = Item[variable].slice();
    }
    return names;
};
CSL.NameOutput.prototype._getFreeters = function (v, values) {
    this.freeters[v] = [];
    if (this.state.opt.development_extensions.spoof_institutional_affiliations) {
        for (var i=values.length-1;i>-1;i--) {
            if (this.isPerson(values[i])) {
                var value = this._checkNickname(values.pop());
                if (value) {
                    this.freeters[v].push(value);
                }
            } else {
                break;
            }
        }
    } else {
        for (var i=values.length-1;i>-1;i--) {
            var value = values.pop();
            if (this.isPerson(value)) {
                var value = this._checkNickname(value);
            }
            this.freeters[v].push(value);
        }
    }
    this.freeters[v].reverse();
    if (this.freeters[v].length) {
        this.nameset_offset += 1;
    }
};
CSL.NameOutput.prototype._getPersonsAndInstitutions = function (v, values) {
    this.persons[v] = [];
    this.institutions[v] = [];
    if (!this.state.opt.development_extensions.spoof_institutional_affiliations) return;
    var persons = [];
    var has_affiliates = false;
    var first = true;
    for (var i = values.length - 1; i > -1; i += -1) {
        if (this.isPerson(values[i])) {
            var value = this._checkNickname(values[i]);
            if (value) {
                persons.push(value);
            }
        } else {
            has_affiliates = true;
            this.institutions[v].push(values[i]);
            if (!first) {
                persons.reverse();
                this.persons[v].push(persons);
                persons = [];
            }
            first = false;
        }
    }
    if (has_affiliates) {
        persons.reverse();
        this.persons[v].push(persons);
        this.persons[v].reverse();
        this.institutions[v].reverse();
    }
};
CSL.NameOutput.prototype._clearValues = function (values) {
    for (var i = values.length - 1; i > -1; i += -1) {
        values.pop();
    }
};
CSL.NameOutput.prototype._checkNickname = function (name) {
    if (["interview", "personal_communication"].indexOf(this.Item.type) > -1) {
        var author = "";
        author = CSL.Util.Names.getRawName(name);
        if (author && this.state.sys.getAbbreviation && !(this.item && this.item["suppress-author"])) {
            var normalizedKey = author;
            if (this.state.sys.normalizeAbbrevsKey) {
                normalizedKey = this.state.sys.normalizeAbbrevsKey("author", author);
            }
            this.state.transform.loadAbbreviation("default", "nickname", normalizedKey);
            var myLocalName = this.state.transform.abbrevs["default"].nickname[normalizedKey];
            if (myLocalName) {
                if (myLocalName === "!here>>>") {
                    name = false;
                } else {
                    name = {family:myLocalName,given:''};
                }
            }
        }
    }
    return name;
};
module.exports = CSL;
CSL.NameOutput.prototype.joinPersons = function (blobs, pos, j, tokenname) {
    var ret;
    if (!tokenname) {
        tokenname = "name";
    }
    if ("undefined" === typeof j) {
        if (this.etal_spec[pos].freeters === 1) {
           ret = this._joinEtAl(blobs, tokenname);
        } else if (this.etal_spec[pos].freeters === 2) {
            ret = this._joinEllipsis(blobs, tokenname);
        } else if (!this.state.tmp.sort_key_flag) {
            ret = this._joinAnd(blobs, tokenname);
        } else {
            ret = this._join(blobs, " ");
        }
    } else {
        if (this.etal_spec[pos].persons[j] === 1) {
            ret = this._joinEtAl(blobs, tokenname);
        } else if (this.etal_spec[pos].persons[j] === 2) {
            ret = this._joinEllipsis(blobs, tokenname);
        } else if (!this.state.tmp.sort_key_flag) {
            ret = this._joinAnd(blobs, tokenname);
        } else {
            ret = this._join(blobs, " ");
        }
    }
    return ret;
};
CSL.NameOutput.prototype.joinInstitutionSets = function (blobs, pos) {
    var ret;
    if (this.etal_spec[pos].institutions === 1) {
        ret = this._joinEtAl(blobs, "institution");
    } else if (this.etal_spec[pos].institutions === 2) {
        ret = this._joinEllipsis(blobs, "institution");
    } else {
        ret = this._joinAnd(blobs, "institution");
    }
    return ret;
};
CSL.NameOutput.prototype.joinPersonsAndInstitutions = function (blobs) {
    return this._join(blobs, this.state.tmp.name_delimiter);
};
CSL.NameOutput.prototype.joinFreetersAndInstitutionSets = function (blobs) {
    var ret = this._join(blobs, "[never here]", this["with"].single, this["with"].multiple);
    return ret;
};
CSL.NameOutput.prototype._joinEtAl = function (blobs, tokenname) {
    var blob = this._join(blobs, this.state.tmp.name_delimiter);
    this.state.output.openLevel(this._getToken(tokenname));
    this.state.output.current.value().strings.delimiter = "";
    this.state.output.append(blob, "literal", true);
    if (blobs.length > 1) {
        this.state.output.append(this["et-al"].multiple, "literal", true);
    } else if (blobs.length === 1) {
        this.state.output.append(this["et-al"].single, "literal", true);
    }
    this.state.output.closeLevel();
    return this.state.output.pop();
};
CSL.NameOutput.prototype._joinEllipsis = function (blobs, tokenname) {
    return this._join(blobs, this.state.tmp.name_delimiter, this.name.ellipsis.single, this.name.ellipsis.multiple, tokenname);
};
CSL.NameOutput.prototype._joinAnd = function (blobs, tokenname) {
    return this._join(blobs, this.state.inheritOpt(this[tokenname], "delimiter", (tokenname + "-delimiter"), ", "), this[tokenname].and.single, this[tokenname].and.multiple, tokenname);
};
CSL.NameOutput.prototype._join = function (blobs, delimiter, single, multiple, tokenname) {
    var i, ilen;
    if (!blobs) {
        return false;
    }
    for (i = blobs.length - 1; i > -1; i += -1) {
        if (!blobs[i] || blobs[i].length === 0 || !blobs[i].blobs.length) {
            blobs = blobs.slice(0, i).concat(blobs.slice(i + 1));
        }
    }
    if (!blobs.length) {
        return false;
    } else if (single && blobs.length === 2) {
        if (single) {
            single = new CSL.Blob(single.blobs,single);
        }
        blobs = [blobs[0], single, blobs[1]];
    } else {
        var delimiter_offset;
        if (multiple) {
            delimiter_offset = 2;
        } else {
            delimiter_offset = 1;
        }
        for (i = 0, ilen = blobs.length - delimiter_offset; i < ilen; i += 1) {
            blobs[i].strings.suffix += delimiter;
        }
        if (blobs.length > 1) {
            var blob = blobs.pop();
            if (multiple) {
                multiple = new CSL.Blob(multiple.blobs,multiple);
                blobs.push(multiple);
            } else {
                if (single) {
                    single = new CSL.Blob(single.blobs,single);
                }
                blobs.push(single);
            }
            blobs.push(blob);
        }
    }
    this.state.output.openLevel();
    if (single && multiple) {
        this.state.output.current.value().strings.delimiter = "";
    }
    for (i = 0, ilen = blobs.length; i < ilen; i += 1) {
        this.state.output.append(blobs[i], false, true);
    }
    this.state.output.closeLevel();
    return this.state.output.pop();
};
CSL.NameOutput.prototype._getToken = function (tokenname) {
    var token = this[tokenname];
    if (tokenname === "institution") {
        var newtoken = new CSL.Token();
        return newtoken;
    }
    return token;
};
module.exports = CSL;
CSL.NameOutput.prototype.setCommonTerm = function () {
    var variables = this.variables;
    var varnames = variables.slice();
    varnames.sort();
    this.common_term = varnames.join("");
    if (!this.common_term) {
        return false;
    }
    var has_term = false;
    if (this.label && this.label[this.variables[0]]) {
        if (this.label[this.variables[0]].before) {
            has_term = this.state.getTerm(this.common_term, this.label[this.variables[0]].before.strings.form, 0);
        } else if (this.label[this.variables[0]].after) {
            has_term = this.state.getTerm(this.common_term, this.label[this.variables[0]].after.strings.form, 0);
        }
    }
    if (!this.state.locale[this.state.opt.lang].terms[this.common_term]
        || !has_term
        || this.variables.length < 2) {
        this.common_term = false;
        return;
    }
    var freeters_offset = 0;
    for (var i = 0, ilen = this.variables.length - 1; i < ilen; i += 1) {
        var v = this.variables[i];
        var vv = this.variables[i + 1];
        if (this.freeters[v].length || this.freeters[vv].length) {
            if (this.etal_spec[v].freeters !== this.etal_spec[vv].freeters
                || !this._compareNamesets(this.freeters[v], this.freeters[vv])) {
                this.common_term = false;
                return;
            }
            freeters_offset += 1;
        }
        if (this.persons[v].length !== this.persons[vv].length) {
            this.common_term = false;
            return;
        }
        for (var j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
            if (this.etal_spec[v].persons[j] !== this.etal_spec[vv].persons[j]
                || !this._compareNamesets(this.persons[v][j], this.persons[vv][j])) {
                this.common_term = false;
                return;
            }
        }
    }
};
CSL.NameOutput.prototype._compareNamesets = function (base_nameset, nameset) {
    if (base_nameset.length !== nameset.length) {
        return false;
    }
    for (var i = 0, ilen = nameset.length; i < ilen; i += 1) {
        var name = nameset[i];
        for (var j = 0, jlen = CSL.NAME_PARTS.length; j < jlen; j += 1) {
            var part = CSL.NAME_PARTS[j];
            if (!base_nameset[i] || base_nameset[i][part] != nameset[i][part]) {
                return false;
            }
        }
    }
    return true;
};
module.exports = CSL;
CSL.NameOutput.prototype.constrainNames = function () {
    this.names_count = 0;
    var pos;
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        pos = this.nameset_base + i;
        if (this.freeters[v].length) {
            this.state.tmp.names_max.push(this.freeters[v].length, "literal");
            this._imposeNameConstraints(this.freeters, this.freeters_count, v, pos);
            this.names_count += this.freeters[v].length;
        }
        if (this.institutions[v].length) {
            this.state.tmp.names_max.push(this.institutions[v].length, "literal");
            this._imposeNameConstraints(this.institutions, this.institutions_count, v, pos);
            this.persons[v] = this.persons[v].slice(0, this.institutions[v].length);
            this.names_count += this.institutions[v].length;
        }
        for (var j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
            if (this.persons[v][j].length) {
                this.state.tmp.names_max.push(this.persons[v][j].length, "literal");
                this._imposeNameConstraints(this.persons[v], this.persons_count[v], j, pos);
                this.names_count += this.persons[v][j].length;
            }
        }
    }
};
CSL.NameOutput.prototype._imposeNameConstraints = function (lst, count, key, pos) {
    var display_names = lst[key];
    var discretionary_names_length = this.state.tmp["et-al-min"];
    if (this.state.tmp.suppress_decorations) {
        if (this.state.tmp.disambig_request && this.state.tmp.disambig_request.names[pos]) {
            discretionary_names_length = this.state.tmp.disambig_request.names[pos];
        } else if (count[key] >= this.etal_min) {
            discretionary_names_length = this.etal_use_first;
        }
    } else {
        if (this.state.tmp.disambig_request 
            && this.state.tmp.disambig_request.names[pos] > this.etal_use_first) {
            if (count[key] < this.etal_min) {
                discretionary_names_length = count[key];
            } else {
                discretionary_names_length = this.state.tmp.disambig_request.names[pos];
            }
        } else if (count[key] >= this.etal_min) {
            discretionary_names_length = this.etal_use_first;
        }
        if (this.etal_use_last && discretionary_names_length > (this.etal_min - 2)) {
            discretionary_names_length = this.etal_min - 2;
        }
    }
    var sane = this.etal_min >= this.etal_use_first;
    var overlength = count[key] > discretionary_names_length;
    if (discretionary_names_length > count[key]) {
        discretionary_names_length = display_names.length;
    }
    if (sane && overlength) {
        if (this.etal_use_last) {
            lst[key] = display_names.slice(0, discretionary_names_length).concat(display_names.slice(-1));
        } else {
            lst[key] = display_names.slice(0, discretionary_names_length);
        }
    }
    this.state.tmp.disambig_settings.names[pos] = lst[key].length;
    this.state.disambiguate.padBase(this.state.tmp.disambig_settings);
};
module.exports = CSL;
CSL.NameOutput.prototype.disambigNames = function () {
    var pos;
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        pos = this.nameset_base + i;
        if (this.freeters[v].length) {
            this._runDisambigNames(this.freeters[v], pos);
        }
        if (this.institutions[v].length) {
            if ("undefined" === typeof this.state.tmp.disambig_settings.givens[pos]) {
                this.state.tmp.disambig_settings.givens[pos] = [];
            }
            for (var j=0,jlen=this.institutions[v].length;j<jlen;j+=1) {
                if ("undefined" === typeof this.state.tmp.disambig_settings.givens[pos][j]) {
                    this.state.tmp.disambig_settings.givens[pos].push(2);
                }
            }
        }
        for (var j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
            if (this.persons[v][j].length) {
                this._runDisambigNames(this.persons[v][j], pos);
            }
        }
    }
};
CSL.NameOutput.prototype._runDisambigNames = function (lst, pos) {
    var chk, myform, myinitials, param, i, ilen, paramx;
    for (i = 0, ilen = lst.length; i < ilen; i += 1) {
        if (!lst[i].given && !lst[i].family) {
            continue;
        }
        myinitials = this.state.inheritOpt(this.name, "initialize-with");
        this.state.registry.namereg.addname("" + this.Item.id, lst[i], i);
        chk = this.state.tmp.disambig_settings.givens[pos];
        if ("undefined" === typeof chk) {
            for (var j = 0, jlen = pos + 1; j < jlen; j += 1) {
                if (!this.state.tmp.disambig_settings.givens[j]) {
                    this.state.tmp.disambig_settings.givens[j] = [];
                }
            }
        }
        chk = this.state.tmp.disambig_settings.givens[pos][i];
        if ("undefined" === typeof chk) {
            myform = this.state.inheritOpt(this.name, "form", "name-form", "long");
            param = this.state.registry.namereg.evalname("" + this.Item.id, lst[i], i, 0, myform, myinitials);
            this.state.tmp.disambig_settings.givens[pos].push(param);
        }
        myform = this.state.inheritOpt(this.name, "form", "name-form", "long");
        paramx = this.state.registry.namereg.evalname("" + this.Item.id, lst[i], i, 0, myform, myinitials);
        if (this.state.tmp.disambig_request) {
            var val = this.state.tmp.disambig_settings.givens[pos][i];
            if (val === 1 && 
                this.state.citation.opt["givenname-disambiguation-rule"] === "by-cite" && 
                ("undefined" === typeof this.state.inheritOpt(this.name, "initialize-with")
                 || "undefined" === typeof lst[i].given)) {
                val = 2;
            }
            param = val;
            if (this.state.opt["disambiguate-add-givenname"] && lst[i].given) {
                param = this.state.registry.namereg.evalname("" + this.Item.id, lst[i], i, param, this.state.inheritOpt(this.name, "form", "name-form", "long"), this.state.inheritOpt(this.name, "initialize-with"));
            }
        } else {
            param = paramx;
        }
        if (!this.state.tmp.just_looking && this.item && this.item.position === CSL.POSITION_FIRST) {
            if (paramx > param) {
                param = paramx;
            }
        }
        if (!this.state.tmp.sort_key_flag) {
            this.state.tmp.disambig_settings.givens[pos][i] = param;
            if ("string" === typeof myinitials
                && ("undefined" === typeof this.name.strings["initialize"]
                    || true === this.name.strings["initialize"])) {
                this.state.tmp.disambig_settings.use_initials = true;
            }
        }
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.getEtAlConfig = function () {
    var item = this.item;
    this["et-al"] = {};
    this.state.output.append(this.etal_term, this.etal_style, true);
    this["et-al"].single = this.state.output.pop();
    this["et-al"].single.strings.suffix = this.etal_suffix;
    this["et-al"].single.strings.prefix = this.etal_prefix_single;
    this.state.output.append(this.etal_term, this.etal_style, true);
    this["et-al"].multiple = this.state.output.pop();
    this["et-al"].multiple.strings.suffix = this.etal_suffix;
    this["et-al"].multiple.strings.prefix = this.etal_prefix_multiple;
    if ("undefined" === typeof item) {
        item = {};
    }
    if (item.position) {
        if (this.state.inheritOpt(this.name, "et-al-subsequent-min")) {
            this.etal_min = this.state.inheritOpt(this.name, "et-al-subsequent-min");
        } else {
            this.etal_min = this.state.inheritOpt(this.name, "et-al-min");
        }
        if (this.state.inheritOpt(this.name, "et-al-subsequent-use-first")) {
            this.etal_use_first = this.state.inheritOpt(this.name, "et-al-subsequent-use-first");
        } else {
            this.etal_use_first = this.state.inheritOpt(this.name, "et-al-use-first");
        }
    } else {
        if (this.state.tmp["et-al-min"]) {
            this.etal_min = this.state.tmp["et-al-min"];
        } else {
            this.etal_min = this.state.inheritOpt(this.name, "et-al-min");
        }
        if (this.state.tmp["et-al-use-first"]) {
            this.etal_use_first = this.state.tmp["et-al-use-first"];
        } else {
            this.etal_use_first = this.state.inheritOpt(this.name, "et-al-use-first");
        }
        if ("boolean" === typeof this.state.tmp["et-al-use-last"]) {
            this.etal_use_last = this.state.tmp["et-al-use-last"];
        } else {
            this.etal_use_last = this.state.inheritOpt(this.name, "et-al-use-last");
        }
    }
    if (!this.state.tmp["et-al-min"]) {
        this.state.tmp["et-al-min"] = this.etal_min;
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.setEtAlParameters = function () {
    var i, ilen, j, jlen;
    for (i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        if ("undefined" === typeof this.etal_spec[v]) {
            this.etal_spec[v] = {freeters:0,institutions:0,persons:[]};
        }
        this.etal_spec[this.nameset_base + i] = this.etal_spec[v];
        if (this.freeters[v].length) {
            this._setEtAlParameter("freeters", v);
        }
        for (j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
            if ("undefined" === typeof this.etal_spec[v][j]) {
                this.etal_spec[v].persons[j] = 0;
            }
            this._setEtAlParameter("persons", v, j);
        }
        if (this.institutions[v].length) {
            this._setEtAlParameter("institutions", v);
        }
    }
};
CSL.NameOutput.prototype._setEtAlParameter = function (type, v, j) {
    var lst, count;
    if (type === "persons") {
        lst = this.persons[v][j];
        count = this.persons_count[v][j];
    } else {
        lst = this[type][v];
        count = this[type + "_count"][v];
    }
    if (lst.length < count && !this.state.tmp.sort_key_flag) {
        if (this.etal_use_last) {
            if (type === "persons") {
                this.etal_spec[v].persons[j] = 2
            } else {
                this.etal_spec[v][type] = 2;
            }
        } else {
            if (type === "persons") {
                this.etal_spec[v].persons[j] = 1;
            } else {
                this.etal_spec[v][type] = 1;
            }
        }
    } else {
        if (type === "persons") {
            this.etal_spec[v].persons[j] = 0;
        } else {
            this.etal_spec[v][type] = 0;
        }
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.renderAllNames = function () {
    var pos;
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        if (this.freeters[v].length || this.institutions[v].length) {
            if (!this.state.tmp.group_context.tip.condition) {
                this.state.tmp.just_did_number = false;
            }
        }
        pos = this.nameset_base + i;
        if (this.freeters[v].length) {
            this.freeters[v] = this._renderNames(v, this.freeters[v], pos);
        }
        for (var j = 0, jlen = this.institutions[v].length; j < jlen; j += 1) {
            this.persons[v][j] = this._renderNames(v, this.persons[v][j], pos, j);
        }
    }
    this.renderInstitutionNames();
};
CSL.NameOutput.prototype.renderInstitutionNames = function () {
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        for (var j = 0, jlen = this.institutions[v].length; j < jlen; j += 1) {
            var institution, institution_short, institution_long, short_style, long_style;
            var name = this.institutions[v][j];
            var j, ret, optLangTag, jlen, key, localesets;
            if (this.state.tmp.extension) {
                localesets = ["sort"];
            } else if (name.isInstitution || name.literal) {
                localesets = this.state.opt['cite-lang-prefs'].institutions;
            } else {
                localesets = this.state.opt['cite-lang-prefs'].persons;
            }
            var slot = {primary:'locale-orig',secondary:false,tertiary:false};
	        if (localesets) {
		        var slotnames = ["primary", "secondary", "tertiary"];
		        for (var k = 0, klen = slotnames.length; k < klen; k += 1) {
			        if (localesets.length - 1 <  k) {
				        break;
			        }
                    if (localesets[k]) {
			            slot[slotnames[k]] = 'locale-' + localesets[k];
                    }
		        }
	        } else {
		        slot.primary = 'locale-translat';
	        }
	        if (this.state.tmp.area !== "bibliography"
		        && !(this.state.tmp.area === "citation"
			         && this.state.opt.xclass === "note"
			         && this.item && !this.item.position)) {
		        slot.secondary = false;
		        slot.tertiary = false;
	        }
            var res;
            this.setRenderedName(name);
            var institution = this._renderInstitutionName(v, name, slot, j);
            this.institutions[v][j] = institution;
        }
    }
}
CSL.NameOutput.prototype._renderInstitutionName = function (v, name, slot, j) {
    var secondary, tertiary, long_style, short_style, institution, institution_short, institution_long;
    var res = this.getName(name, slot.primary, true);
    var primary = res.name;
    var usedOrig = res.usedOrig;
    if (primary) {
        primary = this.fixupInstitution(primary, v, j);
    }
	secondary = false;
	if (slot.secondary) {
        res = this.getName(name, slot.secondary, false, usedOrig);
        var secondary = res.name;
        usedOrig = res.usedOrig;
        if (secondary) {
			secondary = this.fixupInstitution(secondary, v, j);
        }
	}
	tertiary = false;
	if (slot.tertiary) {
        res = this.getName(name, slot.tertiary, false, usedOrig);
        tertiary = res.name;
        if (tertiary) {
			tertiary = this.fixupInstitution(tertiary, v, j);
        }
	}
    var n = {
        l: {
            pri: false,
            sec: false,
            ter: false
        },
        s: {
            pri: false,
            sec: false,
            ter: false
        }
    };
    if (primary) {
        n.l.pri = primary["long"];
        n.s.pri = primary["short"].length ? primary["short"] : primary["long"];
    }
    if (secondary) {
        n.l.sec = secondary["long"];
        n.s.sec = secondary["short"].length ? secondary["short"] : secondary["long"];
    }
    if (tertiary) {
        n.l.ter = tertiary["long"];
        n.s.ter = tertiary["short"].length ? tertiary["short"] : tertiary["long"];
    }
    switch (this.institution.strings["institution-parts"]) {
    case "short":
        if (primary["short"].length) {
            short_style = this._getShortStyle();
            institution = [this._composeOneInstitutionPart([n.s.pri, n.s.sec, n.s.ter], slot, short_style, v)];
        } else {
            long_style = this._getLongStyle(primary, v, j);
            institution = [this._composeOneInstitutionPart([n.l.pri, n.l.sec, n.l.ter], slot, long_style, v)];
        }
        break;
    case "short-long":
        long_style = this._getLongStyle(primary, v, j);
        short_style = this._getShortStyle();
        institution_short = this._renderOneInstitutionPart(primary["short"], short_style);
        institution_long = this._composeOneInstitutionPart([n.l.pri, n.l.sec, n.l.ter], slot, long_style, v);
        institution = [institution_short, institution_long];
        break;
    case "long-short":
        long_style = this._getLongStyle(primary, v, j);
        short_style = this._getShortStyle();
        institution_short = this._renderOneInstitutionPart(primary["short"], short_style);
        institution_long = this._composeOneInstitutionPart([n.l.pri, n.l.sec, n.l.ter], slot, long_style, v);
        institution = [institution_long, institution_short];
        break;
    default:
        long_style = this._getLongStyle(primary, v, j);
        institution = [this._composeOneInstitutionPart([n.l.pri, n.l.sec, n.l.ter], slot, long_style, v)];
        break;
    }
    var blob = this._join(institution, " ");
    this.state.tmp.name_node.children.push(blob);
    return blob;
};
CSL.NameOutput.prototype._composeOneInstitutionPart = function (names, slot, style, v) {
    var primary = false, secondary = false, tertiary = false, primary_tok, secondary_tok, tertiary_tok;
    if (names[0]) {
        primary_tok = CSL.Util.cloneToken(style);
        if (this.state.opt.citeAffixes[slot.primary]){
            if ("<i>" === this.state.opt.citeAffixes.institutions[slot.primary].prefix) {
                var hasItalic = false;
                for (var i = 0, ilen = primary_tok.decorations.length; i < ilen; i += 1) {
                    if (style.decorations[i][0] === "@font-style"
                        && primary_tok.decorations[i][1] === "italic") {
                        hasItalic = true;
                    }
                }
                if (!hasItalic) {
                    primary_tok.decorations.push(["@font-style", "italic"])
                }
            }
        }
        primary = this._renderOneInstitutionPart(names[0], primary_tok);
     }
    if (names[1]) {
        secondary = this._renderOneInstitutionPart(names[1], style);
    }
    if (names[2]) {
        tertiary = this._renderOneInstitutionPart(names[2], style);
    }
    var institutionblob;
    if (secondary || tertiary) {
        this.state.output.openLevel("empty");
        this.state.output.append(primary);
        secondary_tok = CSL.Util.cloneToken(style);
        if (slot.secondary) {
            secondary_tok.strings.prefix = this.state.opt.citeAffixes.institutions[slot.secondary].prefix;
            secondary_tok.strings.suffix = this.state.opt.citeAffixes.institutions[slot.secondary].suffix;
            if (!secondary_tok.strings.prefix) {
                secondary_tok.strings.prefix = " ";
            }
        }
        var secondary_outer = new CSL.Token();
        secondary_outer.decorations.push(["@font-style", "normal"]);
        secondary_outer.decorations.push(["@font-weight", "normal"]);
        this.state.output.openLevel(secondary_outer);
        this.state.output.append(secondary, secondary_tok);
        this.state.output.closeLevel();
        tertiary_tok = CSL.Util.cloneToken(style);
        if (slot.tertiary) {
            tertiary_tok.strings.prefix = this.state.opt.citeAffixes.institutions[slot.tertiary].prefix;
            tertiary_tok.strings.suffix = this.state.opt.citeAffixes.institutions[slot.tertiary].suffix;
            if (!tertiary_tok.strings.prefix) {
                tertiary_tok.strings.prefix = " ";
            }
        }
        var tertiary_outer = new CSL.Token();
        tertiary_outer.decorations.push(["@font-style", "normal"]);
        tertiary_outer.decorations.push(["@font-weight", "normal"]);
        this.state.output.openLevel(tertiary_outer);
        this.state.output.append(tertiary, tertiary_tok);
        this.state.output.closeLevel();
        this.state.output.closeLevel();
        institutionblob = this.state.output.pop();
    } else {
        institutionblob = primary;
    }
    return institutionblob;
}
CSL.NameOutput.prototype._renderOneInstitutionPart = function (blobs, style) {
    for (var i = 0, ilen = blobs.length; i < ilen; i += 1) {
        if (blobs[i]) {
            var str = blobs[i];
            if (this.state.tmp.strip_periods) {
                str = str.replace(/\./g, "");
            } else {
                for (var j = 0, jlen = style.decorations.length; j < jlen; j += 1) {
                    if ("@strip-periods" === style.decorations[j][0] && "true" === style.decorations[j][1]) {
                        str = str.replace(/\./g, "");
                        break;
                    }
                }
            }
            this.state.tmp.group_context.tip.variable_success = true;
            this.state.tmp.can_substitute.replace(false, CSL.LITERAL);
            if (str === "!here>>>") {
                blobs[i] = false;
            } else {
                this.state.output.append(str, style, true);
                blobs[i] = this.state.output.pop();
            }
        }
    }
    if ("undefined" === typeof this.institution.strings["part-separator"]) {
        this.institution.strings["part-separator"] = this.state.tmp.name_delimiter;
    }
    return this._join(blobs, this.institution.strings["part-separator"]);
};
CSL.NameOutput.prototype._renderNames = function (v, values, pos, j) {
    var ret = false;
    if (values.length) {
        var names = [];
        for (var i = 0, ilen = values.length; i < ilen; i += 1) {
            var name = values[i];
            var ret, optLangTag, jlen, key, localesets;
            if (this.state.tmp.extension) {
                localesets = ["sort"];
            } else if (name.isInstitution || name.literal) {
                localesets = this.state.opt['cite-lang-prefs'].institutions;
            } else {
                localesets = this.state.opt['cite-lang-prefs'].persons;
            }
            var slot = {primary:'locale-orig',secondary:false,tertiary:false};
	        if (localesets) {
		        var slotnames = ["primary", "secondary", "tertiary"];
		        for (var k = 0, klen = slotnames.length; k < klen; k += 1) {
			        if (localesets.length - 1 <  k) {
				        break;
			        }
			        slot[slotnames[k]] = 'locale-' + localesets[k];
		        }
	        } else {
		        slot.primary = 'locale-translat';
	        }
	        if (this.state.tmp.sort_key_flag || (this.state.tmp.area !== "bibliography"
		        && !(this.state.tmp.area === "citation"
			         && this.state.opt.xclass === "note"
			         && this.item && !this.item.position))) {
		        slot.secondary = false;
		        slot.tertiary = false;
	        }
            this.setRenderedName(name);
            if (!name.literal && !name.isInstitution) {
                var nameBlob = this._renderPersonalName(v, name, slot, pos, i, j);
                var nameToken = CSL.Util.cloneToken(this.name);
                this.state.output.append(nameBlob, nameToken, true);
                names.push(this.state.output.pop());
            } else {
                names.push(this._renderInstitutionName(v, name, slot, j));
            }
        }
        ret = this.joinPersons(names, pos, j);
    }
    return ret
}
CSL.NameOutput.prototype._renderPersonalName = function (v, name, slot, pos, i, j) {
    var res = this.getName(name, slot.primary, true);
    var primary = this._renderOnePersonalName(res.name, pos, i, j);
	var secondary = false;
	if (slot.secondary) {
        res = this.getName(name, slot.secondary, false, res.usedOrig);
        if (res.name) {
			secondary = this._renderOnePersonalName(res.name, pos, i, j);
        }
	}
	var tertiary = false;
	if (slot.tertiary) {
        res = this.getName(name, slot.tertiary, false, res.usedOrig);
        if (res.name) {
			tertiary = this._renderOnePersonalName(res.name, pos, i, j);
        }
	}
    var personblob;
    if (secondary || tertiary) {
        this.state.output.openLevel("empty");
        this.state.output.append(primary);
        var secondary_tok = new CSL.Token();
        if (slot.secondary) {
            secondary_tok.strings.prefix = this.state.opt.citeAffixes.persons[slot.secondary].prefix;
            secondary_tok.strings.suffix = this.state.opt.citeAffixes.persons[slot.secondary].suffix;
            if (!secondary_tok.strings.prefix) {
                secondary_tok.strings.prefix = " ";
            }
        }
        this.state.output.append(secondary, secondary_tok);
        var tertiary_tok = new CSL.Token();
        if (slot.tertiary) {
            tertiary_tok.strings.prefix = this.state.opt.citeAffixes.persons[slot.tertiary].prefix;
            tertiary_tok.strings.suffix = this.state.opt.citeAffixes.persons[slot.tertiary].suffix;
            if (!tertiary_tok.strings.prefix) {
                tertiary_tok.strings.prefix = " ";
            }
        }
        this.state.output.append(tertiary, tertiary_tok);
        this.state.output.closeLevel();
        personblob = this.state.output.pop();
    } else {
        personblob = primary;
    }
    return personblob;
};
CSL.NameOutput.prototype._isRomanesque = function (name) {
    var ret = 2;
    if (!name.family.replace(/\"/g, '').match(CSL.ROMANESQUE_REGEXP)) {
        ret = 0;
    }
    if (!ret && name.given && name.given.match(CSL.STARTSWITH_ROMANESQUE_REGEXP)) {
        ret = 1;
    }
    if (ret == 2) {
        if (name.multi && name.multi.main) {
            var top_locale = name.multi.main.slice(0, 2);
        } else if (this.Item.language) {
            top_locale = this.Item.language.slice(0, 2);
        }
        if (["ja", "zh"].indexOf(top_locale) > -1) {
            ret = 1;
        }
    }
    return ret;
};
CSL.NameOutput.prototype._renderOnePersonalName = function (value, pos, i, j) {
    var name = value;
    var dropping_particle = this._droppingParticle(name, pos, j);
    var family = this._familyName(name);
    var non_dropping_particle = this._nonDroppingParticle(name);
    var given = this._givenName(name, pos, i);
    var suffix = this._nameSuffix(name);
    if (given === false) {
        dropping_particle = false;
        suffix = false;
    }
    var sort_sep = this.state.inheritOpt(this.name, "sort-separator");
    if (!sort_sep) {
        sort_sep = "";
    }
    var suffix_sep;
    if (name["comma-suffix"]) {
        suffix_sep = ", ";
    } else {
        suffix_sep = " ";
    }
    var romanesque = this._isRomanesque(name);
    function hasJoiningPunctuation(blob) {
        if (!blob) {
            return false;
        } else if ("string" === typeof blob.blobs) {
            if (["\u2019", "\'", "-", " "].indexOf(blob.blobs.slice(-1)) > -1) {
                return true;
            } else {
                return false;
            }
        } else {
            return hasJoiningPunctuation(blob.blobs[blob.blobs.length-1]);
        }
    }
    var has_hyphenated_non_dropping_particle = hasJoiningPunctuation(non_dropping_particle);
    var blob, merged, first, second;
    if (romanesque === 0) {
        blob = this._join([non_dropping_particle, family, given], "");
    } else if (romanesque === 1 || name["static-ordering"]) { // entry likes sort order
        blob = this._join([non_dropping_particle, family, given], " ");
    } else if (name["reverse-ordering"]) { // entry likes reverse order
        blob = this._join([given, non_dropping_particle, family], " ");
    } else if (this.state.tmp.sort_key_flag) {
        if (this.state.opt["demote-non-dropping-particle"] === "never") {
            first = this._join([non_dropping_particle, family, dropping_particle], " ");
            merged = this._join([first, given], this.state.opt.sort_sep);
            blob = this._join([merged, suffix], " ");
        } else {
            second = this._join([given, dropping_particle, non_dropping_particle], " ");
            merged = this._join([family, second], this.state.opt.sort_sep);
            blob = this._join([merged, suffix], " ");
        }
    } else if (this.state.inheritOpt(this.name, "name-as-sort-order") === "all" || (this.state.inheritOpt(this.name, "name-as-sort-order") === "first" && i === 0 && (j === 0 || "undefined" === typeof j))) {
        if (["Lord", "Lady"].indexOf(name.given) > -1) {
            sort_sep = ", ";
        }
        if (["always", "display-and-sort"].indexOf(this.state.opt["demote-non-dropping-particle"]) > -1) {
            second = this._join([given, dropping_particle], (name["comma-dropping-particle"] + " "));
            second = this._join([second, non_dropping_particle], " ");
            if (second && this.given) {
                second.strings.prefix = this.given.strings.prefix;
                second.strings.suffix = this.given.strings.suffix;
            }
            if (family && this.family) {
                family.strings.prefix = this.family.strings.prefix;
                family.strings.suffix = this.family.strings.suffix;
            }
            merged = this._join([family, second], sort_sep);
            blob = this._join([merged, suffix], sort_sep);
        } else {
            if (has_hyphenated_non_dropping_particle) {
                first = this._join([non_dropping_particle, family], "");
            } else {
                first = this._join([non_dropping_particle, family], " ");
            }
            if (first && this.family) {
                first.strings.prefix = this.family.strings.prefix;
                first.strings.suffix = this.family.strings.suffix;
            }
            second = this._join([given, dropping_particle], (name["comma-dropping-particle"] + " "));
            if (second && this.given) {
                second.strings.prefix = this.given.strings.prefix;
                second.strings.suffix = this.given.strings.suffix;
            }
            merged = this._join([first, second], sort_sep);
            blob = this._join([merged, suffix], sort_sep);
        }
    } else { // plain vanilla
        if (name["dropping-particle"] && name.family && !name["non-dropping-particle"]) {
            if (["'","\u02bc","\u2019","-"].indexOf(name["dropping-particle"].slice(-1)) > -1) {
                family = this._join([dropping_particle, family], "");
                dropping_particle = false;
            }
        }
        if (!this.state.tmp.term_predecessor) {
        }
        var space = " ";
        if (this.state.inheritOpt(this.name, "initialize-with")
            && this.state.inheritOpt(this.name, "initialize-with").match(/[\u00a0\ufeff]/)
            && ["fr", "ru", "cs"].indexOf(this.state.opt["default-locale"][0].slice(0, 2)) > -1) {
            space = "\u00a0"
        }
        if (has_hyphenated_non_dropping_particle) {
            second = this._join([non_dropping_particle, family], "");
            second = this._join([dropping_particle, second], space);
        } else {
            second = this._join([dropping_particle, non_dropping_particle, family], space);
        }
        second = this._join([second, suffix], suffix_sep);
        if (second && this.family) {
            second.strings.prefix = this.family.strings.prefix;
            second.strings.suffix = this.family.strings.suffix;
        }
        if (given && this.given) {
            given.strings.prefix = this.given.strings.prefix;
            given.strings.suffix = this.given.strings.suffix;
        }
        if (second.strings.prefix) {
            name["comma-dropping-particle"] = "";
        }
        blob = this._join([given, second], (name["comma-dropping-particle"] + space));
    }
    this.state.tmp.group_context.tip.variable_success = true;
    this.state.tmp.can_substitute.replace(false, CSL.LITERAL);
    this.state.tmp.term_predecessor = true;
    this.state.tmp.name_node.children.push(blob);
    return blob;
};
CSL.NameOutput.prototype._normalizeNameInput = function (value) {
    var name = {
        literal:value.literal,
        family:value.family,
        isInstitution:value.isInstitution,
        given:value.given,
        suffix:value.suffix,
        "comma-suffix":value["comma-suffix"],
        "non-dropping-particle":value["non-dropping-particle"],
        "dropping-particle":value["dropping-particle"],
        "static-ordering":value["static-ordering"],
        "static-particles":value["static-particles"],
        "reverse-ordering":value["reverse-ordering"],
        "full-form-always": value["full-form-always"],
        "parse-names":value["parse-names"],
        "comma-dropping-particle": "",
        block_initialize:value.block_initialize,
        multi:value.multi
    };
    this._parseName(name);
    return name;
};
CSL.NameOutput.prototype._stripPeriods = function (tokname, str) {
    var decor_tok = this[tokname + "_decor"];
    if (str) {
        if (this.state.tmp.strip_periods) {
            str = str.replace(/\./g, "");
        } else  if (decor_tok) {
            for (var i = 0, ilen = decor_tok.decorations.length; i < ilen; i += 1) {
                if ("@strip-periods" === decor_tok.decorations[i][0] && "true" === decor_tok.decorations[i][1]) {
                    str = str.replace(/\./g, "");
                    break;
                }
            }
        }
    }
    return str;
};
CSL.NameOutput.prototype._nonDroppingParticle = function (name) {
    var ndp = name["non-dropping-particle"];
    if (ndp && this.state.tmp.sort_key_flag) {
        ndp = ndp.replace(/[\'\u2019]/, "");
    }
    var str = this._stripPeriods("family", ndp);
    if (this.state.output.append(str, this.family_decor, true)) {
        return this.state.output.pop();
    }
    return false;
};
CSL.NameOutput.prototype._droppingParticle = function (name, pos, j) {
    var dp = name["dropping-particle"];
    if (dp && this.state.tmp.sort_key_flag) {
        dp = dp.replace(/[\'\u2019]/, "");
    }
    var str = this._stripPeriods("given", dp);
    if (name["dropping-particle"] && name["dropping-particle"].match(/^et.?al[^a-z]$/)) {
        if (this.state.inheritOpt(this.name, "et-al-use-last")) {
            if ("undefined" === typeof j) { 
                this.etal_spec[pos].freeters = 2;
            } else {
                this.etal_spec[pos].persons = 2;
            }
        } else {
            if ("undefined" === typeof j) { 
                this.etal_spec[pos].freeters = 1;
            } else {
                this.etal_spec[pos].persons = 1;
            }
        }
        name["comma-dropping-particle"] = "";
    } else if (this.state.output.append(str, this.given_decor, true)) {
        return this.state.output.pop();
    }
    return false;
};
CSL.NameOutput.prototype._familyName = function (name) {
    var str = this._stripPeriods("family", name.family);
    if (this.state.output.append(str, this.family_decor, true)) {
        return this.state.output.pop();
    }
    return false;
};
CSL.NameOutput.prototype._givenName = function (name, pos, i) {
    var ret;
    var formIsShort = this.state.inheritOpt(this.name, "form", "name-form", "long") !== "long";
    var initializeIsTurnedOn = !(this.state.inheritOpt(this.name, "initialize") === false);
    var hasInitializeWith = "string" === typeof this.state.inheritOpt(this.name, "initialize-with") && !name.block_initialize;
    var inBibliography = this.state.tmp.area.slice(0, 12) === "bibliography";
    var defaultLevel;
    var useLevel;
    if (name["full-form-always"]) {
        useLevel = 2;
    } else {
        if (formIsShort) {
            defaultLevel = 0;
        } else if (hasInitializeWith) {
            defaultLevel = 1;
        } else {
            defaultLevel = 2;
        }
        var requestedLevel = this.state.tmp.disambig_settings.givens[pos][i];
        if (requestedLevel > defaultLevel) {
            useLevel = requestedLevel;
        } else {
            useLevel = defaultLevel;
        }
    }
    var gdropt = this.state.citation.opt["givenname-disambiguation-rule"];
   if (gdropt && gdropt.slice(-14) === "-with-initials") {
        hasInitializeWith = true;
    }
    if (name.family && useLevel === 1) {
        if (hasInitializeWith) {
            var initialize_with = this.state.inheritOpt(this.name, "initialize-with", false, "");
            name.given = CSL.Util.Names.initializeWith(this.state, name.given, initialize_with, !initializeIsTurnedOn);
        } else {
            name.given = CSL.Util.Names.unInitialize(this.state, name.given);
        }
    } else if (useLevel === 0) {
        return false;
    } else if (useLevel === 2) {
        name.given = CSL.Util.Names.unInitialize(this.state, name.given);
    }
    var str = this._stripPeriods("given", name.given);
    var rendered = this.state.output.append(str, this.given_decor, true);
    if (rendered) {
        ret = this.state.output.pop();
	    return ret;
    }
    return false;
};
CSL.NameOutput.prototype._nameSuffix = function (name) {
    var str = name.suffix, ret;
    if ("string" === typeof this.state.inheritOpt(this.name, "initialize-with")) {
        str = CSL.Util.Names.initializeWith(this.state, name.suffix, this.state.inheritOpt(this.name, "initialize-with"), true);
    }
    str = this._stripPeriods("family", str);
    var toSuffix = '';
    if (str && str.slice(-1) === '.') {
	str = str.slice(0, -1);
	toSuffix = '.';
    }
    var rendered = this.state.output.append(str, "empty", true);
    if (rendered) {
        ret = this.state.output.pop();
	ret.strings.suffix = toSuffix + ret.strings.suffix;
	return ret;
    }
    return false;
};
CSL.NameOutput.prototype._getLongStyle = function (name, v, i) {
    var long_style, short_style;
    if (name["short"].length) {
        if (this.institutionpart["long-with-short"]) {
            long_style = this.institutionpart["long-with-short"];
        } else {
            long_style = this.institutionpart["long"];
        }
    } else {
        long_style = this.institutionpart["long"];
    }
    if (!long_style) {
        long_style = new CSL.Token();
    }
    return long_style;
};
CSL.NameOutput.prototype._getShortStyle = function () {
    var short_style;
    if (this.institutionpart["short"]) {
        short_style = this.institutionpart["short"];
    } else {
        short_style = new CSL.Token();
    }
    return short_style;
};
CSL.NameOutput.prototype._parseName = function (name) {
    var m, idx;
    if (!name["parse-names"] && "undefined" !== typeof name["parse-names"]) {
        return name;
    }
    if (name.family && !name.given && name.isInstitution) {
        name.literal = name.family;
        name.family = undefined;
        name.isInstitution = undefined;
    }
    var noparse;
    if (name.family 
        && (name.family.slice(0, 1) === '"' && name.family.slice(-1) === '"')
        || (!name["parse-names"] && "undefined" !== typeof name["parse-names"])) {
        name.family = name.family.slice(1, -1);
        noparse = true;
        name["parse-names"] = 0;
    } else {
        noparse = false;
    }
    if (this.state.opt.development_extensions.parse_names) {
        if (!name["non-dropping-particle"] && name.family && !noparse && name.given) {
            if (!name["static-particles"]) {
                CSL.parseParticles(name, true);
            }
        }
    }
};
CSL.NameOutput.prototype.getName = function (name, slotLocaleset, fallback, stopOrig) {
    if (stopOrig && slotLocaleset === 'locale-orig') {
        return {name:false,usedOrig:stopOrig};
    }
    if (!name.family) {
        name.family = "";
    }
    if (!name.given) {
        name.given = "";
    }
    var name_params = {};
    name_params["static-ordering"] = this.getStaticOrder(name);
    var foundTag = true;
    if (slotLocaleset !== 'locale-orig') {
        foundTag = false;
        if (name.multi) {
            var langTags = this.state.opt[slotLocaleset]
            for (var i = 0, ilen = langTags.length; i < ilen; i += 1) {
                langTag = langTags[i];
                if (name.multi._key[langTag]) {
                    foundTag = true;
                    var isInstitution = name.isInstitution;
                    name = name.multi._key[langTag];
                    name.isInstitution = isInstitution;
                    name_params = this.getNameParams(langTag);
                    name_params.transliterated = true;
                    break;
                }
            }
        }
    }
    if (!foundTag) {
        var langTag = false;
        if (name.multi && name.multi.main) {
            langTag = name.multi.main;
        } else if (this.Item.language) {
            langTag = this.Item.language;
        }
        if (langTag) {
            name_params = this.getNameParams(langTag);
        }
    }
    if (!fallback && !foundTag) {
        return {name:false,usedOrig:stopOrig};
    }
    if (!name.family) {
        name.family = "";
    }
    if (!name.given) {
        name.given = "";
    }
    name = {
        family:name.family,
        given:name.given,
        "non-dropping-particle":name["non-dropping-particle"],
        "dropping-particle":name["dropping-particle"],
        suffix:name.suffix,
        "static-ordering":name_params["static-ordering"],
        "static-particles":name["static-particles"],
        "reverse-ordering":name_params["reverse-ordering"],
        "full-form-always": name_params["full-form-always"],
        "parse-names":name["parse-names"],
        "comma-suffix":name["comma-suffix"],
        "comma-dropping-particle":name["comma-dropping-particle"],
        transliterated: name_params.transliterated,
        block_initialize: name_params["block-initialize"],
        literal:name.literal,
        isInstitution:name.isInstitution,
        multi:name.multi
    };
    if (!name.literal && (!name.given && name.family && name.isInstitution)) {
        name.literal = name.family;
    }
    if (name.literal) {
        delete name.family;
        delete name.given;
    }
    name = this._normalizeNameInput(name);
    var usedOrig;
    if (stopOrig) {
        usedOrig = stopOrig;
    } else {
        usedOrig = !foundTag;
    }
    return {name:name,usedOrig:usedOrig};
}
CSL.NameOutput.prototype.getNameParams = function (langTag) {
    var ret = {};
    var langspec = CSL.localeResolve(this.Item.language, this.state.opt["default-locale"][0]);
    var try_locale = this.state.locale[langspec.best] ? langspec.best : this.state.opt["default-locale"][0];
    var name_as_sort_order = this.state.locale[try_locale].opts["name-as-sort-order"]
    var name_as_reverse_order = this.state.locale[try_locale].opts["name-as-reverse-order"]
    var name_never_short = this.state.locale[try_locale].opts["name-never-short"]
    var field_lang_bare = langTag.split("-")[0];
    if (name_as_sort_order && name_as_sort_order[field_lang_bare]) {
        ret["static-ordering"] = true;
        ret["reverse-ordering"] = false;
    }
    if (name_as_reverse_order && name_as_reverse_order[field_lang_bare]) {
        ret["reverse-ordering"] = true;
        ret["static-ordering"] = false;
    }
    if (name_never_short && name_never_short[field_lang_bare]) {
        ret["full-form-always"] = true;
    }
    if (ret["static-ordering"]) {
        ret["block-initialize"] = true;
    }
    return ret;
}
CSL.NameOutput.prototype.setRenderedName = function (name) {
    if (this.state.tmp.area === "bibliography") {
        var strname = "";
        for (var j=0,jlen=CSL.NAME_PARTS.length;j<jlen;j+=1) {
            if (name[CSL.NAME_PARTS[j]]) {
                strname += name[CSL.NAME_PARTS[j]];
            }
        }
        this.state.tmp.rendered_name.push(strname);
    }
}
CSL.NameOutput.prototype.fixupInstitution = function (name, varname, listpos) {
    if (this.state.sys.getHumanForm && "legal_case" === this.Item.type && "authority" === varname) {
        name.literal = this.state.sys.getHumanForm(this.Item.jurisdiction, name.literal, true);
    }
    name = this._splitInstitution(name, varname, listpos);
    if (this.institution.strings["reverse-order"]) {
        name["long"].reverse();
    }
    var long_form = name["long"];
    var short_form = name["long"].slice();
    var use_short_form = false;
    if (this.state.sys.getAbbreviation) {
        var jurisdiction = this.Item.jurisdiction;
        for (var j = 0, jlen = long_form.length; j < jlen; j += 1) {
            var normalizedKey = long_form[j];
            if (this.state.sys.normalizeAbbrevsKey) {
                normalizedKey = this.state.sys.normalizeAbbrevsKey(varname, long_form[j]);
            }
            jurisdiction = this.state.transform.loadAbbreviation(jurisdiction, "institution-part", normalizedKey);
            if (this.state.transform.abbrevs[jurisdiction]["institution-part"][normalizedKey]) {
                short_form[j] = this.state.transform.abbrevs[jurisdiction]["institution-part"][normalizedKey];
                use_short_form = true;
            }
        }
    }
    if (use_short_form) {
        name["short"] = short_form;
    } else {
        name["short"] = [];
    }
    return name;
}
CSL.NameOutput.prototype.getStaticOrder = function (name, refresh) {
    var static_ordering_val = false;
    if (!refresh && name["static-ordering"]) {
        static_ordering_val = true;
    } else if (this._isRomanesque(name) === 0) {
        static_ordering_val = true;
    } else if ((!name.multi || !name.multi.main) && this.Item.language && ['vi', 'hu'].indexOf(this.Item.language) > -1) {
        static_ordering_val = true;
    } else if (name.multi && name.multi.main && ['vi', 'hu'].indexOf(name.multi.main.slice(0,2)) > -1) {
        static_ordering_val = true;
    } else {
        if (this.state.opt['auto-vietnamese-names']
            && (CSL.VIETNAMESE_NAMES.exec(name.family + " " + name.given)
                && CSL.VIETNAMESE_SPECIALS.exec(name.family + name.given))) {
            static_ordering_val = true;
        }
    }
    return static_ordering_val;
}
CSL.NameOutput.prototype._splitInstitution = function (value, v, i) {
    var ret = {};
    if (!value.literal && value.family) {
        value.literal = value.family;
        delete value.family;
    }
    var splitInstitution = value.literal.replace(/\s*\|\s*/g, "|");
    splitInstitution = splitInstitution.split("|");
    if (this.institution.strings.form === "short" && this.state.sys.getAbbreviation) {
        var jurisdiction = this.Item.jurisdiction;
        for (var j = splitInstitution.length; j > 0; j += -1) {
            var str = splitInstitution.slice(0, j).join("|");
            var normalizedKey = str;
            if (this.state.sys.normalizeAbbrevsKey) {
                normalizedKey = this.state.sys.normalizeAbbrevsKey(v, str);
            }
            jurisdiction = this.state.transform.loadAbbreviation(jurisdiction, "institution-entire", normalizedKey);
            if (this.state.transform.abbrevs[jurisdiction]["institution-entire"][normalizedKey]) {
                var splitLst = this.state.transform.abbrevs[jurisdiction]["institution-entire"][normalizedKey];
                splitLst = this.state.transform.quashCheck(splitLst);
                var splitSplitLst = splitLst.split(/>>[0-9]{4}>>/);
                var m = splitLst.match(/>>([0-9]{4})>>/);
                splitLst = splitSplitLst.pop();
                if (splitSplitLst.length > 0 && this.Item["original-date"] && this.Item["original-date"].year) {
                    for (var k=m.length - 1; k > 0; k += -1) {
                        if (parseInt(this.Item["original-date"].year, 10) >= parseInt(m[k], 10)) {
                            break;
                        }
                        splitLst = splitSplitLst.pop();
                    }
                }
                splitLst = splitLst.replace(/\s*\|\s*/g, "|");
                splitInstitution = [splitLst];
                break;
            }
        }
    }
    splitInstitution.reverse();
    ret["long"] = this._trimInstitution(splitInstitution, v, i);
    return ret;
};
CSL.NameOutput.prototype._trimInstitution = function (subunits, v, i) {
    var use_first = false;
    var append_last = false;
    var s = subunits.slice();
    var stop_last = false;
    if (this.institution) {
        if ("undefined" !== typeof this.institution.strings["use-first"]) {
            use_first = this.institution.strings["use-first"];
        }
        if ("undefined" !== typeof this.institution.strings["stop-last"]) {
            stop_last = this.institution.strings["stop-last"];
        } else if ("authority" === v && this.state.tmp.authority_stop_last) {
            stop_last = this.state.tmp.authority_stop_last;
        }
        if (stop_last) {
            s = s.slice(0, stop_last);
            subunits = subunits.slice(0, stop_last);
        }
        if ("undefined" !== typeof this.institution.strings["use-last"]) {
            append_last = this.institution.strings["use-last"];
        }
        if ("authority" === v) {
            if (stop_last) {
                this.state.tmp.authority_stop_last = stop_last;
            }
            if (append_last)  {
                this.state.tmp.authority_stop_last += (append_last * -1);
            }
        }
    }
    if (false === use_first) {
        if (this.persons[v].length === 0) {
            use_first = this.institution.strings["substitute-use-first"];
        }
        if (!use_first) {
            use_first = 0;
        }
    }
    if (false === append_last) {
        if (!use_first) {
            append_last = subunits.length;
        } else {
            append_last = 0;
        }
    }
    if (use_first > subunits.length - append_last) {
        use_first = subunits.length - append_last;
    }
    subunits = subunits.slice(0, use_first);
    s = s.slice(use_first);
    if (append_last) {
        if (append_last > s.length) {
            append_last = s.length;
        }
        if (append_last) {
            subunits = subunits.concat(s.slice((s.length - append_last)));
        }
    }
    return subunits;
};
module.exports = CSL;
CSL.PublisherOutput = function (state, group_tok) {
    this.state = state;
    this.group_tok = group_tok;
    this.varlist = [];
};
CSL.PublisherOutput.prototype.render = function () {
    this.clearVars();
    this.composeAndBlob();
    this.composeElements();
    this.composePublishers();
    this.joinPublishers();
};
CSL.PublisherOutput.prototype.composeAndBlob = function () {
    this.and_blob = {};
    var and_term = false;
    if (this.group_tok.strings.and === "text") {
        and_term = this.state.getTerm("and");
    } else if (this.group_tok.strings.and === "symbol") {
        and_term = "&";
    }
    var tok = new CSL.Token();
    tok.strings.suffix = " ";
    tok.strings.prefix = " ";
    this.state.output.append(and_term, tok, true);
    var no_delim = this.state.output.pop();
    tok.strings.prefix = this.group_tok.strings["subgroup-delimiter"];
    this.state.output.append(and_term, tok, true);
    var with_delim = this.state.output.pop();
    this.and_blob.single = false;
    this.and_blob.multiple = false;
    if (and_term) {
        if (this.group_tok.strings["subgroup-delimiter-precedes-last"] === "always") {
            this.and_blob.single = with_delim;
        } else if (this.group_tok.strings["subgroup-delimiter-precedes-last"] === "never") {
            this.and_blob.single = no_delim;
            this.and_blob.multiple = no_delim;
        } else {
            this.and_blob.single = no_delim;
            this.and_blob.multiple = with_delim;
        }
    }
};
CSL.PublisherOutput.prototype.composeElements = function () {
    for (var i = 0, ilen = 2; i < ilen; i += 1) {
        var varname = ["publisher", "publisher-place"][i];
        for (var j = 0, jlen = this["publisher-list"].length; j < jlen; j += 1) {
            var str = this[varname + "-list"][j];
            var tok = this[varname + "-token"];
            this.state.output.append(str, tok, true);
            this[varname + "-list"][j] = this.state.output.pop();
        }
    }
};
CSL.PublisherOutput.prototype.composePublishers = function () {
    var blobs;
    for (var i = 0, ilen = this["publisher-list"].length; i < ilen; i += 1) {
        var ordered_list = [];
        blobs = [this[this.varlist[0] + "-list"][i], this[this.varlist[1] + "-list"][i]];
        this["publisher-list"][i] = this._join(blobs, this.group_tok.strings.delimiter);
    }
};
CSL.PublisherOutput.prototype.joinPublishers = function () {
    var blobs = this["publisher-list"];
    var delim = this.name_delimiter;
    var publishers = this._join(blobs, this.group_tok.strings["subgroup-delimiter"], this.and_blob.single, this.and_blob.multiple, this.group_tok);
    this.state.output.append(publishers, "literal");
};
CSL.PublisherOutput.prototype._join = CSL.NameOutput.prototype._join;
CSL.PublisherOutput.prototype._getToken = CSL.NameOutput.prototype._getToken;
CSL.PublisherOutput.prototype.clearVars = function () {
    this.state.tmp["publisher-list"] = false;
    this.state.tmp["publisher-place-list"] = false;
    this.state.tmp["publisher-group-token"] = false;
    this.state.tmp["publisher-token"] = false;
    this.state.tmp["publisher-place-token"] = false;
};
module.exports = CSL;
CSL.evaluateLabel = function (node, state, Item, item) {
    var myterm;
    if ("locator" === node.strings.term) {
        if (item && item.label) {
            if (item.label === "sub verbo") {
                myterm = "sub-verbo";
            } else {
                myterm = item.label;
            }
        }
        if (!myterm) {
            myterm = "page";
        }
    } else {
        myterm = node.strings.term;
    }
    var plural = node.strings.plural;
    if ("number" !== typeof plural) {
        var theItem = node.strings.term === "locator" ? item : Item;
        state.processNumber(false, theItem, node.strings.term, Item.type);
        plural = state.tmp.shadow_numbers[node.strings.term].plural;
        if (!state.tmp.shadow_numbers[node.strings.term].labelForm
           && !state.tmp.shadow_numbers[node.strings.term].labelDecorations) {
            state.tmp.shadow_numbers[node.strings.term].labelForm = node.strings.form;
            state.tmp.shadow_numbers[node.strings.term].labelCapitalizeIfFirst = node.strings.capitalize_if_first;
            state.tmp.shadow_numbers[node.strings.term].labelDecorations = node.decorations.slice();
        }
        if (["locator", "number", "page"].indexOf(node.strings.term) > -1 && state.tmp.shadow_numbers[node.strings.term].label) {
            myterm = state.tmp.shadow_numbers[node.strings.term].label;
        }
        if (node.decorations && (state.opt.development_extensions.csl_reverse_lookup_support || state.sys.csl_reverse_lookup_support)) {
            node.decorations.reverse();
            node.decorations.push(["@showid","true", node.cslid]);
            node.decorations.reverse();
        }
    }
    return CSL.castLabel(state, node, myterm, plural, CSL.TOLERANT);
};
CSL.castLabel = function (state, node, term, plural, mode) {
    var label_form = node.strings.form;
    var label_capitalize_if_first = node.strings.capitalize_if_first;
    if (state.tmp.group_context.tip.label_form && label_form !== "static") {
        label_form = state.tmp.group_context.tip.label_form;
    }
    if (state.tmp.group_context.tip.label_capitalize_if_first) {
        label_capitalize_if_first = state.tmp.group_context.tip.label_capitalize_if_first;
    }
    var ret = state.getTerm(term, label_form, plural, false, mode, node.default_locale);
    if (label_capitalize_if_first) {
        ret = CSL.Output.Formatters["capitalize-first"](state, ret);
    }
    if (state.tmp.strip_periods) {
        ret = ret.replace(/\./g, "");
    } else {
        for (var i = 0, ilen = node.decorations.length; i < ilen; i += 1) {
            if ("@strip-periods" === node.decorations[i][0] && "true" === node.decorations[i][1]) {
                ret = ret.replace(/\./g, "");
                break;
            }
        }
    }
    return ret;
};
module.exports = CSL;
CSL.Node.name = {
    build: function (state, target) {
        var func, pos, len, attrname;
        if ([CSL.SINGLETON, CSL.START].indexOf(this.tokentype) > -1) {
            if ("undefined" === typeof state.tmp.root) {
                var oldTmpRoot = undefined;
                state.tmp.root = "citation";
            } else {
                var oldTmpRoot = state.tmp.root;
            }
            if (state.inheritOpt(this, "et-al-subsequent-min")
                && (state.inheritOpt(this, "et-al-subsequent-min") !== state.inheritOpt(this, "et-al-min"))) {
                state.opt.update_mode = CSL.POSITION;
            }
            if (state.inheritOpt(this, "et-al-subsequent-use-first")
                && (state.inheritOpt(this, "et-al-subsequent-use-first") !== state.inheritOpt(this, "et-al-use-first"))) {
                state.opt.update_mode = CSL.POSITION;
            }
            state.tmp.root = oldTmpRoot;
            func = function (state, Item) {
                state.tmp.etal_term = "et-al";
                state.tmp.name_delimiter = state.inheritOpt(this, "delimiter", "name-delimiter", ", ");
                state.tmp["delimiter-precedes-et-al"] = state.inheritOpt(this, "delimiter-precedes-et-al");
                if ("text" === state.inheritOpt(this, "and")) {
                    this.and_term = state.getTerm("and", "long", 0);
                } else if ("symbol" === state.inheritOpt(this, "and")) {
                    if (state.opt.development_extensions.expect_and_symbol_form) {
                        this.and_term = state.getTerm("and", "symbol", 0);
                    } else {
                        this.and_term = "&";
                    }
                }
                state.tmp.and_term = this.and_term;
                if (CSL.STARTSWITH_ROMANESQUE_REGEXP.test(this.and_term)) {
                    this.and_prefix_single = " ";
                    this.and_prefix_multiple = ", ";
                    if ("string" === typeof state.tmp.name_delimiter) {
                        this.and_prefix_multiple = state.tmp.name_delimiter;
                    }
                    this.and_suffix = " ";
                } else {
                    this.and_prefix_single = "";
                    this.and_prefix_multiple = "";
                    this.and_suffix = "";
                }
                if (state.inheritOpt(this, "delimiter-precedes-last") === "always") {
                    this.and_prefix_single = state.tmp.name_delimiter;
                } else if (state.inheritOpt(this, "delimiter-precedes-last") === "never") {
                    if (this.and_prefix_multiple) {
                        this.and_prefix_multiple = " ";
                    }
                } else if (state.inheritOpt(this, "delimiter-precedes-last") === "after-inverted-name") {
                    if (this.and_prefix_single) {
                        this.and_prefix_single = state.tmp.name_delimiter;
                    }
                    if (this.and_prefix_multiple) {
                        this.and_prefix_multiple = " ";
                    }
                }
                this.and = {};
                if (state.inheritOpt(this, "and")) {
                    state.output.append(this.and_term, "empty", true);
                    this.and.single = state.output.pop();
                    this.and.single.strings.prefix = this.and_prefix_single;
                    this.and.single.strings.suffix = this.and_suffix;
                    state.output.append(this.and_term, "empty", true);
                    this.and.multiple = state.output.pop();
                    this.and.multiple.strings.prefix = this.and_prefix_multiple;
                    this.and.multiple.strings.suffix = this.and_suffix;
                } else if (state.tmp.name_delimiter) {
                    this.and.single = new CSL.Blob(state.tmp.name_delimiter);
                    this.and.single.strings.prefix = "";
                    this.and.single.strings.suffix = "";
                    this.and.multiple = new CSL.Blob(state.tmp.name_delimiter);
                    this.and.multiple.strings.prefix = "";
                    this.and.multiple.strings.suffix = "";
                }
                this.ellipsis = {};
                if (state.inheritOpt(this, "et-al-use-last")) {
                    this.ellipsis_term = "\u2026";
                    this.ellipsis_prefix_single = " ";
                    this.ellipsis_prefix_multiple =  state.inheritOpt(this, "delimiter", "name-delimiter", ", ");
                    this.ellipsis_suffix = " ";
                    this.ellipsis.single = new CSL.Blob(this.ellipsis_term);
                    this.ellipsis.single.strings.prefix = this.ellipsis_prefix_single;
                    this.ellipsis.single.strings.suffix = this.ellipsis_suffix;
                    this.ellipsis.multiple = new CSL.Blob(this.ellipsis_term);
                    this.ellipsis.multiple.strings.prefix = this.ellipsis_prefix_multiple;
                    this.ellipsis.multiple.strings.suffix = this.ellipsis_suffix;
                }
                if ("undefined" === typeof state.tmp["et-al-min"]) {
                    state.tmp["et-al-min"] = state.inheritOpt(this, "et-al-min");
                }
                if ("undefined" === typeof state.tmp["et-al-use-first"]) {
                    state.tmp["et-al-use-first"] = state.inheritOpt(this, "et-al-use-first");
                }
                if ("undefined" === typeof state.tmp["et-al-use-last"]) {
                    state.tmp["et-al-use-last"] = state.inheritOpt(this, "et-al-use-last");
                }
                state.nameOutput.name = this;
            };
            state.build.name_flag = true;
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node["name-part"] = {
    build: function (state, target) {
        state.build[this.strings.name] = this;
    }
};
module.exports = CSL;
CSL.Node.names = {
    build: function (state, target) {
        var func, len, pos, attrname;
        var debug = false;
        if (this.tokentype === CSL.START || this.tokentype === CSL.SINGLETON) {
            CSL.Util.substituteStart.call(this, state, target);
            state.build.substitute_level.push(1);
        }
        if (this.tokentype === CSL.SINGLETON) {
            state.build.names_variables.push(this.variables);
            func = function (state, Item, item) {
                var labelVariable = state.nameOutput.labelVariable;
                state.nameOutput.reinit(this, labelVariable);
            };
            this.execs.push(func);
        }
        if (this.tokentype === CSL.START) {
            state.build.names_flag = true;
            state.build.names_level += 1;
            if (state.build.names_level === 1) {
                state.build.names_variables = [];
                state.build.name_label = {};
            }
            state.build.names_variables.push(this.variables);
            func = function (state, Item, item) {
                state.tmp.can_substitute.push(true);
                state.parallel.StartVariable("names",this.variables[0]);
                state.nameOutput.init(this);
            };
            this.execs.push(func);
        }
        if (this.tokentype === CSL.END) {
            for (var i = 0, ilen = 3; i < ilen; i += 1) {
                var key = ["family", "given", "et-al"][i];
                this[key] = state.build[key];
                if (state.build.names_level === 1) {
                    state.build[key] = undefined;
                }
            }
            this.label = state.build.name_label;
            if (state.build.names_level === 1) {
                state.build.name_label = {};
            }
            state.build.names_level += -1;
            state.build.names_variables.pop();
            func = function (state, Item, item) {
                if (state.tmp.etal_node) {
                    this.etal_style = state.tmp.etal_node;
                } else {
                    this.etal_style = "empty";
                }
                this.etal_term = state.getTerm(state.tmp.etal_term, "long", 0);
                if (CSL.STARTSWITH_ROMANESQUE_REGEXP.test(this.etal_term)) {
                    this.etal_prefix_single = " ";
                    this.etal_prefix_multiple = state.tmp.name_delimiter;
                    if (state.tmp["delimiter-precedes-et-al"] === "always") {
                        this.etal_prefix_single = state.tmp.name_delimiter;
                    } else if (state.tmp["delimiter-precedes-et-al"] === "never") {
                        this.etal_prefix_multiple = " ";
                    } else if (state.tmp["delimiter-precedes-et-al"] === "after-inverted-name") {
                        this.etal_prefix_single = state.tmp.name_delimiter;
                        this.etal_prefix_multiple = " ";
                    }
                    this.etal_suffix = "";
                } else {
                    this.etal_prefix_single = "";
                    this.etal_prefix_multiple = "";
                    this.etal_suffix = "";
                }
                for (var i = 0, ilen = 3; i < ilen; i += 1) {
                    var key = ["family", "given"][i];
                    state.nameOutput[key] = this[key];
                }
                state.nameOutput["with"] = this["with"];
                var mywith = "with";
                var with_default_prefix = "";
                var with_suffix = "";
                if (CSL.STARTSWITH_ROMANESQUE_REGEXP.test(mywith)) {
                    with_default_prefix = " ";
                    with_suffix = " ";
                }
                var thewith = {};
                thewith.single = new CSL.Blob(mywith);
                thewith.single.strings.suffix = with_suffix;
                thewith.multiple = new CSL.Blob(mywith);
                thewith.multiple.strings.suffix = with_suffix;
                if (state.inheritOpt(state.nameOutput.name, "delimiter-precedes-last") === "always") {
                    thewith.single.strings.prefix = state.inheritOpt(this, "delimiter", "names-delimiter");
                    thewith.multiple.strings.prefix = state.inheritOpt(this, "delimiter", "names-delimiter");
                } else if (state.inheritOpt(state.nameOutput.name, "delimiter-precedes-last") === "contextual") {
                    thewith.single.strings.prefix = with_default_prefix;
                    thewith.multiple.strings.prefix = state.inheritOpt(this, "delimiter", "names-delimiter");
                } else if (state.inheritOpt(state.nameOutput.name, "delimiter-precedes-last") === "after-inverted-name") {
                    thewith.single.strings.prefix = state.inheritOpt(this, "delimiter", "names-delimiter");
                    thewith.multiple.strings.prefix = with_default_prefix;
                } else {
                    thewith.single.strings.prefix = with_default_prefix;
                    thewith.multiple.strings.prefix = with_default_prefix;
                }
                state.nameOutput["with"] = thewith;
                state.nameOutput.label = this.label;
                state.nameOutput.etal_style = this.etal_style;
                state.nameOutput.etal_term = this.etal_term;
                state.nameOutput.etal_prefix_single = this.etal_prefix_single;
                state.nameOutput.etal_prefix_multiple = this.etal_prefix_multiple;
                state.nameOutput.etal_suffix = this.etal_suffix;
                state.nameOutput.outputNames();
                state.tmp["et-al-use-first"] = undefined;
                state.tmp["et-al-min"] = undefined;
                state.tmp["et-al-use-last"] = undefined;
            };
            this.execs.push(func);
            func = function (state, Item) {
                if (!state.tmp.can_substitute.pop()) {
                    state.tmp.can_substitute.replace(false, CSL.LITERAL);
                }
                state.parallel.CloseVariable("names");
                if (state.tmp.can_substitute.mystack.length === 1) {
                    state.tmp.can_block_substitute = false;
                }
            };
            this.execs.push(func);
            state.build.name_flag = false;
        }
        target.push(this);
        if (this.tokentype === CSL.END || this.tokentype === CSL.SINGLETON) {
            state.build.substitute_level.pop();
            CSL.Util.substituteEnd.call(this, state, target);
        }
    }
};
module.exports = CSL;
CSL.Node.number = {
    build: function (state, target) {
        var func;
        CSL.Util.substituteStart.call(this, state, target);
        if (this.strings.form === "roman") {
            this.formatter = state.fun.romanizer;
        } else if (this.strings.form === "ordinal") {
            this.formatter = state.fun.ordinalizer;
        } else if (this.strings.form === "long-ordinal") {
            this.formatter = state.fun.long_ordinalizer;
        }
        if ("undefined" === typeof this.successor_prefix) {
            this.successor_prefix = state[state.build.area].opt.layout_delimiter;
        }
        if ("undefined" === typeof this.splice_prefix) {
            this.splice_prefix = state[state.build.area].opt.layout_delimiter;
        }
        func = function (state, Item, item) {
            var i, ilen, newlst, lst;
            if (this.variables.length === 0) {
                return;
            }
            if ("undefined" === typeof item) {
                var item = {};
            }
            var varname, num, number, m, j, jlen;
            varname = this.variables[0];
            if (varname === "locator" && state.tmp.just_looking) {
                return;
            }
            state.parallel.StartVariable(this.variables[0]);
            if (this.variables[0] === "locator") {
                state.parallel.AppendToVariable(Item.section);
            } else {
                state.parallel.AppendToVariable(Item[this.variables[0]]);
            }
            var rex = new RegExp("(?:&|, | and |" + state.getTerm("page-range-delimiter") + ")");
            if (varname === 'collection-number' && Item.type === 'legal_case') {
                state.tmp.renders_collection_number = true;
            }
            var value = Item[this.variables[0]];
            var node = this;
            if (state.tmp.group_context.tip.force_suppress) {
                return false;
            }
            if (varname === "locator") {
                state.processNumber(node, item, varname, Item.type);
            } else {
                if (!state.tmp.group_context.tip.condition && Item[varname]) {
                    state.tmp.just_did_number = true;
                }
                state.processNumber(node, Item, varname, Item.type);
            }
            CSL.Util.outputNumericField(state, varname, Item.id);
            state.parallel.CloseVariable("number");
            if (["locator", "locator-extra"].indexOf(this.variables_real[0]) > -1
               && !state.tmp.just_looking) {
                state.tmp.done_vars.push(this.variables_real[0]);
                state.tmp.group_context.tip.done_vars.push(this.variables_real[0]);
            }
        };
        this.execs.push(func);
        target.push(this);
        CSL.Util.substituteEnd.call(this, state, target);
    }
};
module.exports = CSL;
CSL.Node.sort = {
    build: function (state, target) {
        target = state[state.build.root + "_sort"].tokens;
        if (this.tokentype === CSL.START) {
            if (state.build.area === "citation") {
                state.parallel.use_parallels = false;
                state.opt.sort_citations = true;
            }
            state.build.area = state.build.root + "_sort";
            state.build.extension = "_sort";
            var func = function (state, Item) {
                if (state.opt.has_layout_locale) {
                    var langspec = CSL.localeResolve(Item.language, state.opt["default-locale"][0]);
                    var sort_locales = state[state.tmp.area.slice(0,-5)].opt.sort_locales;
                    var langForItem;
                    for (var i=0,ilen=sort_locales.length;i<ilen;i+=1) {
                        langForItem = sort_locales[i][langspec.bare];
                        if (!langForItem) {
                            langForItem = sort_locales[i][langspec.best];
                        }
                        if (langForItem) {
                            break;
                        }
                    }
                    if (!langForItem) {
                        langForItem = state.opt["default-locale"][0];
                    }
                    state.tmp.lang_sort_hold = state.opt.lang;
                    state.opt.lang = langForItem;
                }
            }
            this.execs.push(func);
        }
        if (this.tokentype === CSL.END) {
            state.build.area = state.build.root;
            state.build.extension = "";
            var func = function (state, Item) {
                if (state.opt.has_layout_locale) {
                    state.opt.lang = state.tmp.lang_sort_hold;
                    delete state.tmp.lang_sort_hold;
                }
            }
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.substitute = {
    build: function (state, target) {
        var func;
        if (this.tokentype === CSL.START) {
            func = function (state, Item) {
                state.tmp.can_block_substitute = true;
                if (state.tmp.value.length) {
                    state.tmp.can_substitute.replace(false, CSL.LITERAL);
                }
            };
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.text = {
    build: function (state, target) {
        var variable, func, form, plural, id, num, number, formatter, firstoutput, specialdelimiter, label, myname, names, name, year, suffix, term, dp, len, pos, n, m, value, flag;
        if (this.postponed_macro) {
            var group_start = CSL.Util.cloneToken(this);
            group_start.name = "group";
            group_start.tokentype = CSL.START;
            CSL.Node.group.build.call(group_start, state, target);
            CSL.expandMacro.call(state, this, target);
            var group_end = CSL.Util.cloneToken(this);
            group_end.name = "group";
            group_end.tokentype = CSL.END;
            if (this.postponed_macro === 'juris-locator-label') {
                group_end.isJurisLocatorLabel = true;
            }
            CSL.Node.group.build.call(group_end, state, target);
        } else {
            CSL.Util.substituteStart.call(this, state, target);
            if (!this.variables_real) {
                this.variables_real = [];
            }
            if (!this.variables) {
                this.variables = [];
            }
            form = "long";
            plural = 0;
            if (this.strings.form) {
                form = this.strings.form;
            }
            if (this.strings.plural) {
                plural = this.strings.plural;
            }
            if ("citation-number" === this.variables_real[0] || "year-suffix" === this.variables_real[0] || "citation-label" === this.variables_real[0]) {
                if (this.variables_real[0] === "citation-number") {
                    if (state.build.root === "citation") {
                        state.opt.update_mode = CSL.NUMERIC;
                    }
                    if (state.build.root === "bibliography") {
                        state.opt.bib_mode = CSL.NUMERIC;
                    }
                    if (state.build.area === "bibliography_sort") {
                        state.opt.citation_number_sort_used = true;
                    }
                    if ("citation-number" === state[state.tmp.area].opt.collapse) {
                        this.range_prefix = state.getTerm("citation-range-delimiter");
                    }
                    this.successor_prefix = state[state.build.area].opt.layout_delimiter;
                    this.splice_prefix = state[state.build.area].opt.layout_delimiter;
                    func = function (state, Item, item) {
                        id = "" + Item.id;
                        if (!state.tmp.just_looking) {
                            if (item && item["author-only"]) {
                                state.tmp.element_trace.replace("do-not-suppress-me");
                                var reference_term = state.getTerm("reference", "long", "singular");
                                if ("undefined" === typeof reference_term) {
                                    reference_term = "reference";
                                }
                                term = CSL.Output.Formatters["capitalize-first"](state, reference_term);
                                state.output.append(term + " ");
                                state.tmp.last_element_trace = true;
                            }
                            if (item && item["suppress-author"]) {
                                if (state.tmp.last_element_trace) {
                                    state.tmp.element_trace.replace("suppress-me");
                                }
                                state.tmp.last_element_trace = false;
                            }
                            num = state.registry.registry[id].seq;
                            if (state.opt.citation_number_slug) {
                                state.output.append(state.opt.citation_number_slug, this);
                            } else {
                                number = new CSL.NumericBlob(false, num, this, Item.id);
                                if (state.tmp.in_cite_predecessor) {
                                    if (!state.tmp.just_looking) {
                                    }
                                    number.suppress_splice_prefix = true;
                                }
                                state.output.append(number, "literal");
                            }
                        }
                    };
                    this.execs.push(func);
                } else if (this.variables_real[0] === "year-suffix") {
                    state.opt.has_year_suffix = true;
                    if (state[state.tmp.area].opt.collapse === "year-suffix-ranged") {
                        this.range_prefix = state.getTerm("citation-range-delimiter");
                    }
                    this.successor_prefix = state[state.build.area].opt.layout_delimiter;
                    if (state[state.tmp.area].opt["year-suffix-delimiter"]) {
                        this.successor_prefix = state[state.build.area].opt["year-suffix-delimiter"];
                    }
                    func = function (state, Item) {
                        if (state.registry.registry[Item.id] && state.registry.registry[Item.id].disambig.year_suffix !== false && !state.tmp.just_looking) {
                            num = parseInt(state.registry.registry[Item.id].disambig.year_suffix, 10);
                            if (state[state.tmp.area].opt.cite_group_delimiter) {
                                this.successor_prefix = state[state.tmp.area].opt.cite_group_delimiter;
                            }
                            number = new CSL.NumericBlob(false, num, this, Item.id);
                            formatter = new CSL.Util.Suffixator(CSL.SUFFIX_CHARS);
                            number.setFormatter(formatter);
                            state.output.append(number, "literal");
                            firstoutput = false;
                            for (var i=0,ilen=state.tmp.group_context.mystack.length; i<ilen; i++) {
                                var flags = state.tmp.group_context.mystack[i];
                                if (!flags.variable_success && (flags.variable_attempt || (!flags.variable_attempt && !flags.term_intended))) {
                                    firstoutput = true;
                                    break;
                                }
                            }
                            specialdelimiter = state[state.tmp.area].opt["year-suffix-delimiter"];
                            if (firstoutput && specialdelimiter && !state.tmp.sort_key_flag) {
                                state.tmp.splice_delimiter = state[state.tmp.area].opt["year-suffix-delimiter"];
                            }
                        }
                    };
                    this.execs.push(func);
                } else if (this.variables_real[0] === "citation-label") {
                    state.opt.has_year_suffix = true;
                    func = function (state, Item) {
                        label = Item["citation-label"];
                        if (!label) {
                            label = state.getCitationLabel(Item);
                        }
                        if (!state.tmp.just_looking) {
                            suffix = "";
                            if (state.registry.registry[Item.id] && state.registry.registry[Item.id].disambig.year_suffix !== false) {
                                num = parseInt(state.registry.registry[Item.id].disambig.year_suffix, 10);
                                suffix = state.fun.suffixator.format(num);
                            }
                            label += suffix;
                        }
                        state.output.append(label, this);
                    };
                    this.execs.push(func);
                }
            } else {
                if (this.strings.term) {
                    func = function (state, Item, item) {
                        var gender = state.opt.gender[Item.type];
                        var term = this.strings.term;
                        term = state.getTerm(term, form, plural, gender, CSL.TOLERANT, this.default_locale);
                        var myterm;
                        if (term !== "") {
                            state.tmp.group_context.tip.term_intended = true;
                        }
                        CSL.UPDATE_GROUP_CONTEXT_CONDITION(state, term);
                        if (!state.tmp.term_predecessor && !(state.opt["class"] === "in-text" && state.tmp.area === "citation")) {
                            myterm = CSL.Output.Formatters["capitalize-first"](state, term);
                        } else {
                            myterm = term;
                        }
                        if (state.tmp.strip_periods) {
                            myterm = myterm.replace(/\./g, "");
                        } else {
                            for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
                                if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                                    myterm = myterm.replace(/\./g, "");
                                    break;
                                }
                            }
                        }
                        state.output.append(myterm, this);
                    };
                    this.execs.push(func);
                    state.build.term = false;
                    state.build.form = false;
                    state.build.plural = false;
                } else if (this.variables_real.length) {
                    func = function (state, Item, item) {
                        if (this.variables_real[0] !== "locator") {
                            state.tmp.have_collapsed = false;
                        }
                        var parallel_variable = this.variables[0];
                        if (parallel_variable === "title" 
                            && (form === "short" || Item["title-short"])) { 
                            parallel_variable = "title-short";
                        }
                        state.parallel.StartVariable(parallel_variable);
                        state.parallel.AppendToVariable(Item[parallel_variable],parallel_variable);
                        if (!state.tmp.group_context.tip.condition && Item[this.variables[0]]) {
                            state.tmp.just_did_number = false;
                        }
                    };
                    this.execs.push(func);
                    if (CSL.MULTI_FIELDS.indexOf(this.variables_real[0]) > -1
                        || ["language-name", "language-name-original"].indexOf(this.variables_real[0]) > -1) {
                        var abbrevfam = this.variables[0];
                        var abbrfall = false;
                        var altvar = false;
                        var transfall = false;
                        if (form === "short" || ["country", "jurisdiction"].indexOf(this.variables_real[0]) > -1) {
                            if (this.variables_real[0] === "container-title") {
                                altvar = "journalAbbreviation";
                            } else if (this.variables_real[0] === "title") {
                                altvar = "title-short";
                            }
                        } else {
                            abbrevfam = false;
                        }
                        if (state.build.extension) {
                            transfall = true;
                        } else {
                            transfall = true;
                            abbrfall = true;
						}
                        func = state.transform.getOutputFunction(this.variables, abbrevfam, abbrfall, altvar, transfall);
                    } else {
                        if (CSL.CITE_FIELDS.indexOf(this.variables_real[0]) > -1) {
                            func = function (state, Item, item) {
                                if (item && item[this.variables[0]]) {
                                    state.processNumber(this, item, this.variables[0], Item.type);
                                    CSL.Util.outputNumericField(state, this.variables[0], Item.id);
                                    if (["locator", "locator-extra"].indexOf(this.variables_real[0]) > -1
                                       && !state.tmp.just_looking) { 
                                        state.tmp.done_vars.push(this.variables_real[0]);
                                    }
                                }
                            };
                        } else  if (["page", "page-first", "chapter-number", "collection-number", "edition", "issue", "number", "number-of-pages", "number-of-volumes", "volume"].indexOf(this.variables_real[0]) > -1) {
                            func = function(state, Item) {
                                state.processNumber(this, Item, this.variables[0], Item.type);
                                CSL.Util.outputNumericField(state, this.variables[0], Item.id);
                            }
                        } else if (["URL", "DOI"].indexOf(this.variables_real[0]) > -1) {
                            func = function (state, Item) {
                                var value;
                                if (this.variables[0]) {
                                    value = state.getVariable(Item, this.variables[0], form);
                                    if (value) {
                                        if (state.opt.development_extensions.wrap_url_and_doi) {
                                            if (!this.decorations.length || this.decorations[0][0] !== "@" + this.variables[0]) {
                                                if (this.variables_real[0] === "DOI" && this.strings.prefix === "https://doi.org/") {
                                                    var clonetoken = CSL.Util.cloneToken(this);
                                                    var groupblob = new CSL.Blob(null, null, "url-wrapper");
                                                    groupblob.decorations.push(["@DOI", "true"]);
                                                    value = value.replace(/^https?:\/\/doi\.org\//, "");
                                                    if (value.match(/^https?:\/\//)) {
                                                        var prefix = "";
                                                    } else {
                                                        var prefix = "https://doi.org/";
                                                    }
                                                    var prefixblob = new CSL.Blob(prefix);
                                                    var valueblob = new CSL.Blob(value);
                                                    clonetoken.strings.prefix = "";
                                                    groupblob.push(prefixblob);
                                                    groupblob.push(valueblob);
                                                    state.output.append(groupblob, clonetoken, false, false, true);
                                                } else {
                                                    this.decorations = [["@" + this.variables[0], "true"]].concat(this.decorations);
                                                    state.output.append(value, this, false, false, true);
                                                }
                                            } else {
                                                state.output.append(value, this, false, false, true);
                                            }
                                        } else {
                                            if (this.decorations.length) {
                                                for (var i=this.decorations.length-1; i>-1; i--) {
                                                    if (this.decorations[i][0] === "@" + this.variables[0]) {
                                                        this.decorations = this.decorations.slice(0, i).concat(this.decorations.slice(i+1));
                                                    }
                                                }
                                            }
                                            state.output.append(value, this, false, false, true);
                                        }
                                    }
                                }
                            };
                        } else if (this.variables_real[0] === "section") {
                            func = function (state, Item) {
                                var value;
                                value = state.getVariable(Item, this.variables[0], form);
                                if (value) {
                                    state.output.append(value, this);
                                }
                            };
                        } else if (this.variables_real[0] === "hereinafter") {
                            func = function (state, Item) {
                                var value = state.transform.abbrevs["default"]["hereinafter"][Item.id];
                                if (value) {
                                    state.output.append(value, this);
                                    state.tmp.group_context.tip.variable_success = true;
                                }
                            }
                        } else {
                            func = function (state, Item) {
                                var value;
                                if (this.variables[0]) {
                                    value = state.getVariable(Item, this.variables[0], form);
                                    if (value) {
                                        value = "" + value;
                                        value = value.split("\\").join("");
                                        state.output.append(value, this);
                                    }
                                }
                            };
                        }
                    }
                    this.execs.push(func);
                    func = function (state, Item) {
                        state.parallel.CloseVariable("text");
                    };
                    this.execs.push(func);
                } else if (this.strings.value) {
                    func = function (state, Item) {
                        state.tmp.group_context.tip.term_intended = true;
                        CSL.UPDATE_GROUP_CONTEXT_CONDITION(state, this.strings.value, true);
                        state.output.append(this.strings.value, this);
                    };
                    this.execs.push(func);
                }
            }
            target.push(this);
            CSL.Util.substituteEnd.call(this, state, target);
        }
    }
};
module.exports = CSL;
CSL.Attributes = {};
CSL.Attributes["@genre"] = function (state, arg) {
    arg = arg.replace("-", " ");
    var func = function (Item, item) {
        var ret;
        if (arg === Item.genre) {
            return true;
        }
        return false;
    }
    this.tests.push(func);
}
CSL.Attributes["@disambiguate"] = function (state, arg) {
    if (arg === "true") {
        state.opt.has_disambiguate = true;
        var func = function (Item, item) {
            if (state.tmp.area === "bibliography") {
                if (state.tmp.disambiguate_count < state.registry.registry[Item.id].disambig.disambiguate) {
                    state.tmp.disambiguate_count += 1;
                    return true;
                }
            } else {
                state.tmp.disambiguate_maxMax += 1;
                if (state.tmp.disambig_settings.disambiguate
                    && state.tmp.disambiguate_count < state.tmp.disambig_settings.disambiguate) {
                    state.tmp.disambiguate_count += 1;
                    return true;
                }
            }
            return false;
        };
        this.tests.push(func);
    } else if (arg === "check-ambiguity-and-backreference") {
        var func = function (Item, item) {
            if (state.registry.registry[Item.id].disambig.disambiguate && state.registry.registry[Item.id]["citation-count"] > 1) {
                return true;
            }
            return false;
        };
        this.tests.push(func);
    }
};
CSL.Attributes["@is-numeric"] = function (state, arg, joiner) {
    var variables = arg.split(/\s+/);
    var maketest = function(variable) {
        return function (Item, item) {
            var myitem = Item;
            if (["locator","locator-extra"].indexOf(variable) > -1) {
                myitem = item;
            }
            if ("undefined" === typeof myitem) {
                return false;
            }
            if (CSL.NUMERIC_VARIABLES.indexOf(variable) > -1) {
                if (!state.tmp.shadow_numbers[variable]) {
                    state.processNumber(false, myitem, variable, Item.type);
                }
                if (myitem[variable] && state.tmp.shadow_numbers[variable].numeric) {
                    return true;
                }
            } else if (["title", "locator-extra","version"].indexOf(variable) > -1) {
                if (myitem[variable]) {
                    if (myitem[variable].slice(-1) === "" + parseInt(myitem[variable].slice(-1), 10)) {
                        return true;
                    }
                }
            }
            return false;
        }
    }
    for (var i=0; i<variables.length; i+=1) {
        this.tests.push(maketest(variables[i]));
    }
};
CSL.Attributes["@is-uncertain-date"] = function (state, arg) {
    var variables = arg.split(/\s+/);
    var maketest = function (myvariable) {
        return function(Item, item) {
            if (Item[myvariable] && Item[myvariable].circa) {
                return true;
            } else {
                return false;
            }
        }
    }
    for (var i=0,ilen=variables.length;i<ilen;i+=1) {
        this.tests.push(maketest(variables[i]));
    };
};
CSL.Attributes["@locator"] = function (state, arg) {
    var trylabels = arg.replace("sub verbo", "sub-verbo");
    trylabels = trylabels.split(/\s+/);
    var maketest = function (trylabel) {
        return function(Item, item) {
            var label;
            state.processNumber(false, item, "locator");
            label = state.tmp.shadow_numbers.locator.label;
            if (trylabel === label) {
                return true;
            } else {
                return false;
            }
        }
    }
    for (var i=0,ilen=trylabels.length;i<ilen;i+=1) {
        this.tests.push(maketest(trylabels[i]));
    }
};
CSL.Attributes["@position"] = function (state, arg) {
    var tryposition;
    state.opt.update_mode = CSL.POSITION;
    state.parallel.use_parallels = null;
    var trypositions = arg.split(/\s+/);
    var maketest = function(tryposition) {
        return function (Item, item) {
            if (state.tmp.area === "bibliography") {
                return false;
            }
            if (item && "undefined" === typeof item.position) {
                item.position = 0;
            }
            if (item && typeof item.position === "number") {
                if (item.position === 0 && tryposition === 0) {
                    return true;
                } else if (tryposition > 0 && item.position >= tryposition) {
                    return true;
                }
            } else if (tryposition === 0) {
                return true;
            }
            return false;
        }
    }
    for (var i=0,ilen=trypositions.length;i<ilen;i+=1) {
        var tryposition = trypositions[i];
        if (tryposition === "first") {
            tryposition = CSL.POSITION_FIRST;
        } else if (tryposition === "subsequent") {
            tryposition = CSL.POSITION_SUBSEQUENT;
        } else if (tryposition === "ibid") {
            tryposition = CSL.POSITION_IBID;
        } else if (tryposition === "ibid-with-locator") {
            tryposition = CSL.POSITION_IBID_WITH_LOCATOR;
        }
        if ("near-note" === tryposition) {
            this.tests.push(function (Item, item) {
                if (item && item.position >= CSL.POSITION_SUBSEQUENT && item["near-note"]) {
                    return true;
                }
                return false;
            });
        } else if ("far-note" === tryposition) {
            this.tests.push(function (Item, item) {
                if (item && item.position == CSL.POSITION_SUBSEQUENT && !item["near-note"]) {
                    return true;
                }
                return false;
            });
        } else {
            this.tests.push(maketest(tryposition));
        }
    }
};
CSL.Attributes["@type"] = function (state, arg) {
    var types = arg.split(/\s+/);
    var maketest = function (mytype) {
        return function(Item,item) {
            var ret = (Item.type === mytype);
            if (ret) {
                return true;
            } else {
                return false;
            }
        }
    }
    var tests = [];
    for (var i=0,ilen=types.length;i<ilen;i+=1) {
        tests.push(maketest(types[i]));
    }
    this.tests.push(state.fun.match.any(this, state, tests));
};
CSL.Attributes["@variable"] = function (state, arg) {
    var func;
    this.variables = arg.split(/\s+/);
    this.variables_real = this.variables.slice();
    if ("label" === this.name && this.variables[0]) {
        this.strings.term = this.variables[0];
    } else if (["names", "date", "text", "number"].indexOf(this.name) > -1) {
        func = function (state, Item, item) {
            for (var i = this.variables.length - 1; i > -1; i += -1) {
                this.variables.pop();
            }
            for (var i=0,ilen=this.variables_real.length;i<ilen;i++) {
                if (state.tmp.done_vars.indexOf(this.variables_real[i]) === -1 
                    && !(item && Item.type === "legal_case" && item["suppress-author"] && this.variables_real[i] === "title")
                   ) {
                    this.variables.push(this.variables_real[i]);
                }
                if (state.tmp.can_block_substitute) {
                    state.tmp.done_vars.push(this.variables_real[i]);
                }
            }
        };
        this.execs.push(func);
        func = function (state, Item, item) {
            var mydate;
            var output = false;
            for (var i=0,ilen=this.variables.length;i<ilen;i++) {
                var variable = this.variables[i];
                if (["authority", "committee"].indexOf(variable) > -1
                    && "string" === typeof Item[variable]
                    && "names" === this.name) {
                    var creatorParents = [];
                    var isValid = true;
                    var rawNames = Item[variable].split(/\s*;\s*/);
                    var rawMultiNames = {};
                    if (Item.multi && Item.multi._keys[variable]) {
                        for (var langTag in Item.multi._keys[variable]) {
                            rawMultiNames[langTag] = Item.multi._keys[variable][langTag].split(/\s*;\s*/);
                            if (rawMultiNames[langTag].length !== rawNames.length) {
                                isValid = false;
                                break;
                            }
                        }
                    }
                    if (!isValid) {
                        rawNames = [Item[variable]];
                        rawMultiNames = Item.multi._keys[variable];
                    }
                    for (var j = 0, jlen = rawNames.length; j < jlen; j++) {
                        var creatorParent = {
                            literal:rawNames[j],
                            multi:{
                                _key:{}
                            }
                        };
                        for (var langTag in rawMultiNames) {
                            var creatorChild = {
                                literal:rawMultiNames[langTag][j]
                            }
                            creatorParent.multi._key[langTag] = creatorChild;
                        }
                        rawNames[j] = creatorParent;
                    }
                    Item[variable] = rawNames;
                }
                if (this.strings.form === "short" && !Item[variable]) {
                    if (variable === "title") {
                        variable = "title-short";
                    } else if (variable === "container-title") {
                        variable = "journalAbbreviation";
                    }
                }
                if (variable === "year-suffix") {
                    output = true;
                    break;
                } else if (CSL.DATE_VARIABLES.indexOf(variable) > -1) {
                    if (state.opt.development_extensions.locator_date_and_revision && "locator-date" === variable) {
                        output = true;
                        break;
                    }
                    if (Item[variable]) {
                        for (var key in Item[variable]) {
                            if (this.dateparts.indexOf(key) === -1 && "literal" !== key) {
                                continue;
                            }
                            if (Item[variable][key]) {
                                output = true;
                                break;
                            }
                        }
                        if (output) {
                            break;
                        }
                    }
                } else if ("locator" === variable) {
                    if (item && item.locator) {
                        output = true;
                    }
                    break;
                } else if ("locator-extra" === variable) {
                    if (item && item["locator-extra"]) {
                        output = true;
                    }
                    break;
                } else if (["citation-number","citation-label"].indexOf(variable) > -1) {
                    output = true;
                    break;
                } else if ("first-reference-note-number" === variable) {
                    if (item && item["first-reference-note-number"]) {
                        output = true;
                    }
                    break;
                } else if ("hereinafter" === variable) {
                    if (state.transform.abbrevs["default"].hereinafter[Item.id]
                        && state.sys.getAbbreviation
                        && Item.id) {
                        output = true;
                    }
                    break;
                } else if ("object" === typeof Item[variable]) {
                    if (Item[variable].length) {
                    }
                    break;
                } else if ("string" === typeof Item[variable] && Item[variable]) {
                    output = true;
                    break;
                } else if ("number" === typeof Item[variable]) {
                    output = true;
                    break;
                }
                if (output) {
                    break;
                }
            }
            if (output) {
                for (var i=0,ilen=this.variables_real.length;i<ilen;i++) {
                    var variable = this.variables_real[i];
                    if (variable !== "citation-number" || state.tmp.area !== "bibliography") {
                        state.tmp.cite_renders_content = true;
                    }
                    state.tmp.group_context.tip.variable_success = true;
                    if (state.tmp.can_substitute.value() 
                        && state.tmp.area === "bibliography"
                        && "string" === typeof Item[variable]) {
                        state.tmp.name_node.top = state.output.current.value();
                        state.tmp.rendered_name.push(Item[variable]);
                    }
                }
                state.tmp.can_substitute.replace(false,  CSL.LITERAL);
            } else {
                state.tmp.group_context.tip.variable_attempt = true;
            }
        };
        this.execs.push(func);
    } else if (["if",  "else-if", "condition"].indexOf(this.name) > -1) {
        var maketest = function (variable) {
            return function(Item,item){
                var myitem = Item;
                if (item && ["locator", "locator-extra", "first-reference-note-number", "locator-date"].indexOf(variable) > -1) {
                    myitem = item;
                }
                if (variable === "hereinafter" && state.sys.getAbbreviation && myitem.id) {
                    if (state.transform.abbrevs["default"].hereinafter[myitem.id]) {
                        return true;
                    }
                } else if (myitem[variable]) {
                    if ("number" === typeof myitem[variable] || "string" === typeof myitem[variable]) {
                        return true;
                    } else if ("object" === typeof myitem[variable]) {
                        for (var key in myitem[variable]) {
                            if (myitem[variable][key]) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }
        }
        for (var i=0,ilen=this.variables.length;i<ilen;i+=1) {
            this.tests.push(maketest(this.variables[i]));
        }
    }
};
CSL.Attributes["@page"] = function (state, arg) {
    var trylabels = arg.replace("sub verbo", "sub-verbo");
    trylabels = trylabels.split(/\s+/);
    var maketest = function (trylabel) {
        return function(Item, item) {
            var label;
            state.processNumber(false, Item, "page", Item.type);
            if (!state.tmp.shadow_numbers.page.label) {
                label = "page";
            } else if (state.tmp.shadow_numbers.page.label === "sub verbo") {
                label = "sub-verbo";
            } else {
                label = state.tmp.shadow_numbers.page.label;
            }
            if (trylabel === label) {
                return true;
            } else {
                return false;
            }
        }
    }
    for (var i=0,ilen=trylabels.length;i<ilen;i+=1) {
        this.tests.push(maketest(trylabels[i]));
    }
};
CSL.Attributes["@number"] = function (state, arg) {
    var trylabels = arg.replace("sub verbo", "sub-verbo");
    trylabels = trylabels.split(/\s+/);
    var maketest = function(trylabel) {
        return function (Item, item) {
            var label;
            state.processNumber(false, Item, "number", Item.type);
            if (!state.tmp.shadow_numbers.number.label) {
                label = "number";
            } else if (state.tmp.shadow_numbers.number.label === "sub verbo") {
                label = "sub-verbo";
            } else {
                label = state.tmp.shadow_numbers.number.label;
            }
            if (trylabel === label) {
                return true;
            } else {
                return false;
            }
        }
    }
    for (var i=0,ilen=trylabels.length;i<ilen;i+=1) {
        this.tests.push(maketest(trylabels[i]));
    }
};
CSL.Attributes["@jurisdiction"] = function (state, arg) {
    var tryjurisdictions = arg.split(/\s+/);
    for (var i=0,ilen=tryjurisdictions.length;i<ilen;i+=1) {
        tryjurisdictions[i] = tryjurisdictions[i].split(":");
    }
    var maketests = function (tryjurisdiction) {
        return function(Item,item){
            if (!Item.jurisdiction) {
                return false;
            }
            var jurisdictions = Item.jurisdiction.split(":");
            for (var i=0,ilen=jurisdictions.length;i<ilen;i+=1) {
                jurisdictions[i] = jurisdictions[i].split(":");
            }
            for (i=tryjurisdiction.length;i>0;i+=-1) {
                var tryjurisdictionStr = tryjurisdiction.slice(0,i).join(":");
                var jurisdiction = jurisdictions.slice(0,i).join(":");
                if (tryjurisdictionStr !== jurisdiction) {
                    return false;
                }
            }
            return true;
        }
    }
    for (var i=0,ilen=tryjurisdictions.length;i<ilen;i+=1) {
        var tryjurisdictionSlice = tryjurisdictions[i].slice();
        this.tests.push(maketests(tryjurisdictionSlice));
    }
};
CSL.Attributes["@context"] = function (state, arg) {
    var func = function (Item, item) {
		var area = state.tmp.area.slice(0, arg.length);
		if (area === arg) {
			return true;
		}
		return false;
    };
    this.tests.push(func);
};
CSL.Attributes["@has-year-only"] = function (state, arg) {
    var trydates = arg.split(/\s+/);
    var maketest = function (trydate) {
        return function(Item,item){
            var date = Item[trydate];
            if (!date || date.month || date.season) {
                return false;
            } else {
                return true;
            }
        }
    }
    for (var i=0,ilen=trydates.length;i<ilen;i+=1) {
        this.tests.push(maketest(trydates[i]));
    }
};
CSL.Attributes["@has-to-month-or-season"] = function (state, arg) {
    var trydates = arg.split(/\s+/);
    var maketest = function (trydate) {
        return function(Item,item){
            var date = Item[trydate];
            if (!date || (!date.month && !date.season) || date.day) {
                return false;
            } else {
                return true;
            }
        }
    }
    for (var i=0,ilen=trydates.length;i<ilen;i+=1) {
        this.tests.push(maketest(trydates[i]));
    }
};
CSL.Attributes["@has-day"] = function (state, arg) {
    var trydates = arg.split(/\s+/);
    var maketest = function (trydate) {
        return function(Item,item){
            var date = Item[trydate];
            if (!date || !date.day) {
                return false;
            } else {
                return true;
            }
        }
    }
    for (var i=0,ilen=trydates.length;i<ilen;i+=1) {
        this.tests.push(maketest(trydates[i]));
    };
};
CSL.Attributes["@subjurisdictions"] = function (state, arg) {
    var trysubjurisdictions = parseInt(arg, 10);
    var func = function (Item, item) {
        var subjurisdictions = 0;
        if (Item.jurisdiction) {
            subjurisdictions = Item.jurisdiction.split(":").length;
        }
        if (subjurisdictions) {
            subjurisdictions += -1;
        }
        if (subjurisdictions >= trysubjurisdictions) {
            return true;
        }
        return false;
    };
    this.tests.push(func);
};
CSL.Attributes["@is-plural"] = function (state, arg) {
    var func = function (Item, item) {
        var nameList = Item[arg];
        if (nameList && nameList.length) {
            var persons = 0;
            var institutions = 0;
            var last_is_person = false;
            for (var i = 0, ilen = nameList.length; i < ilen; i += 1) {
                if (state.opt.development_extensions.spoof_institutional_affiliations
                    && (nameList[i].literal || (nameList[i].isInstitution && nameList[i].family && !nameList[i].given))) {
                    institutions += 1;
                    last_is_person = false;
                } else {
                    persons += 1;
                    last_is_person = true;
                }
            }
            if (persons > 1) {
                return true;
            } else if (institutions > 1) {
                return true;
            } else if (institutions && last_is_person) {
                return true;
            }
        }
        return false;
    };
    this.tests.push(func);
};
CSL.Attributes["@locale"] = function (state, arg) {
    var func, ret, len, pos, variable, myitem, langspec, lang, lst, i, ilen, fallback;
    var locale_default = state.opt["default-locale"][0];
    if (this.name === "layout") {
        this.locale_raw = arg;
        if (this.tokentype === CSL.START) {
            var locales = arg.split(/\s+/);
            var sort_locale = {};
            var localeMaster = CSL.localeResolve(locales[0], locale_default);
            if (localeMaster.generic) {
                sort_locale[localeMaster.generic] = localeMaster.best;
            } else {
                sort_locale[localeMaster.best] = localeMaster.best;
            }
            for (var i=1,ilen=locales.length;i<ilen;i+=1) {
                var localeServant = CSL.localeResolve(locales[i], locale_default);
                if (localeServant.generic) {
                    sort_locale[localeServant.generic] = localeMaster.best;
                } else {
                    sort_locale[localeServant.best] = localeMaster.best;
                }
            }
            state[state.build.area].opt.sort_locales.push(sort_locale);
        }
        state.opt.has_layout_locale = true;
    } else {
        lst = arg.split(/\s+/);
        var locale_bares = [];
        for (i = 0, ilen = lst.length; i < ilen; i += 1) {
            lang = lst[i];
            langspec = CSL.localeResolve(lang, locale_default);
            if (lst[i].length === 2) {
                locale_bares.push(langspec.bare);
            }
            state.localeConfigure(langspec, true);
            lst[i] = langspec;
        }
        var locale_list = lst.slice();
        var maketest = function (locale_list, locale_default,locale_bares) {
            return function (Item, item) {
                var key, res;
                ret = [];
                res = false;
                var langspec = false;
                var lang;
                if (!Item.language) {
                    lang = locale_default;
                } else {
                    lang = Item.language;
                }
                langspec = CSL.localeResolve(lang, locale_default);
                for (i = 0, ilen = locale_list.length; i < ilen; i += 1) {
                    if (langspec.best === locale_list[i].best) {
                        res = true;
                        break;
                    }
                }
                if (!res && locale_bares.indexOf(langspec.bare) > -1) {
                    res = true;
                }
                return res;
            }
        }
        this.tests.push(maketest(locale_list,locale_default,locale_bares));
    }
};
CSL.Attributes["@authority-residue"] = function (state, arg) {
    var maketest = function () {
        var succeed = (arg === "true") ? true : false;
        return function(Item, item) {
            if (!Item.authority || !Item.authority[0] || !Item.authority[0].family) return !succeed;
            var varLen = Item.authority[0].family.split("|").length;
            var stopLast = state.tmp.authority_stop_last;
            if ((varLen + stopLast) > 0) {
                return succeed;
            } else {
                return !succeed;
            }
        }
    }
    this.tests.push(maketest());
}
CSL.Attributes["@locale-internal"] = function (state, arg) {
    var func, ret, len, pos, variable, myitem, langspec, lang, lst, i, ilen, fallback;
        lst = arg.split(/\s+/);
        this.locale_bares = [];
        for (i = 0, ilen = lst.length; i < ilen; i += 1) {
            lang = lst[i];
            langspec = CSL.localeResolve(lang, state.opt["default-locale"][0]);
            if (lst[i].length === 2) {
                this.locale_bares.push(langspec.bare);
            }
            state.localeConfigure(langspec);
            lst[i] = langspec;
        }
        this.locale_default = state.opt["default-locale"][0];
        this.locale = lst[0].best;
        this.locale_list = lst.slice();
        var maketest = function (me) {
            return function (Item, item) {
                var key, res;
                ret = [];
                res = false;
                var langspec = false;
                if (Item.language) {
                    lang = Item.language;
                    langspec = CSL.localeResolve(lang, state.opt["default-locale"][0]);
                    if (langspec.best === state.opt["default-locale"][0]) {
                        langspec = false;
                    }
                }
                if (langspec) {
                    for (i = 0, ilen = me.locale_list.length; i < ilen; i += 1) {
                        if (langspec.best === me.locale_list[i].best) {
                            state.opt.lang = me.locale;
                            state.tmp.last_cite_locale = me.locale;
                            state.output.openLevel("empty");
                            state.output.current.value().new_locale = me.locale;
                            res = true;
                            break;
                        }
                    }
                    if (!res && me.locale_bares.indexOf(langspec.bare) > -1) {
                        state.opt.lang = me.locale;
                        state.tmp.last_cite_locale = me.locale;
                        state.output.openLevel("empty");
                        state.output.current.value().new_locale = me.locale;
                        res = true;
                    }
                }
                return res;
            }
        }
        var me = this;
        this.tests.push(maketest(me));
}
CSL.Attributes["@is-parallel"] = function (state, arg) {
    var values = arg.split(" ");
    for (var i = 0, ilen = values.length; i < ilen; i += 1) {
        if (values[i] === "true") {
            values[i] = true;
        } else if (values[i] === "false") {
            values[i] = false;
        }
    }
    this.strings.set_parallel_condition = values;
};
CSL.Attributes["@jurisdiction-depth"] = function (state, arg) {
    this.strings.jurisdiction_depth = parseInt(arg, 10);
};
CSL.Attributes["@require"] = function (state, arg) {
    this.strings.require = arg;
}
CSL.Attributes["@reject"] = function (state, arg) {
    this.strings.reject = arg;
}
CSL.Attributes["@gender"] = function (state, arg) {
    this.gender = arg;
}
CSL.Attributes["@cslid"] = function (state, arg) {
    this.cslid = parseInt(arg, 10);
};
CSL.Attributes["@capitalize-if-first"] = function (state, arg) {
    this.strings.capitalize_if_first_override = arg;
};
CSL.Attributes["@label-capitalize-if-first"] = function (state, arg) {
    this.strings.label_capitalize_if_first_override = arg;
};
CSL.Attributes["@label-form"] = function (state, arg) {
    this.strings.label_form_override = arg;
};
CSL.Attributes["@part-separator"] = function (state, arg) {
    this.strings["part-separator"] = arg;
};
CSL.Attributes["@leading-noise-words"] = function (state, arg) {
    this["leading-noise-words"] = arg;
};
CSL.Attributes["@name-never-short"] = function (state, arg) {
    this["name-never-short"] = arg;
};
CSL.Attributes["@class"] = function (state, arg) {
    state.opt["class"] = arg;
};
CSL.Attributes["@version"] = function (state, arg) {
    state.opt.version = arg;
};
CSL.Attributes["@value"] = function (state, arg) {
    this.strings.value = arg;
};
CSL.Attributes["@name"] = function (state, arg) {
    this.strings.name = arg;
};
CSL.Attributes["@form"] = function (state, arg) {
    this.strings.form = arg;
};
CSL.Attributes["@date-parts"] = function (state, arg) {
    this.strings["date-parts"] = arg;
};
CSL.Attributes["@range-delimiter"] = function (state, arg) {
    this.strings["range-delimiter"] = arg;
};
CSL.Attributes["@macro"] = function (state, arg) {
    this.postponed_macro = arg;
};
CSL.Attributes["@term"] = function (state, arg) {
    if (arg === "sub verbo") {
        this.strings.term = "sub-verbo";
    } else {
        this.strings.term = arg;
    }
};
CSL.Attributes["@xmlns"] = function (state, arg) {};
CSL.Attributes["@lang"] = function (state, arg) {
    if (arg) {
        state.build.lang = arg;
    }
};
CSL.Attributes["@lingo"] = function (state, arg) {
};
CSL.Attributes["@macro-has-date"] = function (state, arg) {
    this["macro-has-date"] = true;
};
CSL.Attributes["@suffix"] = function (state, arg) {
    this.strings.suffix = arg;
};
CSL.Attributes["@prefix"] = function (state, arg) {
    this.strings.prefix = arg;
};
CSL.Attributes["@delimiter"] = function (state, arg) {
    this.strings.delimiter = arg;
};
CSL.Attributes["@match"] = function (state, arg) {
    this.match = arg;
};
CSL.Attributes["@names-min"] = function (state, arg) {
    var val = parseInt(arg, 10);
    if (state[state.build.area].opt.max_number_of_names < val) {
        state[state.build.area].opt.max_number_of_names = val;
    }
    this.strings["et-al-min"] = val;
};
CSL.Attributes["@names-use-first"] = function (state, arg) {
    this.strings["et-al-use-first"] = parseInt(arg, 10);
};
CSL.Attributes["@names-use-last"] = function (state, arg) {
    if (arg === "true") {
        this.strings["et-al-use-last"] = true;
    } else {
        this.strings["et-al-use-last"] = false;
    }
};
CSL.Attributes["@sort"] = function (state, arg) {
    if (arg === "descending") {
        this.strings.sort_direction = CSL.DESCENDING;
    }
};
CSL.Attributes["@plural"] = function (state, arg) {
    if ("always" === arg || "true" === arg) {
        this.strings.plural = 1;
    } else if ("never" === arg || "false" === arg) {
        this.strings.plural = 0;
    } else if ("contextual" === arg) {
        this.strings.plural = false;
    }
};
CSL.Attributes["@has-publisher-and-publisher-place"] = function (state, arg) {
    this.strings["has-publisher-and-publisher-place"] = true;
};
CSL.Attributes["@publisher-delimiter-precedes-last"] = function (state, arg) {
    this.strings["publisher-delimiter-precedes-last"] = arg;
};
CSL.Attributes["@publisher-delimiter"] = function (state, arg) {
    this.strings["publisher-delimiter"] = arg;
};
CSL.Attributes["@publisher-and"] = function (state, arg) {
    this.strings["publisher-and"] = arg;
};
CSL.Attributes["@newdate"] = function (state, arg) {
};
CSL.Attributes["@givenname-disambiguation-rule"] = function (state, arg) {
    if (CSL.GIVENNAME_DISAMBIGUATION_RULES.indexOf(arg) > -1) {
        state.citation.opt["givenname-disambiguation-rule"] = arg;
    }
};
CSL.Attributes["@collapse"] = function (state, arg) {
    if (arg) {
        state[this.name].opt.collapse = arg;
    }
};
CSL.Attributes["@cite-group-delimiter"] = function (state, arg) {
    if (arg) {
        state[state.tmp.area].opt.cite_group_delimiter = arg;
    }
};
CSL.Attributes["@names-delimiter"] = function (state, arg) {
    state.setOpt(this, "names-delimiter", arg);
};
CSL.Attributes["@name-form"] = function (state, arg) {
    state.setOpt(this, "name-form", arg);
};
CSL.Attributes["@subgroup-delimiter"] = function (state, arg) {
    this.strings["subgroup-delimiter"] = arg;
};
CSL.Attributes["@subgroup-delimiter-precedes-last"] = function (state, arg) {
    this.strings["subgroup-delimiter-precedes-last"] = arg;
};
CSL.Attributes["@name-delimiter"] = function (state, arg) {
    state.setOpt(this, "name-delimiter", arg);
};
CSL.Attributes["@et-al-min"] = function (state, arg) {
    var val = parseInt(arg, 10);
    if (state[state.build.area].opt.max_number_of_names < val) {
        state[state.build.area].opt.max_number_of_names = val;
    }
    state.setOpt(this, "et-al-min", val);
};
CSL.Attributes["@et-al-use-first"] = function (state, arg) {
    state.setOpt(this, "et-al-use-first", parseInt(arg, 10));
};
CSL.Attributes["@et-al-use-last"] = function (state, arg) {
    if (arg === "true") {
        state.setOpt(this, "et-al-use-last", true);
    } else {
        state.setOpt(this, "et-al-use-last", false);
    }
};
CSL.Attributes["@et-al-subsequent-min"] = function (state, arg) {
    var val = parseInt(arg, 10);
    if (state[state.build.area].opt.max_number_of_names < val) {
        state[state.build.area].opt.max_number_of_names = val;
    }
    state.setOpt(this, "et-al-subsequent-min", val);
};
CSL.Attributes["@et-al-subsequent-use-first"] = function (state, arg) {
    state.setOpt(this, "et-al-subsequent-use-first", parseInt(arg, 10));
};
CSL.Attributes["@suppress-min"] = function (state, arg) {
    this.strings["suppress-min"] = parseInt(arg, 10);
};
CSL.Attributes["@suppress-max"] = function (state, arg) {
    this.strings["suppress-max"] = parseInt(arg, 10);
};
CSL.Attributes["@and"] = function (state, arg) {
    state.setOpt(this, "and", arg);
};
CSL.Attributes["@delimiter-precedes-last"] = function (state, arg) {
    state.setOpt(this, "delimiter-precedes-last", arg);
};
CSL.Attributes["@delimiter-precedes-et-al"] = function (state, arg) {
    state.setOpt(this, "delimiter-precedes-et-al", arg);
};
CSL.Attributes["@initialize-with"] = function (state, arg) {
    state.setOpt(this, "initialize-with", arg);
};
CSL.Attributes["@initialize"] = function (state, arg) {
    if (arg === "false") {
        state.setOpt(this, "initialize", false);
    }
};
CSL.Attributes["@name-as-reverse-order"] = function (state, arg) {
    this["name-as-reverse-order"] = arg;
};
CSL.Attributes["@name-as-sort-order"] = function (state, arg) {
    if (this.name === "style-options") {
        this["name-as-sort-order"] = arg;
    } else {
        state.setOpt(this, "name-as-sort-order", arg);
    }
};
CSL.Attributes["@sort-separator"] = function (state, arg) {
    state.setOpt(this, "sort-separator", arg);
};
CSL.Attributes["@year-suffix-delimiter"] = function (state, arg) {
    state[this.name].opt["year-suffix-delimiter"] = arg;
};
CSL.Attributes["@after-collapse-delimiter"] = function (state, arg) {
    state[this.name].opt["after-collapse-delimiter"] = arg;
};
CSL.Attributes["@subsequent-author-substitute"] = function (state, arg) {
    state[this.name].opt["subsequent-author-substitute"] = arg;
};
CSL.Attributes["@subsequent-author-substitute-rule"] = function (state, arg) {
    state[this.name].opt["subsequent-author-substitute-rule"] = arg;
};
CSL.Attributes["@disambiguate-add-names"] = function (state, arg) {
    if (arg === "true") {
        state.opt["disambiguate-add-names"] = true;
    }
};
CSL.Attributes["@disambiguate-add-givenname"] = function (state, arg) {
    if (arg === "true") {
        state.opt["disambiguate-add-givenname"] = true;
    }
};
CSL.Attributes["@disambiguate-add-year-suffix"] = function (state, arg) {
    if (arg === "true" && state.opt.xclass !== "numeric") {
        state.opt["disambiguate-add-year-suffix"] = true;
    }
};
CSL.Attributes["@second-field-align"] = function (state, arg) {
    if (arg === "flush" || arg === "margin") {
        state[this.name].opt["second-field-align"] = arg;
    }
};
CSL.Attributes["@hanging-indent"] = function (state, arg) {
    if (arg === "true") {
        state[this.name].opt.hangingindent = 2;
    }
};
CSL.Attributes["@line-spacing"] = function (state, arg) {
    if (arg && arg.match(/^[.0-9]+$/)) {
        state[this.name].opt["line-spacing"] = parseFloat(arg, 10);
    }
};
CSL.Attributes["@entry-spacing"] = function (state, arg) {
    if (arg && arg.match(/^[.0-9]+$/)) {
        state[this.name].opt["entry-spacing"] = parseFloat(arg, 10);
    }
};
CSL.Attributes["@near-note-distance"] = function (state, arg) {
    state[this.name].opt["near-note-distance"] = parseInt(arg, 10);
};
CSL.Attributes["@text-case"] = function (state, arg) {
    var func = function (state, Item) {
        if (arg === "normal") {
            this.text_case_normal = true;
        } else {
            this.strings["text-case"] = arg;
            if (arg === "title") {
                var m = false;
                var default_locale = state.opt["default-locale"][0].slice(0, 2);
                if (Item.jurisdiction) {
                    this.strings["text-case"] = "passthrough";
                }
            }
        }
    };
    this.execs.push(func);
};
CSL.Attributes["@page-range-format"] = function (state, arg) {
    state.opt["page-range-format"] = arg;
};
CSL.Attributes["@year-range-format"] = function (state, arg) {
    state.opt["year-range-format"] = arg;
};
CSL.Attributes["@default-locale"] = function (state, arg) {
    if (this.name === 'style') {
        var lst, len, pos, m, ret;
        var m = arg.match(/-x-(sort|translit|translat)-/g);
        if (m) {
            for (pos = 0, len = m.length; pos < len; pos += 1) {
                m[pos] = m[pos].replace(/^-x-/, "").replace(/-$/, "");
            }
        }
        lst = arg.split(/-x-(?:sort|translit|translat)-/);
        ret = [lst[0]];
        for (pos = 1, len = lst.length; pos < len; pos += 1) {
            ret.push(m[pos - 1]);
            ret.push(lst[pos]);
        }
        lst = ret.slice();
        len = lst.length;
        for (pos = 1; pos < len; pos += 2) {
            state.opt[("locale-" + lst[pos])].push(lst[(pos + 1)].replace(/^\s*/g, "").replace(/\s*$/g, ""));
        }
        if (lst.length) {
            state.opt["default-locale"] = lst.slice(0, 1);
        } else {
            state.opt["default-locale"] = ["en"];
        }
    } else if (arg === "true") {
        this.default_locale = true;
    }
};
CSL.Attributes["@default-locale-sort"] = function (state, arg) {
    var lst, len, pos, m, ret;
    state.opt["default-locale-sort"] = arg;
};
CSL.Attributes["@demote-non-dropping-particle"] = function (state, arg) {
    state.opt["demote-non-dropping-particle"] = arg;
};
CSL.Attributes["@initialize-with-hyphen"] = function (state, arg) {
    if (arg === "false") {
        state.opt["initialize-with-hyphen"] = false;
    }
};
CSL.Attributes["@institution-parts"] = function (state, arg) {
    this.strings["institution-parts"] = arg;
};
CSL.Attributes["@if-short"] = function (state, arg) {
    if (arg === "true") {
        this.strings["if-short"] = true;
    }
};
CSL.Attributes["@substitute-use-first"] = function (state, arg) {
    this.strings["substitute-use-first"] = parseInt(arg, 10);
};
CSL.Attributes["@use-first"] = function (state, arg) {
    this.strings["use-first"] = parseInt(arg, 10);
};
CSL.Attributes["@stop-last"] = function (state, arg) {
    this.strings["stop-last"] = parseInt(arg, 10) * -1;
};
CSL.Attributes["@use-last"] = function (state, arg) {
    this.strings["use-last"] = parseInt(arg, 10);
};
CSL.Attributes["@reverse-order"] = function (state, arg) {
    if ("true" === arg) {
        this.strings["reverse-order"] = true;
    }
};
CSL.Attributes["@display"] = function (state, arg) {
    if (state.bibliography.tokens.length === 2) {
        state.opt.using_display = true;
    }
    this.strings.cls = arg;
};
module.exports = CSL;
CSL.Stack = function (val, literal) {
    this.mystack = [];
    if (literal || val) {
        this.mystack.push(val);
    }
    this.tip = this.mystack[0];
};
CSL.Stack.prototype.push = function (val, literal) {
    if (literal || val) {
        this.mystack.push(val);
    } else {
        this.mystack.push("");
    }
    this.tip = this.mystack[this.mystack.length - 1];
};
CSL.Stack.prototype.clear = function () {
    this.mystack = [];
    this.tip = {};
};
CSL.Stack.prototype.replace = function (val, literal) {
    if (this.mystack.length === 0) {
        throw "Internal CSL processor error: attempt to replace nonexistent stack item with " + val;
    }
    if (literal || val) {
        this.mystack[(this.mystack.length - 1)] = val;
    } else {
        this.mystack[(this.mystack.length - 1)] = "";
    }
    this.tip = this.mystack[this.mystack.length - 1];
};
CSL.Stack.prototype.pop = function () {
    var ret = this.mystack.pop();
    if (this.mystack.length) {
        this.tip = this.mystack[this.mystack.length - 1];
    } else {
        this.tip = {};
    }
    return ret;
};
CSL.Stack.prototype.value = function () {
    return this.mystack.slice(-1)[0];
};
CSL.Stack.prototype.length = function () {
    return this.mystack.length;
};
module.exports = CSL;
CSL.Parallel = function (state) {
    this.state = state;
    this.sets = new CSL.Stack([]);
    this.try_cite = true;
    this.use_parallels = false;
    this.midVars = ["section", "volume", "container-title", "collection-number", "issue", "page-first", "page", "number"];
    this.ignoreVarsLawGeneral = ["first-reference-note-number", "locator", "label","page-first","page","genre"];
    this.ignoreVarsLawProceduralHistory = ["issued", "first-reference-note-number", "locator", "label","page-first","page","genre","jurisdiction"];
    this.ignoreVarsOrders = ["first-reference-note-number"];
    this.ignoreVarsOther = ["first-reference-note-number", "locator", "label","section","page-first","page"];
};
CSL.Parallel.prototype.isMid = function (variable) {
    return (this.midVars.indexOf(variable) > -1);
};
CSL.Parallel.prototype.StartCitation = function (sortedItems, out) {
    this.parallel_conditional_blobs_list = [];
    if (this.use_parallels) {
        this.sortedItems = sortedItems;
        this.sortedItemsPos = -1;
        this.sets.clear();
        this.sets.push([]);
        this.in_series = true;
        this.delim_counter = 0;
        this.delim_pointers = [];
        if (out) {
            this.out = out;
        } else {
            this.out = this.state.output.queue;
        }
        this.master_was_neutral_cite = true;
    }
};
CSL.Parallel.prototype.StartCite = function (Item, item, prevItemID) {
    var position, len, pos, x, curr, master, last_id, prev_locator, curr_locator, is_master, parallel;
    if (this.use_parallels) {
        if (this.sets.value().length && this.sets.value()[0].itemId == Item.id) {
            this.ComposeSet();
        }
        this.sortedItemsPos += 1;
        if (item) {
            position = item.position;
        }
        this.try_cite = true;
        var has_required_var = false;
        for (var i = 0, ilen = CSL.PARALLEL_MATCH_VARS.length; i < ilen; i += 1) {
            if (Item[CSL.PARALLEL_MATCH_VARS[i]]) {
                has_required_var = true;
                break;
            }
        }
        var basics_ok = true;
        var last_cite = this.sets.value().slice(-1)[0];
        if (last_cite && last_cite.Item) {
            var lastJuris = last_cite.Item.jurisdiction ? last_cite.Item.jurisdiction.split(":")[0] : "";
            var thisJuris = Item.jurisdiction ? Item.jurisdiction.split(":")[0] : "";
            if (last_cite.Item.title !== Item.title) {
                basics_ok = false;
            } else if (lastJuris !== thisJuris) {
                basics_ok = false;
            } else if (last_cite.Item.type !== Item.type) {
                basics_ok = false;
            } else if (["article-journal","article-magazine"].indexOf(Item.type) > -1) {
                if (!this.state.opt.development_extensions.handle_parallel_articles
                   || last_cite.Item["container-title"] !== Item["container-title"]) {
                    basics_ok = false;
                }
            }
        }
        if (!basics_ok || !has_required_var || CSL.PARALLEL_TYPES.indexOf(Item.type) === -1) {
            this.try_cite = true;
            if (this.in_series) {
                this.in_series = false;
            }
        }
        this.cite = {};
        this.cite.front = [];
        this.cite.mid = [];
        this.cite.back = [];
        this.cite.front_collapse = {};
        this.cite.back_forceme = [];
        this.cite.position = position;
        this.cite.Item = Item;
        this.cite.itemId = "" + Item.id;
        this.cite.prevItemID = "" + prevItemID;
        this.target = "front";
        if (["treaty"].indexOf(Item.type) > -1) {
            this.ignoreVars = this.ignoreVarsOrders;
        } else if (["article-journal","article-magazine"].indexOf(Item.type) > -1) {
            this.ignoreVars = this.ignoreVarsOther;
        } else if (item && item.prefix) {
            this.ignoreVars = this.ignoreVarsLawProceduralHistory;
            this.cite.useProceduralHistory = true;
            var prev = this.sets.value()[(this.sets.value().length - 1)];
            if (prev && prev.back) {
                for (var i=prev.back.length-1;i>-1;i+=-1) {
                    if (prev.back[i] && prev[prev.back[i]]) {
                        delete prev[prev.back[i]];
                    }
                }
            }
        } else {
            this.ignoreVars = this.ignoreVarsLawGeneral;
        }
        if (this.sortedItems && this.sortedItemsPos > 0 && this.sortedItemsPos < this.sortedItems.length) {
            curr = this.sortedItems[this.sortedItemsPos][1];
            last_id = "" + this.sortedItems[(this.sortedItemsPos - 1)][1].id;
            master = this.state.registry.registry[last_id].parallel;
            prev_locator = false;
            if (master == curr.id) {
                len = this.sortedItemsPos - 1;
                for (pos = len; pos > -1; pos += -1) {
                    if (this.sortedItems[pos][1].id == Item.id) {
                        prev_locator = this.sortedItems[pos][1].locator;
                        break;
                    }
                }
                curr_locator = this.sortedItems[this.sortedItemsPos][1].locator;
                if (!prev_locator && curr_locator) {
                    curr.position = CSL.POSITION_IBID_WITH_LOCATOR;
                } else if (curr_locator === prev_locator) {
                    curr.position = CSL.POSITION_IBID;
                } else {
                    curr.position = CSL.POSITION_IBID_WITH_LOCATOR;
                }
            }
        } else if (this.state.registry.registry[Item.id]) {
            this.state.registry.registry[Item.id].parallel = false;
        } else {
            this.try_cite = false;
            this.force_collapse = false;
            return;
        }
        this.force_collapse = false;
        if (this.state.registry.registry[Item.id].parallel) {
            this.force_collapse = true;
        }
    }
};
CSL.Parallel.prototype.StartVariable = function (variable, real_variable) {
    if (this.use_parallels && (this.try_cite || this.force_collapse)) {
        if (variable === "names") {
            this.variable = variable + ":" + this.target;
        } else {
            this.variable = variable;
        }
        if (this.ignoreVars.indexOf(variable) > -1) {
            return;
        }
        if (variable === "container-title" && this.sets.value().length === 0) {
            this.master_was_neutral_cite = false;
        }
        this.data = {};
        this.data.value = "";
        this.data.blobs = [];
        var is_mid = this.isMid(variable);
        if (real_variable === "authority" && this.variable === "names:front" && this.sets.value().length) {
            var prev = this.sets.value()[(this.sets.value().length - 1)].Item;
            var thisAuthority = false;
            if (this.cite.Item.authority && this.cite.Item.authority.length) {
                thisAuthority = this.cite.Item.authority[0].literal;
            }
            var thatAuthority = false;
            if (prev.authority && prev.authority.length) {
                thatAuthority = prev.authority[0].literal;
            }
            if (thisAuthority !== thatAuthority) {
                this.try_cite = true;
                this.in_series = false;
            }
         } else if (this.target === "front" && is_mid) {
            this.target = "mid";
        } else if (this.target === "mid" && !is_mid && this.cite.Item.title && variable !== "names") {
            this.target = "back";
        } else if (this.target === "back" && is_mid) {
            this.try_cite = true;
            this.in_series = false;
        }
        if (variable === "number") {
            this.cite.front.push(this.variable);
        } else if (CSL.PARALLEL_COLLAPSING_MID_VARSET.indexOf(variable) > -1) {
            if (["article-journal","article-magazine"].indexOf(this.cite.Item.type) > -1) {
                this.cite.mid.push(this.variable);
            } else {
                this.cite.front.push(this.variable);
            }
        } else {
            this.cite[this.target].push(this.variable);
        }
   }
};
CSL.Parallel.prototype.AppendBlobPointer = function (blob) {
    if (this.use_parallels) {
        if (this.ignoreVars.indexOf(this.variable) > -1) {
            return;
        }
        if (this.use_parallels && (this.force_collapse || this.try_cite)) {
            if (["article-journal", "article-magazine"].indexOf(this.cite.Item.type) > -1) {
                if (["volume","page","page-first","issue"].indexOf(this.variable) > -1) {
                    return;
                }
                if ("container-title" === this.variable && this.cite.mid.length > 1) {
                    return;
                }
            }
            if (this.variable && (this.try_cite || this.force_collapse) && blob && blob.blobs) {
                if (!(this.cite.useProceduralHistory && this.target === "back")) {
                    this.data.blobs.push([blob, blob.blobs.length]);
                }
            }
        }
    }
};
CSL.Parallel.prototype.AppendToVariable = function (str, varname) {
    if (this.use_parallels) {
        if (this.ignoreVars.indexOf(this.variable) > -1) {
            return;
        }
        if (this.try_cite || this.force_collapse) {
            if (this.target !== "back" || true) {
                this.data.value += "::" + str;
            } else {
                var prev = this.sets.value()[(this.sets.value().length - 1)];
                if (prev) {
                    if (prev[this.variable]) {
                        if (prev[this.variable].value) {
                            this.data.value += "::" + str;
                        }
                    }
                }
            }
        }
    }
};
CSL.Parallel.prototype.CloseVariable = function () {
    if (this.use_parallels) {
        if (this.ignoreVars.indexOf(this.variable) > -1) {
            return;
        }
        if (this.try_cite || this.force_collapse) {
            this.cite[this.variable] = this.data;
            if (this.sets.value().length > 0) {
                var prev = this.sets.value()[(this.sets.value().length - 1)];
                if (this.target === "front" && this.variable === "issued") {
                    if (this.data.value && this.master_was_neutral_cite) {
                        this.target = "mid";
                    }
                }
                if (this.target === "front") {
                    if ((prev[this.variable] || this.data.value) && (!prev[this.variable] || this.data.value !== prev[this.variable].value)) {
                        if ("issued" !== this.variable) {
                            this.in_series = false;
                        }
                    }
                } else if (this.target === "mid") {
                    if (CSL.PARALLEL_COLLAPSING_MID_VARSET.indexOf(this.variable) > -1) {
                        if (prev[this.variable]) {
                            if (prev[this.variable].value === this.data.value) {
                                this.cite.front_collapse[this.variable] = true;
                            } else {
                                this.cite.front_collapse[this.variable] = false;
                            }
                        } else {
                            this.cite.front_collapse[this.variable] = false;
                        }
                    }
                } else if (this.target === "back") {
                    if (prev[this.variable]) {
                        if (this.data.value !== prev[this.variable].value 
                            && this.sets.value().slice(-1)[0].back_forceme.indexOf(this.variable) === -1) {
                            this.in_series = false;
                        }
                    }
                }
            }
        }
        this.variable = false;
    }
};
CSL.Parallel.prototype.CloseCite = function () {
    var x, pos, len, has_issued, use_journal_info, volume_pos, container_title_pos, section_pos;
    if (this.use_parallels && (this.force_collapse || this.try_cite)) {
        use_journal_info = false;
        if (!this.cite.front_collapse["container-title"]) {
            use_journal_info = true;
        }
        if (this.cite.front_collapse.volume === false) {
            use_journal_info = true;
        }
        if (this.cite.front_collapse["collection-number"] === false) {
            use_journal_info = true;
        }
        if (this.cite.front_collapse.section === false) {
            use_journal_info = true;
        }
        if (use_journal_info) {
            this.cite.use_journal_info = true;
            section_pos = this.cite.front.indexOf("section");
            if (section_pos > -1) {
                this.cite.front = this.cite.front.slice(0,section_pos).concat(this.cite.front.slice(section_pos + 1));
            }
            volume_pos = this.cite.front.indexOf("volume");
            if (volume_pos > -1) {
                this.cite.front = this.cite.front.slice(0,volume_pos).concat(this.cite.front.slice(volume_pos + 1));
            }
            container_title_pos = this.cite.front.indexOf("container-title");
            if (container_title_pos > -1) {
                this.cite.front = this.cite.front.slice(0,container_title_pos).concat(this.cite.front.slice(container_title_pos + 1));
            }
            var collection_number_pos = this.cite.front.indexOf("collection-number");
            if (collection_number_pos > -1) {
                this.cite.front = this.cite.front.slice(0,collection_number_pos).concat(this.cite.front.slice(collection_number_pos + 1));
            }
        }
        if (!this.in_series && !this.force_collapse) {
            this.ComposeSet(true);
        }
        if (this.sets.value().length === 0) {
            var has_date = false;
            for (pos = 0, len = this.cite.back.length; pos < len; pos += 1) {
                x = this.cite.back[pos];
                if (x === "issued" && this.cite["issued"] && this.cite["issued"].value) {
                    has_date = true;
                    break;
                }
            }
            if (!has_date) {
                this.cite.back_forceme.push("issued");
            }
        } else {
            var idx = this.cite.front.indexOf("issued");
            if (idx === -1 || this.master_was_neutral_cite) {
                this.cite.back_forceme = this.sets.value().slice(-1)[0].back_forceme;
            }
            if (idx > -1) {
                var prev = this.sets.value()[this.sets.value().length - 1];
                if (!prev["issued"]) {
                    this.cite.front = this.cite.front.slice(0, idx).concat(this.cite.front.slice(idx + 1));
                }
            }
            if (this.master_was_neutral_cite && this.cite.mid.indexOf("names:mid") > -1) {
                this.cite.front.push("names:mid");
            }
        }
        this.sets.value().push(this.cite);
    }
};
CSL.Parallel.prototype.ComposeSet = function (next_output_in_progress) {
    var cite, pos, master, len;
    if (this.use_parallels && (this.force_collapse || this.try_cite)) {
        var lengthCheck = this.sets.value().length;
        if (this.sets.value().length === 1) {
            if (!this.in_series) {
                this.sets.value().pop();
                this.delim_counter += 1;
            }
        } else {
            len = this.sets.value().length;
            for (pos = 0; pos < len; pos += 1) {
                cite = this.sets.value()[pos];
                if (pos === 0) {
                    this.delim_counter += 1;
                } else {
                    if (!cite.Item.title && cite.use_journal_info) {
                        this.delim_pointers.push(false);
                    } else {
                        this.delim_pointers.push(this.delim_counter);
                    }
                    this.delim_counter += 1;
                }
                if (CSL.POSITION_FIRST === cite.position) {
                    if (pos === 0) {
                        this.state.registry.registry[cite.itemId].master = true;
                        this.state.registry.registry[cite.itemId].siblings = [];
                        this.state.registry.registry[cite.itemId].parallel = false;
                    } else {
                        if (cite.prevItemID) {
                            if (!this.state.registry.registry[cite.prevItemID].parallel) {
                                this.state.registry.registry[cite.itemId].parallel = cite.prevItemID;
                            } else {
                                this.state.registry.registry[cite.itemId].parallel = this.state.registry.registry[cite.prevItemID].parallel;
                            }
                            this.state.registry.registry[cite.itemId].siblings = this.state.registry.registry[cite.prevItemID].siblings;
                            if (!this.state.registry.registry[cite.itemId].siblings) {
                                this.state.registry.registry[cite.itemId].siblings = [];
                                CSL.debug("WARNING: adding missing siblings array to registry object");
                            }
                            this.state.registry.registry[cite.itemId].siblings.push(cite.itemId);
                        }
                    }
                }
            }
            this.sets.push([]);
        }
        if (lengthCheck < 2) {
            this.purgeGroupsIfParallel(false);
        } else {
            this.purgeGroupsIfParallel(true);
        }
        this.in_series = true;
    }
};
CSL.Parallel.prototype.PruneOutputQueue = function () {
    var len, pos, series, ppos, llen, cite;
    if (this.use_parallels) {
        len = this.sets.mystack.length;
        for (pos = 0; pos < len; pos += 1) {
            series = this.sets.mystack[pos];
            if (series.length > 1) {
                llen = series.length;
                for (ppos = 0; ppos < llen; ppos += 1) {
                    cite = series[ppos];
                    if (ppos === 0) {
                        this.purgeVariableBlobs(cite, cite.back);
                    } else if (ppos === (series.length - 1)) {
                        this.purgeVariableBlobs(cite, cite.front.concat(cite.back_forceme));
                    } else {
                        this.purgeVariableBlobs(cite, cite.front.concat(cite.back));
                    }
                }
            }
        }
    }
};
CSL.Parallel.prototype.purgeVariableBlobs = function (cite, varnames) {
    var len, pos, varname, b, llen, ppos, out;
    if (this.use_parallels) {
        out = this.state.output.current.value();
        if ("undefined" === typeof out.length) {
            out = out.blobs;
        }
        for (pos = 0, len = this.delim_pointers.length; pos < len; pos += 1) {
            ppos = this.delim_pointers[pos];
            if (ppos !== false) {
                out[ppos].parallel_delimiter = ", ";
            }
        }
        len = varnames.length - 1;
        for (pos = len; pos > -1; pos += -1) {
            varname = varnames[pos];
            if (cite[varname]) {
                llen = cite[varname].blobs.length - 1;
                for (ppos = llen; ppos > -1; ppos += -1) {
                    b = cite[varname].blobs[ppos];
                    b[0].blobs = b[0].blobs.slice(0, b[1]).concat(b[0].blobs.slice((b[1] + 1)));
                    this.state.tmp.has_purged_parallel = true;
                    if (b[0] && b[0].strings && "string" == typeof b[0].strings.oops
                        && b[0].parent && b[0].parent) {
                        b[0].parent.parent.strings.delimiter = b[0].strings.oops;
                    }
                }
            }
        }
    }
};
CSL.Parallel.prototype.purgeGroupsIfParallel = function (original_condition) {
    for (var i = this.parallel_conditional_blobs_list.length - 1; i > -1; i += -1) {
        var obj = this.parallel_conditional_blobs_list[i];
        var purgeme = true;
        for (var j = 0, jlen = obj.conditions.length; j < jlen; j += 1) {
            if (!(!obj.conditions[j] === !!original_condition
                || ("master" === obj.conditions[j]
                    && !this.state.registry.registry[obj.id].master)
                || ("servant" === obj.conditions[j]
                    && !this.state.registry.registry[obj.id].parallel))) {
                var purgeme = false;
                break;
            }
        }
        if (purgeme) {
            var buffer = [];
            while (obj.blobs.length > obj.pos) {
                buffer.push(obj.blobs.pop());
            }
            if (buffer.length) {
                buffer.pop();
            }
            while (buffer.length) {
                obj.blobs.push(buffer.pop());
            }
        }
        this.parallel_conditional_blobs_list.pop();
    }
}
module.exports = CSL;
CSL.Util = {};
CSL.Util.Match = function () {
    this.any = function (token, state, tests) {
        return function (Item, item) {
            for (var i=0, ilen=tests.length; i < ilen; i += 1) {
                var result = tests[i](Item, item);
                if (result) {
                    return true;
                }
            }
            return false;
        };
    };
    this.none = function (token, state, tests) {
        return function (Item, item) {
            for (var i=0,ilen=tests.length;i<ilen;i+=1) {
                var result = tests[i](Item,item);
                if (result) {
                    return false;
                }
            }
            return true;
        };
    };
    this.all = function (token, state, tests) {
        return function (Item, item) {
            for (var i=0,ilen=tests.length;i<ilen;i+=1) {
                var result = tests[i](Item,item);
                if (!result) {
                    return false;
                }
            }
            return true;
        };
    };
    this[undefined] = this.all;
    this.nand = function (token, state, tests) {
        return function (Item, item) {
            for (var i=0,ilen=tests.length;i<ilen;i+=1) {
                var result = tests[i](Item,item);
                if (!result) {
                    return true;
                }
            }
            return false;
        };
    };
};
module.exports = CSL;
CSL.Transform = function (state) {
    var debug = false, abbreviations, token, fieldname, abbrev_family, opt;
    this.abbrevs = {};
    this.abbrevs["default"] = new state.sys.AbbreviationSegments();
    this.getTextSubField = getTextSubField;
    function getCountryOrJurisdiction(variable, normalizedKey, quashCountry) {
        var value = "";
        if (state.sys.getHumanForm) {
            if (variable === "country") {
                value = state.sys.getHumanForm(normalizedKey.toLowerCase(), false, true);
                value = value.split("|")[0];
            } else if (variable === "jurisdiction") {
                value = state.sys.getHumanForm(normalizedKey.toLowerCase(), false, true);
                if (!quashCountry) {
                    value = value.split("|").slice(1).join(", ");
                } else {
                    value = "";
                }
            }
	    }
	    return value;
    }
    function abbreviate(state, tok, Item, altvar, basevalue, family_var, use_field, form) {
        var value = "";
        var myabbrev_family = CSL.FIELD_CATEGORY_REMAP[family_var];
        if (!myabbrev_family) {
            return basevalue;
        }
        var variable = family_var;
        var normalizedKey = basevalue;
        if (state.sys.normalizeAbbrevsKey) {
            normalizedKey = state.sys.normalizeAbbrevsKey(family_var, basevalue);
        }
        var quashCountry = false;
        if (variable === "jurisdiction" && normalizedKey) {
            quashCountry = normalizedKey.indexOf(":") === -1;
        }
        if (state.sys.getAbbreviation) {
            if (["jurisdiction", "country", "language-name", "language-name-original"].indexOf(variable) > -1) {
                var loadJurisdiction = "default";
            } else if (Item.jurisdiction) {
                var loadJurisdiction = Item.jurisdiction;
            } else {
                var loadJurisdiction = "default";
            }
            var jurisdiction = state.transform.loadAbbreviation(loadJurisdiction, myabbrev_family, normalizedKey, Item.type);
            if (state.transform.abbrevs[jurisdiction][myabbrev_family] && normalizedKey) {
                var abbrev = state.transform.abbrevs[jurisdiction][myabbrev_family][normalizedKey];
                if (tok.strings.form === "short" && abbrev) {
                    if (quashCountry) {
                        value = "";
                    } else {
                        value = abbrev;
                    }
                } else {
	                value = getCountryOrJurisdiction(variable, normalizedKey, quashCountry);
                }
            }
        }
        if (!value 
            && (!state.opt.development_extensions.require_explicit_legal_case_title_short || Item.type !== 'legal_case') 
            && altvar && Item[altvar] && use_field) {
            value = Item[altvar];
        }
        if (!value && !state.sys.getAbbreviation && state.sys.getHumanForm) {
	        value = getCountryOrJurisdiction(variable, normalizedKey, quashCountry);
	    }
        if (!value && !quashCountry && (!state.sys.getHumanForm || variable !== "jurisdiction")) {
            value = basevalue;
        }
        return value;
    }
    function getFieldLocale(Item,field) {
        var ret = state.opt["default-locale"][0].slice(0, 2)
        var localeRex;
        if (state.opt.development_extensions.strict_text_case_locales) {
            localeRex = new RegExp("^([a-zA-Z]{2})(?:$|-.*| .*)");
        } else {
            localeRex = new RegExp("^([a-zA-Z]{2})(?:$|-.*|.*)");
        }
        if (Item.language) {
            var m = ("" + Item.language).match(localeRex);
            if (m) {
                ret = m[1];
            } else {
                ret = "tlh";
            }
        }
        if (Item.multi && Item.multi && Item.multi.main && Item.multi.main[field]) {
            ret = Item.multi.main[field];
        }
        if (!state.opt.development_extensions.strict_text_case_locales
           || state.opt.development_extensions.normalize_lang_keys_to_lowercase) {
            ret = ret.toLowerCase();
        }
        return ret;
    };
    function getTextSubField (Item, field, locale_type, use_default, stopOrig) {
        var m, lst, opt, o, oo, pos, key, ret, len, myret, opts;
        var usedOrig = stopOrig;
        var usingOrig = false;
        if (!Item[field]) {
            return {
                name:"",
                usedOrig:stopOrig,
                token: CSL.Util.cloneToken(this)
            };
        }
        ret = {name:"", usedOrig:stopOrig,locale:getFieldLocale(Item,field)};
        opts = state.opt[locale_type];
        var hasVal = false;
        var jurisdictionName = false;
        if (locale_type === 'locale-orig') {
            if (stopOrig) {
                ret = {name:"", usedOrig:stopOrig};
            } else {
                ret = {name:Item[field], usedOrig:false, locale:getFieldLocale(Item,field)};
            }
            hasVal = true;
            usingOrig = true;
        } else if (use_default && ("undefined" === typeof opts || opts.length === 0)) {
            var ret = {name:Item[field], usedOrig:true, locale:getFieldLocale(Item,field)};
            hasVal = true;
            usingOrig = true;
        }
        if (!hasVal) {
            for (var i = 0, ilen = opts.length; i < ilen; i += 1) {
                opt = opts[i];
                o = opt.split(/[\-_]/)[0];
                if (opt && Item.multi && Item.multi._keys[field] && Item.multi._keys[field][opt]) {
                    ret.name = Item.multi._keys[field][opt];
                    ret.locale = opt;
                    break;
                } else if (o && Item.multi && Item.multi._keys[field] && Item.multi._keys[field][o]) {
                    ret.name = Item.multi._keys[field][o];
                    ret.locale = o;
                    break;
                }
            }
            if (!ret.name && use_default) {
                ret = {name:Item[field], usedOrig:true, locale:getFieldLocale(Item,field)};
                usingOrig = true;
            }
        }
        ret.token = CSL.Util.cloneToken(this);
        if (["title", "container-title"].indexOf(field) > -1) {
            if (!usedOrig
                && (!ret.token.strings["text-case"]
                    || ret.token.strings["text-case"] === "sentence"
                    || ret.token.strings["text-case"] === "normal")) {
                var locale = usingOrig ? false : ret.locale;
                var seg = field.slice(0,-5);
                var sentenceCase = ret.token.strings["text-case"] === "sentence" ? true : false;
                ret.name = CSL.titlecaseSentenceOrNormal(state, Item, seg, locale, sentenceCase);
                delete ret.token.strings["text-case"];
            }
        }
        return ret;
    }
    function loadAbbreviation(jurisdiction, category, orig, itemType) {
        var pos, len;
        if (!jurisdiction) {
            jurisdiction = "default";
        }
        if (!orig) {
            if (!state.transform.abbrevs[jurisdiction]) {
                state.transform.abbrevs[jurisdiction] = new state.sys.AbbreviationSegments();
            }
            if (!state.transform.abbrevs[jurisdiction][category]) {
                state.transform.abbrevs[jurisdiction][category] = {};
            }
            return jurisdiction;
        }
        if (state.sys.getAbbreviation) {
            jurisdiction = state.sys.getAbbreviation(state.opt.styleID, state.transform.abbrevs, jurisdiction, category, orig, itemType, true);
            if (!jurisdiction) {
                jurisdiction = "default";
            }
        }
        return jurisdiction;
    }
    this.loadAbbreviation = loadAbbreviation;
    function publisherCheck (tok, Item, primary, family_var) {
        var varname = tok.variables[0];
        if (state.publisherOutput && primary) {
            if (["publisher","publisher-place"].indexOf(varname) === -1) {
                return false;
            } else {
                state.publisherOutput[varname + "-token"] = tok;
                state.publisherOutput.varlist.push(varname);
                var lst = primary.split(/;\s*/);
                if (lst.length === state.publisherOutput[varname + "-list"].length) {
                    state.publisherOutput[varname + "-list"] = lst;
                }
                for (var i = 0, ilen = lst.length; i < ilen; i += 1) {
                    lst[i] = abbreviate(state, tok, Item, false, lst[i], family_var, true);
                }
                state.tmp[varname + "-token"] = tok;
                return true;
            }
        }
        return false;
    }
    function getOutputFunction(variables, family_var, abbreviation_fallback, alternative_varname, transform_fallback) {
        var localesets;
        var langPrefs = CSL.LangPrefsMap[variables[0]];
        if (!langPrefs) {
            localesets = false;
        } else {
            localesets = state.opt['cite-lang-prefs'][langPrefs];
        }
        return function (state, Item, item, usedOrig) {
            var primary, primary_locale, secondary, secondary_locale, tertiary, tertiary_locale, primary_tok, group_tok, key;
            if (!variables[0] || (!Item[variables[0]] && !Item[alternative_varname])) {
                return null;
            }
            var slot = {primary:false, secondary:false, tertiary:false};
            if (state.tmp.area.slice(-5) === "_sort") {
                slot.primary = 'locale-sort';
            } else {
                if (localesets) {
                    var slotnames = ["primary", "secondary", "tertiary"];
                    for (var i = 0, ilen = slotnames.length; i < ilen; i += 1) {
                        if (localesets.length - 1 <  i) {
                            break;
                        }
                        if (localesets[i]) {
                            slot[slotnames[i]] = 'locale-' + localesets[i];
                        }
                    }
                } else {
                    slot.primary = 'locale-orig';
                }
            }
            if (variables[0] === "title-short" 
                || (state.tmp.area !== "bibliography"
                    && !(state.tmp.area === "citation"
                         && state.opt.xclass === "note"
                         && item && !item.position))) {
                slot.secondary = false;
                slot.tertiary = false;
            }
            if (state.tmp["publisher-list"]) {
                if (variables[0] === "publisher") {
                    state.tmp["publisher-token"] = this;
                } else if (variables[0] === "publisher-place") {
                    state.tmp["publisher-place-token"] = this;
                }
                return null;
            }
            var res = getTextSubField.call(this, Item, variables[0], slot.primary, true);
            primary = res.name;
            primary_locale = res.locale;
            var primary_tok = res.token;
            var primaryUsedOrig = res.usedOrig;
            if (publisherCheck(this, Item, primary, family_var)) {
                return null;
            }
            secondary = false;
            tertiary = false;
            if (slot.secondary) {
                res = getTextSubField.call(this, Item, variables[0], slot.secondary, false, res.usedOrig);
                secondary = res.name;
                secondary_locale = res.locale;
                var secondary_tok = res.token;
            }
            if (slot.tertiary) {
                res = getTextSubField.call(this, Item, variables[0], slot.tertiary, false, res.usedOrig);
                tertiary = res.name;
                tertiary_locale = res.locale;
                var tertiary_tok = res.token;
            }
            if (family_var) {
                primary = abbreviate(state, primary_tok, Item, alternative_varname, primary, family_var, true);
                if (primary) {
                    primary = quashCheck(primary);
                }
                if (secondary) {
                    secondary = abbreviate(state, secondary_tok, Item, false, secondary, family_var, true);
                }
                if (tertiary) {
                    tertiary = abbreviate(state, tertiary_tok, Item, false, tertiary, family_var, true);
                }
            }
            var primaryPrefix;
            if (slot.primary === "locale-translit") {
                primaryPrefix = state.opt.citeAffixes[langPrefs][slot.primary].prefix;
            }                
            if (primaryPrefix === "<i>" && variables[0] === 'title' && !primaryUsedOrig) {
                var hasItalic = false;
                for (var i = 0, ilen = primary_tok.decorations.length; i < ilen; i += 1) {
                    if (primary_tok.decorations[i][0] === "@font-style"
                        && primary_tok.decorations[i][1] === "italic") {
                        hasItalic = true;
                    }
                }
                if (!hasItalic) {
                    primary_tok.decorations.push(["@font-style", "italic"])
                }
            }
            if (primary_locale !== "en" && primary_tok.strings["text-case"] === "title") {
                primary_tok.strings["text-case"] = "passthrough";
            }
            if ("title" === variables[0]) {
                primary = CSL.demoteNoiseWords(state, primary, this["leading-noise-words"]);
            }
            if (secondary || tertiary) {
                state.output.openLevel("empty");
                primary_tok.strings.suffix = primary_tok.strings.suffix.replace(/[ .,]+$/,"");
                state.output.append(primary, primary_tok);
                if (secondary) {
                    secondary_tok.strings.prefix = state.opt.citeAffixes[langPrefs][slot.secondary].prefix;
                    secondary_tok.strings.suffix = state.opt.citeAffixes[langPrefs][slot.secondary].suffix;
                    if (!secondary_tok.strings.prefix) {
                        secondary_tok.strings.prefix = " ";
                    }
                    for (var i = secondary_tok.decorations.length - 1; i > -1; i += -1) {
                        if (['@quotes/true', '@font-style/italic', '@font-style/oblique', '@font-weight/bold'].indexOf(secondary_tok.decorations[i].join('/')) > -1) {
                            secondary_tok.decorations = secondary_tok.decorations.slice(0, i).concat(secondary_tok.decorations.slice(i + 1))
                        }
                    }
                    if (secondary_locale !== "en" && secondary_tok.strings["text-case"] === "title") {
                        secondary_tok.strings["text-case"] = "passthrough";
                    }
                    var secondary_outer = new CSL.Token();
                    secondary_outer.decorations.push(["@font-style", "normal"]);
                    secondary_outer.decorations.push(["@font-weight", "normal"]);
                    state.output.openLevel(secondary_outer);
                    state.output.append(secondary, secondary_tok);
                    state.output.closeLevel();
                    var blob_obj = state.output.current.value();
                    var blobs_pos = state.output.current.value().blobs.length - 1;
                    if (state.parallel.use_parallels) {
                        state.parallel.cite.front.push(variables[0] + ":secondary");
                        state.parallel.cite[variables[0] + ":secondary"] = {blobs:[[blob_obj, blobs_pos]]};
                    }
                }
                if (tertiary) {
                    tertiary_tok.strings.prefix = state.opt.citeAffixes[langPrefs][slot.tertiary].prefix;
                    tertiary_tok.strings.suffix = state.opt.citeAffixes[langPrefs][slot.tertiary].suffix;
                    if (!tertiary_tok.strings.prefix) {
                        tertiary_tok.strings.prefix = " ";
                    }
                    for (var i = tertiary_tok.decorations.length - 1; i > -1; i += -1) {
                        if (['@quotes/true', '@font-style/italic', '@font-style/oblique', '@font-weight/bold'].indexOf(tertiary_tok.decorations[i].join('/')) > -1) {
                            tertiary_tok.decorations = tertiary_tok.decorations.slice(0, i).concat(tertiary_tok.decorations.slice(i + 1))
                        }
                    }
                    if (tertiary_locale !== "en" && tertiary_tok.strings["text-case"] === "title") {
                        tertiary_tok.strings["text-case"] = "passthrough";
                    }
                    var tertiary_outer = new CSL.Token();
                    tertiary_outer.decorations.push(["@font-style", "normal"]);
                    tertiary_outer.decorations.push(["@font-weight", "normal"]);
                    state.output.openLevel(tertiary_outer);
                    state.output.append(tertiary, tertiary_tok);
                    state.output.closeLevel();
                    var blob_obj = state.output.current.value();
                    var blobs_pos = state.output.current.value().blobs.length - 1;
                    if (state.parallel.use_parallels) {
                        state.parallel.cite.front.push(variables[0] + ":tertiary");
                        state.parallel.cite[variables[0] + ":tertiary"] = {blobs:[[blob_obj, blobs_pos]]};
                    }
                }
                state.output.closeLevel();
            } else {
                state.output.append(primary, primary_tok);
            }
            return null;
        };
    }
    this.getOutputFunction = getOutputFunction;
    function quashCheck(value) {
        var m = value.match(/^!([-,_a-z]+)>>>/);
        if (m) {
            var fields = m[1].split(",");
            value = value.slice(m[0].length);
            for (var i = 0, ilen = fields.length; i < ilen; i += 1) {
                if (state.tmp.done_vars.indexOf(fields[i]) === -1) {
                    state.tmp.done_vars.push(fields[i]);
                }
            }
        }
        return value;
    }
    this.quashCheck = quashCheck;
};
module.exports = CSL;
CSL.Token = function (name, tokentype) {
    this.name = name;
    this.strings = {};
    this.strings.delimiter = undefined;
    this.strings.prefix = "";
    this.strings.suffix = "";
    this.decorations = [];
    this.variables = [];
    this.execs = [];
    this.tokentype = tokentype;
    this.evaluator = false;
    this.tests = [];
    this.rawtests = [];
    this.succeed = false;
    this.fail = false;
    this.next = false;
};
CSL.Util.cloneToken = function (token) {
    var newtok, key, pos, len;
    if ("string" === typeof token) {
        return token;
    }
    newtok = new CSL.Token(token.name, token.tokentype);
    for (var key in token.strings) {
        if (token.strings.hasOwnProperty(key)) {
            newtok.strings[key] = token.strings[key];
        }
    }
    if (token.decorations) {
        newtok.decorations = [];
        for (pos = 0, len = token.decorations.length; pos < len; pos += 1) {
            newtok.decorations.push(token.decorations[pos].slice());
        }
    }
    if (token.variables) {
        newtok.variables = token.variables.slice();
    }
    if (token.execs) {
        newtok.execs = token.execs.slice();
        newtok.tests = token.tests.slice();
        newtok.rawtests = token.tests.slice();
    }
    return newtok;
};
module.exports = CSL;
CSL.AmbigConfig = function () {
    this.maxvals = [];
    this.minval = 1;
    this.names = [];
    this.givens = [];
    this.year_suffix = false;
    this.disambiguate = 0;
};
module.exports = CSL;
CSL.Blob = function (str, token, levelname) {
    var len, pos, key;
    this.levelname = levelname;
    if (token) {
        this.strings = {"prefix":"","suffix":""};
        for (var key in token.strings) {
            if (token.strings.hasOwnProperty(key)) {
                this.strings[key] = token.strings[key];
            }
        }
        this.decorations = [];
        if (token.decorations === undefined) {
            len = 0;
        } else {
            len = token.decorations.length;
        }
        for (pos = 0; pos < len; pos += 1) {
            this.decorations.push(token.decorations[pos].slice());
        }
    } else {
        this.strings = {};
        this.strings.prefix = "";
        this.strings.suffix = "";
        this.strings.delimiter = "";
        this.decorations = [];
    }
    if ("string" === typeof str) {
        this.blobs = str;
    } else if (str) {
        this.blobs = [str];
    } else {
        this.blobs = [];
    }
    this.alldecor = [this.decorations];
};
CSL.Blob.prototype.push = function (blob) {
    if ("string" === typeof this.blobs) {
        throw "Attempt to push blob onto string object";
    } else if (false !== blob) {
        blob.alldecor = blob.alldecor.concat(this.alldecor);
        this.blobs.push(blob);
    }
};
module.exports = CSL;
CSL.NumericBlob = function (particle, num, mother_token, id) {
    this.id = id;
    this.alldecor = [];
    this.num = num;
    this.particle = particle;
    this.blobs = num.toString();
    this.status = CSL.START;
    this.strings = {};
    if (mother_token) {
        this.gender = mother_token.gender;
        this.decorations = mother_token.decorations;
        this.strings.prefix = mother_token.strings.prefix;
        this.strings.suffix = mother_token.strings.suffix;
        this.strings["text-case"] = mother_token.strings["text-case"];
        this.successor_prefix = mother_token.successor_prefix;
        this.range_prefix = mother_token.range_prefix;
        this.splice_prefix = mother_token.splice_prefix;
        this.formatter = mother_token.formatter;
        if (!this.formatter) {
            this.formatter =  new CSL.Output.DefaultFormatter();
        }
        if (this.formatter) {
            this.type = this.formatter.format(1);
        }
    } else {
        this.decorations = [];
        this.strings.prefix = "";
        this.strings.suffix = "";
        this.successor_prefix = "";
        this.range_prefix = "";
        this.splice_prefix = "";
        this.formatter = new CSL.Output.DefaultFormatter();
    }
};
CSL.NumericBlob.prototype.setFormatter = function (formatter) {
    this.formatter = formatter;
    this.type = this.formatter.format(1);
};
CSL.Output.DefaultFormatter = function () {};
CSL.Output.DefaultFormatter.prototype.format = function (num) {
    return num.toString();
};
CSL.NumericBlob.prototype.checkNext = function (next,start) {
    if (start) {
        this.status = CSL.START;
        if ("object" === typeof next) {
            if (next.num === (this.num + 1)) {
                next.status = CSL.SUCCESSOR;
            } else {
                next.status = CSL.SEEN;
            }
        }
    } else if (! next || !next.num || this.type !== next.type || next.num !== (this.num + 1)) {
        if (this.status === CSL.SUCCESSOR_OF_SUCCESSOR) {
            this.status = CSL.END;
        }
        if ("object" === typeof next) { 
           next.status = CSL.SEEN;
        }
    } else { // next number is in the sequence
        if (this.status === CSL.START || this.status === CSL.SEEN) {
            next.status = CSL.SUCCESSOR;
        } else if (this.status === CSL.SUCCESSOR || this.status === CSL.SUCCESSOR_OF_SUCCESSOR) {
            if (this.range_prefix) {
                next.status = CSL.SUCCESSOR_OF_SUCCESSOR;
                this.status = CSL.SUPPRESS;
            } else {
                next.status = CSL.SUCCESSOR;
            }
        }
    }
};
CSL.NumericBlob.prototype.checkLast = function (last) {
    if (this.status === CSL.SEEN 
    || (last.num !== (this.num - 1) && this.status === CSL.SUCCESSOR)) {
        this.status = CSL.SUCCESSOR;
        return true;
    }
    return false;
};
module.exports = CSL;
CSL.Util.fixDateNode = function (parent, pos, node) {
    var form, variable, datexml, subnode, partname, attr, val, prefix, suffix, children, key, subchildren, kkey, display, cslid;
    var lingo = this.cslXml.getAttributeValue(node, "lingo");
    var default_locale = this.cslXml.getAttributeValue(node, "default-locale");
    this.build.date_key = true;
    form = this.cslXml.getAttributeValue(node, "form");
    var lingo;
    if (default_locale) {
        lingo = this.opt["default-locale"][0];
    } else {
        lingo = this.cslXml.getAttributeValue(node, "lingo");
    }
    if (!this.getDate(form, default_locale)) {
        return parent;
    }
    var dateparts = this.cslXml.getAttributeValue(node, "date-parts");
    variable = this.cslXml.getAttributeValue(node, "variable");
    prefix = this.cslXml.getAttributeValue(node, "prefix");
    suffix = this.cslXml.getAttributeValue(node, "suffix");
    display = this.cslXml.getAttributeValue(node, "display");
    cslid = this.cslXml.getAttributeValue(node, "cslid");
    datexml = this.cslXml.nodeCopy(this.getDate(form, default_locale));
    this.cslXml.setAttribute(datexml, 'lingo', this.opt.lang);
    this.cslXml.setAttribute(datexml, 'form', form);
    this.cslXml.setAttribute(datexml, 'date-parts', dateparts);
    this.cslXml.setAttribute(datexml, "cslid", cslid);
    this.cslXml.setAttribute(datexml, 'variable', variable);
    this.cslXml.setAttribute(datexml, 'default-locale', default_locale);
    if (prefix) {
        this.cslXml.setAttribute(datexml, "prefix", prefix);
    }
    if (suffix) {
        this.cslXml.setAttribute(datexml, "suffix", suffix);
    }
    if (display) {
        this.cslXml.setAttribute(datexml, "display", display);
    }
    children = this.cslXml.children(datexml);
    for (var key in children) {
        subnode = children[key];
        if ("date-part" === this.cslXml.nodename(subnode)) {
            partname = this.cslXml.getAttributeValue(subnode, "name");
            if (default_locale) {
                this.cslXml.setAttributeOnNodeIdentifiedByNameAttribute(datexml, "date-part", partname, "@default-locale", "true");
            }
        }
    }
    children = this.cslXml.children(node);
    for (var key in children) {
        subnode = children[key];
        if ("date-part" === this.cslXml.nodename(subnode)) {
            partname = this.cslXml.getAttributeValue(subnode, "name");
            subchildren = this.cslXml.attributes(subnode);
            for (attr in subchildren) {
                if ("@name" === attr) {
                    continue;
                }
                if (lingo && lingo !== this.opt.lang) {
                    if (["@suffix", "@prefix", "@form"].indexOf(attr) > -1) {
                        continue;
                    }
                }
                val = subchildren[attr];
                this.cslXml.setAttributeOnNodeIdentifiedByNameAttribute(datexml, "date-part", partname, attr, val);
            }
        }
    }
    if ("year" === this.cslXml.getAttributeValue(node, "date-parts")) {
        this.cslXml.deleteNodeByNameAttribute(datexml, 'month');
        this.cslXml.deleteNodeByNameAttribute(datexml, 'day');
    } else if ("year-month" === this.cslXml.getAttributeValue(node, "date-parts")) {
        this.cslXml.deleteNodeByNameAttribute(datexml, 'day');
    } else if ("month-day" === this.cslXml.getAttributeValue(node, "date-parts")) {
        var childNodes = this.cslXml.children(datexml);
        for (var i=1,ilen=this.cslXml.numberofnodes(childNodes);i<ilen;i++) {
            if (this.cslXml.getAttributeValue(childNodes[i], 'name') === "year") {
                this.cslXml.setAttribute(childNodes[i-1], "suffix", "");
                break;
            }
        }
        this.cslXml.deleteNodeByNameAttribute(datexml, 'year');
    }
    return this.cslXml.insertChildNodeAfter(parent, node, pos, datexml);
};
module.exports = CSL;
CSL.dateMacroAsSortKey = function (state, Item) {
    CSL.dateAsSortKey.call(this, state, Item, true);
};
CSL.dateAsSortKey = function (state, Item, isMacro) {
    var dp, elem, value, e, yr, prefix, i, ilen, num;
    var variable = this.variables[0];
    var macroFlag = "empty";
    if (isMacro && state.tmp.extension) {
        macroFlag = "macro-with-date";
    }
    dp = Item[variable];
    if ("undefined" === typeof dp) {
        dp = {"date-parts": [[0]] };
        if (!dp.year) {
            state.tmp.empty_date = true;
        }
    }
    if ("undefined" === typeof this.dateparts) {
        this.dateparts = ["year", "month", "day"];
    }
    if (dp.raw) {
        dp = state.fun.dateparser.parseDateToArray(dp.raw);
    } else if (dp["date-parts"]) {
        dp = state.dateParseArray(dp);
    }
    if ("undefined" === typeof dp) {
        dp = {};
    }
    for (i = 0, ilen = CSL.DATE_PARTS_INTERNAL.length; i < ilen; i += 1) {
        elem = CSL.DATE_PARTS_INTERNAL[i];
        value = 0;
        e = elem;
        if (e.slice(-4) === "_end") {
            e = e.slice(0, -4);
        }
        if (dp[elem] && this.dateparts.indexOf(e) > -1) {
            value = dp[elem];
        }
        if (elem.slice(0, 4) === "year") {
            yr = CSL.Util.Dates[e].numeric(state, value);
            var prefix = "Y";
            if (yr[0] === "-") {
                prefix = "X";
                yr = yr.slice(1);
                yr = 9999 - parseInt(yr, 10);
            }
            state.output.append(CSL.Util.Dates[elem.slice(0, 4)].numeric(state, (prefix + yr)), macroFlag);
        } else {
            value = CSL.Util.Dates[e]["numeric-leading-zeros"](state, value);
            if (!value) {
                value = "00";
            }
            state.output.append(value, macroFlag);
        }
    }
};
CSL.Engine.prototype.dateParseArray = function (date_obj) {
    var ret, field, dpos, ppos, dp, exts, llen, pos, len, pppos, lllen;
    ret = {};
    for (field in date_obj) {
        if (field === "date-parts") {
            dp = date_obj["date-parts"];
            if (dp.length > 1) {
                if (dp[0].length !== dp[1].length) {
                    CSL.error("CSL data error: element mismatch in date range input.");
                }
            }
            exts = ["", "_end"];
            for (var i = 0, ilen = dp.length; i < ilen; i += 1) {
                for (var j = 0, jlen = CSL.DATE_PARTS.length; j < jlen; j += 1) {
                    if (isNaN(parseInt(dp[i][j], 10))) {
                        ret[(CSL.DATE_PARTS[j] + exts[i])] = undefined;
                    } else {
                        ret[(CSL.DATE_PARTS[j] + exts[i])] = parseInt(dp[i][j], 10);
                    }
                }
            }
        } else if (date_obj.hasOwnProperty(field)) {
            if (field === "literal" && "object" === typeof date_obj.literal && "string" === typeof date_obj.literal.part) {
                CSL.debug("Warning: fixing up weird literal date value");
                ret.literal = date_obj.literal.part;
            } else {
                ret[field] = date_obj[field];
            }
        }
    }
    return ret;
};
module.exports = CSL;
CSL.Util.Names = {};
CSL.Util.Names.compareNamesets = CSL.NameOutput.prototype._compareNamesets;
CSL.Util.Names.unInitialize = function (state, name) {
    var i, ilen, namelist, punctlist, ret;
    if (!name) {
        return "";
    }
    namelist = name.split(/(?:\-|\s+)/);
    punctlist = name.match(/(\-|\s+)/g);
    ret = "";
    for (i = 0, ilen = namelist.length; i < ilen; i += 1) {
        ret += namelist[i];
        if (i < ilen - 1) {
            ret += punctlist[i];
        }
    }
    return ret;
};
CSL.Util.Names.initializeWith = function (state, name, terminator, normalizeOnly) {
    var i, ilen, j, jlen, n, m, mm, str, lst, ret;
    if (!name) {
        return "";
    }
    if (!terminator) {
        terminator = "";
    }
    if (["Lord", "Lady"].indexOf(name) > -1
        || (!name.match(CSL.STARTSWITH_ROMANESQUE_REGEXP)
            && !terminator.match("%s"))) {
        return name;
    }
    var namelist = name;
    if (state.opt["initialize-with-hyphen"] === false) {
        namelist = namelist.replace(/\-/g, " ");
    }
    namelist = namelist.replace(/\s*\-\s*/g, "-").replace(/\s+/g, " ");
    namelist = namelist.replace(/-([a-z])/g, "\u2013$1");
    mm = namelist.match(/[\-\s]+/g);
    lst = namelist.split(/[\-\s]+/);
    if (lst.length === 0) {
        namelist = mm;
    } else {
        namelist = [lst[0]];
        for (i = 1, ilen = lst.length; i < ilen; i += 1) {
            namelist.push(mm[i - 1]);
            namelist.push(lst[i]);
        }
    }
    lst = namelist;
    for (i = lst.length -1; i > -1; i += -1) {
        if (lst[i] && lst[i].slice(0, -1).indexOf(".") > -1) {
            var lstend = lst.slice(i + 1);
            var lstmid = lst[i].slice(0, -1).split(".");
            lst = lst.slice(0, i);
            for (j = 0, jlen = lstmid.length; j < jlen; j += 1) {
                lst.push(lstmid[j] + ".");
                if (j < lstmid.length - 1) {
                    lst.push(" ");
                }
            }
            lst = lst.concat(lstend);
        }
    }
    if (normalizeOnly) {
        ret = CSL.Util.Names.doNormalize(state, lst, terminator);
    } else {
        ret = CSL.Util.Names.doInitialize(state, lst, terminator);
    }
    ret = ret.replace(/\u2013([a-z])/g, "-$1");
    return ret;
};
CSL.Util.Names.doNormalize = function (state, namelist, terminator, mode) {
    var i, ilen;
    terminator = terminator ? terminator : "";
    var isAbbrev = [];
    for (i = 0, ilen = namelist.length; i < ilen; i += 1) {
        if (namelist[i].length > 1 && namelist[i].slice(-1) === ".") {
            namelist[i] = namelist[i].slice(0, -1);
            isAbbrev.push(true);
        } else if (namelist[i].length === 1 && namelist[i].toUpperCase() === namelist[i]) {
            isAbbrev.push(true);
        } else {
            isAbbrev.push(false);
        }
    }
    var ret = [];
    for (i = 0, ilen = namelist.length; i < ilen; i += 2) {
        if (isAbbrev[i]) {
            if (i < namelist.length - 2) {
                namelist[i + 1] = "";
                var onlySpace = terminator.match(/^[\u0009\u000a\u000b\u000c\u000d\u0020\u00a0]+$/)
                if (
                    onlySpace
                    || (
                        (!terminator || (terminator.slice(-1) && !terminator.slice(-1).match(/[\u0009\u000a\u000b\u000c\u000d\u0020\u00a0]/)))
                        && namelist[i].length && namelist[i].match(CSL.ALL_ROMANESQUE_REGEXP)
                        && (namelist[i].length > 1 || namelist[i + 2].length > 1)
                    )
                ) {
                    namelist[i + 1] = " ";
                }
                if (namelist[i + 2].length > 1) {
                    namelist[i] = namelist[i] + terminator.replace(/\ufeff$/, "");
                } else {
                    namelist[i] = namelist[i] + terminator;
                }
            }
            if (i === namelist.length - 1) {
                namelist[i] = namelist[i] + terminator;
            }
        }
    }
    return namelist.join("").replace(/[\u0009\u000a\u000b\u000c\u000d\u0020\ufeff\u00a0]+$/,"").replace(/\s*\-\s*/g, "-").replace(/[\u0009\u000a\u000b\u000c\u000d\u0020]+/g, " ");
};
CSL.Util.Names.doInitialize = function (state, namelist, terminator, mode) {
    var i, ilen, m, j, jlen, lst, n;
    for (i = 0, ilen = namelist.length; i < ilen; i += 2) {
        n = namelist[i];
        if (!n) {
            continue;
        }
        m = n.match(CSL.NAME_INITIAL_REGEXP);
        if (!m && (!n.match(CSL.STARTSWITH_ROMANESQUE_REGEXP) && n.length > 1 && terminator.match("%s"))) {
            m = n.match(/(.)(.*)/);
        }
        if (m && m[1] === m[1].toUpperCase()) {
            var extra = "";
            if (m[2]) {
                var s = "";
                lst = m[2].split("");
                for (j = 0, jlen = lst.length; j < jlen; j += 1) {
                    var c = lst[j];
                    if (c === c.toUpperCase()) {
                        s += c;
                    } else {
                        break;
                    }
                }
                if (s.length < m[2].length) {
                    extra = s.toLocaleLowerCase();
                }
            }
            namelist[i] = m[1].toLocaleUpperCase() + extra;
            if (i < (ilen - 1)) {
                if (terminator.match("%s")) {
                    namelist[i] = terminator.replace("%s", namelist[i]);
                } else {
                    if (namelist[i + 1].indexOf("-") > -1) {
                        namelist[i + 1] = terminator + namelist[i + 1];
                    } else {
                        namelist[i + 1] = terminator;
                    }
                }
            } else {
                if (terminator.match("%s")) {
                    namelist[i] = terminator.replace("%s", namelist[i]);
                } else {
                    namelist.push(terminator);
                }
            }
        } else if (n.match(CSL.ROMANESQUE_REGEXP)) {
            namelist[i] = " " + n;
        }
    }
    var ret = namelist.join("");
    ret = ret.replace(/[\u0009\u000a\u000b\u000c\u000d\u0020\ufeff\u00a0]+$/,"").replace(/\s*\-\s*/g, "-").replace(/[\u0009\u000a\u000b\u000c\u000d\u0020]+/g, " ");
    return ret;
};
CSL.Util.Names.getRawName = function (name) {
    var ret = [];
    if (name.given) {
        ret.push(name.given);
    }
    if (name.family) {
        ret.push(name.family);
    }
    return ret.join(" ");
};
module.exports = CSL;
CSL.Util.Dates = {};
CSL.Util.Dates.year = {};
CSL.Util.Dates.year["long"] = function (state, num) {
    if (!num) {
        if ("boolean" === typeof num) {
            num = "";
        } else {
            num = 0;
        }
    }
    return num.toString();
};
CSL.Util.Dates.year.imperial = function (state, num, end, makeShort) {
    var year = "";
    if (!num) {
        if ("boolean" === typeof num) {
            num = "";
        } else {
            num = 0;
        }
    }
    end = end ? "_end" : "";
    var month = state.tmp.date_object["month" + end];
    month = month ? ""+month : "1";
    while (month.length < 2) {
        month = "0" + month;
    }
    var day = state.tmp.date_object["day" + end];
    day = day ? ""+day : "1";
    while (day.length < 2) {
        day = "0" + day;
    }
    var date = parseInt(num + month + day, 10);
    var label;
    var offset;
    if (date >= 18680908 && date < 19120730) {
        label = '\u660e\u6cbb';
        offset = 1867;
    } else if (date >= 19120730 && date < 19261225) {
        label = '\u5927\u6b63';
        offset = 1911;
    } else if (date >= 19261225 && date < 19890108) {
        label = '\u662d\u548c';
        offset = 1925;
    } else if (date >= 19890108) {
        label = '\u5e73\u6210';
        offset = 1988;
    }
    if (label && offset) {
        var normalizedKey = label;
        if (state.sys.normalizeAbbrevsKey) {
            normalizedKey = state.sys.normalizeAbbrevsKey("number", label);
        }
        if (!state.transform.abbrevs['default']['number'][normalizedKey]) {
            state.transform.loadAbbreviation('default', "number", normalizedKey);
        }
        if (state.transform.abbrevs['default']['number'][normalizedKey]) {
            label = state.transform.abbrevs['default']['number'][normalizedKey];
        };
        year = label + (num - offset);
    }
    return year;
};
CSL.Util.Dates.year["short"] = function (state, num) {
    num = num.toString();
    if (num && num.length === 4) {
        return num.substr(2);
    }
};
CSL.Util.Dates.year.numeric = function (state, num) {
    var m, pre;
    num = "" + num;
    var m = num.match(/([0-9]*)$/);
    if (m) {
        pre = num.slice(0, m[1].length * -1);
        num = m[1];
    } else {
        pre = num;
        num = "";
    }
    while (num.length < 4) {
        num = "0" + num;
    }
    return (pre + num);
};
CSL.Util.Dates.normalizeMonth = function (num, useSeason) {
    var ret;
    if (!num) {
        num = 0;
    }
    num = "" + num;
    if (!num.match(/^[0-9]+$/)) {
        num = 0;
    }
    num = parseInt(num, 10);
    if (useSeason) {
        var res = {stub: "month-", num: num};
        if (res.num < 1 || res.num > 20) {
            res.num = 0;
        } else if (res.num > 16) {
            res.stub = "season-";
            res.num = res.num - 16;
        } else if (res.num > 12) {
            res.stub = "season-";
            res.num = res.num - 12;
        }
        ret = res;
    } else {
        if (num < 1 || num > 12) {
            num = 0;
        }
        ret = num;
    }
    return ret;
}
CSL.Util.Dates.month = {};
CSL.Util.Dates.month.numeric = function (state, num) {
    var num = CSL.Util.Dates.normalizeMonth(num);
    if (!num) {
        num = "";
    }
    return num;
};
CSL.Util.Dates.month["numeric-leading-zeros"] = function (state, num) {
    var num = CSL.Util.Dates.normalizeMonth(num);
    if (!num) {
        num = "";
    } else {
        num = "" + num;
        while (num.length < 2) {
            num = "0" + num;
        }
    }
    return num;
};
CSL.Util.Dates.month["long"] = function (state, num, gender, forceDefaultLocale) {
    var res = CSL.Util.Dates.normalizeMonth(num, true);
    var num = res.num;
    if (!num) {
        num = "";
    } else {
        num = "" + num;
        while (num.length < 2) {
            num = "0" + num;
        }
        num = state.getTerm(res.stub + num, "long", 0, 0, false, forceDefaultLocale);
    }
    return num;
};
CSL.Util.Dates.month["short"] = function (state, num, gender, forceDefaultLocale) {
    var res = CSL.Util.Dates.normalizeMonth(num, true);
    var num = res.num;
    if (!num) {
        num = "";
    } else {
        num = "" + num;
        while (num.length < 2) {
            num = "0" + num;
        }
        num = state.getTerm(res.stub + num, "short", 0, 0, false, forceDefaultLocale);
    }
    return num;
};
CSL.Util.Dates.day = {};
CSL.Util.Dates.day.numeric = function (state, num) {
    return num.toString();
};
CSL.Util.Dates.day["long"] = CSL.Util.Dates.day.numeric;
CSL.Util.Dates.day["numeric-leading-zeros"] = function (state, num) {
    if (!num) {
        num = 0;
    }
    num = num.toString();
    while (num.length < 2) {
        num = "0" + num;
    }
    return num.toString();
};
CSL.Util.Dates.day.ordinal = function (state, num, gender) {
    return state.fun.ordinalizer.format(num, gender);
};
module.exports = CSL;
CSL.Util.Sort = {};
CSL.Util.Sort.strip_prepositions = function (str) {
    var m;
    if ("string" === typeof str) {
        m = str.toLocaleLowerCase();
        m = str.match(/^((a|an|the)\s+)/);
    }
    if (m) {
        str = str.substr(m[1].length);
    }
    return str;
};
module.exports = CSL;
CSL.Util.substituteStart = function (state, target) {
    var element_trace, display, bib_first, func, choose_start, if_start, nodetypes;
    func = function (state, Item) {
        for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
            if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                state.tmp.strip_periods += 1;
                break;
            }
        }
    };
    this.execs.push(func);
    if (this.decorations && (state.opt.development_extensions.csl_reverse_lookup_support || state.sys.csl_reverse_lookup_support)) {
        this.decorations.reverse();
        this.decorations.push(["@showid","true", this.cslid]);
        this.decorations.reverse();
    }
    nodetypes = ["number", "date", "names"];
    if (("text" === this.name && !this.postponed_macro) || nodetypes.indexOf(this.name) > -1) {
        element_trace = function (state, Item, item) {
            if (state.tmp.element_trace.value() === "author" || "names" === this.name) {
                if (item && item["author-only"]) {
                    state.tmp.element_trace.push("do-not-suppress-me");
                } else if (item && item["suppress-author"]) {
                }
            } else {
                if (item && item["author-only"]) {
                    state.tmp.element_trace.push("suppress-me");
                } else if (item && item["suppress-author"]) {
                    state.tmp.element_trace.push("do-not-suppress-me");
                }
            }
        };
        this.execs.push(element_trace);
    }
    display = this.strings.cls;
    this.strings.cls = false;
    if (state.build.render_nesting_level === 0) {
        if (state.build.area === "bibliography" && state.bibliography.opt["second-field-align"]) {
            bib_first = new CSL.Token("group", CSL.START);
            bib_first.decorations = [["@display", "left-margin"]];
            func = function (state, Item) {
                if (!state.tmp.render_seen) {
                    bib_first.strings.first_blob = Item.id;
                    state.output.startTag("bib_first", bib_first);
                }
            };
            bib_first.execs.push(func);
            target.push(bib_first);
        } else if (CSL.DISPLAY_CLASSES.indexOf(display) > -1) {
            bib_first = new CSL.Token("group", CSL.START);
            bib_first.decorations = [["@display", display]];
            func = function (state, Item) {
                bib_first.strings.first_blob = Item.id;
                state.output.startTag("bib_first", bib_first);
            };
            bib_first.execs.push(func);
            target.push(bib_first);
        }
        state.build.cls = display;
    }
    state.build.render_nesting_level += 1;
    if (state.build.substitute_level.value() === 1) {
        choose_start = new CSL.Token("choose", CSL.START);
        CSL.Node.choose.build.call(choose_start, state, target);
        if_start = new CSL.Token("if", CSL.START);
        func = function (Item,item) {
            if (state.tmp.can_substitute.value()) {
                return true;
            }
            return false;
        };
        if_start.tests.push(func);
        if_start.test = state.fun.match.any(this, state, if_start.tests);
        target.push(if_start);
    }
    if (state.sys.variableWrapper
        && this.variables_real
        && this.variables_real.length) {
        func = function (state, Item, item) {
            if (!state.tmp.just_looking && !state.tmp.suppress_decorations) {
                var variable_entry = new CSL.Token("text", CSL.START);
                variable_entry.decorations = [["@showid", "true"]];
                state.output.startTag("variable_entry", variable_entry);
                var position = null;
                if (item) {
                    position = item.position;
                }
                if (!position) position = 0;
                var positionMap = [
                    "first",
                    "subsequent",
                    "ibid",
                    "ibid-with-locator"
                ]
                var noteNumber = 0;
                if (item && item.noteIndex) {
                    noteNumber = item.noteIndex;
                }
                var firstReferenceNoteNumber = 0;
                if (item && item['first-reference-note-number']) {
                    firstReferenceNoteNumber = item['first-reference-note-number'];
                }
                var citationNumber = 0;
                if (item && item['citation-number']) {
                    citationNumber = item['citation-number'];
                }
                var index = 0;
                if (item && item.index) {
                    index = item.index;
                }
                var params = {
                    itemData: Item,
                    variableNames: this.variables,
                    context: state.tmp.area,
                    xclass: state.opt.xclass,
                    position: positionMap[position],
                    "note-number": noteNumber,
                    "first-reference-note-number": firstReferenceNoteNumber,
                    "citation-number": citationNumber,
                    "index": index,
                    "mode": state.opt.mode
                };
                state.output.current.value().params = params;
            }
        }
        this.execs.push(func);
    }
};
CSL.Util.substituteEnd = function (state, target) {
    var func, bib_first_end, bib_other, if_end, choose_end, toplevel, hasval, author_substitute, str;
    if (state.sys.variableWrapper
        && (this.hasVariable || (this.variables_real && this.variables_real.length))) {
        func = function (state,Item) {
            if (!state.tmp.just_looking && !state.tmp.suppress_decorations) {
                state.output.endTag("variable_entry");
            }
        }
        this.execs.push(func);
    }
    func = function (state, Item) {
        for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
            if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                state.tmp.strip_periods += -1;
                break;
            }
        }
    };
    this.execs.push(func);
    state.build.render_nesting_level += -1;
    if (state.build.render_nesting_level === 0) {
        if (state.build.cls) {
            func = function (state, Item) {
                state.output.endTag("bib_first");
            };
            this.execs.push(func);
            state.build.cls = false;
        } else if (state.build.area === "bibliography" && state.bibliography.opt["second-field-align"]) {
            bib_first_end = new CSL.Token("group", CSL.END);
            func = function (state, Item) {
                if (!state.tmp.render_seen) {
                    state.output.endTag("bib_first"); // closes bib_first
                }
            };
            bib_first_end.execs.push(func);
            target.push(bib_first_end);
            bib_other = new CSL.Token("group", CSL.START);
            bib_other.decorations = [["@display", "right-inline"]];
            func = function (state, Item) {
                if (!state.tmp.render_seen) {
                    state.tmp.render_seen = true;
                    state.output.startTag("bib_other", bib_other);
                }
            };
            bib_other.execs.push(func);
            target.push(bib_other);
        }
    }
    if (state.build.substitute_level.value() === 1) {
        if_end = new CSL.Token("if", CSL.END);
        target.push(if_end);
        choose_end = new CSL.Token("choose", CSL.END);
        CSL.Node.choose.build.call(choose_end, state, target);
    }
    if ("names" === this.name || ("text" === this.name && this.variables_real !== "title")) {
        author_substitute = new CSL.Token("text", CSL.SINGLETON);
        func = function (state, Item) {
            if (state.tmp.area !== "bibliography") return;
            if ("string" !== typeof state.bibliography.opt["subsequent-author-substitute"]) return;
            if (this.variables_real && !Item[this.variables_real]) return;
            if (state.tmp.substituted_variable !== this.variables_real) {
                return;
            }
            var subrule = state.bibliography.opt["subsequent-author-substitute-rule"];
            var i, ilen;
            var printing = !state.tmp.suppress_decorations;
            if (printing && state.tmp.subsequent_author_substitute_ok) {
                if (state.tmp.rendered_name) {
                    if ("partial-each" === subrule || "partial-first" === subrule) {
                        var dosub = true;
                        var rendered_name = [];
                        for (i = 0, ilen = state.tmp.name_node.children.length; i < ilen; i += 1) {
                            var name = state.tmp.rendered_name[i];
                            if (dosub
                                && state.tmp.last_rendered_name && state.tmp.last_rendered_name.length > (i - 1)
                                && name && !name.localeCompare(state.tmp.last_rendered_name[i])) {
                                str = new CSL.Blob(state[state.tmp.area].opt["subsequent-author-substitute"]);
                                state.tmp.name_node.children[i].blobs = [str];
                                if ("partial-first" === subrule) {
                                    dosub = false;
                                }
                            } else {
                                dosub = false;
                            }
                            rendered_name.push(name);
                        }
                        state.tmp.last_rendered_name = rendered_name;
                    } else if ("complete-each" === subrule) {
                        var rendered_name = state.tmp.rendered_name.join(",");
                        if (rendered_name) {
                            if (state.tmp.last_rendered_name && !rendered_name.localeCompare(state.tmp.last_rendered_name)) {
                                for (i = 0, ilen = state.tmp.name_node.children.length; i < ilen; i += 1) {
                                    str = new CSL.Blob(state[state.tmp.area].opt["subsequent-author-substitute"]);
                                    state.tmp.name_node.children[i].blobs = [str];
                                }
                            }
                            state.tmp.last_rendered_name = rendered_name;
                        }
                    } else {
                        var rendered_name = state.tmp.rendered_name.join(",");
                        if (rendered_name) {
                            if (state.tmp.last_rendered_name && !rendered_name.localeCompare(state.tmp.last_rendered_name)) {
                                str = new CSL.Blob(state[state.tmp.area].opt["subsequent-author-substitute"]);
                                if (state.tmp.label_blob) {
                                    state.tmp.name_node.top.blobs = [str,state.tmp.label_blob];
                                } else if (state.tmp.name_node.top.blobs.length) {
                                    state.tmp.name_node.top.blobs[0].blobs = [str];
                                } else {
                                    state.tmp.name_node.top.blobs = [str];
                                }
                                state.tmp.substituted_variable = this.variables_real;
                            }
                            state.tmp.last_rendered_name = rendered_name;
                        }
                    }
                    state.tmp.subsequent_author_substitute_ok = false;
                }
            }
        };
        this.execs.push(func);
    }
    if (("text" === this.name && !this.postponed_macro) || ["number", "date", "names"].indexOf(this.name) > -1) {
        func = function (state, Item) {
            state.tmp.element_trace.pop();
        };
        this.execs.push(func);
    }
};
module.exports = CSL;
CSL.Util.padding = function (num) {
    var m = num.match(/\s*(-{0,1}[0-9]+)/);
    if (m) {
        num = parseInt(m[1], 10);
        if (num < 0) {
            num = 99999999999999999999 + num;
        }
        num = "" + num;
        while (num.length < 20) {
            num = "0" + num;
        }
    }
    return num;
};
CSL.Util.LongOrdinalizer = function () {};
CSL.Util.LongOrdinalizer.prototype.init = function (state) {
    this.state = state;
};
CSL.Util.LongOrdinalizer.prototype.format = function (num, gender) {
    if (num < 10) {
        num = "0" + num;
    }
    var ret = CSL.Engine.getField(
        CSL.LOOSE, 
        this.state.locale[this.state.opt.lang].terms,
        "long-ordinal-" + num,
        "long", 
        0, 
        gender
    );
    if (!ret) {
        ret = this.state.fun.ordinalizer.format(num, gender);
    }
    this.state.tmp.cite_renders_content = true;
    return ret;
};
CSL.Util.Ordinalizer = function (state) {
    this.state = state;
    this.suffixes = {};
};
CSL.Util.Ordinalizer.prototype.init = function () {
    if (!this.suffixes[this.state.opt.lang]) {
        this.suffixes[this.state.opt.lang] = {};
        for (var i = 0, ilen = 3; i < ilen; i += 1) {
            var gender = [undefined, "masculine", "feminine"][i];
            this.suffixes[this.state.opt.lang][gender] = [];
            for (var j = 1; j < 5; j += 1) {
                var ordinal = this.state.getTerm("ordinal-0" + j, "long", false, gender);
                if ("undefined" === typeof ordinal) {
                    delete this.suffixes[this.state.opt.lang][gender];
                    break;
                }
                this.suffixes[this.state.opt.lang][gender].push(ordinal);
            }
        }
    }
};
CSL.Util.Ordinalizer.prototype.format = function (num, gender) {
    var str;
    num = parseInt(num, 10);
    str = "" + num;
    var suffix = "";
    var trygenders = [];
    if (gender) {
        trygenders.push(gender);
    }
    trygenders.push("neuter");
    if (this.state.locale[this.state.opt.lang].ord["1.0.1"]) {
        suffix = this.state.getTerm("ordinal",false,0,gender);
        var trygender;
        for (var i = 0, ilen = trygenders.length; i < ilen; i += 1) {
            trygender = trygenders[i];
            var ordinfo = this.state.locale[this.state.opt.lang].ord["1.0.1"];
            if (ordinfo["whole-number"][str] && ordinfo["whole-number"][str][trygender]) {
                suffix = this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["whole-number"][str][trygender],false,0,gender);
            } else if (ordinfo["last-two-digits"][str.slice(str.length - 2)] && ordinfo["last-two-digits"][str.slice(str.length - 2)][trygender]) {
                suffix = this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["last-two-digits"][str.slice(str.length - 2)][trygender],false,0,gender);
            } else if (ordinfo["last-digit"][str.slice(str.length - 1)] && ordinfo["last-digit"][str.slice(str.length - 1)][trygender]) {
                suffix = this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["last-digit"][str.slice(str.length - 1)][trygender],false,0,gender);
            }
            if (suffix) {
                break;
            }
        }
    } else {
        if (!gender) {
            gender = undefined;
        }
        this.state.fun.ordinalizer.init();
        if ((num / 10) % 10 === 1 || (num > 10 && num < 20)) {
            suffix = this.suffixes[this.state.opt.lang][gender][3];
        } else if (num % 10 === 1 && num % 100 !== 11) {
            suffix = this.suffixes[this.state.opt.lang][gender][0];
        } else if (num % 10 === 2 && num % 100 !== 12) {
            suffix = this.suffixes[this.state.opt.lang][gender][1];
        } else if (num % 10 === 3 && num % 100 !== 13) {
            suffix = this.suffixes[this.state.opt.lang][gender][2];
        } else {
            suffix = this.suffixes[this.state.opt.lang][gender][3];
        }
    }
    str = str += suffix;
    return str;
};
CSL.Util.Romanizer = function () {};
CSL.Util.Romanizer.prototype.format = function (num) {
    var ret, pos, n, numstr, len;
    ret = "";
    if (num < 6000) {
        numstr = num.toString().split("");
        numstr.reverse();
        pos = 0;
        n = 0;
        len = numstr.length;
        for (pos = 0; pos < len; pos += 1) {
            n = parseInt(numstr[pos], 10);
            ret = CSL.ROMAN_NUMERALS[pos][n] + ret;
        }
    }
    return ret;
};
CSL.Util.Suffixator = function (slist) {
    if (!slist) {
        slist = CSL.SUFFIX_CHARS;
    }
    this.slist = slist.split(",");
};
CSL.Util.Suffixator.prototype.format = function (N) {
    var X;
    N += 1;
    var key = "";
    do {
        X = ((N % 26) === 0) ? 26 : (N % 26);
        var key = this.slist[X-1] + key;
        N = (N - X) / 26;
    } while ( N !== 0 );
    return key;
};
CSL.Engine.prototype.processNumber = function (node, ItemObject, variable, type) {
    var val, m, i, ilen, j, jlen;
    var debug = false;
    var me = this;
    function normalizeFieldValue(str, defaultLabel) {
        str = str.trim();
        var m = str.match(/^([^ ]+)/);
        if (m && !CSL.STATUTE_SUBDIV_STRINGS[m[1]]) {
            var embeddedLabel = null;
            if (variable === "locator" ) {
                if (ItemObject.label) {
                    embeddedLabel = CSL.STATUTE_SUBDIV_STRINGS_REVERSE[ItemObject.label];
                } else {
                    embeddedLabel = "p.";
                }
            } else {
                embeddedLabel = CSL.STATUTE_SUBDIV_STRINGS_REVERSE[variable];
            }
            if (embeddedLabel) {
                str = embeddedLabel + " " + str;
            }
        }
        return str;
    }
    function composeNumberInfo(origLabel, label, val, joiningSuffix) {
        joiningSuffix = joiningSuffix ? joiningSuffix : "";
        var info = {};
        if (!label && !CSL.STATUTE_SUBDIV_STRINGS_REVERSE[variable]) {
                label = "var:"+variable;
        }
        if (label) {
            var m = label.match(/(\s*)([^\s]+)(\s*)/);
            info.label = m[2];
            info.origLabel = origLabel;
            info.labelSuffix = m[3] ? m[3] : "";
            info.plural = 0;
            info.labelVisibility = false;
        }
        var m = val.match(/^([0-9]*[a-zA-Z]+0*)?([0-9]+(?:[a-zA-Z]*|[-,a-zA-Z]+))$/);
        if (m) {
            info.particle = m[1] ? m[1] : "";
            info.value = m[2];
        } else {
            info.particle = "";
            info.value = val;
        }
        info.joiningSuffix = joiningSuffix.replace(/\s*-\s*/, "-");
        return info;
    };
    function fixupSubsections(elems) {
        for (var i=elems.length-2;i>-1;i-=2) {
            if (elems[i] === "-"
               && elems[i-1].match(/^(?:(?:[a-z]|[a-z][a-z]|[a-z][a-z][a-z]|[a-z][a-z][a-z][a-z])\.  *)*[0-9]+[,a-zA-Z]+$/)
               && elems[i+1].match(/^[,a-zA-Z]+$/)) {
                elems[i-1] = elems.slice(i-1,i+2).join("");
                elems = elems.slice(0,i).concat(elems.slice(i+2));
            }
        }
        return elems;
    }
    function parseString(str, defaultLabel) {
        defaultLabel = defaultLabel ? defaultLabel : "";
        str = normalizeFieldValue(str, defaultLabel);
        var elems = [];
        var m = str.match(/(;\s+|,\s+|\s*\\*[\-\u2013]+\s*|\s*&\s*)/g);
        if (m) {
            var lst = str.split(/(?:;\s+|,\s+|\s*\\*[\-\u2013]+\s*|\s*&\s*)/);
            for (var i=0,ilen=lst.length-1; i<ilen; i++) {
                elems.push(lst[i]);
                elems.push(m[i]);
            }
            elems.push(lst[lst.length-1]);
            elems = fixupSubsections(elems);
        } else {
            var elems = [str];
        }
        var values = [];
        var label = defaultLabel;
        var origLabel = "";
        for (var i=0,ilen=elems.length;i<ilen;i += 2) {
            var m = elems[i].match(/((?:^| )(?:[a-z]|[a-z][a-z]|[a-z][a-z][a-z]|[a-z][a-z][a-z][a-z])(?:\.| ) *)/g);
            if (m) {
                var lst = elems[i].split(/(?:(?:^| )(?:[a-z]|[a-z][a-z]|[a-z][a-z][a-z]|[a-z][a-z][a-z][a-z])(?:\.| ) *)/);
                for (var j=lst.length-1;j>0;j--) {
                    if (lst[j-1] && (!lst[j].match(/^[0-9]+([-;,:a-zA-Z]*)$/) || !lst[j-1].match(/^[0-9]+([-;,:a-zA-Z]*)$/))) {
                        lst[j-1] = lst[j-1] + m[j-1] + lst[j];
                        lst = lst.slice(0,j).concat(lst.slice(j+1))
                        m = m.slice(0,j-1).concat(m.slice(j))
                    }
                }
                if (m.length > 0) {
                    var slug = m[0].trim();
                    var notAlabel = !CSL.STATUTE_SUBDIV_STRINGS[slug]
                        || !me.getTerm(CSL.STATUTE_SUBDIV_STRINGS[slug])
                        || (["locator", "number"].indexOf(variable) === -1 && CSL.STATUTE_SUBDIV_STRINGS[slug] !== variable);
                    if (notAlabel) {
                        if (i === 0) {
                            m = m.slice(1);
                            lst[0] = lst[0] + " " + slug + " " + lst[1];
                            lst = lst.slice(0,1).concat(lst.slice(2))
                        }
                    } else {
                        origLabel = slug;
                    }
                }
                for (var j=0,jlen=lst.length; j<jlen; j++) {
                    if (lst[j] || j === (lst.length-1)) {
                        var filteredOrigLabel;
                        label = m[j-1] ? m[j-1] : label;
                        if (origLabel === label.trim()) {
                            filteredOrigLabel = "";
                        } else {
                            filteredOrigLabel = origLabel;
                        }
                        var str = lst[j] ? lst[j].trim() : "";
                        if (j === (lst.length-1)) {
                            values.push(composeNumberInfo(filteredOrigLabel, label, str, elems[i+1]));
                        } else {
                            values.push(composeNumberInfo(filteredOrigLabel, label, str));
                        }
                    }
                }
            } else {
                var filteredOrigLabel;
                if (origLabel === label.trim()) {
                    filteredOrigLabel = "";
                } else {
                    filteredOrigLabel = origLabel;
                }
                values.push(composeNumberInfo(filteredOrigLabel, label, elems[i], elems[i+1]));
            }
        }
        return values;
    }
    function setSpaces(values) {
        for (var i=0,ilen=values.length-1;i<ilen;i++) {
            if (!values[i].joiningSuffix && values[i+1].label) {
                values[i].joiningSuffix = " ";
            }
        }
    }
    function fixNumericAndCount(values, i, currentLabelInfo) {
        var master = values[currentLabelInfo.pos];
        var val = values[i].value;
        var isEscapedHyphen = master.joiningSuffix === "\\-";
        if (val.particle && val.particle !== master.particle) {
            currentLabelInfo.collapsible = false;
        }
        var mVal = val.match(/^[0-9]+([-,:a-zA-Z]*)$/);
        var mCurrentLabel = master.value.match(/^[0-9]+([-,:a-zA-Z]*)$/);
        if (!val || !mVal || !mCurrentLabel || isEscapedHyphen) {
            currentLabelInfo.collapsible = false;
            if (!val || !mCurrentLabel) {
                currentLabelInfo.numeric = false;
            }
            if (isEscapedHyphen) {
                currentLabelInfo.count--;
            }
        }
        if ((mVal && mVal[1]) || (mCurrentLabel && mCurrentLabel[1])) {
            currentLabelInfo.collapsible = false;
        }
        if (undefined === values[i].collapsible) {
            for (var j=i,jlen=i+currentLabelInfo.count;j<jlen;j++) {
                if (isNaN(parseInt(values[j].value)) && !values[j].value.match(/^[ivxlcmIVXLCM]+$/)) {
                    values[j].collapsible = false;
                } else {
                    values[j].collapsible = true;
                }
            }
            currentLabelInfo.collapsible = values[i].collapsible;
        }
        var isCollapsible = currentLabelInfo.collapsible;
        for (var j=currentLabelInfo.pos,jlen=(currentLabelInfo.pos + currentLabelInfo.count); j<jlen; j++) {
            if (currentLabelInfo.count > 1 && isCollapsible) {
                values[j].plural = 1;
            }
            values[j].numeric = currentLabelInfo.numeric;
            values[j].collapsible = currentLabelInfo.collapsible;
        }
    }
    function fixLabelVisibility(values, groupStartPos, currentLabelInfo) {
        if (currentLabelInfo.label.slice(0, 4) !== "var:") {
            if (currentLabelInfo.pos === 0) {
                if (variable === "locator" || variable === "number") {
                    if (!me.getTerm(CSL.STATUTE_SUBDIV_STRINGS[currentLabelInfo.label])) {
                        values[currentLabelInfo.pos].labelVisibility = true;
                    }
                }
                if (["locator", "number"].indexOf(variable) === -1) {
                    if (CSL.STATUTE_SUBDIV_STRINGS[currentLabelInfo.label] !== variable) {
                        values[0].labelVisibility = true;
                    }
                }
            } else {
                values[currentLabelInfo.pos].labelVisibility = true;
            }
        }
    }
    function setPluralsAndNumerics(values) {
        if (values.length === 0) return;
        var groupStartPos = 0;
        var groupCount = 1;
        for (var i=1,ilen=values.length;i<ilen;i++) {
            var lastVal = values[i-1];
            var thisVal = values[i];
            if (lastVal.label === thisVal.label && lastVal.particle === lastVal.particle) {
                groupCount++;
            } else {
                var currentLabelInfo = JSON.parse(JSON.stringify(values[groupStartPos]));
                currentLabelInfo.pos = groupStartPos;
                currentLabelInfo.count = groupCount;
                currentLabelInfo.numeric = true;
                fixNumericAndCount(values, groupStartPos, currentLabelInfo);
                if (i === 0 || (lastVal.label !== thisVal.label)) {
                    fixLabelVisibility(values, groupStartPos, currentLabelInfo);
                }
                groupStartPos = i;
                groupCount = 1;
            }
        }
        var currentLabelInfo = JSON.parse(JSON.stringify(values[groupStartPos]));
        currentLabelInfo.pos = groupStartPos;
        currentLabelInfo.count = groupCount;
        currentLabelInfo.numeric = true;
        fixNumericAndCount(values, groupStartPos, currentLabelInfo);
        fixLabelVisibility(values, groupStartPos, currentLabelInfo);
        if (values.length && values[0].numeric && variable.slice(0, 10) === "number-of-") {
            if (parseInt(ItemObject[variable], 10) > 1) {
                values[0].plural = 1;
            }
        }
    }        
    function setStyling(values) {
        var masterNode = CSL.Util.cloneToken(node);
        var masterStyling = new CSL.Token();
        if (!me.tmp.just_looking) {
            for (var j=masterNode.decorations.length-1;j>-1;j--) {
                if (masterNode.decorations[j][0] === "@quotes") {
                    masterStyling.decorations = masterStyling.decorations.concat(masterNode.decorations.slice(j, j+1));
                    masterNode.decorations = masterNode.decorations.slice(0, j).concat(masterNode.decorations.slice(j+1))
                }
            }
            masterStyling.strings.prefix = masterNode.strings.prefix;
            masterNode.strings.prefix = "";
            masterStyling.strings.suffix = masterNode.strings.suffix;
            masterNode.strings.suffix = "";
        }
        var masterLabel = values.length ? values[0].label : null;
        if (values.length) {
            for (var i=0,ilen=values.length; i<ilen; i++) {
                var val = values[i];
                var newnode = CSL.Util.cloneToken(masterNode);
                newnode.gender = node.gender;
                if (masterLabel === val.label) {
                    newnode.formatter = node.formatter;
                }
                if (val.numeric) {
                    newnode.successor_prefix = val.successor_prefix;
                }
                newnode.strings.suffix = newnode.strings.suffix + stripHyphenBackslash(val.joiningSuffix);
                val.styling = newnode;
            }
            if (!me.tmp.just_looking) {
                if (values[0].value.slice(0,1) === "\"" && values[values.length-1].value.slice(-1) === "\"") {
                    values[0].value = values[0].value.slice(1);
                    values[values.length-1].value = values[values.length-1].value.slice(0,-1);
                    masterStyling.decorations.push(["@quotes", true]);
                }
            }
        }
        return masterStyling;
    }
    function stripHyphenBackslash(joiningSuffix) {
        return joiningSuffix.replace("\\-", "-");
    }
    function fixupRangeDelimiter(variable, val, rangeDelimiter, isNumeric) {
        var isPage = checkPage(variable, val);
        var hasTerm = checkTerm(variable, val);
        if (hasTerm && rangeDelimiter === "-") {
            if (isNumeric) {
                if (isPage || ["locator", "issue", "volume", "edition", "number"].indexOf(variable) > -1) {
                    rangeDelimiter = me.getTerm("page-range-delimiter")
                    if (!rangeDelimiter) {
                        rangeDelimiter = "\u2013";
                    }
                }
                if (variable === "collection-number") {
                    rangeDelimiter = me.getTerm("year-range-delimiter");
                    if (!rangeDelimiter) {
                        rangeDelimiter = "\u2013";
                    }
                }
            }
        }
        return rangeDelimiter;
    }
    function checkPage(variable, val) {
        return variable === "page" 
            || (variable === "locator" && (["p."].indexOf(val.label) > -1 || ["p."].indexOf(val.origLabel) > -1));
    }
    function checkTerm(variable, val) {
        var ret = true;
        if (variable === "locator") {
            var label;
            if (val.origLabel) {
                label = val.origLabel;
            } else {
                label = val.label;
            }
            ret = !!me.getTerm(CSL.STATUTE_SUBDIV_STRINGS[label]);
        }
        return ret;
    }
    function manglePageNumbers(values, i, currentInfo) {
        if (i<1) return;
        if (currentInfo.count !== 2) {
            return;
        }
        if (values[i-1].particle !== values[i].particle) {
            return;
        }
        if (values[i-1].joiningSuffix !== "-") {
            currentInfo.count = 1;
            return;
        }
        if (!me.opt["page-range-format"] && parseInt(values[i-1].value, 10) > parseInt(values[i].value, 10)) {
            values[i-1].joiningSuffix = fixupRangeDelimiter(variable, values[i], values[i-1].joiningSuffix, true);
            return;
        }
        var val = values[i];
        var isPage = checkPage(variable, val);
        if (isPage && !isNaN(parseInt(values[i-1].value)) && !isNaN(parseInt(values[i].value))) {
            var str = values[i-1].particle + values[i-1].value + " - " + values[i].particle + values[i].value;
            str = me.fun.page_mangler(str);
        } else {
            if (("" + values[i-1].value).match(/^([0-9]+|[ivxlcmIVXLCM]+)$/) && ("" + values[i].value).match(/^([0-9]+|[ivxlcmIVXLCM]+)$/)) {
                values[i-1].joiningSuffix = me.getTerm("page-range-delimiter");
            }
            str = values[i-1].value + stripHyphenBackslash(values[i-1].joiningSuffix) + values[i].value;
        }
        var m = str.match(/^((?:[0-9]*[a-zA-Z]+0*))?([0-9]+)(\s*[^0-9]+\s*)([-,a-zA-Z]?0*)([0-9]+)$/);
        if (m) {
            var rangeDelimiter = m[3];
            rangeDelimiter = fixupRangeDelimiter(variable, val, rangeDelimiter, values[i].numeric);
            values[i-1].particle = m[1];
            values[i-1].value = m[2];
            values[i-1].joiningSuffix = rangeDelimiter;
            values[i].particle = m[4];
            values[i].value = m[5];
        }
        currentInfo.count = 0;
    }
    function fixRanges(values) {
        if (!node) return;
        if (["page", "page-first", "chapter-number", "collection-number", "edition", "issue", "number", "number-of-pages", "number-of-volumes", "volume", "locator"].indexOf(variable) === -1) return;
        var currentInfo = {
            count: 0,
            label: null,
            lastHadRangeDelimiter: false
        }
        for (var i=0,ilen=values.length; i<ilen; i++) {
            var val = values[i];
            if (!val.collapsible) {
                currentInfo.count = 0;
                currentInfo.label = null;
                var isNumeric = val.numeric;
                val.joiningSuffix = fixupRangeDelimiter(variable, val, val.joiningSuffix, isNumeric);
            } else if (currentInfo.label === val.label && val.joiningSuffix === "-") {
                currentInfo.count = 1;
            } else if (currentInfo.label === val.label && val.joiningSuffix !== "-") {
                currentInfo.count++;
                if (currentInfo.count === 2) {
                    manglePageNumbers(values, i, currentInfo);
                }
            } else if (currentInfo.label !== val.label) {
                currentInfo.label = val.label;
                currentInfo.count = 1;
            } else {
                currentInfo.count = 1;
                currentInfo.label = val.label;
            }
        }
        if (currentInfo.count === 2) {
            manglePageNumbers(values, values.length-1, currentInfo);
        }
    }
    function setVariableParams(shadow_numbers, variable, values) {
        var obj = shadow_numbers[variable];
        if (values.length) {
            obj.numeric = values[0].numeric;
            obj.collapsible = values[0].collapsible;
            obj.plural = values[0].plural;
            obj.label = CSL.STATUTE_SUBDIV_STRINGS[values[0].label];
            if (variable === "number" && obj.label === "issue" && me.getTerm("number")) {
                obj.label = "number";
            }
        }
    }
    if (node && this.tmp.shadow_numbers[variable] && this.tmp.shadow_numbers[variable].values.length) {
        var values = this.tmp.shadow_numbers[variable].values;
        fixRanges(values);
            this.tmp.shadow_numbers[variable].masterStyling = setStyling(values);
        return;
    }
    if (!this.tmp.shadow_numbers[variable]) {
        this.tmp.shadow_numbers[variable] = {
            values:[]
        };
    }
    if (!ItemObject) {
        return;
    }
    var languageRole = CSL.LangPrefsMap[variable];
    if (languageRole) {
        var localeType = this.opt["cite-lang-prefs"][languageRole][0];
        val = this.transform.getTextSubField(ItemObject, variable, "locale-"+localeType, true);
        val = val.name;
    } else {
        val = ItemObject[variable];
    }
    if (val && this.sys.getAbbreviation) {
        var jurisdiction = this.transform.loadAbbreviation(ItemObject.jurisdiction, "number", val);
        if (this.transform.abbrevs[jurisdiction].number) {
            if (this.transform.abbrevs[jurisdiction].number[val]) {
                val = this.transform.abbrevs[jurisdiction].number[val];
            } else {
                if ("undefined" !== typeof this.transform.abbrevs[jurisdiction].number[val]) {
                    delete this.transform.abbrevs[jurisdiction].number[val];
                }
            }
        }
    }
    if ("undefined" !== typeof val && ("string" === typeof val || "number" === typeof val)) {
        if ("number" === typeof val) {
            val = "" + val;
        }
        var defaultLabel = CSL.STATUTE_SUBDIV_STRINGS_REVERSE[variable];
        if (!this.tmp.shadow_numbers.values) {
            var values = parseString(val, defaultLabel);
            setSpaces(values);
            setPluralsAndNumerics(values);
            this.tmp.shadow_numbers[variable].values = values;
        }
        if (node) {
            fixRanges(values);
            this.tmp.shadow_numbers[variable].masterStyling = setStyling(values)
        }
        setVariableParams(this.tmp.shadow_numbers, variable, values);
    }
};
CSL.Util.outputNumericField = function(state, varname, itemID) {
    state.output.openLevel(state.tmp.shadow_numbers[varname].masterStyling);
    var nums = state.tmp.shadow_numbers[varname].values;
    var masterLabel = nums.length ? nums[0].label : null;
    var labelForm = state.tmp.shadow_numbers[varname].labelForm;
    var embeddedLabelForm;
    if (labelForm) {
        embeddedLabelForm = labelForm
    } else {
        embeddedLabelForm = "short";
    }
    var labelCapitalizeIfFirst = state.tmp.shadow_numbers[varname].labelCapitalizeIfFirst;
    var labelDecorations = state.tmp.shadow_numbers[varname].labelDecorations;
    var lastLabelName = null;
    for (var i=0,ilen=nums.length;i<ilen;i++) {
        var num = nums[i];
        var label = "";
        if (num.label) {
            var labelName;
            if ('var:' === num.label.slice(0,4)) {
                labelName = num.label.slice(4);
            } else {
                labelName = CSL.STATUTE_SUBDIV_STRINGS[num.label];
            }
            if (labelName) {
                if (num.label === masterLabel) {
                    label = state.getTerm(labelName, labelForm, num.plural);
                } else {
                    label = state.getTerm(labelName, embeddedLabelForm, num.plural);
                }
                if (labelCapitalizeIfFirst) {
                    label = CSL.Output.Formatters["capitalize-first"](state, label);
                }
            }
        }
        var labelPlaceholderPos = -1;
        if (label) {
            labelPlaceholderPos = label.indexOf("%s");
        }
        var numStyling = CSL.Util.cloneToken(num.styling);
        numStyling.formatter = num.styling.formatter;
        numStyling.type = num.styling.type;
        numStyling.num = num.styling.num;
        numStyling.gender = num.styling.gender;
        if (labelPlaceholderPos > 0 && labelPlaceholderPos < (label.length-2)) {
            numStyling.strings.prefix += label.slice(0,labelPlaceholderPos);
            numStyling.strings.suffix = label.slice(labelPlaceholderPos+2) + numStyling.strings.suffix;
        } else if (num.labelVisibility) {
            if (!label) {
                label = num.label;
                labelName = num.label;
            }
            if (labelPlaceholderPos > 0) {
                var prefixLabelStyling = new CSL.Token();
                prefixLabelStyling.decorations = labelDecorations;
                state.output.append(label.slice(0,labelPlaceholderPos), prefixLabelStyling);
            } else if (labelPlaceholderPos === (label.length-2) || labelPlaceholderPos === -1) {
                state.output.append(label+num.labelSuffix, "empty");
            }
        }
        if (num.collapsible) {
            if (num.value.match(/^[1-9][0-9]*$/)) {
                var blob = new CSL.NumericBlob(num.particle, parseInt(num.value, 10), numStyling, itemID);
            } else {
                var blob = new CSL.NumericBlob(num.particle, num.value, numStyling, itemID);
            }
            if ("undefined" === typeof blob.gender) {
                blob.gender = state.locale[state.opt.lang]["noun-genders"][varname];
            }
            state.output.append(blob, "literal");
        } else {
            state.output.append(num.particle + num.value, numStyling)
        }
        if (labelPlaceholderPos === 0 && labelPlaceholderPos < (label.length-2)) {
            if (lastLabelName === null) {
                lastLabelName = labelName;
            }
            if (labelName !== lastLabelName || i === (nums.length-1)) {
                var suffixLabelStyling = new CSL.Token();
                suffixLabelStyling.decorations = labelDecorations;
                state.output.append(label.slice(labelPlaceholderPos+2), suffixLabelStyling);
            }
        }
        lastLabelName === labelName;
        state.tmp.term_predecessor = true;
    }
    state.output.closeLevel();
}
module.exports = CSL;
CSL.Util.PageRangeMangler = {};
CSL.Util.PageRangeMangler.getFunction = function (state, rangeType) {
    var rangerex, pos, len, stringify, listify, expand, minimize, minimize_internal, chicago, lst, m, b, e, ret, begin, end, ret_func, ppos, llen;
    var range_delimiter = state.getTerm(rangeType + "-range-delimiter");
    rangerex = /([0-9]*[a-zA-Z]+0*)?([0-9]+)\s*(?:\u2013|-)\s*([0-9]*[a-zA-Z]+0*)?([0-9]+)/;
    stringify = function (lst) {
        len = lst.length;
        for (pos = 1; pos < len; pos += 2) {
            if ("object" === typeof lst[pos]) {
                lst[pos] = lst[pos].join("");
            }
        }
        var ret = lst.join("");
        ret = ret.replace(/([^\\])\-/g, "$1"+state.getTerm(rangeType + "-range-delimiter"));
        return ret;
    };
    listify = function (str) {
        var m, lst, ret;
        var hyphens = "\\s+\\-\\s+";
        var this_range_delimiter = range_delimiter === "-" ? "" : range_delimiter;
        var delimRex = new RegExp("([^\\\\])[-" + this_range_delimiter + "\\u2013]", "g");
        str = str.replace(delimRex, "$1 - ").replace(/\s+-\s+/g, " - ");
        var rexm = new RegExp("((?:[0-9]*[a-zA-Z]+0*)?[0-9]+" + hyphens + "(?:[0-9]*[a-zA-Z]+0*)?[0-9]+)", "g");
        var rexlst = new RegExp("(?:[0-9]*[a-zA-Z]+0*)?[0-9]+" + hyphens + "(?:[0-9]*[a-zA-Z]+0*)?[0-9]+");
        m = str.match(rexm);
        lst = str.split(rexlst);
        if (lst.length === 0) {
            ret = m;
        } else {
            ret = [lst[0]];
            for (pos = 1, len = lst.length; pos < len; pos += 1) {
                ret.push(m[pos - 1].replace(/\s*\-\s*/g, "-"));
                ret.push(lst[pos]);
            }
        }
        return ret;
    };
    expand = function (str) {
        str = "" + str;
        lst = listify(str);
        len = lst.length;
        for (pos = 1; pos < len; pos += 2) {
            m = lst[pos].match(rangerex);
            if (m) {
                if (!m[3] || m[1] === m[3]) {
                    if (m[4].length < m[2].length) {
                        m[4] = m[2].slice(0, (m[2].length - m[4].length)) + m[4];
                    }
                    if (parseInt(m[2], 10) < parseInt(m[4], 10)) {
                        m[3] = range_delimiter + (m[1] ? m[1] : "");
                        lst[pos] = m.slice(1);
                    }
                }
            }
            if ("string" === typeof lst[pos]) {
                lst[pos] = lst[pos].replace(/\-/g, range_delimiter);
            }
        }
        return lst;
    };
    minimize = function (lst, minchars, isyear) {
        len = lst.length;
        for (var i = 1, ilen = lst.length; i < ilen; i += 2) {
            lst[i][3] = minimize_internal(lst[i][1], lst[i][3], minchars, isyear);
            if (lst[i][2].slice(1) === lst[i][0]) {
                lst[i][2] = range_delimiter;
            }
        }
        return stringify(lst);
    };
    minimize_internal = function (begin, end, minchars, isyear) {
        if (!minchars) {
            minchars = 0;
        }
        b = ("" + begin).split("");
        e = ("" + end).split("");
        ret = e.slice();
        ret.reverse();
        if (b.length === e.length) {
            for (var i = 0, ilen = b.length; i < ilen; i += 1) {
                if (b[i] === e[i] && ret.length > minchars) {
                    ret.pop();
                } else {
                    if (minchars && isyear && ret.length === 3) {
                        var front = b.slice(0, i);
                        front.reverse();
                        ret = ret.concat(front);
                    }
                    break;
                }
            }
        }
        ret.reverse();
        return ret.join("");
    };
    chicago = function (lst) {
        len = lst.length;
        for (pos = 1; pos < len; pos += 2) {
            if ("object" === typeof lst[pos]) {
                m = lst[pos];
                begin = parseInt(m[1], 10);
                end = parseInt(m[3], 10);
                if (begin > 100 && begin % 100 && parseInt((begin / 100), 10) === parseInt((end / 100), 10)) {
                    m[3] = "" + (end % 100);
                } else if (begin >= 10000) {
                    m[3] = "" + (end % 1000);
                }
            }
            if (m[2].slice(1) === m[0]) {
                m[2] = range_delimiter;
            }
        }
        return stringify(lst);
    };
    var sniff = function (str, func, minchars, isyear) {
        var ret;
		str = "" + str;
		var lst = expand(str);
        var ret = func(lst, minchars, isyear);
        return ret;
    }
    if (!state.opt[rangeType + "-range-format"]) {
        ret_func = function (str) {
            return sniff(str, stringify);
        };
    } else if (state.opt[rangeType + "-range-format"] === "expanded") {
        ret_func = function (str) {
            return sniff(str, stringify);
        };
    } else if (state.opt[rangeType + "-range-format"] === "minimal") {
        ret_func = function (str) {
            return sniff(str, minimize);
        };
    } else if (state.opt[rangeType + "-range-format"] === "minimal-two") {
        ret_func = function (str, isyear) {
            return sniff(str, minimize, 2, isyear);
        };
    } else if (state.opt[rangeType + "-range-format"] === "chicago") {
        ret_func = function (str) {
            return sniff(str, chicago);
        };
    }
    return ret_func;
};
module.exports = CSL;
CSL.Util.FlipFlopper = function(state) {
    this.processTags = processTags;
    var _nestingState = [];
    var _nestingData = {
        "<span class=\"nocase\">": {
            type: "nocase",
            opener: "<span class=\"nocase\">",
            closer: "</span>",
            attr: null,
            outer: null,
            flipflop: null
        },
        "<span class=\"nodecor\">": {
            type: "nodecor",
            opener: "<span class=\"nodecor\">",
            closer: "</span>",
            attr: "@class",
            outer: "nodecor",
            flipflop: {
                "nodecor": "nodecor"
            }
        },
        "<span style=\"font-variant:small-caps;\">": {
            type: "tag",
            opener: "<span style=\"font-variant:small-caps;\">",
            closer: "</span>",
            attr: "@font-variant",
            outer: "small-caps",
            flipflop: {
                "small-caps": "normal",
                "normal": "small-caps"
            }
        },
        "<sc>": {
            type: "tag",
            opener: "<sc>",
            closer: "</sc>",
            attr: "@font-variant",
            outer: "small-caps",
            flipflop: {
                "small-caps": "normal",
                "normal": "small-caps"
            }
        },
        "<i>": {
            type: "tag",
            opener: "<i>",
            closer: "</i>",
            attr: "@font-style",
            outer: "italic",
            flipflop: {
                "italic": "normal",
                "normal": "italic"
            }
        },
        "<b>": {
            type: "tag",
            opener: "<b>",
            closer: "</b>",
            attr: "@font-weight",
            outer: "bold",
            flipflop: {
                "bold": "normal",
                "normal": "bold"
            }
        },
        "<sup>": {
            type: "tag",
            opener: "<sup>",
            closer: "</sup>",
            attr: "@vertical-align",
            outer: "sup",
            flipflop: {
                "sub": "sup",
                "sup": "sup"
            }
        },
        "<sub>": {
            type: "tag",
            opener: "<sub>",
            closer: "</sub>",
            attr: "@vertical-align",
            outer: "sub",
            flipflop: {
                "sup": "sub",
                "sub": "sub"
            }
        },
        " \"": {
            type: "quote",
            opener: " \"",
            closer: "\"",
            attr: "@quotes",
            outer: "true",
            flipflop: {
                "true": "inner",
                "inner": "true",
                "false": "true"
            }
        },
        " \'": {
            type: "quote",
            opener: " \'",
            closer: "\'",
            attr: "@quotes",
            outer: "inner",
            flipflop: {
                "true": "inner",
                "inner": "true",
                "false": "true"
            }
        }
    }
    _nestingData["(\""] = _nestingData[" \""]
    _nestingData["(\'"] = _nestingData[" \'"]
    var localeOpenQuote = state.getTerm("open-quote");
    var localeCloseQuote = state.getTerm("close-quote");
    var localeOpenInnerQuote = state.getTerm("open-inner-quote");
    var localeCloseInnerQuote = state.getTerm("close-inner-quote");
    if (localeOpenQuote && localeCloseQuote && [" \""," \'","\"","\'"].indexOf(localeOpenQuote) === -1) {
        _nestingData[localeOpenQuote] = JSON.parse(JSON.stringify(_nestingData[" \""]));
        _nestingData[localeOpenQuote].opener = localeOpenQuote;
        _nestingData[localeOpenQuote].closer = localeCloseQuote;
    }
    if (localeOpenInnerQuote && localeCloseInnerQuote && [" \""," \'","\"","\'"].indexOf(localeOpenInnerQuote) === -1) {
        _nestingData[localeOpenInnerQuote] = JSON.parse(JSON.stringify(_nestingData[" \'"]));
        _nestingData[localeOpenInnerQuote].opener = localeOpenInnerQuote;
        _nestingData[localeOpenInnerQuote].closer = localeCloseInnerQuote;
    }
    var _nestingQuoteReverse = function() {
        var ret = {};
        var keys = Object.keys(_nestingData);
        for (var i = 0, l = keys.length; i < l; i++) {
            var key = keys[i];
            if (_nestingData[key].type === "quote") {
                ret[_nestingData[key].closer] = _nestingData[key];
            }
        }
        return ret;
    }();
    var _nestingDataAttr = function() {
        var ret = {};
        var keys = Object.keys(_nestingData);
        for (var i = 0, l = keys.length; i < l; i++) {
            var key = keys[i];
            if (_nestingData[key].type === "nocase") continue;
            var attr = _nestingData[key].attr;
            var outer = _nestingData[key].outer;
            var inner = _nestingData[key].flipflop[_nestingData[key].outer];
            ret[attr + "/" + outer] = _nestingData[key];
            ret[attr + "/" + inner] = _nestingData[key];
        }
        return ret;
    }();
    function _setOuterQuoteForm(quot) {
        var flip = {
            " \'": " \"",
            " \"": " \'",
            "(\"": "(\'",
            "(\'": "(\""
        }
        _nestingData[quot].outer = "true";
        _nestingData[flip[quot]].outer = "inner";
    }
    function _getNestingOpenerParams(opener) {
        var openers = [];
        var closer;
        var keys = Object.keys(_nestingData);
        for (var i = 0, l = keys.length; i < l; i++) {
            var key = keys[i];
            if (_nestingData[opener].type !== "quote" || !_nestingData[opener]) {
                openers.push(key);
            }
        }
        var ret = _nestingData[opener];
        ret.opener = new RegExp("^(?:" + openers.map(function(str){return str.replace("(", "\\(")}).join("|") + ")"); 
        return ret;
    }
    var _nestingParams = function() {
        var ret = {};
        var keys = Object.keys(_nestingData);
        for (var i = 0, l = keys.length; i < l; i++) {
            var key = keys[i];
            ret[key] = _getNestingOpenerParams(key);
        }
        return ret;
    }()
    var _tagRex = function() {
        var openers = [];
        var closers = [];
        var vals = {};
        for (var opener in _nestingParams) {
            openers.push(opener);
            vals[_nestingParams[opener].closer] = true;
        }
        var keys = Object.keys(vals);
        for (var i = 0, l = keys.length; i < l; i++) {
            var closer = keys[i];
            closers.push(closer);
        }
        var all = openers.concat(closers).map(function(str){return str.replace("(", "\\(")}).join("|");
        return {
            matchAll: new RegExp("((?:" + all + "))", "g"),
            splitAll: new RegExp("(?:" + all + ")", "g"),
            open: new RegExp("(^(?:" + openers.map(function(str){return str.replace("(", "\\(")}).join("|") + ")$)"),
            close: new RegExp("(^(?:" + closers.join("|") + ")$)"),
        }
    }();
    function _nestingFix (tag, pos) {
        return _pushNestingState(tag, pos);
    }
    function _pushNestingState(tag, pos) {
        if (tag.match(_tagRex.open)) {
            return _tryOpen(tag, pos);
        } else {
            return _tryClose(tag, pos);
        }
    }
    function _tryOpen(tag, pos) {
        var params = _nestingState[_nestingState.length - 1];
        if (!params || tag.match(params.opener)) {
            _nestingState.push({
                type: _nestingParams[tag].type,
                opener: _nestingParams[tag].opener,
                closer: _nestingParams[tag].closer,
                pos: pos
            });
            return false;
        } else {
            _nestingState.pop()
            _nestingState.push({
                type: _nestingParams[tag].type,
                opener: _nestingParams[tag].opener,
                closer: _nestingParams[tag].closer,
                pos: pos
            });
            return {
                fixtag: params.pos
            };
        }
    }
    function _tryClose(tag, pos) {
        var params = _nestingState[_nestingState.length - 1];
        if (params && tag === params.closer) {
            _nestingState.pop()
            if (params.type === "nocase") {
                return {
                    nocase: {
                        open: params.pos,
                        close: pos
                    }
                }
            } else {
                return false;
            }
        } else {
            if (params) {
                return {
                    fixtag: params.pos
                };
            } else {
                return {
                    fixtag: pos
                };
            }
        }
    }
    function _doppelString(str) {
        var forcedSpaces = [];
        str = str.replace(/(<span)\s+(style=\"font-variant:)\s*(small-caps);?\"[^>]*(>)/g, "$1 $2$3;\"$4");
        str = str.replace(/(<span)\s+(class=\"no(?:case|decor)\")[^>]*(>)/g, "$1 $2$3");
        var match = str.match(_tagRex.matchAll);
        if (!match) {
            return {
                tags: [],
                strings: [str],
                forcedSpaces: []
            };
        }
        var split = str.split(_tagRex.splitAll);
        for (var i=0,ilen=match.length-1;i<ilen;i++) {
            if (_nestingData[match[i]]) {
                if (split[i+1] === "" && ["\"", "'"].indexOf(match[i+1]) > -1) {
                    match[i+1] = " " + match[i+1]
                    forcedSpaces.push(true);
                } else {
                    forcedSpaces.push(false);
                }
            }
        }
        return {
            tags: match,
            strings: split,
            forcedSpaces: forcedSpaces
        }
    }
    function _undoppelString(obj) {
        var lst = obj.strings.slice(-1);
        for (var i=obj.tags.length-1; i>-1; i+=-1) {
            lst.push(obj.tags[i]);
            lst.push(obj.strings[i]);
        }
        lst.reverse();
        return lst.join("|");
    }
    var _TagReg = function(blob) {
        this.set = set;
        this.pair = pair;
        this.pop = pop;
        var _stack = [];
        function set(tag) {
            var attr = _nestingData[tag].attr;
            var decor = null;
            for (var i=_stack.length-1;i>-1;i--) {
                var _decor = _stack[i];
                if (_decor[0] === attr) {
                    decor = _decor;
                    break;
                }
            }
            if (!decor) {
                var allTheDecor = [state[state.tmp.area].opt.layout_decorations].concat(blob.alldecor)
                outer:
                for (var i=allTheDecor.length-1;i>-1;i--) {
                    var decorset = allTheDecor[i];
                    if (!decorset) continue;
                    for (var j=decorset.length-1;j>-1;j--) {
                        var _decor = decorset[j];
                        if (_decor[0] === attr) {
                            decor = _decor;
                            break outer;
                        }
                    }
                }
            }
            if (!decor) {
                decor = [attr, _nestingData[tag].outer];
            } else {
                decor = [attr, _nestingData[tag].flipflop[decor[1]]];
            }
            _stack.push(decor);
        }
        function pair() {
            return _stack[_stack.length-1];
        }
        function pop() {
            _stack.pop();
        }
    }
    function _apostropheForce(tag, str) {
        if (tag === "\'") {
            if (str && str.match(/^[^\,\.\?\:\;\ ]/)) {
                return true;
            }
        } else if (tag === " \'" && str && str.match(/^[\ ]/)) {
            return true;
        }
        return false;
    }
    function _undoppelToQueue(blob, doppel, leadingSpace) {
        var TOP = blob;
        var firstString = true;
        var tagReg = new _TagReg(blob);
        blob.blobs = [];
        function Stack (blob) {
            this.stack = [blob];
            this.latest = blob;
            this.addStyling = function(str, decor, forcedSpace) {
                if (firstString) {
                    if (str.slice(0, 1) === " ") {
                        str = str.slice(1);
                    }
                    if (str.slice(0, 1) === " ") {
                        str = str.slice(1);
                    }
                    firstString = false;
                }
                this.latest = this.stack[this.stack.length-1];
                if (decor) {
                    if ("string" === typeof this.latest.blobs) {
                        var child = new CSL.Blob();
                        child.blobs = this.latest.blobs;
                        child.alldecor = this.latest.alldecor.slice();
                        this.latest.blobs = [child];
                    }
                    var tok = new CSL.Token();
                    var newblob = new CSL.Blob(null, tok);
                    newblob.alldecor = this.latest.alldecor.slice();
                    if (decor[0] === "@class" && decor[1] === "nodecor") {
                        var newdecorset = [];
                        var seen = {};
                        var allTheDecor = [state[state.tmp.area].opt.layout_decorations].concat(newblob.alldecor)
                        for (var i=allTheDecor.length-1;i>-1;i--) {
                            var _decorset = allTheDecor[i];
                            if (!_decorset) continue;
                            for (var j=_decorset.length-1;j>-1;j--) {
                                var _olddecor = _decorset[j];
                                if (["@font-weight", "@font-style", "@font-variant"].indexOf(_olddecor[0]) > -1
                                    && !seen[_olddecor[0]]) {
                                    if (decor[1] !== "normal") {
                                        newblob.decorations.push([_olddecor[0], "normal"]);
                                        newdecorset.push([_olddecor[0], "normal"])
                                    }
                                    seen[_olddecor[0]] = true;
                                }
                            }
                        }
                        newblob.alldecor.push(newdecorset);
                    } else {
                        newblob.decorations.push(decor);
                        newblob.alldecor.push([decor]);
                    }
                    this.latest.blobs.push(newblob);
                    this.stack.push(newblob);
                    this.latest = newblob;
                    if (str) {
                        var tok = new CSL.Token();
                        var newblob = new CSL.Blob(null, tok);
                        newblob.blobs = str;
                        newblob.alldecor = this.latest.alldecor.slice();
                        this.latest.blobs.push(newblob);
                    }
                } else {
                    if (str) {
                        var child = new CSL.Blob();
                        child.blobs = str;
                        child.alldecor = this.latest.alldecor.slice();
                        this.latest.blobs.push(child);
                    }
                }
            }
            this.popStyling = function() {
                this.stack.pop();
            }
        };
        var stack = new Stack(blob);
        if (doppel.strings.length) {
            var str = doppel.strings[0];
            if (leadingSpace) {
                str = " " + str;
            }
            stack.addStyling(str);
        }
        for (var i=0,ilen=doppel.tags.length;i<ilen;i++) {
            var tag = doppel.tags[i];
            var str = doppel.strings[i+1];
            if (tag.match(_tagRex.open)) {
                tagReg.set(tag);
                stack.addStyling(str, tagReg.pair());
            } else {
                tagReg.pop();
                stack.popStyling();
                stack.addStyling(str);
            }
        }
    }
    function processTags(blob) {
        var str = blob.blobs;
        var leadingSpace = false;
        if (str.slice(0, 1) === " " && !str.match(/^\s+[\'\"]/)) {
            leadingSpace = true;
        }
        var rex = new RegExp("(" + CSL.ROMANESQUE_REGEXP.source + ")\u2019(" + CSL.ROMANESQUE_REGEXP.source + ")", "g")
        var str = " " + str.replace(rex, "$1\'$2");
        var doppel = _doppelString(str);
        if (doppel.tags.length === 0) return;
        var quoteFormSeen = false;
    	for (var i=0,ilen=doppel.tags.length;i<ilen;i++) {
            var tag = doppel.tags[i];
            var str = doppel.strings[i+1];
            if (_apostropheForce(tag, str)) {
                if (tag === " \'") {
                    doppel.strings[i+1] = " \u2019" + doppel.strings[i+1];
                } else {
                    doppel.strings[i+1] = "\u2019" + doppel.strings[i+1];
                }
                doppel.tags[i] = "";
            } else {
                var tagInfo;
                while (true) {
                    tagInfo = _nestingFix(tag, i);
                    if (tagInfo) {
                        if (Object.keys(tagInfo).indexOf("fixtag") > -1) {
                            if (tag.match(_tagRex.close)
                                && tag === "\'") {
                                doppel.strings[i+1] = "\u2019" + doppel.strings[i+1];
                                doppel.tags[i] = "";
                            } else {
                                var failedTag = doppel.tags[tagInfo.fixtag];
                                if (doppel.forcedSpaces[tagInfo.fixtag-1]) {
                                    failedTag = failedTag.slice(1);
                                }
                                doppel.strings[tagInfo.fixtag+1] = failedTag + doppel.strings[tagInfo.fixtag+1];
                                doppel.tags[tagInfo.fixtag] = "";
                            }
                            if (_nestingState.length > 0) {
                                _nestingState.pop();
                            } else {
                                break;
                            }
                        } else if (tagInfo.nocase) {
                            doppel.tags[tagInfo.nocase.open] = "";
                            doppel.tags[tagInfo.nocase.close] = "";
                            break;
                        } else {
                            break;
                        }
                    } else {
                        break;
                    }
                }
                if (tagInfo && (tagInfo.fixtag|| tagInfo.fixtag === 0)) {
                    doppel.strings[i+1] = doppel.tags[i] + doppel.strings[i+1];
                    doppel.tags[i] = "";
                }
            }
        }
        for (var i=_nestingState.length-1;i>-1;i--) {
            var tagPos = _nestingState[i].pos
            var tag = doppel.tags[tagPos];
            if (tag === " \'" || tag === "\'") {
                doppel.strings[tagPos+1] = " \u2019" + doppel.strings[tagPos+1];
            } else {
                doppel.strings[tagPos+1] = doppel.tags[tagPos] + doppel.strings[tagPos+1];
            }
            doppel.tags[tagPos] = "";
            _nestingState.pop();
        }
        for (var i=doppel.tags.length-1;i>-1;i--) {
            if (!doppel.tags[i]) {
                doppel.tags = doppel.tags.slice(0,i).concat(doppel.tags.slice(i+1));
                doppel.strings[i] = doppel.strings[i] + doppel.strings[i+1];
                doppel.strings = doppel.strings.slice(0,i+1).concat(doppel.strings.slice(i+2));
            }
        }
        for (var i=0,ilen=doppel.tags.length;i<ilen;i++) {
            var tag = doppel.tags[i];
            var forcedSpace = doppel.forcedSpaces[i-1];
            if ([" \"", " \'", "(\"", "(\'"].indexOf(tag) > -1) {
                if (!quoteFormSeen) {
                    _setOuterQuoteForm(tag);
                    quoteFormSeen = true;
                }
                if (!forcedSpace) {
                    doppel.strings[i] += tag.slice(0, 1);
                }
            }
        }
        _undoppelToQueue(blob, doppel, leadingSpace);
    }
}
module.exports = CSL;
CSL.Output.Formatters = new function () {
    this.passthrough = passthrough;
    this.lowercase = lowercase;
    this.uppercase = uppercase;
    this.sentence = sentence;
    this.title = title;
    this["capitalize-first"] = capitalizeFirst;
    this["capitalize-all"] = capitalizeAll;
    var rexStr = "(?:\u2018|\u2019|\u201C|\u201D| \"| \'|\"|\'|[-\u2013\u2014\/.,;?!:]|\\[|\\]|\\(|\\)|<span style=\"font-variant: small-caps;\">|<span class=\"no(?:case|decor)\">|<\/span>|<\/?(?:i|sc|b|sub|sup)>)";
    var tagDoppel = new CSL.Doppeler(rexStr, function(str) {
        return str.replace(/(<span)\s+(class=\"no(?:case|decor)\")[^>]*(>)/g, "$1 $2$3").replace(/(<span)\s+(style=\"font-variant:)\s*(small-caps);?(\")[^>]*(>)/g, "$1 $2 $3;$4$5");
    });
    var wordDoppel = new CSL.Doppeler("(?:[\u0020\u00A0\u2000-\u200B\u205F\u3000]+)");
    var _tagParams = {
        "<span style=\"font-variant: small-caps;\">": "</span>",
        "<span class=\"nocase\">": "</span>",
        "<span class=\"nodecor\">": "</span>"
    }
    function _capitalise (word, force) {
        var m = word.match(/(^\s*)((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]))(.*)/);
        if (m && !(m[2].match(/^[\u0370-\u03FF]$/) && !m[3])) {
            return m[1] + m[2].toUpperCase() + m[3];
        }
        return word;
    }
    function _textcaseEngine(config, string) {
        if (!string) {
            return "";
        }
        config.doppel = tagDoppel.split(string);
        var quoteParams = {
            " \"": {
                opener: " \'",
                closer: "\""
            },
            " \'": {
                opener: " \"",
                closer: "\'"
            },
            "\u2018": {
                opener: "\u2018",
                closer: "\u2019"
            },
            "\u201C": {
                opener: "\u201C",
                closer: "\u201D"
            },
        }
        function quoteFix (tag, positions) {
            var m = tag.match(/(^(?:\u2018|\u2019|\u201C|\u201D|\"|\')|(?: \"| \')$)/);
            if (m) {
                return pushQuoteState(m[1], positions);
            }
        }
        function pushQuoteState(tag, pos) {
            var isOpener = ["\u201C", "\u2018", " \"", " \'"].indexOf(tag) > -1 ? true : false;
            if (isOpener) {
                return tryOpen(tag, pos);
            } else {
                return tryClose(tag, pos);
            }
        }
        function tryOpen(tag, pos) {
            if (config.quoteState.length === 0 || tag === config.quoteState[config.quoteState.length - 1].opener) {
                config.quoteState.push({
                    opener: quoteParams[tag].opener,
                    closer: quoteParams[tag].closer,
                    pos: pos
                });
                return false;
            } else {
                var prevPos = config.quoteState[config.quoteState.length-1].pos;
                config.quoteState.pop()
                config.quoteState.push({
                    opener: quoteParams[tag].opener,
                    closer: quoteParams[tag].closer,
                    positions: pos
                });
                return prevPos;
            }
        }
        function tryClose(tag, pos) {
            if (config.quoteState.length > 0 && tag === config.quoteState[config.quoteState.length - 1].closer) {
                config.quoteState.pop()
            } else {
                return pos;
            }
        }
        if (config.doppel.strings.length && config.doppel.strings[0].trim()) {
            config.doppel.strings[0] = config.capitaliseWords(config.doppel.strings[0], 0, config.doppel.tags[0]);
        }
    	for (var i=0,ilen=config.doppel.tags.length;i<ilen;i++) {
            var tag = config.doppel.tags[i];
            var str = config.doppel.strings[i+1];
            if (config.tagState !== null) {
                if (_tagParams[tag]) {
                    config.tagState.push(_tagParams[tag]);
                } else if (config.tagState.length && tag === config.tagState[config.tagState.length - 1]) {
                    config.tagState.pop();
                }
            }
            if (config.afterPunct !== null) {
                if (tag.match(/[\!\?\:]$/)) {
                    config.afterPunct = true;
                }
            }
            if (config.tagState.length === 0) {
                config.doppel.strings[i+1] = config.capitaliseWords(str, i+1, config.doppel,config.doppel.tags[i+1]);
            } else if (config.doppel.strings[i+1].trim()) {
                config.lastWordPos = null;
            }
            if (config.quoteState !== null) {
                var quotePos = quoteFix(tag, i);
                if (quotePos || quotePos === 0) {
                    var origChar = config.doppel.origStrings[quotePos+1].slice(0, 1);
                    config.doppel.strings[quotePos+1] = origChar + config.doppel.strings[quotePos+1].slice(1);
                    config.lastWordPos = null;
                }
            }
            if (config.isFirst) {
                if (str.trim()) {
                    config.isFirst = false;
                }
            }
            if (config.afterPunct) {
                if (str.trim()) {
                    config.afterPunct = false;
                }
            }
        }
        if (config.quoteState) {
            for (var i=0,ilen=config.quoteState.length;i<ilen;i++) {
                var quotePos = config.quoteState[i].pos;
                if (typeof quotePos !== 'undefined') {
                    var origChar = config.doppel.origStrings[quotePos+1].slice(0, 1);
                    config.doppel.strings[quotePos+1] = origChar + config.doppel.strings[quotePos+1].slice(1);
                }
            }
        }
        if (config.lastWordPos) {
            var lastWords = wordDoppel.split(config.doppel.strings[config.lastWordPos.strings]);
            var lastWord = _capitalise(lastWords.strings[config.lastWordPos.words]);
            lastWords.strings[config.lastWordPos.words] = lastWord;
            config.doppel.strings[config.lastWordPos.strings] = wordDoppel.join(lastWords);
        }
        return tagDoppel.join(config.doppel);
    }
    function passthrough (state, str) {
        return str;
    }
    function lowercase(state, string) {
        var config = {
            quoteState: null,
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        words[i] = word.toLowerCase();
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: null
        }
        return _textcaseEngine(config, string);
    }
    function uppercase(state, string) {
        var config = {
            quoteState: null,
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        words[i] = word.toUpperCase();
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: null
        }
        return _textcaseEngine(config, string);
    }
    function sentence(state, string) {
        var config = {
            quoteState: [],
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        if (config.isFirst) {
                            words[i] = _capitalise(word);
                            config.isFirst = false;
                        } else {
                            words[i] = word.toLowerCase();
                        }
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: true
        }
        return _textcaseEngine(config, string);
    }
    function title(state, string) {
        var config = {
            quoteState: [],
            capitaliseWords: function(str, i, followingTag) {
                if (str.trim()) {
                    var words = str.split(/[ \u00A0]+/);
                    var wordle = wordDoppel.split(str);
                    var words = wordle.strings;
                    for (var j=0,jlen=words.length;j<jlen;j++) {
                        var word = words[j];
                        if (!word) continue;
                        if (word.length > 1 && !word.toLowerCase().match(config.skipWordsRex)) {
                            words[j] = _capitalise(words[j]);
                        } else if (j === (words.length - 1) && followingTag === "-") {
                            words[j] = _capitalise(words[j]);
                        } else if (config.isFirst) {
                            words[j] = _capitalise(words[j]);
                        } else if (config.afterPunct) {
                            words[j] = _capitalise(words[j]);
                        }
                        config.afterPunct = false;
                        config.isFirst = false;
                        config.lastWordPos = {
                            strings: i,
                            words: j
                        }
                    }
                    str = wordDoppel.join(wordle);
                }
                return str;
            },
            skipWordsRex: state.locale[state.opt.lang].opts["skip-words-regexp"],
            tagState: [],
            afterPunct: false,
            isFirst: true
        }
        return _textcaseEngine(config, string);
    }
    function capitalizeFirst(state, string) {
        var config = {
            quoteState: [],
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        if (config.isFirst) {
                            words[i] = _capitalise(word);
                            config.isFirst = false;
                            break;
                        }
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: true
        }
        return _textcaseEngine(config, string);
    }
    function capitalizeAll (state, string) {
        var config = {
            quoteState: [],
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        words[i] = _capitalise(word);
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: null
        }
        return _textcaseEngine(config, string);
    }
}
module.exports = CSL;
CSL.Output.Formats = function () {};
CSL.Output.Formats.prototype.html = {
    "text_escape": function (text) {
        if (!text) {
            text = "";
        }
        return text.replace(/&/g, "&#38;")
            .replace(/</g, "&#60;")
            .replace(/>/g, "&#62;")
            .replace(/\s\s/g, "\u00A0 ")
            .replace(CSL.SUPERSCRIPTS_REGEXP,
                     function(aChar) {
                         return "<sup>" + CSL.SUPERSCRIPTS[aChar] + "</sup>";
                     });
    },
    "bibstart": "<div class=\"csl-bib-body\">\n",
    "bibend": "</div>",
    "@font-style/italic": "<i>%%STRING%%</i>",
    "@font-style/oblique": "<em>%%STRING%%</em>",
    "@font-style/normal": "<span style=\"font-style:normal;\">%%STRING%%</span>",
    "@font-variant/small-caps": "<span style=\"font-variant:small-caps;\">%%STRING%%</span>",
    "@passthrough/true": CSL.Output.Formatters.passthrough,
    "@font-variant/normal": "<span style=\"font-variant:normal;\">%%STRING%%</span>",
    "@font-weight/bold": "<b>%%STRING%%</b>",
    "@font-weight/normal": "<span style=\"font-weight:normal;\">%%STRING%%</span>",
    "@font-weight/light": false,
    "@text-decoration/none": "<span style=\"text-decoration:none;\">%%STRING%%</span>",
    "@text-decoration/underline": "<span style=\"text-decoration:underline;\">%%STRING%%</span>",
    "@vertical-align/sup": "<sup>%%STRING%%</sup>",
    "@vertical-align/sub": "<sub>%%STRING%%</sub>",
    "@vertical-align/baseline": "<span style=\"baseline\">%%STRING%%</span>",
    "@strip-periods/true": CSL.Output.Formatters.passthrough,
    "@strip-periods/false": CSL.Output.Formatters.passthrough,
    "@quotes/true": function (state, str) {
        if ("undefined" === typeof str) {
            return state.getTerm("open-quote");
        }
        return state.getTerm("open-quote") + str + state.getTerm("close-quote");
    },
    "@quotes/inner": function (state, str) {
        if ("undefined" === typeof str) {
            return "\u2019";
        }
        return state.getTerm("open-inner-quote") + str + state.getTerm("close-inner-quote");
    },
    "@quotes/false": false,
    "@cite/entry": function (state, str) {
        return state.sys.wrapCitationEntry(str, this.item_id, this.locator_txt, this.suffix_txt);
	},
    "@bibliography/entry": function (state, str) {
        var insert = "";
        if (state.sys.embedBibliographyEntry) {
            insert = state.sys.embedBibliographyEntry(this.item_id) + "\n";
        }
        return "  <div class=\"csl-entry\">" + str + "</div>\n" + insert;
    },
    "@display/block": function (state, str) {
        return "\n\n    <div class=\"csl-block\">" + str + "</div>\n";
    },
    "@display/left-margin": function (state, str) {
        return "\n    <div class=\"csl-left-margin\">" + str + "</div>";
    },
    "@display/right-inline": function (state, str) {
        return "<div class=\"csl-right-inline\">" + str + "</div>\n  ";
    },
    "@display/indent": function (state, str) {
        return "<div class=\"csl-indent\">" + str + "</div>\n  ";
    },
    "@showid/true": function (state, str, cslid) {
        if (!state.tmp.just_looking && ! state.tmp.suppress_decorations) {
            if (cslid) {
                return "<span class=\"" + state.opt.nodenames[cslid] + "\" cslid=\"" + cslid + "\">" + str + "</span>";
            } else if (this.params && "string" === typeof str) {
                var prePunct = "";
                if (str) {
                    var m = str.match(CSL.VARIABLE_WRAPPER_PREPUNCT_REX);
                    prePunct = m[1];
                    str = m[2];
                }
                var postPunct = "";
                if (str && CSL.SWAPPING_PUNCTUATION.indexOf(str.slice(-1)) > -1) {
                    postPunct = str.slice(-1);
                    str = str.slice(0,-1);
                }
                return state.sys.variableWrapper(this.params, prePunct, str, postPunct);
            } else {
                return str;
            }
        } else {
            return str;
        }
    },
    "@URL/true": function (state, str) {
        return "<a href=\"" + str + "\">" + str + "</a>";
    },
    "@DOI/true": function (state, str) {
        var doiurl = str;
        if (!str.match(/^https?:\/\//)) {
            doiurl = "https://doi.org/" + str;
        }
        return "<a href=\"" + doiurl + "\">" + str + "</a>";
    }
};
CSL.Output.Formats.prototype.text = {
    "text_escape": function (text) {
        if (!text) {
            text = "";
        }
        return text;
    },
    "bibstart": "",
    "bibend": "",
    "@font-style/italic": false,
    "@font-style/oblique": false,
    "@font-style/normal": false,
    "@font-variant/small-caps": false,
    "@passthrough/true": CSL.Output.Formatters.passthrough,
    "@font-variant/normal": false,
    "@font-weight/bold": false,
    "@font-weight/normal": false,
    "@font-weight/light": false,
    "@text-decoration/none": false,
    "@text-decoration/underline": false,
    "@vertical-align/baseline": false,
    "@vertical-align/sup": false,
    "@vertical-align/sub": false,
    "@strip-periods/true": CSL.Output.Formatters.passthrough,
    "@strip-periods/false": CSL.Output.Formatters.passthrough,
    "@quotes/true": function (state, str) {
        if ("undefined" === typeof str) {
            return state.getTerm("open-quote");
        }
        return state.getTerm("open-quote") + str + state.getTerm("close-quote");
    },
    "@quotes/inner": function (state, str) {
        if ("undefined" === typeof str) {
            return "\u2019";
        }
        return state.getTerm("open-inner-quote") + str + state.getTerm("close-inner-quote");
    },
    "@quotes/false": false,
    "@cite/entry": function (state, str) {
		return state.sys.wrapCitationEntry(str, this.item_id, this.locator_txt, this.suffix_txt);
	},
    "@bibliography/entry": function (state, str) {
        return str+"\n";
    },
    "@display/block": function (state, str) {
        return "\n"+str;
    },
    "@display/left-margin": function (state, str) {
        return str;
    },
    "@display/right-inline": function (state, str) {
        return str;
    },
    "@display/indent": function (state, str) {
        return "\n    "+str;
    },
    "@showid/true": function (state, str, cslid) {
        return str;
    },
    "@URL/true": function (state, str) {
        return str;
    },
    "@DOI/true": function (state, str) {
        return str;
    }
};
CSL.Output.Formats.prototype.rtf = {
    "text_escape": function (text) {
        if (!text) {
            text = "";
        }
        return text
        .replace(/([\\{}])/g, "\\$1")
        .replace(CSL.SUPERSCRIPTS_REGEXP,
                 function(aChar) {
                     return "\\super " + CSL.SUPERSCRIPTS[aChar] + "\\nosupersub{}";
                 })
        .replace(/[\u007F-\uFFFF]/g,
                 function(aChar) { return "\\uc0\\u"+aChar.charCodeAt(0).toString()+"{}"; })
        .split("\t").join("\\tab{}");
    },
    "@passthrough/true": CSL.Output.Formatters.passthrough,
    "@font-style/italic":"{\\i{}%%STRING%%}",
    "@font-style/normal":"{\\i0{}%%STRING%%}",
    "@font-style/oblique":"{\\i{}%%STRING%%}",
    "@font-variant/small-caps":"{\\scaps %%STRING%%}",
    "@font-variant/normal":"{\\scaps0{}%%STRING%%}",
    "@font-weight/bold":"{\\b{}%%STRING%%}",
    "@font-weight/normal":"{\\b0{}%%STRING%%}",
    "@font-weight/light":false,
    "@text-decoration/none":false,
    "@text-decoration/underline":"{\\ul{}%%STRING%%}",
    "@vertical-align/baseline":false,
    "@vertical-align/sup":"\\super %%STRING%%\\nosupersub{}",
    "@vertical-align/sub":"\\sub %%STRING%%\\nosupersub{}",
    "@strip-periods/true": CSL.Output.Formatters.passthrough,
    "@strip-periods/false": CSL.Output.Formatters.passthrough,
    "@quotes/true": function (state, str) {
        if ("undefined" === typeof str) {
            return CSL.Output.Formats.rtf.text_escape(state.getTerm("open-quote"));
        }
        return CSL.Output.Formats.rtf.text_escape(state.getTerm("open-quote")) + str + CSL.Output.Formats.rtf.text_escape(state.getTerm("close-quote"));
    },
    "@quotes/inner": function (state, str) {
        if ("undefined" === typeof str) {
            return CSL.Output.Formats.rtf.text_escape("\u2019");
        }
        return CSL.Output.Formats.rtf.text_escape(state.getTerm("open-inner-quote")) + str + CSL.Output.Formats.rtf.text_escape(state.getTerm("close-inner-quote"));
    },
    "@quotes/false": false,
    "bibstart":"{\\rtf ",
    "bibend":"}",
    "@display/block": "\\line{}%%STRING%%\\line\r\n",
    "@cite/entry": function (state, str) {
		return state.sys.wrapCitationEntry(str, this.item_id, this.locator_txt, this.suffix_txt);
	},
    "@bibliography/entry": function(state,str){
        return str;
    },
    "@display/left-margin": function(state,str){
        return str+"\\tab ";
    },
    "@display/right-inline": function (state, str) {
        return str+"\r\n";
    },
    "@display/indent": function (state, str) {
        return "\n\\tab "+str+"\\line\r\n";
    },
    "@showid/true": function (state, str, cslid) {
        if (!state.tmp.just_looking && ! state.tmp.suppress_decorations) {
            var prePunct = "";
            if (str) {
                var m = str.match(CSL.VARIABLE_WRAPPER_PREPUNCT_REX);
                prePunct = m[1];
                str = m[2];
            }
            var postPunct = "";
            if (str && CSL.SWAPPING_PUNCTUATION.indexOf(str.slice(-1)) > -1) {
                postPunct = str.slice(-1);
                str = str.slice(0,-1);
            }
            return state.sys.variableWrapper(this.params, prePunct, str, postPunct);
        } else {
            return str;
        }
    },
    "@URL/true": function (state, str) {
        return str;
    },
    "@DOI/true": function (state, str) {
        return str;
    }
};
CSL.Output.Formats = new CSL.Output.Formats();
module.exports = CSL;
CSL.Registry = function (state) {
    var pos, len, ret, i, ilen;
    this.debug = false;
    this.state = state;
    this.registry = {};
    this.reflist = [];
    this.refhash = {};
    this.namereg = new CSL.Registry.NameReg(state);
    this.citationreg = new CSL.Registry.CitationReg(state);
    this.authorstrings = {};
    this.mylist = [];
    this.myhash = {};
    this.deletes = [];
    this.inserts = [];
    this.uncited = {};
    this.refreshes = {};
    this.akeys = {};
    this.oldseq = {};
    this.return_data = {};
    this.ambigcites = {};
    this.ambigresets = {};
    this.sorter = new CSL.Registry.Comparifier(state, "bibliography_sort");
    this.getSortedIds = function () {
        var ret = [];
        for (var i = 0, ilen = this.reflist.length; i < ilen; i += 1) {
            ret.push("" + this.reflist[i].id);
        }
        return ret;
    };
    this.getSortedRegistryItems = function () {
        var ret = [];
        for (var i = 0, ilen = this.reflist.length; i < ilen; i += 1) {
            ret.push(this.reflist[i]);
        }
        return ret;
    };
};
CSL.Registry.prototype.init = function (itemIDs, uncited_flag) {
    var i, ilen;
    this.oldseq = {};
    if (uncited_flag) {
        this.uncited = {};
        for (var i=0,ilen=itemIDs.length;i<ilen; i += 1) {
            if (!this.myhash[itemIDs[i]]) {
                this.mylist.push("" + itemIDs[i]);
            }
            this.uncited[itemIDs[i]] = true;
            this.myhash[itemIDs[i]] = true;
        }
    } else {
        for (var key in this.uncited) {
            itemIDs.push(key);
        }
        var myhash = {};
        for (i=itemIDs.length-1;i>-1; i += -1) {
            if (myhash[itemIDs[i]]) {
                itemIDs = itemIDs.slice(0, i).concat(itemIDs.slice(i + 1));
            } else {
                myhash[itemIDs[i]] = true;
            }
        }
        this.mylist = [];
        for (var i=0,ilen=itemIDs.length;i<ilen;i+=1) {
            this.mylist.push("" + itemIDs[i]);
        }
        this.myhash = myhash;
    }
    this.refreshes = {};
    this.touched = {};
    this.ambigsTouched = {};
    this.ambigresets = {};
};
CSL.Registry.prototype.dopurge = function (myhash) {
    for (var i=this.mylist.length-1;i>-1;i+=-1) {
        if (this.citationreg.citationsByItemId) {
            if (!this.citationreg.citationsByItemId[this.mylist[i]] && !myhash[this.mylist[i]]) {
                delete this.myhash[this.mylist[i]];
                this.mylist = this.mylist.slice(0,i).concat(this.mylist.slice(i+1));
            }
        }
    }
    this.dodeletes(this.myhash);
};
CSL.Registry.prototype.dodeletes = function (myhash) {
    var otheritems, key, ambig, pos, len, items, kkey, mypos, id;
    if ("string" === typeof myhash) {
        myhash = {};
        myhash[myhash] = true;
    }
    for (var key in this.registry) {
        if (!myhash[key]) {
            if (this.uncited[key]) {
                continue;
            }
            otheritems = this.namereg.delitems(key);
            for (kkey in otheritems) {
                this.refreshes[kkey] = true;
            }
            ambig = this.registry[key].ambig;
            mypos = this.ambigcites[ambig].indexOf(key);
            if (mypos > -1) {
                items = this.ambigcites[ambig].slice();
                this.ambigcites[ambig] = items.slice(0, mypos).concat(items.slice(mypos+1, items.length));
                this.ambigresets[ambig] = this.ambigcites[ambig].length;
            }
            len = this.ambigcites[ambig].length;
            for (pos = 0; pos < len; pos += 1) {
                id = "" + this.ambigcites[ambig][pos];
                this.refreshes[id] = true;
            }
            if (this.registry[key].siblings) {
                if (this.registry[key].siblings.length == 1) {
                    var loneSiblingID = this.registry[key].siblings[0];
                    this.registry[loneSiblingID].master = true;
                    this.registry[loneSiblingID].siblings.pop();
                    this.registry[loneSiblingID].parallel = false;
                } else if (this.registry[key].siblings.length > 1) {
                    var removeIDs = [key];
                    if (this.registry[key].master) {
                        var newmasterID = this.registry[key].siblings[0];
                        var newmaster = this.registry[newmasterID];
                        newmaster.master = true;
                        newmaster.parallel = false;
                        removeIDs.push(newmasterID);
                        for (var k = 0, klen = this.registry[key].siblings.length; k < klen; k += 1) {
                            this.registry[this.registry[key].siblings[k]].parallel = newmasterID;
                        }
                    }
                    var buffer = [];
                    for (var k = this.registry[key].siblings.length - 1; k > -1; k += -1) {
                        var siblingID = this.registry[key].siblings.pop();
                        if (removeIDs.indexOf(siblingID) === -1) {
                            buffer.push(siblingID)
                        }
                    }
                    for (var k = buffer.length - 1; k > -1; k += -1) {
                        this.registry[key].siblings.push(buffer[k]);
                    }
                }
            }
            delete this.registry[key];
            delete this.refhash[key];
            this.return_data.bibchange = true;
        }
    }
};
CSL.Registry.prototype.doinserts = function (mylist) {
    var len, pos, item, Item, akey, newitem, abase, j, jlen, k, klen, i, ilen;
    if ("string" === typeof mylist) {
        mylist = [mylist];
    }
    for (var i = 0, ilen = mylist.length; i < ilen; i += 1) {
        item = mylist[i];
        if (!this.registry[item]) {
            Item = this.state.retrieveItem(item);
            akey = CSL.getAmbiguousCite.call(this.state, Item);
            this.ambigsTouched[akey] = true;
            if (!Item.legislation_id) {
                this.akeys[akey] = true;
            }
            newitem = {
                "id": "" + item,
                "seq": 0,
                "offset": 0,
                "sortkeys": false,
                "ambig": false,
                "rendered": false,
                "disambig": false,
                "ref": Item
            };
            this.registry[item] = newitem;
            if (this.citationreg.citationsByItemId && this.citationreg.citationsByItemId[item]) {
                this.registry[item]["first-reference-note-number"] = this.citationreg.citationsByItemId[item][0].properties.noteIndex;
            }
            abase = CSL.getAmbigConfig.call(this.state);
            this.registerAmbigToken(akey, item, abase);
            this.touched[item] = true;
            this.return_data.bibchange = true;
        }
    }
};
CSL.Registry.prototype.rebuildlist = function () {
    var count, len, pos, item;
    this.reflist = [];
    if (this.state.opt.citation_number_sort_direction === CSL.DESCENDING
       && this.state.opt.citation_number_sort_used) {
    }
    len = this.mylist.length;
    for (pos = 0; pos < len; pos += 1) {
        item = this.mylist[pos];
        this.reflist.push(this.registry[item]);
        this.oldseq[item] = this.registry[item].seq;
        this.registry[item].seq = (pos + 1);
    }
    if (this.state.opt.citation_number_sort_direction === CSL.DESCENDING
       && this.state.opt.citation_number_sort_used) {
    }
};
CSL.Registry.prototype.dorefreshes = function () {
    var key, regtoken, Item, old_akey, akey, abase;
    for (var key in this.refreshes) {
        regtoken = this.registry[key];
        if (!regtoken) {
            continue;
        }
        regtoken.sortkeys = undefined;
        Item = this.state.retrieveItem(key);
        var akey = regtoken.ambig;
        if ("undefined" === typeof akey) {
            this.state.tmp.disambig_settings = false;
            akey = CSL.getAmbiguousCite.call(this.state, Item);
            abase = CSL.getAmbigConfig.call(this.state);
            this.registerAmbigToken(akey, key, abase);
        }
        for (var akkey in this.ambigresets) {
            if (this.ambigresets[akkey] === 1) {
                var loneKey = this.ambigcites[akey][0];
                var Item = this.state.retrieveItem(loneKey);
                this.registry[loneKey].disambig = new CSL.AmbigConfig;
                this.state.tmp.disambig_settings = false;
                var akey = CSL.getAmbiguousCite.call(this.state, Item);
                var abase = CSL.getAmbigConfig.call(this.state);
                this.registerAmbigToken(akey, loneKey, abase);
            }
        }
        this.state.tmp.taintedItemIDs[key] = true;
        this.ambigsTouched[akey] = true;
        if (!Item.legislation_id) {
            this.akeys[akey] = true;
        }
        this.touched[key] = true;
    }
};
CSL.Registry.prototype.setdisambigs = function () {
    var akey, leftovers, key, pos, len, id;
    this.leftovers = [];
    for (akey in this.ambigsTouched) {
        this.state.disambiguate.run(akey);
    }
    this.ambigsTouched = {};
    this.akeys = {};
};
CSL.Registry.prototype.renumber = function () {
    var len, pos, item;
    if (this.state.opt.citation_number_sort_direction === CSL.DESCENDING
       && this.state.opt.citation_number_sort_used) {
    }
    len = this.reflist.length;
    for (pos = 0; pos < len; pos += 1) {
        item = this.reflist[pos];
        item.seq = (pos + 1);
        if (this.state.opt.update_mode === CSL.NUMERIC && item.seq != this.oldseq[item.id]) {
            this.state.tmp.taintedItemIDs[item.id] = true;
        }
        if (this.state.opt.bib_mode === CSL.NUMERIC && item.seq != this.oldseq[item.id]) {
            this.return_data.bibchange = true;
        }
    }
    if (this.state.opt.citation_number_sort_direction === CSL.DESCENDING
       && this.state.opt.citation_number_sort_used) {
        this.reflist.reverse();
    }
};
CSL.Registry.prototype.setsortkeys = function () {
    var key;
    for (var i = 0, ilen = this.mylist.length; i < ilen; i += 1) {
        var key = this.mylist[i];
        if (this.touched[key] || this.state.tmp.taintedItemIDs[key] || !this.registry[key].sortkeys) {
            this.registry[key].sortkeys = CSL.getSortKeys.call(this.state, this.state.retrieveItem(key), "bibliography_sort");
        }
    }
};
CSL.Registry.prototype.sorttokens = function () {
    this.reflist.sort(this.sorter.compareKeys);
};
CSL.Registry.Comparifier = function (state, keyset) {
    var sort_directions, len, pos, compareKeys;
    var sortCompare = CSL.getSortCompare(state.opt["default-locale-sort"]);
    sort_directions = state[keyset].opt.sort_directions;
    this.compareKeys = function (a, b) {
        len = a.sortkeys ? a.sortkeys.length : 0;
        for (pos = 0; pos < len; pos += 1) {
            var cmp = 0;
            if (a.sortkeys[pos] === b.sortkeys[pos]) {
                cmp = 0;
            } else if ("undefined" === typeof a.sortkeys[pos]) {
                cmp = sort_directions[pos][1];
            } else if ("undefined" === typeof b.sortkeys[pos]) {
                cmp = sort_directions[pos][0];
            } else {
                cmp = sortCompare(a.sortkeys[pos], b.sortkeys[pos]);
            }
            if (0 < cmp) {
                return sort_directions[pos][1];
            } else if (0 > cmp) {
                return sort_directions[pos][0];
            }
        }
        if (a.seq > b.seq) {
            return 1;
        } else if (a.seq < b.seq) {
            return -1;
        }
        return 0;
    };
    compareKeys = this.compareKeys;
    this.compareCompositeKeys = function (a, b) {
        return compareKeys(a[1], b[1]);
    };
};
CSL.Registry.prototype.compareRegistryTokens = function (a, b) {
    if (a.seq > b.seq) {
        return 1;
    } else if (a.seq < b.seq) {
        return -1;
    }
    return 0;
};
CSL.Registry.prototype.registerAmbigToken = function (akey, id, ambig_config) {
    if (this.registry[id] && this.registry[id].disambig && this.registry[id].disambig.names) {
        for (var i = 0, ilen = ambig_config.names.length; i < ilen; i += 1) {
            var new_names_params = ambig_config.names[i];
            var old_names_params = this.registry[id].disambig.names[i];
            if (new_names_params !== old_names_params) {
                this.state.tmp.taintedItemIDs[id] = true;
            } else if (ambig_config.givens[i]) {
                for (var j=0,jlen=ambig_config.givens[i].length;j<jlen;j+=1) {
                    var new_gnames_params = ambig_config.givens[i][j];
                    var old_gnames_params = this.registry[id].disambig.givens[i][j];
                    if (new_gnames_params !== old_gnames_params) {
                        this.state.tmp.taintedItemIDs[id] = true;
                    }
                }
            }
        }
    }
    if (!this.ambigcites[akey]) {
        this.ambigcites[akey] = [];
    }
    if (this.ambigcites[akey].indexOf("" + id) === -1) {
        this.ambigcites[akey].push("" + id);
    }
    this.registry[id].ambig = akey;
    var dome = false;
    this.registry[id].disambig = CSL.cloneAmbigConfig(ambig_config);
};
CSL.getSortKeys = function (Item, key_type) {
    var area, root, extension, strip_prepositions, use_parallels, len, pos;
    area = this.tmp.area;
    root = this.tmp.root;
    extension = this.tmp.extension;
    strip_prepositions = CSL.Util.Sort.strip_prepositions;
    this.tmp.area = key_type;
    this.tmp.root = key_type.indexOf("_") > -1 ? key_type.slice(0,-5) : key_type;
    this.tmp.extension = "_sort";
    this.tmp.disambig_override = true;
    this.tmp.disambig_request = false;
    this.parallel.use_parallels = (this.parallel.use_parallels === true || this.parallel.use_parallels === null) ? null : false;
    this.tmp.suppress_decorations = true;
    CSL.getCite.call(this, Item);
    this.tmp.suppress_decorations = false;
    this.parallel.use_parallels = this.parallel.use_parallels === null ? true : false;
    this.tmp.disambig_override = false;
    len = this[key_type].keys.length;
    for (pos = 0; pos < len; pos += 1) {
        this[key_type].keys[pos] = strip_prepositions(this[key_type].keys[pos]);
    }
    this.tmp.area = area;
    this.tmp.root = root;
    this.tmp.extension = extension;
    return this[key_type].keys;
};
module.exports = CSL;
CSL.Registry.NameReg = function (state) {
    var pkey, ikey, skey, floor, ceiling, dagopt, gdropt, ret, pos, items, strip_periods, set_keys, evalname, delitems, addname, key, myitems, i, ilen;
    this.state = state;
    this.namereg = {};
    this.nameind = {};
    this.nameindpkeys = {};
    this.itemkeyreg = {};
    strip_periods = function (str) {
        if (!str) {
            str = "";
        }
        return str.replace(/\./g, " ").replace(/\s+/g, " ").replace(/\s+$/,"");
    };
    set_keys = function (state, itemid, nameobj) {
        pkey = strip_periods(nameobj.family);
        skey = strip_periods(nameobj.given);
        var m = skey.match(/[,\!]* ([^,]+)$/);
        if (m && m[1] === m[1].toLowerCase()) {
            skey = skey.replace(/[,\!]* [^,]+$/, "");
        }
        ikey = CSL.Util.Names.initializeWith(state, skey, "%s");
        if (state.citation.opt["givenname-disambiguation-rule"] === "by-cite") {
            pkey = "" + itemid + pkey;
        }
    };
    evalname = function (item_id, nameobj, namenum, request_base, form, initials) {
        var pos, len, items, param;
        if (state.tmp.area.slice(0, 12) === "bibliography" && !form) {
            if ("string" === typeof initials) {
                return 1;
            } else {
                return 2;
            }
        }
        var res = state.nameOutput.getName(nameobj, "locale-translit", true);
        nameobj = res.name;
        set_keys(this.state, "" + item_id, nameobj);
        param = 2;
        dagopt = state.opt["disambiguate-add-givenname"];
        gdropt = state.citation.opt["givenname-disambiguation-rule"];
        var gdropt_orig = gdropt;
        if (gdropt === "by-cite") {
            gdropt = "all-names";
        }
        if ("short" === form) {
            param = 0;
        } else if ("string" === typeof initials) {
            param = 1;
        }
        if ("undefined" === typeof this.namereg[pkey] || "undefined" === typeof this.namereg[pkey].ikey[ikey]) {
            return param;
        }
        if (gdropt_orig === "by-cite" && param <= request_base) {
            return request_base;
        }
        if (!dagopt) {
            return param;
        }
        if ("string" === typeof gdropt && gdropt.slice(0, 12) === "primary-name" && namenum > 0) {
            return param;
        }
        if (!gdropt || gdropt === "all-names" || gdropt === "primary-name") {
            if (this.namereg[pkey].count > 1) {
                param = 1;
            }
            if ((this.namereg[pkey].ikey 
                 && this.namereg[pkey].ikey[ikey].count > 1)
                || (this.namereg[pkey].count > 1 
                    && "string" !== typeof initials)) {
                param = 2;
            }
        } else if (gdropt === "all-names-with-initials" || gdropt === "primary-name-with-initials") {
            if (this.namereg[pkey].count > 1) {
                param = 1;
            } else {
                param = 0;
            }
        }
        if (!state.registry.registry[item_id]) {
            if (form == "short") {
                return 0;
            } else if ("string" == typeof initials) {
                return 1;
            }
        } else {
            return param;
        }
    };
    delitems = function (ids) {
        var item, pos, len, posA, posB, id, fullkey, llen, ppos, otherid;
        if ("string" === typeof ids || "number" === typeof ids) {
            ids = ["" + ids];
        }
        var ret = {};
        len = ids.length;
        for (pos = 0; pos < len; pos += 1) {
            id = "" + ids[pos];
            if (!this.nameind[id]) {
                continue;
            }
            for (fullkey in this.nameind[id]) {
                if (this.nameind[id].hasOwnProperty(fullkey)) {
                    var key = fullkey.split("::");
                    pkey = key[0];
                    ikey = key[1];
                    skey = key[2];
                    if ("undefined" === typeof this.namereg[pkey]) {
                        continue;
                    }
                    items = this.namereg[pkey].items;
                    if (skey && this.namereg[pkey].ikey[ikey] && this.namereg[pkey].ikey[ikey].skey[skey]) {
                        myitems = this.namereg[pkey].ikey[ikey].skey[skey].items;
                        posB = myitems.indexOf("" + id);
                        if (posB > -1) {
                            this.namereg[pkey].ikey[ikey].skey[skey].items = myitems.slice(0, posB).concat(myitems.slice([(posB + 1)]));
                        }
                        if (this.namereg[pkey].ikey[ikey].skey[skey].items.length === 0) {
                            delete this.namereg[pkey].ikey[ikey].skey[skey];
                            this.namereg[pkey].ikey[ikey].count += -1;
                            if (this.namereg[pkey].ikey[ikey].count < 2) {
                                for (var i = 0, ilen = this.namereg[pkey].ikey[ikey].items.length; i < ilen; i += 1) {
                                    state.tmp.taintedItemIDs[this.namereg[pkey].ikey[ikey].items[i]] = true;
                                }
                            }
                        }
                    }
                    if (ikey && this.namereg[pkey].ikey[ikey]) {
                        posB = this.namereg[pkey].ikey[ikey].items.indexOf("" + id);
                        if (posB > -1) {
                            items = this.namereg[pkey].ikey[ikey].items.slice();
                            this.namereg[pkey].ikey[ikey].items = items.slice(0, posB).concat(items.slice([posB + 1]));
                        }
                        if (this.namereg[pkey].ikey[ikey].items.length === 0) {
                            delete this.namereg[pkey].ikey[ikey];
                            this.namereg[pkey].count += -1;
                            if (this.namereg[pkey].count < 2) {
                                for (var i = 0, ilen = this.namereg[pkey].items.length; i < ilen; i += 1) {
                                    state.tmp.taintedItemIDs[this.namereg[pkey].items[i]] = true;
                                }
                            }
                        }
                    }
                    if (pkey) {
                        posB = this.namereg[pkey].items.indexOf("" + id);
                        if (posB > -1) {
                            items = this.namereg[pkey].items.slice();
                            this.namereg[pkey].items = items.slice(0, posB).concat(items.slice([posB + 1], items.length));
                        }
                        if (this.namereg[pkey].items.length < 2) {
                            delete this.namereg[pkey];
                        }
                    }
                    delete this.nameind[id][fullkey];
                }
            }
            delete this.nameind[id];
            delete this.nameindpkeys[id];
        }
        return ret;
    };
    addname = function (item_id, nameobj, pos) {
        var i, ilen;
        var res = state.nameOutput.getName(nameobj, "locale-translit", true);
        nameobj = res.name;
        if (state.citation.opt["givenname-disambiguation-rule"]
            && state.citation.opt["givenname-disambiguation-rule"].slice(0, 8) === "primary-"
            && pos !== 0) {
                return;
        }
        set_keys(this.state, "" + item_id, nameobj);
        if (pkey) {
            if ("undefined" === typeof this.namereg[pkey]) {
                this.namereg[pkey] = {};
                this.namereg[pkey].count = 0;
                this.namereg[pkey].ikey = {};
                this.namereg[pkey].items = [item_id];
            } else if (this.namereg[pkey].items.indexOf(item_id) === -1) {
                this.namereg[pkey].items.push(item_id);
            }
        }
        if (pkey && ikey) {
            if ("undefined" === typeof this.namereg[pkey].ikey[ikey]) {
                this.namereg[pkey].ikey[ikey] = {};
                this.namereg[pkey].ikey[ikey].count = 0;
                this.namereg[pkey].ikey[ikey].skey = {};
                this.namereg[pkey].ikey[ikey].items = [item_id];
                this.namereg[pkey].count += 1;
                if (this.namereg[pkey].count === 2) {
                    for (var i = 0, ilen = this.namereg[pkey].items.length; i < ilen; i += 1) {
                        state.tmp.taintedItemIDs[this.namereg[pkey].items[i]] = true;
                    }
                }
            } else if (this.namereg[pkey].ikey[ikey].items.indexOf(item_id) === -1) {
                this.namereg[pkey].ikey[ikey].items.push(item_id);
            }
        }
        if (pkey && ikey && skey) {
            if ("undefined" === typeof this.namereg[pkey].ikey[ikey].skey[skey]) {
                this.namereg[pkey].ikey[ikey].skey[skey] = {};
                this.namereg[pkey].ikey[ikey].skey[skey].items = [item_id];
                this.namereg[pkey].ikey[ikey].count += 1;
                if (this.namereg[pkey].ikey[ikey].count === 2) {
                    for (var i = 0, ilen = this.namereg[pkey].ikey[ikey].items.length; i < ilen; i += 1) {
                        state.tmp.taintedItemIDs[this.namereg[pkey].ikey[ikey].items[i]] = true;
                    }
                }
            } else if (this.namereg[pkey].ikey[ikey].skey[skey].items.indexOf(item_id) === -1) {
                this.namereg[pkey].ikey[ikey].skey[skey].items.push(item_id);
            }
        }
        if ("undefined" === typeof this.nameind[item_id]) {
            this.nameind[item_id] = {};
            this.nameindpkeys[item_id] = {};
        }
        if (pkey) {
            this.nameind[item_id][pkey + "::" + ikey + "::" + skey] = true;
            this.nameindpkeys[item_id][pkey] = this.namereg[pkey];
        }
    };
    this.addname = addname;
    this.delitems = delitems;
    this.evalname = evalname;
};
module.exports = CSL;
CSL.Registry.CitationReg = function (state) {
    this.citationById = {};
    this.citationByIndex = [];
};
module.exports = CSL;
CSL.Disambiguation = function (state) {
    this.state = state;
    this.sys = this.state.sys;
    this.registry = state.registry.registry;
    this.ambigcites = state.registry.ambigcites;
    this.configModes();
    this.debug = false;
};
CSL.Disambiguation.prototype.run = function(akey) {
    if (!this.modes.length) {
        return;
    }
    this.akey = akey;
    if (this.initVars(akey)) {
        this.runDisambig();
    }
};
CSL.Disambiguation.prototype.runDisambig = function () {
    var pos, len, ppos, llen, pppos, lllen, ismax;
    this.initGivens = true;
    while (this.lists.length) {
        this.gnameset = 0;
        this.gname = 0;
        this.clashes = [1, 0];
        while(this.lists[0][1].length) {
            this.listpos = 0;
            if (!this.base) {
                this.base = this.lists[0][0];
            }
            var names_used = [];
            ismax = this.incrementDisambig();
            this.scanItems(this.lists[0]);
            this.evalScan(ismax);
        }
        this.lists = this.lists.slice(1);
    }
};
CSL.Disambiguation.prototype.scanItems = function (list) {
    var pos, len, Item, otherItem, ItemCite, ignore, base;
    this.Item = list[1][0];
    this.ItemCite = CSL.getAmbiguousCite.call(this.state, this.Item, this.base, true);
    this.scanlist = list[1];
    this.partners = [];
    this.partners.push(this.Item);
    this.nonpartners = [];
    var clashes = 0;
    for (var pos = 1, len = list[1].length; pos < len; pos += 1) {
        otherItem = list[1][pos];
        var otherItemCite = CSL.getAmbiguousCite.call(this.state, otherItem, this.base, true);
        if (this.ItemCite === otherItemCite) {
            clashes += 1;
            this.partners.push(otherItem);
        } else {
            this.nonpartners.push(otherItem);
        }
    }
    this.clashes[0] = this.clashes[1];
    this.clashes[1] = clashes;
};
CSL.Disambiguation.prototype.evalScan = function (maxed) {
    this[this.modes[this.modeindex]](maxed);
    if (maxed) {
        if (this.modeindex < this.modes.length - 1) {
            this.modeindex += 1;
        } else {
            this.lists[this.listpos + 1] = [this.base, []];
        }
    }
};
CSL.Disambiguation.prototype.disNames = function (ismax) {
    var pos, len, mybase, i, ilen;
    if (this.clashes[1] === 0 && this.nonpartners.length === 1) {
        this.captureStepToBase();
        this.state.registry.registerAmbigToken(this.akey, "" + this.nonpartners[0].id, this.betterbase);
        this.state.registry.registerAmbigToken(this.akey, "" + this.partners[0].id, this.betterbase);
        this.lists[this.listpos] = [this.betterbase, []];
    } else if (this.clashes[1] === 0) {
        this.captureStepToBase();
        this.state.registry.registerAmbigToken(this.akey, "" + this.partners[0].id, this.betterbase);
        this.lists[this.listpos] = [this.betterbase, this.nonpartners];
        if (this.nonpartners.length) {
            this.initGivens = true;
        }
    } else if (this.nonpartners.length === 1) {
        this.captureStepToBase();
        this.state.registry.registerAmbigToken(this.akey, "" + this.nonpartners[0].id, this.betterbase);
        this.lists[this.listpos] = [this.betterbase, this.partners];
    } else if (this.clashes[1] < this.clashes[0]) {
        this.captureStepToBase();
        this.lists[this.listpos] = [this.betterbase, this.partners];
        this.lists.push([this.betterbase, this.nonpartners]);
    } else {
        if (ismax) {
            this.lists[this.listpos] = [this.betterbase, this.nonpartners];
            this.lists.push([this.betterbase, this.partners]);
            if (this.modeindex === this.modes.length - 1) {
                for (var i = 0, ilen = this.partners.length; i < ilen; i += 1) {
                    this.state.registry.registerAmbigToken(this.akey, "" + this.partners[i].id, this.betterbase);
                }
                this.lists[this.listpos] = [this.betterbase, []];
            }
        }
    }
};
CSL.Disambiguation.prototype.disExtraText = function () {
    var pos, len, mybase;
    var done = false;
    if (this.clashes[1] === 0 && this.nonpartners.length < 2) {
        done = true;
    }
    if (!done && (!this.base.disambiguate || this.state.tmp.disambiguate_count !== this.state.tmp.disambiguate_maxMax)) {
        this.modeindex = 0;
        this.base.disambiguate = this.state.tmp.disambiguate_count;
        this.betterbase.disambiguate = this.state.tmp.disambiguate_count;
        if (!this.base.disambiguate) {
            this.initGivens = true;
            this.base.disambiguate = 1;
            for (var i = 0, ilen = this.lists[this.listpos][1].length; i < ilen; i += 1) {
                this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id] = true;
            }
        } else {
            this.disNames();
        }
    } else if (done || this.state.tmp.disambiguate_count === this.state.tmp.disambiguate_maxMax) {
        if (done || this.modeindex === this.modes.length - 1) {
            var base = this.lists[this.listpos][0];
            for (var i = 0, ilen = this.lists[this.listpos][1].length; i < ilen; i += 1) {
                this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id] = true;
                this.state.registry.registerAmbigToken(this.akey, "" + this.lists[this.listpos][1][i].id, base);
            }
            this.lists[this.listpos] = [this.betterbase, []];
        } else {
            this.modeindex = this.modes.length - 1;
            var base = this.lists[this.listpos][0];
            base.disambiguate = true;
            for (var i = 0, ilen = this.lists[this.listpos][1].length; i < ilen; i += 1) {
                this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id] = true;
                this.state.registry.registerAmbigToken(this.akey, "" + this.lists[this.listpos][1][i].id, base);
            }
        }
    }
};
CSL.Disambiguation.prototype.disYears = function () {
    var pos, len, tokens, token, item;
    tokens = [];
    var base = this.lists[this.listpos][0];
    if (this.clashes[1]) {
		for (var i = 0, ilen = this.state.registry.mylist.length; i < ilen; i += 1) {
			var origid = this.state.registry.mylist[i];
			for (var j = 0, jlen = this.lists[this.listpos][1].length; j < jlen; j += 1) {
				var token = this.lists[this.listpos][1][j];
				if (token.id == origid) {
					tokens.push(this.registry[token.id]);
					break;
				}
			}
		}
    }
    tokens.sort(this.state.registry.sorter.compareKeys);
    for (var pos = 0, len = tokens.length; pos < len; pos += 1) {
        base.year_suffix = ""+pos;
        var oldBase = this.state.registry.registry[tokens[pos].id].disambig;
        this.state.registry.registerAmbigToken(this.akey, "" + tokens[pos].id, base);
        if (CSL.ambigConfigDiff(oldBase,base)) {
            this.state.tmp.taintedItemIDs[tokens[pos].id] = true;
        }
    }
    this.lists[this.listpos] = [this.betterbase, []];
};
CSL.Disambiguation.prototype.incrementDisambig = function () {
    var val;
    if (this.initGivens) {
        this.initGivens = false;
        return false;
    }
    var maxed = false;
    var increment_names = true;
    var increment_givens = true;
    if ("disNames" === this.modes[this.modeindex]) {
        increment_names = false;
        if ("number" !== typeof this.givensMax) {
            increment_names = true;
        }
        var increment_namesets = false;
        if ("number" !== typeof this.namesMax) {
            increment_namesets = true;
        }
        if ("number" === typeof this.givensMax) {
            if (this.base.givens.length && this.base.givens[this.gnameset][this.gname] < this.givensMax) {
                this.base.givens[this.gnameset][this.gname] += 1;
            } else {
                increment_names = true;
            }
        }
        if ("number" === typeof this.namesMax 
            && increment_names) {
            if (this.state.opt["disambiguate-add-names"]) {
                increment_namesets = false;
                if (this.gname < this.namesMax) {
                    this.base.names[this.gnameset] += 1;
                    this.gname += 1;
                } else {
                    increment_namesets = true;
                }
            } else {
                increment_namesets = true;
            }
        }
        if ("number" === typeof this.namesetsMax && increment_namesets) {
            if (this.gnameset < this.namesetsMax) {
                this.gnameset += 1;
                this.base.names[this.gnameset] = 1;
                this.gname = 0;
            } else {
                var increment_mode = true;
            }
        }
        if (("number" !== typeof this.namesetsMax || this.namesetsMax === -1 || this.gnameset === this.namesetsMax)
            && (!this.state.opt["disambiguate-add-names"] || "number" !== typeof this.namesMax || this.gname === this.namesMax)
            && ("number" != typeof this.givensMax || "undefined" === typeof this.base.givens[this.gnameset] || "undefined" === typeof this.base.givens[this.gnameset][this.gname] || this.base.givens[this.gnameset][this.gname] === this.givensMax)) {
            maxed = true;
        }
    } else if ("disExtraText" === this.modes[this.modeindex]) {
        this.base.disambiguate += 1;
        this.betterbase.disambiguate += 1;
    }
    return maxed;
};
CSL.Disambiguation.prototype.initVars = function (akey) {
    var i, ilen, myIds, myItemBundles, myItems;
    this.lists = [];
    this.base = false;
    this.betterbase = false;
    this.akey = akey;
    this.maxNamesByItemId = {};
    myItemBundles = [];
    myIds = this.ambigcites[akey];
    if (!myIds || !myIds.length) {
        return false;
    }
    var Item = false;
    var myItem = this.state.retrieveItem("" + myIds[0]);
    this.getCiteData(myItem);
    this.base = CSL.getAmbigConfig.call(this.state);
    if (myIds && myIds.length > 1) {
        myItemBundles.push([this.maxNamesByItemId[myItem.id], myItem]);
        for (var i = 1, ilen = myIds.length; i < ilen; i += 1) {
            myItem = this.state.retrieveItem("" + myIds[i]);
            this.getCiteData(myItem, this.base);
            myItemBundles.push([this.maxNamesByItemId[myItem.id], myItem]);
        }
        myItemBundles.sort(
            function (a, b) {
                if (a[0] > b[0]) {
                    return 1;
                } else if (a[0] < b[0]) {
                    return -1;
                } else {
                    if (a[1].id > b[1].id) {
                        return 1;
                    } else if (a[1].id < b[1].id) {
                        return -1;
                    } else {
                        return 0;
                    }
                }
            }
        );
        myItems = [];
        for (var i = 0, ilen = myItemBundles.length; i < ilen; i += 1) {
            myItems.push(myItemBundles[i][1]);
        }
        this.lists.push([this.base, myItems]);
        this.Item = this.lists[0][1][0];
    } else {
        this.Item = this.state.retrieveItem("" + myIds[0]);
    }
    this.modeindex = 0;
    if (this.state.citation.opt["disambiguate-add-names"] || true) {
        this.namesMax = this.maxNamesByItemId[this.Item.id][0];
    } else {
        var namesMax = this.base.names[0];
        for (var i=1,ilen=this.base.names.length;i<ilen;i+=1){
            namesMax = Math.max(namesMax,this.base.names.names[i]);
        }
    }
    this.padBase(this.base);
    this.padBase(this.betterbase);
    this.base.year_suffix = false;
    this.base.disambiguate = false;
    this.betterbase.year_suffix = false;
    this.betterbase.disambiguate = false;
    if (this.state.citation.opt["givenname-disambiguation-rule"] === "by-cite"
       && this.state.opt["disambiguate-add-givenname"]) {
        this.givensMax = 2;
    }
    return true;
};
CSL.Disambiguation.prototype.padBase = function (base) {
    for (var i = 0, ilen = base.names.length; i < ilen; i += 1) {
        if (!base.givens[i]) {
            base.givens[i] = [];
        }
        for (var j=0,jlen=base.names[i];j<jlen;j+=1) {
            if (!base.givens[i][j]) {
                base.givens[i][j] = 0;
            }
        }
    }
}
CSL.Disambiguation.prototype.configModes = function () {
    var dagopt, gdropt;
    this.modes = [];
    dagopt = this.state.opt["disambiguate-add-givenname"];
    gdropt = this.state.citation.opt["givenname-disambiguation-rule"];
    if (this.state.opt['disambiguate-add-names'] || (dagopt && gdropt === "by-cite")) {
        this.modes.push("disNames");
    }
    if (this.state.opt.has_disambiguate) {
        this.modes.push("disExtraText");
    }
    if (this.state.opt["disambiguate-add-year-suffix"]) {
        this.modes.push("disYears");
    }
};
CSL.Disambiguation.prototype.getCiteData = function(Item, base) {
    if (!this.maxNamesByItemId[Item.id]) {
        CSL.getAmbiguousCite.call(this.state, Item, base);
        base = CSL.getAmbigConfig.call(this.state);
        this.maxNamesByItemId[Item.id] = CSL.getMaxVals.call(this.state);
        this.state.registry.registry[Item.id].disambig.givens = this.state.tmp.disambig_settings.givens.slice();
        for (var i=0,ilen=this.state.registry.registry[Item.id].disambig.givens.length;i<ilen;i+=1) {
            this.state.registry.registry[Item.id].disambig.givens[i] = this.state.tmp.disambig_settings.givens[i].slice();
        }
        this.namesetsMax = this.state.registry.registry[Item.id].disambig.names.length - 1;
        if (!this.base) {
            this.base = base;
            this.betterbase = CSL.cloneAmbigConfig(base);
        }
        if (base.names.length < this.base.names.length) {
            this.base = base;
        }
        var update = false;
        for (var i = 0, ilen = base.names.length; i < ilen; i += 1) {
            if (base.names[i] > this.base.names[i]) {
                this.base.givens[i] = base.givens[i].slice();
                this.base.names[i] = base.names[i];
                this.betterbase.names = this.base.names.slice();
                this.betterbase.givens = this.base.givens.slice();
                this.padBase(this.base);
                this.padBase(this.betterbase);
            }
        }
        this.betterbase.givens = this.base.givens.slice();
        for (var j = 0, jlen = this.base.givens.length; j < jlen; j += 1) {
            this.betterbase.givens[j] = this.base.givens[j].slice();
        }
    }
};
CSL.Disambiguation.prototype.captureStepToBase = function() {
    if (this.state.citation.opt["givenname-disambiguation-rule"] === "by-cite"
        && this.base.givens && this.base.givens.length) {
        if ("undefined" !== typeof this.base.givens[this.gnameset][this.gname]) {
            this.betterbase.givens[this.gnameset][this.gname] = this.base.givens[this.gnameset][this.gname];
        }
    }
    this.betterbase.names[this.gnameset] = this.base.names[this.gnameset];
};
module.exports = CSL;
CSL.Engine.prototype.getJurisdictionList = function (jurisdiction) {
    var jurisdictionList = [];
    var jurisdictionElems = jurisdiction.split(":");
    for (var j=jurisdictionElems.length;j>0;j--) {
        jurisdictionList.push(jurisdictionElems.slice(0,j).join(":"));
    }
    if (jurisdictionList.indexOf("us") === -1) {
        jurisdictionList.push("us");
    }
    return jurisdictionList;
}
CSL.Engine.prototype.retrieveAllStyleModules = function (jurisdictionList) {
    var ret = {};
    var preferences = this.locale[this.opt.lang].opts["jurisdiction-preference"];
    preferences = preferences ? preferences : [];
    preferences = [""].concat(preferences);
    for (var i=preferences.length-1;i>-1;i--) {
        var preference = preferences[i];
        for (var j=0,jlen=jurisdictionList.length;j<jlen;j++) {
            var jurisdiction = jurisdictionList[j];
            if (this.opt.jurisdictions_seen[jurisdiction]) continue;
            var res = this.sys.retrieveStyleModule(jurisdiction, preference);
            if ((!res && !preference) || res) {
                this.opt.jurisdictions_seen[jurisdiction] = true;
            }
            if (!res) continue;
            ret[jurisdiction] = res;
        }
    }
    return ret;
}
module.exports = CSL;
CSL.ParticleList = function() {
	var always_dropping_1 = [[[0,1], null]];
	var always_dropping_2 = [[[0,2], null]];
	var always_dropping_3 = [[[0,3], null]]
	var always_non_dropping_1 = [[null, [0,1]]];
	var always_non_dropping_2 = [[null, [0,2]]];
	var always_non_dropping_3 = [[null, [0,3]]];
	var either_1 = [[null, [0,1]],[[0,1],null]];
	var either_2 = [[null, [0,2]],[[0,2],null]];
	var either_1_dropping_best = [[[0,1],null],[null, [0,1]]];
	var either_2_dropping_best = [[[0,2],null],[null, [0,2]]];
	var either_3_dropping_best = [[[0,3],null],[null, [0,3]]];
	var non_dropping_2_alt_dropping_1_non_dropping_1 = [[null, [0,2]], [[0,1], [1,2]]];
	var PARTICLES = [
		["'s", always_non_dropping_1],
		["'s-", always_non_dropping_1],
		["'t", always_non_dropping_1],
		["a", 	always_non_dropping_1],
		["aan 't", always_non_dropping_2],
		["aan de", always_non_dropping_2],
		["aan den", always_non_dropping_2],
		["aan der", always_non_dropping_2],
		["aan het", always_non_dropping_2],
		["aan t", always_non_dropping_2],
		["aan", always_non_dropping_1],
		["ad-", either_1],
		["adh-", either_1],
		["af", either_1],
		["al", either_1],
		["al-", either_1],
		["am de", always_non_dropping_2],
		["am", always_non_dropping_1],
		["an-", either_1],
		["ar-", either_1],
		["as-", either_1],
		["ash-", either_1],
		["at-", either_1],
		["ath-", either_1],
		["auf dem", either_2_dropping_best],
		["auf den", either_2_dropping_best],
		["auf der", either_2_dropping_best],
		["auf ter", always_non_dropping_2],
		["auf", either_1_dropping_best],
		["aus 'm", either_2_dropping_best],
		["aus dem", either_2_dropping_best],
		["aus den", either_2_dropping_best],
		["aus der", either_2_dropping_best],
		["aus m", either_2_dropping_best],
		["aus", either_1_dropping_best],
		["aus'm", either_2_dropping_best],
		["az-", either_1],
		["aš-", either_1],
		["aḍ-", either_1],
		["aḏ-", either_1],
		["aṣ-", either_1],
		["aṭ-", either_1],
		["aṯ-", either_1],
		["aẓ-", either_1],
		["ben", always_non_dropping_1],
		["bij 't", always_non_dropping_2],
		["bij de", always_non_dropping_2],
		["bij den", always_non_dropping_2],
		["bij het", always_non_dropping_2],
		["bij t", always_non_dropping_2],
		["bij", always_non_dropping_1],
		["bin", always_non_dropping_1],
		["boven d", always_non_dropping_2],
		["boven d'", always_non_dropping_2],
		["d", always_non_dropping_1],
		["d'", either_1],
		["da", either_1],
		["dal", always_non_dropping_1],
		["dal'", always_non_dropping_1],
		["dall'", always_non_dropping_1],
		["dalla", always_non_dropping_1],
		["das", either_1],
		["de die le", always_non_dropping_3],
		["de die", always_non_dropping_2],
		["de l", always_non_dropping_2],
		["de l'", always_non_dropping_2],
		["de la", non_dropping_2_alt_dropping_1_non_dropping_1],
		["de las", non_dropping_2_alt_dropping_1_non_dropping_1],
		["de le", always_non_dropping_2],
		["de li", either_2],
		["de van der", always_non_dropping_3],
		["de", either_1],
		["de'", either_1],
		["deca", always_non_dropping_1],
		["degli", either_1],
		["dei", either_1],
		["del", either_1],
		["dela", always_dropping_1],
		["dell'", either_1],
		["della", either_1],
		["delle", either_1],
		["dello", either_1],
		["den", either_1],
		["der", either_1],
		["des", either_1],
		["di", either_1],
		["die le", always_non_dropping_2],
		["do", always_non_dropping_1],
		["don", always_non_dropping_1],
		["dos", either_1],
		["du", either_1],
		["ed-", either_1],
		["edh-", either_1],
		["el", either_1],
		["el-", either_1],
		["en-", either_1],
		["er-", either_1],
		["es-", either_1],
		["esh-", either_1],
		["et-", either_1],
		["eth-", either_1],
		["ez-", either_1],
		["eš-", either_1],
		["eḍ-", either_1],
		["eḏ-", either_1],
		["eṣ-", either_1],
		["eṭ-", either_1],
		["eṯ-", either_1],
		["eẓ-", either_1],
		["het", always_non_dropping_1],
		["i", always_non_dropping_1],
		["il", always_dropping_1],
		["im", always_non_dropping_1],
		["in 't", always_non_dropping_2],
		["in de", always_non_dropping_2],
		["in den", always_non_dropping_2],
		["in der", either_2],
		["in het", always_non_dropping_2],
		["in t", always_non_dropping_2],
		["in", always_non_dropping_1],
		["l", always_non_dropping_1],
		["l'", always_non_dropping_1],
		["la", always_non_dropping_1],
		["las", always_non_dropping_1],
		["le", always_non_dropping_1],
		["les", either_1],
		["lo", either_1],
		["los", always_non_dropping_1],
		["lou", always_non_dropping_1],
		["of", always_non_dropping_1],
		["onder 't", always_non_dropping_2],
		["onder de", always_non_dropping_2],
		["onder den", always_non_dropping_2],
		["onder het", always_non_dropping_2],
		["onder t", always_non_dropping_2],
		["onder", always_non_dropping_1],
		["op 't", always_non_dropping_2],
		["op de", either_2],
		["op den", always_non_dropping_2],
		["op der", always_non_dropping_2],
		["op gen", always_non_dropping_2],
		["op het", always_non_dropping_2],
		["op t", always_non_dropping_2],
		["op ten", always_non_dropping_2],
		["op", always_non_dropping_1],
		["over 't", always_non_dropping_2],
		["over de", always_non_dropping_2],
		["over den", always_non_dropping_2],
		["over het", always_non_dropping_2],
		["over t", always_non_dropping_2],
		["over", always_non_dropping_1],
		["s", always_non_dropping_1],
		["s'", always_non_dropping_1],
		["sen", always_dropping_1],
		["t", always_non_dropping_1],
		["te", always_non_dropping_1],
		["ten", always_non_dropping_1],
		["ter", always_non_dropping_1],
		["tho", always_non_dropping_1],
		["thoe", always_non_dropping_1],
		["thor", always_non_dropping_1],
		["to", always_non_dropping_1],
		["toe", always_non_dropping_1],
		["tot", always_non_dropping_1],
		["uijt 't", always_non_dropping_2],
		["uijt de", always_non_dropping_2],
		["uijt den", always_non_dropping_2],
		["uijt te de", always_non_dropping_3],
		["uijt ten", always_non_dropping_2],
		["uijt", always_non_dropping_1],
		["uit 't", always_non_dropping_2],
		["uit de", always_non_dropping_2],
		["uit den", always_non_dropping_2],
		["uit het", always_non_dropping_2],
		["uit t", always_non_dropping_2],
		["uit te de", always_non_dropping_3],
		["uit ten", always_non_dropping_2],
		["uit", always_non_dropping_1],
		["unter", always_non_dropping_1],
		["v", always_non_dropping_1],
		["v.", always_non_dropping_1],
		["v.d.", always_non_dropping_1],
		["van 't", always_non_dropping_2],
		["van de l", always_non_dropping_3],
		["van de l'", always_non_dropping_3],
		["van de", always_non_dropping_2],
		["van de", always_non_dropping_2],
		["van den", always_non_dropping_2],
		["van der", always_non_dropping_2],
		["van gen", always_non_dropping_2],
		["van het", always_non_dropping_2],
		["van la", always_non_dropping_2],
		["van t", always_non_dropping_2],
		["van ter", always_non_dropping_2],
		["van van de", always_non_dropping_3],
		["van", either_1],
		["vander", always_non_dropping_1],
		["vd", always_non_dropping_1],
		["ver", always_non_dropping_1],
		["vom und zum", always_dropping_3],
		["vom", either_1],
		["von 't", always_non_dropping_2],
		["von dem", either_2_dropping_best],
		["von den", either_2_dropping_best],
		["von der", either_2_dropping_best],
		["von t", always_non_dropping_2],
		["von und zu", either_3_dropping_best],
		["von zu", either_2_dropping_best],
		["von", either_1_dropping_best],
		["voor 't", always_non_dropping_2],
		["voor de", always_non_dropping_2],
		["voor den", always_non_dropping_2],
		["voor in 't", always_non_dropping_3],
		["voor in t", always_non_dropping_3],
		["voor", always_non_dropping_1],
		["vor der", either_2_dropping_best],
		["vor", either_1_dropping_best],
		["z", always_dropping_1],
		["ze", always_dropping_1],
		["zu", either_1_dropping_best],
		["zum", either_1],
		["zur", either_1]
	];
    return PARTICLES;
}();
CSL.parseParticles = function(){
    function splitParticles(nameValue, firstNameFlag, caseOverride) {
		var origNameValue = nameValue;
		nameValue = caseOverride ? nameValue.toLowerCase() : nameValue;
		var particleList = [];
		var apostrophe;
		var rex;
		if (firstNameFlag) {
			nameValue = nameValue.split("").reverse().join("");
			rex = CSL.PARTICLE_GIVEN_REGEXP;
		} else {
			rex = CSL.PARTICLE_FAMILY_REGEXP;
		}
		var m = nameValue.match(rex);
		while (m) {
			var m1 = firstNameFlag ? m[1].split("").reverse().join("") : m[1];
			var firstChar = m ? m1 : false;
			var firstChar = firstChar ? m1.replace(/^[-\'\u02bb\u2019\s]*(.).*$/, "$1") : false;
			var hasParticle = firstChar ? firstChar.toUpperCase() !== firstChar : false;
			if (!hasParticle) break;
			if (firstNameFlag) {
				particleList.push(origNameValue.slice(m1.length * -1));
				origNameValue = origNameValue.slice(0,m1.length * -1);
			} else {
				particleList.push(origNameValue.slice(0,m1.length));
				origNameValue = origNameValue.slice(m1.length);
			}
			nameValue = m[2];
			m = nameValue.match(rex);
		}
		if (firstNameFlag) {
			nameValue = nameValue.split("").reverse().join("");
			particleList.reverse();
			for (var i=1,ilen=particleList.length;i<ilen;i++) {
				if (particleList[i].slice(0, 1) == " ") {
					particleList[i-1] += " ";
				}
			}
			for (var i=0,ilen=particleList.length;i<ilen;i++) {
				if (particleList[i].slice(0, 1) == " ") {
					particleList[i] = particleList[i].slice(1);
				}
			}
			nameValue = origNameValue.slice(0, nameValue.length);
		} else {
			nameValue = origNameValue.slice(nameValue.length * -1);
		}
		return [hasParticle, nameValue, particleList];
	}
    function trimLast(str) {
        var lastChar = str.slice(-1);
        str = str.trim();
        if (lastChar === " " && ["\'", "\u2019"].indexOf(str.slice(-1)) > -1) {
            str += " ";
        }
        return str;
    }
    function parseSuffix(nameObj) {
        if (!nameObj.suffix && nameObj.given) {
            var m = nameObj.given.match(/(\s*,!*\s*)/);
            if (m) {
                var idx = nameObj.given.indexOf(m[1]);
                var possible_suffix = nameObj.given.slice(idx + m[1].length);
                var possible_comma = nameObj.given.slice(idx, idx + m[1].length).replace(/\s*/g, "");
                if (possible_suffix.replace(/\./g, "") === 'et al' && !nameObj["dropping-particle"]) {
                    nameObj["dropping-particle"] = possible_suffix;
                    nameObj["comma-dropping-particle"] = ",";
                } else {
                    if (possible_comma.length === 2) {
                        nameObj["comma-suffix"] = true;
                    }
                    nameObj.suffix = possible_suffix;
                }
                nameObj.given = nameObj.given.slice(0, idx);
            }
        }
    }
    return function(nameObj) {
        var res = splitParticles(nameObj.family);
        var hasLastParticle = res[0];
        var lastNameValue = res[1];
        var lastParticleList = res[2];
        nameObj.family = lastNameValue;
        var nonDroppingParticle = trimLast(lastParticleList.join(""));
        if (nonDroppingParticle) {
            nameObj['non-dropping-particle'] = nonDroppingParticle;
        }
        parseSuffix(nameObj);
        var res = splitParticles(nameObj.given, true);
        var hasFirstParticle = res[0];
        var firstNameValue = res[1];
        var firstParticleList = res[2];
        nameObj.given = firstNameValue;
        var droppingParticle = firstParticleList.join("").trim();
        if (droppingParticle) {
            nameObj['dropping-particle'] = droppingParticle;
        }
    }
}();
module.exports = CSL;

/* WEBPACK VAR INJECTION */}.call(this, __webpack_require__(/*! ./../../../../node_modules/webpack/buildin/module.js */ "../node_modules/webpack/buildin/module.js")(module)))

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi4vbm9kZV9tb2R1bGVzL3dlYnBhY2svYnVpbGRpbi9tb2R1bGUuanMiLCJ3ZWJwYWNrOi8vLy4vcHVibGljL25vZGVfbW9kdWxlcy9jaXRlcHJvYy9jaXRlcHJvY19jb21tb25qcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7Ozs7Ozs7Ozs7OztBQ3JCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0RBQXdEO0FBQ3hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZCQUE2QjtBQUM3QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrREFBa0Q7QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDLE9BQU87QUFDcEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdURBQXVELEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRTtBQUMzRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLFFBQVE7QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtEQUFrRCxPQUFPO0FBQ3pEO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0NBQStDLE9BQU87QUFDdEQ7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1Q0FBdUMsT0FBTztBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLGlDQUFpQztBQUNqQztBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5Q0FBeUMsZUFBZTtBQUN4RCxxQkFBcUI7QUFDckIsb0NBQW9DO0FBQ3BDO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0NBQWdDLEtBQUs7QUFDckM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1Q0FBdUM7QUFDdkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRCQUE0QjtBQUM1QixnQ0FBZ0M7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9DQUFvQztBQUNwQztBQUNBO0FBQ0EsOFNBQThTLElBQUk7QUFDbFQsMkJBQTJCLDBCQUEwQixJQUFJO0FBQ3pELG9EQUFvRDtBQUNwRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNDQUFzQyxPQUFPO0FBQzdDO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUNBQXlDLFFBQVE7QUFDakQ7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSwwQ0FBMEMsT0FBTztBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkNBQTJDLE9BQU87QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNEZBQTRGO0FBQzVGLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQSw0REFBNEQsVUFBVTtBQUN0RTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsU0FBUztBQUNULG1DQUFtQyxZQUFZO0FBQy9DO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsY0FBYztBQUNkLG1CQUFtQjtBQUNuQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0NBQXNDLE9BQU87QUFDN0M7QUFDQTtBQUNBLCtDQUErQyxPQUFPO0FBQ3REO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsOENBQThDLFVBQVU7QUFDeEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtEQUFrRCxVQUFVO0FBQzVEO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsUUFBUTtBQUNyRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDhDQUE4QyxVQUFVO0FBQ3hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSw2REFBNkQ7QUFDN0QsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLHdDQUF3QyxPQUFPO0FBQy9DO0FBQ0E7QUFDQSxhQUFhO0FBQ2IscURBQXFEO0FBQ3JEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsT0FBTztBQUNwRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxPQUFPO0FBQ3BEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQsT0FBTztBQUN4RDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDLE9BQU87QUFDcEQ7QUFDQTtBQUNBO0FBQ0EsSztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFEQUFxRCxPQUFPO0FBQzVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9DQUFvQyxvQkFBb0IsYUFBYTtBQUNyRTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxPQUFPO0FBQ3BEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQsT0FBTztBQUN4RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFFQUFxRSxPQUFPO0FBQzVFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDREQUE0RCxPQUFPO0FBQ25FO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsT0FBTztBQUNwRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxPQUFPO0FBQ3BEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLGlEQUFpRCxPQUFPO0FBQ3hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCO0FBQ2hCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsT0FBTztBQUM1QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdDQUFnQyxLQUFLO0FBQ3JDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCLDBCQUEwQjtBQUMxQix3QkFBd0Isd0JBQXdCO0FBQ2hELCtCQUErQixJQUFJLEVBQUU7QUFDckMsK0NBQStDO0FBQy9DO0FBQ0EsYUFBYTtBQUNiLG1DQUFtQyxJQUFJLEVBQUU7QUFDekMsK0NBQStDO0FBQy9DO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLE9BQU87QUFDOUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0RBQWdELE9BQU87QUFDdkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUNBQWlDLE9BQU87QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4REFBOEQ7QUFDOUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0VBQWdFLFFBQVE7QUFDeEU7QUFDQTtBQUNBLG9FQUFvRSxRQUFRO0FBQzVFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRDQUE0QyxXQUFXO0FBQ3ZEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLFdBQVc7QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsV0FBVztBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFDQUFxQyxXQUFXO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsV0FBVztBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxVQUFVO0FBQ2xEO0FBQ0E7QUFDQSxzREFBc0QsVUFBVTtBQUNoRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsVUFBVTtBQUMvQztBQUNBO0FBQ0E7QUFDQSxvRDtBQUNBO0FBQ0EsK0RBQStELFVBQVU7QUFDekU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRDQUE0QyxVQUFVO0FBQ3REO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUNBQXFDLFdBQVc7QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtEQUErRCxVQUFVO0FBQ3pFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0RBQW9ELFVBQVU7QUFDOUQ7QUFDQSx1RUFBdUUsVUFBVTtBQUNqRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUNBQXFDLFdBQVc7QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCwyQ0FBMkMsV0FBVztBQUN0RDtBQUNBO0FBQ0EsYUFBYTtBQUNiLG9EQUFvRCxhQUFhO0FBQ2pFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkNBQTJDLFVBQVU7QUFDckQ7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDLFVBQVU7QUFDdkQ7QUFDQSxtREFBbUQsVUFBVTtBQUM3RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5Q0FBeUMsT0FBTztBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3Q0FBd0MsUUFBUTtBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLFFBQVE7QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsOEJBQThCLElBQUksVUFBVSxJQUFJLE9BQU8sRUFBRTtBQUN6RCw0QkFBNEIsRUFBRSxrQkFBa0IsSUFBSSxFQUFFLElBQUk7QUFDMUQsNEJBQTRCLElBQUk7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsUUFBUTtBQUMzRDtBQUNBO0FBQ0E7QUFDQSxnREFBZ0QsUUFBUTtBQUN4RDtBQUNBLHVEQUF1RCxRQUFRO0FBQy9EO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbURBQW1ELFFBQVE7QUFDM0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsUUFBUTtBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBLHVEQUF1RCxRQUFRO0FBQy9EO0FBQ0E7QUFDQSxrRUFBa0UsUUFBUTtBQUMxRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCLGtFQUFrRSxRQUFRO0FBQzFFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlDQUFpQztBQUNqQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsUUFBUTtBQUMzRDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtDQUFrQyxRQUFRO0FBQzFDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRCQUE0QixRQUFRO0FBQ3BDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9DQUFvQyxRQUFRO0FBQzVDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUMsVUFBVTtBQUMzQztBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzQ0FBc0MsUUFBUTtBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUNBQXFDLFFBQVE7QUFDN0M7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDLElBQUk7QUFDdEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxFQUFFLE9BQU8sRUFBRTtBQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdEQUFnRCxRQUFRO0FBQ3hEO0FBQ0E7QUFDQSxrREFBa0QsUUFBUTtBQUMxRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EsNkNBQTZDLFFBQVE7QUFDckQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFDQUFxQyxRQUFRO0FBQzdDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSx3Q0FBd0MsUUFBUTtBQUNoRDtBQUNBO0FBQ0E7QUFDQSwwQ0FBMEMsUUFBUTtBQUNsRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUNBQXlDLEVBQUU7QUFDM0M7QUFDQTtBQUNBO0FBQ0EseURBQXlELFFBQVE7QUFDakU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdEQUF3RCxRQUFRO0FBQ2hFO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCO0FBQ3ZCO0FBQ0E7QUFDQSx1Q0FBdUMsUUFBUTtBQUMvQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUVBQXVFLFVBQVU7QUFDakY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUIsMERBQTBEO0FBQ25GO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLFdBQVc7QUFDNUI7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLFdBQVc7QUFDNUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQixXQUFXO0FBQ2hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJCQUEyQixlQUFlO0FBQzFDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0NBQXNDLFVBQVU7QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNERBQTRELFFBQVE7QUFDcEU7QUFDQTtBQUNBLDZEQUE2RCxRQUFRO0FBQ3JFO0FBQ0E7QUFDQSw2REFBNkQsUUFBUTtBQUNyRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0MsUUFBUTtBQUN2RDtBQUNBO0FBQ0Esc0RBQXNELFFBQVE7QUFDOUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFEQUFxRCxVQUFVO0FBQy9EO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtDQUErQyxVQUFVO0FBQ3pEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtCQUErQixVQUFVO0FBQ3pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw0Q0FBNEMsVUFBVTtBQUN0RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbURBQW1EO0FBQ25EO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckIsa0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0MsVUFBVTtBQUN6RDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0EsYUFBYTtBQUNiO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrQ0FBa0MsT0FBTztBQUN6QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUNBQXFDLE1BQU07QUFDM0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLDhDQUE4QyxRQUFRO0FBQ3RELHFEQUFxRCxRQUFRO0FBQzdEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtDQUErQyxVQUFVO0FBQ3pEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLGdEQUFnRCxVQUFVO0FBQzFEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxRQUFRO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLFVBQVU7QUFDakQ7QUFDQSxzQkFBc0I7QUFDdEIsMENBQTBDLFVBQVU7QUFDcEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxVQUFVO0FBQ2pEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxVQUFVO0FBQ2pEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxVQUFVO0FBQ2pEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkNBQTJDLFVBQVU7QUFDckQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseURBQXlELFVBQVU7QUFDbkU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtDQUErQyxVQUFVO0FBQ3pELGdEQUFnRCxVQUFVO0FBQzFEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0NBQWdDO0FBQ2hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaURBQWlELFFBQVE7QUFDekQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxVQUFVO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUVBQWlFLFVBQVU7QUFDM0U7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxRUFBcUUsVUFBVTtBQUMvRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzREFBc0QsT0FBTztBQUM3RDtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlDQUFpQyxPQUFPO0FBQ3hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0NBQXNDLFVBQVU7QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLHFDQUFxQyxPQUFPO0FBQzVDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJEQUEyRCxVQUFVO0FBQ3JFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyREFBMkQsVUFBVTtBQUNyRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixXQUFXO0FBQzVCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLFdBQVc7QUFDNUI7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0NBQWdDLFNBQVM7QUFDekM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUIsV0FBVztBQUM1QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDhCQUE4QixhQUFhO0FBQzNDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFDQUFxQyxLQUFLO0FBQzFDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLE1BQU07QUFDcEIsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLE1BQU07QUFDcEIsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLE1BQU07QUFDcEIsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLE1BQU07QUFDcEIsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLE1BQU07QUFDcEIsU0FBUztBQUNULFVBQVU7QUFDVjtBQUNBO0FBQ0EsbUJBQW1CO0FBQ25CLG1CQUFtQjtBQUNuQixtQkFBbUI7QUFDbkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNEQUFzRCxPQUFPO0FBQzdEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0RBQXNELE9BQU87QUFDN0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0EseUNBQXlDLEtBQUs7QUFDOUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlDQUF5QyxLQUFLO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsOENBQThDLE9BQU87QUFDckQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlEQUFpRCxLQUFLO0FBQ3REO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUNBQXlDLEtBQUs7QUFDOUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUM7QUFDakM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGE7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsOENBQThDLE9BQU87QUFDckQ7QUFDQTtBQUNBLHVEQUF1RCxPQUFPO0FBQzlEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCLFdBQVc7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1QkFBdUI7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzREFBc0QsVUFBVTtBQUNoRTtBQUNBLHNEQUFzRCxVQUFVO0FBQ2hFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrREFBa0QsVUFBVTtBQUM1RDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtEQUFrRCxVQUFVO0FBQzVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlEQUF5RCxVQUFVO0FBQ25FO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtDQUErQyxVQUFVO0FBQ3pEO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdEQUFnRCxVQUFVO0FBQzFEO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0RBQWtELFVBQVU7QUFDNUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpRUFBaUUsVUFBVTtBQUMzRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0RBQWtELFVBQVU7QUFDNUQ7QUFDQTtBQUNBO0FBQ0Esc0RBQXNELFVBQVU7QUFDaEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzREFBc0QsVUFBVTtBQUNoRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCLE9BQU87QUFDOUI7QUFDQTtBQUNBO0FBQ0EsZ0RBQWdELFVBQVU7QUFDMUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrRUFBa0UsVUFBVTtBQUM1RTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtRUFBbUUsVUFBVTtBQUM3RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtHQUErRyxPQUFPO0FBQ3RIO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkJBQTZCO0FBQzdCLDJHQUEyRyxPQUFPO0FBQ2xIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZCQUE2QjtBQUM3QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxRUFBcUUsVUFBVTtBQUMvRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZCQUE2QjtBQUM3QjtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlDQUFpQztBQUNqQztBQUNBO0FBQ0E7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlDQUFpQztBQUNqQztBQUNBO0FBQ0E7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQSw2QkFBNkI7QUFDN0IsK0NBQStDO0FBQy9DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5RUFBeUUsVUFBVTtBQUNuRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNEQUFzRCxVQUFVO0FBQ2hFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdEQUF3RCxVQUFVO0FBQ2xFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNEQUFzRCxVQUFVO0FBQ2hFO0FBQ0E7QUFDQTtBQUNBLGtEQUFrRCxVQUFVO0FBQzVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxRUFBcUUsVUFBVTtBQUMvRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixXQUFXO0FBQzVCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCLFdBQVc7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0MsT0FBTztBQUN0RDtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsT0FBTztBQUMxRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4Q0FBOEMsVUFBVTtBQUN4RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1Q0FBdUMsVUFBVTtBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrREFBa0QsVUFBVTtBQUM1RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLFdBQVc7QUFDNUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0NBQStDLE9BQU87QUFDdEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1EQUFtRCxPQUFPO0FBQzFEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxXQUFXO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0JBQXNCLGFBQWE7QUFDbkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUIsV0FBVztBQUNwQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0VBQStFLE9BQU87QUFDdEY7QUFDQTtBQUNBLDhFQUE4RSxPQUFPO0FBQ3JGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUZBQWlGLE9BQU87QUFDeEY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBEQUEwRCw4QkFBOEI7QUFDeEY7QUFDQTtBQUNBO0FBQ0EsZ0NBQWdDLFFBQVE7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixXQUFXO0FBQzVCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QztBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCLGVBQWU7QUFDdEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnREFBZ0QsVUFBVTtBQUMxRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLFVBQVU7QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2REFBNkQsVUFBVTtBQUN2RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSw2REFBNkQsVUFBVTtBQUN2RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLDREQUE0RCxVQUFVO0FBQ3RFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyREFBMkQsVUFBVTtBQUNyRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLHlCQUF5QixpQkFBaUI7QUFDMUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0MsVUFBVTtBQUN6RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsT0FBTztBQUMxRDtBQUNBO0FBQ0EsbURBQW1ELE9BQU87QUFDMUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxPQUFPO0FBQzlDLDREQUE0RCxPQUFPO0FBQ25FO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLE9BQU87QUFDOUM7QUFDQTtBQUNBLHdDQUF3QyxPQUFPO0FBQy9DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxVQUFVO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkMsVUFBVTtBQUNyRDtBQUNBO0FBQ0EsMkNBQTJDLFVBQVU7QUFDckQ7QUFDQSxnRUFBZ0UsVUFBVTtBQUMxRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLFVBQVU7QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQSw0Q0FBNEMsT0FBTztBQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQkFBZ0I7QUFDaEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxPQUFPO0FBQ3BELDhEQUE4RCxPQUFPO0FBQ3JFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUM7QUFDckM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLHVEQUF1RCxXQUFXO0FBQ2xFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrREFBa0QsVUFBVTtBQUM1RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFDQUFxQztBQUNyQztBQUNBO0FBQ0EsdUJBQXVCLGVBQWUscUJBQXFCO0FBQzNEO0FBQ0E7QUFDQSxtREFBbUQsV0FBVztBQUM5RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkIsVUFBVTtBQUN2QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbURBQW1ELFdBQVc7QUFDOUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQSxxREFBcUQsT0FBTztBQUM1RDtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQSxxREFBcUQsT0FBTztBQUM1RDtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQSxxREFBcUQsT0FBTztBQUM1RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbURBQW1ELFdBQVc7QUFDOUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkMsT0FBTztBQUNsRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLE9BQU87QUFDOUM7QUFDQTtBQUNBO0FBQ0EscURBQXFELE9BQU87QUFDNUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxPQUFPO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3Q0FBd0M7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFDQUFxQyxXQUFXO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBLDZCQUE2QjtBQUM3QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsV0FBVztBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFDQUFxQyxXQUFXO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekIsMkVBQTJFLFVBQVU7QUFDckY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QiwyRUFBMkUsVUFBVTtBQUNyRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUMsV0FBVztBQUM1QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtRUFBbUU7QUFDbkUsa0ZBQWtGO0FBQ2xGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnREFBZ0QsT0FBTztBQUN2RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlFQUFpRSxPQUFPO0FBQ3hFO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUVBQXlFLE9BQU87QUFDaEY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlFQUFpRSxPQUFPO0FBQ3hFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtFQUFrRSxPQUFPO0FBQ3pFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUVBQXFFLE9BQU87QUFDNUU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTLE9BQU87QUFDaEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsVUFBVTtBQUM3RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdURBQXVELFVBQVU7QUFDakU7QUFDQTtBQUNBLGFBQWE7QUFDYix1REFBdUQsVUFBVTtBQUNqRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJEO0FBQ0EsOENBQThDO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQsVUFBVTtBQUMzRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxREFBcUQsVUFBVTtBQUMvRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0RBQW9ELFVBQVU7QUFDOUQ7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsVUFBVTtBQUM3RDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3Q0FBd0MsVUFBVTtBQUNsRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1QsK0RBQStELFVBQVU7QUFDekU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxVQUFVO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsVUFBVTtBQUM3RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxzREFBc0QsVUFBVTtBQUNoRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0RBQXNELFVBQVU7QUFDaEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLGlEQUFpRCxVQUFVO0FBQzNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVEQUF1RCxPQUFPO0FBQzlEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxVQUFVO0FBQ3ZEO0FBQ0E7QUFDQTtBQUNBLGlEQUFpRCxPQUFPO0FBQ3hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLFVBQVU7QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBEQUEwRCxVQUFVO0FBQ3BFO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLDBEQUEwRCxVQUFVO0FBQ3BFLHFFQUFxRSxVQUFVO0FBQy9FO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtCQUFrQiw2QkFBNkI7QUFDL0MsS0FBSztBQUNMO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1DQUFtQyxLQUFLO0FBQ3hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLG1DQUFtQyxLQUFLO0FBQ3hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUNBQW1DLFFBQVE7QUFDM0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQ0FBbUMsUUFBUTtBQUMzQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCLDRCQUE0QjtBQUM1QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQSxTQUFTO0FBQ1Q7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4QkFBOEIsUUFBUTtBQUN0QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSwyREFBMkQsVUFBVTtBQUNyRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvQ0FBb0MsVUFBVTtBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscURBQXFELFVBQVU7QUFDL0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNEQUFzRCxVQUFVO0FBQ2hFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBDQUEwQyxVQUFVO0FBQ3BEO0FBQ0EscURBQXFELFVBQVU7QUFDL0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaURBQWlELFVBQVU7QUFDM0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzREFBc0QsVUFBVTtBQUNoRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlEQUFpRCxVQUFVO0FBQzNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBEQUEwRCxPQUFPO0FBQ2pFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzREFBc0QsVUFBVTtBQUNoRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDLFVBQVU7QUFDNUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkMsVUFBVTtBQUNyRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxVQUFVO0FBQ3ZEO0FBQ0E7QUFDQSxpQ0FBaUM7QUFDakM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtEQUFrRCxVQUFVO0FBQzVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQsVUFBVTtBQUMzRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJEQUEyRCxVQUFVO0FBQ3JFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlEQUFpRCxVQUFVO0FBQzNEO0FBQ0EsMkRBQTJELFVBQVU7QUFDckU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0Esd0JBQXdCO0FBQ3hCO0FBQ0E7QUFDQSxrREFBa0QsVUFBVTtBQUM1RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0VBQXNFLFVBQVU7QUFDaEY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxVQUFVO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiLGdFQUFnRSxVQUFVO0FBQzFFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsVUFBVTtBQUN2RDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0Esd0JBQXdCO0FBQ3hCO0FBQ0E7QUFDQSxrREFBa0QsVUFBVTtBQUM1RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUssd0RBQXdEO0FBQzdEO0FBQ0EsS0FBSyxxQ0FBcUM7QUFDMUM7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSyxPQUFPO0FBQ1o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVCxnRUFBZ0UsVUFBVTtBQUMxRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJDO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLFNBQVM7QUFDVCwyQztBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCO0FBQ2hCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsVUFBVTtBQUM3RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCO0FBQ2hCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnREFBZ0QsT0FBTztBQUN2RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0RBQWdELFVBQVU7QUFDMUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsT0FBTztBQUNwRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw0REFBNEQsRUFBRTtBQUM5RCxpREFBaUQsRUFBRTtBQUNuRDtBQUNBO0FBQ0EsNENBQTRDLE9BQU87QUFDbkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZCQUE2QixVQUFVO0FBQ3ZDO0FBQ0EsNkRBQTZELFVBQVU7QUFDdkU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseURBQXlELFVBQVU7QUFDbkU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsdURBQXVELFVBQVU7QUFDakU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUNBQXFDLFVBQVU7QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5Q0FBeUMsVUFBVTtBQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBEQUEwRCxPQUFPO0FBQ2pFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFGQUFxRixRQUFRO0FBQzdGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekIsMkVBQTJFLFVBQVU7QUFDckY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkJBQTZCO0FBQzdCO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0U7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscURBQXFEO0FBQ3JEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQ7QUFDakQ7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDO0FBQzdDO0FBQ0E7QUFDQSx5Q0FBeUM7QUFDekM7QUFDQSxxRkFBcUYsTUFBTTtBQUMzRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLG9CQUFvQjtBQUNyQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1Q0FBdUMsT0FBTztBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxPQUFPO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBDQUEwQyxPQUFPO0FBQ2pEO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBLFNBQVM7QUFDVDtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQ0FBbUMsT0FBTztBQUMxQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLG1EQUFtRCxRQUFRO0FBQzNEO0FBQ0E7QUFDQSx5REFBeUQsT0FBTztBQUNoRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0RBQW9ELE9BQU87QUFDM0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkRBQTZEO0FBQzdEO0FBQ0E7QUFDQTtBQUNBLG9HQUFvRztBQUNwRztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJEQUEyRCxVQUFVO0FBQ3JFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZEQUE2RCxPQUFPO0FBQ3BFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnREFBZ0QsT0FBTztBQUN2RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxPQUFPO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxPQUFPO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4Q0FBOEMsT0FBTztBQUNyRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbURBQW1ELE9BQU87QUFDMUQ7QUFDQTtBQUNBLDBDQUEwQyxJQUFJO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDhDQUE4QyxPQUFPO0FBQ3JEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNDQUFzQyxPQUFPO0FBQzdDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0NBQXNDLE9BQU87QUFDN0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzQ0FBc0MsT0FBTztBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsVUFBVTtBQUM3RDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSw2Q0FBNkMsT0FBTztBQUNwRDtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxzQ0FBc0MsVUFBVTtBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0Esc0RBQXNELFVBQVU7QUFDaEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNDQUFzQyxVQUFVO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkRBQTZELFVBQVU7QUFDdkU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5Q0FBeUMsVUFBVTtBQUNuRDtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlDQUF5QyxXQUFXO0FBQ3BEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1Q0FBdUMsV0FBVztBQUNsRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCLFdBQVc7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4REFBOEQsVUFBVTtBQUN4RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSxhQUFhO0FBQ2I7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4Q0FBOEMsS0FBSztBQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtCQUErQixVQUFVO0FBQ3pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBLFNBQVM7QUFDVDtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkJBQTZCO0FBQzdCO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0RBQXNELFdBQVc7QUFDakU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQSx5QkFBeUIsV0FBVztBQUNwQztBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0EsNkJBQTZCO0FBQzdCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQixXQUFXO0FBQ2hDO0FBQ0E7QUFDQTtBQUNBLDhCQUE4QixhQUFhO0FBQzNDO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdURBQXVELFdBQVc7QUFDbEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCLFVBQVU7QUFDakM7QUFDQTtBQUNBO0FBQ0EsaUNBQWlDLFdBQVc7QUFDNUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpRUFBaUUsUUFBUTtBQUN6RTtBQUNBO0FBQ0EscURBQXFELFVBQVU7QUFDL0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRDQUE0QyxVQUFVO0FBQ3REO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkNBQTJDLE9BQU87QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkMsT0FBTztBQUNsRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMkNBQTJDLE9BQU87QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtDQUErQyxFQUFFO0FBQ2pELFNBQVM7QUFDVCwrQ0FBK0MsRUFBRTtBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxlQUFlO0FBQ2Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVCQUF1QjtBQUN2QixhQUFhO0FBQ2IsdUJBQXVCO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVCx1QkFBdUI7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0MsVUFBVTtBQUN6RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSwwQ0FBMEM7QUFDMUM7QUFDQTtBQUNBO0FBQ0Esa0RBQWtELFVBQVU7QUFDNUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3QkFBd0I7QUFDeEI7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsNERBQTRELFVBQVU7QUFDdEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYTtBQUNBO0FBQ0E7QUFDQSxzRUFBc0UsVUFBVTtBQUNoRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNFQUFzRSxRQUFRO0FBQzlFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw0RUFBNEU7QUFDNUU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFFQUFxRSxRQUFRO0FBQzdFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyRUFBMkU7QUFDM0U7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQsVUFBVTtBQUMzRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFEQUFxRCxXQUFXO0FBQ2hFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdCQUF3QjtBQUN4QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxxQkFBcUIsV0FBVztBQUNoQztBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSx1QztBQUNBO0FBQ0E7QUFDQSxLQUFLLE9BQU87QUFDWjtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLEtBQUs7QUFDTDtBQUNBLGdFQUFnRSxPQUFPO0FBQ3ZFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYztBQUNkO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0RBQXNELFVBQVU7QUFDaEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsVUFBVTtBQUN2RCw2REFBNkQsVUFBVTtBQUN2RTtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLFVBQVU7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0Esc0NBQXNDLFVBQVU7QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJCQUEyQixRQUFRO0FBQ25DO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDLFVBQVU7QUFDdkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLFVBQVU7QUFDakQ7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLFVBQVU7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLFVBQVU7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4Q0FBOEMsVUFBVTtBQUN4RDtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUI7QUFDbkI7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVEQUF1RCxVQUFVO0FBQ2pFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1REFBdUQsVUFBVTtBQUNqRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0EscURBQXFEO0FBQ3JEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtFQUErRSxVQUFVO0FBQ3pGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZCQUE2QjtBQUM3QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBLHVGQUF1RixVQUFVO0FBQ2pHO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUM7QUFDakM7QUFDQSxpQ0FBaUM7QUFDakM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkIsSUFBSTtBQUNqQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUNBQWlDLFVBQVU7QUFDM0M7QUFDQTtBQUNBLDJCQUEyQixPQUFPO0FBQ2xDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQsVUFBVTtBQUMzRDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCLFdBQVc7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtDQUFrQyxLQUFLO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkJBQTZCO0FBQzdCO0FBQ0EscUNBQXFDO0FBQ3JDLDJDQUEyQyxRQUFRO0FBQ25EO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxPQUFPO0FBQzlDO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxJQUFJO0FBQzVDLCtEQUErRCw4Q0FBOEM7QUFDN0c7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDLFFBQVE7QUFDckQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMENBQTBDLE9BQU87QUFDakQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdURBQXVELE9BQU87QUFDOUQ7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2RkFBNkYsUUFBUTtBQUNyRztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3Q0FBd0MsT0FBTztBQUMvQztBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdURBQXVELEtBQUs7QUFDNUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNENBQTRDLFFBQVE7QUFDcEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3Q0FBd0MsUUFBUTtBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDLE9BQU87QUFDekM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCLFdBQVc7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBLDJDQUEyQyxXQUFXO0FBQ3REO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCLFdBQVc7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBDQUEwQyxVQUFVO0FBQ3BEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNENBQTRDLFVBQVU7QUFDdEQ7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCLFdBQVc7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVCwrQ0FBK0M7QUFDL0M7QUFDQSwyREFBMkQ7QUFDM0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLE9BQU87QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxPQUFPO0FBQy9DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLE9BQU87QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUVBQW1FLCtCQUErQixtQjtBQUNsRztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLE9BQU87QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLE9BQU87QUFDL0M7QUFDQTtBQUNBO0FBQ0EsNERBQTRELCtCQUErQjtBQUMzRjtBQUNBO0FBQ0E7QUFDQSxpRUFBaUUsK0JBQStCO0FBQ2hHO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRFQUE0RSx3QkFBd0I7QUFDcEc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5Q0FBeUMsT0FBTztBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsTUFBTTtBQUMzQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUNBQXVDLEtBQUs7QUFDNUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0RBQWdELEtBQUs7QUFDckQ7QUFDQTtBQUNBLGlEQUFpRCxLQUFLO0FBQ3REO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0NBQStDO0FBQy9DO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3REFBd0QsS0FBSztBQUM3RDtBQUNBO0FBQ0EsMERBQTBELEtBQUs7QUFDL0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsT0FBTztBQUNwRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwwQ0FBMEMsT0FBTztBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkJBQTZCO0FBQzdCO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0EseUJBQXlCO0FBQ3pCO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMENBQTBDLEtBQUs7QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxLQUFLO0FBQzdDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxPQUFPO0FBQ3BEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtGQUFrRiw0REFBNEQ7QUFDOUk7QUFDQSxtSkFBbUosMkJBQTJCO0FBQzlLLEtBQUs7QUFDTDtBQUNBO0FBQ0EsZ0RBQWdEO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaURBQWlELE9BQU87QUFDeEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVEQUF1RCxPQUFPO0FBQzlEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0MsT0FBTztBQUN0RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0NBQStDLE9BQU87QUFDdEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtDQUErQyxPQUFPO0FBQ3REO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQsT0FBTztBQUMxRDtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0NBQStDLE9BQU87QUFDdEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0NBQStDLE9BQU87QUFDdEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QztBQUN4QyxpQ0FBaUM7QUFDakMsaUNBQWlDO0FBQ2pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0JBQXNCO0FBQ3RCLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJEQUEyRDtBQUMzRCx1RUFBdUU7QUFDdkU7QUFDQSwrREFBK0Q7QUFDL0Q7QUFDQSw2REFBNkQ7QUFDN0Q7QUFDQSxpRUFBaUU7QUFDakUsMkVBQTJFO0FBQzNFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0EsRUFBRTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxFQUFFO0FBQ0Y7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdCQUF3QjtBQUN4QjtBQUNBO0FBQ0Esa0ZBQWtGO0FBQ2xGLGtCQUFrQjtBQUNsQjtBQUNBLGtDQUFrQyxxREFBcUQsRUFBRSxFQUFFO0FBQzNGLGtDQUFrQztBQUNsQyxLQUFLO0FBQ0w7QUFDQSwyQkFBMkIsS0FBSyxXQUFXO0FBQzNDLDJCQUEyQixNQUFNLFdBQVc7QUFDNUMsNEJBQTRCLEtBQUssV0FBVztBQUM1QyxpQ0FBaUMsbUJBQW1CO0FBQ3BELDZCQUE2QixVQUFVLFdBQVc7QUFDbEQsMEJBQTBCLEtBQUssV0FBVztBQUMxQyw0QkFBNEIsTUFBTSxXQUFXO0FBQzdDO0FBQ0E7QUFDQSxtQ0FBbUMsTUFBTSxXQUFXO0FBQ3BEO0FBQ0EsMkRBQTJEO0FBQzNELHlEQUF5RDtBQUN6RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0EsaUJBQWlCO0FBQ2pCLGVBQWU7QUFDZiwrQkFBK0I7QUFDL0I7QUFDQTtBQUNBLEVBQUU7QUFDRjtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1EQUFtRCxVQUFVO0FBQzdEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1EQUFtRCxVQUFVO0FBQzdEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUNBQXlDLE9BQU87QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0NBQWdDLEtBQUs7QUFDckM7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlDQUF5QyxPQUFPO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0NBQW9DLEtBQUs7QUFDekM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QixXQUFXO0FBQ3BDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtGQUFrRixVQUFVO0FBQzVGO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0VBQXdFLFFBQVE7QUFDaEY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1EQUFtRCxRQUFRO0FBQzNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlDQUF5QyxVQUFVO0FBQ25EO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixXQUFXO0FBQzVCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUIsV0FBVztBQUM1QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDhDQUE4QyxVQUFVO0FBQ3hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQixXQUFXO0FBQ2hDO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLGFBQWE7QUFDYjtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5REFBeUQsVUFBVTtBQUNuRTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYixnRUFBZ0UsT0FBTztBQUN2RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixXQUFXO0FBQzVCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCLFdBQVc7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0dBQWtHLFVBQVU7QUFDNUc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUZBQXVGLFVBQVU7QUFDakc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyRUFBMkUsVUFBVTtBQUNyRjtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0ZBQXNGLFVBQVU7QUFDaEc7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkMsV0FBVztBQUN0RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLDREQUE0RCxVQUFVO0FBQ3RFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzRUFBc0UsVUFBVTtBQUNoRjtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLHNFQUFzRSxVQUFVO0FBQ2hGO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBLHNFQUFzRSxVQUFVO0FBQ2hGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyREFBMkQsVUFBVTtBQUNyRTtBQUNBLDZEQUE2RCxVQUFVO0FBQ3ZFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBDQUEwQyxXQUFXO0FBQ3JEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNENBQTRDLFVBQVU7QUFDdEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0EscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9EQUFvRCxVQUFVO0FBQzlEO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxpREFBaUQsT0FBTztBQUN4RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxVQUFVO0FBQ3ZEO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxPQUFPO0FBQy9DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVGQUF1RixPQUFPO0FBQzlGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBaUQsVUFBVTtBQUMzRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVEQUF1RCxVQUFVO0FBQ2pFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3Q0FBd0MsSUFBSTtBQUM1QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvQ0FBb0MsS0FBSztBQUN6QztBQUNBLGtEQUFrRCxPQUFPO0FBQ3pEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlDQUF5QyxPQUFPO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUNBQXlDLE9BQU87QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDO0FBQ0QiLCJmaWxlIjoidmVuZG9yc35jc2wuYnVuZGxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsibW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihtb2R1bGUpIHtcblx0aWYgKCFtb2R1bGUud2VicGFja1BvbHlmaWxsKSB7XG5cdFx0bW9kdWxlLmRlcHJlY2F0ZSA9IGZ1bmN0aW9uKCkge307XG5cdFx0bW9kdWxlLnBhdGhzID0gW107XG5cdFx0Ly8gbW9kdWxlLnBhcmVudCA9IHVuZGVmaW5lZCBieSBkZWZhdWx0XG5cdFx0aWYgKCFtb2R1bGUuY2hpbGRyZW4pIG1vZHVsZS5jaGlsZHJlbiA9IFtdO1xuXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShtb2R1bGUsIFwibG9hZGVkXCIsIHtcblx0XHRcdGVudW1lcmFibGU6IHRydWUsXG5cdFx0XHRnZXQ6IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRyZXR1cm4gbW9kdWxlLmw7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KG1vZHVsZSwgXCJpZFwiLCB7XG5cdFx0XHRlbnVtZXJhYmxlOiB0cnVlLFxuXHRcdFx0Z2V0OiBmdW5jdGlvbigpIHtcblx0XHRcdFx0cmV0dXJuIG1vZHVsZS5pO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdG1vZHVsZS53ZWJwYWNrUG9seWZpbGwgPSAxO1xuXHR9XG5cdHJldHVybiBtb2R1bGU7XG59O1xuIiwiLypcbiAqIENvcHlyaWdodCAoYykgMjAwOS0yMDE2IEZyYW5rIEJlbm5ldHRcbiAqIFxuICogXHRUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yXG4gKiBcdG1vZGlmeSBpdCB1bmRlciBFSVRIRVJcbiAqIFxuICogICAgICAgKiB0aGUgdGVybXMgb2YgdGhlIENvbW1vbiBQdWJsaWMgQXR0cmlidXRpb24gTGljZW5zZSAoQ1BBTCkgYXNcbiAqIFx0ICAgIHB1Ymxpc2hlZCBieSB0aGUgT3BlbiBTb3VyY2UgSW5pdGlhdGl2ZSwgZWl0aGVyIHZlcnNpb24gMSBvZlxuICogXHQgICAgdGhlIENQQUwsIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb247IE9SXG4gKiBcbiAqICAgICAgICogdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgKEFHUEwpXG4gKiAgICAgICAgIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvblxuICogICAgICAgICAzIG9mIHRoZSBBR1BMLCBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICogXG4gKiBcdFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogXHRidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogXHRNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlIEdOVVxuICogXHRBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICogXG4gKiBcdFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBjb3BpZXMgb2YgdGhlIENvbW1vbiBQdWJsaWMgQXR0cmlidXRpb25cbiAqICAgICBMaWNlbnNlIGFuZCBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGhcbiAqICAgICB0aGlzIHByb2dyYW0uICBJZiBub3QsIHNlZSA8aHR0cHM6Ly9vcGVuc291cmNlLm9yZy9saWNlbnNlcy8+IG9yXG4gKiAgICAgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+IHJlc3BlY3RpdmVseS5cbiAqL1xuXG52YXIgQ1NMID0ge1xuICAgIFBST0NFU1NPUl9WRVJTSU9OOiBcIjEuMS4yMDZcIixcbiAgICBDT05ESVRJT05fTEVWRUxfVE9QOiAxLFxuICAgIENPTkRJVElPTl9MRVZFTF9CT1RUT006IDIsXG4gICAgUExBSU5fSFlQSEVOX1JFR0VYOiAvKD86W15cXFxcXS18XFx1MjAxMykvLFxuICAgIExPQ0FUT1JfTEFCRUxTX1JFR0VYUDogbmV3IFJlZ0V4cChcIl4oKGFydHxjaHxzdWJjaHxjb2x8ZmlnfGx8bnxub3xvcHxwfHBwfHBhcmF8c3VicGFyYXxwdHxyfHNlY3xzdWJzZWN8c3Z8c2NofHRpdHx2cnN8dm9sKVxcXFwuKVxcXFxzKyguKilcIiksXG4gICAgU1RBVFVURV9TVUJESVZfR1JPVVBFRF9SRUdFWDogLygoPzpefCApKD86YXJ0fGJrfGNofHN1YmNofGNvbHxmaWd8Zm9sfGx8bnxub3xvcHxwfHBwfHBhcmF8c3VicGFyYXxwdHxyfHNlY3xzdWJzZWN8c3Z8c2NofHRpdHx2cnN8dm9sKVxcLiAqKS9nLFxuICAgIFNUQVRVVEVfU1VCRElWX1BMQUlOX1JFR0VYOiAvKD86KD86XnwgKSg/OmFydHxia3xjaHxzdWJjaHxjb2x8ZmlnfGZvbHxsfG58bm98b3B8cHxwcHxwYXJhfHN1YnBhcmF8cHR8cnxzZWN8c3Vic2VjfHN2fHNjaHx0aXR8dnJzfHZvbClcXC4gKikvLFxuICAgIFNUQVRVVEVfU1VCRElWX1BMQUlOX1JFR0VYX0ZST05UOiAvKD86XlxccypbLiw7XSpcXHMqKD86YXJ0fGJrfGNofHN1YmNofGNvbHxmaWd8Zm9sfGx8bnxub3xvcHxwfHBwfHBhcmF8c3VicGFyYXxwdHxyfHNlY3xzdWJzZWN8c3Z8c2NofHRpdHx2cnN8dm9sKVxcLiAqKS8sXG4gICAgU1RBVFVURV9TVUJESVZfU1RSSU5HUzoge1xuICAgICAgICBcImFydC5cIjogXCJhcnRpY2xlXCIsXG4gICAgICAgIFwiYmsuXCI6IFwiYm9va1wiLFxuICAgICAgICBcImNoLlwiOiBcImNoYXB0ZXJcIixcbiAgICAgICAgXCJzdWJjaC5cIjogXCJzdWJjaGFwdGVyXCIsXG4gICAgICAgIFwicC5cIjogXCJwYWdlXCIsXG4gICAgICAgIFwicHAuXCI6IFwicGFnZVwiLFxuICAgICAgICBcInBhcmEuXCI6IFwicGFyYWdyYXBoXCIsXG4gICAgICAgIFwic3VicGFyYS5cIjogXCJzdWJwYXJhZ3JhcGhcIixcbiAgICAgICAgXCJwdC5cIjogXCJwYXJ0XCIsXG4gICAgICAgIFwici5cIjogXCJydWxlXCIsXG4gICAgICAgIFwic2VjLlwiOiBcInNlY3Rpb25cIixcbiAgICAgICAgXCJzdWJzZWMuXCI6IFwic3Vic2VjdGlvblwiLFxuICAgICAgICBcInNjaC5cIjogXCJzY2hlZHVsZVwiLFxuICAgICAgICBcInRpdC5cIjogXCJ0aXRsZVwiLFxuICAgICAgICBcImNvbC5cIjogXCJjb2x1bW5cIixcbiAgICAgICAgXCJmaWcuXCI6IFwiZmlndXJlXCIsXG4gICAgICAgIFwiZm9sLlwiOiBcImZvbGlvXCIsXG4gICAgICAgIFwibC5cIjogXCJsaW5lXCIsXG4gICAgICAgIFwibi5cIjogXCJub3RlXCIsXG4gICAgICAgIFwibm8uXCI6IFwiaXNzdWVcIixcbiAgICAgICAgXCJvcC5cIjogXCJvcHVzXCIsXG4gICAgICAgIFwic3YuXCI6IFwic3ViLXZlcmJvXCIsXG4gICAgICAgIFwidnJzLlwiOiBcInZlcnNlXCIsXG4gICAgICAgIFwidm9sLlwiOiBcInZvbHVtZVwiXG4gICAgfSxcbiAgICBTVEFUVVRFX1NVQkRJVl9TVFJJTkdTX1JFVkVSU0U6IHtcbiAgICAgICAgXCJhcnRpY2xlXCI6IFwiYXJ0LlwiLFxuICAgICAgICBcImJvb2tcIjogXCJiay5cIixcbiAgICAgICAgXCJjaGFwdGVyXCI6IFwiY2guXCIsXG4gICAgICAgIFwic3ViY2hhcHRlclwiOiBcInN1YmNoLlwiLFxuICAgICAgICBcInBhZ2VcIjogXCJwLlwiLFxuICAgICAgICBcInBhcmFncmFwaFwiOiBcInBhcmEuXCIsXG4gICAgICAgIFwic3VicGFyYWdyYXBoXCI6IFwic3VicGFyYS5cIixcbiAgICAgICAgXCJwYXJ0XCI6IFwicHQuXCIsXG4gICAgICAgIFwicnVsZVwiOiBcInIuXCIsXG4gICAgICAgIFwic2VjdGlvblwiOiBcInNlYy5cIixcbiAgICAgICAgXCJzdWJzZWN0aW9uXCI6IFwic3Vic2VjLlwiLFxuICAgICAgICBcInNjaGVkdWxlXCI6IFwic2NoLlwiLFxuICAgICAgICBcInRpdGxlXCI6IFwidGl0LlwiLFxuICAgICAgICBcImNvbHVtblwiOiBcImNvbC5cIixcbiAgICAgICAgXCJmaWd1cmVcIjogXCJmaWcuXCIsXG4gICAgICAgIFwiZm9saW9cIjogXCJmb2wuXCIsXG4gICAgICAgIFwibGluZVwiOiBcImwuXCIsXG4gICAgICAgIFwibm90ZVwiOiBcIm4uXCIsXG4gICAgICAgIFwiaXNzdWVcIjogXCJuby5cIixcbiAgICAgICAgXCJvcHVzXCI6IFwib3AuXCIsXG4gICAgICAgIFwic3ViLXZlcmJvXCI6IFwic3YuXCIsXG4gICAgICAgIFwic3ViIHZlcmJvXCI6IFwic3YuXCIsXG4gICAgICAgIFwidmVyc2VcIjogXCJ2cnMuXCIsXG4gICAgICAgIFwidm9sdW1lXCI6IFwidm9sLlwiXG4gICAgfSxcbiAgICBMT0NBVE9SX0xBQkVMU19NQVA6IHtcbiAgICAgICAgXCJhcnRcIjogXCJhcnRpY2xlXCIsXG4gICAgICAgIFwiYmtcIjogXCJib29rXCIsXG4gICAgICAgIFwiY2hcIjogXCJjaGFwdGVyXCIsXG4gICAgICAgIFwic3ViY2hcIjogXCJzdWJjaGFwdGVyXCIsXG4gICAgICAgIFwiY29sXCI6IFwiY29sdW1uXCIsXG4gICAgICAgIFwiZmlnXCI6IFwiZmlndXJlXCIsXG4gICAgICAgIFwiZm9sXCI6IFwiZm9saW9cIixcbiAgICAgICAgXCJsXCI6IFwibGluZVwiLFxuICAgICAgICBcIm5cIjogXCJub3RlXCIsXG4gICAgICAgIFwibm9cIjogXCJpc3N1ZVwiLFxuICAgICAgICBcIm9wXCI6IFwib3B1c1wiLFxuICAgICAgICBcInBcIjogXCJwYWdlXCIsXG4gICAgICAgIFwicHBcIjogXCJwYWdlXCIsXG4gICAgICAgIFwicGFyYVwiOiBcInBhcmFncmFwaFwiLFxuICAgICAgICBcInN1YnBhcmFcIjogXCJzdWJwYXJhZ3JhcGhcIixcbiAgICAgICAgXCJwdFwiOiBcInBhcnRcIixcbiAgICAgICAgXCJyXCI6IFwicnVsZVwiLFxuXHRcdFwic2VjXCI6IFwic2VjdGlvblwiLFxuXHRcdFwic3Vic2VjXCI6IFwic3Vic2VjdGlvblwiLFxuXHRcdFwic3ZcIjogXCJzdWItdmVyYm9cIixcbiAgICAgICAgXCJzY2hcIjogXCJzY2hlZHVsZVwiLFxuICAgICAgICBcInRpdFwiOiBcInRpdGxlXCIsXG4gICAgICAgIFwidnJzXCI6IFwidmVyc2VcIixcbiAgICAgICAgXCJ2b2xcIjogXCJ2b2x1bWVcIlxuICAgIH0sXG4gICAgTU9EVUxFX01BQ1JPUzoge1xuICAgICAgICBcImp1cmlzLXByZXRpdGxlXCI6IHRydWUsXG4gICAgICAgIFwianVyaXMtdGl0bGVcIjogdHJ1ZSxcbiAgICAgICAgXCJqdXJpcy1wcmV0aXRsZS1zaG9ydFwiOiB0cnVlLFxuICAgICAgICBcImp1cmlzLXRpdGxlLXNob3J0XCI6IHRydWUsXG4gICAgICAgIFwianVyaXMtbWFpblwiOiB0cnVlLFxuICAgICAgICBcImp1cmlzLW1haW4tc2hvcnRcIjogdHJ1ZSxcbiAgICAgICAgXCJqdXJpcy10YWlsXCI6IHRydWUsXG4gICAgICAgIFwianVyaXMtdGFpbC1zaG9ydFwiOiB0cnVlLFxuICAgICAgICBcImp1cmlzLWxvY2F0b3JcIjogdHJ1ZVxuICAgIH0sXG4gICAgTU9EVUxFX1RZUEVTOiB7XG4gICAgICAgIFwibGVnYWxfY2FzZVwiOiB0cnVlLFxuICAgICAgICBcImxlZ2lzbGF0aW9uXCI6IHRydWUsXG4gICAgICAgIFwiYmlsbFwiOiB0cnVlLFxuICAgICAgICBcImhlYXJpbmdcIjogdHJ1ZSxcbiAgICAgICAgXCJnYXpldHRlXCI6IHRydWUsXG4gICAgICAgIFwicmVwb3J0XCI6IHRydWUsXG4gICAgICAgIFwicmVndWxhdGlvblwiOiB0cnVlLFxuICAgICAgICBcInN0YW5kYXJkXCI6IHRydWVcbiAgICB9LFxuICAgIE5lc3RlZEJyYWNlczogW1xuICAgICAgICBbXCIoXCIsIFwiW1wiXSxcbiAgICAgICAgW1wiKVwiLCBcIl1cIl1cbiAgICBdLFxuICAgIGNoZWNrTmVzdGVkQnJhY2U6IGZ1bmN0aW9uKHN0YXRlKSB7XG4gICAgICAgIGlmIChzdGF0ZS5vcHQueGNsYXNzID09PSBcIm5vdGVcIikge1xuICAgICAgICAgICAgdGhpcy5kZXB0aCA9IDA7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSA9IGZ1bmN0aW9uKHN0cikge1xuICAgICAgICAgICAgICAgIHZhciBzdHIgPSBzdHIgPyBzdHIgOiAnJztcbiAgICAgICAgICAgICAgICB2YXIgbHN0ID0gc3RyLnNwbGl0KC8oW1xcKFxcKV0pLyk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaT0xLGlsZW49bHN0Lmxlbmd0aDtpPGlsZW47aSArPSAyKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsc3RbaV0gPT09ICcoJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDEgPT09ICh0aGlzLmRlcHRoICUgMikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsc3RbaV0gPSAnWydcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVwdGggKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChsc3RbaV0gPT09ICcpJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDAgPT09ICh0aGlzLmRlcHRoICUgMikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsc3RbaV0gPSAnXSdcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVwdGggLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgcmV0ID0gbHN0LmpvaW4oXCJcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlID0gZnVuY3Rpb24oc3RyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9LFxuICAgIE1VTFRJX0ZJRUxEUzogW1wiZXZlbnRcIiwgXCJwdWJsaXNoZXJcIiwgXCJwdWJsaXNoZXItcGxhY2VcIiwgXCJldmVudC1wbGFjZVwiLCBcInRpdGxlXCIsIFwiY29udGFpbmVyLXRpdGxlXCIsIFwiY29sbGVjdGlvbi10aXRsZVwiLCBcImF1dGhvcml0eVwiLFwiZ2VucmVcIixcInRpdGxlLXNob3J0XCIsXCJtZWRpdW1cIixcImNvdW50cnlcIixcImp1cmlzZGljdGlvblwiLFwiYXJjaGl2ZVwiLFwiYXJjaGl2ZS1wbGFjZVwiXSxcbiAgICBMYW5nUHJlZnNNYXA6IHtcbiAgICAgICAgXCJ0aXRsZVwiOlwidGl0bGVzXCIsXG4gICAgICAgIFwidGl0bGUtc2hvcnRcIjpcInRpdGxlc1wiLFxuICAgICAgICBcImV2ZW50XCI6XCJ0aXRsZXNcIixcbiAgICAgICAgXCJnZW5yZVwiOlwidGl0bGVzXCIsXG4gICAgICAgIFwibWVkaXVtXCI6XCJ0aXRsZXNcIixcbiAgICAgICAgXCJjb250YWluZXItdGl0bGVcIjpcImpvdXJuYWxzXCIsXG4gICAgICAgIFwiY29sbGVjdGlvbi10aXRsZVwiOlwiam91cm5hbHNcIixcbiAgICAgICAgXCJhcmNoaXZlXCI6XCJqb3VybmFsc1wiLFxuICAgICAgICBcInB1Ymxpc2hlclwiOlwicHVibGlzaGVyc1wiLFxuICAgICAgICBcImF1dGhvcml0eVwiOlwicHVibGlzaGVyc1wiLFxuICAgICAgICBcInB1Ymxpc2hlci1wbGFjZVwiOiBcInBsYWNlc1wiLFxuICAgICAgICBcImV2ZW50LXBsYWNlXCI6IFwicGxhY2VzXCIsXG4gICAgICAgIFwiYXJjaGl2ZS1wbGFjZVwiOiBcInBsYWNlc1wiLFxuICAgICAgICBcImp1cmlzZGljdGlvblwiOiBcInBsYWNlc1wiLFxuICAgICAgICBcIm51bWJlclwiOiBcIm51bWJlclwiLFxuICAgICAgICBcImVkaXRpb25cIjpcIm51bWJlclwiLFxuICAgICAgICBcImlzc3VlXCI6XCJudW1iZXJcIixcbiAgICAgICAgXCJ2b2x1bWVcIjpcIm51bWJlclwiXG4gICAgfSxcbiAgICBBYmJyZXZpYXRpb25TZWdtZW50czogZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzW1wiY29udGFpbmVyLXRpdGxlXCJdID0ge307XG4gICAgICAgIHRoaXNbXCJjb2xsZWN0aW9uLXRpdGxlXCJdID0ge307XG4gICAgICAgIHRoaXNbXCJpbnN0aXR1dGlvbi1lbnRpcmVcIl0gPSB7fTtcbiAgICAgICAgdGhpc1tcImluc3RpdHV0aW9uLXBhcnRcIl0gPSB7fTtcbiAgICAgICAgdGhpcy5uaWNrbmFtZSA9IHt9O1xuICAgICAgICB0aGlzLm51bWJlciA9IHt9O1xuICAgICAgICB0aGlzLnRpdGxlID0ge307XG4gICAgICAgIHRoaXMucGxhY2UgPSB7fTtcbiAgICAgICAgdGhpcy5oZXJlaW5hZnRlciA9IHt9O1xuICAgICAgICB0aGlzLmNsYXNzaWMgPSB7fTtcbiAgICAgICAgdGhpc1tcImNvbnRhaW5lci1waHJhc2VcIl0gPSB7fTtcbiAgICAgICAgdGhpc1tcInRpdGxlLXBocmFzZVwiXSA9IHt9O1xuICAgIH0sXG4gICAgRklFTERfQ0FURUdPUllfUkVNQVA6IHtcbiAgICAgICAgXCJ0aXRsZVwiOiBcInRpdGxlXCIsXG4gICAgICAgIFwiY29udGFpbmVyLXRpdGxlXCI6IFwiY29udGFpbmVyLXRpdGxlXCIsXG4gICAgICAgIFwiY29sbGVjdGlvbi10aXRsZVwiOiBcImNvbGxlY3Rpb24tdGl0bGVcIixcbiAgICAgICAgXCJjb3VudHJ5XCI6IFwicGxhY2VcIixcbiAgICAgICAgXCJudW1iZXJcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJwbGFjZVwiOiBcInBsYWNlXCIsXG4gICAgICAgIFwiYXJjaGl2ZVwiOiBcImNvbGxlY3Rpb24tdGl0bGVcIixcbiAgICAgICAgXCJ0aXRsZS1zaG9ydFwiOiBcInRpdGxlXCIsXG4gICAgICAgIFwiZ2VucmVcIjogXCJ0aXRsZVwiLFxuICAgICAgICBcImV2ZW50XCI6IFwidGl0bGVcIixcbiAgICAgICAgXCJtZWRpdW1cIjogXCJ0aXRsZVwiLFxuXHRcdFwiYXJjaGl2ZS1wbGFjZVwiOiBcInBsYWNlXCIsXG5cdFx0XCJwdWJsaXNoZXItcGxhY2VcIjogXCJwbGFjZVwiLFxuXHRcdFwiZXZlbnQtcGxhY2VcIjogXCJwbGFjZVwiLFxuXHRcdFwianVyaXNkaWN0aW9uXCI6IFwicGxhY2VcIixcblx0XHRcImxhbmd1YWdlLW5hbWVcIjogXCJwbGFjZVwiLFxuXHRcdFwibGFuZ3VhZ2UtbmFtZS1vcmlnaW5hbFwiOiBcInBsYWNlXCIsXG4gICAgICAgIFwiY2FsbC1udW1iZXJcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJjaGFwdGVyLW51bWJlclwiOiBcIm51bWJlclwiLFxuICAgICAgICBcImNvbGxlY3Rpb24tbnVtYmVyXCI6IFwibnVtYmVyXCIsXG4gICAgICAgIFwiZWRpdGlvblwiOiBcIm51bWJlclwiLFxuICAgICAgICBcInBhZ2VcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJpc3N1ZVwiOiBcIm51bWJlclwiLFxuICAgICAgICBcImxvY2F0b3JcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJudW1iZXItb2YtcGFnZXNcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJudW1iZXItb2Ytdm9sdW1lc1wiOiBcIm51bWJlclwiLFxuICAgICAgICBcInZvbHVtZVwiOiBcIm51bWJlclwiLFxuICAgICAgICBcImNpdGF0aW9uLW51bWJlclwiOiBcIm51bWJlclwiLFxuICAgICAgICBcInB1Ymxpc2hlclwiOiBcImluc3RpdHV0aW9uLXBhcnRcIlxuICAgIH0sXG4gICAgcGFyc2VMb2NhdG9yOiBmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmxvY2F0b3JfZGF0ZV9hbmRfcmV2aXNpb24pIHtcbiAgICAgICAgICAgIGlmIChpdGVtLmxvY2F0b3IpIHtcbiAgICAgICAgICAgICAgICBpdGVtLmxvY2F0b3IgPSBcIlwiICsgaXRlbS5sb2NhdG9yO1xuICAgICAgICAgICAgICAgIHZhciBpZHggPSBpdGVtLmxvY2F0b3IuaW5kZXhPZihcInxcIik7XG4gICAgICAgICAgICAgICAgaWYgKGlkeCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByYXdfbG9jYXRvciA9IGl0ZW0ubG9jYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gcmF3X2xvY2F0b3Iuc2xpY2UoMCwgaWR4KTtcbiAgICAgICAgICAgICAgICAgICAgcmF3X2xvY2F0b3IgPSByYXdfbG9jYXRvci5zbGljZShpZHggKyAxKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG0gPSByYXdfbG9jYXRvci5tYXRjaCgvXihbMC05XXs0fS1bMC05XXsyfS1bMC05XXsyfSkuKi8pO1xuICAgICAgICAgICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVtcImxvY2F0b3ItZGF0ZVwiXSA9IHRoaXMuZnVuLmRhdGVwYXJzZXIucGFyc2VEYXRlVG9PYmplY3QobVsxXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByYXdfbG9jYXRvciA9IHJhd19sb2NhdG9yLnNsaWNlKG1bMV0ubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpdGVtW1wibG9jYXRvci1leHRyYVwiXSA9IHJhd19sb2NhdG9yLnJlcGxhY2UoL15cXHMrLywgXCJcIikucmVwbGFjZSgvXFxzKyQvLCBcIlwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGl0ZW0ubG9jYXRvcikge1xuICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gKFwiXCIgKyBpdGVtLmxvY2F0b3IpLnJlcGxhY2UoL1xccyskLywgJycpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgIH0sXG4gICAgbm9ybWFsaXplTG9jYWxlU3RyOiBmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgaWYgKCFzdHIpIHJldHVybjtcbiAgICAgICAgdmFyIGxzdCA9IHN0ci5zcGxpdCgnLScpO1xuICAgICAgICBsc3RbMF0gPSBsc3RbMF0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKGxzdFsxXSkge1xuICAgICAgICAgICAgbHN0WzFdID0gbHN0WzFdLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxzdC5qb2luKFwiLVwiKTtcbiAgICB9LFxuICAgIGlzRGF0ZVBhcnQ6IGZ1bmN0aW9uKHN0ciwgbGVzcywgbW9yZSkge1xuICAgICAgICBpZiAoc3RyLmxlbmd0aCA+IGxlc3MgJiYgc3RyLmxlbmd0aCA8IG1vcmUgJiYgcGFyc2VJbnQoc3RyKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgaXNEYXRlU3RyaW5nOiBmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgaWYgKCFzdHIpIHJldHVybiBmYWxzZTtcbiAgICAgICAgdmFyIHN0ckxzdCA9IHN0ci5zcGxpdChcIi1cIik7XG4gICAgICAgIGlmIChzdHJMc3QubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgaWYgKCFpc0RhdGVQYXJ0KHN0ckxzdFswXSwgMywgNSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0ckxzdC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICBpZiAoIWlzRGF0ZVBhcnQoc3RyTHN0WzFdLCAwLCAzKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChzdHJMc3QubGVuZ3RoID4gMikge1xuICAgICAgICAgICAgaWYgKCFpc0RhdGVQYXJ0KHN0ckxzdFsyXSwgMCwgMykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RyTHN0Lmxlbmd0aCA+IDMpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9LFxuICAgIHBhcnNlTm90ZUZpZWxkSGFja3M6IGZ1bmN0aW9uKEl0ZW0sIHZhbGlkRmllbGRzRm9yVHlwZSwgYWxsb3dEYXRlT3ZlcnJpZGUpIHtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgIT09IHR5cGVvZiBJdGVtLm5vdGUpIHJldHVybjtcbiAgICAgICAgdmFyIGVsZW1zID0gW107XG4gICAgICAgIHZhciBsaW5lcyA9IEl0ZW0ubm90ZS5zcGxpdCgnXFxuJyk7XG4gICAgICAgIHZhciBsYXN0bGluZSA9IFwiXCI7XG4gICAgICAgIGZvciAodmFyIGk9MCwgaWxlbj1saW5lcy5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgbGluZSA9IGxpbmVzW2ldO1xuICAgICAgICAgICAgdmFyIGVsZW1zID0gW107XG4gICAgICAgICAgICB2YXIgbSA9IGxpbmUubWF0Y2goQ1NMLk5PVEVfRklFTERTX1JFR0VYUCk7XG4gICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgIHZhciBzcGx0ID0gbGluZS5zcGxpdChDU0wuTk9URV9GSUVMRFNfUkVHRVhQKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqPTAsamxlbj0oc3BsdC5sZW5ndGgtMSk7ajxqbGVuO2orKykge1xuICAgICAgICAgICAgICAgICAgICBlbGVtcy5wdXNoKHNwbHRbal0pO1xuICAgICAgICAgICAgICAgICAgICBlbGVtcy5wdXNoKG1bal0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbGVtcy5wdXNoKHNwbHRbc3BsdC5sZW5ndGgtMV0pXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaj0xLGpsZW49ZWxlbXMubGVuZ3RoO2o8amxlbjtqICs9IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1zW2otMV0udHJpbSgpICYmIChpPjAgfHwgaj4xKSAmJiAhZWxlbXNbai0xXS5tYXRjaChDU0wuTk9URV9GSUVMRF9SRUdFWFApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbXNbal0gPSAnXFxuJyArIGVsZW1zW2pdLnNsaWNlKDIsLTEpLnRyaW0oKSArICdcXG4nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxpbmVzW2ldID0gZWxlbXMuam9pbignJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGluZXMgPSBsaW5lcy5qb2luKCdcXG4nKS5zcGxpdCgnXFxuJyk7XG4gICAgICAgIHZhciBvZmZzZXQgPSAwO1xuICAgICAgICB2YXIgbmFtZXMgPSB7fTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bGluZXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIHZhciBsaW5lID0gbGluZXNbaV07XG4gICAgICAgICAgICB2YXIgbW0gPSBsaW5lLm1hdGNoKENTTC5OT1RFX0ZJRUxEX1JFR0VYUCk7XG4gICAgICAgICAgICBpZiAoIWxpbmUudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFtbSkge1xuICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IGk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBrZXkgPSBtbVsxXTtcbiAgICAgICAgICAgIHZhciB2YWwgPSBtbVsyXS5yZXBsYWNlKC9eXFxzKy8sIFwiXCIpLnJlcGxhY2UoL1xccyskLywgXCJcIik7XG4gICAgICAgICAgICBpZiAoa2V5ID09PSBcInR5cGVcIikge1xuICAgICAgICAgICAgICAgIEl0ZW0udHlwZSA9IHZhbDtcbiAgICAgICAgICAgICAgICBsaW5lc1tpXSA9IFwiXCI7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKENTTC5EQVRFX1ZBUklBQkxFUy5pbmRleE9mKGtleSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIGlmIChhbGxvd0RhdGVPdmVycmlkZSkge1xuICAgICAgICAgICAgICAgICAgICBJdGVtW2tleV0gPSB7cmF3OiB2YWx9O1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkRmllbGRzRm9yVHlwZSB8fCAodmFsaWRGaWVsZHNGb3JUeXBlW2tleV0gJiYgaXNEYXRlU3RyaW5nKHZhbCkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lc1tpXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFJdGVtW2tleV0pIHtcbiAgICAgICAgICAgICAgICBpZiAoQ1NMLk5BTUVfVkFSSUFCTEVTLmluZGV4T2Yoa2V5KSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghbmFtZXNba2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXNba2V5XSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBsc3QgPSB2YWwuc3BsaXQoL1xccypcXHxcXHxcXHMqLyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsc3QubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lc1trZXldLnB1c2goe2xpdGVyYWw6bHN0WzBdfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobHN0Lmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSB7ZmFtaWx5OmxzdFswXSxnaXZlbjpsc3RbMV19O1xuICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLnBhcnNlUGFydGljbGVzKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXNba2V5XS5wdXNoKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgSXRlbVtrZXldID0gdmFsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXZhbGlkRmllbGRzRm9yVHlwZSB8fCB2YWxpZEZpZWxkc0ZvclR5cGVba2V5XSkge1xuICAgICAgICAgICAgICAgICAgICBsaW5lc1tpXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lcykge1xuICAgICAgICAgICAgSXRlbVtrZXldID0gbmFtZXNba2V5XTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmFsaWRGaWVsZHNGb3JUeXBlKSB7XG4gICAgICAgICAgICBpZiAobGluZXNbb2Zmc2V0XS50cmltKCkpIHtcbiAgICAgICAgICAgICAgICBsaW5lc1tvZmZzZXRdID0gJ1xcbicgKyBsaW5lc1tvZmZzZXRdXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKHZhciBpPW9mZnNldC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFsaW5lc1tpXS50cmltKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgbGluZXMgPSBsaW5lcy5zbGljZSgwLCBpKS5jb25jYXQobGluZXMuc2xpY2UoaSArIDEpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgSXRlbS5ub3RlID0gbGluZXMuam9pbihcIlxcblwiKS50cmltKCk7XG4gICAgfSxcbiAgICBHRU5ERVJTOiBbXCJtYXNjdWxpbmVcIiwgXCJmZW1pbmluZVwiXSxcbiAgICBFUlJPUl9OT19SRU5ERVJFRF9GT1JNOiAxLFxuICAgIFBSRVZJRVc6IFwiSnVzdCBmb3IgbGF1Z2hzLlwiLFxuICAgIEFTU1VNRV9BTExfSVRFTVNfUkVHSVNURVJFRDogMixcbiAgICBTVEFSVDogMCxcbiAgICBFTkQ6IDEsXG4gICAgU0lOR0xFVE9OOiAyLFxuICAgIFNFRU46IDYsXG4gICAgU1VDQ0VTU09SOiAzLFxuICAgIFNVQ0NFU1NPUl9PRl9TVUNDRVNTT1I6IDQsXG4gICAgU1VQUFJFU1M6IDUsXG4gICAgU0lOR1VMQVI6IDAsXG4gICAgUExVUkFMOiAxLFxuICAgIExJVEVSQUw6IHRydWUsXG4gICAgQkVGT1JFOiAxLFxuICAgIEFGVEVSOiAyLFxuICAgIERFU0NFTkRJTkc6IDEsXG4gICAgQVNDRU5ESU5HOiAyLFxuICAgIE9OTFlfRklSU1Q6IDEsXG4gICAgQUxXQVlTOiAyLFxuICAgIE9OTFlfTEFTVDogMyxcbiAgICBGSU5JU0g6IDEsXG4gICAgUE9TSVRJT05fRklSU1Q6IDAsXG4gICAgUE9TSVRJT05fU1VCU0VRVUVOVDogMSxcbiAgICBQT1NJVElPTl9JQklEOiAyLFxuICAgIFBPU0lUSU9OX0lCSURfV0lUSF9MT0NBVE9SOiAzLFxuICAgIE1BUktfVFJBSUxJTkdfTkFNRVM6IHRydWUsXG4gICAgUE9TSVRJT05fVEVTVF9WQVJTOiBbXCJwb3NpdGlvblwiLCBcImZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlclwiLCBcIm5lYXItbm90ZVwiXSxcbiAgICBBUkVBUzogW1wiY2l0YXRpb25cIiwgXCJjaXRhdGlvbl9zb3J0XCIsIFwiYmlibGlvZ3JhcGh5XCIsIFwiYmlibGlvZ3JhcGh5X3NvcnRcIl0sXG4gICAgQ0lURV9GSUVMRFM6IFtcImZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlclwiLCBcImxvY2F0b3JcIiwgXCJsb2NhdG9yLWV4dHJhXCJdLFxuICAgIE1JTklNQUxfTkFNRV9GSUVMRFM6IFtcImxpdGVyYWxcIiwgXCJmYW1pbHlcIl0sXG4gICAgU1dBUFBJTkdfUFVOQ1RVQVRJT046IFtcIi5cIiwgXCIhXCIsIFwiP1wiLCBcIjpcIiwgXCIsXCJdLFxuICAgIFRFUk1JTkFMX1BVTkNUVUFUSU9OOiBbXCI6XCIsIFwiLlwiLCBcIjtcIiwgXCIhXCIsIFwiP1wiLCBcIiBcIl0sXG4gICAgTk9ORTogMCxcbiAgICBOVU1FUklDOiAxLFxuICAgIFBPU0lUSU9OOiAyLFxuICAgIENPTExBUFNFX1ZBTFVFUzogW1wiY2l0YXRpb24tbnVtYmVyXCIsIFwieWVhclwiLCBcInllYXItc3VmZml4XCJdLFxuICAgIERBVEVfUEFSVFM6IFtcInllYXJcIiwgXCJtb250aFwiLCBcImRheVwiXSxcbiAgICBEQVRFX1BBUlRTX0FMTDogW1wieWVhclwiLCBcIm1vbnRoXCIsIFwiZGF5XCIsIFwic2Vhc29uXCJdLFxuICAgIERBVEVfUEFSVFNfSU5URVJOQUw6IFtcInllYXJcIiwgXCJtb250aFwiLCBcImRheVwiLCBcInllYXJfZW5kXCIsIFwibW9udGhfZW5kXCIsIFwiZGF5X2VuZFwiXSxcbiAgICBOQU1FX1BBUlRTOiBbXCJub24tZHJvcHBpbmctcGFydGljbGVcIiwgXCJmYW1pbHlcIiwgXCJnaXZlblwiLCBcImRyb3BwaW5nLXBhcnRpY2xlXCIsIFwic3VmZml4XCIsIFwibGl0ZXJhbFwiXSxcbiAgICBERUNPUkFCTEVfTkFNRV9QQVJUUzogW1wiZ2l2ZW5cIiwgXCJmYW1pbHlcIiwgXCJzdWZmaXhcIl0sXG4gICAgRElTQU1CSUdVQVRFX09QVElPTlM6IFtcbiAgICAgICAgXCJkaXNhbWJpZ3VhdGUtYWRkLW5hbWVzXCIsXG4gICAgICAgIFwiZGlzYW1iaWd1YXRlLWFkZC1naXZlbm5hbWVcIixcbiAgICAgICAgXCJkaXNhbWJpZ3VhdGUtYWRkLXllYXItc3VmZml4XCJcbiAgICBdLFxuICAgIEdJVkVOTkFNRV9ESVNBTUJJR1VBVElPTl9SVUxFUzogW1xuICAgICAgICBcImFsbC1uYW1lc1wiLFxuICAgICAgICBcImFsbC1uYW1lcy13aXRoLWluaXRpYWxzXCIsXG4gICAgICAgIFwicHJpbWFyeS1uYW1lXCIsXG4gICAgICAgIFwicHJpbWFyeS1uYW1lLXdpdGgtaW5pdGlhbHNcIixcbiAgICAgICAgXCJieS1jaXRlXCJcbiAgICBdLFxuICAgIE5BTUVfQVRUUklCVVRFUzogW1xuICAgICAgICBcImFuZFwiLFxuICAgICAgICBcImRlbGltaXRlci1wcmVjZWRlcy1sYXN0XCIsXG4gICAgICAgIFwiZGVsaW1pdGVyLXByZWNlZGVzLWV0LWFsXCIsXG4gICAgICAgIFwiaW5pdGlhbGl6ZS13aXRoXCIsXG4gICAgICAgIFwiaW5pdGlhbGl6ZVwiLFxuICAgICAgICBcIm5hbWUtYXMtc29ydC1vcmRlclwiLFxuICAgICAgICBcInNvcnQtc2VwYXJhdG9yXCIsXG4gICAgICAgIFwiZXQtYWwtbWluXCIsXG4gICAgICAgIFwiZXQtYWwtdXNlLWZpcnN0XCIsXG4gICAgICAgIFwiZXQtYWwtc3Vic2VxdWVudC1taW5cIixcbiAgICAgICAgXCJldC1hbC1zdWJzZXF1ZW50LXVzZS1maXJzdFwiLFxuICAgICAgICBcImZvcm1cIixcbiAgICAgICAgXCJwcmVmaXhcIixcbiAgICAgICAgXCJzdWZmaXhcIixcbiAgICAgICAgXCJkZWxpbWl0ZXJcIlxuICAgIF0sXG4gICAgUEFSQUxMRUxfTUFUQ0hfVkFSUzogW1wiY29udGFpbmVyLXRpdGxlXCJdLFxuICAgIFBBUkFMTEVMX1RZUEVTOiBbXCJiaWxsXCIsXCJnYXpldHRlXCIsXCJyZWd1bGF0aW9uXCIsXCJsZWdpc2xhdGlvblwiLFwibGVnYWxfY2FzZVwiLFwidHJlYXR5XCIsXCJhcnRpY2xlLW1hZ2F6aW5lXCIsXCJhcnRpY2xlLWpvdXJuYWxcIl0sXG4gICAgUEFSQUxMRUxfQ09MTEFQU0lOR19NSURfVkFSU0VUOiBbXCJ2b2x1bWVcIiwgXCJpc3N1ZVwiLCBcImNvbnRhaW5lci10aXRsZVwiLCBcInNlY3Rpb25cIiwgXCJjb2xsZWN0aW9uLW51bWJlclwiXSxcbiAgICBMT09TRTogMCxcbiAgICBTVFJJQ1Q6IDEsXG4gICAgVE9MRVJBTlQ6IDIsXG4gICAgUFJFRklYX1BVTkNUVUFUSU9OOiAvWy47Ol1cXHMqJC8sXG4gICAgU1VGRklYX1BVTkNUVUFUSU9OOiAvXlxccypbLjs6LFxcKFxcKV0vLFxuICAgIE5VTUJFUl9SRUdFWFA6IC8oPzpeXFxkK3xcXGQrJCkvLFxuICAgIE5BTUVfSU5JVElBTF9SRUdFWFA6IC9eKFtBLVpcXHUwMGMwLVxcdTAxN2ZcXHUwNDAwLVxcdTA0MmZcXHUwNTkwLVxcdTA1ZDRcXHUwNWQ2LVxcdTA1ZmZcXHUwNjAwLVxcdTA2ZmZcXHUwMzcwXFx1MDM3MlxcdTAzNzZcXHUwMzg2XFx1MDM4OC1cXHUwM2FiXFx1MDNlMlxcdTAzZTRcXHUwM2U2XFx1MDNlOFxcdTAzZWFcXHUwM2VjXFx1MDNlZVxcdTAzZjRcXHUwM2Y3XFx1MDNmZC1cXHUwM2ZmXSkoW2EtekEtWlxcdTAwYzAtXFx1MDE3ZlxcdTA0MDAtXFx1MDUyZlxcdTA2MDAtXFx1MDZmZlxcdTAzNzAtXFx1MDNmZlxcdTFmMDAtXFx1MWZmZl0qfCkvLFxuICAgIFJPTUFORVNRVUVfUkVHRVhQOiAvWy0wLTlhLXpBLVpcXHUwMGMwLVxcdTAxN2ZcXHUwMzcwLVxcdTAzZmZcXHUwNDAwLVxcdTA1MmZcXHUwNTkwLVxcdTA1ZDRcXHUwNWQ2LVxcdTA1ZmZcXHUxZjAwLVxcdTFmZmZcXHUwNjAwLVxcdTA2ZmZcXHUyMDBjXFx1MjAwZFxcdTIwMGVcXHUwMjE4XFx1MDIxOVxcdTAyMWFcXHUwMjFiXFx1MjAyYS1cXHUyMDJlXS8sXG4gICAgUk9NQU5FU1FVRV9OT1RfUkVHRVhQOiAvW15hLXpBLVpcXHUwMGMwLVxcdTAxN2ZcXHUwMzcwLVxcdTAzZmZcXHUwNDAwLVxcdTA1MmZcXHUwNTkwLVxcdTA1ZDRcXHUwNWQ2LVxcdTA1ZmZcXHUxZjAwLVxcdTFmZmZcXHUwNjAwLVxcdTA2ZmZcXHUyMDBjXFx1MjAwZFxcdTIwMGVcXHUwMjE4XFx1MDIxOVxcdTAyMWFcXHUwMjFiXFx1MjAyYS1cXHUyMDJlXS9nLFxuICAgIFNUQVJUU1dJVEhfUk9NQU5FU1FVRV9SRUdFWFA6IC9eWyZhLXpBLVpcXHUwMGMwLVxcdTAxN2ZcXHUwMzcwLVxcdTAzZmZcXHUwNDAwLVxcdTA1MmZcXHUwNTkwLVxcdTA1ZDRcXHUwNWQ2LVxcdTA1ZmZcXHUxZjAwLVxcdTFmZmZcXHUwNjAwLVxcdTA2ZmZcXHUyMDBjXFx1MjAwZFxcdTIwMGVcXHUwMjE4XFx1MDIxOVxcdTAyMWFcXHUwMjFiXFx1MjAyYS1cXHUyMDJlXS8sXG4gICAgRU5EU1dJVEhfUk9NQU5FU1FVRV9SRUdFWFA6IC9bLjs6JmEtekEtWlxcdTAwYzAtXFx1MDE3ZlxcdTAzNzAtXFx1MDNmZlxcdTA0MDAtXFx1MDUyZlxcdTA1OTAtXFx1MDVkNFxcdTA1ZDYtXFx1MDVmZlxcdTFmMDAtXFx1MWZmZlxcdTA2MDAtXFx1MDZmZlxcdTIwMGNcXHUyMDBkXFx1MjAwZVxcdTAyMThcXHUwMjE5XFx1MDIxYVxcdTAyMWJcXHUyMDJhLVxcdTIwMmVdJC8sXG4gICAgQUxMX1JPTUFORVNRVUVfUkVHRVhQOiAvXlthLXpBLVpcXHUwMGMwLVxcdTAxN2ZcXHUwMzcwLVxcdTAzZmZcXHUwNDAwLVxcdTA1MmZcXHUwNTkwLVxcdTA1ZDRcXHUwNWQ2LVxcdTA1ZmZcXHUxZjAwLVxcdTFmZmZcXHUwNjAwLVxcdTA2ZmZcXHUyMDBjXFx1MjAwZFxcdTIwMGVcXHUwMjE4XFx1MDIxOVxcdTAyMWFcXHUwMjFiXFx1MjAyYS1cXHUyMDJlXSskLyxcbiAgICBWSUVUTkFNRVNFX1NQRUNJQUxTOiAvW1xcdTAwYzAtXFx1MDBjM1xcdTAwYzgtXFx1MDBjYVxcdTAwY2NcXHUwMGNkXFx1MDBkMi1cXHUwMGQ1XFx1MDBkOVxcdTAwZGFcXHUwMGRkXFx1MDBlMC1cXHUwMGUzXFx1MDBlOC1cXHUwMGVhXFx1MDBlY1xcdTAwZWRcXHUwMGYyLVxcdTAwZjVcXHUwMGY5XFx1MDBmYVxcdTAwZmRcXHUwMTAxXFx1MDEwM1xcdTAxMTBcXHUwMTExXFx1MDEyOFxcdTAxMjlcXHUwMTY4XFx1MDE2OVxcdTAxYTBcXHUwMWExXFx1MDFhZlxcdTAxYjBcXHUxZWEwLVxcdTFlZjldLyxcbiAgICBWSUVUTkFNRVNFX05BTUVTOiAvXig/Oig/OlsuQWFCYkNjRGRFZUdnSGhJaUtrTGxNbU5uT29QcFFxUnJTc1R0VXVWdlh4WXkgXFx1MDBjMC1cXHUwMGMzXFx1MDBjOC1cXHUwMGNhXFx1MDBjY1xcdTAwY2RcXHUwMGQyLVxcdTAwZDVcXHUwMGQ5XFx1MDBkYVxcdTAwZGRcXHUwMGUwLVxcdTAwZTNcXHUwMGU4LVxcdTAwZWFcXHUwMGVjXFx1MDBlZFxcdTAwZjItXFx1MDBmNVxcdTAwZjlcXHUwMGZhXFx1MDBmZFxcdTAxMDFcXHUwMTAzXFx1MDExMFxcdTAxMTFcXHUwMTI4XFx1MDEyOVxcdTAxNjhcXHUwMTY5XFx1MDFhMFxcdTAxYTFcXHUwMWFmXFx1MDFiMFxcdTFlYTAtXFx1MWVmOV17Miw2fSkoXFxzK3wkKSkrJC8sXG4gICAgTk9URV9GSUVMRFNfUkVHRVhQOiAvXFx7Oig/OltcXC1fYS16XSt8W0EtWl0rKTpbXlxcfV0rXFx9L2csXG4gICAgTk9URV9GSUVMRF9SRUdFWFA6IC9eKFtcXC1fYS16XSt8W0EtWl0rKTpcXHMqKFteXFx9XSspJC8sXG5cdFBBUlRJQ0xFX0dJVkVOX1JFR0VYUDogL14oW14gXSsoPzpcXHUwMmJiIHxcXHUyMDE5IHwgfFxcJyApICopKC4rKSQvLFxuXHRQQVJUSUNMRV9GQU1JTFlfUkVHRVhQOiAvXihbXiBdKyg/OlxcLXxcXHUwMmJifFxcdTIwMTl8IHxcXCcpICopKC4rKSQvLFxuICAgIERJU1BMQVlfQ0xBU1NFUzogW1wiYmxvY2tcIiwgXCJsZWZ0LW1hcmdpblwiLCBcInJpZ2h0LWlubGluZVwiLCBcImluZGVudFwiXSxcbiAgICBOQU1FX1ZBUklBQkxFUzogW1xuICAgICAgICBcImF1dGhvclwiLFxuICAgICAgICBcImVkaXRvclwiLFxuICAgICAgICBcInRyYW5zbGF0b3JcIixcbiAgICAgICAgXCJjb250cmlidXRvclwiLFxuICAgICAgICBcImNvbGxlY3Rpb24tZWRpdG9yXCIsXG4gICAgICAgIFwiY29tcG9zZXJcIixcbiAgICAgICAgXCJjb250YWluZXItYXV0aG9yXCIsXG4gICAgICAgIFwiZGlyZWN0b3JcIixcbiAgICAgICAgXCJlZGl0b3JpYWwtZGlyZWN0b3JcIixcbiAgICAgICAgXCJpbnRlcnZpZXdlclwiLFxuICAgICAgICBcIm9yaWdpbmFsLWF1dGhvclwiLFxuICAgICAgICBcInJlY2lwaWVudFwiXG4gICAgXSxcbiAgICBOVU1FUklDX1ZBUklBQkxFUzogW1xuICAgICAgICBcImNhbGwtbnVtYmVyXCIsXG4gICAgICAgIFwiY2hhcHRlci1udW1iZXJcIixcbiAgICAgICAgXCJjb2xsZWN0aW9uLW51bWJlclwiLFxuICAgICAgICBcImVkaXRpb25cIixcbiAgICAgICAgXCJwYWdlXCIsXG4gICAgICAgIFwiaXNzdWVcIixcbiAgICAgICAgXCJsb2NhdG9yXCIsXG4gICAgICAgIFwibnVtYmVyXCIsXG4gICAgICAgIFwibnVtYmVyLW9mLXBhZ2VzXCIsXG4gICAgICAgIFwibnVtYmVyLW9mLXZvbHVtZXNcIixcbiAgICAgICAgXCJ2b2x1bWVcIixcbiAgICAgICAgXCJjaXRhdGlvbi1udW1iZXJcIlxuICAgIF0sXG4gICAgREFURV9WQVJJQUJMRVM6IFtcbiAgICAgICAgXCJsb2NhdG9yLWRhdGVcIiwgXG4gICAgICAgIFwiaXNzdWVkXCIsIFxuICAgICAgICBcImV2ZW50LWRhdGVcIiwgXG4gICAgICAgIFwiYWNjZXNzZWRcIiwgXG4gICAgICAgIFwiY29udGFpbmVyXCIsIFxuICAgICAgICBcIm9yaWdpbmFsLWRhdGVcIixcbiAgICAgICAgXCJwdWJsaWNhdGlvbi1kYXRlXCIsXG4gICAgICAgIFwib3JpZ2luYWwtZGF0ZVwiLFxuICAgICAgICBcImF2YWlsYWJsZS1kYXRlXCIsXG4gICAgICAgIFwic3VibWl0dGVkXCJcbiAgICBdLFxuICAgIFRJVExFX0ZJRUxEX1NQTElUUzogZnVuY3Rpb24oc2VnKSB7XG4gICAgICAgIHZhciBrZXlzID0gW1widGl0bGVcIiwgXCJzaG9ydFwiLCBcIm1haW5cIiwgXCJzdWJcIl07XG4gICAgICAgIHZhciByZXQgPSB7fTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49a2V5cy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgcmV0W2tleXNbaV1dID0gc2VnICsgXCJ0aXRsZVwiICsgKGtleXNbaV0gPT09IFwidGl0bGVcIiA/IFwiXCIgOiBcIi1cIiArIGtleXNbaV0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfSxcbiAgICBUQUdfVVNFQUxMOiBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIHZhciByZXQsIG9wZW4sIGNsb3NlLCBlbmQ7XG4gICAgICAgIHJldCA9IFtcIlwiXTtcbiAgICAgICAgb3BlbiA9IHN0ci5pbmRleE9mKFwiPFwiKTtcbiAgICAgICAgY2xvc2UgPSBzdHIuaW5kZXhPZihcIj5cIik7XG4gICAgICAgIHdoaWxlIChvcGVuID4gLTEgJiYgY2xvc2UgPiAtMSkge1xuICAgICAgICAgICAgaWYgKG9wZW4gPiBjbG9zZSkge1xuICAgICAgICAgICAgICAgIGVuZCA9IG9wZW4gKyAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBlbmQgPSBjbG9zZSArIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3BlbiA8IGNsb3NlICYmIHN0ci5zbGljZShvcGVuICsgMSwgY2xvc2UpLmluZGV4T2YoXCI8XCIpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIHJldFtyZXQubGVuZ3RoIC0gMV0gKz0gc3RyLnNsaWNlKDAsIG9wZW4pO1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKHN0ci5zbGljZShvcGVuLCBjbG9zZSArIDEpKTtcbiAgICAgICAgICAgICAgICByZXQucHVzaChcIlwiKTtcbiAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoZW5kKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0W3JldC5sZW5ndGggLSAxXSArPSBzdHIuc2xpY2UoMCwgY2xvc2UgKyAxKTtcbiAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoZW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9wZW4gPSBzdHIuaW5kZXhPZihcIjxcIik7XG4gICAgICAgICAgICBjbG9zZSA9IHN0ci5pbmRleE9mKFwiPlwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXRbcmV0Lmxlbmd0aCAtIDFdICs9IHN0cjtcbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9LFxuICAgIGRlbW90ZU5vaXNlV29yZHM6IGZ1bmN0aW9uIChzdGF0ZSwgZmxkLCBkcm9wX29yX2RlbW90ZSkge1xuICAgICAgICB2YXIgU0tJUF9XT1JEUyA9IHN0YXRlLmxvY2FsZVtzdGF0ZS5vcHQubGFuZ10ub3B0c1tcImxlYWRpbmctbm9pc2Utd29yZHNcIl07XG4gICAgICAgIGlmIChmbGQgJiYgZHJvcF9vcl9kZW1vdGUpIHtcbiAgICAgICAgICAgIGZsZCA9IGZsZC5zcGxpdCgvXFxzKy8pO1xuICAgICAgICAgICAgZmxkLnJldmVyc2UoKTtcbiAgICAgICAgICAgIHZhciB0b0VuZCA9IFtdO1xuICAgICAgICAgICAgZm9yICh2YXIgaiAgPSBmbGQubGVuZ3RoIC0gMTsgaiA+IC0xOyBqICs9IC0xKSB7XG4gICAgICAgICAgICAgICAgaWYgKFNLSVBfV09SRFMuaW5kZXhPZihmbGRbal0udG9Mb3dlckNhc2UoKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICB0b0VuZC5wdXNoKGZsZC5wb3AoKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZmxkLnJldmVyc2UoKTtcbiAgICAgICAgICAgIHZhciBzdGFydCA9IGZsZC5qb2luKFwiIFwiKTtcbiAgICAgICAgICAgIHZhciBlbmQgPSB0b0VuZC5qb2luKFwiIFwiKTtcbiAgICAgICAgICAgIGlmIChcImRyb3BcIiA9PT0gZHJvcF9vcl9kZW1vdGUgfHwgIWVuZCkge1xuICAgICAgICAgICAgICAgIGZsZCA9IHN0YXJ0O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChcImRlbW90ZVwiID09PSBkcm9wX29yX2RlbW90ZSkge1xuICAgICAgICAgICAgICAgIGZsZCA9IFtzdGFydCwgZW5kXS5qb2luKFwiLCBcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZsZDtcbiAgICB9LFxuICAgIGV4dHJhY3RUaXRsZUFuZFN1YnRpdGxlOiBmdW5jdGlvbiAoSXRlbSkge1xuICAgICAgICB2YXIgc2VnbWVudHMgPSBbXCJcIiwgXCJjb250YWluZXItXCJdO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1zZWdtZW50cy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgdmFyIHNlZyA9IHNlZ21lbnRzW2ldO1xuICAgICAgICAgICAgdmFyIHRpdGxlID0gQ1NMLlRJVExFX0ZJRUxEX1NQTElUUyhzZWcpO1xuICAgICAgICAgICAgdmFyIGxhbmdzID0gW2ZhbHNlXTtcbiAgICAgICAgICAgIGlmIChJdGVtLm11bHRpKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgbGFuZyBpbiBJdGVtLm11bHRpLl9rZXlzW3RpdGxlLnNob3J0XSkge1xuICAgICAgICAgICAgICAgICAgICBsYW5ncy5wdXNoKGxhbmcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPWxhbmdzLmxlbmd0aDtqPGlsZW47aisrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxhbmcgPSBsYW5nc1tqXTtcbiAgICAgICAgICAgICAgICB2YXIgdmFscyA9IHt9O1xuICAgICAgICAgICAgICAgIGlmIChsYW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChJdGVtLm11bHRpLl9rZXlzW3RpdGxlLnRpdGxlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsc1t0aXRsZS50aXRsZV0gPSBJdGVtLm11bHRpLl9rZXlzW3RpdGxlLnRpdGxlXVtsYW5nXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoSXRlbS5tdWx0aS5fa2V5c1t0aXRsZVtcInNob3J0XCJdXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsc1t0aXRsZVtcInNob3J0XCJdXSA9IEl0ZW0ubXVsdGkuX2tleXNbdGl0bGVbXCJzaG9ydFwiXV1bbGFuZ107XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YWxzW3RpdGxlLnRpdGxlXSA9IEl0ZW1bdGl0bGUudGl0bGVdO1xuICAgICAgICAgICAgICAgICAgICB2YWxzW3RpdGxlW1wic2hvcnRcIl1dID0gSXRlbVt0aXRsZVtcInNob3J0XCJdXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFsc1t0aXRsZS5tYWluXSA9IHZhbHNbdGl0bGUudGl0bGVdO1xuICAgICAgICAgICAgICAgIHZhbHNbdGl0bGUuc3ViXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmICh2YWxzW3RpdGxlLnRpdGxlXSAmJiB2YWxzW3RpdGxlW1wic2hvcnRcIl1dKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzaG9ydFRpdGxlID0gdmFsc1t0aXRsZVtcInNob3J0XCJdXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNldCA9IHNob3J0VGl0bGUubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICBpZiAodmFsc1t0aXRsZS50aXRsZV0uc2xpY2UoMCxvZmZzZXQpID09PSBzaG9ydFRpdGxlICYmIHZhbHNbdGl0bGUudGl0bGVdLnNsaWNlKG9mZnNldCkubWF0Y2goL15cXHMqOi8pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWxzW3RpdGxlLm1haW5dID0gdmFsc1t0aXRsZS50aXRsZV0uc2xpY2UoMCxvZmZzZXQpLnJlcGxhY2UoL1xccyskLyxcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHNbdGl0bGUuc3ViXSA9IHZhbHNbdGl0bGUudGl0bGVdLnNsaWNlKG9mZnNldCkucmVwbGFjZSgvXlxccyo6XFxzKi8sXCJcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGxhbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHZhbHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghSXRlbS5tdWx0aS5fa2V5c1trZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgSXRlbS5tdWx0aS5fa2V5c1trZXldID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBJdGVtLm11bHRpLl9rZXlzW2tleV1bbGFuZ10gPSB2YWxzW2tleV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFscykge1xuICAgICAgICAgICAgICAgICAgICAgICAgSXRlbVtrZXldID0gdmFsc1trZXldO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcbiAgICB0aXRsZWNhc2VTZW50ZW5jZU9yTm9ybWFsOiBmdW5jdGlvbihzdGF0ZSwgSXRlbSwgc2VnLCBsYW5nLCBzZW50ZW5jZUNhc2UpIHtcbiAgICAgICAgdmFyIHRpdGxlID0gQ1NMLlRJVExFX0ZJRUxEX1NQTElUUyhzZWcpO1xuICAgICAgICB2YXIgdmFscyA9IHt9O1xuICAgICAgICBpZiAobGFuZyAmJiBJdGVtLm11bHRpKSB7XG4gICAgICAgICAgICBpZiAoSXRlbS5tdWx0aS5fa2V5c1t0aXRsZS50aXRsZV0pIHtcbiAgICAgICAgICAgICAgICB2YWxzW3RpdGxlLnRpdGxlXSA9IEl0ZW0ubXVsdGkuX2tleXNbdGl0bGUudGl0bGVdW2xhbmddO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKEl0ZW0ubXVsdGkuX2tleXNbdGl0bGUubWFpbl0pIHtcbiAgICAgICAgICAgICAgICB2YWxzW3RpdGxlLm1haW5dID0gSXRlbS5tdWx0aS5fa2V5c1t0aXRsZS5tYWluXVtsYW5nXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChJdGVtLm11bHRpLl9rZXlzW3RpdGxlLnN1Yl0pIHtcbiAgICAgICAgICAgICAgICB2YWxzW3RpdGxlLnN1Yl0gPSBJdGVtLm11bHRpLl9rZXlzW3RpdGxlLnN1Yl1bbGFuZ107XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YWxzW3RpdGxlLnRpdGxlXSA9IEl0ZW1bdGl0bGUudGl0bGVdO1xuICAgICAgICAgICAgdmFsc1t0aXRsZS5tYWluXSA9IEl0ZW1bdGl0bGUubWFpbl07XG4gICAgICAgICAgICB2YWxzW3RpdGxlLnN1Yl0gPSBJdGVtW3RpdGxlLnN1Yl07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZhbHNbdGl0bGUubWFpbl0gJiYgdmFsc1t0aXRsZS5zdWJdKSB7XG4gICAgICAgICAgICB2YXIgbWFpblRpdGxlID0gdmFsc1t0aXRsZS5tYWluXTtcbiAgICAgICAgICAgIHZhciBzdWJUaXRsZSA9IHZhbHNbdGl0bGUuc3ViXTtcbiAgICAgICAgICAgIGlmIChzZW50ZW5jZUNhc2UpIHtcbiAgICAgICAgICAgICAgICBtYWluVGl0bGUgPSBDU0wuT3V0cHV0LkZvcm1hdHRlcnMuc2VudGVuY2Uoc3RhdGUsIG1haW5UaXRsZSk7XG4gICAgICAgICAgICAgICAgc3ViVGl0bGUgPSBDU0wuT3V0cHV0LkZvcm1hdHRlcnMuc2VudGVuY2Uoc3RhdGUsIHN1YlRpdGxlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc3ViVGl0bGUgPSBDU0wuT3V0cHV0LkZvcm1hdHRlcnNbXCJjYXBpdGFsaXplLWZpcnN0XCJdKHN0YXRlLCBzdWJUaXRsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gW21haW5UaXRsZSwgc3ViVGl0bGVdLmpvaW4odmFsc1t0aXRsZS50aXRsZV0uc2xpY2UobWFpblRpdGxlLmxlbmd0aCwgLTEgKiBzdWJUaXRsZS5sZW5ndGgpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChzZW50ZW5jZUNhc2UpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzLnNlbnRlbmNlKHN0YXRlLCB2YWxzW3RpdGxlLnRpdGxlXSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB2YWxzW3RpdGxlLnRpdGxlXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG4gICAgZ2V0U2FmZUVzY2FwZTogZnVuY3Rpb24oc3RhdGUpIHtcbiAgICAgICAgaWYgKFtcImJpYmxpb2dyYXBoeVwiLCBcImNpdGF0aW9uXCJdLmluZGV4T2Yoc3RhdGUudG1wLmFyZWEpID4gLTEpIHtcbiAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBbXTtcbiAgICAgICAgICAgIGlmIChzdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy50aGluX25vbl9icmVha2luZ19zcGFjZV9odG1sX2hhY2sgJiYgc3RhdGUub3B0Lm1vZGUgPT09IFwiaHRtbFwiKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tzLnB1c2goZnVuY3Rpb24gKHR4dCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHh0LnJlcGxhY2UoL1xcdTIwMmYvZywgJzxzcGFuIHN0eWxlPVwid2hpdGUtc3BhY2U6bm93cmFwXCI+JnRoaW5zcDs8L3NwYW4+Jyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY2FsbGJhY2tzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAodHh0KSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gY2FsbGJhY2tzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHh0ID0gY2FsbGJhY2tzW2ldKHR4dCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIENTTC5PdXRwdXQuRm9ybWF0c1tzdGF0ZS5vcHQubW9kZV0udGV4dF9lc2NhcGUodHh0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBDU0wuT3V0cHV0LkZvcm1hdHNbc3RhdGUub3B0Lm1vZGVdLnRleHRfZXNjYXBlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0eHQpIHsgcmV0dXJuIHR4dDsgfTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgU0tJUF9XT1JEUzogW1wiYWJvdXRcIixcImFib3ZlXCIsXCJhY3Jvc3NcIixcImFmb3JlXCIsXCJhZnRlclwiLFwiYWdhaW5zdFwiLFwiYWxvbmdcIixcImFsb25nc2lkZVwiLFwiYW1pZFwiLFwiYW1pZHN0XCIsXCJhbW9uZ1wiLFwiYW1vbmdzdFwiLFwiYW5lbnN0XCIsXCJhcHJvcG9zXCIsXCJhcHVkXCIsXCJhcm91bmRcIixcImFzXCIsXCJhc2lkZVwiLFwiYXN0cmlkZVwiLFwiYXRcIixcImF0aHdhcnRcIixcImF0b3BcIixcImJhcnJpbmdcIixcImJlZm9yZVwiLFwiYmVoaW5kXCIsXCJiZWxvd1wiLFwiYmVuZWF0aFwiLFwiYmVzaWRlXCIsXCJiZXNpZGVzXCIsXCJiZXR3ZWVuXCIsXCJiZXlvbmRcIixcImJ1dFwiLFwiYnlcIixcImNpcmNhXCIsXCJkZXNwaXRlXCIsXCJkb3duXCIsXCJkdXJpbmdcIixcImV4Y2VwdFwiLFwiZm9yXCIsXCJmb3JlbmVuc3RcIixcImZyb21cIixcImdpdmVuXCIsXCJpblwiLFwiaW5zaWRlXCIsXCJpbnRvXCIsXCJsZXN0XCIsXCJsaWtlXCIsXCJtb2R1bG9cIixcIm5lYXJcIixcIm5leHRcIixcIm5vdHdpdGhzdGFuZGluZ1wiLFwib2ZcIixcIm9mZlwiLFwib25cIixcIm9udG9cIixcIm91dFwiLFwib3ZlclwiLFwicGVyXCIsXCJwbHVzXCIsXCJwcm9cIixcInF1YVwiLFwic2Fuc1wiLFwic2luY2VcIixcInRoYW5cIixcInRocm91Z2hcIixcIiB0aHJ1XCIsXCJ0aHJvdWdob3V0XCIsXCJ0aHJ1b3V0XCIsXCJ0aWxsXCIsXCJ0b1wiLFwidG93YXJkXCIsXCJ0b3dhcmRzXCIsXCJ1bmRlclwiLFwidW5kZXJuZWF0aFwiLFwidW50aWxcIixcInVudG9cIixcInVwXCIsXCJ1cG9uXCIsXCJ2ZXJzdXNcIixcInZzLlwiLFwidi5cIixcInZzXCIsXCJ2XCIsXCJ2aWFcIixcInZpcy3DoC12aXNcIixcIndpdGhcIixcIndpdGhpblwiLFwid2l0aG91dFwiLFwiYWNjb3JkaW5nIHRvXCIsXCJhaGVhZCBvZlwiLFwiYXBhcnQgZnJvbVwiLFwiYXMgZm9yXCIsXCJhcyBvZlwiLFwiYXMgcGVyXCIsXCJhcyByZWdhcmRzXCIsXCJhc2lkZSBmcm9tXCIsXCJiYWNrIHRvXCIsXCJiZWNhdXNlIG9mXCIsXCJjbG9zZSB0b1wiLFwiZHVlIHRvXCIsXCJleGNlcHQgZm9yXCIsXCJmYXIgZnJvbVwiLFwiaW5zaWRlIG9mXCIsXCJpbnN0ZWFkIG9mXCIsXCJuZWFyIHRvXCIsXCJuZXh0IHRvXCIsXCJvbiB0b1wiLFwib3V0IGZyb21cIixcIm91dCBvZlwiLFwib3V0c2lkZSBvZlwiLFwicHJpb3IgdG9cIixcInB1cnN1YW50IHRvXCIsXCJyYXRoZXIgdGhhblwiLFwicmVnYXJkbGVzcyBvZlwiLFwic3VjaCBhc1wiLFwidGhhdCBvZlwiLFwidXAgdG9cIixcIndoZXJlIGFzXCIsXCJvclwiLCBcInlldFwiLCBcInNvXCIsIFwiZm9yXCIsIFwiYW5kXCIsIFwibm9yXCIsIFwiYVwiLCBcImFuXCIsIFwidGhlXCIsIFwiZGVcIiwgXCJkJ1wiLCBcInZvblwiLCBcInZhblwiLCBcImNcIiwgXCJldFwiLCBcImNhXCJdLFxuICAgIEZPUk1BVF9LRVlfU0VRVUVOQ0U6IFtcbiAgICAgICAgXCJAc3RyaXAtcGVyaW9kc1wiLFxuICAgICAgICBcIkBmb250LXN0eWxlXCIsXG4gICAgICAgIFwiQGZvbnQtdmFyaWFudFwiLFxuICAgICAgICBcIkBmb250LXdlaWdodFwiLFxuICAgICAgICBcIkB0ZXh0LWRlY29yYXRpb25cIixcbiAgICAgICAgXCJAdmVydGljYWwtYWxpZ25cIixcbiAgICAgICAgXCJAcXVvdGVzXCJcbiAgICBdLFxuICAgIElOU1RJVFVUSU9OX0tFWVM6IFtcbiAgICAgICAgXCJmb250LXN0eWxlXCIsXG4gICAgICAgIFwiZm9udC12YXJpYW50XCIsXG4gICAgICAgIFwiZm9udC13ZWlnaHRcIixcbiAgICAgICAgXCJ0ZXh0LWRlY29yYXRpb25cIixcbiAgICAgICAgXCJ0ZXh0LWNhc2VcIlxuICAgIF0sXG4gICAgU1VGRklYX0NIQVJTOiBcImEsYixjLGQsZSxmLGcsaCxpLGosayxsLG0sbixvLHAscSxyLHMsdCx1LHYsdyx4LHkselwiLFxuICAgIFJPTUFOX05VTUVSQUxTOiBbXG4gICAgICAgIFsgXCJcIiwgXCJpXCIsIFwiaWlcIiwgXCJpaWlcIiwgXCJpdlwiLCBcInZcIiwgXCJ2aVwiLCBcInZpaVwiLCBcInZpaWlcIiwgXCJpeFwiIF0sXG4gICAgICAgIFsgXCJcIiwgXCJ4XCIsIFwieHhcIiwgXCJ4eHhcIiwgXCJ4bFwiLCBcImxcIiwgXCJseFwiLCBcImx4eFwiLCBcImx4eHhcIiwgXCJ4Y1wiIF0sXG4gICAgICAgIFsgXCJcIiwgXCJjXCIsIFwiY2NcIiwgXCJjY2NcIiwgXCJjZFwiLCBcImRcIiwgXCJkY1wiLCBcImRjY1wiLCBcImRjY2NcIiwgXCJjbVwiIF0sXG4gICAgICAgIFsgXCJcIiwgXCJtXCIsIFwibW1cIiwgXCJtbW1cIiwgXCJtbW1tXCIsIFwibW1tbW1cIl1cbiAgICBdLFxuICAgIENSRUFUT1JTOiBbXG4gICAgICAgIFwiYXV0aG9yXCIsXG4gICAgICAgIFwiZWRpdG9yXCIsXG4gICAgICAgIFwiY29udHJpYnV0b3JcIixcbiAgICAgICAgXCJ0cmFuc2xhdG9yXCIsXG4gICAgICAgIFwicmVjaXBpZW50XCIsXG4gICAgICAgIFwiaW50ZXJ2aWV3ZXJcIixcbiAgICAgICAgXCJjb21wb3NlclwiLFxuICAgICAgICBcIm9yaWdpbmFsLWF1dGhvclwiLFxuICAgICAgICBcImNvbnRhaW5lci1hdXRob3JcIixcbiAgICAgICAgXCJjb2xsZWN0aW9uLWVkaXRvclwiXG4gICAgXSxcbiAgICBMQU5HUzoge1xuICAgICAgICBcImFmLVpBXCI6XCJBZnJpa2FhbnNcIixcbiAgICAgICAgXCJhclwiOlwiQXJhYmljXCIsXG4gICAgICAgIFwiYmctQkdcIjpcIkJ1bGdhcmlhblwiLFxuICAgICAgICBcImNhLUFEXCI6XCJDYXRhbGFuXCIsXG4gICAgICAgIFwiY3MtQ1pcIjpcIkN6ZWNoXCIsXG4gICAgICAgIFwiZGEtREtcIjpcIkRhbmlzaFwiLFxuICAgICAgICBcImRlLUFUXCI6XCJBdXN0cmlhblwiLFxuICAgICAgICBcImRlLUNIXCI6XCJHZXJtYW4gKENIKVwiLFxuICAgICAgICBcImRlLURFXCI6XCJHZXJtYW4gKERFKVwiLFxuICAgICAgICBcImVsLUdSXCI6XCJHcmVla1wiLFxuICAgICAgICBcImVuLUdCXCI6XCJFbmdsaXNoIChHQilcIixcbiAgICAgICAgXCJlbi1VU1wiOlwiRW5nbGlzaCAoVVMpXCIsXG4gICAgICAgIFwiZXMtRVNcIjpcIlNwYW5pc2hcIixcbiAgICAgICAgXCJldC1FRVwiOlwiRXN0b25pYW5cIixcbiAgICAgICAgXCJldVwiOlwiRXVyb3BlYW5cIixcbiAgICAgICAgXCJmYS1JUlwiOlwiUGVyc2lhblwiLFxuICAgICAgICBcImZpLUZJXCI6XCJGaW5uaXNoXCIsXG4gICAgICAgIFwiZnItQ0FcIjpcIkZyZW5jaCAoQ0EpXCIsXG4gICAgICAgIFwiZnItRlJcIjpcIkZyZW5jaCAoRlIpXCIsXG4gICAgICAgIFwiaGUtSUxcIjpcIkhlYnJld1wiLFxuICAgICAgICBcImhyLUhSXCI6XCJDcm9hdGlhblwiLFxuICAgICAgICBcImh1LUhVXCI6XCJIdW5nYXJpYW5cIixcbiAgICAgICAgXCJpcy1JU1wiOlwiSWNlbGFuZGljXCIsXG4gICAgICAgIFwiaXQtSVRcIjpcIkl0YWxpYW5cIixcbiAgICAgICAgXCJqYS1KUFwiOlwiSmFwYW5lc2VcIixcbiAgICAgICAgXCJrbS1LSFwiOlwiS2htZXJcIixcbiAgICAgICAgXCJrby1LUlwiOlwiS29yZWFuXCIsXG4gICAgICAgIFwibHQtTFRcIjpcIkxpdGh1YW5pYW5cIixcbiAgICAgICAgXCJsdi1MVlwiOlwiTGF0dmlhblwiLFxuICAgICAgICBcIm1uLU1OXCI6XCJNb25nb2xpYW5cIixcbiAgICAgICAgXCJuYi1OT1wiOlwiTm9yd2VnaWFuIChCb2ttw6VsKVwiLFxuICAgICAgICBcIm5sLU5MXCI6XCJEdXRjaFwiLFxuICAgICAgICBcIm5uLU5PXCI6XCJOb3J3ZWdpYW4gKE55bm9yc2spXCIsXG4gICAgICAgIFwicGwtUExcIjpcIlBvbGlzaFwiLFxuICAgICAgICBcInB0LUJSXCI6XCJQb3J0dWd1ZXNlIChCUilcIixcbiAgICAgICAgXCJwdC1QVFwiOlwiUG9ydHVndWVzZSAoUFQpXCIsXG4gICAgICAgIFwicm8tUk9cIjpcIlJvbWFuaWFuXCIsXG4gICAgICAgIFwicnUtUlVcIjpcIlJ1c3NpYW5cIixcbiAgICAgICAgXCJzay1TS1wiOlwiU2xvdmFrXCIsXG4gICAgICAgIFwic2wtU0lcIjpcIlNsb3ZlbmlhblwiLFxuICAgICAgICBcInNyLVJTXCI6XCJTZXJiaWFuXCIsXG4gICAgICAgIFwic3YtU0VcIjpcIlN3ZWRpc2hcIixcbiAgICAgICAgXCJ0aC1USFwiOlwiVGhhaVwiLFxuICAgICAgICBcInRyLVRSXCI6XCJUdXJraXNoXCIsXG4gICAgICAgIFwidWstVUFcIjpcIlVrcmFuaWFuXCIsXG4gICAgICAgIFwidmktVk5cIjpcIlZpZXRuYW1lc2VcIixcbiAgICAgICAgXCJ6aC1DTlwiOlwiQ2hpbmVzZSAoQ04pXCIsXG4gICAgICAgIFwiemgtVFdcIjpcIkNoaW5lc2UgKFRXKVwiXG4gICAgfSxcbiAgICBMQU5HX0JBU0VTOiB7XG4gICAgICAgIGFmOiBcImFmX1pBXCIsXG4gICAgICAgIGFyOiBcImFyXCIsXG4gICAgICAgIGJnOiBcImJnX0JHXCIsXG4gICAgICAgIGNhOiBcImNhX0FEXCIsXG4gICAgICAgIGNzOiBcImNzX0NaXCIsXG4gICAgICAgIGRhOiBcImRhX0RLXCIsXG4gICAgICAgIGRlOiBcImRlX0RFXCIsXG4gICAgICAgIGVsOiBcImVsX0dSXCIsXG4gICAgICAgIGVuOiBcImVuX1VTXCIsXG4gICAgICAgIGVzOiBcImVzX0VTXCIsXG4gICAgICAgIGV0OiBcImV0X0VFXCIsXG4gICAgICAgIGV1OiBcImV1XCIsXG4gICAgICAgIGZhOiBcImZhX0lSXCIsXG4gICAgICAgIGZpOiBcImZpX0ZJXCIsXG4gICAgICAgIGZyOiBcImZyX0ZSXCIsXG4gICAgICAgIGhlOiBcImhlX0lMXCIsXG4gICAgICAgIGhyOiBcImhyLUhSXCIsXG4gICAgICAgIGh1OiBcImh1X0hVXCIsXG4gICAgICAgIGlzOiBcImlzX0lTXCIsXG4gICAgICAgIGl0OiBcIml0X0lUXCIsXG4gICAgICAgIGphOiBcImphX0pQXCIsXG4gICAgICAgIGttOiBcImttX0tIXCIsXG4gICAgICAgIGtvOiBcImtvX0tSXCIsXG4gICAgICAgIGx0OiBcImx0X0xUXCIsXG4gICAgICAgIGx2OiBcImx2LUxWXCIsXG4gICAgICAgIG1uOiBcIm1uX01OXCIsXG4gICAgICAgIG5iOiBcIm5iX05PXCIsXG4gICAgICAgIG5sOiBcIm5sX05MXCIsXG4gICAgICAgIG5uOiBcIm5uLU5PXCIsXG4gICAgICAgIHBsOiBcInBsX1BMXCIsXG4gICAgICAgIHB0OiBcInB0X1BUXCIsXG4gICAgICAgIHJvOiBcInJvX1JPXCIsXG4gICAgICAgIHJ1OiBcInJ1X1JVXCIsXG4gICAgICAgIHNrOiBcInNrX1NLXCIsXG4gICAgICAgIHNsOiBcInNsX1NJXCIsXG4gICAgICAgIHNyOiBcInNyX1JTXCIsXG4gICAgICAgIHN2OiBcInN2X1NFXCIsXG4gICAgICAgIHRoOiBcInRoX1RIXCIsXG4gICAgICAgIHRyOiBcInRyX1RSXCIsXG4gICAgICAgIHVrOiBcInVrX1VBXCIsXG4gICAgICAgIHZpOiBcInZpX1ZOXCIsXG4gICAgICAgIHpoOiBcInpoX0NOXCJcbiAgICB9LFxuICAgIFNVUEVSU0NSSVBUUzoge1xuICAgICAgICBcIlxcdTAwQUFcIjogXCJcXHUwMDYxXCIsXG4gICAgICAgIFwiXFx1MDBCMlwiOiBcIlxcdTAwMzJcIixcbiAgICAgICAgXCJcXHUwMEIzXCI6IFwiXFx1MDAzM1wiLFxuICAgICAgICBcIlxcdTAwQjlcIjogXCJcXHUwMDMxXCIsXG4gICAgICAgIFwiXFx1MDBCQVwiOiBcIlxcdTAwNkZcIixcbiAgICAgICAgXCJcXHUwMkIwXCI6IFwiXFx1MDA2OFwiLFxuICAgICAgICBcIlxcdTAyQjFcIjogXCJcXHUwMjY2XCIsXG4gICAgICAgIFwiXFx1MDJCMlwiOiBcIlxcdTAwNkFcIixcbiAgICAgICAgXCJcXHUwMkIzXCI6IFwiXFx1MDA3MlwiLFxuICAgICAgICBcIlxcdTAyQjRcIjogXCJcXHUwMjc5XCIsXG4gICAgICAgIFwiXFx1MDJCNVwiOiBcIlxcdTAyN0JcIixcbiAgICAgICAgXCJcXHUwMkI2XCI6IFwiXFx1MDI4MVwiLFxuICAgICAgICBcIlxcdTAyQjdcIjogXCJcXHUwMDc3XCIsXG4gICAgICAgIFwiXFx1MDJCOFwiOiBcIlxcdTAwNzlcIixcbiAgICAgICAgXCJcXHUwMkUwXCI6IFwiXFx1MDI2M1wiLFxuICAgICAgICBcIlxcdTAyRTFcIjogXCJcXHUwMDZDXCIsXG4gICAgICAgIFwiXFx1MDJFMlwiOiBcIlxcdTAwNzNcIixcbiAgICAgICAgXCJcXHUwMkUzXCI6IFwiXFx1MDA3OFwiLFxuICAgICAgICBcIlxcdTAyRTRcIjogXCJcXHUwMjk1XCIsXG4gICAgICAgIFwiXFx1MUQyQ1wiOiBcIlxcdTAwNDFcIixcbiAgICAgICAgXCJcXHUxRDJEXCI6IFwiXFx1MDBDNlwiLFxuICAgICAgICBcIlxcdTFEMkVcIjogXCJcXHUwMDQyXCIsXG4gICAgICAgIFwiXFx1MUQzMFwiOiBcIlxcdTAwNDRcIixcbiAgICAgICAgXCJcXHUxRDMxXCI6IFwiXFx1MDA0NVwiLFxuICAgICAgICBcIlxcdTFEMzJcIjogXCJcXHUwMThFXCIsXG4gICAgICAgIFwiXFx1MUQzM1wiOiBcIlxcdTAwNDdcIixcbiAgICAgICAgXCJcXHUxRDM0XCI6IFwiXFx1MDA0OFwiLFxuICAgICAgICBcIlxcdTFEMzVcIjogXCJcXHUwMDQ5XCIsXG4gICAgICAgIFwiXFx1MUQzNlwiOiBcIlxcdTAwNEFcIixcbiAgICAgICAgXCJcXHUxRDM3XCI6IFwiXFx1MDA0QlwiLFxuICAgICAgICBcIlxcdTFEMzhcIjogXCJcXHUwMDRDXCIsXG4gICAgICAgIFwiXFx1MUQzOVwiOiBcIlxcdTAwNERcIixcbiAgICAgICAgXCJcXHUxRDNBXCI6IFwiXFx1MDA0RVwiLFxuICAgICAgICBcIlxcdTFEM0NcIjogXCJcXHUwMDRGXCIsXG4gICAgICAgIFwiXFx1MUQzRFwiOiBcIlxcdTAyMjJcIixcbiAgICAgICAgXCJcXHUxRDNFXCI6IFwiXFx1MDA1MFwiLFxuICAgICAgICBcIlxcdTFEM0ZcIjogXCJcXHUwMDUyXCIsXG4gICAgICAgIFwiXFx1MUQ0MFwiOiBcIlxcdTAwNTRcIixcbiAgICAgICAgXCJcXHUxRDQxXCI6IFwiXFx1MDA1NVwiLFxuICAgICAgICBcIlxcdTFENDJcIjogXCJcXHUwMDU3XCIsXG4gICAgICAgIFwiXFx1MUQ0M1wiOiBcIlxcdTAwNjFcIixcbiAgICAgICAgXCJcXHUxRDQ0XCI6IFwiXFx1MDI1MFwiLFxuICAgICAgICBcIlxcdTFENDVcIjogXCJcXHUwMjUxXCIsXG4gICAgICAgIFwiXFx1MUQ0NlwiOiBcIlxcdTFEMDJcIixcbiAgICAgICAgXCJcXHUxRDQ3XCI6IFwiXFx1MDA2MlwiLFxuICAgICAgICBcIlxcdTFENDhcIjogXCJcXHUwMDY0XCIsXG4gICAgICAgIFwiXFx1MUQ0OVwiOiBcIlxcdTAwNjVcIixcbiAgICAgICAgXCJcXHUxRDRBXCI6IFwiXFx1MDI1OVwiLFxuICAgICAgICBcIlxcdTFENEJcIjogXCJcXHUwMjVCXCIsXG4gICAgICAgIFwiXFx1MUQ0Q1wiOiBcIlxcdTAyNUNcIixcbiAgICAgICAgXCJcXHUxRDREXCI6IFwiXFx1MDA2N1wiLFxuICAgICAgICBcIlxcdTFENEZcIjogXCJcXHUwMDZCXCIsXG4gICAgICAgIFwiXFx1MUQ1MFwiOiBcIlxcdTAwNkRcIixcbiAgICAgICAgXCJcXHUxRDUxXCI6IFwiXFx1MDE0QlwiLFxuICAgICAgICBcIlxcdTFENTJcIjogXCJcXHUwMDZGXCIsXG4gICAgICAgIFwiXFx1MUQ1M1wiOiBcIlxcdTAyNTRcIixcbiAgICAgICAgXCJcXHUxRDU0XCI6IFwiXFx1MUQxNlwiLFxuICAgICAgICBcIlxcdTFENTVcIjogXCJcXHUxRDE3XCIsXG4gICAgICAgIFwiXFx1MUQ1NlwiOiBcIlxcdTAwNzBcIixcbiAgICAgICAgXCJcXHUxRDU3XCI6IFwiXFx1MDA3NFwiLFxuICAgICAgICBcIlxcdTFENThcIjogXCJcXHUwMDc1XCIsXG4gICAgICAgIFwiXFx1MUQ1OVwiOiBcIlxcdTFEMURcIixcbiAgICAgICAgXCJcXHUxRDVBXCI6IFwiXFx1MDI2RlwiLFxuICAgICAgICBcIlxcdTFENUJcIjogXCJcXHUwMDc2XCIsXG4gICAgICAgIFwiXFx1MUQ1Q1wiOiBcIlxcdTFEMjVcIixcbiAgICAgICAgXCJcXHUxRDVEXCI6IFwiXFx1MDNCMlwiLFxuICAgICAgICBcIlxcdTFENUVcIjogXCJcXHUwM0IzXCIsXG4gICAgICAgIFwiXFx1MUQ1RlwiOiBcIlxcdTAzQjRcIixcbiAgICAgICAgXCJcXHUxRDYwXCI6IFwiXFx1MDNDNlwiLFxuICAgICAgICBcIlxcdTFENjFcIjogXCJcXHUwM0M3XCIsXG4gICAgICAgIFwiXFx1MjA3MFwiOiBcIlxcdTAwMzBcIixcbiAgICAgICAgXCJcXHUyMDcxXCI6IFwiXFx1MDA2OVwiLFxuICAgICAgICBcIlxcdTIwNzRcIjogXCJcXHUwMDM0XCIsXG4gICAgICAgIFwiXFx1MjA3NVwiOiBcIlxcdTAwMzVcIixcbiAgICAgICAgXCJcXHUyMDc2XCI6IFwiXFx1MDAzNlwiLFxuICAgICAgICBcIlxcdTIwNzdcIjogXCJcXHUwMDM3XCIsXG4gICAgICAgIFwiXFx1MjA3OFwiOiBcIlxcdTAwMzhcIixcbiAgICAgICAgXCJcXHUyMDc5XCI6IFwiXFx1MDAzOVwiLFxuICAgICAgICBcIlxcdTIwN0FcIjogXCJcXHUwMDJCXCIsXG4gICAgICAgIFwiXFx1MjA3QlwiOiBcIlxcdTIyMTJcIixcbiAgICAgICAgXCJcXHUyMDdDXCI6IFwiXFx1MDAzRFwiLFxuICAgICAgICBcIlxcdTIwN0RcIjogXCJcXHUwMDI4XCIsXG4gICAgICAgIFwiXFx1MjA3RVwiOiBcIlxcdTAwMjlcIixcbiAgICAgICAgXCJcXHUyMDdGXCI6IFwiXFx1MDA2RVwiLFxuICAgICAgICBcIlxcdTIxMjBcIjogXCJcXHUwMDUzXFx1MDA0RFwiLFxuICAgICAgICBcIlxcdTIxMjJcIjogXCJcXHUwMDU0XFx1MDA0RFwiLFxuICAgICAgICBcIlxcdTMxOTJcIjogXCJcXHU0RTAwXCIsXG4gICAgICAgIFwiXFx1MzE5M1wiOiBcIlxcdTRFOENcIixcbiAgICAgICAgXCJcXHUzMTk0XCI6IFwiXFx1NEUwOVwiLFxuICAgICAgICBcIlxcdTMxOTVcIjogXCJcXHU1NkRCXCIsXG4gICAgICAgIFwiXFx1MzE5NlwiOiBcIlxcdTRFMEFcIixcbiAgICAgICAgXCJcXHUzMTk3XCI6IFwiXFx1NEUyRFwiLFxuICAgICAgICBcIlxcdTMxOThcIjogXCJcXHU0RTBCXCIsXG4gICAgICAgIFwiXFx1MzE5OVwiOiBcIlxcdTc1MzJcIixcbiAgICAgICAgXCJcXHUzMTlBXCI6IFwiXFx1NEU1OVwiLFxuICAgICAgICBcIlxcdTMxOUJcIjogXCJcXHU0RTE5XCIsXG4gICAgICAgIFwiXFx1MzE5Q1wiOiBcIlxcdTRFMDFcIixcbiAgICAgICAgXCJcXHUzMTlEXCI6IFwiXFx1NTkyOVwiLFxuICAgICAgICBcIlxcdTMxOUVcIjogXCJcXHU1NzMwXCIsXG4gICAgICAgIFwiXFx1MzE5RlwiOiBcIlxcdTRFQkFcIixcbiAgICAgICAgXCJcXHUwMkMwXCI6IFwiXFx1MDI5NFwiLFxuICAgICAgICBcIlxcdTAyQzFcIjogXCJcXHUwMjk1XCIsXG4gICAgICAgIFwiXFx1MDZFNVwiOiBcIlxcdTA2NDhcIixcbiAgICAgICAgXCJcXHUwNkU2XCI6IFwiXFx1MDY0QVwiXG4gICAgfSxcbiAgICBTVVBFUlNDUklQVFNfUkVHRVhQOiBuZXcgUmVnRXhwKFwiW1xcdTAwQUFcXHUwMEIyXFx1MDBCM1xcdTAwQjlcXHUwMEJBXFx1MDJCMFxcdTAyQjFcXHUwMkIyXFx1MDJCM1xcdTAyQjRcXHUwMkI1XFx1MDJCNlxcdTAyQjdcXHUwMkI4XFx1MDJFMFxcdTAyRTFcXHUwMkUyXFx1MDJFM1xcdTAyRTRcXHUxRDJDXFx1MUQyRFxcdTFEMkVcXHUxRDMwXFx1MUQzMVxcdTFEMzJcXHUxRDMzXFx1MUQzNFxcdTFEMzVcXHUxRDM2XFx1MUQzN1xcdTFEMzhcXHUxRDM5XFx1MUQzQVxcdTFEM0NcXHUxRDNEXFx1MUQzRVxcdTFEM0ZcXHUxRDQwXFx1MUQ0MVxcdTFENDJcXHUxRDQzXFx1MUQ0NFxcdTFENDVcXHUxRDQ2XFx1MUQ0N1xcdTFENDhcXHUxRDQ5XFx1MUQ0QVxcdTFENEJcXHUxRDRDXFx1MUQ0RFxcdTFENEZcXHUxRDUwXFx1MUQ1MVxcdTFENTJcXHUxRDUzXFx1MUQ1NFxcdTFENTVcXHUxRDU2XFx1MUQ1N1xcdTFENThcXHUxRDU5XFx1MUQ1QVxcdTFENUJcXHUxRDVDXFx1MUQ1RFxcdTFENUVcXHUxRDVGXFx1MUQ2MFxcdTFENjFcXHUyMDcwXFx1MjA3MVxcdTIwNzRcXHUyMDc1XFx1MjA3NlxcdTIwNzdcXHUyMDc4XFx1MjA3OVxcdTIwN0FcXHUyMDdCXFx1MjA3Q1xcdTIwN0RcXHUyMDdFXFx1MjA3RlxcdTIxMjBcXHUyMTIyXFx1MzE5MlxcdTMxOTNcXHUzMTk0XFx1MzE5NVxcdTMxOTZcXHUzMTk3XFx1MzE5OFxcdTMxOTlcXHUzMTlBXFx1MzE5QlxcdTMxOUNcXHUzMTlEXFx1MzE5RVxcdTMxOUZcXHUwMkMwXFx1MDJDMVxcdTA2RTVcXHUwNkU2XVwiLCBcImdcIiksXG4gICAgVVBEQVRFX0dST1VQX0NPTlRFWFRfQ09ORElUSU9OOiBmdW5jdGlvbiAoc3RhdGUsIHRlcm10eHQsIHZhbHVlVGVybSkge1xuICAgICAgICBpZiAoc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmNvbmRpdGlvbikge1xuICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24udGVzdCkge1xuICAgICAgICAgICAgICAgIHZhciB0ZXN0cmVzO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuY29uZGl0aW9uLnRlc3QgPT09IFwiZW1wdHktbGFiZWxcIikge1xuICAgICAgICAgICAgICAgICAgICB0ZXN0cmVzID0gIXRlcm10eHQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuY29uZGl0aW9uLnRlc3QgPT09IFwiZW1wdHktbGFiZWwtbm8tZGVjb3JcIikge1xuICAgICAgICAgICAgICAgICAgICB0ZXN0cmVzID0gIXRlcm10eHQgfHwgdGVybXR4dC5pbmRleE9mKFwiJXNcIikgPiAtMTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24udGVzdCA9PT0gXCJjb21tYS1zYWZlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVtcHR5ID0gIXRlcm10eHQ7XG4gICAgICAgICAgICAgICAgICAgIHZhciBhbHBoYSA9IHRlcm10eHQuc2xpY2UoMCwxKS5tYXRjaChDU0wuQUxMX1JPTUFORVNRVUVfUkVHRVhQKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG51bSA9IHN0YXRlLnRtcC5qdXN0X2RpZF9udW1iZXI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbXB0eSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVzdHJlcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobnVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxwaGEgJiYgIXZhbHVlVGVybSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RyZXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0cmVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxwaGEgJiYgIXZhbHVlVGVybSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RyZXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0cmVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRlc3RyZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmZvcmNlX3N1cHByZXNzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmZvcmNlX3N1cHByZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24ubm90KSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5mb3JjZV9zdXBwcmVzcyA9ICFzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuZm9yY2Vfc3VwcHJlc3M7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRlcm10eHQuc2xpY2UoLTEpLm1hdGNoKC9bMC05XS8pKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmp1c3RfZGlkX251bWJlciA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5qdXN0X2RpZF9udW1iZXIgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG4gICAgbG9jYWxlOiB7fSxcbiAgICBsb2NhbGVfb3B0czoge30sXG4gICAgbG9jYWxlX2RhdGVzOiB7fVxufTtcbmlmICh0eXBlb2YgcmVxdWlyZSAhPT0gXCJ1bmRlZmluZWRcIiAmJiB0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBcImV4cG9ydHNcIiBpbiBtb2R1bGUpIHtcbiAgICB2YXIgQ1NMX0lTX05PREVKUyA9IHRydWU7XG4gICAgZXhwb3J0cy5DU0wgPSBDU0w7XG59XG5DU0wuVEVSTUlOQUxfUFVOQ1RVQVRJT05fUkVHRVhQID0gbmV3IFJlZ0V4cChcIl4oW1wiICsgQ1NMLlRFUk1JTkFMX1BVTkNUVUFUSU9OLnNsaWNlKDAsIC0xKS5qb2luKFwiXCIpICsgXCJdKSguKilcIik7XG5DU0wuQ0xPU1VSRVMgPSBuZXcgUmVnRXhwKFwiLipbXFxcXF1cXFxcKV1cIik7XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbmlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgY29uc29sZSkge1xuICAgIENTTC5kZWJ1ZyA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgZHVtcChcIkNTTDogXCIgKyBzdHIgKyBcIlxcblwiKTtcbiAgICB9O1xuICAgIENTTC5lcnJvciA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgZHVtcChcIkNTTCBlcnJvcjogXCIgKyBzdHIgKyBcIlxcblwiKTtcbiAgICB9O1xufSBlbHNlIHtcbiAgICBDU0wuZGVidWcgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ1NMOiBcIiArIHN0cik7XG4gICAgfTtcbiAgICBDU0wuZXJyb3IgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ1NMIGVycm9yOiBcIiArIHN0cik7XG4gICAgfTtcbn1cbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlhtbEpTT04gPSBmdW5jdGlvbiAoZGF0YU9iaikge1xuICAgIHRoaXMuZGF0YU9iaiA9IGRhdGFPYmo7XG4gICAgdGhpcy5pbnN0aXR1dGlvbiA9IHtcbiAgICAgICAgbmFtZTpcImluc3RpdHV0aW9uXCIsXG4gICAgICAgIGF0dHJzOntcbiAgICAgICAgICAgIFwiaW5zdGl0dXRpb24tcGFydHNcIjpcImxvbmdcIixcbiAgICAgICAgICAgIFwiZGVsaW1pdGVyXCI6XCIsIFwiLFxuICAgICAgICAgICAgXCJzdWJzdGl0dXRlLXVzZS1maXJzdFwiOlwiMVwiLFxuICAgICAgICAgICAgXCJ1c2UtbGFzdFwiOlwiMVwiXG4gICAgICAgIH0sXG4gICAgICAgIGNoaWxkcmVuOltcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOlwiaW5zdGl0dXRpb24tcGFydFwiLFxuICAgICAgICAgICAgICAgIGF0dHJzOntcbiAgICAgICAgICAgICAgICAgICAgbmFtZTpcImxvbmdcIlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgY2hpbGRyZW46W11cbiAgICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgIH07XG59O1xuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmNsZWFuID0gZnVuY3Rpb24gKGpzb24pIHtcbiAgICByZXR1cm4ganNvbjtcbn07XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuZ2V0U3R5bGVJZCA9IGZ1bmN0aW9uIChteWpzb24sIHN0eWxlTmFtZSkge1xuICAgIHZhciB0YWdOYW1lID0gJ2lkJztcbiAgICBpZiAoc3R5bGVOYW1lKSB7XG4gICAgICAgIHRhZ05hbWUgPSAndGl0bGUnO1xuICAgIH1cbiAgICB2YXIgcmV0ID0gXCJcIjtcbiAgICB2YXIgY2hpbGRyZW4gPSBteWpzb24uY2hpbGRyZW47XG4gICAgZm9yICh2YXIgaT0wLGlsZW49Y2hpbGRyZW4ubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgaWYgKGNoaWxkcmVuW2ldLm5hbWUgPT09ICdpbmZvJykge1xuICAgICAgICAgICAgdmFyIGdyYW5ka2lkcyA9IGNoaWxkcmVuW2ldLmNoaWxkcmVuO1xuICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49Z3JhbmRraWRzLmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICAgICAgaWYgKGdyYW5ka2lkc1tqXS5uYW1lID09PSB0YWdOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldCA9IGdyYW5ka2lkc1tqXS5jaGlsZHJlblswXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuY2hpbGRyZW4gPSBmdW5jdGlvbiAobXlqc29uKSB7XG4gICAgaWYgKG15anNvbiAmJiBteWpzb24uY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBteWpzb24uY2hpbGRyZW4uc2xpY2UoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5YbWxKU09OLnByb3RvdHlwZS5ub2RlbmFtZSA9IGZ1bmN0aW9uIChteWpzb24pIHtcbiAgICByZXR1cm4gbXlqc29uID8gbXlqc29uLm5hbWUgOiBudWxsO1xufTtcbkNTTC5YbWxKU09OLnByb3RvdHlwZS5hdHRyaWJ1dGVzID0gZnVuY3Rpb24gKG15anNvbikge1xuICAgIHZhciByZXQgPSB7fTtcbiAgICBmb3IgKHZhciBhdHRybmFtZSBpbiBteWpzb24uYXR0cnMpIHtcbiAgICAgICAgcmV0W1wiQFwiK2F0dHJuYW1lXSA9IG15anNvbi5hdHRyc1thdHRybmFtZV07XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmNvbnRlbnQgPSBmdW5jdGlvbiAobXlqc29uKSB7XG4gICAgdmFyIHJldCA9IFwiXCI7XG4gICAgaWYgKCFteWpzb24gfHwgIW15anNvbi5jaGlsZHJlbikge1xuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICBmb3IgKHZhciBpPTAsIGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgcmV0ICs9IG15anNvbi5jaGlsZHJlbltpXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5YbWxKU09OLnByb3RvdHlwZS5uYW1lc3BhY2UgPSB7fVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLm51bWJlcm9mbm9kZXMgPSBmdW5jdGlvbiAobXlqc29uKSB7XG4gICAgaWYgKG15anNvbiAmJiBcIm51bWJlclwiID09IHR5cGVvZiBteWpzb24ubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBteWpzb24ubGVuZ3RoO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbn07XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuZ2V0QXR0cmlidXRlVmFsdWUgPSBmdW5jdGlvbiAobXlqc29uLG5hbWUsbmFtZXNwYWNlKSB7XG4gICAgdmFyIHJldCA9IFwiXCI7XG4gICAgaWYgKG5hbWVzcGFjZSkge1xuICAgICAgICBuYW1lID0gbmFtZXNwYWNlK1wiOlwiK25hbWU7XG4gICAgfVxuICAgIGlmIChteWpzb24pIHtcbiAgICAgICAgaWYgKG15anNvbi5hdHRycykge1xuICAgICAgICAgICAgaWYgKG15anNvbi5hdHRyc1tuYW1lXSkge1xuICAgICAgICAgICAgICAgIHJldCA9IG15anNvbi5hdHRyc1tuYW1lXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gXCJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmdldE5vZGVWYWx1ZSA9IGZ1bmN0aW9uIChteWpzb24sbmFtZSkge1xuICAgIHZhciByZXQgPSBcIlwiO1xuICAgIGlmIChuYW1lKXtcbiAgICAgICAgZm9yICh2YXIgaT0wLCBpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChteWpzb24uY2hpbGRyZW5baV0ubmFtZSA9PT0gbmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChteWpzb24uY2hpbGRyZW5baV0uY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldCA9IG15anNvbi5jaGlsZHJlbltpXTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXQgPSBcIlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAobXlqc29uKSB7XG4gICAgICAgIHJldCA9IG15anNvbjtcbiAgICB9XG4gICAgaWYgKHJldCAmJiByZXQuY2hpbGRyZW4gJiYgcmV0LmNoaWxkcmVuLmxlbmd0aCA9PSAxICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiByZXQuY2hpbGRyZW5bMF0pIHtcbiAgICAgICAgcmV0ID0gcmV0LmNoaWxkcmVuWzBdO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLnNldEF0dHJpYnV0ZU9uTm9kZUlkZW50aWZpZWRCeU5hbWVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobXlqc29uLG5vZGVuYW1lLHBhcnRuYW1lLGF0dHJuYW1lLHZhbCkge1xuICAgIHZhciBwb3MsIGxlbiwgeG1sLCBub2Rlcywgbm9kZTtcbiAgICBpZiAoYXR0cm5hbWUuc2xpY2UoMCwxKSA9PT0gJ0AnKXtcbiAgICAgICAgYXR0cm5hbWUgPSBhdHRybmFtZS5zbGljZSgxKTtcbiAgICB9XG4gICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDsgaTxpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKG15anNvbi5jaGlsZHJlbltpXS5uYW1lID09PSBub2RlbmFtZSAmJiBteWpzb24uY2hpbGRyZW5baV0uYXR0cnMubmFtZSA9PT0gcGFydG5hbWUpIHtcbiAgICAgICAgICAgIG15anNvbi5jaGlsZHJlbltpXS5hdHRyc1thdHRybmFtZV0gPSB2YWw7XG4gICAgICAgIH1cbiAgICB9XG59XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuZGVsZXRlTm9kZUJ5TmFtZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChteWpzb24sdmFsKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IG15anNvbi5jaGlsZHJlbi5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKCFteWpzb24uY2hpbGRyZW5baV0gfHwgXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG15anNvbi5jaGlsZHJlbltpXS5hdHRycy5uYW1lID09IHZhbCkge1xuICAgICAgICAgICAgbXlqc29uLmNoaWxkcmVuID0gbXlqc29uLmNoaWxkcmVuLnNsaWNlKDAsaSkuY29uY2F0KG15anNvbi5jaGlsZHJlbi5zbGljZShpKzEpKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5kZWxldGVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobXlqc29uLGF0dHJuYW1lKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiBteWpzb24uYXR0cnNbYXR0cm5hbWVdKSB7XG4gICAgICAgIG15anNvbi5hdHRycy5wb3AoYXR0cm5hbWUpO1xuICAgIH1cbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobXlqc29uLGF0dHIsdmFsKSB7XG4gICAgbXlqc29uLmF0dHJzW2F0dHJdID0gdmFsO1xuICAgIHJldHVybiBmYWxzZTtcbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5ub2RlQ29weSA9IGZ1bmN0aW9uIChteWpzb24sY2xvbmUpIHtcbiAgICBpZiAoIWNsb25lKSB7XG4gICAgICAgIHZhciBjbG9uZSA9IHt9O1xuICAgIH1cbiAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIGNsb25lICYmIFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBjbG9uZS5sZW5ndGgpIHtcbiAgICAgICAgZm9yICh2YXIga2V5IGluIG15anNvbikge1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBteWpzb25ba2V5XSkge1xuICAgICAgICAgICAgICAgIGNsb25lW2tleV0gPSBteWpzb25ba2V5XTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIG15anNvbltrZXldKSB7XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBteWpzb25ba2V5XS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xvbmVba2V5XSA9IHRoaXMubm9kZUNvcHkobXlqc29uW2tleV0se30pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNsb25lW2tleV0gPSB0aGlzLm5vZGVDb3B5KG15anNvbltrZXldLFtdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1teWpzb24ubGVuZ3RoO2k8aWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15anNvbltpXSkge1xuICAgICAgICAgICAgICAgIGNsb25lW2ldID0gbXlqc29uW2ldO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjbG9uZVtpXSA9IHRoaXMubm9kZUNvcHkobXlqc29uW2ldLHt9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gY2xvbmU7XG59XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuZ2V0Tm9kZXNCeU5hbWUgPSBmdW5jdGlvbiAobXlqc29uLG5hbWUsbmFtZWF0dHJ2YWwscmV0KSB7XG4gICAgdmFyIG5vZGVzLCBub2RlLCBwb3MsIGxlbjtcbiAgICBpZiAoIXJldCkge1xuICAgICAgICB2YXIgcmV0ID0gW107XG4gICAgfVxuICAgIGlmICghbXlqc29uIHx8ICFteWpzb24uY2hpbGRyZW4pIHtcbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG4gICAgaWYgKG5hbWUgPT09IG15anNvbi5uYW1lKSB7XG4gICAgICAgIGlmIChuYW1lYXR0cnZhbCkge1xuICAgICAgICAgICAgaWYgKG5hbWVhdHRydmFsID09PSBteWpzb24uYXR0cnMubmFtZSkge1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKG15anNvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXQucHVzaChteWpzb24pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krPTEpe1xuICAgICAgICBpZiAoXCJvYmplY3RcIiAhPT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5nZXROb2Rlc0J5TmFtZShteWpzb24uY2hpbGRyZW5baV0sbmFtZSxuYW1lYXR0cnZhbCxyZXQpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLm5vZGVOYW1lSXMgPSBmdW5jdGlvbiAobXlqc29uLG5hbWUpIHtcbiAgICBpZiAodHlwZW9mIG15anNvbiA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChuYW1lID09IG15anNvbi5uYW1lKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUubWFrZVhtbCA9IGZ1bmN0aW9uIChteWpzb24pIHtcbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15anNvbikge1xuICAgICAgICBpZiAobXlqc29uLnNsaWNlKDAsIDEpID09PSBcIjxcIikge1xuICAgICAgICAgICAgbXlqc29uID0gdGhpcy5qc29uU3RyaW5nV2Fsa2VyLndhbGtUb09iamVjdChteWpzb24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbXlqc29uID0gSlNPTi5wYXJzZShteWpzb24pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBteWpzb247XG59O1xuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmluc2VydENoaWxkTm9kZUFmdGVyID0gZnVuY3Rpb24gKHBhcmVudCxub2RlLHBvcyxkYXRlanNvbikge1xuICAgIGZvciAodmFyIGk9MCxpbGVuPXBhcmVudC5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgaWYgKG5vZGUgPT09IHBhcmVudC5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuID0gcGFyZW50LmNoaWxkcmVuLnNsaWNlKDAsaSkuY29uY2F0KFtkYXRlanNvbl0pLmNvbmNhdChwYXJlbnQuY2hpbGRyZW4uc2xpY2UoaSsxKSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGFyZW50O1xufTtcbkNTTC5YbWxKU09OLnByb3RvdHlwZS5pbnNlcnRQdWJsaXNoZXJBbmRQbGFjZSA9IGZ1bmN0aW9uKG15anNvbikge1xuICAgIGlmIChteWpzb24ubmFtZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICAgIHZhciB1c2VtZSA9IHRydWU7XG4gICAgICAgIHZhciBtdXN0SGF2ZXMgPSBbXCJwdWJsaXNoZXJcIixcInB1Ymxpc2hlci1wbGFjZVwiXTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgdmFyIGhhdmVWYXJuYW1lID0gbXVzdEhhdmVzLmluZGV4T2YobXlqc29uLmNoaWxkcmVuW2ldLmF0dHJzLnZhcmlhYmxlKTtcbiAgICAgICAgICAgIHZhciBpc1RleHQgPSBteWpzb24uY2hpbGRyZW5baV0ubmFtZSA9PT0gXCJ0ZXh0XCI7XG4gICAgICAgICAgICBpZiAoaXNUZXh0ICYmIGhhdmVWYXJuYW1lID4gLTEgJiYgIW15anNvbi5jaGlsZHJlbltpXS5hdHRycy5wcmVmaXggJiYgIW15anNvbi5jaGlsZHJlbltpXS5hdHRycy5zdWZmaXgpIHtcbiAgICAgICAgICAgICAgICBtdXN0SGF2ZXMgPSBtdXN0SGF2ZXMuc2xpY2UoMCxoYXZlVmFybmFtZSkuY29uY2F0KG11c3RIYXZlcy5zbGljZShoYXZlVmFybmFtZSsxKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHVzZW1lID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHVzZW1lICYmICFtdXN0SGF2ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBteWpzb24uYXR0cnNbXCJoYXMtcHVibGlzaGVyLWFuZC1wdWJsaXNoZXItcGxhY2VcIl0gPSB0cnVlO1xuICAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgdGhpcy5pbnNlcnRQdWJsaXNoZXJBbmRQbGFjZShteWpzb24uY2hpbGRyZW5baV0pO1xuICAgICAgICB9XG4gICAgfSAgICBcbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5pc0NoaWxkT2ZTdWJzdGl0dXRlID0gZnVuY3Rpb24ocGFyZW50cykge1xuICAgIGlmIChwYXJlbnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdmFyIG15cGFyZW50cyA9IHBhcmVudHMuc2xpY2UoKTtcbiAgICAgICAgdmFyIHBhcmVudCA9IG15cGFyZW50cy5wb3AoKTtcbiAgICAgICAgaWYgKHBhcmVudCA9PT0gXCJzdWJzdGl0dXRlXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNDaGlsZE9mU3Vic3RpdHV0ZShteXBhcmVudHMpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuYWRkTWlzc2luZ05hbWVOb2RlcyA9IGZ1bmN0aW9uKG15anNvbixwYXJlbnRzKSB7XG4gICAgaWYgKCFwYXJlbnRzKSB7XG4gICAgICAgIHBhcmVudHMgPSBbXTtcbiAgICB9XG4gICAgaWYgKG15anNvbi5uYW1lID09PSBcIm5hbWVzXCIpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzQ2hpbGRPZlN1YnN0aXR1dGUocGFyZW50cykpIHtcbiAgICAgICAgICAgIHZhciBhZGROYW1lID0gdHJ1ZTtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgIGlmIChteWpzb24uY2hpbGRyZW5baV0ubmFtZSA9PT0gXCJuYW1lXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkTmFtZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYWRkTmFtZSkge1xuICAgICAgICAgICAgICAgIG15anNvbi5jaGlsZHJlbiA9IFt7bmFtZTpcIm5hbWVcIixhdHRyczp7fSxjaGlsZHJlbjpbXX1dLmNvbmNhdChteWpzb24uY2hpbGRyZW4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHBhcmVudHMucHVzaChteWpzb24ubmFtZSk7XG4gICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgdGhpcy5hZGRNaXNzaW5nTmFtZU5vZGVzKG15anNvbi5jaGlsZHJlbltpXSxwYXJlbnRzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwYXJlbnRzLnBvcCgpO1xufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmFkZEluc3RpdHV0aW9uTm9kZXMgPSBmdW5jdGlvbihteWpzb24pIHtcbiAgICB2YXIgbmFtZXMsIHRoZW5hbWVzLCBpbnN0aXR1dGlvbiwgdGhlaW5zdGl0dXRpb24sIG5hbWUsIHRoZW5hbWUsIHhtbCwgcG9zLCBsZW47XG4gICAgaWYgKG15anNvbi5uYW1lID09PSBcIm5hbWVzXCIpIHtcbiAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSB7fTtcbiAgICAgICAgdmFyIGluc2VydFBvcyA9IC0xO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1teWpzb24uY2hpbGRyZW4ubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICBpZiAobXlqc29uLmNoaWxkcmVuW2ldLm5hbWUgPT0gXCJuYW1lXCIpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbXlqc29uLmNoaWxkcmVuW2ldLmF0dHJzKSB7XG4gICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXNba2V5XSA9IG15anNvbi5jaGlsZHJlbltpXS5hdHRyc1trZXldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLmRlbGltaXRlciA9IG15anNvbi5jaGlsZHJlbltpXS5hdHRycy5kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgYXR0cmlidXRlcy5hbmQgPSBteWpzb24uY2hpbGRyZW5baV0uYXR0cnMuYW5kO1xuICAgICAgICAgICAgICAgIGluc2VydFBvcyA9IGk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaz0wLGtsZW49bXlqc29uLmNoaWxkcmVuW2ldLmNoaWxkcmVuLmxlbmd0aDtrPGtsZW47ays9MSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAobXlqc29uLmNoaWxkcmVuW2ldLmNoaWxkcmVuW2tdLmF0dHJzLm5hbWUgIT09ICdmYW1pbHknKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbXlqc29uLmNoaWxkcmVuW2ldLmNoaWxkcmVuW2tdLmF0dHJzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzW2tleV0gPSBteWpzb24uY2hpbGRyZW5baV0uY2hpbGRyZW5ba10uYXR0cnNba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChteWpzb24uY2hpbGRyZW5baV0ubmFtZSA9PSBcImluc3RpdHV0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICBpbnNlcnRQb3MgPSAtMTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoaW5zZXJ0UG9zID4gLTEpIHtcbiAgICAgICAgICAgIHZhciBpbnN0aXR1dGlvbiA9IHRoaXMubm9kZUNvcHkodGhpcy5pbnN0aXR1dGlvbik7XG4gICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbiA9IENTTC5JTlNUSVRVVElPTl9LRVlTLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgICAgIHZhciBhdHRybmFtZSA9IENTTC5JTlNUSVRVVElPTl9LRVlTW2ldO1xuICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgYXR0cmlidXRlc1thdHRybmFtZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGl0dXRpb24uY2hpbGRyZW5bMF0uYXR0cnNbYXR0cm5hbWVdID0gYXR0cmlidXRlc1thdHRybmFtZV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmRlbGltaXRlcikge1xuICAgICAgICAgICAgICAgICAgICBpbnN0aXR1dGlvbi5hdHRycy5kZWxpbWl0ZXIgPSBhdHRyaWJ1dGVzLmRlbGltaXRlcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuYW5kKSB7XG4gICAgICAgICAgICAgICAgICAgIGluc3RpdHV0aW9uLmF0dHJzLmFuZCA9IFwidGV4dFwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG15anNvbi5jaGlsZHJlbiA9IG15anNvbi5jaGlsZHJlbi5zbGljZSgwLGluc2VydFBvcysxKS5jb25jYXQoW2luc3RpdHV0aW9uXSkuY29uY2F0KG15anNvbi5jaGlsZHJlbi5zbGljZShpbnNlcnRQb3MrMSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBteWpzb24uY2hpbGRyZW5baV0pIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuYWRkSW5zdGl0dXRpb25Ob2RlcyhteWpzb24uY2hpbGRyZW5baV0pO1xuICAgIH1cbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5mbGFnRGF0ZU1hY3JvcyA9IGZ1bmN0aW9uKG15anNvbikge1xuICAgIGZvciAodmFyIGk9MCxpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgaWYgKG15anNvbi5jaGlsZHJlbltpXS5uYW1lID09PSBcIm1hY3JvXCIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmluc3BlY3REYXRlTWFjcm9zKG15anNvbi5jaGlsZHJlbltpXSkpIHtcbiAgICAgICAgICAgICAgICBteWpzb24uY2hpbGRyZW5baV0uYXR0cnNbXCJtYWNyby1oYXMtZGF0ZVwiXSA9IFwidHJ1ZVwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmluc3BlY3REYXRlTWFjcm9zID0gZnVuY3Rpb24obXlqc29uKSB7XG4gICAgaWYgKCFteWpzb24gfHwgIW15anNvbi5jaGlsZHJlbikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChteWpzb24ubmFtZSA9PT0gXCJkYXRlXCIpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuaW5zcGVjdERhdGVNYWNyb3MobXlqc29uLmNoaWxkcmVuW2ldKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cbkNTTC5zdHJpcFhtbFByb2Nlc3NpbmdJbnN0cnVjdGlvbiA9IGZ1bmN0aW9uICh4bWwpIHtcbiAgICBpZiAoIXhtbCkge1xuICAgICAgICByZXR1cm4geG1sO1xuICAgIH1cbiAgICB4bWwgPSB4bWwucmVwbGFjZSgvXjxcXD9bXj9dK1xcPz4vLCBcIlwiKTtcbiAgICB4bWwgPSB4bWwucmVwbGFjZSgvPCEtLVtePl0rLS0+L2csIFwiXCIpO1xuICAgIHhtbCA9IHhtbC5yZXBsYWNlKC9eXFxzKy9nLCBcIlwiKTtcbiAgICB4bWwgPSB4bWwucmVwbGFjZSgvXFxzKyQvZywgXCJcIik7XG4gICAgcmV0dXJuIHhtbDtcbn07XG5DU0wucGFyc2VYbWwgPSBmdW5jdGlvbihzdHIpIHtcbiAgICB2YXIgX3BvcyA9IDA7XG4gICAgdmFyIF9vYmogPSB7Y2hpbGRyZW46W119O1xuICAgIHZhciBfc3RhY2sgPSBbX29iai5jaGlsZHJlbl07XG4gICAgZnVuY3Rpb24gX2xpc3RpZnlTdHJpbmcoc3RyKSB7XG4gICAgICAgIHN0ciA9IHN0ci5zcGxpdCgvKD86XFxyXFxufFxcbnxcXHIpLykuam9pbihcIiBcIikucmVwbGFjZSgvPltcdCBdKzwvZywgXCI+PFwiKS5yZXBsYWNlKC88XFwhLS0uKj8tLT4vZywgXCJcIik7XG4gICAgICAgIHZhciBsc3QgPSBzdHIuc3BsaXQoXCI+PFwiKTtcbiAgICAgICAgdmFyIHN0eWxlUG9zID0gbnVsbDtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bHN0Lmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICBpZiAoaSA+IDApIHtcbiAgICAgICAgICAgICAgICBsc3RbaV0gPSBcIjxcIiArIGxzdFtpXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpIDwgKGxzdC5sZW5ndGgtMSkpIHtcbiAgICAgICAgICAgICAgICBsc3RbaV0gPSBsc3RbaV0gKyBcIj5cIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChcIm51bWJlclwiICE9IHR5cGVvZiBzdHlsZVBvcykge1xuICAgICAgICAgICAgICAgIGlmIChsc3RbaV0uc2xpY2UoMCwgNykgPT09IFwiPHN0eWxlIFwiIHx8IGxzdFtpXS5zbGljZSgwLCA4KSA9PSBcIjxsb2NhbGUgXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3R5bGVQb3MgPSBpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsc3QgPSBsc3Quc2xpY2Uoc3R5bGVQb3MpO1xuICAgICAgICBmb3IgKHZhciBpPWxzdC5sZW5ndGgtMjtpPi0xO2ktLSkge1xuICAgICAgICAgICAgaWYgKGxzdFtpXS5zbGljZSgxKS5pbmRleE9mKFwiPFwiKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICB2YXIgc3R1YiA9IGxzdFtpXS5zbGljZSgwLCA1KTtcbiAgICAgICAgICAgICAgICBpZiAobHN0W2ldLnNsaWNlKC0yKSAhPT0gXCIvPlwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdHViID09PSBcIjx0ZXJtXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsc3RbaSsxXS5zbGljZSgwLCA2KSA9PT0gXCI8L3Rlcm1cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxzdFtpXSA9IGxzdFtpXSArIGxzdFtpKzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxzdCA9IGxzdC5zbGljZSgwLCBpKzEpLmNvbmNhdChsc3Quc2xpY2UoaSsyKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoW1wiPHNpbmdcIiwgXCI8bXVsdFwiXS5pbmRleE9mKHN0dWIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsc3RbaV0uc2xpY2UoLTIpICE9PSBcIi8+XCIgJiYgbHN0W2krMV0uc2xpY2UoMCwgMSkgPT09IFwiPFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbHN0W2ldID0gbHN0W2ldICsgbHN0W2krMV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbHN0ID0gbHN0LnNsaWNlKDAsIGkrMSkuY29uY2F0KGxzdC5zbGljZShpKzIpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbHN0O1xuICAgIH1cbiAgICBmdW5jdGlvbiBfZGVjb2RlSHRtbEVudGl0aWVzKHN0cikge1xuICAgICAgICByZXR1cm4gc3RyXG4gICAgICAgICAgICAuc3BsaXQoXCImYW1wO1wiKS5qb2luKFwiJlwiKVxuICAgICAgICAgICAgLnNwbGl0KFwiJnF1b3Q7XCIpLmpvaW4oXCJcXFwiXCIpXG4gICAgICAgICAgICAuc3BsaXQoXCImZ3Q7XCIpLmpvaW4oXCI+XCIpLnNwbGl0KFwiJmx0O1wiKS5qb2luKFwiPFwiKVxuICAgICAgICAgICAgLnJlcGxhY2UoLyYjKFswLTldezEsNn0pOy9naSwgZnVuY3Rpb24obWF0Y2gsIG51bVN0cikge1xuICAgICAgICAgICAgICAgIHZhciBudW0gPSBwYXJzZUludChudW1TdHIsIDEwKTsgLy8gcmVhZCBudW0gYXMgbm9ybWFsIG51bWJlclxuICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKG51bSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnJlcGxhY2UoLyYjeChbYS1mMC05XXsxLDZ9KTsvZ2ksIGZ1bmN0aW9uKG1hdGNoLCBudW1TdHIpe1xuICAgICAgICAgICAgICAgIHZhciBudW0gPSBwYXJzZUludChudW1TdHIsIDE2KTsgLy8gcmVhZCBudW0gYXMgaGV4XG4gICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUobnVtKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cbiAgICBmdW5jdGlvbiBfZ2V0QXR0cmlidXRlcyhlbGVtKSB7XG4gICAgICAgIHZhciBtID0gZWxlbS5tYXRjaCgvKFteXFwnXFxcIj1cdCBdKyk9KD86XFxcIlteXFxcIl0qXFxcInxcXCdbXlxcJ10qXFwnKS9nKTtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPW0ubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICBtW2ldID0gbVtpXS5yZXBsYWNlKC89LiovLCBcIlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbTtcbiAgICB9XG4gICAgZnVuY3Rpb24gX2dldEF0dHJpYnV0ZShlbGVtLCBhdHRyKSB7XG4gICAgICAgIHZhciByZXggPSBSZWdFeHAoJ14uKltcdCBdKycgKyBhdHRyICsgJz0oXFxcIig/OlteXFxcIl0qKVxcXCJ8XFwnKD86W15cXCddKilcXCcpLiokJyk7XG4gICAgICAgIHZhciBtID0gZWxlbS5tYXRjaChyZXgpO1xuICAgICAgICByZXR1cm4gbSA/IG1bMV0uc2xpY2UoMSwgLTEpIDogbnVsbDtcbiAgICB9XG4gICAgZnVuY3Rpb24gX2dldFRhZ05hbWUoZWxlbSkge1xuICAgICAgICB2YXIgcmV4ID0gUmVnRXhwKFwiXjwoW15cdCAvPl0rKVwiKTtcbiAgICAgICAgdmFyIG0gPSBlbGVtLm1hdGNoKHJleCk7XG4gICAgICAgIHJldHVybiBtID8gbVsxXSA6IG51bGw7XG4gICAgfVxuICAgIGZ1bmN0aW9uIF9jYXN0T2JqZWN0RnJvbU9wZW5pbmdUYWcoZWxlbSkge1xuICAgICAgICB2YXIgb2JqID0ge307XG4gICAgICAgIG9iai5uYW1lID0gX2dldFRhZ05hbWUoZWxlbSk7XG4gICAgICAgIG9iai5hdHRycyA9IHt9O1xuICAgICAgICB2YXIgYXR0cmlidXRlcyA9IF9nZXRBdHRyaWJ1dGVzKGVsZW0pO1xuICAgICAgICBpZiAoYXR0cmlidXRlcykge1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49YXR0cmlidXRlcy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgIHZhciBhdHRyID0ge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBhdHRyaWJ1dGVzW2ldLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogX2dldEF0dHJpYnV0ZShlbGVtLCBhdHRyaWJ1dGVzW2ldKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBvYmouYXR0cnNbYXR0ci5uYW1lXSA9IF9kZWNvZGVIdG1sRW50aXRpZXMoYXR0ci52YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgb2JqLmNoaWxkcmVuID0gW107XG4gICAgICAgIHJldHVybiBvYmo7XG4gICAgfVxuICAgIGZ1bmN0aW9uIF9leHRyYWN0VGV4dEZyb21Db21wb3NpdGVFbGVtZW50KGVsZW0pIHtcbiAgICAgICAgdmFyIG0gPSBlbGVtLm1hdGNoKC9eLio+KFtePF0qKTwuKiQvKTtcbiAgICAgICAgcmV0dXJuIF9kZWNvZGVIdG1sRW50aXRpZXMobVsxXSk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIF9hcHBlbmRUb0NoaWxkcmVuKG9iaikge1xuICAgICAgICBfc3RhY2suc2xpY2UoLTEpWzBdLnB1c2gob2JqKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gX2V4dGVuZFN0YWNrV2l0aE5ld0NoaWxkcmVuKG9iaikge1xuICAgICAgICBfc3RhY2sucHVzaChvYmouY2hpbGRyZW4pO1xuICAgIH1cbiAgICBmdW5jdGlvbiBwcm9jZXNzRWxlbWVudChlbGVtKSB7XG4gICAgICAgIHZhciBvYmo7XG4gICAgICAgIGlmIChlbGVtLnNsaWNlKDEpLmluZGV4T2YoJzwnKSA+IC0xKSB7XG4gICAgICAgICAgICB2YXIgdGFnID0gZWxlbS5zbGljZSgwLCBlbGVtLmluZGV4T2YoJz4nKSsxKTtcbiAgICAgICAgICAgIG9iaiA9IF9jYXN0T2JqZWN0RnJvbU9wZW5pbmdUYWcodGFnKTtcbiAgICAgICAgICAgIG9iai5jaGlsZHJlbiA9IFtfZXh0cmFjdFRleHRGcm9tQ29tcG9zaXRlRWxlbWVudChlbGVtKV07XG4gICAgICAgICAgICBfYXBwZW5kVG9DaGlsZHJlbihvYmopO1xuICAgICAgICB9IGVsc2UgaWYgKGVsZW0uc2xpY2UoLTIpID09PSAnLz4nKSB7XG4gICAgICAgICAgICBvYmogPSBfY2FzdE9iamVjdEZyb21PcGVuaW5nVGFnKGVsZW0pO1xuICAgICAgICAgICAgaWYgKF9nZXRUYWdOYW1lKGVsZW0pID09PSAndGVybScpIHtcbiAgICAgICAgICAgICAgICBvYmouY2hpbGRyZW4ucHVzaCgnJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfYXBwZW5kVG9DaGlsZHJlbihvYmopO1xuICAgICAgICB9IGVsc2UgaWYgKGVsZW0uc2xpY2UoMCwgMikgPT09ICc8LycpIHtcbiAgICAgICAgICAgIF9zdGFjay5wb3AoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9iaiA9IF9jYXN0T2JqZWN0RnJvbU9wZW5pbmdUYWcoZWxlbSk7XG4gICAgICAgICAgICBfYXBwZW5kVG9DaGlsZHJlbihvYmopXG4gICAgICAgICAgICBfZXh0ZW5kU3RhY2tXaXRoTmV3Q2hpbGRyZW4ob2JqKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgbHN0ID0gX2xpc3RpZnlTdHJpbmcoc3RyKTtcbiAgICBmb3IgKHZhciBpPTAsaWxlbj1sc3QubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgdmFyIGVsZW0gPSBsc3RbaV07XG4gICAgICAgIHByb2Nlc3NFbGVtZW50KGVsZW0pO1xuICAgIH1cbiAgICByZXR1cm4gX29iai5jaGlsZHJlblswXTtcbn1cbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlhtbERPTSA9IGZ1bmN0aW9uIChkYXRhT2JqKSB7XG4gICAgdGhpcy5kYXRhT2JqID0gZGF0YU9iajtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PSB0eXBlb2YgRE9NUGFyc2VyKSB7XG4gICAgICAgIERPTVBhcnNlciA9IGZ1bmN0aW9uKCkge307XG4gICAgICAgIERPTVBhcnNlci5wcm90b3R5cGUucGFyc2VGcm9tU3RyaW5nID0gZnVuY3Rpb24oc3RyLCBjb250ZW50VHlwZSkge1xuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mIEFjdGl2ZVhPYmplY3QpIHtcbiAgICAgICAgICAgICAgICB2YXIgeG1sZGF0YSA9IG5ldyBBY3RpdmVYT2JqZWN0KCdNU1hNTC5Eb21Eb2N1bWVudCcpO1xuICAgICAgICAgICAgICAgIHhtbGRhdGEuYXN5bmMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB4bWxkYXRhLmxvYWRYTUwoc3RyKTtcbiAgICAgICAgICAgICAgICByZXR1cm4geG1sZGF0YTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2YgWE1MSHR0cFJlcXVlc3QpIHtcbiAgICAgICAgICAgICAgICB2YXIgeG1sZGF0YSA9IG5ldyBYTUxIdHRwUmVxdWVzdDtcbiAgICAgICAgICAgICAgICBpZiAoIWNvbnRlbnRUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlID0gJ3RleHQveG1sJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgeG1sZGF0YS5vcGVuKCdHRVQnLCAnZGF0YTonICsgY29udGVudFR5cGUgKyAnO2NoYXJzZXQ9dXRmLTgsJyArIGVuY29kZVVSSUNvbXBvbmVudChzdHIpLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgaWYoeG1sZGF0YS5vdmVycmlkZU1pbWVUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIHhtbGRhdGEub3ZlcnJpZGVNaW1lVHlwZShjb250ZW50VHlwZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHhtbGRhdGEuc2VuZChudWxsKTtcbiAgICAgICAgICAgICAgICByZXR1cm4geG1sZGF0YS5yZXNwb25zZVhNTDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2YgbWFya25vdGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgcGFyc2VyID0gbmV3IG1hcmtub3RlLlBhcnNlcigpO1xuICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZXIucGFyc2Uoc3RyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5oYXNBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgICAgICAgIHZhciByZXQ7XG4gICAgICAgICAgICBpZiAobm9kZS5hdHRyaWJ1dGVzICYmIG5vZGUuYXR0cmlidXRlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXQgPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXQgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5oYXNBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgICAgICAgIHZhciByZXQ7XG4gICAgICAgICAgICBpZiAobm9kZS5hdHRyaWJ1dGVzICYmIG5vZGUuYXR0cmlidXRlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXQgPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXQgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgIH07XG4gICAgfVxuICAgIHRoaXMuaW1wb3J0Tm9kZSA9IGZ1bmN0aW9uIChkb2MsIHNyY0VsZW1lbnQpIHtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT0gdHlwZW9mIGRvYy5pbXBvcnROb2RlKSB7XG4gICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5faW1wb3J0Tm9kZShkb2MsIHNyY0VsZW1lbnQsIHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIHJldCA9IGRvYy5pbXBvcnROb2RlKHNyY0VsZW1lbnQsIHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcbiAgICB0aGlzLl9pbXBvcnROb2RlID0gZnVuY3Rpb24oZG9jLCBub2RlLCBhbGxDaGlsZHJlbikge1xuICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICB2YXIgbmV3Tm9kZSA9IGRvYy5jcmVhdGVFbGVtZW50KG5vZGUubm9kZU5hbWUpO1xuICAgICAgICAgICAgICAgIGlmIChub2RlLmF0dHJpYnV0ZXMgJiYgbm9kZS5hdHRyaWJ1dGVzLmxlbmd0aCA+IDApXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbCA9IG5vZGUuYXR0cmlidXRlcy5sZW5ndGg7IGkgPCBpbDspXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdOb2RlLnNldEF0dHJpYnV0ZShub2RlLmF0dHJpYnV0ZXNbaV0ubm9kZU5hbWUsIG5vZGUuZ2V0QXR0cmlidXRlKG5vZGUuYXR0cmlidXRlc1tpKytdLm5vZGVOYW1lKSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbGxDaGlsZHJlbiAmJiBub2RlLmNoaWxkTm9kZXMgJiYgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aCA+IDApXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWwgPSBub2RlLmNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgaWw7KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld05vZGUuYXBwZW5kQ2hpbGQodGhpcy5faW1wb3J0Tm9kZShkb2MsIG5vZGUuY2hpbGROb2Rlc1tpKytdLCBhbGxDaGlsZHJlbikpO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXdOb2RlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAzOlxuICAgICAgICAgICAgY2FzZSA0OlxuICAgICAgICAgICAgY2FzZSA4OlxuICAgICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnBhcnNlciA9IG5ldyBET01QYXJzZXIoKTtcbiAgICB2YXIgc3RyID0gXCI8ZG9jY28+PGluc3RpdHV0aW9uIGluc3RpdHV0aW9uLXBhcnRzPVxcXCJsb25nXFxcIiBkZWxpbWl0ZXI9XFxcIiwgXFxcIiBzdWJzdGl0dXRlLXVzZS1maXJzdD1cXFwiMVxcXCIgdXNlLWxhc3Q9XFxcIjFcXFwiPjxpbnN0aXR1dGlvbi1wYXJ0IG5hbWU9XFxcImxvbmdcXFwiLz48L2luc3RpdHV0aW9uPjwvZG9jY28+XCI7XG4gICAgdmFyIGluc3RfZG9jID0gdGhpcy5wYXJzZXIucGFyc2VGcm9tU3RyaW5nKHN0ciwgXCJ0ZXh0L3htbFwiKTtcbiAgICB2YXIgaW5zdF9ub2RlID0gaW5zdF9kb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJpbnN0aXR1dGlvblwiKTtcbiAgICB0aGlzLmluc3RpdHV0aW9uID0gaW5zdF9ub2RlLml0ZW0oMCk7XG4gICAgdmFyIGluc3RfcGFydF9ub2RlID0gaW5zdF9kb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJpbnN0aXR1dGlvbi1wYXJ0XCIpO1xuICAgIHRoaXMuaW5zdGl0dXRpb25wYXJ0ID0gaW5zdF9wYXJ0X25vZGUuaXRlbSgwKTtcbiAgICB0aGlzLm5zID0gXCJodHRwOi8vcHVybC5vcmcvbmV0L3hiaWJsaW8vY3NsXCI7XG59O1xuQ1NMLlhtbERPTS5wcm90b3R5cGUuY2xlYW4gPSBmdW5jdGlvbiAoeG1sKSB7XG4gICAgeG1sID0geG1sLnJlcGxhY2UoLzxcXD9bXj9dK1xcPz4vZywgXCJcIik7XG4gICAgeG1sID0geG1sLnJlcGxhY2UoLzwhW14+XSs+L2csIFwiXCIpO1xuICAgIHhtbCA9IHhtbC5yZXBsYWNlKC9eXFxzKy8sIFwiXCIpO1xuICAgIHhtbCA9IHhtbC5yZXBsYWNlKC9cXHMrJC8sIFwiXCIpO1xuICAgIHhtbCA9IHhtbC5yZXBsYWNlKC9eXFxuKi8sIFwiXCIpO1xuICAgIHJldHVybiB4bWw7XG59O1xuQ1NMLlhtbERPTS5wcm90b3R5cGUuZ2V0U3R5bGVJZCA9IGZ1bmN0aW9uIChteXhtbCwgc3R5bGVOYW1lKSB7XG4gICAgdmFyIHRleHQgPSBcIlwiO1xuICAgIHZhciB0YWdOYW1lID0gXCJpZFwiO1xuICAgIGlmIChzdHlsZU5hbWUpIHtcbiAgICAgICAgdGFnTmFtZSA9IFwidGl0bGVcIjtcbiAgICB9XG4gICAgdmFyIG5vZGUgPSBteXhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWdOYW1lKTtcbiAgICBpZiAobm9kZSAmJiBub2RlLmxlbmd0aCkge1xuICAgICAgICBub2RlID0gbm9kZS5pdGVtKDApO1xuICAgIH1cbiAgICBpZiAobm9kZSkge1xuICAgICAgICB0ZXh0ID0gbm9kZS50ZXh0Q29udGVudDtcbiAgICB9XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICAgIHRleHQgPSBub2RlLmlubmVyVGV4dDtcbiAgICB9XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICAgIHRleHQgPSBub2RlLmlubmVySFRNTDtcbiAgICB9XG4gICAgcmV0dXJuIHRleHQ7XG59O1xuQ1NMLlhtbERPTS5wcm90b3R5cGUuY2hpbGRyZW4gPSBmdW5jdGlvbiAobXl4bWwpIHtcbiAgICB2YXIgY2hpbGRyZW4sIHBvcywgbGVuLCByZXQ7XG4gICAgaWYgKG15eG1sKSB7XG4gICAgICAgIHJldCA9IFtdO1xuICAgICAgICBjaGlsZHJlbiA9IG15eG1sLmNoaWxkTm9kZXM7XG4gICAgICAgIGZvciAocG9zID0gMCwgbGVuID0gY2hpbGRyZW4ubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICBpZiAoY2hpbGRyZW5bcG9zXS5ub2RlTmFtZSAhPSBcIiN0ZXh0XCIpIHtcbiAgICAgICAgICAgICAgICByZXQucHVzaChjaGlsZHJlbltwb3NdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG59O1xuQ1NMLlhtbERPTS5wcm90b3R5cGUubm9kZW5hbWUgPSBmdW5jdGlvbiAobXl4bWwpIHtcbiAgICB2YXIgcmV0ID0gbXl4bWwubm9kZU5hbWU7XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5hdHRyaWJ1dGVzID0gZnVuY3Rpb24gKG15eG1sKSB7XG4gICAgdmFyIHJldCwgYXR0cnMsIGF0dHIsIGtleSwgeG1sLCBwb3MsIGxlbjtcbiAgICByZXQgPSBuZXcgT2JqZWN0KCk7XG4gICAgaWYgKG15eG1sICYmIHRoaXMuaGFzQXR0cmlidXRlcyhteXhtbCkpIHtcbiAgICAgICAgYXR0cnMgPSBteXhtbC5hdHRyaWJ1dGVzO1xuICAgICAgICBmb3IgKHBvcyA9IDAsIGxlbj1hdHRycy5sZW5ndGg7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIGF0dHIgPSBhdHRyc1twb3NdO1xuICAgICAgICAgICAgcmV0W1wiQFwiICsgYXR0ci5uYW1lXSA9IGF0dHIudmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5jb250ZW50ID0gZnVuY3Rpb24gKG15eG1sKSB7XG4gICAgdmFyIHJldDtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2YgbXl4bWwudGV4dENvbnRlbnQpIHtcbiAgICAgICAgcmV0ID0gbXl4bWwudGV4dENvbnRlbnQ7XG4gICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiICE9IHR5cGVvZiBteXhtbC5pbm5lclRleHQpIHtcbiAgICAgICAgcmV0ID0gbXl4bWwuaW5uZXJUZXh0O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldCA9IG15eG1sLnR4dDtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5uYW1lc3BhY2UgPSB7XG4gICAgXCJ4bWxcIjpcImh0dHA6Ly93d3cudzMub3JnL1hNTC8xOTk4L25hbWVzcGFjZVwiXG59XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5udW1iZXJvZm5vZGVzID0gZnVuY3Rpb24gKG15eG1sKSB7XG4gICAgaWYgKG15eG1sKSB7XG4gICAgICAgIHJldHVybiBteXhtbC5sZW5ndGg7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxufTtcbkNTTC5YbWxET00ucHJvdG90eXBlLmdldEF0dHJpYnV0ZU5hbWUgPSBmdW5jdGlvbiAoYXR0cikge1xuICAgIHZhciByZXQgPSBhdHRyLm5hbWU7XG4gICAgcmV0dXJuIHJldDtcbn1cbkNTTC5YbWxET00ucHJvdG90eXBlLmdldEF0dHJpYnV0ZVZhbHVlID0gZnVuY3Rpb24gKG15eG1sLG5hbWUsbmFtZXNwYWNlKSB7XG4gICAgdmFyIHJldCA9IFwiXCI7XG4gICAgaWYgKG5hbWVzcGFjZSkge1xuICAgICAgICBuYW1lID0gbmFtZXNwYWNlK1wiOlwiK25hbWU7XG4gICAgfVxuICAgIGlmIChteXhtbCAmJiB0aGlzLmhhc0F0dHJpYnV0ZXMobXl4bWwpICYmIG15eG1sLmdldEF0dHJpYnV0ZShuYW1lKSkge1xuICAgICAgICByZXQgPSBteXhtbC5nZXRBdHRyaWJ1dGUobmFtZSk7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5nZXROb2RlVmFsdWUgPSBmdW5jdGlvbiAobXl4bWwsbmFtZSkge1xuICAgIHZhciByZXQgPSBudWxsO1xuICAgIGlmIChuYW1lKXtcbiAgICAgICAgdmFyIHZhbHMgPSBteXhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKTtcbiAgICAgICAgaWYgKHZhbHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mIHZhbHNbMF0udGV4dENvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICByZXQgPSB2YWxzWzBdLnRleHRDb250ZW50O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiICE9IHR5cGVvZiB2YWxzWzBdLmlubmVyVGV4dCkge1xuICAgICAgICAgICAgICAgIHJldCA9IHZhbHNbMF0uaW5uZXJUZXh0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXQgPSB2YWxzWzBdLnRleHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHJldCA9PT0gbnVsbCAmJiBteXhtbCAmJiBteXhtbC5jaGlsZE5vZGVzICYmIChteXhtbC5jaGlsZE5vZGVzLmxlbmd0aCA9PSAwIHx8IChteXhtbC5jaGlsZE5vZGVzLmxlbmd0aCA9PSAxICYmIG15eG1sLmZpcnN0Q2hpbGQubm9kZU5hbWUgPT0gXCIjdGV4dFwiKSkpIHtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mIG15eG1sLnRleHRDb250ZW50KSB7XG4gICAgICAgICAgICByZXQgPSBteXhtbC50ZXh0Q29udGVudDtcbiAgICAgICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiICE9IHR5cGVvZiBteXhtbC5pbm5lclRleHQpIHtcbiAgICAgICAgICAgIHJldCA9IG15eG1sLmlubmVyVGV4dDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldCA9IG15eG1sLnRleHQ7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHJldCA9PT0gbnVsbCkge1xuICAgICAgICByZXQgPSBteXhtbDtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn1cbkNTTC5YbWxET00ucHJvdG90eXBlLnNldEF0dHJpYnV0ZU9uTm9kZUlkZW50aWZpZWRCeU5hbWVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobXl4bWwsbm9kZW5hbWUscGFydG5hbWUsYXR0cm5hbWUsdmFsKSB7XG4gICAgdmFyIHBvcywgbGVuLCB4bWwsIG5vZGVzLCBub2RlO1xuICAgIGlmIChhdHRybmFtZS5zbGljZSgwLDEpID09PSAnQCcpe1xuICAgICAgICBhdHRybmFtZSA9IGF0dHJuYW1lLnNsaWNlKDEpO1xuICAgIH1cbiAgICBub2RlcyA9IG15eG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKG5vZGVuYW1lKTtcbiAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IG5vZGVzLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBub2RlID0gbm9kZXNbcG9zXTtcbiAgICAgICAgaWYgKG5vZGUuZ2V0QXR0cmlidXRlKFwibmFtZVwiKSAhPSBwYXJ0bmFtZSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoYXR0cm5hbWUsIHZhbCk7XG4gICAgfVxufVxuQ1NMLlhtbERPTS5wcm90b3R5cGUuZGVsZXRlTm9kZUJ5TmFtZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChteXhtbCx2YWwpIHtcbiAgICB2YXIgcG9zLCBsZW4sIG5vZGUsIG5vZGVzO1xuICAgIG5vZGVzID0gbXl4bWwuY2hpbGROb2RlcztcbiAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IG5vZGVzLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBub2RlID0gbm9kZXNbcG9zXTtcbiAgICAgICAgaWYgKCFub2RlIHx8IG5vZGUubm9kZVR5cGUgPT0gbm9kZS5URVhUX05PREUpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmhhc0F0dHJpYnV0ZXMobm9kZSkgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoXCJuYW1lXCIpID09IHZhbCkge1xuICAgICAgICAgICAgbXl4bWwucmVtb3ZlQ2hpbGQobm9kZXNbcG9zXSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5kZWxldGVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobXl4bWwsYXR0cikge1xuICAgIG15eG1sLnJlbW92ZUF0dHJpYnV0ZShhdHRyKTtcbn1cbkNTTC5YbWxET00ucHJvdG90eXBlLnNldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChteXhtbCxhdHRyLHZhbCkge1xuICAgIGlmICghbXl4bWwub3duZXJEb2N1bWVudCkge1xuICAgICAgICBteXhtbCA9IG15eG1sLmZpcnN0Q2hpbGQ7XG4gICAgfVxuICAgIGlmIChbXCJmdW5jdGlvblwiLCBcInVua25vd25cIl0uaW5kZXhPZih0eXBlb2YgbXl4bWwuc2V0QXR0cmlidXRlKSA+IC0xKSB7XG4gICAgICAgIG15eG1sLnNldEF0dHJpYnV0ZShhdHRyLCB2YWwpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5ub2RlQ29weSA9IGZ1bmN0aW9uIChteXhtbCkge1xuICAgIHZhciBjbG9uZWRfbm9kZSA9IG15eG1sLmNsb25lTm9kZSh0cnVlKTtcbiAgICByZXR1cm4gY2xvbmVkX25vZGU7XG59XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5nZXROb2Rlc0J5TmFtZSA9IGZ1bmN0aW9uIChteXhtbCxuYW1lLG5hbWVhdHRydmFsKSB7XG4gICAgdmFyIHJldCwgbm9kZXMsIG5vZGUsIHBvcywgbGVuO1xuICAgIHJldCA9IFtdO1xuICAgIG5vZGVzID0gbXl4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUobmFtZSk7XG4gICAgZm9yIChwb3MgPSAwLCBsZW4gPSBub2Rlcy5sZW5ndGg7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgbm9kZSA9IG5vZGVzLml0ZW0ocG9zKTtcbiAgICAgICAgaWYgKG5hbWVhdHRydmFsICYmICEodGhpcy5oYXNBdHRyaWJ1dGVzKG5vZGUpICYmIG5vZGUuZ2V0QXR0cmlidXRlKFwibmFtZVwiKSA9PSBuYW1lYXR0cnZhbCkpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldC5wdXNoKG5vZGUpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLlhtbERPTS5wcm90b3R5cGUubm9kZU5hbWVJcyA9IGZ1bmN0aW9uIChteXhtbCxuYW1lKSB7XG4gICAgaWYgKG5hbWUgPT0gbXl4bWwubm9kZU5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cbkNTTC5YbWxET00ucHJvdG90eXBlLm1ha2VYbWwgPSBmdW5jdGlvbiAobXl4bWwpIHtcbiAgICB2YXIgcmV0LCB0b3Bub2RlO1xuICAgIGlmICghbXl4bWwpIHtcbiAgICAgICAgbXl4bWwgPSBcIjxkb2Njbz48Ym9ndXMvPjwvZG9jY28+XCI7XG4gICAgfVxuICAgIG15eG1sID0gbXl4bWwucmVwbGFjZSgvXFxzKjxcXD9bXj5dKlxcPz5cXHMqXFxuKi9nLCBcIlwiKTtcbiAgICB2YXIgbm9kZXRyZWUgPSB0aGlzLnBhcnNlci5wYXJzZUZyb21TdHJpbmcobXl4bWwsIFwiYXBwbGljYXRpb24veG1sXCIpO1xuICAgIHJldHVybiBub2RldHJlZS5maXJzdENoaWxkO1xufTtcbkNTTC5YbWxET00ucHJvdG90eXBlLmluc2VydENoaWxkTm9kZUFmdGVyID0gZnVuY3Rpb24gKHBhcmVudCxub2RlLHBvcyxkYXRleG1sKSB7XG4gICAgdmFyIG15eG1sLCB4bWw7XG4gICAgbXl4bWwgPSB0aGlzLmltcG9ydE5vZGUobm9kZS5vd25lckRvY3VtZW50LCBkYXRleG1sKTtcbiAgICBwYXJlbnQucmVwbGFjZUNoaWxkKG15eG1sLCBub2RlKTtcbiAgICAgcmV0dXJuIHBhcmVudDtcbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5pbnNlcnRQdWJsaXNoZXJBbmRQbGFjZSA9IGZ1bmN0aW9uKG15eG1sKSB7XG4gICAgdmFyIGdyb3VwID0gbXl4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJncm91cFwiKTtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGdyb3VwLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgbm9kZSA9IGdyb3VwLml0ZW0oaSk7XG4gICAgICAgIHZhciBza2lwcGVycyA9IFtdO1xuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChub2RlLmNoaWxkTm9kZXMuaXRlbShqKS5ub2RlVHlwZSAhPT0gMSkge1xuICAgICAgICAgICAgICAgIHNraXBwZXJzLnB1c2goaik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggLSBza2lwcGVycy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgIHZhciB0d292YXJzID0gW107XG4gICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IDI7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2tpcHBlcnMuaW5kZXhPZihqKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkTm9kZXMuaXRlbShqKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBzdWJza2lwcGVycyA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBrbGVuID0gY2hpbGQuY2hpbGROb2Rlcy5sZW5ndGg7IGsgPCBrbGVuOyBrICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmNoaWxkTm9kZXMuaXRlbShrKS5ub2RlVHlwZSAhPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2tpcHBlcnMucHVzaChrKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2hpbGQuY2hpbGROb2Rlcy5sZW5ndGggLSBzdWJza2lwcGVycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdHdvdmFycy5wdXNoKGNoaWxkLmdldEF0dHJpYnV0ZSgndmFyaWFibGUnKSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5nZXRBdHRyaWJ1dGUoJ3N1ZmZpeCcpXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCBjaGlsZC5nZXRBdHRyaWJ1dGUoJ3ByZWZpeCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0d292YXJzID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0d292YXJzLmluZGV4T2YoXCJwdWJsaXNoZXJcIikgPiAtMSAmJiB0d292YXJzLmluZGV4T2YoXCJwdWJsaXNoZXItcGxhY2VcIikgPiAtMSkge1xuICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKCdoYXMtcHVibGlzaGVyLWFuZC1wdWJsaXNoZXItcGxhY2UnLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5pc0NoaWxkT2ZTdWJzdGl0dXRlID0gZnVuY3Rpb24obm9kZSkge1xuICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHtcbiAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09IFwic3Vic3RpdHV0ZVwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzQ2hpbGRPZlN1YnN0aXR1dGUobm9kZS5wYXJlbnROb2RlKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59O1xuQ1NMLlhtbERPTS5wcm90b3R5cGUuYWRkTWlzc2luZ05hbWVOb2RlcyA9IGZ1bmN0aW9uKG15eG1sKSB7XG4gICAgdmFyIG5hbWVzbGlzdCA9IG15eG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwibmFtZXNcIik7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBuYW1lc2xpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciBuYW1lcyA9IG5hbWVzbGlzdC5pdGVtKGkpO1xuICAgICAgICB2YXIgbmFtZWxpc3QgPSBuYW1lcy5nZXRFbGVtZW50c0J5VGFnTmFtZShcIm5hbWVcIik7XG4gICAgICAgIGlmICgoIW5hbWVsaXN0IHx8IG5hbWVsaXN0Lmxlbmd0aCA9PT0gMClcbiAgICAgICAgICAgICYmICF0aGlzLmlzQ2hpbGRPZlN1YnN0aXR1dGUobmFtZXMpKSB7XG4gICAgICAgICAgICB2YXIgZG9jID0gbmFtZXMub3duZXJEb2N1bWVudDtcbiAgICAgICAgICAgIHZhciBuYW1lID0gZG9jLmNyZWF0ZUVsZW1lbnQoXCJuYW1lXCIpO1xuICAgICAgICAgICAgbmFtZXMuYXBwZW5kQ2hpbGQobmFtZSk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLlhtbERPTS5wcm90b3R5cGUuYWRkSW5zdGl0dXRpb25Ob2RlcyA9IGZ1bmN0aW9uKG15eG1sKSB7XG4gICAgdmFyIG5hbWVzLCB0aGVuYW1lcywgaW5zdGl0dXRpb24sIHRoZWluc3RpdHV0aW9uLCBuYW1lLCB0aGVuYW1lLCB4bWwsIHBvcywgbGVuO1xuICAgIG5hbWVzID0gbXl4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJuYW1lc1wiKTtcbiAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IG5hbWVzLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICB0aGVuYW1lcyA9IG5hbWVzLml0ZW0ocG9zKTtcbiAgICAgICAgbmFtZSA9IHRoZW5hbWVzLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwibmFtZVwiKTtcbiAgICAgICAgaWYgKG5hbWUubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGluc3RpdHV0aW9uID0gdGhlbmFtZXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJpbnN0aXR1dGlvblwiKTtcbiAgICAgICAgaWYgKGluc3RpdHV0aW9uLmxlbmd0aCA9PSAwKSB7XG4gICAgICAgICAgICB0aGVpbnN0aXR1dGlvbiA9IHRoaXMuaW1wb3J0Tm9kZShteXhtbC5vd25lckRvY3VtZW50LCB0aGlzLmluc3RpdHV0aW9uKTtcbiAgICAgICAgICAgIHRoZWluc3RpdHV0aW9ucGFydCA9IHRoZWluc3RpdHV0aW9uLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiaW5zdGl0dXRpb24tcGFydFwiKS5pdGVtKDApO1xuICAgICAgICAgICAgdGhlbmFtZSA9IG5hbWUuaXRlbSgwKTtcbiAgICAgICAgICAgIHRoZW5hbWVzLmluc2VydEJlZm9yZSh0aGVpbnN0aXR1dGlvbiwgdGhlbmFtZS5uZXh0U2libGluZyk7XG4gICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IENTTC5JTlNUSVRVVElPTl9LRVlTLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgIHZhciBhdHRybmFtZSA9IENTTC5JTlNUSVRVVElPTl9LRVlTW2pdO1xuICAgICAgICAgICAgICAgIHZhciBhdHRydmFsID0gdGhlbmFtZS5nZXRBdHRyaWJ1dGUoYXR0cm5hbWUpO1xuICAgICAgICAgICAgICAgIGlmIChhdHRydmFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoZWluc3RpdHV0aW9ucGFydC5zZXRBdHRyaWJ1dGUoYXR0cm5hbWUsIGF0dHJ2YWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBuYW1lcGFydHMgPSB0aGVuYW1lLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwibmFtZS1wYXJ0XCIpO1xuICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSBuYW1lcGFydHMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKCdmYW1pbHknID09PSBuYW1lcGFydHNbal0uZ2V0QXR0cmlidXRlKCduYW1lJykpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGtsZW4gPSBDU0wuSU5TVElUVVRJT05fS0VZUy5sZW5ndGg7IGsgPCBrbGVuOyBrICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRybmFtZSA9IENTTC5JTlNUSVRVVElPTl9LRVlTW2tdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJ2YWwgPSBuYW1lcGFydHNbal0uZ2V0QXR0cmlidXRlKGF0dHJuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRydmFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlaW5zdGl0dXRpb25wYXJ0LnNldEF0dHJpYnV0ZShhdHRybmFtZSwgYXR0cnZhbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLlhtbERPTS5wcm90b3R5cGUuZmxhZ0RhdGVNYWNyb3MgPSBmdW5jdGlvbihteXhtbCkge1xuICAgIHZhciBwb3MsIGxlbiwgdGhlbm9kZSwgdGhlZGF0ZTtcbiAgICBub2RlcyA9IG15eG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwibWFjcm9cIik7XG4gICAgZm9yIChwb3MgPSAwLCBsZW4gPSBub2Rlcy5sZW5ndGg7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgdGhlbm9kZSA9IG5vZGVzLml0ZW0ocG9zKTtcbiAgICAgICAgdGhlZGF0ZSA9IHRoZW5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJkYXRlXCIpO1xuICAgICAgICBpZiAodGhlZGF0ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoZW5vZGUuc2V0QXR0cmlidXRlKCdtYWNyby1oYXMtZGF0ZScsICd0cnVlJyk7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5pZiAoXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIFhNTCkge1xuICAgIHRyeSB7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBcIk9PUFM6IFwiK2U7XG4gICAgfVxufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuc2V0dXBYbWwgPSBmdW5jdGlvbih4bWxPYmplY3QpIHtcbiAgICB2YXIgZGF0YU9iaiA9IHt9O1xuICAgIHZhciBwYXJzZXIgPSBudWxsO1xuICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgeG1sT2JqZWN0KSB7XG4gICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgeG1sT2JqZWN0KSB7XG4gICAgICAgICAgICB4bWxPYmplY3QgPSB4bWxPYmplY3QucmVwbGFjZShcIl5cXHVGRUZGXCIsIFwiXCIpXG4gICAgICAgICAgICAgICAgLnJlcGxhY2UoL15cXHMrLywgXCJcIik7XG4gICAgICAgICAgICBpZiAoeG1sT2JqZWN0LnNsaWNlKDAsIDEpID09PSBcIjxcIikge1xuICAgICAgICAgICAgICAgIGRhdGFPYmogPSBDU0wucGFyc2VYbWwoeG1sT2JqZWN0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGF0YU9iaiA9IEpTT04ucGFyc2UoeG1sT2JqZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhcnNlciA9IG5ldyBDU0wuWG1sSlNPTihkYXRhT2JqKTtcbiAgICAgICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgeG1sT2JqZWN0LmdldEF0dHJpYnV0ZSkge1xuICAgICAgICAgICAgcGFyc2VyID0gbmV3IENTTC5YbWxET00oeG1sT2JqZWN0KTtcbiAgICAgICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgeG1sT2JqZWN0LnRvWE1MU3RyaW5nKSB7XG4gICAgICAgICAgICBwYXJzZXIgPSBuZXcgQ1NMLlhtbEU0WCh4bWxPYmplY3QpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGFyc2VyID0gbmV3IENTTC5YbWxKU09OKHhtbE9iamVjdCk7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBDU0wuZXJyb3IoXCJ1bmFibGUgdG8gcGFyc2UgWE1MIGlucHV0XCIpO1xuICAgIH1cbiAgICBpZiAoIXBhcnNlcikge1xuICAgICAgICB0aHJvdyBcImNpdGVwcm9jLWpzIGVycm9yOiB1bmFibGUgdG8gcGFyc2UgQ1NMIHN0eWxlIG9yIGxvY2FsZSBvYmplY3RcIjtcbiAgICB9XG4gICAgcmV0dXJuIHBhcnNlcjtcbn1cbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLmdldFNvcnRDb21wYXJlID0gZnVuY3Rpb24gKGRlZmF1bHRfbG9jYWxlKSB7XG4gICAgaWYgKENTTC5zdHJpbmdDb21wYXJlKSB7XG4gICAgICAgIHJldHVybiBDU0wuc3RyaW5nQ29tcGFyZTtcbiAgICB9XG4gICAgdmFyIHN0cmNtcDtcbiAgICB2YXIgc3RyY21wX29wdHMgPSB7XG4gICAgICAgIHNlbnNpdGl2aXR5OlwiYmFzZVwiLFxuICAgICAgICBpZ25vcmVQdW5jdHVhdGlvbjp0cnVlLFxuICAgICAgICBudW1lcmljOnRydWVcbiAgIH1cbiAgICBpZiAoIWRlZmF1bHRfbG9jYWxlKSB7XG4gICAgICAgIGRlZmF1bHRfbG9jYWxlID0gXCJlbi1VU1wiO1xuICAgIH1cbiAgICBzdHJjbXAgPSBmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICByZXR1cm4gYS50b0xvY2FsZUxvd2VyQ2FzZSgpLmxvY2FsZUNvbXBhcmUoYi50b0xvY2FsZUxvd2VyQ2FzZSgpLGRlZmF1bHRfbG9jYWxlLHN0cmNtcF9vcHRzKTtcbiAgICB9O1xuICAgIHZhciBzdHJpcFB1bmN0ID0gZnVuY3Rpb24gKHN0cikge1xuICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoL15bXFxbXFxdXFwnXFxcIl0qL2csIFwiXCIpO1xuICAgIH1cbiAgICB2YXIgZ2V0QnJhY2tldFByZVNvcnQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmICghc3RyY21wKFwiW3hcIixcInhcIikpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdHJjbXAoc3RyaXBQdW5jdChhKSwgc3RyaXBQdW5jdChiKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIGJyYWNrZXRQcmVTb3J0ID0gZ2V0QnJhY2tldFByZVNvcnQoKTtcbiAgICB2YXIgc29ydENvbXBhcmUgPSBmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICBpZiAoYnJhY2tldFByZVNvcnQpIHtcbiAgICAgICAgICAgIHJldHVybiBicmFja2V0UHJlU29ydChhLCBiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBzdHJjbXAoYSwgYik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNvcnRDb21wYXJlO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLmFtYmlnQ29uZmlnRGlmZiA9IGZ1bmN0aW9uKGEsIGIpIHtcbiAgICB2YXIgcmV0LCBwb3MsIGxlbiwgcHBvcywgbGxlbjtcbiAgICBpZiAoYS5uYW1lcy5sZW5ndGggIT09IGIubmFtZXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGZvciAocG9zID0gMCwgbGVuID0gYS5uYW1lcy5sZW5ndGg7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChhLm5hbWVzW3Bvc10gIT09IGIubmFtZXNbcG9zXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmb3IgKHBwb3MgPSAwLCBsbGVuID0gYS5naXZlbnNbcG9zXTsgcHBvcyA8IGxsZW47IHBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYS5naXZlbnNbcG9zXVtwcG9zXSAhPT0gYi5naXZlbnNbcG9zXVtwcG9zXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGEuZGlzYW1iaWd1YXRlICE9IGIuZGlzYW1iaWd1YXRlKSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICBpZiAoYS55ZWFyX3N1ZmZpeCAhPT0gYi55ZWFyX3N1ZmZpeCkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICB9XG4gICAgcmV0dXJuIDA7XG59O1xuQ1NMLmNsb25lQW1iaWdDb25maWcgPSBmdW5jdGlvbiAoY29uZmlnLCBvbGRjb25maWcsIHRhaW50ZXJzKSB7XG4gICAgdmFyIGksIGlsZW4sIGosIGpsZW4sIGssIGtsZW4sIHBhcmFtO1xuICAgIHZhciByZXQgPSB7fTtcbiAgICByZXQubmFtZXMgPSBbXTtcbiAgICByZXQuZ2l2ZW5zID0gW107XG4gICAgcmV0LnllYXJfc3VmZml4ID0gZmFsc2U7XG4gICAgcmV0LmRpc2FtYmlndWF0ZSA9IGZhbHNlO1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBjb25maWcubmFtZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHBhcmFtID0gY29uZmlnLm5hbWVzW2ldO1xuICAgICAgICByZXQubmFtZXNbaV0gPSBwYXJhbTtcbiAgICB9XG4gICAgZm9yIChpICA9IDAsIGlsZW4gPSBjb25maWcuZ2l2ZW5zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBwYXJhbSA9IFtdO1xuICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gY29uZmlnLmdpdmVuc1tpXS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIHBhcmFtLnB1c2goY29uZmlnLmdpdmVuc1tpXVtqXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0LmdpdmVucy5wdXNoKHBhcmFtKTtcbiAgICB9XG4gICAgaWYgKG9sZGNvbmZpZykge1xuICAgICAgICByZXQueWVhcl9zdWZmaXggPSBvbGRjb25maWcueWVhcl9zdWZmaXg7XG4gICAgICAgIHJldC5kaXNhbWJpZ3VhdGUgPSBvbGRjb25maWcuZGlzYW1iaWd1YXRlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldC55ZWFyX3N1ZmZpeCA9IGNvbmZpZy55ZWFyX3N1ZmZpeDtcbiAgICAgICAgcmV0LmRpc2FtYmlndWF0ZSA9IGNvbmZpZy5kaXNhbWJpZ3VhdGU7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLmdldEFtYmlnQ29uZmlnID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBjb25maWcsIHJldDtcbiAgICBjb25maWcgPSB0aGlzLnRtcC5kaXNhbWJpZ19yZXF1ZXN0O1xuICAgIGlmICghY29uZmlnKSB7XG4gICAgICAgIGNvbmZpZyA9IHRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzO1xuICAgIH1cbiAgICB2YXIgcmV0ID0gQ1NMLmNsb25lQW1iaWdDb25maWcoY29uZmlnKTtcbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5nZXRNYXhWYWxzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLnRtcC5uYW1lc19tYXgubXlzdGFjay5zbGljZSgpO1xufTtcbkNTTC5nZXRNaW5WYWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMudG1wW1wiZXQtYWwtbWluXCJdO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLnRva2VuRXhlYyA9IGZ1bmN0aW9uICh0b2tlbiwgSXRlbSwgaXRlbSkge1xuICAgIHZhciBuZXh0LCBtYXliZW5leHQsIGV4ZWMsIGRlYnVnO1xuICAgIGRlYnVnID0gZmFsc2U7XG4gICAgbmV4dCA9IHRva2VuLm5leHQ7XG4gICAgbWF5YmVuZXh0ID0gZmFsc2U7XG4gICAgdmFyIHJlY29yZCA9IGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgdGhpcy50bXAuanVtcC5yZXBsYWNlKFwic3VjY2VlZFwiKTtcbiAgICAgICAgICAgIHJldHVybiB0b2tlbi5zdWNjZWVkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50bXAuanVtcC5yZXBsYWNlKFwiZmFpbFwiKTtcbiAgICAgICAgICAgIHJldHVybiB0b2tlbi5mYWlsO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0b2tlbi50ZXN0KSB7XG4gICAgICAgIG5leHQgPSByZWNvcmQuY2FsbCh0aGlzLHRva2VuLnRlc3QoSXRlbSwgaXRlbSkpO1xuICAgIH1cbiAgICBmb3IgKHZhciBpPTAsaWxlbj10b2tlbi5leGVjcy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICBleGVjID0gdG9rZW4uZXhlY3NbaV07XG4gICAgICAgIG1heWJlbmV4dCA9IGV4ZWMuY2FsbCh0b2tlbiwgdGhpcywgSXRlbSwgaXRlbSk7XG4gICAgICAgIGlmIChtYXliZW5leHQpIHtcbiAgICAgICAgICAgIG5leHQgPSBtYXliZW5leHQ7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5leHQ7XG59O1xuQ1NMLmV4cGFuZE1hY3JvID0gZnVuY3Rpb24gKG1hY3JvX2tleV90b2tlbiwgdGFyZ2V0KSB7XG4gICAgdmFyIG1rZXksIHN0YXJ0X3Rva2VuLCBrZXksIGVuZF90b2tlbiwgbmF2aSwgbWFjcm9fbm9kZXMsIG5ld291dHB1dCwgbWVyZ2VvdXRwdXQsIGVuZF9vZl9tYWNybywgZnVuYztcbiAgICBta2V5ID0gbWFjcm9fa2V5X3Rva2VuLnBvc3Rwb25lZF9tYWNybztcbiAgICBtYWNyb19rZXlfdG9rZW4gPSBuZXcgQ1NMLlRva2VuKFwiZ3JvdXBcIiwgQ1NMLlNUQVJUKTtcbiAgICB2YXIgaGFzRGF0ZSA9IGZhbHNlO1xuICAgIHZhciBtYWNyb2lkID0gZmFsc2U7XG4gICAgbWFjcm9fbm9kZXMgPSB0aGlzLmNzbFhtbC5nZXROb2Rlc0J5TmFtZSh0aGlzLmNzbFhtbC5kYXRhT2JqLCAnbWFjcm8nLCBta2V5KTtcbiAgICBpZiAobWFjcm9fbm9kZXMubGVuZ3RoKSB7XG4gICAgICAgIG1hY3JvaWQgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShtYWNyb19ub2Rlc1swXSwnY3NsaWQnKTtcbiAgICAgICAgaGFzRGF0ZSA9IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG1hY3JvX25vZGVzWzBdLCBcIm1hY3JvLWhhcy1kYXRlXCIpO1xuICAgIH1cbiAgICBpZiAoaGFzRGF0ZSkge1xuICAgICAgICBta2V5ID0gbWtleSArIFwiQFwiICsgdGhpcy5idWlsZC5jdXJyZW50X2RlZmF1bHRfbG9jYWxlO1xuICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLmV4dGVuc2lvbikge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcFtcImRvaW5nLW1hY3JvLXdpdGgtZGF0ZVwiXSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIG1hY3JvX2tleV90b2tlbi5leGVjcy5wdXNoKGZ1bmMpO1xuICAgIH1cbiAgICBpZiAodGhpcy5idWlsZC5tYWNyb19zdGFjay5pbmRleE9mKG1rZXkpID4gLTEpIHtcbiAgICAgICAgdGhyb3cgXCJDU0wgcHJvY2Vzc29yIGVycm9yOiBjYWxsIHRvIG1hY3JvIFxcXCJcIiArIG1rZXkgKyBcIlxcXCIgd291bGQgY2F1c2UgYW4gaW5maW5pdGUgbG9vcFwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYnVpbGQubWFjcm9fc3RhY2sucHVzaChta2V5KTtcbiAgICB9XG4gICAgbWFjcm9fa2V5X3Rva2VuLmNzbGlkID0gbWFjcm9pZDtcbiAgICBpZiAoQ1NMLk1PRFVMRV9NQUNST1NbbWtleV0pIHtcbiAgICAgICAgbWFjcm9fa2V5X3Rva2VuLmp1cmlzID0gbWtleTtcbiAgICAgICAgdGhpcy5vcHQudXBkYXRlX21vZGUgPSBDU0wuUE9TSVRJT047XG4gICAgfVxuICAgIENTTC5Ob2RlLmdyb3VwLmJ1aWxkLmNhbGwobWFjcm9fa2V5X3Rva2VuLCB0aGlzLCB0YXJnZXQsIHRydWUpO1xuICAgIGlmICghdGhpcy5jc2xYbWwuZ2V0Tm9kZVZhbHVlKG1hY3JvX25vZGVzKSkge1xuICAgICAgICB0aHJvdyBcIkNTTCBzdHlsZSBlcnJvcjogdW5kZWZpbmVkIG1hY3JvIFxcXCJcIiArIG1rZXkgKyBcIlxcXCJcIjtcbiAgICB9XG4gICAgdmFyIG15dGFyZ2V0ID0gQ1NMLmdldE1hY3JvVGFyZ2V0LmNhbGwodGhpcywgbWtleSk7XG4gICAgaWYgKG15dGFyZ2V0KSB7XG4gICAgICAgIENTTC5idWlsZE1hY3JvLmNhbGwodGhpcywgbXl0YXJnZXQsIG1hY3JvX25vZGVzKTtcbiAgICAgICAgQ1NMLmNvbmZpZ3VyZU1hY3JvLmNhbGwodGhpcywgbXl0YXJnZXQpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuYnVpbGQuZXh0ZW5zaW9uKSB7XG4gICAgICAgIHZhciBmdW5jID0gZnVuY3Rpb24obWFjcm9fbmFtZSkge1xuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gMDtcbiAgICAgICAgICAgICAgICB3aGlsZSAobmV4dCA8IHN0YXRlLm1hY3Jvc1ttYWNyb19uYW1lXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dCA9IENTTC50b2tlbkV4ZWMuY2FsbChzdGF0ZSwgc3RhdGUubWFjcm9zW21hY3JvX25hbWVdW25leHRdLCBJdGVtLCBpdGVtKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0obWtleSk7XG4gICAgICAgIHZhciB0ZXh0X25vZGUgPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgdGV4dF9ub2RlLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIHRhcmdldC5wdXNoKHRleHRfbm9kZSk7XG4gICAgfVxuICAgIGVuZF9vZl9tYWNybyA9IG5ldyBDU0wuVG9rZW4oXCJncm91cFwiLCBDU0wuRU5EKTtcbiAgICBpZiAoaGFzRGF0ZSkge1xuICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLmV4dGVuc2lvbikge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcFtcImRvaW5nLW1hY3JvLXdpdGgtZGF0ZVwiXSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBlbmRfb2ZfbWFjcm8uZXhlY3MucHVzaChmdW5jKTtcbiAgICB9XG4gICAgaWYgKG1hY3JvX2tleV90b2tlbi5qdXJpcykge1xuICAgICAgICBlbmRfb2ZfbWFjcm8uanVyaXMgPSBta2V5O1xuICAgICB9XG4gICAgQ1NMLk5vZGUuZ3JvdXAuYnVpbGQuY2FsbChlbmRfb2ZfbWFjcm8sIHRoaXMsIHRhcmdldCwgdHJ1ZSk7XG4gICAgdGhpcy5idWlsZC5tYWNyb19zdGFjay5wb3AoKTtcbn07XG5DU0wuZ2V0TWFjcm9UYXJnZXQgPSBmdW5jdGlvbiAobWtleSkge1xuICAgIHZhciBteXRhcmdldCA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmJ1aWxkLmV4dGVuc2lvbikge1xuICAgICAgICBteXRhcmdldCA9IHRoaXNbdGhpcy5idWlsZC5yb290ICsgdGhpcy5idWlsZC5leHRlbnNpb25dLnRva2VucztcbiAgICB9IGVsc2UgaWYgKCF0aGlzLm1hY3Jvc1tta2V5XSkge1xuICAgICAgICBteXRhcmdldCA9IFtdO1xuICAgICAgICB0aGlzLm1hY3Jvc1tta2V5XSA9IG15dGFyZ2V0O1xuICAgIH1cbiAgICByZXR1cm4gbXl0YXJnZXQ7XG59XG5DU0wuYnVpbGRNYWNybyA9IGZ1bmN0aW9uIChteXRhcmdldCwgbWFjcm9fbm9kZXMpIHtcbiAgICB2YXIgYnVpbGRlciA9IENTTC5tYWtlQnVpbGRlcih0aGlzLCBteXRhcmdldCk7XG4gICAgdmFyIG15bm9kZTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIG1hY3JvX25vZGVzLmxlbmd0aCkge1xuICAgICAgICBteW5vZGUgPSBtYWNyb19ub2RlcztcbiAgICB9IGVsc2Uge1xuICAgICAgICBteW5vZGUgPSBtYWNyb19ub2Rlc1swXTtcbiAgICB9XG4gICAgYnVpbGRlcihteW5vZGUpO1xufVxuQ1NMLmNvbmZpZ3VyZU1hY3JvID0gZnVuY3Rpb24gKG15dGFyZ2V0KSB7XG4gICAgaWYgKCF0aGlzLmJ1aWxkLmV4dGVuc2lvbikge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyZVRva2VuTGlzdChteXRhcmdldCk7XG4gICAgfVxufVxuQ1NMLlhtbFRvVG9rZW4gPSBmdW5jdGlvbiAoc3RhdGUsIHRva2VudHlwZSwgZXhwbGljaXRUYXJnZXQsIHZhcl9zdGFjaykge1xuICAgIHZhciBuYW1lLCB0eHQsIGF0dHJmdW5jcywgYXR0cmlidXRlcywgZGVjb3JhdGlvbnMsIHRva2VuLCBrZXksIHRhcmdldDtcbiAgICBuYW1lID0gc3RhdGUuY3NsWG1sLm5vZGVuYW1lKHRoaXMpO1xuICAgIGlmIChzdGF0ZS5idWlsZC5za2lwICYmIHN0YXRlLmJ1aWxkLnNraXAgIT09IG5hbWUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIW5hbWUpIHtcbiAgICAgICAgdHh0ID0gc3RhdGUuY3NsWG1sLmNvbnRlbnQodGhpcyk7XG4gICAgICAgIGlmICh0eHQpIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLnRleHQgPSB0eHQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIUNTTC5Ob2RlW3N0YXRlLmNzbFhtbC5ub2RlbmFtZSh0aGlzKV0pIHtcbiAgICAgICAgdGhyb3cgXCJVbmRlZmluZWQgbm9kZSBuYW1lIFxcXCJcIiArIG5hbWUgKyBcIlxcXCIuXCI7XG4gICAgfVxuICAgIGF0dHJmdW5jcyA9IFtdO1xuICAgIGF0dHJpYnV0ZXMgPSBzdGF0ZS5jc2xYbWwuYXR0cmlidXRlcyh0aGlzKTtcbiAgICBkZWNvcmF0aW9ucyA9IENTTC5zZXREZWNvcmF0aW9ucy5jYWxsKHRoaXMsIHN0YXRlLCBhdHRyaWJ1dGVzKTtcbiAgICB0b2tlbiA9IG5ldyBDU0wuVG9rZW4obmFtZSwgdG9rZW50eXBlKTtcbiAgICBpZiAodG9rZW50eXBlICE9PSBDU0wuRU5EIHx8IG5hbWUgPT09IFwiaWZcIiB8fCBuYW1lID09PSBcImVsc2UtaWZcIiB8fCBuYW1lID09PSBcImxheW91dFwiKSB7XG4gICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRva2VudHlwZSA9PT0gQ1NMLkVORCAmJiBrZXkgIT09IFwiQGxhbmd1YWdlXCIgJiYga2V5ICE9PSBcIkBsb2NhbGVcIikge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoQ1NMLkF0dHJpYnV0ZXNba2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDU0wuQXR0cmlidXRlc1trZXldLmNhbGwodG9rZW4sIHN0YXRlLCBcIlwiICsgYXR0cmlidXRlc1trZXldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDU0wuZXJyb3IoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgXCJDU0wgcHJvY2Vzc29yIGVycm9yLCBcIiArIGtleSArIFwiIGF0dHJpYnV0ZTogXCIgKyBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLmRlYnVnKFwid2FybmluZzogdW5kZWZpbmVkIGF0dHJpYnV0ZSBcXFwiXCIra2V5K1wiXFxcIiBpbiBzdHlsZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0b2tlbi5kZWNvcmF0aW9ucyA9IGRlY29yYXRpb25zO1xuICAgICAgICBpZiAoQ1NMLkRBVEVfVkFSSUFCTEVTLmluZGV4T2YoYXR0cmlidXRlc1snQHZhcmlhYmxlJ10pID4gLTEpIHtcbiAgICAgICAgICAgIHZhcl9zdGFjay5wdXNoKHRva2VuLnZhcmlhYmxlcyk7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHRva2VudHlwZSA9PT0gQ1NMLkVORCAmJiBhdHRyaWJ1dGVzWydAdmFyaWFibGUnXSkge1xuICAgICAgICB0b2tlbi5oYXNWYXJpYWJsZSA9IHRydWU7XG4gICAgICAgIGlmIChDU0wuREFURV9WQVJJQUJMRVMuaW5kZXhPZihhdHRyaWJ1dGVzWydAdmFyaWFibGUnXSkgPiAtMSkge1xuICAgICAgICAgICAgdG9rZW4udmFyaWFibGVzID0gdmFyX3N0YWNrLnBvcCgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChleHBsaWNpdFRhcmdldCkge1xuICAgICAgICB0YXJnZXQgPSBleHBsaWNpdFRhcmdldDtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0YXJnZXQgPSBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS50b2tlbnM7XG4gICAgfVxuICAgIENTTC5Ob2RlW25hbWVdLmJ1aWxkLmNhbGwodG9rZW4sIHN0YXRlLCB0YXJnZXQsIHRydWUpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkRhdGVQYXJzZXIgPSBuZXcgZnVuY3Rpb24gKCkge1xuICAgIHZhciBlcG9jaFBhaXJzID0gW1xuICAgICAgICBbXCJcXHU2NjBFXFx1NkNCQlwiLCAxODY3XSxcbiAgICAgICAgW1wiXFx1NTkyN1xcdTZCNjNcIiwgMTkxMV0sXG4gICAgICAgIFtcIlxcdTY2MkRcXHU1NDhDXCIsIDE5MjVdLFxuICAgICAgICBbXCJcXHU1RTczXFx1NjIxMFwiLCAxOTg4XVxuICAgIF07XG4gICAgdmFyIGVwb2NoWWVhckJ5TmFtZSA9IHt9O1xuICAgIGZvciAodmFyIGk9MCxpbGVuPWVwb2NoUGFpcnMubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICB2YXIga2V5ID0gZXBvY2hQYWlyc1tpXVswXTtcbiAgICAgICAgdmFyIHZhbCA9IGVwb2NoUGFpcnNbaV1bMV07XG4gICAgICAgIGVwb2NoWWVhckJ5TmFtZVtrZXldID0gdmFsO1xuICAgIH1cbiAgICB2YXIgZXBvY2hNYXRjaFN0cmluZ3MgPSBbXTtcbiAgICBmb3IgKHZhciBpPTAsaWxlbj1lcG9jaFBhaXJzLmxlbmd0aDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgdmFyIHZhbCA9IGVwb2NoUGFpcnNbaV1bMF07XG4gICAgICAgIGVwb2NoTWF0Y2hTdHJpbmdzLnB1c2godmFsKTtcbiAgICB9XG4gICAgdmFyIGVwb2NoTWF0Y2hTdHJpbmcgPSBlcG9jaE1hdGNoU3RyaW5ncy5qb2luKFwifFwiKTtcbiAgICB2YXIgZXBvY2hTcGxpdHRlciA9IG5ldyBSZWdFeHAoXCIoPzpcIiArIGVwb2NoTWF0Y2hTdHJpbmcgKyBcIikoPzpbMC05XSspXCIpO1xuICAgIHZhciBlcG9jaE1hdGNoZXIgPSBuZXcgUmVnRXhwKFwiKD86XCIgKyBlcG9jaE1hdGNoU3RyaW5nICsgXCIpKD86WzAtOV0rKVwiLCBcImdcIik7XG4gICAgdmFyIGthbmppTW9udGhEYXkgPSAvKFxcdTY3MDh8XFx1NUU3NCkvZztcbiAgICB2YXIga2FuamlZZWFyID0gL1xcdTY1RTUvZztcbiAgICB2YXIga2FuamlSYW5nZSA9IC9cXHUzMDFjL2c7XG4gICAgdmFyIHllYXJMYXN0ID0gXCIoPzpbPzAtOV17MSwyfSUlTlVNRCUlKXswLDJ9Wz8wLTldezR9KD8hWzAtOV0pXCI7XG4gICAgdmFyIHllYXJGaXJzdCA9IFwiWz8wLTldezR9KD86JSVOVU1EJSVbPzAtOV17MSwyfSl7MCwyfSg/IVswLTldKVwiO1xuICAgIHZhciBudW1iZXJWYWwgPSBcIls/MC05XXsxLDN9XCI7XG4gICAgdmFyIHJhbmdlU2VwYXJhdG9yID0gXCJbJSVEQVRFRCUlXVwiO1xuICAgIHZhciBmdXp6eUNoYXIgPSBcIls/fl1cIjtcbiAgICB2YXIgY2hhcnMgPSBcIlteXFwtXFwvXFx+XFw/MC05XStcIjtcbiAgICB2YXIgcmV4U3RyaW5nID0gXCIoXCIgKyB5ZWFyRmlyc3QgKyBcInxcIiArIHllYXJMYXN0ICsgXCJ8XCIgKyBudW1iZXJWYWwgKyBcInxcIiArIHJhbmdlU2VwYXJhdG9yICsgXCJ8XCIgKyBmdXp6eUNoYXIgKyBcInxcIiArIGNoYXJzICsgXCIpXCI7XG4gICAgdmFyIHJleERhc2ggPSBuZXcgUmVnRXhwKHJleFN0cmluZy5yZXBsYWNlKC8lJU5VTUQlJS9nLCBcIi1cIikucmVwbGFjZSgvJSVEQVRFRCUlL2csIFwiLVwiKSk7XG4gICAgdmFyIHJleERhc2hTbGFzaCA9IG5ldyBSZWdFeHAocmV4U3RyaW5nLnJlcGxhY2UoLyUlTlVNRCUlL2csIFwiLVwiKS5yZXBsYWNlKC8lJURBVEVEJSUvZywgXCJcXC9cIikpO1xuICAgIHZhciByZXhTbGFzaERhc2ggPSBuZXcgUmVnRXhwKHJleFN0cmluZy5yZXBsYWNlKC8lJU5VTUQlJS9nLCBcIlxcL1wiKS5yZXBsYWNlKC8lJURBVEVEJSUvZywgXCItXCIpKTtcbiAgICB2YXIgbW9udGhTdHJpbmcgPSBcImphbnVhcnkgZmVicnVhcnkgbWFyY2ggYXByaWwgbWF5IGp1bmUganVseSBhdWd1c3Qgc2VwdGVtYmVyIG9jdG9iZXIgbm92ZW1iZXIgZGVjZW1iZXIgc3ByaW5nIHN1bW1lciBmYWxsIHdpbnRlciBzcHJpbmcgc3VtbWVyXCI7XG4gICAgdGhpcy5tb250aFN0cmluZ3MgPSBtb250aFN0cmluZy5zcGxpdChcIiBcIik7XG4gICAgdGhpcy5zZXRPcmRlckRheU1vbnRoID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMubW9udGhHdWVzcyA9IDE7XG4gICAgICAgIHRoaXMuZGF5R3Vlc3MgPSAwO1xuICAgIH07XG4gICAgdGhpcy5zZXRPcmRlck1vbnRoRGF5ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMubW9udGhHdWVzcyA9IDA7XG4gICAgICAgIHRoaXMuZGF5R3Vlc3MgPSAxO1xuICAgIH07XG4gICAgdGhpcy5yZXNldERhdGVQYXJzZXJNb250aHMgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5tb250aFNldHMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy5tb250aFN0cmluZ3MubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdGhpcy5tb250aFNldHMucHVzaChbdGhpcy5tb250aFN0cmluZ3NbaV1dKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vbnRoQWJicmV2cyA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLm1vbnRoU2V0cy5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICB0aGlzLm1vbnRoQWJicmV2cy5wdXNoKFtdKTtcbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXRoaXMubW9udGhTZXRzW2ldLmxlbmd0aDsgajxqbGVuOyBqKyspIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoQWJicmV2c1tpXS5wdXNoKHRoaXMubW9udGhTZXRzW2ldWzBdLnNsaWNlKDAsIDMpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vbnRoUmV4ZXMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy5tb250aEFiYnJldnMubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdGhpcy5tb250aFJleGVzLnB1c2gobmV3IFJlZ0V4cChcIig/OlwiICsgdGhpcy5tb250aEFiYnJldnNbaV0uam9pbihcInxcIikgKyBcIilcIikpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmFkZERhdGVQYXJzZXJNb250aHMgPSBmdW5jdGlvbihsc3QpIHtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBsc3QpIHtcbiAgICAgICAgICAgIGxzdCA9IGxzdC5zcGxpdCgvXFxzKy8pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsc3QubGVuZ3RoICE9PSAxMiAmJiBsc3QubGVuZ3RoICE9PSAxNikge1xuICAgICAgICAgICAgQ1NMLmRlYnVnKFwibW9udGggWytzZWFzb25dIGxpc3Qgb2YgXCIrbHN0Lmxlbmd0aCtcIiwgZXhwZWN0ZWQgMTIgb3IgMTYuIElnbm9yaW5nLlwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgb3RoZXJNYXRjaCA9IFtdO1xuICAgICAgICB2YXIgdGhpc01hdGNoID0gW107XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWxzdC5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgYWJicmV2TGVuZ3RoID0gbnVsbDtcbiAgICAgICAgICAgIHZhciBza2lwID0gZmFsc2U7XG4gICAgICAgICAgICB2YXIgaW5zZXJ0ID0gMztcbiAgICAgICAgICAgIHZhciBleHRlbmRlZFNldHMgPSB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXRoaXMubW9udGhBYmJyZXZzLmxlbmd0aDsgajxqbGVuOyBqKyspIHtcbiAgICAgICAgICAgICAgICBleHRlbmRlZFNldHNbal0gPSB7fTtcbiAgICAgICAgICAgICAgICBpZiAoaiA9PT0gaSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrPTAsa2xlbj10aGlzLm1vbnRoQWJicmV2c1tpXS5sZW5ndGg7IGs8a2xlbjsgaysrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tb250aEFiYnJldnNbaV1ba10gPT09IGxzdFtpXS5zbGljZSgwLCB0aGlzLm1vbnRoQWJicmV2c1tpXVtrXS5sZW5ndGgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2tpcCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrPTAsa2xlbj10aGlzLm1vbnRoQWJicmV2c1tqXS5sZW5ndGg7IGs8a2xlbjsgaysrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhYmJyZXZMZW5ndGggPSB0aGlzLm1vbnRoQWJicmV2c1tqXVtrXS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tb250aEFiYnJldnNbal1ba10gPT09IGxzdFtpXS5zbGljZSgwLCBhYmJyZXZMZW5ndGgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHRoaXMubW9udGhTZXRzW2pdW2tdLnNsaWNlKDAsIGFiYnJldkxlbmd0aCkgPT09IGxzdFtpXS5zbGljZSgwLCBhYmJyZXZMZW5ndGgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhYmJyZXZMZW5ndGggPiBsc3RbaV0ubGVuZ3RoIHx8IGFiYnJldkxlbmd0aCA+IHRoaXMubW9udGhTZXRzW2pdW2tdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLmRlYnVnKFwidW5hYmxlIHRvIGRpc2FtYmlndWF0ZSBtb250aCBzdHJpbmcgaW4gZGF0ZSBwYXJzZXI6IFwiK2xzdFtpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFiYnJldkxlbmd0aCArPSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydCA9IGFiYnJldkxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHRlbmRlZFNldHNbal1ba10gPSBhYmJyZXZMZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaktleSBpbiBleHRlbmRlZFNldHMpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChrS2V5IGluIGV4dGVuZGVkU2V0c1tqS2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWJicmV2TGVuZ3RoID0gZXh0ZW5kZWRTZXRzW2pLZXldW2tLZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgaktleSA9IHBhcnNlSW50KGpLZXksIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtLZXkgPSBwYXJzZUludChrS2V5LCAxMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vbnRoQWJicmV2c1tqS2V5XVtrS2V5XSA9IHRoaXMubW9udGhTZXRzW2pLZXldW2tLZXldLnNsaWNlKDAsIGFiYnJldkxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXNraXApIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoU2V0c1tpXS5wdXNoKGxzdFtpXSk7XG4gICAgICAgICAgICAgICAgdGhpcy5tb250aEFiYnJldnNbaV0ucHVzaChsc3RbaV0uc2xpY2UoMCwgaW5zZXJ0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tb250aFJleGVzID0gW107XG4gICAgICAgIHRoaXMubW9udGhSZXhTdHJzID0gW107XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMubW9udGhBYmJyZXZzLmxlbmd0aDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMubW9udGhSZXhlcy5wdXNoKG5ldyBSZWdFeHAoXCJeKD86XCIgKyB0aGlzLm1vbnRoQWJicmV2c1tpXS5qb2luKFwifFwiKSArIFwiKVwiKSk7XG4gICAgICAgICAgICB0aGlzLm1vbnRoUmV4U3Rycy5wdXNoKFwiXig/OlwiICsgdGhpcy5tb250aEFiYnJldnNbaV0uam9pbihcInxcIikgKyBcIilcIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubW9udGhBYmJyZXZzLmxlbmd0aCA9PT0gMTgpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MTIsaWxlbj0xNDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoUmV4ZXNbaSs0XSA9IG5ldyBSZWdFeHAoXCJeKD86XCIgKyB0aGlzLm1vbnRoQWJicmV2c1tpXS5qb2luKFwifFwiKSArIFwiKVwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoUmV4U3Ryc1tpKzRdID0gXCJeKD86XCIgKyB0aGlzLm1vbnRoQWJicmV2c1tpXS5qb2luKFwifFwiKSArIFwiKVwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmNvbnZlcnREYXRlT2JqZWN0VG9BcnJheSA9IGZ1bmN0aW9uICh0aGVkYXRlKSB7XG4gICAgICAgIHRoZWRhdGVbXCJkYXRlLXBhcnRzXCJdID0gW107XG4gICAgICAgIHRoZWRhdGVbXCJkYXRlLXBhcnRzXCJdLnB1c2goW10pO1xuICAgICAgICB2YXIgc2xpY2VsZW4gPSAwO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj0zOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdmFyIHBhcnQgPSBbXCJ5ZWFyXCIsIFwibW9udGhcIiwgXCJkYXlcIl1baV07XG4gICAgICAgICAgICBpZiAoIXRoZWRhdGVbcGFydF0pIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNsaWNlbGVuICs9IDE7XG4gICAgICAgICAgICB0aGVkYXRlW1wiZGF0ZS1wYXJ0c1wiXVswXS5wdXNoKHRoZWRhdGVbcGFydF0pO1xuICAgICAgICAgICAgZGVsZXRlIHRoZWRhdGVbcGFydF07XG4gICAgICAgIH1cbiAgICAgICAgdGhlZGF0ZVtcImRhdGUtcGFydHNcIl0ucHVzaChbXSk7XG4gICAgICAgIGZvciAodmFyIGk9MCwgaWxlbj1zbGljZWxlbjsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgIHBhcnQgPSBbXCJ5ZWFyX2VuZFwiLCBcIm1vbnRoX2VuZFwiLCBcImRheV9lbmRcIl1baV07XG4gICAgICAgICAgICBpZiAoIXRoZWRhdGVbcGFydF0pIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoZWRhdGVbXCJkYXRlLXBhcnRzXCJdWzFdLnB1c2godGhlZGF0ZVtwYXJ0XSk7XG4gICAgICAgICAgICBkZWxldGUgdGhlZGF0ZVtwYXJ0XTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhlZGF0ZVtcImRhdGUtcGFydHNcIl1bMF0ubGVuZ3RoICE9PSB0aGVkYXRlW1wiZGF0ZS1wYXJ0c1wiXVsxXS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoZWRhdGVbXCJkYXRlLXBhcnRzXCJdLnBvcCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGVkYXRlO1xuICAgIH07XG4gICAgdGhpcy5jb252ZXJ0RGF0ZU9iamVjdFRvU3RyaW5nID0gZnVuY3Rpb24odGhlZGF0ZSkge1xuICAgICAgICB2YXIgcmV0ID0gW107XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gMzsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKHRoZWRhdGVbREFURV9QQVJUU19BTExbaV1dKSB7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2godGhlZGF0ZVtEQVRFX1BBUlRTX0FMTFtpXV0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0LmpvaW4oXCItXCIpO1xuICAgIH1cbiAgICB0aGlzLl9wYXJzZU51bWVyaWNEYXRlID0gZnVuY3Rpb24gKHJldCwgZGVsaW0sIHN1ZmYsIHR4dCkge1xuICAgICAgICBpZiAoIXN1ZmYpIHN1ZmYgPSBcIlwiO1xuICAgICAgICB2YXIgbHN0ID0gdHh0LnNwbGl0KGRlbGltKTtcbiAgICAgICAgZm9yICh2YXIgaT0wLCBpbGVuPWxzdC5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICBpZiAobHN0W2ldLmxlbmd0aCA9PT0gNCkge1xuICAgICAgICAgICAgICAgIHJldFsoXCJ5ZWFyXCIgKyBzdWZmKV0gPSBsc3RbaV0ucmVwbGFjZSgvXjAqLywgXCJcIik7XG4gICAgICAgICAgICAgICAgaWYgKCFpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxzdCA9IGxzdC5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCwgaSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWxzdC5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICBsc3RbaV0gPSBwYXJzZUludChsc3RbaV0sIDEwKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobHN0Lmxlbmd0aCA9PT0gMSB8fCAobHN0Lmxlbmd0aCA9PT0gMiAmJiAhbHN0WzFdKSkge1xuICAgICAgICAgICAgcmV0WyhcIm1vbnRoXCIgKyBzdWZmKV0gPSBcIlwiICsgbHN0WzBdO1xuICAgICAgICB9IGVsc2UgaWYgKGxzdC5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgIGlmIChsc3RbdGhpcy5tb250aEd1ZXNzXSA+IDEyKSB7XG4gICAgICAgICAgICAgICAgcmV0WyhcIm1vbnRoXCIgKyBzdWZmKV0gPSBcIlwiICsgbHN0W3RoaXMuZGF5R3Vlc3NdO1xuICAgICAgICAgICAgICAgIHJldFsoXCJkYXlcIiArIHN1ZmYpXSA9IFwiXCIgKyBsc3RbdGhpcy5tb250aEd1ZXNzXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0WyhcIm1vbnRoXCIgKyBzdWZmKV0gPSBcIlwiICsgbHN0W3RoaXMubW9udGhHdWVzc107XG4gICAgICAgICAgICAgICAgcmV0WyhcImRheVwiICsgc3VmZildID0gXCJcIiArIGxzdFt0aGlzLmRheUd1ZXNzXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5wYXJzZURhdGVUb09iamVjdCA9IGZ1bmN0aW9uICh0eHQpIHtcbiAgICAgICAgdmFyIG9yaWcgPSB0eHQ7XG4gICAgICAgIHZhciBzbGFzaFBvcyA9IC0xO1xuICAgICAgICB2YXIgZGFzaFBvcyA9IC0xO1xuICAgICAgICB2YXIgeWVhcklzTmVnYXRpdmUgPSBmYWxzZTtcbiAgICAgICAgdmFyIGxzdDtcbiAgICAgICAgaWYgKHR4dCkge1xuICAgICAgICAgICAgaWYgKHR4dC5zbGljZSgwLCAxKSA9PT0gXCItXCIpIHtcbiAgICAgICAgICAgICAgICB5ZWFySXNOZWdhdGl2ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnNsaWNlKDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHR4dC5tYXRjaCgvXlswLTldezEsM30kLykpIHtcbiAgICAgICAgICAgICAgICB3aGlsZSAodHh0Lmxlbmd0aCA8IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgdHh0ID0gXCIwXCIgKyB0eHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdHh0ID0gXCJcIiArIHR4dDtcbiAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXHMqWzAtOV17Mn06WzAtOV17Mn0oPzo6WzAtOV0rKS8sXCJcIik7XG4gICAgICAgICAgICB2YXIgbSA9IHR4dC5tYXRjaChrYW5qaU1vbnRoRGF5KTtcbiAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2UoL1xccysvZywgXCJcIik7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2Uoa2FuamlZZWFyLCBcIlwiKTtcbiAgICAgICAgICAgICAgICB0eHQgPSB0eHQucmVwbGFjZShrYW5qaU1vbnRoRGF5LCBcIi1cIik7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2Uoa2FuamlSYW5nZSwgXCIvXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXC1cXC8vZywgXCIvXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC8tJC9nLFwiXCIpO1xuICAgICAgICAgICAgICAgIHZhciBzbHN0ID0gdHh0LnNwbGl0KGVwb2NoU3BsaXR0ZXIpO1xuICAgICAgICAgICAgICAgIGxzdCA9IFtdO1xuICAgICAgICAgICAgICAgIHZhciBtbSA9IHR4dC5tYXRjaChlcG9jaE1hdGNoZXIpO1xuICAgICAgICAgICAgICAgIGlmIChtbSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbW14ID0gW107XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPW1tLmxlbmd0aDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1teCA9IG1teC5jb25jYXQobW1baV0ubWF0Y2goLyhbXjAtOV0rKShbMC05XSspLykuc2xpY2UoMSkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXNsc3QubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbHN0LnB1c2goc2xzdFtpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSAhPT0gKGxlbiAtIDEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1tcG9zID0gKHBvcyAqIDIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxzdC5wdXNoKG1teFttbXBvc10pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxzdC5wdXNoKG1teFttbXBvcyArIDFdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxzdCA9IHNsc3Q7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MSxpbGVuPWxzdC5sZW5ndGg7IGk8aWxlbjsgaSs9Mykge1xuICAgICAgICAgICAgICAgICAgICBsc3RbaSArIDFdID0gaml5W2xzdFtpXV0gKyBwYXJzZUludChsc3RbaSArIDFdLCAxMCk7XG4gICAgICAgICAgICAgICAgICAgIGxzdFtpXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHR4dCA9IGxzdC5qb2luKFwiXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXHMqLVxccyokLywgXCJcIikucmVwbGFjZSgvXFxzKi1cXHMqXFwvLywgXCIvXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXC5cXHMqJC8sIFwiXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXC4oPyEgKS8sIFwiXCIpO1xuICAgICAgICAgICAgICAgIHNsYXNoUG9zID0gdHh0LmluZGV4T2YoXCIvXCIpO1xuICAgICAgICAgICAgICAgIGRhc2hQb3MgPSB0eHQuaW5kZXhPZihcIi1cIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2UoLyhbQS1aYS16XSlcXC4vZywgXCIkMVwiKTtcbiAgICAgICAgdmFyIG51bWJlciA9IFwiXCI7XG4gICAgICAgIHZhciBub3RlID0gXCJcIjtcbiAgICAgICAgdmFyIHRoZWRhdGUgPSB7fTtcbiAgICAgICAgdmFyIHJhbmdlRGVsaW07XG4gICAgICAgIHZhciBkYXRlRGVsaW07XG4gICAgICAgIGlmICh0eHQuc2xpY2UoMCwgMSkgPT09IFwiXFxcIlwiICYmIHR4dC5zbGljZSgtMSkgPT09IFwiXFxcIlwiKSB7XG4gICAgICAgICAgICB0aGVkYXRlLmxpdGVyYWwgPSB0eHQuc2xpY2UoMSwgLTEpO1xuICAgICAgICAgICAgcmV0dXJuIHRoZWRhdGU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNsYXNoUG9zID4gLTEgJiYgZGFzaFBvcyA+IC0xKSB7XG4gICAgICAgICAgICB2YXIgc2xhc2hDb3VudCA9IHR4dC5zcGxpdChcIi9cIik7XG4gICAgICAgICAgICBpZiAoc2xhc2hDb3VudC5sZW5ndGggPiAzKSB7XG4gICAgICAgICAgICAgICAgcmFuZ2VEZWxpbSA9IFwiLVwiO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXF8vZywgXCItXCIpO1xuICAgICAgICAgICAgICAgIGRhdGVEZWxpbSA9IFwiL1wiO1xuICAgICAgICAgICAgICAgIGxzdCA9IHR4dC5zcGxpdChyZXhTbGFzaERhc2gpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByYW5nZURlbGltID0gXCIvXCI7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2UoL1xcXy9nLCBcIi9cIik7XG4gICAgICAgICAgICAgICAgZGF0ZURlbGltID0gXCItXCI7XG4gICAgICAgICAgICAgICAgbHN0ID0gdHh0LnNwbGl0KHJleERhc2hTbGFzaCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0eHQgPSB0eHQucmVwbGFjZSgvXFwvL2csIFwiLVwiKTtcbiAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXF8vZywgXCItXCIpO1xuICAgICAgICAgICAgcmFuZ2VEZWxpbSA9IFwiLVwiO1xuICAgICAgICAgICAgZGF0ZURlbGltID0gXCItXCI7XG4gICAgICAgICAgICBsc3QgPSB0eHQuc3BsaXQocmV4RGFzaCk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHJldCA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1sc3QubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdmFyIG0gPSBsc3RbaV0ubWF0Y2goL15cXHMqKFtcXC1cXC9dfFteXFwtXFwvXFx+XFw/MC05XSt8W1xcLX4/MC05XSspXFxzKiQvKTtcbiAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2gobVsxXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGRlbGltUG9zID0gcmV0LmluZGV4T2YocmFuZ2VEZWxpbSk7XG4gICAgICAgIHZhciBkZWxpbXMgPSBbXTtcbiAgICAgICAgdmFyIGlzUmFuZ2UgPSBmYWxzZTtcbiAgICAgICAgaWYgKGRlbGltUG9zID4gLTEpIHtcbiAgICAgICAgICAgIGRlbGltcy5wdXNoKFswLCBkZWxpbVBvc10pO1xuICAgICAgICAgICAgZGVsaW1zLnB1c2goWyhkZWxpbVBvcyArIDEpLCByZXQubGVuZ3RoXSk7XG4gICAgICAgICAgICBpc1JhbmdlID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRlbGltcy5wdXNoKFswLCByZXQubGVuZ3RoXSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHN1ZmYgPSBcIlwiO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1kZWxpbXMubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdmFyIGRlbGltID0gZGVsaW1zW2ldO1xuICAgICAgICAgICAgdmFyIGRhdGUgPSByZXQuc2xpY2UoZGVsaW1bMF0sIGRlbGltWzFdKTtcbiAgICAgICAgICAgIG91dGVyOiBcbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPWRhdGUubGVuZ3RoOyBqPGpsZW47IGorKykge1xuICAgICAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZGF0ZVtqXTtcbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5pbmRleE9mKGRhdGVEZWxpbSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJzZU51bWVyaWNEYXRlKHRoZWRhdGUsIGRhdGVEZWxpbSwgc3VmZiwgZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5tYXRjaCgvWzAtOV17NH0vKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGVkYXRlWyhcInllYXJcIiArIHN1ZmYpXSA9IGVsZW1lbnQucmVwbGFjZSgvXjAqLywgXCJcIik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBrPTAsa2xlbj10aGlzLm1vbnRoUmV4ZXMubGVuZ3RoOyBrPGtsZW47IGsrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC50b0xvY2FsZUxvd2VyQ2FzZSgpLm1hdGNoKHRoaXMubW9udGhSZXhlc1trXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoZWRhdGVbKFwibW9udGhcIiArIHN1ZmYpXSA9IFwiXCIgKyAocGFyc2VJbnQoaywgMTApICsgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBvdXRlcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5tYXRjaCgvXlswLTldKyQvKSkge1xuICAgICAgICAgICAgICAgICAgICBudW1iZXIgPSBlbGVtZW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC50b0xvY2FsZUxvd2VyQ2FzZSgpLm1hdGNoKC9eYmMvKSAmJiBudW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhlZGF0ZVsoXCJ5ZWFyXCIgKyBzdWZmKV0gPSBcIlwiICsgKG51bWJlciAqIC0xKTtcbiAgICAgICAgICAgICAgICAgICAgbnVtYmVyID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LnRvTG9jYWxlTG93ZXJDYXNlKCkubWF0Y2goL15hZC8pICYmIG51bWJlcikge1xuICAgICAgICAgICAgICAgICAgICB0aGVkYXRlWyhcInllYXJcIiArIHN1ZmYpXSA9IFwiXCIgKyBudW1iZXI7XG4gICAgICAgICAgICAgICAgICAgIG51bWJlciA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudCA9PT0gXCJ+XCIgfHwgZWxlbWVudCA9PT0gXCI/XCIgfHwgZWxlbWVudCA9PT0gXCJjXCIgfHwgZWxlbWVudC5tYXRjaCgvXmNpci8pKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoZWRhdGUuY2lyY2EgPSBcIlwiICsgMTtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LnRvTG9jYWxlTG93ZXJDYXNlKCkubWF0Y2goLyg/Om1pY3x0cml8aGlsfGVhcykvKSAmJiAhdGhlZGF0ZVsoXCJzZWFzb25cIiArIHN1ZmYpXSkge1xuICAgICAgICAgICAgICAgICAgICBub3RlID0gZWxlbWVudDtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG51bWJlcikge1xuICAgICAgICAgICAgICAgIHRoZWRhdGVbKFwiZGF5XCIgKyBzdWZmKV0gPSBudW1iZXI7XG4gICAgICAgICAgICAgICAgbnVtYmVyID0gXCJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChub3RlICYmICF0aGVkYXRlWyhcInNlYXNvblwiICsgc3VmZildKSB7XG4gICAgICAgICAgICAgICAgdGhlZGF0ZVsoXCJzZWFzb25cIiArIHN1ZmYpXSA9IG5vdGU7XG4gICAgICAgICAgICAgICAgbm90ZSA9IFwiXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdWZmID0gXCJfZW5kXCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzUmFuZ2UpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPUNTTC5EQVRFX1BBUlRTX0FMTC5sZW5ndGg7IGo8amxlbjsgaisrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSBDU0wuREFURV9QQVJUU19BTExbal07XG4gICAgICAgICAgICAgICAgaWYgKHRoZWRhdGVbaXRlbV0gJiYgIXRoZWRhdGVbKGl0ZW0gKyBcIl9lbmRcIildKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoZWRhdGVbKGl0ZW0gKyBcIl9lbmRcIildID0gdGhlZGF0ZVtpdGVtXTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGVkYXRlW2l0ZW1dICYmIHRoZWRhdGVbKGl0ZW0gKyBcIl9lbmRcIildKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoZWRhdGVbaXRlbV0gPSB0aGVkYXRlWyhpdGVtICsgXCJfZW5kXCIpXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGVkYXRlLnllYXIgfHwgKHRoZWRhdGUueWVhciAmJiB0aGVkYXRlLmRheSAmJiAhdGhlZGF0ZS5tb250aCkpIHtcbiAgICAgICAgICAgIHRoZWRhdGUgPSB7IFwibGl0ZXJhbFwiOiBvcmlnIH07XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHBhcnRzID0gW1wieWVhclwiLCBcIm1vbnRoXCIsIFwiZGF5XCIsIFwieWVhcl9lbmRcIiwgXCJtb250aF9lbmRcIiwgXCJkYXlfZW5kXCJdO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1wYXJ0cy5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgcGFydCA9IHBhcnRzW2ldO1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiB0aGVkYXRlW3BhcnRdICYmIHRoZWRhdGVbcGFydF0ubWF0Y2goL15bMC05XSskLykpIHtcbiAgICAgICAgICAgICAgICB0aGVkYXRlW3BhcnRdID0gcGFyc2VJbnQodGhlZGF0ZVtwYXJ0XSwgMTApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh5ZWFySXNOZWdhdGl2ZSAmJiBPYmplY3Qua2V5cyh0aGVkYXRlKS5pbmRleE9mKFwieWVhclwiKSA+IC0xKSB7XG4gICAgICAgICAgICB0aGVkYXRlLnllYXIgPSAodGhlZGF0ZS55ZWFyICogLTEpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGVkYXRlO1xuICAgIH07XG4gICAgdGhpcy5wYXJzZURhdGVUb0FycmF5ID0gZnVuY3Rpb24odHh0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnZlcnREYXRlT2JqZWN0VG9BcnJheSh0aGlzLnBhcnNlRGF0ZVRvT2JqZWN0KHR4dCkpOyAgICAgICAgICAgIFxuICAgIH1cbiAgICB0aGlzLnBhcnNlRGF0ZVRvU3RyaW5nID0gZnVuY3Rpb24odHh0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnZlcnREYXRlT2JqZWN0VG9TdHJpbmcodGhpcy5wYXJzZURhdGVUb09iamVjdCh0eHQpKTtcbiAgICB9XG4gICAgdGhpcy5wYXJzZSA9IGZ1bmN0aW9uKHR4dCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZURhdGVUb09iamVjdCh0eHQpO1xuICAgIH1cbiAgICB0aGlzLnNldE9yZGVyTW9udGhEYXkoKTtcbiAgICB0aGlzLnJlc2V0RGF0ZVBhcnNlck1vbnRocygpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkVuZ2luZSA9IGZ1bmN0aW9uIChzeXMsIHN0eWxlLCBsYW5nLCBmb3JjZUxhbmcpIHtcbiAgICB2YXIgYXR0cnMsIGxhbmdzcGVjLCBsb2NhbGV4bWwsIGxvY2FsZTtcbiAgICB0aGlzLnByb2Nlc3Nvcl92ZXJzaW9uID0gQ1NMLlBST0NFU1NPUl9WRVJTSU9OO1xuICAgIHRoaXMuY3NsX3ZlcnNpb24gPSBcIjEuMFwiO1xuICAgIHRoaXMuc3lzID0gc3lzO1xuICAgIGlmIChzeXMudmFyaWFibGVXcmFwcGVyKSB7XG4gICAgICAgIENTTC5WQVJJQUJMRV9XUkFQUEVSX1BSRVBVTkNUX1JFWCA9IG5ldyBSZWdFeHAoJ14oWycgKyBbXCIgXCJdLmNvbmNhdChDU0wuU1dBUFBJTkdfUFVOQ1RVQVRJT04pLmpvaW4oXCJcIikgKyAnXSopKC4qKScpO1xuICAgIH1cbiAgICBpZiAoQ1NMLnJldHJpZXZlU3R5bGVNb2R1bGUpIHtcbiAgICAgICAgdGhpcy5zeXMucmV0cmlldmVTdHlsZU1vZHVsZSA9IENTTC5yZXRyaWV2ZVN0eWxlTW9kdWxlO1xuICAgIH1cbiAgICBpZiAoQ1NMLmdldEFiYnJldmlhdGlvbikge1xuICAgICAgICB0aGlzLnN5cy5nZXRBYmJyZXZpYXRpb24gPSBDU0wuZ2V0QWJicmV2aWF0aW9uO1xuICAgIH1cbiAgICBpZiAodGhpcy5zeXMuc3RyaW5nQ29tcGFyZSkge1xuICAgICAgICBDU0wuc3RyaW5nQ29tcGFyZSA9IHRoaXMuc3lzLnN0cmluZ0NvbXBhcmU7XG4gICAgfVxuICAgIHRoaXMuc3lzLkFiYnJldmlhdGlvblNlZ21lbnRzID0gQ1NMLkFiYnJldmlhdGlvblNlZ21lbnRzO1xuICAgIHRoaXMucGFyYWxsZWwgPSBuZXcgQ1NMLlBhcmFsbGVsKHRoaXMpO1xuICAgIHRoaXMudHJhbnNmb3JtID0gbmV3IENTTC5UcmFuc2Zvcm0odGhpcyk7XG4gICAgdGhpcy5zZXRQYXJzZU5hbWVzID0gZnVuY3Rpb24gKHZhbCkge1xuICAgICAgICB0aGlzLm9wdFsncGFyc2UtbmFtZXMnXSA9IHZhbDtcbiAgICB9O1xuICAgIHRoaXMub3B0ID0gbmV3IENTTC5FbmdpbmUuT3B0KCk7XG4gICAgdGhpcy50bXAgPSBuZXcgQ1NMLkVuZ2luZS5UbXAoKTtcbiAgICB0aGlzLmJ1aWxkID0gbmV3IENTTC5FbmdpbmUuQnVpbGQoKTtcbiAgICB0aGlzLmZ1biA9IG5ldyBDU0wuRW5naW5lLkZ1bih0aGlzKTtcbiAgICB0aGlzLmNvbmZpZ3VyZSA9IG5ldyBDU0wuRW5naW5lLkNvbmZpZ3VyZSgpO1xuICAgIHRoaXMuY2l0YXRpb25fc29ydCA9IG5ldyBDU0wuRW5naW5lLkNpdGF0aW9uU29ydCgpO1xuICAgIHRoaXMuYmlibGlvZ3JhcGh5X3NvcnQgPSBuZXcgQ1NMLkVuZ2luZS5CaWJsaW9ncmFwaHlTb3J0KCk7XG4gICAgdGhpcy5jaXRhdGlvbiA9IG5ldyBDU0wuRW5naW5lLkNpdGF0aW9uKHRoaXMpO1xuICAgIHRoaXMuYmlibGlvZ3JhcGh5ID0gbmV3IENTTC5FbmdpbmUuQmlibGlvZ3JhcGh5KCk7XG4gICAgdGhpcy5vdXRwdXQgPSBuZXcgQ1NMLk91dHB1dC5RdWV1ZSh0aGlzKTtcbiAgICB0aGlzLmRhdGVwdXQgPSBuZXcgQ1NMLk91dHB1dC5RdWV1ZSh0aGlzKTtcbiAgICB0aGlzLmNzbFhtbCA9IENTTC5zZXR1cFhtbChzdHlsZSk7XG4gICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuY3NsX3JldmVyc2VfbG9va3VwX3N1cHBvcnQgfHwgdGhpcy5zeXMuY3NsX3JldmVyc2VfbG9va3VwX3N1cHBvcnQpIHtcbiAgICAgICAgdGhpcy5idWlsZC5jc2xOb2RlSWQgPSAwO1xuICAgICAgICB0aGlzLnNldENzbE5vZGVJZHMgPSBmdW5jdGlvbihteXhtbCwgbm9kZW5hbWUpIHtcbiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY3NsWG1sLmNoaWxkcmVuKG15eG1sKTtcbiAgICAgICAgICAgIHRoaXMuY3NsWG1sLnNldEF0dHJpYnV0ZShteXhtbCwgJ2NzbGlkJywgdGhpcy5idWlsZC5jc2xOb2RlSWQpO1xuICAgICAgICAgICAgdGhpcy5vcHQubm9kZW5hbWVzLnB1c2gobm9kZW5hbWUpO1xuICAgICAgICAgICAgdGhpcy5idWlsZC5jc2xOb2RlSWQgKz0gMTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5jc2xYbWwubnVtYmVyb2Zub2RlcyhjaGlsZHJlbik7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBub2RlbmFtZSA9IHRoaXMuY3NsWG1sLm5vZGVuYW1lKGNoaWxkcmVuW2ldKTtcbiAgICAgICAgICAgICAgICBpZiAobm9kZW5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDc2xOb2RlSWRzKGNoaWxkcmVuW2ldLCBub2RlbmFtZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNldENzbE5vZGVJZHModGhpcy5jc2xYbWwuZGF0YU9iaiwgXCJzdHlsZVwiKTtcbiAgICB9XG4gICAgdGhpcy5jc2xYbWwuYWRkTWlzc2luZ05hbWVOb2Rlcyh0aGlzLmNzbFhtbC5kYXRhT2JqKTtcbiAgICB0aGlzLmNzbFhtbC5hZGRJbnN0aXR1dGlvbk5vZGVzKHRoaXMuY3NsWG1sLmRhdGFPYmopO1xuICAgIHRoaXMuY3NsWG1sLmluc2VydFB1Ymxpc2hlckFuZFBsYWNlKHRoaXMuY3NsWG1sLmRhdGFPYmopO1xuICAgIHRoaXMuY3NsWG1sLmZsYWdEYXRlTWFjcm9zKHRoaXMuY3NsWG1sLmRhdGFPYmopO1xuICAgIGF0dHJzID0gdGhpcy5jc2xYbWwuYXR0cmlidXRlcyh0aGlzLmNzbFhtbC5kYXRhT2JqKTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGF0dHJzW1wiQHNvcnQtc2VwYXJhdG9yXCJdKSB7XG4gICAgICAgIHRoaXMuY3NsWG1sLnNldEF0dHJpYnV0ZSh0aGlzLmNzbFhtbC5kYXRhT2JqLCBcInNvcnQtc2VwYXJhdG9yXCIsIFwiLCBcIik7XG4gICAgfVxuICAgIHRoaXMub3B0W1wiaW5pdGlhbGl6ZS13aXRoLWh5cGhlblwiXSA9IHRydWU7XG4gICAgdGhpcy5zZXRTdHlsZUF0dHJpYnV0ZXMoKTtcbiAgICB0aGlzLm9wdC54Y2xhc3MgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZSh0aGlzLmNzbFhtbC5kYXRhT2JqLCBcImNsYXNzXCIpO1xuICAgIHRoaXMub3B0W1wiY2xhc3NcIl0gPSB0aGlzLm9wdC54Y2xhc3M7XG4gICAgdGhpcy5vcHQuc3R5bGVJRCA9IHRoaXMuY3NsWG1sLmdldFN0eWxlSWQodGhpcy5jc2xYbWwuZGF0YU9iaik7XG4gICAgdGhpcy5vcHQuc3R5bGVOYW1lID0gdGhpcy5jc2xYbWwuZ2V0U3R5bGVJZCh0aGlzLmNzbFhtbC5kYXRhT2JqLCB0cnVlKTtcbiAgICBpZiAodGhpcy5vcHQudmVyc2lvbi5zbGljZSgwLDQpID09PSBcIjEuMW1cIikge1xuICAgICAgICB0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnN0YXRpY19zdGF0dXRlX2xvY2F0b3IgPSB0cnVlO1xuICAgICAgICB0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmhhbmRsZV9wYXJhbGxlbF9hcnRpY2xlcyA9IHRydWU7XG4gICAgICAgIHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMubWFpbl90aXRsZV9mcm9tX3Nob3J0X3RpdGxlID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ydGxfc3VwcG9ydCA9IHRydWU7XG4gICAgICAgIHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZXhwZWN0X2FuZF9zeW1ib2xfZm9ybSA9IHRydWU7XG4gICAgICAgIHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMucmVxdWlyZV9leHBsaWNpdF9sZWdhbF9jYXNlX3RpdGxlX3Nob3J0ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5mb3JjZV9qdXJpc2RpY3Rpb24gPSB0cnVlO1xuICAgIH1cbiAgICBpZiAobGFuZykge1xuICAgICAgICBsYW5nID0gbGFuZy5yZXBsYWNlKFwiX1wiLCBcIi1cIik7XG4gICAgICAgIGxhbmcgPSBDU0wubm9ybWFsaXplTG9jYWxlU3RyKGxhbmcpO1xuICAgIH1cbiAgICBpZiAodGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXSkge1xuICAgICAgICB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdID0gdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXS5yZXBsYWNlKFwiX1wiLCBcIi1cIik7XG4gICAgICAgIHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0gPSBDU0wubm9ybWFsaXplTG9jYWxlU3RyKHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0pO1xuICAgIH1cbiAgICBpZiAobGFuZyAmJiBmb3JjZUxhbmcpIHtcbiAgICAgICAgdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXSA9IFtsYW5nXTtcbiAgICB9XG4gICAgaWYgKGxhbmcgJiYgIWZvcmNlTGFuZyAmJiB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdKSB7XG4gICAgICAgIGxhbmcgPSB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdO1xuICAgIH1cbiAgICBpZiAodGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgaWYgKCFsYW5nKSB7XG4gICAgICAgICAgICBsYW5nID0gXCJlbi1VU1wiO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl0ucHVzaChcImVuLVVTXCIpO1xuICAgIH1cbiAgICBpZiAoIWxhbmcpIHtcbiAgICAgICAgbGFuZyA9IHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF07XG4gICAgfVxuICAgIGxhbmdzcGVjID0gQ1NMLmxvY2FsZVJlc29sdmUobGFuZyk7XG4gICAgdGhpcy5vcHQubGFuZyA9IGxhbmdzcGVjLmJlc3Q7XG4gICAgdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXSA9IGxhbmdzcGVjLmJlc3Q7XG4gICAgdGhpcy5sb2NhbGUgPSB7fTtcbiAgICBpZiAoIXRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGUtc29ydFwiXSkge1xuICAgICAgICB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlLXNvcnRcIl0gPSB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdO1xuICAgIH1cbiAgICBpZiAoJ2RhbGV8Jy5sb2NhbGVDb21wYXJlKCdkYWxlYicsIHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGUtc29ydFwiXSkgPiAtMSkge1xuICAgICAgICB0aGlzLm9wdC5zb3J0X3NlcCA9IFwiQFwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMub3B0LnNvcnRfc2VwID0gXCJ8XCI7XG4gICAgfVxuICAgIHRoaXMubG9jYWxlQ29uZmlndXJlKGxhbmdzcGVjKTtcbiAgICBmdW5jdGlvbiBtYWtlUmVnRXhwKGxzdCkge1xuICAgICAgICB2YXIgbHN0ID0gbHN0LnNsaWNlKCk7XG4gICAgICAgIHZhciByZXQgPSBuZXcgUmVnRXhwKCBcIig/Oig/Ols/ITpdKlxcXFxzK3wtfF4pKD86XCIgKyBsc3Quam9pbihcInxcIikgKyBcIikoPz1bIT86XSpcXFxccyt8LXwkKSlcIiwgXCJnXCIpO1xuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICB0aGlzLmxvY2FsZVt0aGlzLm9wdC5sYW5nXS5vcHRzW1wic2tpcC13b3Jkcy1yZWdleHBcIl0gPSBtYWtlUmVnRXhwKHRoaXMubG9jYWxlW3RoaXMub3B0LmxhbmddLm9wdHNbXCJza2lwLXdvcmRzXCJdKTtcbiAgICB0aGlzLm91dHB1dC5hZGp1c3QgPSBuZXcgQ1NMLk91dHB1dC5RdWV1ZS5hZGp1c3QodGhpcy5nZXRPcHQoJ3B1bmN0dWF0aW9uLWluLXF1b3RlJykpO1xuICAgIHRoaXMucmVnaXN0cnkgPSBuZXcgQ1NMLlJlZ2lzdHJ5KHRoaXMpO1xuICAgIHRoaXMubWFjcm9zID0ge307XG4gICAgdGhpcy5idWlsZC5hcmVhID0gXCJjaXRhdGlvblwiO1xuICAgIHZhciBhcmVhX25vZGVzID0gdGhpcy5jc2xYbWwuZ2V0Tm9kZXNCeU5hbWUodGhpcy5jc2xYbWwuZGF0YU9iaiwgdGhpcy5idWlsZC5hcmVhKTtcbiAgICB0aGlzLmJ1aWxkVG9rZW5MaXN0cyhhcmVhX25vZGVzLCB0aGlzW3RoaXMuYnVpbGQuYXJlYV0udG9rZW5zKTtcbiAgICB0aGlzLmJ1aWxkLmFyZWEgPSBcImJpYmxpb2dyYXBoeVwiO1xuICAgIHZhciBhcmVhX25vZGVzID0gdGhpcy5jc2xYbWwuZ2V0Tm9kZXNCeU5hbWUodGhpcy5jc2xYbWwuZGF0YU9iaiwgdGhpcy5idWlsZC5hcmVhKTtcbiAgICB0aGlzLmJ1aWxkVG9rZW5MaXN0cyhhcmVhX25vZGVzLCB0aGlzW3RoaXMuYnVpbGQuYXJlYV0udG9rZW5zKTtcbiAgICB0aGlzLmp1cmlzID0ge307XG4gICAgdGhpcy5jb25maWd1cmVUb2tlbkxpc3RzKCk7XG4gICAgdGhpcy5kaXNhbWJpZ3VhdGUgPSBuZXcgQ1NMLkRpc2FtYmlndWF0aW9uKHRoaXMpO1xuICAgIHRoaXMuc3BsaWNlX2RlbGltaXRlciA9IGZhbHNlO1xuICAgIHRoaXMuZnVuLmRhdGVwYXJzZXIgPSBDU0wuRGF0ZVBhcnNlcjtcbiAgICB0aGlzLmZ1bi5mbGlwZmxvcHBlciA9IG5ldyBDU0wuVXRpbC5GbGlwRmxvcHBlcih0aGlzKTtcbiAgICB0aGlzLnNldENsb3NlUXVvdGVzQXJyYXkoKTtcbiAgICB0aGlzLmZ1bi5vcmRpbmFsaXplci5pbml0KHRoaXMpO1xuICAgIHRoaXMuZnVuLmxvbmdfb3JkaW5hbGl6ZXIuaW5pdCh0aGlzKTtcbiAgICB0aGlzLmZ1bi5wYWdlX21hbmdsZXIgPSBDU0wuVXRpbC5QYWdlUmFuZ2VNYW5nbGVyLmdldEZ1bmN0aW9uKHRoaXMsIFwicGFnZVwiKTtcbiAgICB0aGlzLmZ1bi55ZWFyX21hbmdsZXIgPSBDU0wuVXRpbC5QYWdlUmFuZ2VNYW5nbGVyLmdldEZ1bmN0aW9uKHRoaXMsIFwieWVhclwiKTtcbiAgICB0aGlzLnNldE91dHB1dEZvcm1hdChcImh0bWxcIik7XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuc2V0Q2xvc2VRdW90ZXNBcnJheSA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcmV0O1xuICAgIHJldCA9IFtdO1xuICAgIHJldC5wdXNoKHRoaXMuZ2V0VGVybShcImNsb3NlLXF1b3RlXCIpKTtcbiAgICByZXQucHVzaCh0aGlzLmdldFRlcm0oXCJjbG9zZS1pbm5lci1xdW90ZVwiKSk7XG4gICAgcmV0LnB1c2goJ1wiJyk7XG4gICAgcmV0LnB1c2goXCInXCIpO1xuICAgIHRoaXMub3B0LmNsb3NlX3F1b3Rlc19hcnJheSA9IHJldDtcbn07XG5DU0wubWFrZUJ1aWxkZXIgPSBmdW5jdGlvbiAobWUsIHRhcmdldCkge1xuICAgIHZhciB2YXJfc3RhY2sgPSBbXTtcbiAgICBmdW5jdGlvbiBlbnRlckZ1bmMgKG5vZGUpIHtcbiAgICAgICAgQ1NMLlhtbFRvVG9rZW4uY2FsbChub2RlLCBtZSwgQ1NMLlNUQVJULCB0YXJnZXQsIHZhcl9zdGFjayk7XG4gICAgfTtcbiAgICBmdW5jdGlvbiBsZWF2ZUZ1bmMgKG5vZGUpIHtcbiAgICAgICAgQ1NMLlhtbFRvVG9rZW4uY2FsbChub2RlLCBtZSwgQ1NMLkVORCwgdGFyZ2V0LCB2YXJfc3RhY2spO1xuICAgIH07XG4gICAgZnVuY3Rpb24gc2luZ2xldG9uRnVuYyAobm9kZSkge1xuICAgICAgICBDU0wuWG1sVG9Ub2tlbi5jYWxsKG5vZGUsIG1lLCBDU0wuU0lOR0xFVE9OLCB0YXJnZXQsIHZhcl9zdGFjayk7XG4gICAgfTtcbiAgICBmdW5jdGlvbiBidWlsZFN0eWxlIChub2RlKSB7XG4gICAgICAgIHZhciBzdGFydHRhZywgb3JpZ3BhcmVudDtcbiAgICAgICAgaWYgKG1lLmNzbFhtbC5udW1iZXJvZm5vZGVzKG1lLmNzbFhtbC5jaGlsZHJlbihub2RlKSkpIHtcbiAgICAgICAgICAgIG9yaWdwYXJlbnQgPSBub2RlO1xuICAgICAgICAgICAgZW50ZXJGdW5jKG9yaWdwYXJlbnQpO1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wO2k8bWUuY3NsWG1sLm51bWJlcm9mbm9kZXMobWUuY3NsWG1sLmNoaWxkcmVuKG9yaWdwYXJlbnQpKTtpKz0xKSB7XG4gICAgICAgICAgICAgICAgbm9kZSA9IG1lLmNzbFhtbC5jaGlsZHJlbihvcmlncGFyZW50KVtpXTtcbiAgICAgICAgICAgICAgICBpZiAobWUuY3NsWG1sLm5vZGVuYW1lKG5vZGUpID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobWUuY3NsWG1sLm5vZGVuYW1lKG5vZGUpID09PSBcImRhdGVcIikge1xuICAgICAgICAgICAgICAgICAgICBDU0wuVXRpbC5maXhEYXRlTm9kZS5jYWxsKG1lLCBvcmlncGFyZW50LCBpLCBub2RlKVxuICAgICAgICAgICAgICAgICAgICBub2RlID0gbWUuY3NsWG1sLmNoaWxkcmVuKG9yaWdwYXJlbnQpW2ldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBidWlsZFN0eWxlKG5vZGUsIGVudGVyRnVuYywgbGVhdmVGdW5jLCBzaW5nbGV0b25GdW5jKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxlYXZlRnVuYyhvcmlncGFyZW50KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNpbmdsZXRvbkZ1bmMobm9kZSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGJ1aWxkU3R5bGU7XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuYnVpbGRUb2tlbkxpc3RzID0gZnVuY3Rpb24gKGFyZWFfbm9kZXMsIHRhcmdldCkge1xuICAgIGlmICghdGhpcy5jc2xYbWwuZ2V0Tm9kZVZhbHVlKGFyZWFfbm9kZXMpKSByZXR1cm47XG4gICAgdmFyIGJ1aWxkZXIgPSBDU0wubWFrZUJ1aWxkZXIodGhpcywgdGFyZ2V0KTtcbiAgICB2YXIgbXlub2RlO1xuICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgYXJlYV9ub2Rlcy5sZW5ndGgpIHtcbiAgICAgICAgbXlub2RlID0gYXJlYV9ub2RlcztcbiAgICB9IGVsc2Uge1xuICAgICAgICBteW5vZGUgPSBhcmVhX25vZGVzWzBdO1xuICAgIH1cbiAgICBidWlsZGVyKG15bm9kZSk7XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuc2V0U3R5bGVBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBkdW1teSwgYXR0ciwga2V5LCBhdHRyaWJ1dGVzLCBhdHRybmFtZTtcbiAgICB2YXIgZHVtbXkgPSB7fTtcbiAgICBkdW1teS5uYW1lID0gdGhpcy5jc2xYbWwubm9kZW5hbWUodGhpcy5jc2xYbWwuZGF0YU9iaik7XG4gICAgYXR0cmlidXRlcyA9IHRoaXMuY3NsWG1sLmF0dHJpYnV0ZXModGhpcy5jc2xYbWwuZGF0YU9iaik7XG4gICAgZm9yIChhdHRybmFtZSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KGF0dHJuYW1lKSkge1xuICAgICAgICAgICAgQ1NMLkF0dHJpYnV0ZXNbYXR0cm5hbWVdLmNhbGwoZHVtbXksIHRoaXMsIGF0dHJpYnV0ZXNbYXR0cm5hbWVdKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5nZXRUZXJtID0gZnVuY3Rpb24gKHRlcm0sIGZvcm0sIHBsdXJhbCwgZ2VuZGVyLCBtb2RlLCBmb3JjZURlZmF1bHRMb2NhbGUpIHtcbiAgICBpZiAodGVybSAmJiB0ZXJtLm1hdGNoKC9bQS1aXS8pICYmIHRlcm0gPT09IHRlcm0udG9VcHBlckNhc2UoKSkge1xuICAgICAgICBDU0wuZGVidWcoXCJXYXJuaW5nOiB0ZXJtIGtleSBpcyBpbiB1cHBlcmNhc2UgZm9ybTogXCIrdGVybSk7XG4gICAgICAgIHRlcm0gPSB0ZXJtLnRvTG93ZXJDYXNlKCk7XG4gICAgfVxuICAgIHZhciBsYW5nO1xuICAgIGlmIChmb3JjZURlZmF1bHRMb2NhbGUpIHtcbiAgICAgICAgbGFuZyA9IHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbGFuZyA9IHRoaXMub3B0Lmxhbmc7XG4gICAgfVxuICAgIHZhciByZXQgPSBDU0wuRW5naW5lLmdldEZpZWxkKENTTC5MT09TRSwgdGhpcy5sb2NhbGVbbGFuZ10udGVybXMsIHRlcm0sIGZvcm0sIHBsdXJhbCwgZ2VuZGVyKTtcbiAgICBpZiAoIXJldCAmJiB0ZXJtID09PSBcInJhbmdlLWRlbGltaXRlclwiKSB7XG4gICAgICAgIHJldCA9IFwiXFx1MjAxM1wiO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHJldCA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICBpZiAobW9kZSA9PT0gQ1NMLlNUUklDVCkge1xuICAgICAgICAgICAgdGhyb3cgXCJFcnJvciBpbiBnZXRUZXJtOiB0ZXJtIFxcXCJcIiArIHRlcm0gKyBcIlxcXCIgZG9lcyBub3QgZXhpc3QuXCI7XG4gICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gQ1NMLlRPTEVSQU5UKSB7XG4gICAgICAgICAgICByZXQgPSBcIlwiO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChyZXQpIHtcbiAgICAgICAgdGhpcy50bXAuY2l0ZV9yZW5kZXJzX2NvbnRlbnQgPSB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmdldERhdGUgPSBmdW5jdGlvbiAoZm9ybSwgZm9yY2VEZWZhdWx0TG9jYWxlKSB7XG4gICAgdmFyIGxhbmc7XG4gICAgaWYgKGZvcmNlRGVmYXVsdExvY2FsZSkge1xuICAgICAgICBsYW5nID0gdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBsYW5nID0gdGhpcy5vcHQubGFuZztcbiAgICB9XG4gICAgaWYgKHRoaXMubG9jYWxlW2xhbmddLmRhdGVzW2Zvcm1dKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsZVtsYW5nXS5kYXRlc1tmb3JtXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmdldE9wdCA9IGZ1bmN0aW9uIChhcmcpIHtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIHRoaXMubG9jYWxlW3RoaXMub3B0LmxhbmddLm9wdHNbYXJnXSkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVbdGhpcy5vcHQubGFuZ10ub3B0c1thcmddO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuZ2V0VmFyaWFibGUgPSBmdW5jdGlvbiAoSXRlbSwgdmFybmFtZSwgZm9ybSwgcGx1cmFsKSB7XG4gICAgcmV0dXJuIENTTC5FbmdpbmUuZ2V0RmllbGQoQ1NMLkxPT1NFLCBJdGVtLCB2YXJuYW1lLCBmb3JtLCBwbHVyYWwpO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmdldERhdGVOdW0gPSBmdW5jdGlvbiAoSXRlbUZpZWxkLCBwYXJ0bmFtZSkge1xuICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgSXRlbUZpZWxkKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBJdGVtRmllbGRbcGFydG5hbWVdO1xuICAgIH1cbn07XG5DU0wuRW5naW5lLmdldEZpZWxkID0gZnVuY3Rpb24gKG1vZGUsIGhhc2gsIHRlcm0sIGZvcm0sIHBsdXJhbCwgZ2VuZGVyKSB7XG4gICAgdmFyIHJldCwgZm9ybXMsIGYsIHBvcywgbGVuLCBoYXNodGVybTtcbiAgICByZXQgPSBcIlwiO1xuICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgaGFzaFt0ZXJtXSkge1xuICAgICAgICBpZiAobW9kZSA9PT0gQ1NMLlNUUklDVCkge1xuICAgICAgICAgICAgdGhyb3cgXCJFcnJvciBpbiBnZXRGaWVsZDogdGVybSBcXFwiXCIgKyB0ZXJtICsgXCJcXFwiIGRvZXMgbm90IGV4aXN0LlwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoZ2VuZGVyICYmIGhhc2hbdGVybV1bZ2VuZGVyXSkge1xuICAgICAgICBoYXNodGVybSA9IGhhc2hbdGVybV1bZ2VuZGVyXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBoYXNodGVybSA9IGhhc2hbdGVybV07XG4gICAgfVxuICAgIGZvcm1zID0gW107XG4gICAgaWYgKGZvcm0gPT09IFwic3ltYm9sXCIpIHtcbiAgICAgICAgZm9ybXMgPSBbXCJzeW1ib2xcIiwgXCJzaG9ydFwiXTtcbiAgICB9IGVsc2UgaWYgKGZvcm0gPT09IFwidmVyYi1zaG9ydFwiKSB7XG4gICAgICAgIGZvcm1zID0gW1widmVyYi1zaG9ydFwiLCBcInZlcmJcIl07XG4gICAgfSBlbHNlIGlmIChmb3JtICE9PSBcImxvbmdcIikge1xuICAgICAgICBmb3JtcyA9IFtmb3JtXTtcbiAgICB9XG4gICAgZm9ybXMgPSBmb3Jtcy5jb25jYXQoW1wibG9uZ1wiXSk7XG4gICAgbGVuID0gZm9ybXMubGVuZ3RoO1xuICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBmID0gZm9ybXNbcG9zXTtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBoYXNodGVybSB8fCBcIm51bWJlclwiID09PSB0eXBlb2YgaGFzaHRlcm0pIHtcbiAgICAgICAgICAgIHJldCA9IGhhc2h0ZXJtO1xuICAgICAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiBoYXNodGVybVtmXSkge1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBoYXNodGVybVtmXSB8fCBcIm51bWJlclwiID09PSB0eXBlb2YgaGFzaHRlcm1bZl0pIHtcbiAgICAgICAgICAgICAgICByZXQgPSBoYXNodGVybVtmXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKFwibnVtYmVyXCIgPT09IHR5cGVvZiBwbHVyYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0ID0gaGFzaHRlcm1bZl1bcGx1cmFsXTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXQgPSBoYXNodGVybVtmXVswXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmNvbmZpZ3VyZVRva2VuTGlzdHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGRhdGVwYXJ0c19tYXN0ZXIsIGFyZWEsIHBvcywgdG9rZW4sIGRhdGVwYXJ0cywgcGFydCwgcHBvcywgcHBwb3MsIGxlbiwgbGxlbiwgbGxsZW47XG4gICAgbGVuID0gQ1NMLkFSRUFTLmxlbmd0aDtcbiAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgYXJlYSA9IENTTC5BUkVBU1twb3NdO1xuICAgICAgICB2YXIgdG9rZW5zID0gdGhpc1thcmVhXS50b2tlbnM7XG4gICAgICAgIHRoaXMuY29uZmlndXJlVG9rZW5MaXN0KHRva2Vucyk7XG4gICAgfVxuICAgIHRoaXMudmVyc2lvbiA9IENTTC52ZXJzaW9uO1xuICAgIHJldHVybiB0aGlzLnN0YXRlO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmNvbmZpZ3VyZVRva2VuTGlzdCA9IGZ1bmN0aW9uICh0b2tlbnMpIHtcbiAgICB2YXIgZGF0ZXBhcnRzX21hc3RlciwgYXJlYSwgcG9zLCB0b2tlbiwgZGF0ZXBhcnRzLCBwYXJ0LCBwcG9zLCBwcHBvcywgbGVuLCBsbGVuLCBsbGxlbjtcbiAgICBkYXRlcGFydHNfbWFzdGVyID0gW1wieWVhclwiLCBcIm1vbnRoXCIsIFwiZGF5XCJdO1xuICAgIGxsZW4gPSB0b2tlbnMubGVuZ3RoIC0gMTtcbiAgICBmb3IgKHBwb3MgPSBsbGVuOyBwcG9zID4gLTE7IHBwb3MgKz0gLTEpIHtcbiAgICAgICAgdG9rZW4gPSB0b2tlbnNbcHBvc107XG4gICAgICAgIGlmIChcImRhdGVcIiA9PT0gdG9rZW4ubmFtZSAmJiBDU0wuRU5EID09PSB0b2tlbi50b2tlbnR5cGUpIHtcbiAgICAgICAgICAgIGRhdGVwYXJ0cyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcImRhdGUtcGFydFwiID09PSB0b2tlbi5uYW1lICYmIHRva2VuLnN0cmluZ3MubmFtZSkge1xuICAgICAgICAgICAgbGxsZW4gPSBkYXRlcGFydHNfbWFzdGVyLmxlbmd0aDtcbiAgICAgICAgICAgIGZvciAocHBwb3MgPSAwOyBwcHBvcyA8IGxsbGVuOyBwcHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgcGFydCA9IGRhdGVwYXJ0c19tYXN0ZXJbcHBwb3NdO1xuICAgICAgICAgICAgICAgIGlmIChwYXJ0ID09PSB0b2tlbi5zdHJpbmdzLm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0ZXBhcnRzLnB1c2godG9rZW4uc3RyaW5ncy5uYW1lKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwiZGF0ZVwiID09PSB0b2tlbi5uYW1lICYmIENTTC5TVEFSVCA9PT0gdG9rZW4udG9rZW50eXBlKSB7XG4gICAgICAgICAgICBkYXRlcGFydHMucmV2ZXJzZSgpO1xuICAgICAgICAgICAgdG9rZW4uZGF0ZXBhcnRzID0gZGF0ZXBhcnRzO1xuICAgICAgICB9XG4gICAgICAgIHRva2VuLm5leHQgPSAocHBvcyArIDEpO1xuICAgICAgICBpZiAodG9rZW4ubmFtZSAmJiBDU0wuTm9kZVt0b2tlbi5uYW1lXS5jb25maWd1cmUpIHtcbiAgICAgICAgICAgIENTTC5Ob2RlW3Rva2VuLm5hbWVdLmNvbmZpZ3VyZS5jYWxsKHRva2VuLCB0aGlzLCBwcG9zKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbkNTTC5FbmdpbmUucHJvdG90eXBlLnJldHJpZXZlSXRlbXMgPSBmdW5jdGlvbiAoaWRzKSB7XG4gICAgdmFyIHJldCwgcG9zLCBsZW47XG4gICAgcmV0ID0gW107XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBpZHMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHJldC5wdXNoKHRoaXMucmV0cmlldmVJdGVtKFwiXCIgKyBpZHNbaV0pKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuSVRFUkFUSU9OID0gMDtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnJldHJpZXZlSXRlbSA9IGZ1bmN0aW9uIChpZCkge1xuICAgIHZhciBJdGVtLCBtLCBwb3MsIGxlbiwgbW0sIGk7XG4gICAgaWYgKCF0aGlzLnRtcC5sb2FkZWRJdGVtSURzW2lkXSkge1xuICAgICAgICB0aGlzLnRtcC5sb2FkZWRJdGVtSURzW2lkXSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVnaXN0cnkucmVmaGFzaFtpZF07XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLm5vcm1hbGl6ZV9sYW5nX2tleXNfdG9fbG93ZXJjYXNlICYmXG4gICAgICAgIFwiYm9vbGVhblwiID09PSB0eXBlb2YgdGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ub3JtYWxpemVfbGFuZ19rZXlzX3RvX2xvd2VyY2FzZSkge1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdLmxlbmd0aDsgaTxpbGVuOyBpKz0xKSB7XG4gICAgICAgICAgICB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdW2ldID0gdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVtpXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMub3B0W1wibG9jYWxlLXRyYW5zbGl0XCJdLmxlbmd0aDsgaTxpbGVuOyBpKz0xKSB7XG4gICAgICAgICAgICB0aGlzLm9wdFtcImxvY2FsZS10cmFuc2xpdFwiXVtpXSA9IHRoaXMub3B0W1wibG9jYWxlLXRyYW5zbGl0XCJdW2ldLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy5vcHRbXCJsb2NhbGUtdHJhbnNsYXRcIl0ubGVuZ3RoOyBpPGlsZW47IGkrPTEpIHtcbiAgICAgICAgICAgIHRoaXMub3B0W1wibG9jYWxlLXRyYW5zbGF0XCJdW2ldID0gdGhpcy5vcHRbXCJsb2NhbGUtdHJhbnNsYXRcIl1baV0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLm5vcm1hbGl6ZV9sYW5nX2tleXNfdG9fbG93ZXJjYXNlID0gMTAwO1xuICAgIH1cbiAgICBDU0wuSVRFUkFUSU9OICs9IDE7XG4gICAgSXRlbSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5zeXMucmV0cmlldmVJdGVtKFwiXCIgKyBpZCkpKTtcbiAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ub3JtYWxpemVfbGFuZ19rZXlzX3RvX2xvd2VyY2FzZSkge1xuICAgICAgICBpZiAoSXRlbS5tdWx0aSkge1xuICAgICAgICAgICAgaWYgKEl0ZW0ubXVsdGkuX2tleXMpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBmaWVsZCBpbiBJdGVtLm11bHRpLl9rZXlzKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBJdGVtLm11bHRpLl9rZXlzW2ZpZWxkXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSAhPT0ga2V5LnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJdGVtLm11bHRpLl9rZXlzW2ZpZWxkXVtrZXkudG9Mb3dlckNhc2UoKV0gPSBJdGVtLm11bHRpLl9rZXlzW2ZpZWxkXVtrZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBJdGVtLm11bHRpLl9rZXlzW2ZpZWxkXVtrZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKEl0ZW0ubXVsdGkubWFpbikge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGZpZWxkIGluIEl0ZW0ubXVsdGkubWFpbikge1xuICAgICAgICAgICAgICAgICAgICBJdGVtLm11bHRpLm1haW5bZmllbGRdID0gSXRlbS5tdWx0aS5tYWluW2ZpZWxkXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBpPTAsIGlsZW49Q1NMLkNSRUFUT1JTLmxlbmd0aDsgaT5pbGVuOyBpKz0xKSB7XG4gICAgICAgICAgICB2YXIgY3R5cGUgPSBDU0wuQ1JFQVRPUlNbaV07XG4gICAgICAgICAgICBpZiAoSXRlbVtjdHlwZV0gJiYgSXRlbVtjdHlwZV0ubXVsdGkpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqPTAsIGpsZW49SXRlbVtjdHlwZV0ubGVuZ3RoOyBqPGpsZW47IGorPTEpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNyZWF0b3IgPSBJdGVtW2N0eXBlXVtqXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNyZWF0b3IubXVsdGkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjcmVhdG9yLm11bHRpLl9rZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY3JlYXRvci5tdWx0aS5fa2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgIT09IGtleS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdG9yLm11bHRpLl9rZXlba2V5LnRvTG93ZXJDYXNlKCldID0gY3JlYXRvci5tdWx0aS5fa2V5W2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY3JlYXRvci5tdWx0aS5fa2V5W2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3JlYXRvci5tdWx0aS5tYWluKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRvci5tdWx0aS5tYWluID0gY3JlYXRvci5tdWx0aS5tYWluLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKEl0ZW0ubGFuZ3VhZ2UpIHtcbiAgICAgICAgdmFyIGxzdCA9IEl0ZW0ubGFuZ3VhZ2Uuc3BsaXQoXCI8XCIpO1xuICAgICAgICBpZiAobHN0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIEl0ZW1bXCJsYW5ndWFnZS1uYW1lXCJdID0gbHN0WzBdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsc3QubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICBJdGVtW1wibGFuZ3VhZ2UtbmFtZS1vcmlnaW5hbFwiXSA9IGxzdFsxXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoSXRlbS5wYWdlKSB7XG4gICAgICAgIEl0ZW1bXCJwYWdlLWZpcnN0XCJdID0gSXRlbS5wYWdlO1xuICAgICAgICB2YXIgbnVtID0gXCJcIiArIEl0ZW0ucGFnZTtcbiAgICAgICAgdmFyIG0gPSBudW0uc3BsaXQoL1xccyooPzomfCwgfC18XFx1MjAxMylcXHMqLyk7XG4gICAgICAgIGlmIChtWzBdLnNsaWNlKC0xKSAhPT0gXCJcXFxcXCIpIHtcbiAgICAgICAgICAgIEl0ZW1bXCJwYWdlLWZpcnN0XCJdID0gbVswXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5maWVsZF9oYWNrICYmIEl0ZW0ubm90ZSkge1xuICAgICAgICBDU0wucGFyc2VOb3RlRmllbGRIYWNrcyhJdGVtLCBmYWxzZSwgdGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5hbGxvd19maWVsZF9oYWNrX2RhdGVfb3ZlcnJpZGUpO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMSwgaWxlbiA9IENTTC5EQVRFX1ZBUklBQkxFUy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIGRhdGVvYmogPSBJdGVtW0NTTC5EQVRFX1ZBUklBQkxFU1tpXV07XG4gICAgICAgIGlmIChkYXRlb2JqKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5yYXdfZGF0ZV9wYXJzaW5nKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGVvYmoucmF3KSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGVvYmogPSB0aGlzLmZ1bi5kYXRlcGFyc2VyLnBhcnNlRGF0ZVRvT2JqZWN0KGRhdGVvYmoucmF3KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBJdGVtW0NTTC5EQVRFX1ZBUklBQkxFU1tpXV0gPSB0aGlzLmRhdGVQYXJzZUFycmF5KGRhdGVvYmopO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnN0YXRpY19zdGF0dXRlX2xvY2F0b3IpIHtcbiAgICAgICAgaWYgKEl0ZW0udHlwZSAmJiBbXCJiaWxsXCIsXCJnYXpldHRlXCIsXCJsZWdpc2xhdGlvblwiLFwicmVndWxhdGlvblwiLFwidHJlYXR5XCJdLmluZGV4T2YoSXRlbS50eXBlKSA+IC0xKSB7XG4gICAgICAgICAgICB2YXIgdmFybmFtZTtcbiAgICAgICAgICAgIHZhciBlbGVtZW50cyA9IFtcInR5cGVcIiwgXCJ0aXRsZVwiLCBcImp1cmlzZGljdGlvblwiLCBcImdlbnJlXCIsIFwidm9sdW1lXCIsIFwiY29udGFpbmVyLXRpdGxlXCJdO1xuICAgICAgICAgICAgdmFyIGxlZ2lzbGF0aW9uX2lkID0gW107XG4gICAgICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gZWxlbWVudHMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgdmFybmFtZSA9IGVsZW1lbnRzW2ldO1xuXHRcdFx0XHRpZiAoSXRlbVt2YXJuYW1lXSkge1xuXHRcdFx0XHRcdGxlZ2lzbGF0aW9uX2lkLnB1c2goSXRlbVt2YXJuYW1lXSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cbiAgICAgICAgICAgIGVsZW1lbnRzID0gW1wib3JpZ2luYWwtZGF0ZVwiLCBcImlzc3VlZFwiXTtcblx0XHRcdGZvciAoaSA9IDAsIGVsZW1lbnRzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIHZhcm5hbWUgPSBlbGVtZW50c1tpXTtcblx0XHRcdFx0aWYgKEl0ZW1bdmFybmFtZV0gJiYgSXRlbVt2YXJuYW1lXS55ZWFyKSB7XG5cdFx0XHRcdFx0dmFyIHZhbHVlID0gSXRlbVt2YXJuYW1lXS55ZWFyO1xuXHRcdFx0XHRcdGxlZ2lzbGF0aW9uX2lkLnB1c2godmFsdWUpO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRJdGVtLmxlZ2lzbGF0aW9uX2lkID0gbGVnaXNsYXRpb25faWQuam9pbihcIjo6XCIpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmZvcmNlX2p1cmlzZGljdGlvbikge1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIEl0ZW0uYXV0aG9yaXR5KSB7XG4gICAgICAgICAgICBJdGVtLmF1dGhvcml0eSA9IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGxpdGVyYWw6IEl0ZW0uYXV0aG9yaXR5XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghSXRlbVtcInRpdGxlLXNob3J0XCJdKSB7XG4gICAgICAgIEl0ZW1bXCJ0aXRsZS1zaG9ydFwiXSA9IEl0ZW0uc2hvcnRUaXRsZTtcbiAgICB9XG4gICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMubWFpbl90aXRsZV9mcm9tX3Nob3J0X3RpdGxlKSB7XG4gICAgICAgIENTTC5leHRyYWN0VGl0bGVBbmRTdWJ0aXRsZShJdGVtKTtcbiAgICB9XG4gICAgdmFyIGlzTGVnYWxUeXBlID0gW1wiYmlsbFwiLFwibGVnYWxfY2FzZVwiLFwibGVnaXNsYXRpb25cIixcImdhemV0dGVcIixcInJlZ3VsYXRpb25cIl0uaW5kZXhPZihJdGVtLnR5cGUpID4gLTE7XG4gICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZm9yY2VfanVyaXNkaWN0aW9uICYmIGlzTGVnYWxUeXBlKSB7XG4gICAgICAgIGlmICghSXRlbS5qdXJpc2RpY3Rpb24pIHtcbiAgICAgICAgICAgIEl0ZW0uanVyaXNkaWN0aW9uID0gXCJ1c1wiO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghaXNMZWdhbFR5cGUgJiYgSXRlbS50aXRsZSAmJiB0aGlzLnN5cy5nZXRBYmJyZXZpYXRpb24pIHtcbiAgICAgICAgdmFyIG5vSGludHMgPSBmYWxzZTtcbiAgICAgICAgaWYgKCFJdGVtLmp1cmlzZGljdGlvbikge1xuICAgICAgICAgICAgbm9IaW50cyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkpIHtcbiAgICAgICAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gdGhpcy5zeXMubm9ybWFsaXplQWJicmV2c0tleShJdGVtLnRpdGxlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gSXRlbS50aXRsZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIganVyaXNkaWN0aW9uID0gdGhpcy50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihJdGVtLmp1cmlzZGljdGlvbiwgXCJ0aXRsZVwiLCBub3JtYWxpemVkS2V5LCBJdGVtLnR5cGUpO1xuICAgICAgICBpZiAodGhpcy50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dW1widGl0bGVcIl0pIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bXCJ0aXRsZVwiXVtub3JtYWxpemVkS2V5XSkge1xuICAgICAgICAgICAgICAgIEl0ZW1bXCJ0aXRsZS1zaG9ydFwiXSA9IHRoaXMudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXVtcInRpdGxlXCJdW25vcm1hbGl6ZWRLZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghSXRlbVtcImNvbnRhaW5lci10aXRsZS1zaG9ydFwiXSkge1xuICAgICAgICBJdGVtW1wiY29udGFpbmVyLXRpdGxlLXNob3J0XCJdID0gSXRlbS5qb3VybmFsQWJicmV2aWF0aW9uO1xuICAgIH1cbiAgICBpZiAoSXRlbVtcImNvbnRhaW5lci10aXRsZVwiXSAmJiB0aGlzLnN5cy5nZXRBYmJyZXZpYXRpb24pIHtcbiAgICAgICAgaWYgKHRoaXMuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkpIHtcbiAgICAgICAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gdGhpcy5zeXMubm9ybWFsaXplQWJicmV2c0tleShJdGVtW1wiY29udGFpbmVyLXRpdGxlXCJdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gSXRlbVtcImNvbnRhaW5lci10aXRsZVwiXTtcbiAgICAgICAgfVxuICAgICAgICB2YXIganVyaXNkaWN0aW9uID0gdGhpcy50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihJdGVtLmp1cmlzZGljdGlvbiwgXCJjb250YWluZXItdGl0bGVcIiwgbm9ybWFsaXplZEtleSk7XG4gICAgICAgIGlmICh0aGlzLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bXCJjb250YWluZXItdGl0bGVcIl0pIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bXCJjb250YWluZXItdGl0bGVcIl1bbm9ybWFsaXplZEtleV0pIHtcbiAgICAgICAgICAgICAgICBJdGVtW1wiY29udGFpbmVyLXRpdGxlLXNob3J0XCJdID0gdGhpcy50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dW1wiY29udGFpbmVyLXRpdGxlXCJdW25vcm1hbGl6ZWRLZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChJdGVtW1wianVyaXNkaWN0aW9uXCJdKSB7XG4gICAgICAgIEl0ZW1bXCJjb3VudHJ5XCJdID0gSXRlbVtcImp1cmlzZGljdGlvblwiXS5zcGxpdChcIjpcIilbMF07XG4gICAgfVxuICAgIHRoaXMucmVnaXN0cnkucmVmaGFzaFtpZF0gPSBJdGVtO1xuICAgIHJldHVybiBJdGVtO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldE9wdCA9IGZ1bmN0aW9uICh0b2tlbiwgbmFtZSwgdmFsdWUpIHtcbiAgICBpZiAodG9rZW4ubmFtZSA9PT0gXCJzdHlsZVwiIHx8IHRva2VuLm5hbWUgPT09IFwiY3Nsc3R5bGVcIikge1xuICAgICAgICB0aGlzLm9wdC5pbmhlcml0ZWRBdHRyaWJ1dGVzW25hbWVdID0gdmFsdWU7XG4gICAgICAgIHRoaXMuY2l0YXRpb24ub3B0LmluaGVyaXRlZEF0dHJpYnV0ZXNbbmFtZV0gPSB2YWx1ZTtcbiAgICAgICAgdGhpcy5iaWJsaW9ncmFwaHkub3B0LmluaGVyaXRlZEF0dHJpYnV0ZXNbbmFtZV0gPSB2YWx1ZTtcbiAgICB9IGVsc2UgaWYgKFtcImNpdGF0aW9uXCIsIFwiYmlibGlvZ3JhcGh5XCJdLmluZGV4T2YodG9rZW4ubmFtZSkgPiAtMSkge1xuICAgICAgICB0aGlzW3Rva2VuLm5hbWVdLm9wdC5pbmhlcml0ZWRBdHRyaWJ1dGVzW25hbWVdID0gdmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdG9rZW4uc3RyaW5nc1tuYW1lXSA9IHZhbHVlO1xuICAgIH1cbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5pbmhlcml0T3B0ID0gZnVuY3Rpb24gKHRva2VuLCBhdHRybmFtZSwgcGFyZW50bmFtZSwgZGVmYXVsdFZhbHVlKSB7XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB0b2tlbi5zdHJpbmdzW2F0dHJuYW1lXSkge1xuICAgICAgICByZXR1cm4gdG9rZW4uc3RyaW5nc1thdHRybmFtZV07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIHBhcmVudFZhbHVlID0gdGhpc1t0aGlzLnRtcC5yb290XS5vcHQuaW5oZXJpdGVkQXR0cmlidXRlc1twYXJlbnRuYW1lID8gcGFyZW50bmFtZSA6IGF0dHJuYW1lXTtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiBwYXJlbnRWYWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuIHBhcmVudFZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnJlbWFwU2VjdGlvblZhcmlhYmxlID0gZnVuY3Rpb24gKGlucHV0TGlzdCkge1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gaW5wdXRMaXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgSXRlbSA9IGlucHV0TGlzdFtpXVswXTtcbiAgICAgICAgdmFyIGl0ZW0gPSBpbnB1dExpc3RbaV1bMV07XG4gICAgICAgIGlmIChbXCJiaWxsXCIsXCJnYXpldHRlXCIsXCJsZWdpc2xhdGlvblwiLFwicmVndWxhdGlvblwiLFwidHJlYXR5XCJdLmluZGV4T2YoSXRlbS50eXBlKSA+IC0xKSB7XG4gICAgICAgICAgICBpZiAoaXRlbS5sb2NhdG9yKSB7XG4gICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gaXRlbS5sb2NhdG9yLnRyaW0oKTtcbiAgICAgICAgICAgICAgICB2YXIgbSA9IGl0ZW0ubG9jYXRvci5tYXRjaChDU0wuU1RBVFVURV9TVUJESVZfUExBSU5fUkVHRVhfRlJPTlQpO1xuICAgICAgICAgICAgICAgIGlmICghbSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5sYWJlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1NfUkVWRVJTRVtpdGVtLmxhYmVsXSArIFwiIFwiICsgaXRlbS5sb2NhdG9yO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gXCJwLiBcIiArIGl0ZW0ubG9jYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzZWN0aW9uTWFzdGVyTGFiZWwgPSBudWxsO1xuICAgICAgICAgICAgaWYgKEl0ZW0uc2VjdGlvbikge1xuICAgICAgICAgICAgICAgIEl0ZW0uc2VjdGlvbiA9IEl0ZW0uc2VjdGlvbi50cmltKCk7XG4gICAgICAgICAgICAgICAgdmFyIG0gPSBJdGVtLnNlY3Rpb24ubWF0Y2goQ1NMLlNUQVRVVEVfU1VCRElWX1BMQUlOX1JFR0VYX0ZST05UKTtcbiAgICAgICAgICAgICAgICBpZiAoIW0pIHtcbiAgICAgICAgICAgICAgICAgICAgSXRlbS5zZWN0aW9uID0gXCJzZWMuIFwiICsgSXRlbS5zZWN0aW9uO1xuICAgICAgICAgICAgICAgICAgICBzZWN0aW9uTWFzdGVyTGFiZWwgPSBcInNlYy5cIjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzZWN0aW9uTWFzdGVyTGFiZWwgPSBtWzBdLnRyaW0oKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoSXRlbS5zZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpdGVtLmxvY2F0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gSXRlbS5zZWN0aW9uO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtID0gaXRlbS5sb2NhdG9yLm1hdGNoKC9eKFteIF0qKVxccyooLiopLyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzcGFjZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1bMV0gPT09IFwicC5cIiAmJiBzZWN0aW9uTWFzdGVyTGFiZWwgIT09IFwicC5cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ubG9jYXRvciA9IG1bMl07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoW1wiW1wiLCBcIihcIiwgXCIuXCIsIFwiLFwiLCBcIjtcIiwgXCI6XCIsIFwiP1wiXS5pbmRleE9mKGl0ZW0ubG9jYXRvci5zbGljZSgwLCAxKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYWNlID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgc3BhY2UgPSBcIlwiOyBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpdGVtLmxvY2F0b3IgPSBJdGVtLnNlY3Rpb24gKyBzcGFjZSArIGl0ZW0ubG9jYXRvcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpdGVtLmxhYmVsID0gXCJcIjtcbiAgICAgICAgfVxuICAgIH1cbn1cbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldE51bWJlckxhYmVscyA9IGZ1bmN0aW9uIChJdGVtKSB7XG4gICAgIGlmIChJdGVtLm51bWJlclxuICAgICAgICAmJiBbXCJiaWxsXCIsIFwiZ2F6ZXR0ZVwiLCBcImxlZ2lzbGF0aW9uXCIsXCJyZWd1bGF0aW9uXCIsXCJ0cmVhdHlcIl0uaW5kZXhPZihJdGVtLnR5cGUpID4gLTFcbiAgICAgICAgJiYgdGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5zdGF0aWNfc3RhdHV0ZV9sb2NhdG9yXG4gICAgICAgICYmICF0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1tcIm51bWJlclwiXSkge1xuICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1tcIm51bWJlclwiXSA9IHt9O1xuICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1tcIm51bWJlclwiXS52YWx1ZXMgPSBbXTtcbiAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0ucGx1cmFsID0gMDtcbiAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0ubnVtZXJpYyA9IGZhbHNlO1xuICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1tcIm51bWJlclwiXS5sYWJlbCA9IGZhbHNlO1xuICAgICAgICB2YXIgdmFsdWUgPSBcIlwiICsgSXRlbS5udW1iZXI7XG4gICAgICAgIHZhbHVlID0gdmFsdWUuc3BsaXQoXCJcXFxcXCIpLmpvaW4oXCJcIik7XG4gICAgICAgIHZhciBmaXJzdHdvcmQgPSB2YWx1ZS5zcGxpdCgvXFxzKy8pWzBdO1xuICAgICAgICB2YXIgZmlyc3RsYWJlbCA9IENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTW2ZpcnN0d29yZF07XG4gICAgICAgIGlmIChmaXJzdGxhYmVsKSB7XG4gICAgICAgICAgICB2YXIgbSA9IHZhbHVlLm1hdGNoKENTTC5TVEFUVVRFX1NVQkRJVl9HUk9VUEVEX1JFR0VYKTtcbiAgICAgICAgICAgIHZhciBzcGx0ID0gdmFsdWUuc3BsaXQoQ1NMLlNUQVRVVEVfU1VCRElWX1BMQUlOX1JFR0VYKTtcbiAgICAgICAgICAgIGlmIChzcGx0Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICB2YXIgbHN0ID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaj0xLCBqbGVuPXNwbHQubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdWJkaXYgPSBtW2ogLSAxXS5yZXBsYWNlKC9eXFxzKi8sIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICBsc3QucHVzaChzcGx0W2pdLnJlcGxhY2UoL1xccyokLywgXCJcIikucmVwbGFjZSgvXlxccyovLCBcIlwiKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhbHVlID0gbHN0LmpvaW4oXCIgXCIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHNwbHRbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1tcIm51bWJlclwiXS5sYWJlbCA9IGZpcnN0bGFiZWw7XG4gICAgICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1tcIm51bWJlclwiXS52YWx1ZXMucHVzaChbXCJCbG9iXCIsIHZhbHVlLCBmYWxzZV0pO1xuICAgICAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0ubnVtZXJpYyA9IGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0udmFsdWVzLnB1c2goW1wiQmxvYlwiLCB2YWx1ZSwgZmFsc2VdKTtcbiAgICAgICAgICAgIHRoaXMudG1wLnNoYWRvd19udW1iZXJzW1wibnVtYmVyXCJdLm51bWVyaWMgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuc3Vic3RpdHV0ZU9uZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSkge1xuICAgIHJldHVybiBmdW5jdGlvbiAoc3RhdGUsIGxpc3QpIHtcbiAgICAgICAgaWYgKCFsaXN0KSB7XG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZS5yZXBsYWNlKFwiJSVTVFJJTkclJVwiLCBsaXN0KTtcbiAgICAgICAgfVxuICAgIH07XG59O1xuQ1NMLnN1YnN0aXR1dGVUd28gPSBmdW5jdGlvbiAodGVtcGxhdGUpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKHBhcmFtKSB7XG4gICAgICAgIHZhciB0ZW1wbGF0ZTIgPSB0ZW1wbGF0ZS5yZXBsYWNlKFwiJSVQQVJBTSUlXCIsIHBhcmFtKTtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzdGF0ZSwgbGlzdCkge1xuICAgICAgICAgICAgaWYgKCFsaXN0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTIucmVwbGFjZShcIiUlU1RSSU5HJSVcIiwgbGlzdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfTtcbn07XG5DU0wuTW9kZSA9IGZ1bmN0aW9uIChtb2RlKSB7XG4gICAgdmFyIGRlY29yYXRpb25zLCBwYXJhbXMsIHBhcmFtLCBmdW5jLCB2YWwsIGFyZ3M7XG4gICAgZGVjb3JhdGlvbnMgPSB7fTtcbiAgICBwYXJhbXMgPSBDU0wuT3V0cHV0LkZvcm1hdHNbbW9kZV07XG4gICAgZm9yIChwYXJhbSBpbiBwYXJhbXMpIHtcbiAgICAgICAgaWYgKHRydWUpIHtcbiAgICAgICAgICAgIGlmIChcIkBcIiAhPT0gcGFyYW0uc2xpY2UoMCwgMSkpIHtcbiAgICAgICAgICAgICAgICBkZWNvcmF0aW9uc1twYXJhbV0gPSBwYXJhbXNbcGFyYW1dO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuYyA9IGZhbHNlO1xuICAgICAgICAgICAgdmFsID0gcGFyYW1zW3BhcmFtXTtcbiAgICAgICAgICAgIGFyZ3MgPSBwYXJhbS5zcGxpdCgnLycpO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09IFwic3RyaW5nXCIgJiYgdmFsLmluZGV4T2YoXCIlJVNUUklORyUlXCIpID4gLTEpICB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbC5pbmRleE9mKFwiJSVQQVJBTSUlXCIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IENTTC5zdWJzdGl0dXRlVHdvKHZhbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IENTTC5zdWJzdGl0dXRlT25lKHZhbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSBcImJvb2xlYW5cIiAmJiAhdmFsKSB7XG4gICAgICAgICAgICAgICAgZnVuYyA9IENTTC5PdXRwdXQuRm9ybWF0dGVycy5wYXNzdGhyb3VnaDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgZnVuYyA9IHZhbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgXCJDU0wuQ29tcGlsZXI6IEJhZCBcIiArIG1vZGUgKyBcIiBjb25maWcgZW50cnkgZm9yIFwiICsgcGFyYW0gKyBcIjogXCIgKyB2YWw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICBkZWNvcmF0aW9uc1thcmdzWzBdXSA9IGZ1bmM7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGFyZ3MubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFkZWNvcmF0aW9uc1thcmdzWzBdXSkge1xuICAgICAgICAgICAgICAgICAgICBkZWNvcmF0aW9uc1thcmdzWzBdXSA9IHt9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkZWNvcmF0aW9uc1thcmdzWzBdXVthcmdzWzFdXSA9IGZ1bmM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRlY29yYXRpb25zO1xufTtcbkNTTC5zZXREZWNvcmF0aW9ucyA9IGZ1bmN0aW9uIChzdGF0ZSwgYXR0cmlidXRlcykge1xuICAgIHZhciByZXQsIGtleSwgcG9zO1xuICAgIHJldCA9IFtdO1xuICAgIGZvciAocG9zIGluIENTTC5GT1JNQVRfS0VZX1NFUVVFTkNFKSB7XG4gICAgICAgIGlmICh0cnVlKSB7XG4gICAgICAgICAgICB2YXIga2V5ID0gQ1NMLkZPUk1BVF9LRVlfU0VRVUVOQ0VbcG9zXTtcbiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzW2tleV0pIHtcbiAgICAgICAgICAgICAgICByZXQucHVzaChba2V5LCBhdHRyaWJ1dGVzW2tleV1dKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgYXR0cmlidXRlc1trZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLkRvcHBlbGVyID0gZnVuY3Rpb24ocmV4U3RyLCBzdHJpbmdNYW5nbGVyKSB7XG4gICAgdmFyIG14LCBsc3QsIGxlbiwgcG9zLCBtLCBidWYxLCBidWYyLCBpZHgsIHJldCwgbXlyZXQ7XG4gICAgdGhpcy5zcGxpdCA9IHNwbGl0O1xuICAgIHRoaXMuam9pbiA9IGpvaW47XG4gICAgdmFyIG1hdGNoUmV4ID0gbmV3IFJlZ0V4cChcIihcIiArIHJleFN0ciArIFwiKVwiLCBcImdcIik7XG4gICAgdmFyIHNwbGl0UmV4ID0gbmV3IFJlZ0V4cChyZXhTdHIsIFwiZ1wiKTtcbiAgICBmdW5jdGlvbiBzcGxpdChzdHIpIHtcbiAgICAgICAgaWYgKHN0cmluZ01hbmdsZXIpIHtcbiAgICAgICAgICAgIHN0ciA9IHN0cmluZ01hbmdsZXIoc3RyKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbWF0Y2ggPSBzdHIubWF0Y2gobWF0Y2hSZXgpO1xuICAgICAgICBpZiAoIW1hdGNoKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHRhZ3M6IFtdLFxuICAgICAgICAgICAgICAgIHN0cmluZ3M6IFtzdHJdXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHZhciBzcGxpdCA9IHN0ci5zcGxpdChzcGxpdFJleCk7XG4gICAgICAgIGZvciAodmFyIGk9bWF0Y2gubGVuZ3RoLTE7IGk+IC0xOyBpLS0pIHtcbiAgICAgICAgICAgIHZhciB0YWcgPSBtYXRjaFtpXTtcbiAgICAgICAgICAgIGlmICh0YWcgPT09IFwiXFwnXCIgJiYgc3BsaXRbaSsxXS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgc3BsaXRbaSsxXSA9IG1hdGNoW2ldICsgc3BsaXRbaSsxXTtcbiAgICAgICAgICAgICAgICBtYXRjaFtpXSA9IFwiXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRhZ3M6IG1hdGNoLFxuICAgICAgICAgICAgc3RyaW5nczogc3BsaXQsXG4gICAgICAgICAgICBvcmlnU3RyaW5nczogc3BsaXQuc2xpY2UoKVxuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIGpvaW4ob2JqKSB7XG4gICAgICAgIHZhciBsc3QgPSBvYmouc3RyaW5ncy5zbGljZSgtMSk7XG4gICAgICAgIGZvciAodmFyIGk9b2JqLnRhZ3MubGVuZ3RoLTE7IGk+LTE7IGktLSkge1xuICAgICAgICAgICAgbHN0LnB1c2gob2JqLnRhZ3NbaV0pO1xuICAgICAgICAgICAgbHN0LnB1c2gob2JqLnN0cmluZ3NbaV0pO1xuICAgICAgICB9XG4gICAgICAgIGxzdC5yZXZlcnNlKCk7XG4gICAgICAgIHJldHVybiBsc3Quam9pbihcIlwiKTtcbiAgICB9XG59XG5DU0wuRW5naW5lLnByb3RvdHlwZS5ub3JtYWxEZWNvcklzT3JwaGFuID0gZnVuY3Rpb24gKGJsb2IsIHBhcmFtcykge1xuICAgIGlmIChwYXJhbXNbMV0gPT09IFwibm9ybWFsXCIpIHtcbiAgICAgICAgdmFyIHVzZV9wYXJhbSA9IGZhbHNlO1xuICAgICAgICB2YXIgYWxsX3RoZV9kZWNvcjtcbiAgICAgICAgaWYgKHRoaXMudG1wLmFyZWEgPT09IFwiY2l0YXRpb25cIikge1xuICAgICAgICAgICAgYWxsX3RoZV9kZWNvciA9IFt0aGlzLmNpdGF0aW9uLm9wdC5sYXlvdXRfZGVjb3JhdGlvbnNdLmNvbmNhdChibG9iLmFsbGRlY29yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFsbF90aGVfZGVjb3IgPSBibG9iLmFsbGRlY29yO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGsgPSBhbGxfdGhlX2RlY29yLmxlbmd0aCAtIDE7IGsgPiAtMTsgayArPSAtMSkge1xuICAgICAgICAgICAgZm9yICh2YXIgbiA9IGFsbF90aGVfZGVjb3Jba10ubGVuZ3RoIC0gMTsgbiA+IC0xOyBuICs9IC0xKSB7XG4gICAgICAgICAgICAgICAgaWYgKGFsbF90aGVfZGVjb3Jba11bbl1bMF0gPT09IHBhcmFtc1swXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYWxsX3RoZV9kZWNvcltrXVtuXVsxXSAhPT0gXCJub3JtYWxcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXNlX3BhcmFtID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIXVzZV9wYXJhbSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuZ2V0Q2l0YXRpb25MYWJlbCA9IGZ1bmN0aW9uIChJdGVtKSB7XG4gICAgdmFyIGxhYmVsID0gXCJcIjtcbiAgICB2YXIgcGFyYW1zID0gdGhpcy5nZXRUcmlncmFwaFBhcmFtcygpO1xuICAgIHZhciBjb25maWcgPSBwYXJhbXNbMF07XG4gICAgdmFyIG15bmFtZSA9IHRoaXMuZ2V0VGVybShcInJlZmVyZW5jZVwiLCBcInNob3J0XCIsIDApO1xuICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgbXluYW1lKSB7XG4gICAgICAgIG15bmFtZSA9IFwicmVmZXJlbmNlXCI7XG4gICAgfVxuICAgIG15bmFtZSA9IG15bmFtZS5yZXBsYWNlKFwiLlwiLCBcIlwiKTtcbiAgICBteW5hbWUgPSBteW5hbWUuc2xpY2UoMCwgMSkudG9VcHBlckNhc2UoKSArIG15bmFtZS5zbGljZSgxKTtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IENTTC5DUkVBVE9SUy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIG4gPSBDU0wuQ1JFQVRPUlNbaV07XG4gICAgICAgIGlmIChJdGVtW25dKSB7XG4gICAgICAgICAgICB2YXIgbmFtZXMgPSBJdGVtW25dO1xuICAgICAgICAgICAgaWYgKG5hbWVzLmxlbmd0aCA+IHBhcmFtcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBjb25maWcgPSBwYXJhbXNbcGFyYW1zLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25maWcgPSBwYXJhbXNbbmFtZXMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IG5hbWVzLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgIGlmIChqID09PSBjb25maWcuYXV0aG9ycy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciByZXMgPSB0aGlzLm5hbWVPdXRwdXQuZ2V0TmFtZShuYW1lc1tqXSwgXCJsb2NhbGUtdHJhbnNsaXRcIiwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgdmFyIG5hbWUgPSByZXMubmFtZTtcbiAgICAgICAgICAgICAgICBpZiAobmFtZSAmJiBuYW1lLmZhbWlseSkge1xuICAgICAgICAgICAgICAgICAgICBteW5hbWUgPSBuYW1lLmZhbWlseTtcbiAgICAgICAgICAgICAgICAgICAgbXluYW1lID0gbXluYW1lLnJlcGxhY2UoL14oWyBcXCdcXHUyMDE5YS16XStcXHMrKS8sIFwiXCIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZSAmJiBuYW1lLmxpdGVyYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgbXluYW1lID0gbmFtZS5saXRlcmFsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgbSA9IG15bmFtZS50b0xvd2VyQ2FzZSgpLm1hdGNoKC9eKGFcXHMrfHRoZVxccyt8YW5cXHMrKS8pO1xuICAgICAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgICAgIG15bmFtZSA9IG15bmFtZS5zbGljZShtWzFdLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG15bmFtZSA9IG15bmFtZS5yZXBsYWNlKENTTC5ST01BTkVTUVVFX05PVF9SRUdFWFAsIFwiXCIpO1xuICAgICAgICAgICAgICAgIGlmICghbXluYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBteW5hbWUgPSBteW5hbWUuc2xpY2UoMCwgY29uZmlnLmF1dGhvcnNbal0pO1xuICAgICAgICAgICAgICAgIGlmIChteW5hbWUubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICBteW5hbWUgPSBteW5hbWUuc2xpY2UoMCwgMSkudG9VcHBlckNhc2UoKSArIG15bmFtZS5zbGljZSgxKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobXluYW1lLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICBteW5hbWUgPSBteW5hbWUudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGFiZWwgKz0gbXluYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFsYWJlbCkge1xuICAgICAgICBpZiAoSXRlbS50aXRsZSkge1xuICAgICAgICAgICAgdmFyIHNraXBXb3JkcyA9IHRoaXMubG9jYWxlW3RoaXMub3B0LmxhbmddLm9wdHNbXCJza2lwLXdvcmRzXCJdO1xuICAgICAgICAgICAgdmFyIGxzdCA9IEl0ZW0udGl0bGUuc3BsaXQoL1xccysvKTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBsc3QubGVuZ3RoIC0gMTsgaSA+IC0xOyBpLS0pIHtcbiAgICAgICAgICAgICAgICBpZiAoc2tpcFdvcmRzLmluZGV4T2YobHN0W2ldKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGxzdCA9IGxzdC5zbGljZSgwLCBpKS5jb25jYXQobHN0LnNsaWNlKGkgKyAxKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHN0ciA9IGxzdC5qb2luKCcnKTtcbiAgICAgICAgICAgIHN0ciA9IHN0ci5zbGljZSgwLCBwYXJhbXNbMF0uYXV0aG9yc1swXSk7XG4gICAgICAgICAgICBpZiAoc3RyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoMCwgMSkudG9VcHBlckNhc2UoKSArIHN0ci5zbGljZSgxKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChzdHIubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgc3RyID0gc3RyLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsYWJlbCA9IHN0cjtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgeWVhciA9IFwiMDAwMFwiO1xuICAgIGlmIChJdGVtLmlzc3VlZCkge1xuICAgICAgICBpZiAoSXRlbS5pc3N1ZWQueWVhcikge1xuICAgICAgICAgICAgeWVhciA9IFwiXCIgKyBJdGVtLmlzc3VlZC55ZWFyO1xuICAgICAgICB9XG4gICAgfVxuICAgIHllYXIgPSB5ZWFyLnNsaWNlKChjb25maWcueWVhciAqIC0xKSk7XG4gICAgbGFiZWwgPSBsYWJlbCArIHllYXI7XG4gICAgcmV0dXJuIGxhYmVsO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmdldFRyaWdyYXBoUGFyYW1zID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBwYXJhbXMgPSBbXTtcbiAgICB2YXIgaWxzdCA9IHRoaXMub3B0LnRyaWdyYXBoLnNwbGl0KFwiOlwiKTtcbiAgICBpZiAoIXRoaXMub3B0LnRyaWdyYXBoIHx8IHRoaXMub3B0LnRyaWdyYXBoLnNsaWNlKDAsMSkgIT09IFwiQVwiKSB7XG4gICAgICAgIHRocm93IFwiQmFkIHRyaWdyYXBoIGRlZmluaXRpb246IFwiK3RoaXMub3B0LnRyaWdyYXBoO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGlsc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciBzdHIgPSBpbHN0W2ldO1xuICAgICAgICB2YXIgY29uZmlnID0ge2F1dGhvcnM6W10sIHllYXI6MH07XG4gICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gc3RyLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgc3dpdGNoIChzdHIuc2xpY2UoaixqKzEpKSB7XG4gICAgICAgICAgICBjYXNlIFwiQVwiOlxuICAgICAgICAgICAgICAgIGNvbmZpZy5hdXRob3JzLnB1c2goMSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiYVwiOlxuICAgICAgICAgICAgICAgIGNvbmZpZy5hdXRob3JzW2NvbmZpZy5hdXRob3JzLmxlbmd0aCAtIDFdICs9IDE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiMFwiOlxuICAgICAgICAgICAgICAgIGNvbmZpZy55ZWFyICs9IDE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRocm93IFwiSW52YWxpZCBjaGFyYWN0ZXIgaW4gdHJpZ3JhcGggZGVmaW5pdGlvbjogXCIrdGhpcy5vcHQudHJpZ3JhcGg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcGFyYW1zLnB1c2goY29uZmlnKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcmFtcztcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldE91dHB1dEZvcm1hdCA9IGZ1bmN0aW9uIChtb2RlKSB7XG4gICAgdGhpcy5vcHQubW9kZSA9IG1vZGU7XG4gICAgdGhpcy5mdW4uZGVjb3JhdGUgPSBDU0wuTW9kZShtb2RlKTtcbiAgICBpZiAoIXRoaXMub3V0cHV0W21vZGVdKSB7XG4gICAgICAgIHRoaXMub3V0cHV0W21vZGVdID0ge307XG4gICAgICAgIHRoaXMub3V0cHV0W21vZGVdLnRtcCA9IHt9O1xuICAgIH1cbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5nZXRTb3J0RnVuYyA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKGEsYikge1xuICAgICAgICBhID0gYS5zcGxpdChcIi1cIik7XG4gICAgICAgIGIgPSBiLnNwbGl0KFwiLVwiKTtcbiAgICAgICAgaWYgKGEubGVuZ3RoIDwgYi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiAxXG4gICAgICAgIH0gZWxzZSBpZiAoYS5sZW5ndGggPiBiLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIC0xXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhID0gYS5zbGljZSgtMSlbMF07XG4gICAgICAgICAgICBiID0gYi5zbGljZSgtMSlbMF07XG4gICAgICAgICAgICBpZiAoYS5sZW5ndGggPCBiLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhLmxlbmd0aCA+IGIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuc2V0TGFuZ1RhZ3NGb3JDc2xTb3J0ID0gZnVuY3Rpb24gKHRhZ3MpIHtcbiAgICB2YXIgaSwgaWxlbjtcbiAgICBpZiAodGFncykge1xuICAgICAgICB0aGlzLm9wdFsnbG9jYWxlLXNvcnQnXSA9IFtdO1xuICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gdGFncy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHRoaXMub3B0Wydsb2NhbGUtc29ydCddLnB1c2godGFnc1tpXSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5vcHRbJ2xvY2FsZS1zb3J0J10uc29ydCh0aGlzLmdldFNvcnRGdW5jKCkpO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldExhbmdUYWdzRm9yQ3NsVHJhbnNsaXRlcmF0aW9uID0gZnVuY3Rpb24gKHRhZ3MpIHtcbiAgICB2YXIgaSwgaWxlbjtcbiAgICB0aGlzLm9wdFsnbG9jYWxlLXRyYW5zbGl0J10gPSBbXTtcbiAgICBpZiAodGFncykge1xuICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gdGFncy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHRoaXMub3B0Wydsb2NhbGUtdHJhbnNsaXQnXS5wdXNoKHRhZ3NbaV0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMub3B0Wydsb2NhbGUtdHJhbnNsaXQnXS5zb3J0KHRoaXMuZ2V0U29ydEZ1bmMoKSk7XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuc2V0TGFuZ1RhZ3NGb3JDc2xUcmFuc2xhdGlvbiA9IGZ1bmN0aW9uICh0YWdzKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgdGhpcy5vcHRbJ2xvY2FsZS10cmFuc2xhdCddID0gW107XG4gICAgaWYgKHRhZ3MpIHtcbiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHRhZ3MubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICB0aGlzLm9wdFsnbG9jYWxlLXRyYW5zbGF0J10ucHVzaCh0YWdzW2ldKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLm9wdFsnbG9jYWxlLXRyYW5zbGF0J10uc29ydCh0aGlzLmdldFNvcnRGdW5jKCkpO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldExhbmdQcmVmc0ZvckNpdGVzID0gZnVuY3Rpb24gKG9iaiwgY29udikge1xuICAgIHZhciBvcHQgPSB0aGlzLm9wdFsnY2l0ZS1sYW5nLXByZWZzJ107XG4gICAgaWYgKCFjb252KSB7XG4gICAgICAgIGNvbnYgPSBmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAgICAgICByZXR1cm4ga2V5LnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIH07XG4gICAgfVxuICAgIHZhciBzZWdtZW50cyA9IFsnUGVyc29ucycsICdJbnN0aXR1dGlvbnMnLCAnVGl0bGVzJywgJ0pvdXJuYWxzJywgJ1B1Ymxpc2hlcnMnLCAnUGxhY2VzJ107XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBzZWdtZW50cy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIGNsaWVudFNlZ21lbnQgPSBjb252KHNlZ21lbnRzW2ldKTtcbiAgICAgICAgdmFyIGNpdGVwcm9jU2VnbWVudCA9IHNlZ21lbnRzW2ldLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmICghb2JqW2NsaWVudFNlZ21lbnRdKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgc3VwcGxlbWVudHMgPSBbXTtcbiAgICAgICAgd2hpbGUgKG9ialtjbGllbnRTZWdtZW50XS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICBzdXBwbGVtZW50cy5wdXNoKG9ialtjbGllbnRTZWdtZW50XS5wb3AoKSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHNvcnR2YWwgPSB7b3JpZzoxLHRyYW5zbGl0OjIsdHJhbnNsYXQ6M307XG4gICAgICAgIGlmIChzdXBwbGVtZW50cy5sZW5ndGggPT09IDIgJiYgc29ydHZhbFtzdXBwbGVtZW50c1swXV0gPCBzb3J0dmFsW3N1cHBsZW1lbnRzWzFdXSkge1xuICAgICAgICAgICAgc3VwcGxlbWVudHMucmV2ZXJzZSgpO1xuICAgICAgICB9XG4gICAgICAgIHdoaWxlIChzdXBwbGVtZW50cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIG9ialtjbGllbnRTZWdtZW50XS5wdXNoKHN1cHBsZW1lbnRzLnBvcCgpKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbHN0ID0gb3B0W2NpdGVwcm9jU2VnbWVudF07XG4gICAgICAgIHdoaWxlIChsc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICBsc3QucG9wKCk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSBvYmpbY2xpZW50U2VnbWVudF0ubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICBsc3QucHVzaChvYmpbY2xpZW50U2VnbWVudF1bal0pO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldExhbmdQcmVmc0ZvckNpdGVBZmZpeGVzID0gZnVuY3Rpb24gKGFmZml4TGlzdCkge1xuICAgIGlmIChhZmZpeExpc3QgJiYgYWZmaXhMaXN0Lmxlbmd0aCA9PT0gNDgpIHtcbiAgICAgICAgdmFyIGFmZml4ZXMgPSB0aGlzLm9wdC5jaXRlQWZmaXhlcztcbiAgICAgICAgdmFyIGNvdW50ID0gMDtcbiAgICAgICAgdmFyIHNldHRpbmdzID0gW1wicGVyc29uc1wiLCBcImluc3RpdHV0aW9uc1wiLCBcInRpdGxlc1wiLCBcImpvdXJuYWxzXCIsIFwicHVibGlzaGVyc1wiLCBcInBsYWNlc1wiXTtcbiAgICAgICAgdmFyIGZvcm1zID0gW1widHJhbnNsaXRcIiwgXCJvcmlnXCIsIFwidHJhbnNsaXRcIiwgXCJ0cmFuc2xhdFwiXTtcbiAgICAgICAgdmFyIHZhbHVlO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHNldHRpbmdzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSBmb3Jtcy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgaWYgKChjb3VudCAlIDgpID09PSA0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYWZmaXhlc1tzZXR0aW5nc1tpXV1bXCJsb2NhbGUtXCIrZm9ybXNbal1dLnByZWZpeFxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgIWFmZml4ZXNbc2V0dGluZ3NbaV1dW1wibG9jYWxlLVwiK2Zvcm1zW2pdXS5zdWZmaXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYWZmaXhMaXN0W2NvdW50XSA/IGFmZml4TGlzdFtjb3VudF0gOiBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgYWZmaXhlc1tzZXR0aW5nc1tpXV1bXCJsb2NhbGUtXCIgKyBmb3Jtc1tqXV0ucHJlZml4ID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFmZml4TGlzdFtjb3VudF0gPyBhZmZpeExpc3RbY291bnQgKyAxXSA6IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBhZmZpeGVzW3NldHRpbmdzW2ldXVtcImxvY2FsZS1cIiArIGZvcm1zW2pdXS5zdWZmaXggPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYWZmaXhMaXN0W2NvdW50XSA/IGFmZml4TGlzdFtjb3VudF0gOiBcIlwiO1xuICAgICAgICAgICAgICAgICAgICBhZmZpeGVzW3NldHRpbmdzW2ldXVtcImxvY2FsZS1cIiArIGZvcm1zW2pdXS5wcmVmaXggPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBhZmZpeExpc3RbY291bnRdID8gYWZmaXhMaXN0W2NvdW50ICsgMV0gOiBcIlwiO1xuICAgICAgICAgICAgICAgICAgICBhZmZpeGVzW3NldHRpbmdzW2ldXVtcImxvY2FsZS1cIiArIGZvcm1zW2pdXS5zdWZmaXggPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY291bnQgKz0gMjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLm9wdC5jaXRlQWZmaXhlcyA9IGFmZml4ZXM7XG4gICAgfVxufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldEF1dG9WaWV0bmFtZXNlTmFtZXNPcHRpb24gPSBmdW5jdGlvbiAoYXJnKSB7XG4gICAgaWYgKGFyZykge1xuICAgICAgICB0aGlzLm9wdFtcImF1dG8tdmlldG5hbWVzZS1uYW1lc1wiXSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5vcHRbXCJhdXRvLXZpZXRuYW1lc2UtbmFtZXNcIl0gPSBmYWxzZTtcbiAgICB9XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuc2V0QWJicmV2aWF0aW9ucyA9IGZ1bmN0aW9uIChhcmcpIHtcbiAgICBpZiAodGhpcy5zeXMuc2V0QWJicmV2aWF0aW9ucykge1xuICAgICAgICB0aGlzLnN5cy5zZXRBYmJyZXZpYXRpb25zKGFyZyk7XG4gICAgfVxufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldFN1cHByZXNzVHJhaWxpbmdQdW5jdHVhdGlvbiA9IGZ1bmN0aW9uIChhcmcpIHtcbiAgICB0aGlzLmNpdGF0aW9uLm9wdC5zdXBwcmVzc1RyYWlsaW5nUHVuY3R1YXRpb24gPSAhIWFyZztcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5PdXRwdXQgPSB7fTtcbkNTTC5PdXRwdXQuUXVldWUgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICB0aGlzLmxldmVsbmFtZSA9IFtcInRvcFwiXTtcbiAgICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gICAgdGhpcy5xdWV1ZSA9IFtdO1xuICAgIHRoaXMuZW1wdHkgPSBuZXcgQ1NMLlRva2VuKFwiZW1wdHlcIik7XG4gICAgdmFyIHRva2Vuc3RvcmUgPSB7fTtcbiAgICB0b2tlbnN0b3JlLmVtcHR5ID0gdGhpcy5lbXB0eTtcbiAgICB0aGlzLmZvcm1hdHMgPSBuZXcgQ1NMLlN0YWNrKHRva2Vuc3RvcmUpO1xuICAgIHRoaXMuY3VycmVudCA9IG5ldyBDU0wuU3RhY2sodGhpcy5xdWV1ZSk7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUucG9wID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBkcmlwID0gdGhpcy5jdXJyZW50LnZhbHVlKCk7XG4gICAgaWYgKGRyaXAubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBkcmlwLnBvcCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBkcmlwLmJsb2JzLnBvcCgpO1xuICAgIH1cbn07XG5DU0wuT3V0cHV0LlF1ZXVlLnByb3RvdHlwZS5nZXRUb2tlbiA9IGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgdmFyIHJldCA9IHRoaXMuZm9ybWF0cy52YWx1ZSgpW25hbWVdO1xuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUubWVyZ2VUb2tlblN0cmluZ3MgPSBmdW5jdGlvbiAoYmFzZSwgbW9kaWZpZXIpIHtcbiAgICB2YXIgYmFzZV90b2tlbiwgbW9kaWZpZXJfdG9rZW4sIHJldCwga2V5O1xuICAgIGJhc2VfdG9rZW4gPSB0aGlzLmZvcm1hdHMudmFsdWUoKVtiYXNlXTtcbiAgICBtb2RpZmllcl90b2tlbiA9IHRoaXMuZm9ybWF0cy52YWx1ZSgpW21vZGlmaWVyXTtcbiAgICByZXQgPSBiYXNlX3Rva2VuO1xuICAgIGlmIChtb2RpZmllcl90b2tlbikge1xuICAgICAgICBpZiAoIWJhc2VfdG9rZW4pIHtcbiAgICAgICAgICAgIGJhc2VfdG9rZW4gPSBuZXcgQ1NMLlRva2VuKGJhc2UsIENTTC5TSU5HTEVUT04pO1xuICAgICAgICAgICAgYmFzZV90b2tlbi5kZWNvcmF0aW9ucyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIHJldCA9IG5ldyBDU0wuVG9rZW4oYmFzZSwgQ1NMLlNJTkdMRVRPTik7XG4gICAgICAgIHZhciBrZXkgPSBcIlwiO1xuICAgICAgICBmb3IgKHZhciBrZXkgaW4gYmFzZV90b2tlbi5zdHJpbmdzKSB7XG4gICAgICAgICAgICBpZiAoYmFzZV90b2tlbi5zdHJpbmdzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgICByZXQuc3RyaW5nc1trZXldID0gYmFzZV90b2tlbi5zdHJpbmdzW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIga2V5IGluIG1vZGlmaWVyX3Rva2VuLnN0cmluZ3MpIHtcbiAgICAgICAgICAgIGlmIChtb2RpZmllcl90b2tlbi5zdHJpbmdzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgICByZXQuc3RyaW5nc1trZXldID0gbW9kaWZpZXJfdG9rZW4uc3RyaW5nc1trZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldC5kZWNvcmF0aW9ucyA9IGJhc2VfdG9rZW4uZGVjb3JhdGlvbnMuY29uY2F0KG1vZGlmaWVyX3Rva2VuLmRlY29yYXRpb25zKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuT3V0cHV0LlF1ZXVlLnByb3RvdHlwZS5hZGRUb2tlbiA9IGZ1bmN0aW9uIChuYW1lLCBtb2RpZmllciwgdG9rZW4pIHtcbiAgICB2YXIgbmV3dG9rLCBhdHRyO1xuICAgIG5ld3RvayA9IG5ldyBDU0wuVG9rZW4oXCJvdXRwdXRcIik7XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiB0b2tlbikge1xuICAgICAgICB0b2tlbiA9IHRoaXMuZm9ybWF0cy52YWx1ZSgpW3Rva2VuXTtcbiAgICB9XG4gICAgaWYgKHRva2VuICYmIHRva2VuLnN0cmluZ3MpIHtcbiAgICAgICAgZm9yIChhdHRyIGluIHRva2VuLnN0cmluZ3MpIHtcbiAgICAgICAgICAgIGlmICh0b2tlbi5zdHJpbmdzLmhhc093blByb3BlcnR5KGF0dHIpKSB7XG4gICAgICAgICAgICAgICAgbmV3dG9rLnN0cmluZ3NbYXR0cl0gPSB0b2tlbi5zdHJpbmdzW2F0dHJdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG5ld3Rvay5kZWNvcmF0aW9ucyA9IHRva2VuLmRlY29yYXRpb25zO1xuICAgIH1cbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG1vZGlmaWVyKSB7XG4gICAgICAgIG5ld3Rvay5zdHJpbmdzLmRlbGltaXRlciA9IG1vZGlmaWVyO1xuICAgIH1cbiAgICB0aGlzLmZvcm1hdHMudmFsdWUoKVtuYW1lXSA9IG5ld3Rvaztcbn07XG5DU0wuT3V0cHV0LlF1ZXVlLnByb3RvdHlwZS5wdXNoRm9ybWF0cyA9IGZ1bmN0aW9uICh0b2tlbnN0b3JlKSB7XG4gICAgaWYgKCF0b2tlbnN0b3JlKSB7XG4gICAgICAgIHRva2Vuc3RvcmUgPSB7fTtcbiAgICB9XG4gICAgdG9rZW5zdG9yZS5lbXB0eSA9IHRoaXMuZW1wdHk7XG4gICAgdGhpcy5mb3JtYXRzLnB1c2godG9rZW5zdG9yZSk7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUucG9wRm9ybWF0cyA9IGZ1bmN0aW9uICh0b2tlbnN0b3JlKSB7XG4gICAgdGhpcy5mb3JtYXRzLnBvcCgpO1xufTtcbkNTTC5PdXRwdXQuUXVldWUucHJvdG90eXBlLnN0YXJ0VGFnID0gZnVuY3Rpb24gKG5hbWUsIHRva2VuKSB7XG4gICAgdmFyIHRva2Vuc3RvcmUgPSB7fTtcbiAgICBpZiAodGhpcy5zdGF0ZS50bXBbXCJkb2luZy1tYWNyby13aXRoLWRhdGVcIl0gJiYgdGhpcy5zdGF0ZS50bXAuZXh0ZW5zaW9uKSB7XG4gICAgICAgIHRva2VuID0gdGhpcy5lbXB0eTtcbiAgICAgICAgbmFtZSA9IFwiZW1wdHlcIjtcbiAgICB9XG4gICAgdG9rZW5zdG9yZVtuYW1lXSA9IHRva2VuO1xuICAgIHRoaXMucHVzaEZvcm1hdHModG9rZW5zdG9yZSk7XG4gICAgdGhpcy5vcGVuTGV2ZWwobmFtZSk7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUuZW5kVGFnID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICB0aGlzLmNsb3NlTGV2ZWwobmFtZSk7XG4gICAgdGhpcy5wb3BGb3JtYXRzKCk7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUub3BlbkxldmVsID0gZnVuY3Rpb24gKHRva2VuLCBlcGhlbWVyYWwpIHtcbiAgICB2YXIgYmxvYiwgY3VyciwgeCwgaGFzX2VwaGVtZXJhbDtcbiAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIHRva2VuKSB7XG4gICAgICAgIGJsb2IgPSBuZXcgQ1NMLkJsb2IodW5kZWZpbmVkLCB0b2tlbik7XG4gICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdG9rZW4pIHtcbiAgICAgICAgYmxvYiA9IG5ldyBDU0wuQmxvYih1bmRlZmluZWQsIHRoaXMuZm9ybWF0cy52YWx1ZSgpLmVtcHR5LCBcImVtcHR5XCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghdGhpcy5mb3JtYXRzLnZhbHVlKCkgfHwgIXRoaXMuZm9ybWF0cy52YWx1ZSgpW3Rva2VuXSkge1xuICAgICAgICAgICAgdGhyb3cgXCJDU0wgcHJvY2Vzc29yIGVycm9yOiBjYWxsIHRvIG5vbmV4aXN0ZW50IGZvcm1hdCB0b2tlbiBcXFwiXCIgKyB0b2tlbiArIFwiXFxcIlwiO1xuICAgICAgICB9XG4gICAgICAgIGJsb2IgPSBuZXcgQ1NMLkJsb2IodW5kZWZpbmVkLCB0aGlzLmZvcm1hdHMudmFsdWUoKVt0b2tlbl0sIHRva2VuKTtcbiAgICB9XG4gICAgY3VyciA9IHRoaXMuY3VycmVudC52YWx1ZSgpO1xuICAgIGlmICghdGhpcy5zdGF0ZS50bXAuanVzdF9sb29raW5nICYmIHRoaXMuY2hlY2tOZXN0ZWRCcmFjZSkge1xuICAgICAgICBibG9iLnN0cmluZ3MucHJlZml4ID0gdGhpcy5jaGVja05lc3RlZEJyYWNlLnVwZGF0ZShibG9iLnN0cmluZ3MucHJlZml4KTtcbiAgICB9XG4gICAgY3Vyci5wdXNoKGJsb2IpO1xuICAgIHRoaXMuY3VycmVudC5wdXNoKGJsb2IpO1xufTtcbkNTTC5PdXRwdXQuUXVldWUucHJvdG90eXBlLmNsb3NlTGV2ZWwgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIGlmIChuYW1lICYmIG5hbWUgIT09IHRoaXMuY3VycmVudC52YWx1ZSgpLmxldmVsbmFtZSkge1xuICAgICAgICBDU0wuZXJyb3IoXCJMZXZlbCBtaXNtYXRjaCBlcnJvcjogIHdhbnRlZCBcIiArIG5hbWUgKyBcIiBidXQgZm91bmQgXCIgKyB0aGlzLmN1cnJlbnQudmFsdWUoKS5sZXZlbG5hbWUpO1xuICAgIH1cbiAgICB2YXIgYmxvYiA9IHRoaXMuY3VycmVudC5wb3AoKTtcbiAgICBpZiAoIXRoaXMuc3RhdGUudG1wLmp1c3RfbG9va2luZyAmJiB0aGlzLmNoZWNrTmVzdGVkQnJhY2UpIHtcbiAgICAgICAgYmxvYi5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuY2hlY2tOZXN0ZWRCcmFjZS51cGRhdGUoYmxvYi5zdHJpbmdzLnN1ZmZpeCk7XG4gICAgfVxufTtcbkNTTC5PdXRwdXQuUXVldWUucHJvdG90eXBlLmFwcGVuZCA9IGZ1bmN0aW9uIChzdHIsIHRva25hbWUsIG5vdFNlcmlvdXMsIGlnbm9yZVByZWRlY2Vzc29yLCBub1N0cmlwUGVyaW9kcykge1xuICAgIHZhciB0b2tlbiwgYmxvYiwgY3VycjtcbiAgICB2YXIgdXNlYmxvYiA9IHRydWU7XG4gICAgaWYgKG5vdFNlcmlvdXMpIHtcbiAgICAgICAgaWdub3JlUHJlZGVjZXNzb3IgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0ZS50bXBbXCJkb2luZy1tYWNyby13aXRoLWRhdGVcIl0gJiYgIW5vdFNlcmlvdXMpIHtcbiAgICAgICAgaWYgKHRva25hbWUgIT09IFwibWFjcm8td2l0aC1kYXRlXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodG9rbmFtZSA9PT0gXCJtYWNyby13aXRoLWRhdGVcIikge1xuICAgICAgICAgICAgdG9rbmFtZSA9IFwiZW1wdHlcIjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHN0cikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChcIm51bWJlclwiID09PSB0eXBlb2Ygc3RyKSB7XG4gICAgICAgIHN0ciA9IFwiXCIgKyBzdHI7XG4gICAgfVxuICAgIGlmICghbm90U2VyaW91cyBcbiAgICAgICAgJiYgdGhpcy5zdGF0ZS50bXAuZWxlbWVudF90cmFjZSBcbiAgICAgICAgJiYgdGhpcy5zdGF0ZS50bXAuZWxlbWVudF90cmFjZS52YWx1ZSgpID09PSBcInN1cHByZXNzLW1lXCIpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBibG9iID0gZmFsc2U7XG4gICAgaWYgKCF0b2tuYW1lKSB7XG4gICAgICAgIHRva2VuID0gdGhpcy5mb3JtYXRzLnZhbHVlKCkuZW1wdHk7XG4gICAgfSBlbHNlIGlmICh0b2tuYW1lID09PSBcImxpdGVyYWxcIikge1xuICAgICAgICB0b2tlbiA9IHRydWU7XG4gICAgICAgIHVzZWJsb2IgPSBmYWxzZTtcbiAgICB9IGVsc2UgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiB0b2tuYW1lKSB7XG4gICAgICAgIHRva2VuID0gdGhpcy5mb3JtYXRzLnZhbHVlKClbdG9rbmFtZV07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdG9rZW4gPSB0b2tuYW1lO1xuICAgIH1cbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICAgIHRocm93IFwiQ1NMIHByb2Nlc3NvciBlcnJvcjogdW5rbm93biBmb3JtYXQgdG9rZW4gbmFtZTogXCIgKyB0b2tuYW1lO1xuICAgIH1cbiAgICBpZiAodG9rZW4uc3RyaW5ncyAmJiBcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdG9rZW4uc3RyaW5ncy5kZWxpbWl0ZXIpIHtcbiAgICAgICAgdG9rZW4uc3RyaW5ncy5kZWxpbWl0ZXIgPSBcIlwiO1xuICAgIH1cbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHN0ciAmJiBzdHIubGVuZ3RoKSB7XG4gICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC8gKFs6Oz8hXFx1MDBiYl0pL2csIFwiXFx1MjAyZiQxXCIpLnJlcGxhY2UoL1xcdTAwYWIgL2csIFwiXFx1MDBhYlxcdTIwMmZcIik7XG4gICAgICAgIHRoaXMubGFzdF9jaGFyX3JlbmRlcmVkID0gc3RyLnNsaWNlKC0xKTtcbiAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoL1xccysnL2csIFwiIFxcJ1wiKTtcbiAgICAgICAgaWYgKCFub3RTZXJpb3VzKSB7XG4gICAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgvXicvZywgXCIgXFwnXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghaWdub3JlUHJlZGVjZXNzb3IpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnRlcm1fcHJlZGVjZXNzb3IgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuaW5fY2l0ZV9wcmVkZWNlc3NvciA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAobm90U2VyaW91cykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3Nvcl9uYW1lID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBibG9iID0gbmV3IENTTC5CbG9iKHN0ciwgdG9rZW4pO1xuICAgIGN1cnIgPSB0aGlzLmN1cnJlbnQudmFsdWUoKTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGN1cnIgJiYgdGhpcy5jdXJyZW50Lm15c3RhY2subGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMuY3VycmVudC5teXN0YWNrLnB1c2goW10pO1xuICAgICAgICBjdXJyID0gdGhpcy5jdXJyZW50LnZhbHVlKCk7XG4gICAgfVxuICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgYmxvYi5ibG9icykge1xuICAgICAgICBpZiAoIWlnbm9yZVByZWRlY2Vzc29yKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC50ZXJtX3ByZWRlY2Vzc29yID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmluX2NpdGVfcHJlZGVjZXNzb3IgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKG5vdFNlcmlvdXMpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnRlcm1fcHJlZGVjZXNzb3JfbmFtZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFub3RTZXJpb3VzKSB7XG4gICAgICAgIHRoaXMuc3RhdGUucGFyYWxsZWwuQXBwZW5kQmxvYlBvaW50ZXIoY3Vycik7XG4gICAgfVxuICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2Ygc3RyKSB7XG4gICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgYmxvYi5ibG9icykge1xuICAgICAgICAgICAgaWYgKGJsb2IuYmxvYnMuc2xpY2UoMCwgMSkgIT09IFwiIFwiKSB7XG4gICAgICAgICAgICAgICAgdmFyIGJsb2JQcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgIHZhciBibG9iQmxvYnMgPSBibG9iLmJsb2JzO1xuICAgICAgICAgICAgICAgIHdoaWxlIChDU0wuVEVSTUlOQUxfUFVOQ1RVQVRJT04uaW5kZXhPZihibG9iQmxvYnMuc2xpY2UoMCwgMSkpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgYmxvYlByZWZpeCA9IGJsb2JQcmVmaXggKyBibG9iQmxvYnMuc2xpY2UoMCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIGJsb2JCbG9icyA9IGJsb2JCbG9icy5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGJsb2JCbG9icyAmJiBibG9iUHJlZml4KSB7XG4gICAgICAgICAgICAgICAgICAgIGJsb2Iuc3RyaW5ncy5wcmVmaXggPSBibG9iLnN0cmluZ3MucHJlZml4ICsgYmxvYlByZWZpeDtcbiAgICAgICAgICAgICAgICAgICAgYmxvYi5ibG9icyA9IGJsb2JCbG9icztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJsb2Iuc3RyaW5nc1tcInRleHQtY2FzZVwiXSkge1xuICAgICAgICAgICAgYmxvYi5ibG9icyA9IENTTC5PdXRwdXQuRm9ybWF0dGVyc1tibG9iLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl1dKHRoaXMuc3RhdGUsIHN0cik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLnN0cmlwX3BlcmlvZHMgJiYgIW5vU3RyaXBQZXJpb2RzKSB7XG4gICAgICAgICAgICBibG9iLmJsb2JzID0gYmxvYi5ibG9icy5yZXBsYWNlKC9cXC4oW15hLXpdfCQpL2csIFwiJDFcIik7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaSA9IGJsb2IuZGVjb3JhdGlvbnMubGVuZ3RoIC0gMTsgaSA+IC0xOyBpICs9IC0xKSB7XG4gICAgICAgICAgICBpZiAoYmxvYi5kZWNvcmF0aW9uc1tpXVswXSA9PT0gXCJAcXVvdGVzXCIgJiYgYmxvYi5kZWNvcmF0aW9uc1tpXVsxXSAhPT0gXCJmYWxzZVwiKSB7XG4gICAgICAgICAgICAgICAgYmxvYi5wdW5jdHVhdGlvbl9pbl9xdW90ZSA9IHRoaXMuc3RhdGUuZ2V0T3B0KFwicHVuY3R1YXRpb24taW4tcXVvdGVcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWJsb2IuYmxvYnMubWF0Y2goQ1NMLlJPTUFORVNRVUVfUkVHRVhQKSkge1xuICAgICAgICAgICAgICAgIGlmIChibG9iLmRlY29yYXRpb25zW2ldWzBdID09PSBcIkBmb250LXN0eWxlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgYmxvYi5kZWNvcmF0aW9ucyA9IGJsb2IuZGVjb3JhdGlvbnMuc2xpY2UoMCwgaSkuY29uY2F0KGJsb2IuZGVjb3JhdGlvbnMuc2xpY2UoaSArIDEpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY3Vyci5wdXNoKGJsb2IpO1xuICAgICAgICB0aGlzLnN0YXRlLmZ1bi5mbGlwZmxvcHBlci5wcm9jZXNzVGFncyhibG9iKTtcbiAgICB9IGVsc2UgaWYgKHVzZWJsb2IpIHtcbiAgICAgICAgY3Vyci5wdXNoKGJsb2IpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGN1cnIucHVzaChzdHIpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn07XG5DU0wuT3V0cHV0LlF1ZXVlLnByb3RvdHlwZS5zdHJpbmcgPSBmdW5jdGlvbiAoc3RhdGUsIG15YmxvYnMsIGJsb2IpIHtcbiAgICB2YXIgaSwgaWxlbiwgaiwgamxlbiwgYjtcbiAgICB2YXIgdHh0X2VzYyA9IENTTC5nZXRTYWZlRXNjYXBlKHRoaXMuc3RhdGUpO1xuICAgIHZhciBibG9icyA9IG15YmxvYnMuc2xpY2UoKTtcbiAgICB2YXIgcmV0ID0gW107XG4gICAgaWYgKGJsb2JzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICB2YXIgYmxvYl9kZWxpbWl0ZXIgPSBcIlwiO1xuICAgIGlmIChibG9iKSB7XG4gICAgICAgIGJsb2JfZGVsaW1pdGVyID0gYmxvYi5zdHJpbmdzLmRlbGltaXRlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzdGF0ZS50bXAuY291bnRfb2Zmc2V0X2NoYXJhY3RlcnMgPSBmYWxzZTtcbiAgICAgICAgc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzID0gMDtcbiAgICB9XG4gICAgaWYgKGJsb2IgJiYgYmxvYi5uZXdfbG9jYWxlKSB7XG4gICAgICAgIGJsb2Iub2xkX2xvY2FsZSA9IHN0YXRlLm9wdC5sYW5nO1xuICAgICAgICBzdGF0ZS5vcHQubGFuZyA9IGJsb2IubmV3X2xvY2FsZTtcbiAgICB9XG4gICAgdmFyIGJsb2JqciwgdXNlX3N1ZmZpeCwgdXNlX3ByZWZpeCwgcGFyYW1zO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gYmxvYnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGJsb2JqciA9IGJsb2JzW2ldO1xuICAgICAgICBpZiAoYmxvYmpyLnN0cmluZ3MuZmlyc3RfYmxvYikge1xuICAgICAgICAgICAgc3RhdGUudG1wLmNvdW50X29mZnNldF9jaGFyYWN0ZXJzID0gYmxvYmpyLnN0cmluZ3MuZmlyc3RfYmxvYjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2Jqci5ibG9icykge1xuICAgICAgICAgICAgaWYgKFwibnVtYmVyXCIgPT09IHR5cGVvZiBibG9ianIubnVtKSB7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2goYmxvYmpyKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvYmpyLmJsb2JzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGJsb2Jqci5wYXJ0aWNsZSkge1xuICAgICAgICAgICAgICAgICAgICBibG9ianIuYmxvYnMgPSBibG9ianIucGFydGljbGUgKyBibG9ianIuYmxvYnM7XG4gICAgICAgICAgICAgICAgICAgIGJsb2Jqci5wYXJ0aWNsZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGIgPSB0eHRfZXNjKGJsb2Jqci5ibG9icyk7XG4gICAgICAgICAgICAgICAgdmFyIGJsZW4gPSBiLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gYmxvYmpyLmRlY29yYXRpb25zLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gYmxvYmpyLmRlY29yYXRpb25zW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtc1swXSA9PT0gXCJAc2hvd2lkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5ub3JtYWxEZWNvcklzT3JwaGFuKGJsb2JqciwgcGFyYW1zKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYiA9IHN0YXRlLmZ1bi5kZWNvcmF0ZVtwYXJhbXNbMF1dW3BhcmFtc1sxXV0uY2FsbChibG9ianIsIHN0YXRlLCBiLCBwYXJhbXNbMl0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChiICYmIGIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGIgPSB0eHRfZXNjKGJsb2Jqci5zdHJpbmdzLnByZWZpeCkgKyBiICsgdHh0X2VzYyhibG9ianIuc3RyaW5ncy5zdWZmaXgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmNzbF9yZXZlcnNlX2xvb2t1cF9zdXBwb3J0IHx8IHN0YXRlLnN5cy5jc2xfcmV2ZXJzZV9sb29rdXBfc3VwcG9ydCkgJiYgIXN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IGJsb2Jqci5kZWNvcmF0aW9ucy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBibG9ianIuZGVjb3JhdGlvbnNbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtc1swXSA9PT0gXCJAc2hvd2lkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYiA9IHN0YXRlLmZ1bi5kZWNvcmF0ZVtwYXJhbXNbMF1dW3BhcmFtc1sxXV0uY2FsbChibG9ianIsIHN0YXRlLCBiLCBwYXJhbXNbMl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXQucHVzaChiKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5jb3VudF9vZmZzZXRfY2hhcmFjdGVycykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzICs9IChibGVuICsgYmxvYmpyLnN0cmluZ3Muc3VmZml4Lmxlbmd0aCArIGJsb2Jqci5zdHJpbmdzLnByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGJsb2Jqci5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhciBhZGR0b3JldCA9IHN0YXRlLm91dHB1dC5zdHJpbmcoc3RhdGUsIGJsb2Jqci5ibG9icywgYmxvYmpyKTtcbiAgICAgICAgICAgIGlmIChibG9iKSB7XG4gICAgICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgIT09IGFkZHRvcmV0ICYmIGFkZHRvcmV0Lmxlbmd0aCA+IDEgJiYgYmxvYmpyLnN0cmluZ3MuZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBudW1iZXJTZWVuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPWFkZHRvcmV0Lmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiAhPT0gdHlwZW9mIGFkZHRvcmV0W2pdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyU2VlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG51bWJlclNlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGR0b3JldFtqXSA9IChibG9ianIuc3RyaW5ncy5kZWxpbWl0ZXIgKyBhZGR0b3JldFtqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXQgPSByZXQuY29uY2F0KGFkZHRvcmV0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYmxvYmpyLnN0cmluZ3MuZmlyc3RfYmxvYiAmJiBzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtibG9ianIuc3RyaW5ncy5maXJzdF9ibG9iXSkge1xuICAgICAgICAgICAgc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbYmxvYmpyLnN0cmluZ3MuZmlyc3RfYmxvYl0ub2Zmc2V0ID0gc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzO1xuICAgICAgICAgICAgc3RhdGUudG1wLmNvdW50X29mZnNldF9jaGFyYWN0ZXJzID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yIChpPTAsaWxlbj1yZXQubGVuZ3RoIC0gMTtpPGlsZW47aSs9MSkge1xuICAgICAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIHJldFtpXS5udW0gJiYgXCJudW1iZXJcIiA9PT0gdHlwZW9mIHJldFtpKzFdLm51bSAmJiAhcmV0W2krMV0uVUdMWV9ERUxJTUlURVJfU1VQUFJFU1NfSEFDSykge1xuICAgICAgICAgICAgcmV0W2ldLnN0cmluZ3Muc3VmZml4ID0gcmV0W2ldLnN0cmluZ3Muc3VmZml4ICsgKGJsb2JfZGVsaW1pdGVyID8gYmxvYl9kZWxpbWl0ZXIgOiBcIlwiKTtcbiAgICAgICAgICAgIHJldFtpKzFdLnN1Y2Nlc3Nvcl9wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgcmV0W2krMV0uVUdMWV9ERUxJTUlURVJfU1VQUFJFU1NfSEFDSyA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHNwYW5fc3BsaXQgPSAwO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gcmV0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHJldFtpXSkge1xuICAgICAgICAgICAgc3Bhbl9zcGxpdCA9IChwYXJzZUludChpLCAxMCkgKyAxKTtcbiAgICAgICAgICAgIGlmIChpIDwgcmV0Lmxlbmd0aCAtIDEgICYmIFwib2JqZWN0XCIgPT09IHR5cGVvZiByZXRbaSArIDFdKSB7XG4gICAgICAgICAgICAgICAgaWYgKGJsb2JfZGVsaW1pdGVyICYmICFyZXRbaSArIDFdLlVHTFlfREVMSU1JVEVSX1NVUFBSRVNTX0hBQ0spIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0W2ldICs9IHR4dF9lc2MoYmxvYl9kZWxpbWl0ZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXRbaSArIDFdLlVHTFlfREVMSU1JVEVSX1NVUFBSRVNTX0hBQ0sgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChibG9iICYmIChibG9iLmRlY29yYXRpb25zLmxlbmd0aCB8fCBibG9iLnN0cmluZ3Muc3VmZml4KSkge1xuICAgICAgICBzcGFuX3NwbGl0ID0gcmV0Lmxlbmd0aDtcbiAgICB9IGVsc2UgaWYgKGJsb2IgJiYgYmxvYi5zdHJpbmdzLnByZWZpeCkge1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1yZXQubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgcmV0W2ldLm51bSkge1xuICAgICAgICAgICAgICAgIHNwYW5fc3BsaXQgPSBpO1xuICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldFtpXS5zdHJpbmdzLnByZWZpeCA9IGJsb2Iuc3RyaW5ncy5wcmVmaXggKyByZXRbaV0uc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHZhciBibG9ic19zdGFydCA9IHN0YXRlLm91dHB1dC5yZW5kZXJCbG9icyhyZXQuc2xpY2UoMCwgc3Bhbl9zcGxpdCksIGJsb2JfZGVsaW1pdGVyLCBmYWxzZSwgYmxvYik7XG4gICAgaWYgKGJsb2JzX3N0YXJ0ICYmIGJsb2IgJiYgKGJsb2IuZGVjb3JhdGlvbnMubGVuZ3RoIHx8IGJsb2Iuc3RyaW5ncy5zdWZmaXggfHwgYmxvYi5zdHJpbmdzLnByZWZpeCkpIHtcbiAgICAgICAgaWYgKCFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gYmxvYi5kZWNvcmF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMgPSBibG9iLmRlY29yYXRpb25zW2ldO1xuICAgICAgICAgICAgICAgIGlmIChbXCJAY2l0ZVwiLFwiQGJpYmxpb2dyYXBoeVwiLCBcIkBkaXNwbGF5XCIsIFwiQHNob3dpZFwiXS5pbmRleE9mKHBhcmFtc1swXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLm5vcm1hbERlY29ySXNPcnBoYW4oYmxvYmpyLCBwYXJhbXMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2JzX3N0YXJ0KSB7XG4gICAgICAgICAgICAgICAgICAgIGJsb2JzX3N0YXJ0ID0gc3RhdGUuZnVuLmRlY29yYXRlW3BhcmFtc1swXV1bcGFyYW1zWzFdXS5jYWxsKGJsb2IsIHN0YXRlLCBibG9ic19zdGFydCwgcGFyYW1zWzJdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYiA9IGJsb2JzX3N0YXJ0O1xuICAgICAgICB1c2Vfc3VmZml4ID0gYmxvYi5zdHJpbmdzLnN1ZmZpeDtcbiAgICAgICAgaWYgKGIgJiYgYi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHVzZV9wcmVmaXggPSBibG9iLnN0cmluZ3MucHJlZml4O1xuICAgICAgICAgICAgYiA9IHR4dF9lc2ModXNlX3ByZWZpeCkgKyBiICsgdHh0X2VzYyh1c2Vfc3VmZml4KTtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY291bnRfb2Zmc2V0X2NoYXJhY3RlcnMpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAub2Zmc2V0X2NoYXJhY3RlcnMgKz0gKHVzZV9wcmVmaXgubGVuZ3RoICsgdXNlX3N1ZmZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJsb2JzX3N0YXJ0ID0gYjtcbiAgICAgICAgaWYgKCFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gYmxvYi5kZWNvcmF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMgPSBibG9iLmRlY29yYXRpb25zW2ldO1xuICAgICAgICAgICAgICAgIGlmIChbXCJAY2l0ZVwiLFwiQGJpYmxpb2dyYXBoeVwiLCBcIkBkaXNwbGF5XCIsIFwiQHNob3dpZFwiXS5pbmRleE9mKHBhcmFtc1swXSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2JzX3N0YXJ0KSB7XG4gICAgICAgICAgICAgICAgICAgIGJsb2JzX3N0YXJ0ID0gc3RhdGUuZnVuLmRlY29yYXRlW3BhcmFtc1swXV1bcGFyYW1zWzFdXS5jYWxsKGJsb2IsIHN0YXRlLCBibG9ic19zdGFydCwgcGFyYW1zWzJdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIGJsb2JzX2VuZCA9IHJldC5zbGljZShzcGFuX3NwbGl0LCByZXQubGVuZ3RoKTtcbiAgICBpZiAoIWJsb2JzX2VuZC5sZW5ndGggJiYgYmxvYnNfc3RhcnQpIHtcbiAgICAgICAgcmV0ID0gW2Jsb2JzX3N0YXJ0XTtcbiAgICB9IGVsc2UgaWYgKGJsb2JzX2VuZC5sZW5ndGggJiYgIWJsb2JzX3N0YXJ0KSB7XG4gICAgICAgIHJldCA9IGJsb2JzX2VuZDtcbiAgICB9IGVsc2UgaWYgKGJsb2JzX3N0YXJ0ICYmIGJsb2JzX2VuZC5sZW5ndGgpIHtcbiAgICAgICAgcmV0ID0gW2Jsb2JzX3N0YXJ0XS5jb25jYXQoYmxvYnNfZW5kKTtcbiAgICB9XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBibG9iKSB7XG4gICAgICAgIHRoaXMucXVldWUgPSBbXTtcbiAgICAgICAgdGhpcy5jdXJyZW50Lm15c3RhY2sgPSBbXTtcbiAgICAgICAgdGhpcy5jdXJyZW50Lm15c3RhY2sucHVzaCh0aGlzLnF1ZXVlKTtcbiAgICAgICAgaWYgKHN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgcmV0ID0gc3RhdGUub3V0cHV0LnJlbmRlckJsb2JzKHJldCwgdW5kZWZpbmVkLCBmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKFwiYm9vbGVhblwiID09PSB0eXBlb2YgYmxvYikge1xuICAgICAgICByZXQgPSBzdGF0ZS5vdXRwdXQucmVuZGVyQmxvYnMocmV0LCB1bmRlZmluZWQsIHRydWUpO1xuICAgIH1cbiAgICBpZiAoYmxvYiAmJiBibG9iLm5ld19sb2NhbGUpIHtcbiAgICAgICAgc3RhdGUub3B0LmxhbmcgPSBibG9iLm9sZF9sb2NhbGU7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUuY2xlYXJsZXZlbCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgYmxvYiwgcG9zLCBsZW47XG4gICAgYmxvYiA9IHRoaXMuY3VycmVudC52YWx1ZSgpO1xuICAgIGxlbiA9IGJsb2IuYmxvYnMubGVuZ3RoO1xuICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBibG9iLmJsb2JzLnBvcCgpO1xuICAgIH1cbn07XG5DU0wuT3V0cHV0LlF1ZXVlLnByb3RvdHlwZS5yZW5kZXJCbG9icyA9IGZ1bmN0aW9uIChibG9icywgZGVsaW0sIGluX2NpdGUsIHBhcmVudCkge1xuICAgIHZhciBzdGF0ZSwgcmV0LCByZXRfbGFzdF9jaGFyLCB1c2VfZGVsaW0sIGksIGJsb2IsIHBvcywgbGVuLCBwcG9zLCBsbGVuLCBwcHBvcywgbGxsZW4sIHJlcywgc3RyLCBwYXJhbXMsIHR4dF9lc2M7XG4gICAgdHh0X2VzYyA9IENTTC5nZXRTYWZlRXNjYXBlKHRoaXMuc3RhdGUpO1xuICAgIGlmICghZGVsaW0pIHtcbiAgICAgICAgZGVsaW0gPSBcIlwiO1xuICAgIH1cbiAgICBzdGF0ZSA9IHRoaXMuc3RhdGU7XG4gICAgcmV0ID0gXCJcIjtcbiAgICByZXRfbGFzdF9jaGFyID0gW107XG4gICAgdXNlX2RlbGltID0gXCJcIjtcbiAgICBsZW4gPSBibG9icy5sZW5ndGg7XG4gICAgaWYgKHRoaXMuc3RhdGUudG1wLmFyZWEgPT09IFwiY2l0YXRpb25cIiAmJiAhdGhpcy5zdGF0ZS50bXAuanVzdF9sb29raW5nICYmIGxlbiA9PT0gMSAmJiB0eXBlb2YgYmxvYnNbMF0gPT09IFwib2JqZWN0XCIgJiYgcGFyZW50KSB7XG4gICAgICAgIGJsb2JzWzBdLnN0cmluZ3MucHJlZml4ID0gcGFyZW50LnN0cmluZ3MucHJlZml4ICsgYmxvYnNbMF0uc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgIGJsb2JzWzBdLnN0cmluZ3Muc3VmZml4ID0gYmxvYnNbMF0uc3RyaW5ncy5zdWZmaXggKyBwYXJlbnQuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgIGJsb2JzWzBdLmRlY29yYXRpb25zID0gYmxvYnNbMF0uZGVjb3JhdGlvbnMuY29uY2F0KHBhcmVudC5kZWNvcmF0aW9ucyk7XG4gICAgICAgIGJsb2JzWzBdLnBhcmFtcyA9IHBhcmVudC5wYXJhbXM7XG4gICAgICAgIHJldHVybiBibG9ic1swXTtcbiAgICB9XG4gICAgdmFyIHN0YXJ0ID0gdHJ1ZTtcbiAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgaWYgKGJsb2JzW3Bvc10uY2hlY2tOZXh0KSB7XG4gICAgICAgICAgICBibG9ic1twb3NdLmNoZWNrTmV4dChibG9ic1twb3MgKyAxXSxzdGFydCk7XG4gICAgICAgICAgICBzdGFydCA9IGZhbHNlO1xuICAgICAgICB9IGVsc2UgaWYgKGJsb2JzW3BvcysxXSAmJiBibG9ic1twb3MrMV0uc3BsaWNlX3ByZWZpeCkge1xuICAgICAgICAgICAgc3RhcnQgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0YXJ0ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgZG9pdCA9IHRydWU7XG4gICAgZm9yIChwb3MgPSBibG9icy5sZW5ndGggLSAxOyBwb3MgPiAwOyBwb3MgKz0gLTEpIHtcbiAgICAgICAgaWYgKGJsb2JzW3Bvc10uY2hlY2tMYXN0KSB7XG4gICAgICAgICAgICBpZiAoZG9pdCAmJiBibG9ic1twb3NdLmNoZWNrTGFzdChibG9ic1twb3MgLSAxXSkpIHtcbiAgICAgICAgICAgICAgICBkb2l0ID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkb2l0ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBsZW4gPSBibG9icy5sZW5ndGg7XG4gICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIGJsb2IgPSBibG9ic1twb3NdO1xuICAgICAgICBpZiAocmV0KSB7XG4gICAgICAgICAgICB1c2VfZGVsaW0gPSBkZWxpbTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2IpIHtcbiAgICAgICAgICAgIHJldCArPSB0eHRfZXNjKHVzZV9kZWxpbSk7XG4gICAgICAgICAgICByZXQgKz0gYmxvYjtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY291bnRfb2Zmc2V0X2NoYXJhY3RlcnMpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAub2Zmc2V0X2NoYXJhY3RlcnMgKz0gKHVzZV9kZWxpbS5sZW5ndGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGluX2NpdGUpIHtcbiAgICAgICAgICAgIGlmIChyZXQpIHtcbiAgICAgICAgICAgICAgICByZXQgPSBbcmV0LCBibG9iXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gW2Jsb2JdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGJsb2Iuc3RhdHVzICE9PSBDU0wuU1VQUFJFU1MpIHtcbiAgICAgICAgICAgIGlmIChibG9iLnBhcnRpY2xlKSB7XG4gICAgICAgICAgICAgICAgc3RyID0gYmxvYi5wYXJ0aWNsZSArIGJsb2IubnVtO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdHIgPSBibG9iLmZvcm1hdHRlci5mb3JtYXQoYmxvYi5udW0sIGJsb2IuZ2VuZGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzdHJsZW4gPSBzdHIucmVwbGFjZSgvPFtePl0qPi9nLCBcIlwiKS5sZW5ndGg7XG4gICAgICAgICAgICB0aGlzLmFwcGVuZChzdHIsIFwiZW1wdHlcIiwgdHJ1ZSk7XG4gICAgICAgICAgICB2YXIgc3RyX2Jsb2IgPSB0aGlzLnBvcCgpO1xuICAgICAgICAgICAgdmFyIGNvdW50X29mZnNldF9jaGFyYWN0ZXJzID0gc3RhdGUudG1wLmNvdW50X29mZnNldF9jaGFyYWN0ZXJzO1xuICAgICAgICAgICAgc3RyID0gdGhpcy5zdHJpbmcoc3RhdGUsIFtzdHJfYmxvYl0sIGZhbHNlKTtcbiAgICAgICAgICAgIHN0YXRlLnRtcC5jb3VudF9vZmZzZXRfY2hhcmFjdGVycyA9IGNvdW50X29mZnNldF9jaGFyYWN0ZXJzO1xuICAgICAgICAgICAgaWYgKGJsb2Iuc3RyaW5nc1tcInRleHQtY2FzZVwiXSkge1xuICAgICAgICAgICAgICAgIHN0ciA9IENTTC5PdXRwdXQuRm9ybWF0dGVyc1tibG9iLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl1dKHRoaXMuc3RhdGUsIHN0cik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc3RyICYmIHRoaXMuc3RhdGUudG1wLnN0cmlwX3BlcmlvZHMpIHtcbiAgICAgICAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgvXFwuKFteYS16XXwkKS9nLCBcIiQxXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBsbGVuID0gYmxvYi5kZWNvcmF0aW9ucy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgZm9yIChwcG9zID0gMDsgcHBvcyA8IGxsZW47IHBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBibG9iLmRlY29yYXRpb25zW3Bwb3NdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUubm9ybWFsRGVjb3JJc09ycGhhbihibG9iLCBwYXJhbXMpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdGF0ZS5mdW4uZGVjb3JhdGVbcGFyYW1zWzBdXVtwYXJhbXNbMV1dLmNhbGwoYmxvYiwgc3RhdGUsIHN0ciwgcGFyYW1zWzJdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdHIgPSB0eHRfZXNjKGJsb2Iuc3RyaW5ncy5wcmVmaXgpICsgc3RyICsgdHh0X2VzYyhibG9iLnN0cmluZ3Muc3VmZml4KTtcbiAgICAgICAgICAgIHZhciBhZGRtZSA9IFwiXCI7XG4gICAgICAgICAgICBpZiAoYmxvYi5zdGF0dXMgPT09IENTTC5FTkQpIHtcbiAgICAgICAgICAgICAgICBhZGRtZSA9IHR4dF9lc2MoYmxvYi5yYW5nZV9wcmVmaXgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChibG9iLnN0YXR1cyA9PT0gQ1NMLlNVQ0NFU1NPUikge1xuICAgICAgICAgICAgICAgIGFkZG1lID0gdHh0X2VzYyhibG9iLnN1Y2Nlc3Nvcl9wcmVmaXgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChibG9iLnN0YXR1cyA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBvcyA+IDAgJiYgIWJsb2Iuc3VwcHJlc3Nfc3BsaWNlX3ByZWZpeCkge1xuICAgICAgICAgICAgICAgICAgICBhZGRtZSA9IHR4dF9lc2MoYmxvYi5zcGxpY2VfcHJlZml4KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhZGRtZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChibG9iLnN0YXR1cyA9PT0gQ1NMLlNFRU4pIHtcbiAgICAgICAgICAgICAgICBhZGRtZSA9IHR4dF9lc2MoYmxvYi5zcGxpY2VfcHJlZml4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldCArPSBhZGRtZTtcbiAgICAgICAgICAgIHJldCArPSBzdHI7XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLmNvdW50X29mZnNldF9jaGFyYWN0ZXJzKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzICs9IChhZGRtZS5sZW5ndGggKyBibG9iLnN0cmluZ3MucHJlZml4Lmxlbmd0aCArIHN0cmxlbiArIGJsb2Iuc3RyaW5ncy5zdWZmaXgubGVuZ3RoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5PdXRwdXQuUXVldWUucHVyZ2VFbXB0eUJsb2JzID0gZnVuY3Rpb24gKHBhcmVudCkge1xuICAgIGlmIChcIm9iamVjdFwiICE9PSB0eXBlb2YgcGFyZW50IHx8IFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQuYmxvYnMgfHwgIXBhcmVudC5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBmb3IgKHZhciBpPXBhcmVudC5ibG9icy5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICBDU0wuT3V0cHV0LlF1ZXVlLnB1cmdlRW1wdHlCbG9icyhwYXJlbnQuYmxvYnNbaV0pO1xuICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnQuYmxvYnNbaV07XG4gICAgICAgIGlmICghY2hpbGQgfHwgIWNoaWxkLmJsb2JzIHx8ICFjaGlsZC5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhciBidWYgPSBbXTtcbiAgICAgICAgICAgIHdoaWxlICgocGFyZW50LmJsb2JzLmxlbmd0aC0xKSA+IGkpIHtcbiAgICAgICAgICAgICAgICBidWYucHVzaChwYXJlbnQuYmxvYnMucG9wKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFyZW50LmJsb2JzLnBvcCgpO1xuICAgICAgICAgICAgd2hpbGUgKGJ1Zi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBwYXJlbnQuYmxvYnMucHVzaChidWYucG9wKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5PdXRwdXQuUXVldWUuYWRqdXN0ID0gZnVuY3Rpb24gKHB1bmN0SW5RdW90ZSkge1xuICAgIHZhciBOT19TV0FQX0lOID0ge1xuICAgICAgICBcIjtcIjogdHJ1ZSxcbiAgICAgICAgXCI6XCI6IHRydWVcbiAgICB9XG4gICAgdmFyIE5PX1NXQVBfT1VUID0ge1xuICAgICAgICBcIi5cIjogdHJ1ZSxcbiAgICAgICAgXCIhXCI6IHRydWUsXG4gICAgICAgIFwiP1wiOiB0cnVlXG4gICAgfVxuICAgIHRoaXMudXB3YXJkID0gdXB3YXJkO1xuICAgIHRoaXMubGVmdHdhcmQgPSBsZWZ0d2FyZDtcbiAgICB0aGlzLmRvd253YXJkID0gZG93bndhcmQ7XG4gICAgdGhpcy5maXggPSBmaXg7XG4gICAgdmFyIEx0b1JfTUFQID0ge1xuICAgICAgICBcIiFcIjoge1xuICAgICAgICAgICAgXCIuXCI6IFwiIVwiLFxuICAgICAgICAgICAgXCI/XCI6IFwiIT9cIixcbiAgICAgICAgICAgIFwiOlwiOiBcIiFcIixcbiAgICAgICAgICAgIFwiLFwiOiBcIiEsXCIsXG4gICAgICAgICAgICBcIjtcIjogXCIhO1wiXG4gICAgICAgIH0sXG4gICAgICAgIFwiP1wiOiB7XG4gICAgICAgICAgICBcIiFcIjogXCI/IVwiLFxuICAgICAgICAgICAgXCIuXCI6IFwiP1wiLFxuICAgICAgICAgICAgXCI6XCI6IFwiP1wiLFxuICAgICAgICAgICAgXCIsXCI6IFwiPyxcIixcbiAgICAgICAgICAgIFwiO1wiOiBcIj87XCJcbiAgICAgICAgfSxcbiAgICAgICAgXCIuXCI6IHtcbiAgICAgICAgICAgIFwiIVwiOiBcIi4hXCIsXG4gICAgICAgICAgICBcIj9cIjogXCIuP1wiLFxuICAgICAgICAgICAgXCI6XCI6IFwiLjpcIixcbiAgICAgICAgICAgIFwiLFwiOiBcIi4sXCIsXG4gICAgICAgICAgICBcIjtcIjogXCIuO1wiXG4gICAgICAgIH0sXG4gICAgICAgIFwiOlwiOiB7XG4gICAgICAgICAgICBcIiFcIjogXCIhXCIsXG4gICAgICAgICAgICBcIj9cIjogXCI/XCIsXG4gICAgICAgICAgICBcIi5cIjogXCI6XCIsXG4gICAgICAgICAgICBcIixcIjogXCI6LFwiLFxuICAgICAgICAgICAgXCI7XCI6IFwiOjtcIlxuICAgICAgICB9LFxuICAgICAgICBcIixcIjoge1xuICAgICAgICAgICAgXCIhXCI6IFwiLCFcIixcbiAgICAgICAgICAgIFwiP1wiOiBcIiw/XCIsXG4gICAgICAgICAgICBcIjpcIjogXCIsOlwiLFxuICAgICAgICAgICAgXCIuXCI6IFwiLC5cIixcbiAgICAgICAgICAgIFwiO1wiOiBcIiw7XCJcbiAgICAgICAgfSxcbiAgICAgICAgXCI7XCI6IHtcbiAgICAgICAgICAgIFwiIVwiOiBcIiFcIixcbiAgICAgICAgICAgIFwiP1wiOiBcIj9cIixcbiAgICAgICAgICAgIFwiOlwiOiBcIjtcIixcbiAgICAgICAgICAgIFwiLFwiOiBcIjssXCIsXG4gICAgICAgICAgICBcIi5cIjogXCI7XCJcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgU1dBUF9JTiA9IHt9O1xuICAgIHZhciBTV0FQX09VVCA9IHt9O1xuICAgIHZhciBQVU5DVCA9IHt9O1xuICAgIHZhciBQVU5DVF9PUl9TUEFDRSA9IHt9O1xuICAgIGZvciAodmFyIGtleSBpbiBMdG9SX01BUCkge1xuICAgICAgICBQVU5DVFtrZXldID0gdHJ1ZTtcbiAgICAgICAgUFVOQ1RfT1JfU1BBQ0Vba2V5XSA9IHRydWU7XG4gICAgICAgIGlmICghTk9fU1dBUF9JTltrZXldKSB7XG4gICAgICAgICAgICBTV0FQX0lOW2tleV0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghTk9fU1dBUF9PVVRba2V5XSkge1xuICAgICAgICAgICAgU1dBUF9PVVRba2V5XSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgUFVOQ1RfT1JfU1BBQ0VbXCIgXCJdID0gdHJ1ZTtcbiAgICBQVU5DVF9PUl9TUEFDRVtcIsKgXCJdID0gdHJ1ZTtcbiAgICB2YXIgUnRvTF9NQVAgPSB7fTtcbiAgICBmb3IgKHZhciBrZXkgaW4gTHRvUl9NQVApIHtcbiAgICAgICAgZm9yICh2YXIgc3Via2V5IGluIEx0b1JfTUFQW2tleV0pIHtcbiAgICAgICAgICAgIGlmICghUnRvTF9NQVBbc3Via2V5XSkge1xuICAgICAgICAgICAgICAgIFJ0b0xfTUFQW3N1YmtleV0gPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFJ0b0xfTUFQW3N1YmtleV1ba2V5XSA9IEx0b1JfTUFQW2tleV1bc3Via2V5XTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBibG9iSXNOdW1iZXIoYmxvYikge1xuICAgICAgICByZXR1cm4gKFwibnVtYmVyXCIgPT09IHR5cGVvZiBibG9iLm51bSB8fCAoYmxvYi5ibG9icyAmJiBibG9iLmJsb2JzLmxlbmd0aCA9PT0gMSAmJiBcIm51bWJlclwiID09PSB0eXBlb2YgYmxvYi5ibG9ic1swXS5udW0pKTtcbiAgICB9O1xuICAgIGZ1bmN0aW9uIGJsb2JFbmRzSW5OdW1iZXIoYmxvYikge1xuICAgICAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIGJsb2IubnVtKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWJsb2IuYmxvYnMgfHwgXCJvYmplY3RcIiAhPT0gIHR5cGVvZiBibG9iLmJsb2JzKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmIChibG9iRW5kc0luTnVtYmVyKGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV0pKSByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgZnVuY3Rpb24gYmxvYkhhc0RlY29yYXRpb25zKGJsb2IsaW5jbHVkZVF1b3Rlcykge1xuICAgICAgICB2YXIgcmV0ID0gZmFsc2U7XG4gICAgICAgIHZhciBkZWNvcmxpc3QgPSBbJ0Bmb250LXN0eWxlJywnQGZvbnQtdmFyaWFudCcsJ0Bmb250LXdlaWdodCcsJ0B0ZXh0LWRlY29yYXRpb24nLCdAdmVydGljYWwtYWxpZ24nXTtcbiAgICAgICAgaWYgKGluY2x1ZGVRdW90ZXMpIHtcbiAgICAgICAgICAgIGRlY29ybGlzdC5wdXNoKCdAcXVvdGVzJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJsb2IuZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWJsb2IuZGVjb3JhdGlvbnMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoZGVjb3JsaXN0LmluZGV4T2YoYmxvYi5kZWNvcmF0aW9uc1tpXVswXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICByZXQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuICAgIGZ1bmN0aW9uIGJsb2JIYXNEZXNjZW5kYW50UXVvdGVzKGJsb2IpIHtcbiAgICAgICAgaWYgKGJsb2IuZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWJsb2IuZGVjb3JhdGlvbnMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoYmxvYi5kZWNvcmF0aW9uc1tpXVswXSA9PT0gJ0BxdW90ZXMnICYmIGJsb2IuZGVjb3JhdGlvbnNbaV1bMV0gIT09IFwiZmFsc2VcIikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwib2JqZWN0XCIgIT09IHR5cGVvZiBibG9iLmJsb2JzKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGJsb2JIYXNEZXNjZW5kYW50UXVvdGVzKGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV0pO1xuICAgIH1cbiAgICBmdW5jdGlvbiBibG9iSGFzRGVzY2VuZGFudE1lcmdpbmdQdW5jdHVhdGlvbihwYXJlbnRDaGFyLGJsb2IpIHtcbiAgICAgICAgdmFyIGNoaWxkQ2hhciA9IGJsb2Iuc3RyaW5ncy5zdWZmaXguc2xpY2UoLTEpO1xuICAgICAgICBpZiAoIWNoaWxkQ2hhciAmJiBcInN0cmluZ1wiID09PSB0eXBlb2YgYmxvYi5ibG9icykge1xuICAgICAgICAgICAgY2hpbGRDaGFyID0gYmxvYi5ibG9icy5zbGljZSgtMSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1lcmdlZENoYXJzID0gUnRvTF9NQVBbcGFyZW50Q2hhcl1bY2hpbGRDaGFyXTtcbiAgICAgICAgaWYgKG1lcmdlZENoYXJzICYmIG1lcmdlZENoYXJzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwib2JqZWN0XCIgIT09IHR5cGVvZiBibG9iLmJsb2JzKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmIChibG9iSGFzRGVzY2VuZGFudE1lcmdpbmdQdW5jdHVhdGlvbihwYXJlbnRDaGFyLGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV0pKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmdW5jdGlvbiBtYXRjaExhc3RDaGFyKGJsb2IsIGNocikge1xuICAgICAgICBpZiAoIVBVTkNUW2Nocl0pIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2IuYmxvYnMpIHtcbiAgICAgICAgICAgIGlmIChibG9iLmJsb2JzLnNsaWNlKC0xKSA9PT0gY2hyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBjaGlsZCA9IGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV07XG4gICAgICAgICAgICBpZiAoY2hpbGQpIHtcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGRDaGFyID0gY2hpbGQuc3RyaW5ncy5zdWZmaXguc2xpY2UoLTEpO1xuICAgICAgICAgICAgICAgIGlmICghY2hpbGRDaGFyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaExhc3RDaGFyKGNoaWxkLGNocik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGlsZC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSkgPT0gY2hyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgZnVuY3Rpb24gbWVyZ2VDaGFycyAoRmlyc3QsIGZpcnN0LCBTZWNvbmQsIHNlY29uZCwgbWVyZ2VfcmlnaHQpIHtcbiAgICAgICAgdmFyIEZpcnN0U3RyaW5ncyA9IFwiYmxvYnNcIiA9PT0gZmlyc3QgPyBGaXJzdCA6IEZpcnN0LnN0cmluZ3M7XG4gICAgICAgIHZhciBTZWNvbmRTdHJpbmdzID0gXCJibG9ic1wiID09PSBzZWNvbmQgPyBTZWNvbmQ6IFNlY29uZC5zdHJpbmdzO1xuICAgICAgICB2YXIgZmlyc3RDaGFyID0gRmlyc3RTdHJpbmdzW2ZpcnN0XS5zbGljZSgtMSk7XG4gICAgICAgIHZhciBzZWNvbmRDaGFyID0gU2Vjb25kU3RyaW5nc1tzZWNvbmRdLnNsaWNlKDAsMSk7XG4gICAgICAgIGZ1bmN0aW9uIGN1bGxSaWdodCAoKSB7XG4gICAgICAgICAgICBTZWNvbmRTdHJpbmdzW3NlY29uZF0gPSBTZWNvbmRTdHJpbmdzW3NlY29uZF0uc2xpY2UoMSk7XG4gICAgICAgIH07XG4gICAgICAgIGZ1bmN0aW9uIGN1bGxMZWZ0ICgpIHtcbiAgICAgICAgICAgIEZpcnN0U3RyaW5nc1tmaXJzdF0gPSBGaXJzdFN0cmluZ3NbZmlyc3RdLnNsaWNlKDAsLTEpO1xuICAgICAgICB9O1xuICAgICAgICBmdW5jdGlvbiBhZGRSaWdodCAoY2hyKSB7XG4gICAgICAgICAgICBTZWNvbmRTdHJpbmdzW3NlY29uZF0gPSBjaHIgKyBTZWNvbmRTdHJpbmdzW3NlY29uZF07XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gYWRkTGVmdCAoY2hyKSB7XG4gICAgICAgICAgICBGaXJzdFN0cmluZ3NbZmlyc3RdICs9IGNocjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgY3VsbCA9IG1lcmdlX3JpZ2h0ID8gY3VsbExlZnQgOiBjdWxsUmlnaHQ7XG4gICAgICAgIGZ1bmN0aW9uIG1hdGNoT25SaWdodCAoKSB7XG4gICAgICAgICAgICByZXR1cm4gUnRvTF9NQVBbc2Vjb25kQ2hhcl07XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gbWF0Y2hPbkxlZnQgKCkge1xuICAgICAgICAgICAgcmV0dXJuIEx0b1JfTUFQW2ZpcnN0Q2hhcl07XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1hdGNoID0gbWVyZ2VfcmlnaHQgPyBtYXRjaE9uTGVmdCA6IG1hdGNoT25SaWdodDtcbiAgICAgICAgZnVuY3Rpb24gbWVyZ2VUb1JpZ2h0ICgpIHtcbiAgICAgICAgICAgIHZhciBjaHIgPSBMdG9SX01BUFtmaXJzdENoYXJdW3NlY29uZENoYXJdO1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBjaHIpIHtcbiAgICAgICAgICAgICAgICBjdWxsTGVmdCgpO1xuICAgICAgICAgICAgICAgIGN1bGxSaWdodCgpO1xuICAgICAgICAgICAgICAgIGFkZFJpZ2h0KGNocik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFkZFJpZ2h0KGZpcnN0Q2hhcik7XG4gICAgICAgICAgICAgICAgY3VsbExlZnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiBtZXJnZVRvTGVmdCAoKSB7XG4gICAgICAgICAgICB2YXIgY2hyID0gUnRvTF9NQVBbc2Vjb25kQ2hhcl1bZmlyc3RDaGFyXTtcbiAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgY2hyKSB7XG4gICAgICAgICAgICAgICAgY3VsbExlZnQoKTtcbiAgICAgICAgICAgICAgICBjdWxsUmlnaHQoKTtcbiAgICAgICAgICAgICAgICBhZGRMZWZ0KGNocik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFkZExlZnQoc2Vjb25kQ2hhcik7XG4gICAgICAgICAgICAgICAgY3VsbFJpZ2h0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1lcmdlID0gbWVyZ2VfcmlnaHQgPyBtZXJnZVRvUmlnaHQ6IG1lcmdlVG9MZWZ0O1xuICAgICAgICB2YXIgaXNEdXBsaWNhdGUgPSBmaXJzdENoYXIgPT09IHNlY29uZENoYXI7XG4gICAgICAgIGlmIChpc0R1cGxpY2F0ZSkge1xuICAgICAgICAgICAgY3VsbCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG1hdGNoKCkpIHtcbiAgICAgICAgICAgICAgICBtZXJnZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICBmdW5jdGlvbiB1cHdhcmQgKHBhcmVudCkge1xuICAgICAgICBpZiAocGFyZW50LmJsb2JzICYmIFwic3RyaW5nXCIgPT0gdHlwZW9mIHBhcmVudC5ibG9icykge1xuICAgICAgICAgICAgaWYgKFBVTkNUW3BhcmVudC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpXVxuICAgICAgICAgICAgICAgICYmIHBhcmVudC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpID09PSBwYXJlbnQuYmxvYnMuc2xpY2UoLTEpKSB7XG4gICAgICAgICAgICAgICAgcGFyZW50LnN0cmluZ3Muc3VmZml4ID0gcGFyZW50LnN0cmluZ3Muc3VmZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2UgaWYgKFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQgfHwgXCJvYmplY3RcIiAhPT0gdHlwZW9mIHBhcmVudC5ibG9icyB8fCAhcGFyZW50LmJsb2JzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHZhciBwYXJlbnREZWNvcmF0aW9ucyA9IGJsb2JIYXNEZWNvcmF0aW9ucyhwYXJlbnQsdHJ1ZSk7XG4gICAgICAgIGZvciAodmFyIGk9cGFyZW50LmJsb2JzLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICB2YXIgZW5kRmxhZyA9IGkgPT09IChwYXJlbnQuYmxvYnMubGVuZ3RoLTEpO1xuICAgICAgICAgICAgdGhpcy51cHdhcmQocGFyZW50LmJsb2JzW2ldKTtcbiAgICAgICAgICAgIHZhciBwYXJlbnRTdHJpbmdzID0gcGFyZW50LnN0cmluZ3M7XG4gICAgICAgICAgICB2YXIgY2hpbGRTdHJpbmdzID0gcGFyZW50LmJsb2JzW2ldLnN0cmluZ3M7XG4gICAgICAgICAgICBpZiAoaSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGlmIChcIiBcIiA9PT0gcGFyZW50U3RyaW5ncy5wcmVmaXguc2xpY2UoLTEpICYmIFwiIFwiID09PSBjaGlsZFN0cmluZ3MucHJlZml4LnNsaWNlKDAsIDEpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkU3RyaW5ncy5wcmVmaXggPSBjaGlsZFN0cmluZ3MucHJlZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgY2hpbGRDaGFyID0gY2hpbGRTdHJpbmdzLnByZWZpeC5zbGljZSgwLCAxKTtcbiAgICAgICAgICAgICAgICBpZiAoIXBhcmVudERlY29yYXRpb25zICYmIFBVTkNUX09SX1NQQUNFW2NoaWxkQ2hhcl0gJiYgIXBhcmVudFN0cmluZ3MucHJlZml4KSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmVudFN0cmluZ3MucHJlZml4ICs9IGNoaWxkQ2hhcjtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRTdHJpbmdzLnByZWZpeCA9IGNoaWxkU3RyaW5ncy5wcmVmaXguc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGkgPT09IChwYXJlbnQuYmxvYnMubGVuZ3RoIC0gMSkpIHtcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGRDaGFyID0gY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSk7XG4gICAgICAgICAgICAgICAgaWYgKCFwYXJlbnREZWNvcmF0aW9ucyAmJiBbXCIgXCJdLmluZGV4T2YoY2hpbGRDaGFyKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRTdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpICE9PSBjaGlsZENoYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0cmluZ3Muc3VmZml4ID0gY2hpbGRDaGFyICsgcGFyZW50U3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2hpbGRTdHJpbmdzLnN1ZmZpeCA9IGNoaWxkU3RyaW5ncy5zdWZmaXguc2xpY2UoMCwgLTEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYXJlbnRTdHJpbmdzLmRlbGltaXRlciAmJiBpID4gMCkge1xuICAgICAgICAgICAgICAgIGlmIChQVU5DVF9PUl9TUEFDRVtwYXJlbnRTdHJpbmdzLmRlbGltaXRlci5zbGljZSgtMSldXG4gICAgICAgICAgICAgICAgICAgICYmIHBhcmVudFN0cmluZ3MuZGVsaW1pdGVyLnNsaWNlKC0xKSA9PT0gY2hpbGRTdHJpbmdzLnByZWZpeC5zbGljZSgwLCAxKSkge1xuICAgICAgICAgICAgICAgICAgICBjaGlsZFN0cmluZ3MucHJlZml4ID0gY2hpbGRTdHJpbmdzLnByZWZpeC5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGZ1bmN0aW9uIGxlZnR3YXJkIChwYXJlbnQpIHtcbiAgICAgICAgaWYgKFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQgfHwgXCJvYmplY3RcIiAhPT0gdHlwZW9mIHBhcmVudC5ibG9icyB8fCAhcGFyZW50LmJsb2JzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9cGFyZW50LmJsb2JzLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICB0aGlzLmxlZnR3YXJkKHBhcmVudC5ibG9ic1tpXSk7XG4gICAgICAgICAgICBpZiAoKGkgPCBwYXJlbnQuYmxvYnMubGVuZ3RoIC0xKSAmJiAhcGFyZW50LnN0cmluZ3MuZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmJsb2JzW2ldO1xuICAgICAgICAgICAgICAgIHZhciBjaGlsZENoYXIgPSBjaGlsZC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSk7XG4gICAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBwYXJlbnQuYmxvYnNbaSsxXTtcbiAgICAgICAgICAgICAgICB2YXIgc2libGluZ0NoYXIgPSBzaWJsaW5nLnN0cmluZ3MucHJlZml4LnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgIHZhciBoYXNEZWNvcmF0aW9ucyA9IGJsb2JIYXNEZWNvcmF0aW9ucyhjaGlsZCkgfHwgYmxvYkhhc0RlY29yYXRpb25zKHNpYmxpbmcpO1xuICAgICAgICAgICAgICAgIHZhciBoYXNOdW1iZXIgPSBcIm51bWJlclwiID09PSB0eXBlb2YgY2hpbGRDaGFyIHx8IFwibnVtYmVyXCIgPT09IHR5cGVvZiBzaWJsaW5nQ2hhcjtcbiAgICAgICAgICAgICAgICBpZiAoIWhhc0RlY29yYXRpb25zICYmICFoYXNOdW1iZXIgJiYgUFVOQ1Rbc2libGluZ0NoYXJdICYmICFoYXNOdW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN1ZmZpeEFuZFByZWZpeE1hdGNoID0gc2libGluZ0NoYXIgPT09IGNoaWxkLnN0cmluZ3Muc3VmZml4LnNsaWNlKC0xKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN1ZmZpeEFuZEZpZWxkTWF0Y2ggPSAoIWNoaWxkLnN0cmluZ3Muc3VmZml4ICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiBjaGlsZC5ibG9icyAmJiBjaGlsZC5ibG9icy5zbGljZSgtMSkgPT09IHNpYmxpbmdDaGFyKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdWZmaXhBbmRQcmVmaXhNYXRjaCAmJiAhc3VmZml4QW5kRmllbGRNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VDaGFycyhjaGlsZCwgJ3N1ZmZpeCcsIHNpYmxpbmcsICdwcmVmaXgnKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpYmxpbmcuc3RyaW5ncy5wcmVmaXggPSBzaWJsaW5nLnN0cmluZ3MucHJlZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICBmdW5jdGlvbiBkb3dud2FyZCAocGFyZW50LCB0b3ApIHtcbiAgICAgICAgaWYgKHBhcmVudC5ibG9icyAmJiBcInN0cmluZ1wiID09IHR5cGVvZiBwYXJlbnQuYmxvYnMpIHtcbiAgICAgICAgICAgIGlmIChQVU5DVFtwYXJlbnQuc3RyaW5ncy5zdWZmaXguc2xpY2UoMCwxKV1cbiAgICAgICAgICAgICAgICAmJiBwYXJlbnQuc3RyaW5ncy5zdWZmaXguc2xpY2UoMCwxKSA9PT0gcGFyZW50LmJsb2JzLnNsaWNlKC0xKSkge1xuICAgICAgICAgICAgICAgIHBhcmVudC5zdHJpbmdzLnN1ZmZpeCA9IHBhcmVudC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSBlbHNlIGlmIChcIm9iamVjdFwiICE9PSB0eXBlb2YgcGFyZW50IHx8IFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQuYmxvYnMgfHwgIXBhcmVudC5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcGFyZW50U3RyaW5ncyA9IHBhcmVudC5zdHJpbmdzO1xuICAgICAgICB2YXIgc29tZUNoaWxkcmVuQXJlTnVtYmVycyA9IGZhbHNlO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1wYXJlbnQuYmxvYnMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIGlmIChibG9iSXNOdW1iZXIocGFyZW50LmJsb2JzW2ldKSkge1xuICAgICAgICAgICAgICAgIHNvbWVDaGlsZHJlbkFyZU51bWJlcnMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0cnVlIHx8ICFzb21lQ2hpbGRyZW5BcmVOdW1iZXJzKSB7XG4gICAgICAgICAgICBpZiAocGFyZW50U3RyaW5ncy5kZWxpbWl0ZXIgJiYgUFVOQ1RbcGFyZW50U3RyaW5ncy5kZWxpbWl0ZXIuc2xpY2UoMCwgMSldKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRlbGltQ2hhciA9IHBhcmVudFN0cmluZ3MuZGVsaW1pdGVyLnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9cGFyZW50LmJsb2JzLmxlbmd0aC0yO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZFN0cmluZ3MgPSBwYXJlbnQuYmxvYnNbaV0uc3RyaW5ncztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkU3RyaW5ncy5zdWZmaXguc2xpY2UoLTEpICE9PSBkZWxpbUNoYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU3RyaW5ncy5zdWZmaXggKz0gZGVsaW1DaGFyO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBhcmVudFN0cmluZ3MuZGVsaW1pdGVyID0gcGFyZW50U3RyaW5ncy5kZWxpbWl0ZXIuc2xpY2UoMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHBhcmVudERlY29yYXRpb25zID0gYmxvYkhhc0RlY29yYXRpb25zKHBhcmVudCwgdHJ1ZSk7XG4gICAgICAgIHZhciBwYXJlbnRJc051bWJlciA9IGJsb2JJc051bWJlcihwYXJlbnQpO1xuICAgICAgICBmb3IgKHZhciBpPXBhcmVudC5ibG9icy5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmJsb2JzW2ldO1xuICAgICAgICAgICAgdmFyIGNoaWxkU3RyaW5ncyA9IHBhcmVudC5ibG9ic1tpXS5zdHJpbmdzO1xuICAgICAgICAgICAgdmFyIGNoaWxkRGVjb3JhdGlvbnMgPSBibG9iSGFzRGVjb3JhdGlvbnMoY2hpbGQsIHRydWUpO1xuICAgICAgICAgICAgdmFyIGNoaWxkSXNOdW1iZXIgPSBibG9iSXNOdW1iZXIoY2hpbGQpO1xuICAgICAgICAgICAgaWYgKGkgPT09IChwYXJlbnQuYmxvYnMubGVuZ3RoIC0gMSkpIHtcbiAgICAgICAgICAgICAgICBpZiAodHJ1ZSB8fCAhc29tZUNoaWxkcmVuQXJlTnVtYmVycykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Q2hhciA9IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgYWxsb3dNaWdyYXRpb24gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFBVTkNUW3BhcmVudENoYXJdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd01pZ3JhdGlvbiA9IGJsb2JIYXNEZXNjZW5kYW50TWVyZ2luZ1B1bmN0dWF0aW9uKHBhcmVudENoYXIsY2hpbGQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhbGxvd01pZ3JhdGlvbiAmJiBwdW5jdEluUXVvdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd01pZ3JhdGlvbiA9IGJsb2JIYXNEZXNjZW5kYW50UXVvdGVzKGNoaWxkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoYWxsb3dNaWdyYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChQVU5DVFtwYXJlbnRDaGFyXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYmxvYkVuZHNJbk51bWJlcihjaGlsZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBjaGlsZC5ibG9icykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VDaGFycyhjaGlsZCwgJ2Jsb2JzJywgcGFyZW50LCAnc3VmZml4Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZUNoYXJzKGNoaWxkLCAnc3VmZml4JywgcGFyZW50LCAnc3VmZml4Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSkgPT09IFwiLlwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFN0cmluZ3Muc3VmZml4ICs9IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdHJpbmdzLnN1ZmZpeCA9IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFN0cmluZ3Muc3VmZml4LnNsaWNlKC0xKSA9PT0gXCLCoFwiICYmIHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSkgPT09IFwiIFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdHJpbmdzLnN1ZmZpeCA9IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChQVU5DVF9PUl9TUEFDRVtjaGlsZFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGNoaWxkLmJsb2JzICYmIGNoaWxkLmJsb2JzLnNsaWNlKC0xKSA9PT0gY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTdHJpbmdzLnN1ZmZpeCA9IGNoaWxkU3RyaW5ncy5zdWZmaXguc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSkgPT09IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsIDEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RyaW5ncy5zdWZmaXggPSBwYXJlbnRTdHJpbmdzLnN1ZmZpeC5zbGljZSgwLCAtMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG1hdGNoTGFzdENoYXIocGFyZW50LHBhcmVudC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpKSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJlbnQuc3RyaW5ncy5zdWZmaXggPSBwYXJlbnQuc3RyaW5ncy5zdWZmaXguc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJlbnRTdHJpbmdzLmRlbGltaXRlcikge1xuICAgICAgICAgICAgICAgIGlmIChQVU5DVF9PUl9TUEFDRVtwYXJlbnRTdHJpbmdzLmRlbGltaXRlci5zbGljZSgwLDEpXVxuICAgICAgICAgICAgICAgICAgICAmJiBwYXJlbnRTdHJpbmdzLmRlbGltaXRlci5zbGljZSgwLCAxKSA9PT0gY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50LmJsb2JzW2ldLnN0cmluZ3Muc3VmZml4ID0gcGFyZW50LmJsb2JzW2ldLnN0cmluZ3Muc3VmZml4LnNsaWNlKDAsIC0xKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBzaWJsaW5nU3RyaW5ncyA9IHBhcmVudC5ibG9ic1tpKzFdLnN0cmluZ3M7XG4gICAgICAgICAgICAgICAgaWYgKCFibG9iSXNOdW1iZXIoY2hpbGQpIFxuICAgICAgICAgICAgICAgICAgICAmJiAhY2hpbGREZWNvcmF0aW9uc1xuICAgICAgICAgICAgICAgICAgICAmJiBQVU5DVF9PUl9TUEFDRVtjaGlsZFN0cmluZ3Muc3VmZml4LnNsaWNlKC0xKV1cbiAgICAgICAgICAgICAgICAgICAgJiYgY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSkgPT09IHNpYmxpbmdTdHJpbmdzLnByZWZpeC5zbGljZSgwLCAxKSkge1xuICAgICAgICAgICAgICAgICAgICBzaWJsaW5nU3RyaW5ncy5wcmVmaXggPSBzaWJsaW5nU3RyaW5ncy5wcmVmaXguc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFjaGlsZElzTnVtYmVyICYmICFjaGlsZERlY29yYXRpb25zICYmIFBVTkNUW2NoaWxkU3RyaW5ncy5zdWZmaXguc2xpY2UoMCwxKV1cbiAgICAgICAgICAgICAgICAmJiBcInN0cmluZ1wiID09PSB0eXBlb2YgY2hpbGQuYmxvYnMpIHtcbiAgICAgICAgICAgICAgICBtZXJnZUNoYXJzKGNoaWxkLCAnYmxvYnMnLCBjaGlsZCwgJ3N1ZmZpeCcpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmRvd253YXJkKHBhcmVudC5ibG9ic1tpXSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGZ1bmN0aW9uIHN3YXBUb1RoZUxlZnQgKGNoaWxkKSB7XG4gICAgICAgIHZhciBjaGlsZENoYXIgPSBjaGlsZC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpO1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGNoaWxkLmJsb2JzKSB7XG4gICAgICAgICAgICB3aGlsZSAoU1dBUF9JTltjaGlsZENoYXJdKSB7XG4gICAgICAgICAgICAgICAgbWVyZ2VDaGFycyhjaGlsZCwgJ2Jsb2JzJywgY2hpbGQsICdzdWZmaXgnKTtcbiAgICAgICAgICAgICAgICBjaGlsZENoYXIgPSBjaGlsZC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB3aGlsZSAoU1dBUF9JTltjaGlsZENoYXJdKSB7XG4gICAgICAgICAgICAgICAgbWVyZ2VDaGFycyhjaGlsZC5ibG9ic1tjaGlsZC5ibG9icy5sZW5ndGgtMV0sICdzdWZmaXgnLCBjaGlsZCwgJ3N1ZmZpeCcpO1xuICAgICAgICAgICAgICAgIGNoaWxkQ2hhciA9IGNoaWxkLnN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gc3dhcFRvVGhlUmlnaHQgKGNoaWxkKSB7XG4gICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgY2hpbGQuYmxvYnMpIHtcbiAgICAgICAgICAgIHZhciBjaGlsZENoYXIgPSBjaGlsZC5ibG9icy5zbGljZSgtMSk7XG4gICAgICAgICAgICB3aGlsZSAoU1dBUF9PVVRbY2hpbGRDaGFyXSkge1xuICAgICAgICAgICAgICAgIG1lcmdlQ2hhcnMoY2hpbGQsICdibG9icycsIGNoaWxkLCAnc3VmZml4JywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgY2hpbGRDaGFyID0gY2hpbGQuYmxvYnMuc2xpY2UoLTEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIGNoaWxkQ2hhciA9IGNoaWxkLmJsb2JzW2NoaWxkLmJsb2JzLmxlbmd0aC0xXS5zdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSk7XG4gICAgICAgICAgICB3aGlsZSAoU1dBUF9PVVRbY2hpbGRDaGFyXSkge1xuICAgICAgICAgICAgICAgIG1lcmdlQ2hhcnMoY2hpbGQuYmxvYnNbY2hpbGQuYmxvYnMubGVuZ3RoLTFdLCAnc3VmZml4JywgY2hpbGQsICdzdWZmaXgnLCB0cnVlKTtcbiAgICAgICAgICAgICAgICBjaGlsZENoYXIgPSBjaGlsZC5ibG9ic1tjaGlsZC5ibG9icy5sZW5ndGgtMV0uc3RyaW5ncy5zdWZmaXguc2xpY2UoLTEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIGZpeCAocGFyZW50KSB7XG4gICAgICAgIGlmIChcIm9iamVjdFwiICE9PSB0eXBlb2YgcGFyZW50IHx8IFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQuYmxvYnMgfHwgIXBhcmVudC5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbGFzdENoYXI7XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXBhcmVudC5ibG9icy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmJsb2JzW2ldO1xuICAgICAgICAgICAgdmFyIHF1b3RlU3dhcCA9IGZhbHNlO1xuICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49Y2hpbGQuZGVjb3JhdGlvbnMubGVuZ3RoO2o8amxlbjtqKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgZGVjb3JhdGlvbiA9IGNoaWxkLmRlY29yYXRpb25zW2pdO1xuICAgICAgICAgICAgICAgIGlmIChkZWNvcmF0aW9uWzBdID09PSBcIkBxdW90ZXNcIiAmJiBkZWNvcmF0aW9uWzFdICE9PSBcImZhbHNlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVvdGVTd2FwID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocXVvdGVTd2FwKSB7XG4gICAgICAgICAgICAgICAgaWYgKHB1bmN0SW5RdW90ZSkge1xuICAgICAgICAgICAgICAgICAgICBzd2FwVG9UaGVMZWZ0KGNoaWxkKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzd2FwVG9UaGVSaWdodChjaGlsZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGFzdENoYXIgPSB0aGlzLmZpeChwYXJlbnQuYmxvYnNbaV0pO1xuICAgICAgICAgICAgaWYgKGNoaWxkLmJsb2JzICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiBjaGlsZC5ibG9icykge1xuICAgICAgICAgICAgICAgIGxhc3RDaGFyID0gY2hpbGQuYmxvYnMuc2xpY2UoLTEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsYXN0Q2hhcjtcbiAgICB9O1xufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuRW5naW5lLk9wdCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmhhc19kaXNhbWJpZ3VhdGUgPSBmYWxzZTtcbiAgICB0aGlzLm1vZGUgPSBcImh0bWxcIjtcbiAgICB0aGlzLmRhdGVzID0ge307XG4gICAgdGhpcy5qdXJpc2RpY3Rpb25zX3NlZW4gPSB7fTtcbiAgICB0aGlzLnN1cHByZXNzZWRKdXJpc2RpY3Rpb25zID0ge307XG4gICAgdGhpcy5pbmhlcml0ZWRBdHRyaWJ1dGVzID0ge307XG4gICAgdGhpc1tcImxvY2FsZS1zb3J0XCJdID0gW107XG4gICAgdGhpc1tcImxvY2FsZS10cmFuc2xpdFwiXSA9IFtdO1xuICAgIHRoaXNbXCJsb2NhbGUtdHJhbnNsYXRcIl0gPSBbXTtcbiAgICB0aGlzLmNpdGVBZmZpeGVzID0ge1xuICAgICAgICBwZXJzb25zOntcbiAgICAgICAgICAgIFwibG9jYWxlLW9yaWdcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBcImxvY2FsZS10cmFuc2xpdFwiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwibG9jYWxlLXRyYW5zbGF0XCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGluc3RpdHV0aW9uczp7XG4gICAgICAgICAgICBcImxvY2FsZS1vcmlnXCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsaXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBcImxvY2FsZS10cmFuc2xhdFwiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB0aXRsZXM6e1xuICAgICAgICAgICAgXCJsb2NhbGUtb3JpZ1wiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwibG9jYWxlLXRyYW5zbGl0XCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsYXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgam91cm5hbHM6e1xuICAgICAgICAgICAgXCJsb2NhbGUtb3JpZ1wiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwibG9jYWxlLXRyYW5zbGl0XCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsYXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgcHVibGlzaGVyczp7XG4gICAgICAgICAgICBcImxvY2FsZS1vcmlnXCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsaXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBcImxvY2FsZS10cmFuc2xhdFwiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBwbGFjZXM6e1xuICAgICAgICAgICAgXCJsb2NhbGUtb3JpZ1wiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwibG9jYWxlLXRyYW5zbGl0XCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsYXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgdGhpc1tcImRlZmF1bHQtbG9jYWxlXCJdID0gW107XG4gICAgdGhpcy51cGRhdGVfbW9kZSA9IENTTC5OT05FO1xuICAgIHRoaXMuYmliX21vZGUgPSBDU0wuTk9ORTtcbiAgICB0aGlzLnNvcnRfY2l0YXRpb25zID0gZmFsc2U7XG4gICAgdGhpc1tcImV0LWFsLW1pblwiXSA9IDA7XG4gICAgdGhpc1tcImV0LWFsLXVzZS1maXJzdFwiXSA9IDE7XG4gICAgdGhpc1tcImV0LWFsLXVzZS1sYXN0XCJdID0gZmFsc2U7XG4gICAgdGhpc1tcImV0LWFsLXN1YnNlcXVlbnQtbWluXCJdID0gZmFsc2U7XG4gICAgdGhpc1tcImV0LWFsLXN1YnNlcXVlbnQtdXNlLWZpcnN0XCJdID0gZmFsc2U7XG4gICAgdGhpc1tcImRlbW90ZS1ub24tZHJvcHBpbmctcGFydGljbGVcIl0gPSBcImRpc3BsYXktYW5kLXNvcnRcIjtcbiAgICB0aGlzW1wicGFyc2UtbmFtZXNcIl0gPSB0cnVlO1xuICAgIHRoaXMuY2l0YXRpb25fbnVtYmVyX3NsdWcgPSBmYWxzZTtcbiAgICB0aGlzLnRyaWdyYXBoID0gXCJBYWFhMDA6QWFBYTAwOkFhQUEwMDpBQUFBMDBcIjtcbiAgICB0aGlzLm5vZGVuYW1lcyA9IFtdO1xuICAgIHRoaXMuZ2VuZGVyID0ge307XG4gICAgdGhpc1snY2l0ZS1sYW5nLXByZWZzJ10gPSB7XG4gICAgICAgIHBlcnNvbnM6WydvcmlnJ10sXG4gICAgICAgIGluc3RpdHV0aW9uczpbJ29yaWcnXSxcbiAgICAgICAgdGl0bGVzOlsnb3JpZyddLFxuICAgICAgICBqb3VybmFsczpbJ29yaWcnXSxcbiAgICAgICAgcHVibGlzaGVyczpbJ29yaWcnXSxcbiAgICAgICAgcGxhY2VzOlsnb3JpZyddLFxuICAgICAgICBudW1iZXI6WydvcmlnJ11cbiAgICB9O1xuICAgIHRoaXMuaGFzX2xheW91dF9sb2NhbGUgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMgPSB7fTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZmllbGRfaGFjayA9IHRydWU7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmFsbG93X2ZpZWxkX2hhY2tfZGF0ZV9vdmVycmlkZSA9IHRydWU7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmxvY2F0b3JfZGF0ZV9hbmRfcmV2aXNpb24gPSB0cnVlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5sb2NhdG9yX3BhcnNpbmdfZm9yX3BsdXJhbHMgPSB0cnVlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5sb2NhdG9yX2xhYmVsX3BhcnNlID0gdHJ1ZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMucmF3X2RhdGVfcGFyc2luZyA9IHRydWU7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmNsZWFuX3VwX2NzbF9mbGF3cyA9IHRydWU7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmZsaXBfcGFyZW50aGVzZXNfdG9fYnJhY2VzID0gdHJ1ZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuanVyaXNkaWN0aW9uX3N1YmZpZWxkID0gdHJ1ZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3RhdGljX3N0YXR1dGVfbG9jYXRvciA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5jc2xfcmV2ZXJzZV9sb29rdXBfc3VwcG9ydCA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5jbG9iYmVyX2xvY2F0b3JfaWZfbm9fc3RhdHV0ZV9zZWN0aW9uID0gZmFsc2U7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLndyYXBfdXJsX2FuZF9kb2kgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuYWxsb3dfZm9yY2VfbG93ZXJjYXNlID0gZmFsc2U7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmhhbmRsZV9wYXJhbGxlbF9hcnRpY2xlcyA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy50aGluX25vbl9icmVha2luZ19zcGFjZV9odG1sX2hhY2sgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuYXBwbHlfY2l0YXRpb25fd3JhcHBlciA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5tYWluX3RpdGxlX2Zyb21fc2hvcnRfdGl0bGUgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMudXBwZXJjYXNlX3N1YnRpdGxlcyA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ub3JtYWxpemVfbGFuZ19rZXlzX3RvX2xvd2VyY2FzZSA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5zdHJpY3RfdGV4dF9jYXNlX2xvY2FsZXMgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMucnRsX3N1cHBvcnQgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZXhwZWN0X2FuZF9zeW1ib2xfZm9ybSA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5yZXF1aXJlX2V4cGxpY2l0X2xlZ2FsX2Nhc2VfdGl0bGVfc2hvcnQgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3Bvb2ZfaW5zdGl0dXRpb25hbF9hZmZpbGlhdGlvbnMgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZm9yY2VfanVyaXNkaWN0aW9uID0gZmFsc2U7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLnBhcnNlX25hbWVzID0gdHJ1ZTtcbn07XG5DU0wuRW5naW5lLlRtcCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLm5hbWVzX21heCA9IG5ldyBDU0wuU3RhY2soKTtcbiAgICB0aGlzLm5hbWVzX2Jhc2UgPSBuZXcgQ1NMLlN0YWNrKCk7XG4gICAgdGhpcy5naXZlbnNfYmFzZSA9IG5ldyBDU0wuU3RhY2soKTtcbiAgICB0aGlzLnZhbHVlID0gW107XG4gICAgdGhpcy5uYW1lcGFydF9kZWNvcmF0aW9ucyA9IHt9O1xuICAgIHRoaXMubmFtZXBhcnRfdHlwZSA9IGZhbHNlO1xuICAgIHRoaXMuYXJlYSA9IFwiY2l0YXRpb25cIjtcbiAgICB0aGlzLnJvb3QgPSBcImNpdGF0aW9uXCI7XG4gICAgdGhpcy5leHRlbnNpb24gPSBcIlwiO1xuICAgIHRoaXMuY2FuX3N1YnN0aXR1dGUgPSBuZXcgQ1NMLlN0YWNrKDAsIENTTC5MSVRFUkFMKTtcbiAgICB0aGlzLmVsZW1lbnRfcmVuZGVyZWRfb2sgPSBmYWxzZTtcbiAgICB0aGlzLmVsZW1lbnRfdHJhY2UgPSBuZXcgQ1NMLlN0YWNrKFwic3R5bGVcIik7XG4gICAgdGhpcy5uYW1lc2V0X2NvdW50ZXIgPSAwO1xuICAgIHRoaXMuZ3JvdXBfY29udGV4dCA9IG5ldyBDU0wuU3RhY2soe1xuICAgICAgICB0ZXJtX2ludGVuZGVkOiBmYWxzZSxcbiAgICAgICAgdmFyaWFibGVfYXR0ZW1wdDogZmFsc2UsXG4gICAgICAgIHZhcmlhYmxlX3N1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBvdXRwdXRfdGlwOiB1bmRlZmluZWQsXG4gICAgICAgIGxhYmVsX2Zvcm06ICB1bmRlZmluZWQsXG4gICAgICAgIHBhcmFsbGVsX2NvbmRpdGlvbnM6IHVuZGVmaW5lZCxcbiAgICAgICAgY29uZGl0aW9uOiBmYWxzZSxcbiAgICAgICAgZm9yY2Vfc3VwcHJlc3M6IGZhbHNlLFxuICAgICAgICBkb25lX3ZhcnM6IFtdXG4gICAgfSk7XG4gICAgdGhpcy50ZXJtX3ByZWRlY2Vzc29yID0gZmFsc2U7XG4gICAgdGhpcy5pbl9jaXRlX3ByZWRlY2Vzc29yID0gZmFsc2U7XG4gICAgdGhpcy5qdW1wID0gbmV3IENTTC5TdGFjaygwLCBDU0wuTElURVJBTCk7XG4gICAgdGhpcy5kZWNvcmF0aW9ucyA9IG5ldyBDU0wuU3RhY2soKTtcbiAgICB0aGlzLnRva2Vuc3RvcmVfc3RhY2sgPSBuZXcgQ1NMLlN0YWNrKCk7XG4gICAgdGhpcy5sYXN0X3N1ZmZpeF91c2VkID0gXCJcIjtcbiAgICB0aGlzLmxhc3RfbmFtZXNfdXNlZCA9IFtdO1xuICAgIHRoaXMubGFzdF95ZWFyc191c2VkID0gW107XG4gICAgdGhpcy55ZWFyc191c2VkID0gW107XG4gICAgdGhpcy5uYW1lc191c2VkID0gW107XG4gICAgdGhpcy50YWludGVkSXRlbUlEcyA9IHt9O1xuICAgIHRoaXMudGFpbnRlZENpdGF0aW9uSURzID0ge307XG4gICAgdGhpcy5pbml0aWFsaXplX3dpdGggPSBuZXcgQ1NMLlN0YWNrKCk7XG4gICAgdGhpcy5kaXNhbWJpZ19yZXF1ZXN0ID0gZmFsc2U7XG4gICAgdGhpc1tcIm5hbWUtYXMtc29ydC1vcmRlclwiXSA9IGZhbHNlO1xuICAgIHRoaXMuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSBmYWxzZTtcbiAgICB0aGlzLmRpc2FtYmlnX3NldHRpbmdzID0gbmV3IENTTC5BbWJpZ0NvbmZpZygpO1xuICAgIHRoaXMuYmliX3NvcnRfa2V5cyA9IFtdO1xuICAgIHRoaXMucHJlZml4ID0gbmV3IENTTC5TdGFjayhcIlwiLCBDU0wuTElURVJBTCk7XG4gICAgdGhpcy5zdWZmaXggPSBuZXcgQ1NMLlN0YWNrKFwiXCIsIENTTC5MSVRFUkFMKTtcbiAgICB0aGlzLmRlbGltaXRlciA9IG5ldyBDU0wuU3RhY2soXCJcIiwgQ1NMLkxJVEVSQUwpO1xuICAgIHRoaXMuY2l0ZV9sb2NhbGVzID0gW107XG4gICAgdGhpcy5jaXRlX2FmZml4ZXMgPSB7XG4gICAgICAgIGNpdGF0aW9uOiBmYWxzZSwgXG4gICAgICAgIGJpYmxpb2dyYXBoeTogZmFsc2UsXG4gICAgICAgIGNpdGF0aW9uX3NvcnQ6IGZhbHNlLCBcbiAgICAgICAgYmlibGlvZ3JhcGh5X3NvcnQ6IGZhbHNlXG4gICAgfTtcbiAgICB0aGlzLnN0cmlwX3BlcmlvZHMgPSAwO1xuICAgIHRoaXMuc2hhZG93X251bWJlcnMgPSB7fTtcbiAgICB0aGlzLmF1dGhvcml0eV9zdG9wX2xhc3QgPSAwO1xuICAgIHRoaXMubG9hZGVkSXRlbUlEcyA9IHt9O1xufTtcbkNTTC5FbmdpbmUuRnVuID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdGhpcy5tYXRjaCA9IG5ldyBDU0wuVXRpbC5NYXRjaDtcbiAgICB0aGlzLnN1ZmZpeGF0b3IgPSBuZXcgQ1NMLlV0aWwuU3VmZml4YXRvcihDU0wuU1VGRklYX0NIQVJTKTtcbiAgICB0aGlzLnJvbWFuaXplciA9IG5ldyBDU0wuVXRpbC5Sb21hbml6ZXIoKTtcbiAgICB0aGlzLm9yZGluYWxpemVyID0gbmV3IENTTC5VdGlsLk9yZGluYWxpemVyKHN0YXRlKTtcbiAgICB0aGlzLmxvbmdfb3JkaW5hbGl6ZXIgPSBuZXcgQ1NMLlV0aWwuTG9uZ09yZGluYWxpemVyKCk7XG59O1xuQ1NMLkVuZ2luZS5CdWlsZCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzW1wiYWx0ZXJuYXRlLXRlcm1cIl0gPSBmYWxzZTtcbiAgICB0aGlzLmluX2JpYmxpb2dyYXBoeSA9IGZhbHNlO1xuICAgIHRoaXMuaW5fc3R5bGUgPSBmYWxzZTtcbiAgICB0aGlzLnNraXAgPSBmYWxzZTtcbiAgICB0aGlzLnBvc3Rwb25lZF9tYWNybyA9IGZhbHNlO1xuICAgIHRoaXMubGF5b3V0X2ZsYWcgPSBmYWxzZTtcbiAgICB0aGlzLm5hbWUgPSBmYWxzZTtcbiAgICB0aGlzLmZvcm0gPSBmYWxzZTtcbiAgICB0aGlzLnRlcm0gPSBmYWxzZTtcbiAgICB0aGlzLm1hY3JvID0ge307XG4gICAgdGhpcy5tYWNyb19zdGFjayA9IFtdO1xuICAgIHRoaXMudGV4dCA9IGZhbHNlO1xuICAgIHRoaXMubGFuZyA9IGZhbHNlO1xuICAgIHRoaXMuYXJlYSA9IFwiY2l0YXRpb25cIjtcbiAgICB0aGlzLnJvb3QgPSBcImNpdGF0aW9uXCI7XG4gICAgdGhpcy5leHRlbnNpb24gPSBcIlwiO1xuICAgIHRoaXMuc3Vic3RpdHV0ZV9sZXZlbCA9IG5ldyBDU0wuU3RhY2soMCwgQ1NMLkxJVEVSQUwpO1xuICAgIHRoaXMubmFtZXNfbGV2ZWwgPSAwO1xuICAgIHRoaXMucmVuZGVyX25lc3RpbmdfbGV2ZWwgPSAwO1xuICAgIHRoaXMucmVuZGVyX3NlZW4gPSBmYWxzZTtcbn07XG5DU0wuRW5naW5lLkNvbmZpZ3VyZSA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmZhaWwgPSBbXTtcbiAgICB0aGlzLnN1Y2NlZWQgPSBbXTtcbn07XG5DU0wuRW5naW5lLkNpdGF0aW9uID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdGhpcy5vcHQgPSB7XG4gICAgICAgIGluaGVyaXRlZEF0dHJpYnV0ZXM6IHt9XG4gICAgfTtcbiAgICB0aGlzLnRva2VucyA9IFtdO1xuICAgIHRoaXMuc3J0ID0gbmV3IENTTC5SZWdpc3RyeS5Db21wYXJpZmllcihzdGF0ZSwgXCJjaXRhdGlvbl9zb3J0XCIpO1xuICAgIHRoaXMub3B0LmNvbGxhcHNlID0gW107XG4gICAgdGhpcy5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLW5hbWVzXCJdID0gZmFsc2U7XG4gICAgdGhpcy5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiXSA9IGZhbHNlO1xuICAgIHRoaXMub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC15ZWFyLXN1ZmZpeFwiXSA9IGZhbHNlO1xuICAgIHRoaXMub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0gPSBcImJ5LWNpdGVcIjtcbiAgICB0aGlzLm9wdFtcIm5lYXItbm90ZS1kaXN0YW5jZVwiXSA9IDU7XG4gICAgdGhpcy5vcHQudG9wZGVjb3IgPSBbXTtcbiAgICB0aGlzLm9wdC5sYXlvdXRfZGVjb3JhdGlvbnMgPSBbXTtcbiAgICB0aGlzLm9wdC5sYXlvdXRfcHJlZml4ID0gXCJcIjtcbiAgICB0aGlzLm9wdC5sYXlvdXRfc3VmZml4ID0gXCJcIjtcbiAgICB0aGlzLm9wdC5sYXlvdXRfZGVsaW1pdGVyID0gXCJcIjtcbiAgICB0aGlzLm9wdC5zb3J0X2xvY2FsZXMgPSBbXTtcbiAgICB0aGlzLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzID0gMDtcbiAgICB0aGlzLnJvb3QgPSBcImNpdGF0aW9uXCI7XG59O1xuQ1NMLkVuZ2luZS5CaWJsaW9ncmFwaHkgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5vcHQgPSB7XG4gICAgICAgIGluaGVyaXRlZEF0dHJpYnV0ZXM6IHt9XG4gICAgfTtcbiAgICB0aGlzLnRva2VucyA9IFtdO1xuICAgIHRoaXMub3B0LmNvbGxhcHNlID0gW107XG4gICAgdGhpcy5vcHQudG9wZGVjb3IgPSBbXTtcbiAgICB0aGlzLm9wdC5sYXlvdXRfZGVjb3JhdGlvbnMgPSBbXTtcbiAgICB0aGlzLm9wdC5sYXlvdXRfcHJlZml4ID0gXCJcIjtcbiAgICB0aGlzLm9wdC5sYXlvdXRfc3VmZml4ID0gXCJcIjtcbiAgICB0aGlzLm9wdC5sYXlvdXRfZGVsaW1pdGVyID0gXCJcIjtcbiAgICB0aGlzLm9wdFtcImxpbmUtc3BhY2luZ1wiXSA9IDE7XG4gICAgdGhpcy5vcHRbXCJlbnRyeS1zcGFjaW5nXCJdID0gMTtcbiAgICB0aGlzLm9wdC5zb3J0X2xvY2FsZXMgPSBbXTtcbiAgICB0aGlzLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzID0gMDtcbiAgICB0aGlzLnJvb3QgPSBcImJpYmxpb2dyYXBoeVwiO1xufTtcbkNTTC5FbmdpbmUuQmlibGlvZ3JhcGh5U29ydCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnRva2VucyA9IFtdO1xuICAgIHRoaXMub3B0ID0ge307XG4gICAgdGhpcy5vcHQuc29ydF9kaXJlY3Rpb25zID0gW107XG4gICAgdGhpcy5rZXlzID0gW107XG4gICAgdGhpcy5vcHQudG9wZGVjb3IgPSBbXTtcbiAgICB0aGlzLnJvb3QgPSBcImJpYmxpb2dyYXBoeVwiO1xufTtcbkNTTC5FbmdpbmUuQ2l0YXRpb25Tb3J0ID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMudG9rZW5zID0gW107XG4gICAgdGhpcy5vcHQgPSB7fTtcbiAgICB0aGlzLm9wdC5zb3J0X2RpcmVjdGlvbnMgPSBbXTtcbiAgICB0aGlzLmtleXMgPSBbXTtcbiAgICB0aGlzLm9wdC50b3BkZWNvciA9IFtdO1xuICAgIHRoaXMucm9vdCA9IFwiY2l0YXRpb25cIjtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnByZXZpZXdDaXRhdGlvbkNsdXN0ZXIgPSBmdW5jdGlvbiAoY2l0YXRpb24sIGNpdGF0aW9uc1ByZSwgY2l0YXRpb25zUG9zdCwgbmV3TW9kZSkge1xuICAgIHZhciBvbGRNb2RlID0gdGhpcy5vcHQubW9kZTtcbiAgICB0aGlzLnNldE91dHB1dEZvcm1hdChuZXdNb2RlKTtcbiAgICB2YXIgcmV0ID0gdGhpcy5wcm9jZXNzQ2l0YXRpb25DbHVzdGVyKGNpdGF0aW9uLCBjaXRhdGlvbnNQcmUsIGNpdGF0aW9uc1Bvc3QsIENTTC5QUkVWSUVXKTtcbiAgICB0aGlzLnNldE91dHB1dEZvcm1hdChvbGRNb2RlKTtcbiAgICByZXR1cm4gcmV0WzFdO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmFwcGVuZENpdGF0aW9uQ2x1c3RlciA9IGZ1bmN0aW9uIChjaXRhdGlvbikge1xuICAgIHZhciBjaXRhdGlvbnNQcmUgPSBbXTtcbiAgICB2YXIgbGVuID0gdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SW5kZXgubGVuZ3RoO1xuICAgIGZvciAodmFyIHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgdmFyIGMgPSB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJbmRleFtwb3NdO1xuICAgICAgICBjaXRhdGlvbnNQcmUucHVzaChbXCJcIiArIGMuY2l0YXRpb25JRCwgYy5wcm9wZXJ0aWVzLm5vdGVJbmRleF0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzQ2l0YXRpb25DbHVzdGVyKGNpdGF0aW9uLCBjaXRhdGlvbnNQcmUsIFtdKVsxXTtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5wcm9jZXNzQ2l0YXRpb25DbHVzdGVyID0gZnVuY3Rpb24gKGNpdGF0aW9uLCBjaXRhdGlvbnNQcmUsIGNpdGF0aW9uc1Bvc3QsIGZsYWcpIHtcbiAgICB2YXIgYywgaSwgaWxlbiwgaiwgamxlbiwgaywga2xlbiwgbiwgbmxlbiwga2V5LCBJdGVtLCBpdGVtLCBub3RlQ2l0YXRpb25zLCB0ZXh0Q2l0YXRpb25zLCBtLCBjaXRhdGlvbnNJbk5vdGU7XG4gICAgdGhpcy5kZWJ1ZyA9IGZhbHNlO1xuICAgIHRoaXMudG1wLmxvYWRlZEl0ZW1JRHMgPSB7fTtcbiAgICB0aGlzLnRtcC5jaXRhdGlvbl9lcnJvcnMgPSBbXTtcbiAgICB2YXIgcmV0dXJuX2RhdGEgPSB7XCJiaWJjaGFuZ2VcIjogZmFsc2V9O1xuICAgIHRoaXMuc2V0Q2l0YXRpb25JZChjaXRhdGlvbik7XG4gICAgdmFyIG9sZENpdGF0aW9uTGlzdDtcbiAgICB2YXIgb2xkSXRlbUxpc3Q7XG4gICAgdmFyIG9sZEFtYmlncztcbiAgICBpZiAoZmxhZyA9PT0gQ1NMLlBSRVZJRVcpIHtcbiAgICAgICAgb2xkQ2l0YXRpb25MaXN0ID0gdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SW5kZXguc2xpY2UoKTtcbiAgICAgICAgb2xkSXRlbUxpc3QgPSB0aGlzLnJlZ2lzdHJ5LnJlZmxpc3Quc2xpY2UoKTtcbiAgICAgICAgdmFyIG5ld0NpdGF0aW9uTGlzdCA9IGNpdGF0aW9uc1ByZS5jb25jYXQoW1tcIlwiICsgY2l0YXRpb24uY2l0YXRpb25JRCwgY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXhdXSkuY29uY2F0KGNpdGF0aW9uc1Bvc3QpO1xuICAgICAgICB2YXIgbmV3SXRlbUlkcyA9IHt9O1xuICAgICAgICB2YXIgbmV3SXRlbUlkc0xpc3QgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBuZXdDaXRhdGlvbkxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBjID0gdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWRbbmV3Q2l0YXRpb25MaXN0W2ldWzBdXTtcbiAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBjLmNpdGF0aW9uSXRlbXMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgbmV3SXRlbUlkc1tjLmNpdGF0aW9uSXRlbXNbal0uaWRdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBuZXdJdGVtSWRzTGlzdC5wdXNoKFwiXCIgKyBjLmNpdGF0aW9uSXRlbXNbal0uaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG9sZEFtYmlncyA9IHt9O1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG9sZEl0ZW1MaXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKCFuZXdJdGVtSWRzW29sZEl0ZW1MaXN0W2ldLmlkXSkge1xuICAgICAgICAgICAgICAgIHZhciBvbGRBa2V5ID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtvbGRJdGVtTGlzdFtpXS5pZF0uYW1iaWc7XG4gICAgICAgICAgICAgICAgdmFyIGlkcyA9IHRoaXMucmVnaXN0cnkuYW1iaWdjaXRlc1tvbGRBa2V5XTtcbiAgICAgICAgICAgICAgICBpZiAoaWRzKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBpZHMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvbGRBbWJpZ3NbaWRzW2pdXSA9IENTTC5jbG9uZUFtYmlnQ29uZmlnKHRoaXMucmVnaXN0cnkucmVnaXN0cnlbaWRzW2pdXS5kaXNhbWJpZyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy50bXAudGFpbnRlZENpdGF0aW9uSURzID0ge307XG4gICAgdmFyIHNvcnRlZEl0ZW1zID0gW107XG4gICAgdmFyIHJlcnVuQWtleXMgPSB7fTtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGNpdGF0aW9uLmNpdGF0aW9uSXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGl0ZW0gPSB7fTtcbiAgICAgICAgZm9yICh2YXIga2V5IGluIGNpdGF0aW9uLmNpdGF0aW9uSXRlbXNbaV0pIHtcbiAgICAgICAgICAgIGl0ZW1ba2V5XSA9IGNpdGF0aW9uLmNpdGF0aW9uSXRlbXNbaV1ba2V5XTtcbiAgICAgICAgfVxuICAgICAgICBJdGVtID0gdGhpcy5yZXRyaWV2ZUl0ZW0oXCJcIiArIGl0ZW0uaWQpO1xuICAgICAgICBpZiAoSXRlbS5pZCkge1xuICAgICAgICAgICAgdGhpcy50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihcImRlZmF1bHRcIiwgXCJoZXJlaW5hZnRlclwiLCBJdGVtLmlkKTtcbiAgICAgICAgfVxuICAgICAgICBpdGVtID0gQ1NMLnBhcnNlTG9jYXRvci5jYWxsKHRoaXMsIGl0ZW0pO1xuICAgICAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5zdGF0aWNfc3RhdHV0ZV9sb2NhdG9yKSB7XG4gICAgICAgICAgICB0aGlzLnJlbWFwU2VjdGlvblZhcmlhYmxlKFtbSXRlbSxpdGVtXV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmxvY2F0b3JfbGFiZWxfcGFyc2UpIHtcbiAgICAgICAgICAgIGlmIChpdGVtLmxvY2F0b3IgJiYgW1wiYmlsbFwiLFwiZ2F6ZXR0ZVwiLFwibGVnaXNsYXRpb25cIixcInJlZ3VsYXRpb25cIixcInRyZWF0eVwiXS5pbmRleE9mKEl0ZW0udHlwZSkgPT09IC0xICYmICghaXRlbS5sYWJlbCB8fCBpdGVtLmxhYmVsID09PSAncGFnZScpKSB7XG4gICAgICAgICAgICAgICAgdmFyIG0gPSBDU0wuTE9DQVRPUl9MQUJFTFNfUkVHRVhQLmV4ZWMoaXRlbS5sb2NhdG9yKTtcbiAgICAgICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdHJ5TGFiZWwgPSBDU0wuTE9DQVRPUl9MQUJFTFNfTUFQW21bMl1dO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRUZXJtKHRyeUxhYmVsKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5sYWJlbCA9IHRyeUxhYmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gbVszXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgbmV3aXRlbSA9IFtJdGVtLCBpdGVtXTtcbiAgICAgICAgc29ydGVkSXRlbXMucHVzaChuZXdpdGVtKTtcbiAgICAgICAgY2l0YXRpb24uY2l0YXRpb25JdGVtc1tpXS5pdGVtID0gSXRlbTtcbiAgICB9XG4gICAgY2l0YXRpb24uc29ydGVkSXRlbXMgPSBzb3J0ZWRJdGVtcztcbiAgICB2YXIgY2l0YXRpb25CeUluZGV4ID0gW107XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBjaXRhdGlvbnNQcmUubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGMgPSBjaXRhdGlvbnNQcmVbaV07XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJZFtjWzBdXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCA9IGNbMV07XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHZhciBlcnIgPSBcIkNTTCBlcnJvclxcblwiO1xuICAgICAgICAgICAgZXJyICs9IFwiICBcIiArIGUgKyBcIlxcblwiO1xuICAgICAgICAgICAgZXJyICs9IFwiICBjaXRhdGlvbklEPVwiICsgY1swXSArIFwiXFxuXCI7XG4gICAgICAgICAgICBlcnIgKz0gXCIgIG5vdGVJbmRleD1cIiArIGNbMV0gKyBcIlxcblwiO1xuICAgICAgICAgICAgZXJyICs9IFwiICBhdGFycmF5IGNpdGF0aW9uc1ByZSBpbmRleCBcIiArIGkgKyBcIiwgZnJvbSBjaXRhdGlvbiBhdCBkb2N1bWVudCBwb3NpdGlvbiBcIiArIGNpdGF0aW9uc1ByZS5sZW5ndGg7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cbiAgICAgICAgY2l0YXRpb25CeUluZGV4LnB1c2godGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWRbY1swXV0pO1xuICAgIH1cbiAgICBjaXRhdGlvbkJ5SW5kZXgucHVzaChjaXRhdGlvbik7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBjaXRhdGlvbnNQb3N0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBjID0gY2l0YXRpb25zUG9zdFtpXTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25CeUlkW2NbMF1dLnByb3BlcnRpZXMubm90ZUluZGV4ID0gY1sxXTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdmFyIGVyciA9IFwiQ1NMIGVycm9yXFxuXCI7XG4gICAgICAgICAgICBlcnIgKz0gXCIgIFwiICsgZSArIFwiXFxuXCI7XG4gICAgICAgICAgICBlcnIgKz0gXCIgIGNpdGF0aW9uSUQ9XCIgKyBjWzBdICsgXCJcXG5cIjtcbiAgICAgICAgICAgIGVyciArPSBcIiAgbm90ZUluZGV4PVwiICsgY1sxXSArIFwiXFxuXCI7XG4gICAgICAgICAgICBlcnIgKz0gXCIgIGF0IGFycmF5IGNpdGF0aW9uc1Bvc3QgaW5kZXggXCIgKyBpICsgXCIsIGZyb20gY2l0YXRpb24gYXQgZG9jdW1lbnQgcG9zaXRpb24gXCIgKyBjaXRhdGlvbnNQcmUubGVuZ3RoO1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9XG4gICAgICAgIGNpdGF0aW9uQnlJbmRleC5wdXNoKHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25CeUlkW2NbMF1dKTtcbiAgICB9XG4gICAgdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SW5kZXggPSBjaXRhdGlvbkJ5SW5kZXg7XG4gICAgdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZCA9IHt9O1xuICAgIGlmICh0aGlzLm9wdC51cGRhdGVfbW9kZSA9PT0gQ1NMLlBPU0lUSU9OKSB7XG4gICAgICAgIHRleHRDaXRhdGlvbnMgPSBbXTtcbiAgICAgICAgbm90ZUNpdGF0aW9ucyA9IFtdO1xuICAgICAgICBjaXRhdGlvbnNJbk5vdGUgPSB7fTtcbiAgICB9XG4gICAgdmFyIHVwZGF0ZV9pdGVtcyA9IFtdO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gY2l0YXRpb25CeUluZGV4Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAoIWNpdGF0aW9uQnlJbmRleFtpXS5wcm9wZXJ0aWVzKSB7XG4gICAgICAgICAgICBjaXRhdGlvbkJ5SW5kZXhbaV0ucHJvcGVydGllcyA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIGNpdGF0aW9uQnlJbmRleFtpXS5wcm9wZXJ0aWVzLmluZGV4ID0gaTtcbiAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IGNpdGF0aW9uQnlJbmRleFtpXS5zb3J0ZWRJdGVtcy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIGl0ZW0gPSBjaXRhdGlvbkJ5SW5kZXhbaV0uc29ydGVkSXRlbXNbal07XG4gICAgICAgICAgICBpZiAoIXRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbaXRlbVsxXS5pZF0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW2l0ZW1bMV0uaWRdID0gW107XG4gICAgICAgICAgICAgICAgdXBkYXRlX2l0ZW1zLnB1c2goXCJcIiArIGl0ZW1bMV0uaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbaXRlbVsxXS5pZF0uaW5kZXhPZihjaXRhdGlvbkJ5SW5kZXhbaV0pID09PSAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbaXRlbVsxXS5pZF0ucHVzaChjaXRhdGlvbkJ5SW5kZXhbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm9wdC51cGRhdGVfbW9kZSA9PT0gQ1NMLlBPU0lUSU9OKSB7XG4gICAgICAgICAgICBpZiAoY2l0YXRpb25CeUluZGV4W2ldLnByb3BlcnRpZXMubm90ZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgbm90ZUNpdGF0aW9ucy5wdXNoKGNpdGF0aW9uQnlJbmRleFtpXSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNpdGF0aW9uQnlJbmRleFtpXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCA9IDA7XG4gICAgICAgICAgICAgICAgdGV4dENpdGF0aW9ucy5wdXNoKGNpdGF0aW9uQnlJbmRleFtpXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGZsYWcgIT09IENTTC5BU1NVTUVfQUxMX0lURU1TX1JFR0lTVEVSRUQpIHtcbiAgICAgICAgdGhpcy51cGRhdGVJdGVtcyh1cGRhdGVfaXRlbXMsIG51bGwsIG51bGwsIHRydWUpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMub3B0LmNpdGF0aW9uX251bWJlcl9zb3J0ICYmIHNvcnRlZEl0ZW1zICYmIHNvcnRlZEl0ZW1zLmxlbmd0aCA+IDEgJiYgdGhpcy5jaXRhdGlvbl9zb3J0LnRva2Vucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gc29ydGVkSXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBzb3J0ZWRJdGVtc1tpXVsxXS5zb3J0a2V5cyA9IENTTC5nZXRTb3J0S2V5cy5jYWxsKHRoaXMsIHNvcnRlZEl0ZW1zW2ldWzBdLCBcImNpdGF0aW9uX3NvcnRcIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMub3B0Lmdyb3VwZWRfc29ydCAmJiAgIWNpdGF0aW9uLnByb3BlcnRpZXMudW5zb3J0ZWQpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gc29ydGVkSXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNvcnRrZXlzID0gc29ydGVkSXRlbXNbaV1bMV0uc29ydGtleXM7XG4gICAgICAgICAgICAgICAgdGhpcy50bXAuYXV0aG9yc3RyaW5nX3JlcXVlc3QgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHZhciBteWRpc2FtYmlnID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtzb3J0ZWRJdGVtc1tpXVswXS5pZF0uZGlzYW1iaWc7XG4gICAgICAgICAgICAgICAgdGhpcy50bXAuYXV0aG9yc3RyaW5nX3JlcXVlc3QgPSB0cnVlO1xuICAgICAgICAgICAgICAgIENTTC5nZXRBbWJpZ3VvdXNDaXRlLmNhbGwodGhpcywgc29ydGVkSXRlbXNbaV1bMF0sIG15ZGlzYW1iaWcpO1xuICAgICAgICAgICAgICAgIHZhciBhdXRob3JzdHJpbmcgPSB0aGlzLnJlZ2lzdHJ5LmF1dGhvcnN0cmluZ3Nbc29ydGVkSXRlbXNbaV1bMF0uaWRdO1xuICAgICAgICAgICAgICAgIHRoaXMudG1wLmF1dGhvcnN0cmluZ19yZXF1ZXN0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgc29ydGVkSXRlbXNbaV1bMV0uc29ydGtleXMgPSBbYXV0aG9yc3RyaW5nXS5jb25jYXQoc29ydGtleXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc29ydGVkSXRlbXMuc29ydCh0aGlzLmNpdGF0aW9uLnNydC5jb21wYXJlQ29tcG9zaXRlS2V5cyk7XG4gICAgICAgICAgICB2YXIgbGFzdGF1dGhvciA9IGZhbHNlO1xuICAgICAgICAgICAgdmFyIHRoaXNrZXkgPSBmYWxzZTtcbiAgICAgICAgICAgIHZhciB0aGlzYXV0aG9yID0gZmFsc2U7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHNvcnRlZEl0ZW1zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIGlmIChzb3J0ZWRJdGVtc1tpXVsxXS5zb3J0a2V5c1swXSAhPT0gbGFzdGF1dGhvcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzYXV0aG9yID0gc29ydGVkSXRlbXNbaV1bMV0uc29ydGtleXNbMF07XG4gICAgICAgICAgICAgICAgICAgIHRoaXNrZXkgPSAgc29ydGVkSXRlbXNbaV1bMV0uc29ydGtleXNbMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNvcnRlZEl0ZW1zW2ldWzFdLnNvcnRrZXlzWzBdID0gXCJcIiArIHRoaXNrZXkgKyBpO1xuICAgICAgICAgICAgICAgIGxhc3RhdXRob3IgPSB0aGlzYXV0aG9yO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghY2l0YXRpb24ucHJvcGVydGllcy51bnNvcnRlZCkge1xuICAgICAgICAgICAgc29ydGVkSXRlbXMuc29ydCh0aGlzLmNpdGF0aW9uLnNydC5jb21wYXJlQ29tcG9zaXRlS2V5cyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIGNpdGF0aW9ucztcbiAgICBpZiAodGhpcy5vcHQudXBkYXRlX21vZGUgPT09IENTTC5QT1NJVElPTikge1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDI7IGkgKz0gMSkge1xuICAgICAgICAgICAgY2l0YXRpb25zID0gW3RleHRDaXRhdGlvbnMsIG5vdGVDaXRhdGlvbnNdW2ldO1xuICAgICAgICAgICAgdmFyIGZpcnN0X3JlZiA9IHt9O1xuICAgICAgICAgICAgdmFyIGxhc3RfcmVmID0ge307XG4gICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gY2l0YXRpb25zLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgIHZhciBvbmVjaXRhdGlvbiA9IGNpdGF0aW9uc1tqXTtcbiAgICAgICAgICAgICAgICBpZiAoIWNpdGF0aW9uc1tqXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICBjaXRhdGlvbnNbal0ucHJvcGVydGllcy5ub3RlSW5kZXggPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjaXRhdGlvbnNbal0ucHJvcGVydGllcy5ub3RlSW5kZXggPSBwYXJzZUludChjaXRhdGlvbnNbal0ucHJvcGVydGllcy5ub3RlSW5kZXgsIDEwKTtcbiAgICAgICAgICAgICAgICBpZiAoaiA+IDAgJiYgY2l0YXRpb25zW2ogLSAxXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCA+IGNpdGF0aW9uc1tqXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICBjaXRhdGlvbnNJbk5vdGUgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgZmlyc3RfcmVmID0ge307XG4gICAgICAgICAgICAgICAgICAgIGxhc3RfcmVmID0ge307XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAoayA9IDAsIGtsZW4gPSBvbmVjaXRhdGlvbi5zb3J0ZWRJdGVtcy5sZW5ndGg7IGsgPCBrbGVuOyBrICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W29uZWNpdGF0aW9uLnNvcnRlZEl0ZW1zW2tdWzFdLmlkXS5wYXJhbGxlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjaXRhdGlvbnNJbk5vdGVbb25lY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXhdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2l0YXRpb25zSW5Ob3RlW29uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4XSA9IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNpdGF0aW9uc0luTm90ZVtvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleF0gKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKGsgPSAwLCBrbGVuID0gY2l0YXRpb25zW2pdLnNvcnRlZEl0ZW1zLmxlbmd0aDsgayA8IGtsZW47IGsgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBpdGVtID0gY2l0YXRpb25zW2pdLnNvcnRlZEl0ZW1zW2tdO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbXlpZCA9IGl0ZW1bMF0uaWQ7XG4gICAgICAgICAgICAgICAgICAgIHZhciBteWxvY2F0b3IgPSBpdGVtWzFdLmxvY2F0b3I7XG4gICAgICAgICAgICAgICAgICAgIHZhciBteWxhYmVsID0gaXRlbVsxXS5sYWJlbDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1bMF0ubGVnaXNsYXRpb25faWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG15aWQgPSBpdGVtWzBdLmxlZ2lzbGF0aW9uX2lkO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbmNpdGF0aW9uaWQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChrID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9uZWNpdGF0aW9uLnNvcnRlZEl0ZW1zW2sgLSAxXVswXS5sZWdpc2xhdGlvbl9pZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2l0YXRpb25pZCA9IG9uZWNpdGF0aW9uLnNvcnRlZEl0ZW1zW2sgLSAxXVswXS5sZWdpc2xhdGlvbl9pZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jaXRhdGlvbmlkID0gb25lY2l0YXRpb24uc29ydGVkSXRlbXNbayAtIDFdWzFdLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChmbGFnID09PSBDU0wuUFJFVklFVykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9uZWNpdGF0aW9uLmNpdGF0aW9uSUQgIT0gY2l0YXRpb24uY2l0YXRpb25JRCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgZmlyc3RfcmVmW2l0ZW1bMV0uaWRdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X3JlZltteWlkXSA9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0X3JlZltteWlkXSA9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfcmVmW215aWRdID0gb25lY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBvbGR2YWx1ZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICBvbGR2YWx1ZS5wb3NpdGlvbiA9IGl0ZW1bMV0ucG9zaXRpb247XG4gICAgICAgICAgICAgICAgICAgIG9sZHZhbHVlW1wiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCJdID0gaXRlbVsxXVtcImZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlclwiXTtcbiAgICAgICAgICAgICAgICAgICAgb2xkdmFsdWVbXCJuZWFyLW5vdGVcIl0gPSBpdGVtWzFdW1wibmVhci1ub3RlXCJdO1xuICAgICAgICAgICAgICAgICAgICBpdGVtWzFdW1wiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCJdID0gMDtcbiAgICAgICAgICAgICAgICAgICAgaXRlbVsxXVtcIm5lYXItbm90ZVwiXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtteWlkXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0LnhjbGFzcyA9PT0gJ25vdGUnICYmIHRoaXMub3B0Lmhhc19kaXNhbWJpZ3VhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkQ291bnQgPSB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W215aWRdW1wiY2l0YXRpb24tY291bnRcIl1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3Q291bnQgPSB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW215aWRdLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W215aWRdW1wiY2l0YXRpb24tY291bnRcIl0gPSB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW215aWRdLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIG9sZENvdW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRDb3VudENoZWNrID0gKG9sZENvdW50IDwgMik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdDb3VudENoZWNrID0gKG5ld0NvdW50IDwgMik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRDb3VudENoZWNrICE9PSBuZXdDb3VudENoZWNrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBsPTAsbGxlbj10aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW215aWRdLmxlbmd0aDtsPGxsZW47bCsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVydW5Ba2V5c1t0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W215aWRdLmFtYmlnXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50bXAudGFpbnRlZENpdGF0aW9uSURzW3RoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbbXlpZF1bbF0uY2l0YXRpb25JRF0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbD0wLGxsZW49dGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtteWlkXS5sZW5ndGg7bDxsbGVuO2wrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVydW5Ba2V5c1t0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W215aWRdLmFtYmlnXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC50YWludGVkQ2l0YXRpb25JRHNbdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtteWlkXVtsXS5jaXRhdGlvbklEXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZGxhc3RpZDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBmaXJzdF9yZWZbbXlpZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X3JlZltteWlkXSA9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmVnaXN0cnkucmVnaXN0cnlbbXlpZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W215aWRdWydmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXInXSA9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9yZWZbbXlpZF0gPSBvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bMV0ucG9zaXRpb24gPSBDU0wuUE9TSVRJT05fRklSU1Q7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWJpZG1lID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3VwcmFtZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGogPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkbGFzdGlkID0gIGNpdGF0aW9uc1tqIC0gMV0uc29ydGVkSXRlbXMuc2xpY2UoLTEpWzBdWzFdLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IFwiQ1NMIEVycm9yXFxuXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVyciArPSBcIiAgXCIgKyBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnIgKz0gXCIgIGluIGNpdGF0aW9uIG9iamVjdCBcIiArIGNpdGF0aW9uc1tqIC0gMV0uY2l0YXRpb25JRCArIFwiIGF0IGluZGV4IFwiICsgKGogLSAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2l0YXRpb25zW2ogLSAxXS5zb3J0ZWRJdGVtc1swXS5zbGljZSgtMSlbMF0ubGVnaXNsYXRpb25faWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkbGFzdGlkID0gY2l0YXRpb25zW2ogLSAxXS5zb3J0ZWRJdGVtc1swXS5zbGljZSgtMSlbMF0ubGVnaXNsYXRpb25faWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGogPiAwICYmIHBhcnNlSW50KGssIDEwKSA9PT0gMCAmJiBjaXRhdGlvbnNbaiAtIDFdLnByb3BlcnRpZXMubm90ZUluZGV4ICE9PSBjaXRhdGlvbnNbal0ucHJvcGVydGllcy5ub3RlSW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSBjaXRhdGlvbnNbKGogLSAxKV0uc29ydGVkSXRlbXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVzZW1lID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZGlkID0gY2l0YXRpb25zW2ogLSAxXS5zb3J0ZWRJdGVtc1swXVswXS5pZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2l0YXRpb25zW2ogLSAxXS5zb3J0ZWRJdGVtc1swXVswXS5sZWdpc2xhdGlvbl9pZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRpZCA9IGNpdGF0aW9uc1tqIC0gMV0uc29ydGVkSXRlbXNbMF1bMF0ubGVnaXNsYXRpb25faWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgob2xkaWQgID09IG15aWQgJiYgY2l0YXRpb25zW2ogLSAxXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCA+PSAoY2l0YXRpb25zW2pdLnByb3BlcnRpZXMubm90ZUluZGV4IC0gMSkpIHx8IGNpdGF0aW9uc1tqIC0gMV0uc29ydGVkSXRlbXNbMF1bMV0uaWQgPT0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtpdGVtWzFdLmlkXS5wYXJhbGxlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2l0YXRpb25zSW5Ob3RlW2NpdGF0aW9uc1tqIC0gMV0ucHJvcGVydGllcy5ub3RlSW5kZXhdID09PSAxIHx8IGNpdGF0aW9uc1tqIC0gMV0ucHJvcGVydGllcy5ub3RlSW5kZXggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZW1lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKG4gPSAwLCBubGVuID0gaXRlbXMuc2xpY2UoMSkubGVuZ3RoOyBuIDwgbmxlbjsgbiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdG1wID0gaXRlbXMuc2xpY2UoMSlbbl07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtpdG1wWzFdLmlkXS5wYXJhbGxlbCB8fCB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2l0bXBbMV0uaWRdLnBhcmFsbGVsID09IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbaXRtcFsxXS5pZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZW1lID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVzZW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGliaWRtZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VwcmFtZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrID4gMCAmJiBpbmNpdGF0aW9uaWQgPT0gbXlpZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGliaWRtZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGsgPT09IDAgJiYgY2l0YXRpb25zW2ogLSAxXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCA9PSBjaXRhdGlvbnNbal0ucHJvcGVydGllcy5ub3RlSW5kZXhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgY2l0YXRpb25zW2ogLSAxXS5zb3J0ZWRJdGVtcy5sZW5ndGggXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIG9sZGxhc3RpZCA9PSBteWlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWJpZG1lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VwcmFtZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldiwgcHJldl9sb2NhdG9yLCBwcmV2X2xhYmVsLCBjdXJyX2xvY2F0b3IsIGN1cnJfbGFiZWw7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWJpZG1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGsgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXYgPSBvbmVjaXRhdGlvbi5zb3J0ZWRJdGVtc1soayAtIDEpXVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2ID0gY2l0YXRpb25zWyhqIC0gMSldLnNvcnRlZEl0ZW1zWzBdWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldi5sb2NhdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2LmxhYmVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2X2xhYmVsID0gcHJldi5sYWJlbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZfbGFiZWwgPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZfbG9jYXRvciA9IFwiXCIgKyBwcmV2LmxvY2F0b3IgKyBwcmV2X2xhYmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZfbG9jYXRvciA9IHByZXYubG9jYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG15bG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXlsYWJlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vycl9sYWJlbCA9IG15bGFiZWw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyX2xhYmVsID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyX2xvY2F0b3IgPSBcIlwiICsgbXlsb2NhdG9yICsgY3Vycl9sYWJlbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyX2xvY2F0b3IgPSBteWxvY2F0b3I7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGliaWRtZSAmJiBwcmV2X2xvY2F0b3IgJiYgIWN1cnJfbG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGliaWRtZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1cHJhbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGliaWRtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcHJldl9sb2NhdG9yICYmIGN1cnJfbG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtWzFdLnBvc2l0aW9uID0gQ1NMLlBPU0lUSU9OX0lCSURfV0lUSF9MT0NBVE9SO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXByZXZfbG9jYXRvciAmJiAhY3Vycl9sb2NhdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bMV0ucG9zaXRpb24gPSBDU0wuUE9TSVRJT05fSUJJRDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByZXZfbG9jYXRvciAmJiBjdXJyX2xvY2F0b3IgPT09IHByZXZfbG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtWzFdLnBvc2l0aW9uID0gQ1NMLlBPU0lUSU9OX0lCSUQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcmV2X2xvY2F0b3IgJiYgY3Vycl9sb2NhdG9yICYmIGN1cnJfbG9jYXRvciAhPT0gcHJldl9sb2NhdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bMV0ucG9zaXRpb24gPSBDU0wuUE9TSVRJT05fSUJJRF9XSVRIX0xPQ0FUT1I7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWJpZG1lID0gZmFsc2U7IC8vIGp1c3QgdG8gYmUgY2xlYXJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VwcmFtZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN1cHJhbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtWzFdLnBvc2l0aW9uID0gQ1NMLlBPU0lUSU9OX1NVQlNFUVVFTlQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3VwcmFtZSB8fCBpYmlkbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3RfcmVmW215aWRdICE9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bMV1bXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIl0gPSBmaXJzdF9yZWZbbXlpZF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W215aWRdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkRmlyc3QgPSB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW215aWRdWzBdLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0ZpcnN0ID0gb25lY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W215aWRdWydmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXInXSA9IG5ld0ZpcnN0IDwgb2xkRmlyc3QgPyBuZXdGaXJzdDogb2xkRmlyc3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm90ZV9kaXN0YW5jZSA9IHBhcnNlSW50KG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4LCAxMCkgLSBwYXJzZUludChsYXN0X3JlZltteWlkXSwgMTApO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1bMV0ucG9zaXRpb24gIT09IENTTC5QT1NJVElPTl9GSVJTVCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBub3RlX2Rpc3RhbmNlIDw9IHRoaXMuY2l0YXRpb24ub3B0W1wibmVhci1ub3RlLWRpc3RhbmNlXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVsxXVtcIm5lYXItbm90ZVwiXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0X3JlZltteWlkXSA9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChvbmVjaXRhdGlvbi5jaXRhdGlvbklEICE9IGNpdGF0aW9uLmNpdGF0aW9uSUQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobiA9IDAsIG5sZW4gPSBDU0wuUE9TSVRJT05fVEVTVF9WQVJTLmxlbmd0aDsgbiA8IG5sZW47IG4gKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJhbSA9IENTTC5QT1NJVElPTl9URVNUX1ZBUlNbbl07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1bMV1bcGFyYW1dICE9PSBvbGR2YWx1ZVtwYXJhbV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmVnaXN0cnkucmVnaXN0cnlbbXlpZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbSA9PT0gJ2ZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlcicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXJ1bkFrZXlzW3RoaXMucmVnaXN0cnkucmVnaXN0cnlbbXlpZF0uYW1iaWddID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC50YWludGVkSXRlbUlEc1tteWlkXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50bXAudGFpbnRlZENpdGF0aW9uSURzW29uZWNpdGF0aW9uLmNpdGF0aW9uSURdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3lzLnZhcmlhYmxlV3JhcHBlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVsxXS5pbmRleCA9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMuaW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtWzFdLm5vdGVJbmRleCA9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdC5jaXRhdGlvbl9udW1iZXJfc29ydCAmJiBzb3J0ZWRJdGVtcyAmJiBzb3J0ZWRJdGVtcy5sZW5ndGggPiAxICYmIHRoaXMuY2l0YXRpb25fc29ydC50b2tlbnMubGVuZ3RoID4gMCkge1xuICAgICAgICBpZiAoIWNpdGF0aW9uLnByb3BlcnRpZXMudW5zb3J0ZWQpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gc29ydGVkSXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgc29ydGVkSXRlbXNbaV1bMV0uc29ydGtleXMgPSBDU0wuZ2V0U29ydEtleXMuY2FsbCh0aGlzLCBzb3J0ZWRJdGVtc1tpXVswXSwgXCJjaXRhdGlvbl9zb3J0XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc29ydGVkSXRlbXMuc29ydCh0aGlzLmNpdGF0aW9uLnNydC5jb21wYXJlQ29tcG9zaXRlS2V5cyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2YXIga2V5IGluIHRoaXMudG1wLnRhaW50ZWRJdGVtSURzKSB7XG4gICAgICAgIGlmICh0aGlzLnRtcC50YWludGVkSXRlbUlEcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICBjaXRhdGlvbnMgPSB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW2tleV07XG4gICAgICAgICAgICBpZiAoY2l0YXRpb25zKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBjaXRhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudG1wLnRhaW50ZWRDaXRhdGlvbklEc1tjaXRhdGlvbnNbaV0uY2l0YXRpb25JRF0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgcmV0ID0gW107XG4gICAgaWYgKGZsYWcgPT09IENTTC5QUkVWSUVXKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXQgPSB0aGlzLnByb2Nlc3NfQ2l0YXRpb25DbHVzdGVyLmNhbGwodGhpcywgY2l0YXRpb24uc29ydGVkSXRlbXMsIGNpdGF0aW9uLmNpdGF0aW9uSUQpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBDU0wuZXJyb3IoXCJFcnJvciBydW5uaW5nIENTTCBwcm9jZXNzb3IgZm9yIHByZXZpZXc6IFwiK2UpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25CeUluZGV4ID0gb2xkQ2l0YXRpb25MaXN0O1xuICAgICAgICB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJZCA9IHt9O1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG9sZENpdGF0aW9uTGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25CeUlkW29sZENpdGF0aW9uTGlzdFtpXS5jaXRhdGlvbklEXSA9IG9sZENpdGF0aW9uTGlzdFtpXTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgb2xkSXRlbUlkcyA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG9sZEl0ZW1MaXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgb2xkSXRlbUlkcy5wdXNoKFwiXCIgKyBvbGRJdGVtTGlzdFtpXS5pZCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy51cGRhdGVJdGVtcyhvbGRJdGVtSWRzLCBudWxsLCBudWxsLCB0cnVlKTtcbiAgICAgICAgZm9yICh2YXIga2V5IGluIG9sZEFtYmlncykge1xuICAgICAgICAgICAgaWYgKG9sZEFtYmlncy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtrZXldLmRpc2FtYmlnID0gb2xkQW1iaWdzW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKHZhciByZXJ1bkFrZXkgaW4gcmVydW5Ba2V5cykge1xuICAgICAgICAgICAgdGhpcy5kaXNhbWJpZ3VhdGUucnVuKHJlcnVuQWtleSwgY2l0YXRpb24pO1xuICAgICAgICB9XG4gICAgICAgIHZhciBvYmo7XG4gICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnRtcC50YWludGVkQ2l0YXRpb25JRHMpIHtcbiAgICAgICAgICAgIGlmIChrZXkgPT0gY2l0YXRpb24uY2l0YXRpb25JRCkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG15Y2l0YXRpb24gPSB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJZFtrZXldO1xuICAgICAgICAgICAgaWYgKCFteWNpdGF0aW9uLnByb3BlcnRpZXMudW5zb3J0ZWQpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG15Y2l0YXRpb24uc29ydGVkSXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIG15Y2l0YXRpb24uc29ydGVkSXRlbXNbaV1bMV0uc29ydGtleXMgPSBDU0wuZ2V0U29ydEtleXMuY2FsbCh0aGlzLCBteWNpdGF0aW9uLnNvcnRlZEl0ZW1zW2ldWzBdLCBcImNpdGF0aW9uX3NvcnRcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG15Y2l0YXRpb24uc29ydGVkSXRlbXMuc29ydCh0aGlzLmNpdGF0aW9uLnNydC5jb21wYXJlQ29tcG9zaXRlS2V5cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnRtcC5jaXRhdGlvbl9wb3MgPSBteWNpdGF0aW9uLnByb3BlcnRpZXMuaW5kZXg7XG4gICAgICAgICAgICB0aGlzLnRtcC5jaXRhdGlvbl9ub3RlX2luZGV4ID0gbXljaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleDtcbiAgICAgICAgICAgIHRoaXMudG1wLmNpdGF0aW9uX2lkID0gXCJcIiArIG15Y2l0YXRpb24uY2l0YXRpb25JRDtcbiAgICAgICAgICAgIG9iaiA9IFtdO1xuICAgICAgICAgICAgb2JqLnB1c2gobXljaXRhdGlvbi5wcm9wZXJ0aWVzLmluZGV4KTtcbiAgICAgICAgICAgIG9iai5wdXNoKHRoaXMucHJvY2Vzc19DaXRhdGlvbkNsdXN0ZXIuY2FsbCh0aGlzLCBteWNpdGF0aW9uLnNvcnRlZEl0ZW1zLCBteWNpdGF0aW9uLmNpdGF0aW9uSUQpKTtcbiAgICAgICAgICAgIG9iai5wdXNoKG15Y2l0YXRpb24uY2l0YXRpb25JRCk7XG4gICAgICAgICAgICByZXQucHVzaChvYmopO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudG1wLnRhaW50ZWRJdGVtSURzID0ge307XG4gICAgICAgIHRoaXMudG1wLnRhaW50ZWRDaXRhdGlvbklEcyA9IHt9O1xuICAgICAgICB0aGlzLnRtcC5jaXRhdGlvbl9wb3MgPSBjaXRhdGlvbi5wcm9wZXJ0aWVzLmluZGV4O1xuICAgICAgICB0aGlzLnRtcC5jaXRhdGlvbl9ub3RlX2luZGV4ID0gY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXg7XG4gICAgICAgIHRoaXMudG1wLmNpdGF0aW9uX2lkID0gXCJcIiArIGNpdGF0aW9uLmNpdGF0aW9uSUQ7XG4gICAgICAgIG9iaiA9IFtdO1xuICAgICAgICBvYmoucHVzaChjaXRhdGlvbnNQcmUubGVuZ3RoKTtcbiAgICAgICAgb2JqLnB1c2godGhpcy5wcm9jZXNzX0NpdGF0aW9uQ2x1c3Rlci5jYWxsKHRoaXMsIHNvcnRlZEl0ZW1zLCBjaXRhdGlvbi5jaXRhdGlvbklEKSk7XG4gICAgICAgIG9iai5wdXNoKGNpdGF0aW9uLmNpdGF0aW9uSUQpO1xuICAgICAgICByZXQucHVzaChvYmopO1xuICAgICAgICByZXQuc29ydChmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICAgICAgaWYgKGFbMF0gPiBiWzBdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGFbMF0gPCBiWzBdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybl9kYXRhLmNpdGF0aW9uX2Vycm9ycyA9IHRoaXMudG1wLmNpdGF0aW9uX2Vycm9ycy5zbGljZSgpO1xuICAgIHJldHVybiBbcmV0dXJuX2RhdGEsIHJldF07XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUucHJvY2Vzc19DaXRhdGlvbkNsdXN0ZXIgPSBmdW5jdGlvbiAoc29ydGVkSXRlbXMsIGNpdGF0aW9uSUQpIHtcbiAgICB2YXIgc3RyO1xuICAgIHRoaXMucGFyYWxsZWwuU3RhcnRDaXRhdGlvbihzb3J0ZWRJdGVtcyk7XG4gICAgc3RyID0gQ1NMLmdldENpdGF0aW9uQ2x1c3Rlci5jYWxsKHRoaXMsIHNvcnRlZEl0ZW1zLCBjaXRhdGlvbklEKTtcbiAgICByZXR1cm4gc3RyO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLm1ha2VDaXRhdGlvbkNsdXN0ZXIgPSBmdW5jdGlvbiAocmF3TGlzdCkge1xuICAgIHZhciBpbnB1dExpc3QsIG5ld2l0ZW0sIHN0ciwgcG9zLCBsZW4sIGl0ZW0sIEl0ZW07XG4gICAgaW5wdXRMaXN0ID0gW107XG4gICAgbGVuID0gcmF3TGlzdC5sZW5ndGg7XG4gICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIGl0ZW0gPSB7fTtcbiAgICAgICAgZm9yICh2YXIga2V5IGluIHJhd0xpc3RbcG9zXSkge1xuICAgICAgICAgICAgaXRlbVtrZXldID0gcmF3TGlzdFtwb3NdW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgSXRlbSA9IHRoaXMucmV0cmlldmVJdGVtKFwiXCIgKyBpdGVtLmlkKTtcbiAgICAgICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMubG9jYXRvcl9sYWJlbF9wYXJzZSkge1xuICAgICAgICAgICAgaWYgKGl0ZW0ubG9jYXRvciAmJiBbXCJiaWxsXCIsXCJnYXpldHRlXCIsXCJsZWdpc2xhdGlvblwiLFwicmVndWxhdGlvblwiLFwidHJlYXR5XCJdLmluZGV4T2YoSXRlbS50eXBlKSA9PT0gLTEgJiYgKCFpdGVtLmxhYmVsIHx8IGl0ZW0ubGFiZWwgPT09ICdwYWdlJykpIHtcbiAgICAgICAgICAgICAgICB2YXIgbSA9IENTTC5MT0NBVE9SX0xBQkVMU19SRUdFWFAuZXhlYyhpdGVtLmxvY2F0b3IpO1xuICAgICAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0cnlMYWJlbCA9IENTTC5MT0NBVE9SX0xBQkVMU19NQVBbbVsyXV07XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldFRlcm0odHJ5TGFiZWwpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmxhYmVsID0gdHJ5TGFiZWw7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmxvY2F0b3IgPSBtWzNdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChpdGVtLmxvY2F0b3IpIHtcbiAgICAgICAgICAgIGl0ZW0ubG9jYXRvciA9IChcIlwiICsgaXRlbS5sb2NhdG9yKS5yZXBsYWNlKC9cXHMrJC8sICcnKTtcbiAgICAgICAgfVxuICAgICAgICBuZXdpdGVtID0gW0l0ZW0sIGl0ZW1dO1xuICAgICAgICBpbnB1dExpc3QucHVzaChuZXdpdGVtKTtcbiAgICB9XG4gICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3RhdGljX3N0YXR1dGVfbG9jYXRvcikge1xuICAgICAgICB0aGlzLnJlbWFwU2VjdGlvblZhcmlhYmxlKGlucHV0TGlzdCk7XG4gICAgfVxuICAgIGlmIChpbnB1dExpc3QgJiYgaW5wdXRMaXN0Lmxlbmd0aCA+IDEgJiYgdGhpcy5jaXRhdGlvbl9zb3J0LnRva2Vucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGxlbiA9IGlucHV0TGlzdC5sZW5ndGg7XG4gICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgaW5wdXRMaXN0W3Bvc11bMV0uc29ydGtleXMgPSBDU0wuZ2V0U29ydEtleXMuY2FsbCh0aGlzLCBpbnB1dExpc3RbcG9zXVswXSwgXCJjaXRhdGlvbl9zb3J0XCIpO1xuICAgICAgICB9XG4gICAgICAgIGlucHV0TGlzdC5zb3J0KHRoaXMuY2l0YXRpb24uc3J0LmNvbXBhcmVDb21wb3NpdGVLZXlzKTtcbiAgICB9XG4gICAgdGhpcy50bXAuY2l0YXRpb25fZXJyb3JzID0gW107XG4gICAgdGhpcy5wYXJhbGxlbC5TdGFydENpdGF0aW9uKGlucHV0TGlzdCk7XG4gICAgc3RyID0gQ1NMLmdldENpdGF0aW9uQ2x1c3Rlci5jYWxsKHRoaXMsIGlucHV0TGlzdCk7XG4gICAgcmV0dXJuIHN0cjtcbn07XG5DU0wuZ2V0QW1iaWd1b3VzQ2l0ZSA9IGZ1bmN0aW9uIChJdGVtLCBkaXNhbWJpZywgdmlzdWFsRm9ybSwgaXRlbSkge1xuICAgIHZhciB1c2VfcGFyYWxsZWxzLCByZXQ7XG4gICAgdmFyIGZsYWdzID0gdGhpcy50bXAuZ3JvdXBfY29udGV4dC50aXA7XG4gICAgdmFyIG9sZFRlcm1TaWJsaW5nTGF5ZXIgPSB7XG4gICAgICAgIHRlcm1faW50ZW5kZWQ6IGZsYWdzLnRlcm1faW50ZW5kZWQsXG4gICAgICAgIHZhcmlhYmxlX2F0dGVtcHQ6IGZsYWdzLnZhcmlhYmxlX2F0dGVtcHQsXG4gICAgICAgIHZhcmlhYmxlX3N1Y2Nlc3M6IGZsYWdzLnZhcmlhYmxlX3N1Y2Nlc3MsXG4gICAgICAgIG91dHB1dF90aXA6IGZsYWdzLm91dHB1dF90aXAsXG4gICAgICAgIGxhYmVsX2Zvcm06IGZsYWdzLmxhYmVsX2Zvcm0sXG4gICAgICAgIHBhcmFsbGVsX2NvbmRpdGlvbnM6IGZsYWdzLnBhcmFsbGVsX2NvbmRpdGlvbnMsXG4gICAgICAgIGNvbmRpdGlvbjogZmxhZ3MuY29uZGl0aW9uLFxuICAgICAgICBmb3JjZV9zdXBwcmVzczogZmxhZ3MuZm9yY2Vfc3VwcHJlc3MsXG4gICAgICAgIGRvbmVfdmFyczogZmxhZ3MuZG9uZV92YXJzLnNsaWNlKClcbiAgICB9XG4gICAgaWYgKGRpc2FtYmlnKSB7XG4gICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3JlcXVlc3QgPSBkaXNhbWJpZztcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19yZXF1ZXN0ID0gZmFsc2U7XG4gICAgfVxuICAgIHZhciBpdGVtU3VwcCA9IHtcbiAgICAgICAgcG9zaXRpb246IDEsXG4gICAgICAgIFwibmVhci1ub3RlXCI6IHRydWVcbiAgICB9O1xuICAgIGlmIChpdGVtKSB7XG4gICAgICAgIGl0ZW1TdXBwLmxvY2F0b3IgPSBpdGVtLmxvY2F0b3I7XG4gICAgICAgIGl0ZW1TdXBwLmxhYmVsID0gaXRlbS5sYWJlbDtcbiAgICB9XG4gICAgaWYgKHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0gXG4gICAgICAgICYmIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRcbiAgICAgICAgJiYgdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtJdGVtLmlkXVxuICAgICAgICAmJiB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW0l0ZW0uaWRdLmxlbmd0aCBcbiAgICAgICAgJiYgdmlzdWFsRm9ybSkge1xuICAgICAgICBpZiAodGhpcy5jaXRhdGlvbi5vcHRbXCJnaXZlbm5hbWUtZGlzYW1iaWd1YXRpb24tcnVsZVwiXSA9PT0gXCJieS1jaXRlXCIpIHtcbiAgICAgICAgICAgIGl0ZW1TdXBwWydmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXInXSA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF1bJ2ZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlciddO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudG1wLmFyZWEgPSBcImNpdGF0aW9uXCI7XG4gICAgdGhpcy50bXAucm9vdCA9IFwiY2l0YXRpb25cIjtcbiAgICB0aGlzLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPSAodGhpcy5wYXJhbGxlbC51c2VfcGFyYWxsZWxzID09PSB0cnVlIHx8IHRoaXMucGFyYWxsZWwudXNlX3BhcmFsbGVscyA9PT0gbnVsbCkgPyBudWxsIDogZmFsc2U7XG4gICAgdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSB0cnVlO1xuICAgIHRoaXMudG1wLmp1c3RfbG9va2luZyA9IHRydWU7XG4gICAgQ1NMLmdldENpdGUuY2FsbCh0aGlzLCBJdGVtLCBpdGVtU3VwcCwgbnVsbCwgZmFsc2UpO1xuICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMub3V0cHV0LnF1ZXVlLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICBDU0wuT3V0cHV0LlF1ZXVlLnB1cmdlRW1wdHlCbG9icyh0aGlzLm91dHB1dC5xdWV1ZVtpXSk7XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmNsZWFuX3VwX2NzbF9mbGF3cykge1xuICAgICAgICBmb3IgKHZhciBqPTAsamxlbj10aGlzLm91dHB1dC5xdWV1ZS5sZW5ndGg7ajxqbGVuO2orPTEpIHtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0LmFkanVzdC51cHdhcmQodGhpcy5vdXRwdXQucXVldWVbal0pO1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQuYWRqdXN0LmxlZnR3YXJkKHRoaXMub3V0cHV0LnF1ZXVlW2pdKTtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0LmFkanVzdC5kb3dud2FyZCh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QuZml4KHRoaXMub3V0cHV0LnF1ZXVlW2pdKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgcmV0ID0gdGhpcy5vdXRwdXQuc3RyaW5nKHRoaXMsIHRoaXMub3V0cHV0LnF1ZXVlKTtcbiAgICB0aGlzLnRtcC5qdXN0X2xvb2tpbmcgPSBmYWxzZTtcbiAgICB0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucyA9IGZhbHNlO1xuICAgIHRoaXMucGFyYWxsZWwudXNlX3BhcmFsbGVscyA9IHRoaXMucGFyYWxsZWwudXNlX3BhcmFsbGVscyA9PT0gbnVsbCA/IHRydWUgOiBmYWxzZTtcbiAgICB0aGlzLnRtcC5ncm91cF9jb250ZXh0LnJlcGxhY2Uob2xkVGVybVNpYmxpbmdMYXllcik7XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuZ2V0U3BsaWNlRGVsaW1pdGVyID0gZnVuY3Rpb24gKGxhc3RfbG9jYXRvciwgbGFzdF9jb2xsYXBzZWQsIHBvcykge1xuICAgIGlmICh1bmRlZmluZWQgIT09IHRoaXMuY2l0YXRpb24ub3B0W1wiYWZ0ZXItY29sbGFwc2UtZGVsaW1pdGVyXCJdKSB7XG4gICAgICAgIGlmIChsYXN0X2xvY2F0b3IpIHtcbiAgICAgICAgICAgIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSB0aGlzLmNpdGF0aW9uLm9wdFtcImFmdGVyLWNvbGxhcHNlLWRlbGltaXRlclwiXTtcbiAgICAgICAgfSBlbHNlIGlmIChsYXN0X2NvbGxhcHNlZCAmJiAhdGhpcy50bXAuaGF2ZV9jb2xsYXBzZWQpIHtcbiAgICAgICAgICAgIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSB0aGlzLmNpdGF0aW9uLm9wdFtcImFmdGVyLWNvbGxhcHNlLWRlbGltaXRlclwiXTtcbiAgICAgICAgfSBlbHNlIGlmICghbGFzdF9jb2xsYXBzZWQgJiYgIXRoaXMudG1wLmhhdmVfY29sbGFwc2VkICYmIHRoaXMuY2l0YXRpb24ub3B0LmNvbGxhcHNlICE9PSBcInllYXItc3VmZml4XCIpIHtcbiAgICAgICAgICAgIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSB0aGlzLmNpdGF0aW9uLm9wdFtcImFmdGVyLWNvbGxhcHNlLWRlbGltaXRlclwiXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSB0aGlzLmNpdGF0aW9uLm9wdC5sYXlvdXRfZGVsaW1pdGVyO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmICh0aGlzLnRtcC51c2VfY2l0ZV9ncm91cF9kZWxpbWl0ZXIpIHtcbiAgICAgICAgdGhpcy50bXAuc3BsaWNlX2RlbGltaXRlciA9IHRoaXMuY2l0YXRpb24ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLnRtcC5oYXZlX2NvbGxhcHNlZCAmJiB0aGlzLm9wdC54Y2xhc3MgPT09IFwiaW4tdGV4dFwiICYmIHRoaXMub3B0LnVwZGF0ZV9tb2RlICE9PSBDU0wuTlVNRVJJQykge1xuICAgICAgICAgICAgdGhpcy50bXAuc3BsaWNlX2RlbGltaXRlciA9IFwiLCBcIjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRtcC5jaXRlX2xvY2FsZXNbcG9zIC0gMV0pIHtcbiAgICAgICAgICAgIHZhciBhbHRfYWZmaXhlcyA9IHRoaXMudG1wLmNpdGVfYWZmaXhlc1t0aGlzLnRtcC5hcmVhXVt0aGlzLnRtcC5jaXRlX2xvY2FsZXNbcG9zIC0gMV1dO1xuICAgICAgICAgICAgaWYgKGFsdF9hZmZpeGVzICYmIGFsdF9hZmZpeGVzLmRlbGltaXRlcikge1xuICAgICAgICAgICAgICAgIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSBhbHRfYWZmaXhlcy5kZWxpbWl0ZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSBcIlwiO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnRtcC5zcGxpY2VfZGVsaW1pdGVyO1xufTtcbkNTTC5nZXRDaXRhdGlvbkNsdXN0ZXIgPSBmdW5jdGlvbiAoaW5wdXRMaXN0LCBjaXRhdGlvbklEKSB7XG4gICAgdmFyIHJlc3VsdCwgb2JqZWN0cywgbXlwYXJhbXMsIGxlbiwgcG9zLCBpdGVtLCBsYXN0X2NvbGxhcHNlZCwgcGFyYW1zLCBlbXB0aWVzLCBjb21wb3NpdGUsIGNvbXBpZSwgbXlibG9icywgSXRlbSwgbGxlbiwgcHBvcywgb2JqLCBwcmVjZWRpbmdfaXRlbSwgdHh0X2VzYywgZXJyb3Jfb2JqZWN0O1xuICAgIGlucHV0TGlzdCA9IGlucHV0TGlzdCA/IGlucHV0TGlzdCA6IFtdO1xuICAgIHRoaXMudG1wLmxhc3RfcHJpbWFyeV9uYW1lc19zdHJpbmcgPSBmYWxzZTtcbiAgICB0eHRfZXNjID0gQ1NMLmdldFNhZmVFc2NhcGUodGhpcyk7XG4gICAgdGhpcy50bXAuYXJlYSA9IFwiY2l0YXRpb25cIjtcbiAgICB0aGlzLnRtcC5yb290ID0gXCJjaXRhdGlvblwiO1xuICAgIHJlc3VsdCA9IFwiXCI7XG4gICAgb2JqZWN0cyA9IFtdO1xuICAgIHRoaXMudG1wLmxhc3Rfc3VmZml4X3VzZWQgPSBcIlwiO1xuICAgIHRoaXMudG1wLmxhc3RfbmFtZXNfdXNlZCA9IFtdO1xuICAgIHRoaXMudG1wLmxhc3RfeWVhcnNfdXNlZCA9IFtdO1xuICAgIHRoaXMudG1wLmJhY2tyZWZfaW5kZXggPSBbXTtcbiAgICB0aGlzLnRtcC5jaXRlX2xvY2FsZXMgPSBbXTtcbiAgICB0aGlzLm91dHB1dC5jaGVja05lc3RlZEJyYWNlID0gbmV3IENTTC5jaGVja05lc3RlZEJyYWNlKHRoaXMpO1xuICAgIHZhciB1c2VfbGF5b3V0X3ByZWZpeCA9IHRoaXMub3V0cHV0LmNoZWNrTmVzdGVkQnJhY2UudXBkYXRlKHRoaXMuY2l0YXRpb24ub3B0LmxheW91dF9wcmVmaXgpO1xuICAgIHZhciBzdXBwcmVzc1RyYWlsaW5nUHVuY3R1YXRpb24gPSBmYWxzZTtcbiAgICBpZiAodGhpcy5vcHQueGNsYXNzID09PSBcIm5vdGVcIiAmJiB0aGlzLmNpdGF0aW9uLm9wdC5zdXBwcmVzc1RyYWlsaW5nUHVuY3R1YXRpb24pIHtcbiAgICAgICAgc3VwcHJlc3NUcmFpbGluZ1B1bmN0dWF0aW9uID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGNpdGF0aW9uSUQpIHtcbiAgICAgICAgaWYgKHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25CeUlkW2NpdGF0aW9uSURdLnByb3BlcnRpZXNbXCJzdXBwcmVzcy10cmFpbGluZy1wdW5jdHVhdGlvblwiXSkge1xuICAgICAgICAgICAgc3VwcHJlc3NUcmFpbGluZ1B1bmN0dWF0aW9uID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5vcHQueGNsYXNzID09PSBcIm5vdGVcIikge1xuICAgICAgICB2YXIgcGFyYXNldHMgPSBbXTtcbiAgICAgICAgdmFyIGxhc3RUaXRsZSA9IGZhbHNlO1xuICAgICAgICB2YXIgbGFzdFBvc2l0aW9uID0gZmFsc2U7XG4gICAgICAgIHZhciBsYXN0SUQgPSBmYWxzZTtcbiAgICAgICAgdmFyIGxzdCA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpPTAsIGlsZW4gPSBpbnB1dExpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICB2YXIgdHlwZSA9IGlucHV0TGlzdFtpXVswXS50eXBlO1xuICAgICAgICAgICAgdmFyIHRpdGxlID0gaW5wdXRMaXN0W2ldWzBdLnRpdGxlO1xuICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gaW5wdXRMaXN0W2ldWzFdLnBvc2l0aW9uO1xuICAgICAgICAgICAgdmFyIGlkID0gaW5wdXRMaXN0W2ldWzBdLmlkO1xuICAgICAgICAgICAgaWYgKHRpdGxlICYmIHR5cGUgPT09IFwibGVnYWxfY2FzZVwiICYmIGlkICE9PSBsYXN0SUQgJiYgcG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAodGl0bGUgIT09IGxhc3RUaXRsZSB8fCBwYXJhc2V0cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbHN0ID0gW107XG4gICAgICAgICAgICAgICAgICAgIHBhcmFzZXRzLnB1c2gobHN0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbHN0LnB1c2goaW5wdXRMaXN0W2ldWzFdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxhc3RUaXRsZSA9IHRpdGxlO1xuICAgICAgICAgICAgbGFzdFBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgICAgICAgICBsYXN0SUQgPSBpZDtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGk9MCwgaWxlbj1wYXJhc2V0cy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGxzdCA9IHBhcmFzZXRzW2ldO1xuICAgICAgICAgICAgaWYgKGxzdC5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgbG9jYXRvckluTGFzdFBvc2l0aW9uID0gbHN0LnNsaWNlKC0xKVswXS5sb2NhdG9yO1xuICAgICAgICAgICAgaWYgKGxvY2F0b3JJbkxhc3RQb3NpdGlvbikge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGo9MCwgamxlbj1sc3QubGVuZ3RoIC0gMTsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAobHN0W2pdLmxvY2F0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0b3JJbkxhc3RQb3NpdGlvbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGxvY2F0b3JJbkxhc3RQb3NpdGlvbikge1xuICAgICAgICAgICAgICAgIGxzdFswXS5sb2NhdG9yID0gbG9jYXRvckluTGFzdFBvc2l0aW9uO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBsc3Quc2xpY2UoLTEpWzBdLmxvY2F0b3I7XG4gICAgICAgICAgICAgICAgbHN0WzBdLmxhYmVsID0gbHN0LnNsaWNlKC0xKVswXS5sYWJlbDtcbiAgICAgICAgICAgICAgICBpZiAobHN0LnNsaWNlKC0xKVswXS5sYWJlbCkge1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgbHN0LnNsaWNlKC0xKVswXS5sYWJlbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgfVxuICAgIH1cbiAgICBteXBhcmFtcyA9IFtdO1xuICAgIGxlbiA9IGlucHV0TGlzdC5sZW5ndGg7XG4gICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIEl0ZW0gPSBpbnB1dExpc3RbcG9zXVswXTtcbiAgICAgICAgaXRlbSA9IGlucHV0TGlzdFtwb3NdWzFdO1xuICAgICAgICBpdGVtID0gQ1NMLnBhcnNlTG9jYXRvci5jYWxsKHRoaXMsIGl0ZW0pO1xuICAgICAgICBsYXN0X2NvbGxhcHNlZCA9IHRoaXMudG1wLmhhdmVfY29sbGFwc2VkO1xuICAgICAgICB2YXIgbGFzdF9sb2NhdG9yID0gZmFsc2U7XG4gICAgICAgIGlmIChwb3MgPiAwICYmIGlucHV0TGlzdFtwb3MtMV1bMV0pIHtcbiAgICAgICAgICAgIGxhc3RfbG9jYXRvciA9ICEhaW5wdXRMaXN0W3Bvcy0xXVsxXS5sb2NhdG9yO1xuICAgICAgICB9XG4gICAgICAgIHBhcmFtcyA9IHt9O1xuICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVycyA9IHt9O1xuICAgICAgICBpZiAoIXRoaXMudG1wLmp1c3RfbG9va2luZyAmJiB0aGlzLm9wdC5oYXNQbGFjZWhvbGRlclRlcm0pIHtcbiAgICAgICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLm91dHB1dDtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0ID0gbmV3IENTTC5PdXRwdXQuUXVldWUodGhpcyk7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QgPSBuZXcgQ1NMLk91dHB1dC5RdWV1ZS5hZGp1c3QoKTtcbiAgICAgICAgICAgIENTTC5nZXRBbWJpZ3VvdXNDaXRlLmNhbGwodGhpcywgSXRlbSwgbnVsbCwgZmFsc2UsIGl0ZW0pO1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQgPSBvdXRwdXQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50bXAuaW5fY2l0ZV9wcmVkZWNlc3NvciA9IGZhbHNlO1xuICAgICAgICBpZiAocG9zID4gMCkge1xuICAgICAgICAgICAgQ1NMLmdldENpdGUuY2FsbCh0aGlzLCBJdGVtLCBpdGVtLCBcIlwiICsgaW5wdXRMaXN0Wyhwb3MgLSAxKV1bMF0uaWQsIHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50bXAudGVybV9wcmVkZWNlc3NvciA9IGZhbHNlO1xuICAgICAgICAgICAgQ1NMLmdldENpdGUuY2FsbCh0aGlzLCBJdGVtLCBpdGVtLCBudWxsLCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMudG1wLmNpdGVfcmVuZGVyc19jb250ZW50KSB7XG4gICAgICAgICAgICBlcnJvcl9vYmplY3QgPSB7XG4gICAgICAgICAgICAgICAgY2l0YXRpb25JRDogXCJcIiArIHRoaXMudG1wLmNpdGF0aW9uX2lkLFxuICAgICAgICAgICAgICAgIGluZGV4OiB0aGlzLnRtcC5jaXRhdGlvbl9wb3MsXG4gICAgICAgICAgICAgICAgbm90ZUluZGV4OiB0aGlzLnRtcC5jaXRhdGlvbl9ub3RlX2luZGV4LFxuICAgICAgICAgICAgICAgIGl0ZW1JRDogXCJcIiArIEl0ZW0uaWQsXG4gICAgICAgICAgICAgICAgY2l0YXRpb25JdGVtc19wb3M6IHBvcyxcbiAgICAgICAgICAgICAgICBlcnJvcl9jb2RlOiBDU0wuRVJST1JfTk9fUkVOREVSRURfRk9STVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMudG1wLmNpdGF0aW9uX2Vycm9ycy5wdXNoKGVycm9yX29iamVjdCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBvcyA9PT0gKGlucHV0TGlzdC5sZW5ndGggLSAxKSkge1xuICAgICAgICAgICAgdGhpcy5wYXJhbGxlbC5Db21wb3NlU2V0KCk7XG4gICAgICAgIH1cbiAgICAgICAgcGFyYW1zLnNwbGljZV9kZWxpbWl0ZXIgPSBDU0wuZ2V0U3BsaWNlRGVsaW1pdGVyLmNhbGwodGhpcywgbGFzdF9sb2NhdG9yLCBsYXN0X2NvbGxhcHNlZCwgcG9zKTtcbiAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbVtcImF1dGhvci1vbmx5XCJdKSB7XG4gICAgICAgICAgICB0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBvcyA+IDApIHtcbiAgICAgICAgICAgIHByZWNlZGluZ19pdGVtID0gaW5wdXRMaXN0W3BvcyAtIDFdWzFdO1xuICAgICAgICAgICAgdmFyIHByZWNlZGluZ0VuZHNJblBlcmlvZE9yQ29tbWEgPSBwcmVjZWRpbmdfaXRlbS5zdWZmaXggJiYgW1wiLlwiLCBcIixcIl0uaW5kZXhPZihwcmVjZWRpbmdfaXRlbS5zdWZmaXguc2xpY2UoLTEpKSA+IC0xO1xuICAgICAgICAgICAgdmFyIGN1cnJlbnRTdGFydHNXaXRoUGVyaW9kT3JDb21tYSA9ICFwcmVjZWRpbmdfaXRlbS5zdWZmaXggJiYgaXRlbS5wcmVmaXggJiYgW1wiLlwiLCBcIixcIl0uaW5kZXhPZihpdGVtLnByZWZpeC5zbGljZSgwLCAxKSkgPiAtMTtcbiAgICAgICAgICAgIGlmIChwcmVjZWRpbmdFbmRzSW5QZXJpb2RPckNvbW1hIHx8IGN1cnJlbnRTdGFydHNXaXRoUGVyaW9kT3JDb21tYSkge1xuICAgICAgICAgICAgICAgIHZhciBzcGFjZWlkeCA9IHBhcmFtcy5zcGxpY2VfZGVsaW1pdGVyLmluZGV4T2YoXCIgXCIpO1xuICAgICAgICAgICAgICAgIGlmIChzcGFjZWlkeCA+IC0xICYmICFjdXJyZW50U3RhcnRzV2l0aFBlcmlvZE9yQ29tbWEpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLnNwbGljZV9kZWxpbWl0ZXIgPSBwYXJhbXMuc3BsaWNlX2RlbGltaXRlci5zbGljZShzcGFjZWlkeCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLnNwbGljZV9kZWxpbWl0ZXIgPSBcIlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBwYXJhbXMuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSB0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucztcbiAgICAgICAgcGFyYW1zLmhhdmVfY29sbGFwc2VkID0gdGhpcy50bXAuaGF2ZV9jb2xsYXBzZWQ7XG4gICAgICAgIG15cGFyYW1zLnB1c2gocGFyYW1zKTtcbiAgICB9XG4gICAgdGhpcy50bXAuaGFzX3B1cmdlZF9wYXJhbGxlbCA9IGZhbHNlO1xuICAgIHRoaXMucGFyYWxsZWwuUHJ1bmVPdXRwdXRRdWV1ZSh0aGlzKTtcbiAgICBlbXB0aWVzID0gMDtcbiAgICBteWJsb2JzID0gdGhpcy5vdXRwdXQucXVldWUuc2xpY2UoKTtcbiAgICB2YXIgZmFrZWJsb2IgPSB7XG4gICAgICAgIHN0cmluZ3M6IHtcbiAgICAgICAgICAgIHN1ZmZpeDogdGhpcy5jaXRhdGlvbi5vcHQubGF5b3V0X3N1ZmZpeCxcbiAgICAgICAgICAgIGRlbGltaXRlcjogdGhpcy5jaXRhdGlvbi5vcHQubGF5b3V0X2RlbGltaXRlciAgICAgICAgICAgICAgICBcbiAgICAgICAgfVxuICAgIH07XG4gICAgdmFyIHN1ZmZpeCA9IHRoaXMuY2l0YXRpb24ub3B0LmxheW91dF9zdWZmaXg7XG4gICAgdmFyIGxhc3RfbG9jYWxlID0gdGhpcy50bXAuY2l0ZV9sb2NhbGVzW3RoaXMudG1wLmNpdGVfbG9jYWxlcy5sZW5ndGggLSAxXTtcbiAgICBpZiAobGFzdF9sb2NhbGUgJiYgdGhpcy50bXAuY2l0ZV9hZmZpeGVzW3RoaXMudG1wLmFyZWFdW2xhc3RfbG9jYWxlXSAmJiB0aGlzLnRtcC5jaXRlX2FmZml4ZXNbdGhpcy50bXAuYXJlYV1bbGFzdF9sb2NhbGVdLnN1ZmZpeCkge1xuICAgICAgICBzdWZmaXggPSB0aGlzLnRtcC5jaXRlX2FmZml4ZXNbdGhpcy50bXAuYXJlYV1bbGFzdF9sb2NhbGVdLnN1ZmZpeDtcbiAgICB9XG4gICAgaWYgKENTTC5URVJNSU5BTF9QVU5DVFVBVElPTi5zbGljZSgwLCAtMSkuaW5kZXhPZihzdWZmaXguc2xpY2UoMCwgMSkpID4gLTEpIHtcbiAgICAgICAgc3VmZml4ID0gc3VmZml4LnNsaWNlKDAsIDEpO1xuICAgIH1cbiAgICB2YXIgZGVsaW1pdGVyID0gdGhpcy5jaXRhdGlvbi5vcHQubGF5b3V0X2RlbGltaXRlcjtcbiAgICBpZiAoIWRlbGltaXRlcikge1xuICAgICAgICBkZWxpbWl0ZXIgPSBcIlwiO1xuICAgIH1cbiAgICBpZiAoQ1NMLlRFUk1JTkFMX1BVTkNUVUFUSU9OLnNsaWNlKDAsIC0xKS5pbmRleE9mKGRlbGltaXRlci5zbGljZSgwLCAxKSkgPiAtMSkge1xuICAgICAgICBkZWxpbWl0ZXIgPSBkZWxpbWl0ZXIuc2xpY2UoMCwgMSk7XG4gICAgfVxuICAgIHN1ZmZpeCA9IHRoaXMub3V0cHV0LmNoZWNrTmVzdGVkQnJhY2UudXBkYXRlKHN1ZmZpeCk7XG4gICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy5vdXRwdXQucXVldWUubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgIENTTC5PdXRwdXQuUXVldWUucHVyZ2VFbXB0eUJsb2JzKHRoaXMub3V0cHV0LnF1ZXVlW2ldKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucyAmJiB0aGlzLm91dHB1dC5xdWV1ZS5sZW5ndGgpIHtcbiAgICAgICAgaWYgKCEodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5hcHBseV9jaXRhdGlvbl93cmFwcGVyXG4gICAgICAgICAgICAgICYmIHRoaXMuc3lzLndyYXBDaXRhdGlvbkVudHJ5XG4gICAgICAgICAgICAgICAmJiAhdGhpcy50bXAuanVzdF9sb29raW5nXG4gICAgICAgICAgICAgICYmIHRoaXMudG1wLmFyZWEgPT09IFwiY2l0YXRpb25cIikpIHsgXG4gICAgICAgICAgICBpZiAoIXN1cHByZXNzVHJhaWxpbmdQdW5jdHVhdGlvbikge1xuICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0LnF1ZXVlW3RoaXMub3V0cHV0LnF1ZXVlLmxlbmd0aCAtIDFdLnN0cmluZ3Muc3VmZml4ID0gc3VmZml4O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5vdXRwdXQucXVldWVbMF0uc3RyaW5ncy5wcmVmaXggPSB1c2VfbGF5b3V0X3ByZWZpeDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5jbGVhbl91cF9jc2xfZmxhd3MpIHtcbiAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49dGhpcy5vdXRwdXQucXVldWUubGVuZ3RoO2o8amxlbjtqKz0xKSB7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QudXB3YXJkKHRoaXMub3V0cHV0LnF1ZXVlW2pdKTtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0LmFkanVzdC5sZWZ0d2FyZCh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QuZG93bndhcmQodGhpcy5vdXRwdXQucXVldWVbal0pO1xuICAgICAgICAgICAgdGhpcy50bXAubGFzdF9jaHIgPSB0aGlzLm91dHB1dC5hZGp1c3QuZml4KHRoaXMub3V0cHV0LnF1ZXVlW2pdKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IG15YmxvYnMubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIHZhciBidWZmZXIgPSBbXTtcbiAgICAgICAgdGhpcy5vdXRwdXQucXVldWUgPSBbbXlibG9ic1twb3NdXTtcbiAgICAgICAgdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSBteXBhcmFtc1twb3NdLnN1cHByZXNzX2RlY29yYXRpb25zO1xuICAgICAgICB0aGlzLnRtcC5zcGxpY2VfZGVsaW1pdGVyID0gbXlwYXJhbXNbcG9zXS5zcGxpY2VfZGVsaW1pdGVyO1xuICAgICAgICBpZiAobXlibG9ic1twb3NdLnBhcmFsbGVsX2RlbGltaXRlcikge1xuICAgICAgICAgICAgdGhpcy50bXAuc3BsaWNlX2RlbGltaXRlciA9IG15YmxvYnNbcG9zXS5wYXJhbGxlbF9kZWxpbWl0ZXI7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50bXAuaGF2ZV9jb2xsYXBzZWQgPSBteXBhcmFtc1twb3NdLmhhdmVfY29sbGFwc2VkO1xuICAgICAgICBjb21wb3NpdGUgPSB0aGlzLm91dHB1dC5zdHJpbmcodGhpcywgdGhpcy5vdXRwdXQucXVldWUpO1xuICAgICAgICB0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucyA9IGZhbHNlO1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGNvbXBvc2l0ZSkge1xuICAgICAgICAgICAgdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSBmYWxzZTtcbiAgICAgICAgICAgIHJldHVybiBjb21wb3NpdGU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwib2JqZWN0XCIgPT09IHR5cGVvZiBjb21wb3NpdGUgJiYgY29tcG9zaXRlLmxlbmd0aCA9PT0gMCAmJiAhaXRlbVtcInN1cHByZXNzLWF1dGhvclwiXSkge1xuICAgICAgICAgICAgaWYgKHRoaXMudG1wLmhhc19wdXJnZWRfcGFyYWxsZWwpIHtcbiAgICAgICAgICAgICAgICBjb21wb3NpdGUucHVzaChcIlwiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIGVyclN0ciA9IFwiW0NTTCBTVFlMRSBFUlJPUjogcmVmZXJlbmNlIHdpdGggbm8gcHJpbnRlZCBmb3JtLl1cIjtcbiAgICAgICAgICAgICAgICB2YXIgcHJlU3RyID0gcG9zID09PSAwID8gdHh0X2VzYyh0aGlzLmNpdGF0aW9uLm9wdC5sYXlvdXRfcHJlZml4KSA6IFwiXCI7XG4gICAgICAgICAgICAgICAgdmFyIHN1ZlN0ciA9IHBvcyA9PT0gKG15YmxvYnMubGVuZ3RoIC0gMSkgPyB0eHRfZXNjKHRoaXMuY2l0YXRpb24ub3B0LmxheW91dF9zdWZmaXgpIDogXCJcIjtcbiAgICAgICAgICAgICAgICBjb21wb3NpdGUucHVzaChwcmVTdHIgKyBlcnJTdHIgKyBzdWZTdHIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChidWZmZXIubGVuZ3RoICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiBjb21wb3NpdGVbMF0pIHtcbiAgICAgICAgICAgIGNvbXBvc2l0ZS5yZXZlcnNlKCk7XG4gICAgICAgICAgICB2YXIgdG1wc3RyID0gY29tcG9zaXRlLnBvcCgpO1xuICAgICAgICAgICAgaWYgKHRtcHN0ciAmJiB0bXBzdHIuc2xpY2UoMCwgMSkgPT09IFwiLFwiKSB7XG4gICAgICAgICAgICAgICAgYnVmZmVyLnB1c2godG1wc3RyKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJzdHJpbmdcIiA9PSB0eXBlb2YgYnVmZmVyLnNsaWNlKC0xKVswXSAmJiBidWZmZXIuc2xpY2UoLTEpWzBdLnNsaWNlKC0xKSA9PT0gXCIsXCIpIHtcbiAgICAgICAgICAgICAgICBidWZmZXIucHVzaChcIiBcIiArIHRtcHN0cik7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRtcHN0cikge1xuICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKHR4dF9lc2ModGhpcy50bXAuc3BsaWNlX2RlbGltaXRlcikgKyB0bXBzdHIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29tcG9zaXRlLnJldmVyc2UoKTtcbiAgICAgICAgICAgIGNvbXBpZSA9IGNvbXBvc2l0ZS5wb3AoKTtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgY29tcGllKSB7XG4gICAgICAgICAgICAgICAgaWYgKGJ1ZmZlci5sZW5ndGggJiYgXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJ1ZmZlcltidWZmZXIubGVuZ3RoIC0gMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgYnVmZmVyW2J1ZmZlci5sZW5ndGggLSAxXSArPSBjb21waWUuc3VjY2Vzc29yX3ByZWZpeDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goY29tcGllKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsbGVuID0gY29tcG9zaXRlLmxlbmd0aDtcbiAgICAgICAgZm9yIChwcG9zID0gMDsgcHBvcyA8IGxsZW47IHBwb3MgKz0gMSkge1xuICAgICAgICAgICAgb2JqID0gY29tcG9zaXRlW3Bwb3NdO1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBvYmopIHtcbiAgICAgICAgICAgICAgICBidWZmZXIucHVzaCh0eHRfZXNjKHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIpICsgb2JqKTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbXBpZSA9IGNvbXBvc2l0ZS5wb3AoKTtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgY29tcGllKSB7XG4gICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goY29tcGllKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoYnVmZmVyLmxlbmd0aCA9PT0gMCAmJiAhaW5wdXRMaXN0W3Bvc11bMV1bXCJzdXBwcmVzcy1hdXRob3JcIl0pIHtcbiAgICAgICAgICAgIGVtcHRpZXMgKz0gMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYnVmZmVyLmxlbmd0aCA+IDEgJiYgdHlwZW9mIGJ1ZmZlclswXSAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgYnVmZmVyID0gW3RoaXMub3V0cHV0LnJlbmRlckJsb2JzKGJ1ZmZlcildO1xuICAgICAgICB9XG4gICAgICAgIGlmIChidWZmZXIubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJ1ZmZlclswXSkge1xuICAgICAgICAgICAgICAgIGlmIChwb3MgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlclswXSA9IHR4dF9lc2ModGhpcy50bXAuc3BsaWNlX2RlbGltaXRlcikgKyBidWZmZXJbMF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocG9zID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBidWZmZXJbMF0uc3BsaWNlX3ByZWZpeCA9IHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYnVmZmVyWzBdLnNwbGljZV9wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBvYmplY3RzID0gb2JqZWN0cy5jb25jYXQoYnVmZmVyKTtcbiAgICB9XG4gICAgcmVzdWx0ICs9IHRoaXMub3V0cHV0LnJlbmRlckJsb2JzKG9iamVjdHMpO1xuICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgaWYgKCF0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgbGVuID0gdGhpcy5jaXRhdGlvbi5vcHQubGF5b3V0X2RlY29yYXRpb25zLmxlbmd0aDtcbiAgICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgIHBhcmFtcyA9IHRoaXMuY2l0YXRpb24ub3B0LmxheW91dF9kZWNvcmF0aW9uc1twb3NdO1xuICAgICAgICAgICAgICAgIGlmIChwYXJhbXNbMV0gPT09IFwibm9ybWFsXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghaXRlbSB8fCAhaXRlbVtcImF1dGhvci1vbmx5XCJdKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMuZnVuLmRlY29yYXRlW3BhcmFtc1swXV1bcGFyYW1zWzFdXSh0aGlzLCByZXN1bHQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucyA9IGZhbHNlO1xuICAgIHJldHVybiByZXN1bHQ7XG59O1xuQ1NMLmdldENpdGUgPSBmdW5jdGlvbiAoSXRlbSwgaXRlbSwgcHJldkl0ZW1JRCwgYmxvY2tTaGFkb3dOdW1iZXJSZXNldCkge1xuICAgIHZhciBuZXh0LCBlcnJvcl9vYmplY3Q7XG4gICAgdGhpcy50bXAuY2l0ZV9yZW5kZXJzX2NvbnRlbnQgPSBmYWxzZTtcbiAgICB0aGlzLnBhcmFsbGVsLlN0YXJ0Q2l0ZShJdGVtLCBpdGVtLCBwcmV2SXRlbUlEKTtcbiAgICBDU0wuY2l0ZVN0YXJ0LmNhbGwodGhpcywgSXRlbSwgaXRlbSwgYmxvY2tTaGFkb3dOdW1iZXJSZXNldCk7XG4gICAgbmV4dCA9IDA7XG4gICAgdGhpcy50bXAubmFtZV9ub2RlID0ge307XG4gICAgdGhpcy5uYW1lT3V0cHV0ID0gbmV3IENTTC5OYW1lT3V0cHV0KHRoaXMsIEl0ZW0sIGl0ZW0pO1xuICAgIHdoaWxlIChuZXh0IDwgdGhpc1t0aGlzLnRtcC5hcmVhXS50b2tlbnMubGVuZ3RoKSB7XG4gICAgICAgIG5leHQgPSBDU0wudG9rZW5FeGVjLmNhbGwodGhpcywgdGhpc1t0aGlzLnRtcC5hcmVhXS50b2tlbnNbbmV4dF0sIEl0ZW0sIGl0ZW0pO1xuICAgIH1cbiAgICBDU0wuY2l0ZUVuZC5jYWxsKHRoaXMsIEl0ZW0sIGl0ZW0pO1xuICAgIHRoaXMucGFyYWxsZWwuQ2xvc2VDaXRlKHRoaXMpO1xuICAgIGlmICghdGhpcy50bXAuY2l0ZV9yZW5kZXJzX2NvbnRlbnQgJiYgIXRoaXMudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICBpZiAodGhpcy50bXAuYXJlYSA9PT0gXCJiaWJsaW9ncmFwaHlcIikge1xuICAgICAgICAgICAgZXJyb3Jfb2JqZWN0ID0ge1xuICAgICAgICAgICAgICAgIGluZGV4OiB0aGlzLnRtcC5iaWJsaW9ncmFwaHlfcG9zLFxuICAgICAgICAgICAgICAgIGl0ZW1JRDogXCJcIiArIEl0ZW0uaWQsXG4gICAgICAgICAgICAgICAgZXJyb3JfY29kZTogQ1NMLkVSUk9SX05PX1JFTkRFUkVEX0ZPUk1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLnRtcC5iaWJsaW9ncmFwaHlfZXJyb3JzLnB1c2goZXJyb3Jfb2JqZWN0KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gXCJcIiArIEl0ZW0uaWQ7XG59O1xuQ1NMLmNpdGVTdGFydCA9IGZ1bmN0aW9uIChJdGVtLCBpdGVtLCBibG9ja1NoYWRvd051bWJlclJlc2V0KSB7XG4gICAgaWYgKCFibG9ja1NoYWRvd051bWJlclJlc2V0KSB7XG4gICAgICAgIHRoaXMudG1wLnNoYWRvd19udW1iZXJzID0ge307XG4gICAgfVxuICAgIHRoaXMudG1wLmRpc2FtYmlndWF0ZV9jb3VudCA9IDA7XG4gICAgdGhpcy50bXAuZGlzYW1iaWd1YXRlX21heE1heCA9IDA7XG4gICAgdGhpcy50bXAuc2FtZV9hdXRob3JfYXNfcHJldmlvdXNfY2l0ZSA9IGZhbHNlO1xuICAgIGlmICghdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgdGhpcy50bXAuc3Vic2VxdWVudF9hdXRob3Jfc3Vic3RpdHV0ZV9vayA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy50bXAuc3Vic2VxdWVudF9hdXRob3Jfc3Vic3RpdHV0ZV9vayA9IGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLnRtcC5sYXN0Y2hyID0gXCJcIjtcbiAgICBpZiAodGhpcy50bXAuYXJlYSA9PT0gXCJjaXRhdGlvblwiICYmIHRoaXMuY2l0YXRpb24ub3B0LmNvbGxhcHNlICYmIHRoaXMuY2l0YXRpb24ub3B0LmNvbGxhcHNlLmxlbmd0aCkge1xuICAgICAgICB0aGlzLnRtcC5oYXZlX2NvbGxhcHNlZCA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy50bXAuaGF2ZV9jb2xsYXBzZWQgPSBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy50bXAucmVuZGVyX3NlZW4gPSBmYWxzZTtcbiAgICBpZiAodGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdCAgJiYgISB0aGlzLnRtcC5kaXNhbWJpZ19vdmVycmlkZSkge1xuICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19zZXR0aW5ncyA9IHRoaXMudG1wLmRpc2FtYmlnX3JlcXVlc3Q7XG4gICAgfSBlbHNlIGlmICh0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdICYmICEgdGhpcy50bXAuZGlzYW1iaWdfb3ZlcnJpZGUpIHtcbiAgICAgICAgdGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdCA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWc7XG4gICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZztcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19zZXR0aW5ncyA9IG5ldyBDU0wuQW1iaWdDb25maWcoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMudG1wLmFyZWEgIT09ICdjaXRhdGlvbicpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdKSB7XG4gICAgICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19yZXN0b3JlID0gbmV3IENTTC5BbWJpZ0NvbmZpZygpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50bXAuZGlzYW1iaWdfcmVzdG9yZSA9IENTTC5jbG9uZUFtYmlnQ29uZmlnKHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcpO1xuICAgICAgICAgICAgaWYgKHRoaXMudG1wLmFyZWEgPT09ICdiaWJsaW9ncmFwaHknICYmIHRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzICYmIHRoaXMudG1wLmRpc2FtYmlnX292ZXJyaWRlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC1uYW1lc1wiXSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5uYW1lcyA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcubmFtZXMuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudG1wLmRpc2FtYmlnX3JlcXVlc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3JlcXVlc3QubmFtZXMgPSB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLm5hbWVzLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC1naXZlbm5hbWVcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdCA9IHRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnMgPSB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLmdpdmVucy5zbGljZSgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19yZXF1ZXN0LmdpdmVucyA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZ2l2ZW5zLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVucy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVuc1tpXSA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZ2l2ZW5zW2ldLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdC5naXZlbnMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19yZXF1ZXN0LmdpdmVuc1tpXSA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZ2l2ZW5zW2ldLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy50bXAubmFtZXNfdXNlZCA9IFtdO1xuICAgIHRoaXMudG1wLm5hbWVzZXRfY291bnRlciA9IDA7XG4gICAgdGhpcy50bXAueWVhcnNfdXNlZCA9IFtdO1xuICAgIHRoaXMudG1wLm5hbWVzX21heC5jbGVhcigpO1xuICAgIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSB0aGlzW3RoaXMudG1wLmFyZWFdLm9wdC5sYXlvdXRfZGVsaW1pdGVyO1xuICAgIHRoaXMuYmlibGlvZ3JhcGh5X3NvcnQua2V5cyA9IFtdO1xuICAgIHRoaXMuY2l0YXRpb25fc29ydC5rZXlzID0gW107XG4gICAgdGhpcy50bXAuaGFzX2RvbmVfeWVhcl9zdWZmaXggPSBmYWxzZTtcbiAgICB0aGlzLnRtcC5sYXN0X2NpdGVfbG9jYWxlID0gZmFsc2U7XG4gICAgaWYgKCF0aGlzLnRtcC5qdXN0X2xvb2tpbmcgJiYgaXRlbSAmJiAhaXRlbS5wb3NpdGlvbiAmJiB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdKSB7XG4gICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3Jlc3RvcmUgPSBDU0wuY2xvbmVBbWJpZ0NvbmZpZyh0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnKTtcbiAgICB9XG4gICAgdGhpcy50bXAuZmlyc3RfbmFtZV9zdHJpbmcgPSBmYWxzZTtcbiAgICB0aGlzLnRtcC5hdXRob3JpdHlfc3RvcF9sYXN0ID0gMDtcbn07XG5DU0wuY2l0ZUVuZCA9IGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgaWYgKHRoaXMudG1wLmRpc2FtYmlnX3Jlc3RvcmUgJiYgdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXSkge1xuICAgICAgICB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLm5hbWVzID0gdGhpcy50bXAuZGlzYW1iaWdfcmVzdG9yZS5uYW1lcy5zbGljZSgpO1xuICAgICAgICB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLmdpdmVucyA9IHRoaXMudG1wLmRpc2FtYmlnX3Jlc3RvcmUuZ2l2ZW5zLnNsaWNlKCk7XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZ2l2ZW5zLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5naXZlbnNbaV0gPSB0aGlzLnRtcC5kaXNhbWJpZ19yZXN0b3JlLmdpdmVuc1tpXS5zbGljZSgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudG1wLmRpc2FtYmlnX3Jlc3RvcmUgPSBmYWxzZTtcbiAgICBpZiAoaXRlbSAmJiBpdGVtLnN1ZmZpeCkge1xuICAgICAgICB0aGlzLnRtcC5sYXN0X3N1ZmZpeF91c2VkID0gaXRlbS5zdWZmaXg7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy50bXAubGFzdF9zdWZmaXhfdXNlZCA9IFwiXCI7XG4gICAgfVxuICAgIHRoaXMudG1wLmxhc3RfeWVhcnNfdXNlZCA9IHRoaXMudG1wLnllYXJzX3VzZWQuc2xpY2UoKTtcbiAgICB0aGlzLnRtcC5sYXN0X25hbWVzX3VzZWQgPSB0aGlzLnRtcC5uYW1lc191c2VkLnNsaWNlKCk7XG4gICAgdGhpcy50bXAuY3V0X3ZhciA9IGZhbHNlO1xuICAgIHRoaXMudG1wLmRpc2FtYmlnX3JlcXVlc3QgPSBmYWxzZTtcbiAgICB0aGlzLnRtcC5jaXRlX2xvY2FsZXMucHVzaCh0aGlzLnRtcC5sYXN0X2NpdGVfbG9jYWxlKTtcbiAgICBpZiAodGhpcy50bXAuaXNzdWVkX2RhdGUgJiYgdGhpcy50bXAucmVuZGVyc19jb2xsZWN0aW9uX251bWJlcikge1xuICAgICAgICB2YXIgYnVmID0gW107XG4gICAgICAgIGZvciAodmFyIGkgPSB0aGlzLnRtcC5pc3N1ZWRfZGF0ZS5saXN0Lmxlbmd0aCAtIDE7IGkgPiB0aGlzLnRtcC5pc3N1ZWRfZGF0ZS5wb3M7IGkgKz0gLTEpIHtcbiAgICAgICAgICAgIGJ1Zi5wdXNoKHRoaXMudG1wLmlzc3VlZF9kYXRlLmxpc3QucG9wKCkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudG1wLmlzc3VlZF9kYXRlLmxpc3QucG9wKCk7XG4gICAgICAgIGZvciAoaSA9IGJ1Zi5sZW5ndGggLSAxOyBpID4gLTE7IGkgKz0gLTEpIHtcbiAgICAgICAgICAgIHRoaXMudG1wLmlzc3VlZF9kYXRlLmxpc3QucHVzaChidWYucG9wKCkpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMpIHtcbiAgICAgICAgICAgIHRoaXMucGFyYWxsZWwuY2l0ZVtcImlzc3VlZFwiXSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudG1wLmlzc3VlZF9kYXRlID0gZmFsc2U7XG4gICAgdGhpcy50bXAucmVuZGVyc19jb2xsZWN0aW9uX251bWJlciA9IGZhbHNlO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUubWFrZUJpYmxpb2dyYXBoeSA9IGZ1bmN0aW9uIChiaWJzZWN0aW9uKSB7XG4gICAgdmFyIGRlYnVnLCByZXQsIHBhcmFtcywgbWF4b2Zmc2V0LCBpdGVtLCBsZW4sIHBvcywgdG9rLCB0b2trLCB0b2traywgZW50cnlfaWRzLCBlbnRyeV9zdHJpbmdzLCBiaWJsaW9ncmFwaHlfZXJyb3JzO1xuICAgIGRlYnVnID0gZmFsc2U7XG4gICAgaWYgKCF0aGlzLmJpYmxpb2dyYXBoeS50b2tlbnMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBiaWJzZWN0aW9uKSB7XG4gICAgICAgIHRoaXMub3B0LmNpdGF0aW9uX251bWJlcl9zbHVnID0gYmlic2VjdGlvbjtcbiAgICAgICAgYmlic2VjdGlvbiA9IGZhbHNlO1xuICAgIH1cbiAgICByZXQgPSBDU0wuZ2V0QmlibGlvZ3JhcGh5RW50cmllcy5jYWxsKHRoaXMsIGJpYnNlY3Rpb24pO1xuICAgIGVudHJ5X2lkcyA9IHJldFswXTtcbiAgICBlbnRyeV9zdHJpbmdzID0gcmV0WzFdO1xuICAgIHZhciBkb25lID0gcmV0WzJdO1xuICAgIHBhcmFtcyA9IHtcbiAgICAgICAgXCJtYXhvZmZzZXRcIjogMCxcbiAgICAgICAgXCJlbnRyeXNwYWNpbmdcIjogdGhpcy5iaWJsaW9ncmFwaHkub3B0W1wiZW50cnktc3BhY2luZ1wiXSxcbiAgICAgICAgXCJsaW5lc3BhY2luZ1wiOiB0aGlzLmJpYmxpb2dyYXBoeS5vcHRbXCJsaW5lLXNwYWNpbmdcIl0sXG4gICAgICAgIFwic2Vjb25kLWZpZWxkLWFsaWduXCI6IGZhbHNlLFxuICAgICAgICBcImVudHJ5X2lkc1wiOiBlbnRyeV9pZHMsXG4gICAgICAgIFwiYmlibGlvZ3JhcGh5X2Vycm9yc1wiOiB0aGlzLnRtcC5iaWJsaW9ncmFwaHlfZXJyb3JzLnNsaWNlKCksXG4gICAgICAgIFwiZG9uZVwiOiBkb25lXG4gICAgfTtcbiAgICBpZiAodGhpcy5iaWJsaW9ncmFwaHkub3B0W1wic2Vjb25kLWZpZWxkLWFsaWduXCJdKSB7XG4gICAgICAgIHBhcmFtc1tcInNlY29uZC1maWVsZC1hbGlnblwiXSA9IHRoaXMuYmlibGlvZ3JhcGh5Lm9wdFtcInNlY29uZC1maWVsZC1hbGlnblwiXTtcbiAgICB9XG4gICAgbWF4b2Zmc2V0ID0gMDtcbiAgICBsZW4gPSB0aGlzLnJlZ2lzdHJ5LnJlZmxpc3QubGVuZ3RoO1xuICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBpdGVtID0gdGhpcy5yZWdpc3RyeS5yZWZsaXN0W3Bvc107XG4gICAgICAgIGlmIChpdGVtLm9mZnNldCA+IHBhcmFtcy5tYXhvZmZzZXQpIHtcbiAgICAgICAgICAgIHBhcmFtcy5tYXhvZmZzZXQgPSBpdGVtLm9mZnNldDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5iaWJsaW9ncmFwaHkub3B0LmhhbmdpbmdpbmRlbnQpIHtcbiAgICAgICAgcGFyYW1zLmhhbmdpbmdpbmRlbnQgPSB0aGlzLmJpYmxpb2dyYXBoeS5vcHQuaGFuZ2luZ2luZGVudDtcbiAgICB9XG4gICAgcGFyYW1zLmJpYnN0YXJ0ID0gdGhpcy5mdW4uZGVjb3JhdGUuYmlic3RhcnQ7XG4gICAgcGFyYW1zLmJpYmVuZCA9IHRoaXMuZnVuLmRlY29yYXRlLmJpYmVuZDtcbiAgICB0aGlzLm9wdC5jaXRhdGlvbl9udW1iZXJfc2x1ZyA9IGZhbHNlO1xuICAgIHJldHVybiBbcGFyYW1zLCBlbnRyeV9zdHJpbmdzXTtcbn07XG5DU0wuZ2V0QmlibGlvZ3JhcGh5RW50cmllcyA9IGZ1bmN0aW9uIChiaWJzZWN0aW9uKSB7XG4gICAgdmFyIHJldCwgaW5wdXQsIGluY2x1ZGUsIGFueW1hdGNoLCBhbGxtYXRjaCwgYmliX2VudHJ5LCByZXMsIGxlbiwgcG9zLCBpdGVtLCBsbGVuLCBwcG9zLCBzcGVjLCBsbGxlbiwgcHBwb3MsIGJpYl9sYXlvdXQsIHRvcGJsb2JzLCBhbGxfaXRlbV9pZHMsIGVudHJ5X2l0ZW1faWRzLCBkZWJ1ZywgY29sbGFwc2VfcGFyYWxsZWwsIGksIGlsZW4sIHNpYmxpbmdzLCBza2lwcywgc29ydGVkSXRlbXMsIGV5ZXRlbSwgY2hyLCBlbnRyeV9pdGVtX2RhdGEsIGosIGpsZW4sIG5ld0lEcywgb3JpZ2luYWxJRHM7XG4gICAgcmV0ID0gW107XG4gICAgZW50cnlfaXRlbV9kYXRhID0gW107XG4gICAgdGhpcy50bXAuYXJlYSA9IFwiYmlibGlvZ3JhcGh5XCI7XG4gICAgdGhpcy50bXAucm9vdCA9IFwiYmlibGlvZ3JhcGh5XCI7XG4gICAgdGhpcy50bXAubGFzdF9yZW5kZXJlZF9uYW1lID0gZmFsc2U7XG4gICAgdGhpcy50bXAuYmlibGlvZ3JhcGh5X2Vycm9ycyA9IFtdO1xuICAgIHRoaXMudG1wLmJpYmxpb2dyYXBoeV9wb3MgPSAwO1xuICAgIGlmIChiaWJzZWN0aW9uICYmIGJpYnNlY3Rpb24ucGFnZV9zdGFydCAmJiBiaWJzZWN0aW9uLnBhZ2VfbGVuZ3RoKSB7XG4gICAgICAgIGlucHV0ID0gdGhpcy5yZWdpc3RyeS5nZXRTb3J0ZWRJZHMoKTsgICAgICAgIFxuICAgIH0gZWxzZSB7XG4gICAgICAgIGlucHV0ID0gdGhpcy5yZXRyaWV2ZUl0ZW1zKHRoaXMucmVnaXN0cnkuZ2V0U29ydGVkSWRzKCkpO1xuICAgIH1cbiAgICB0aGlzLnRtcC5kaXNhbWJpZ19vdmVycmlkZSA9IHRydWU7XG4gICAgZnVuY3Rpb24gZXZhbF9zdHJpbmcoYSwgYikge1xuICAgICAgICBpZiAoYSA9PT0gYikge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmdW5jdGlvbiBldmFsX2xpc3QoYSwgbHN0KSB7XG4gICAgICAgIGxsbGVuID0gbHN0Lmxlbmd0aDtcbiAgICAgICAgZm9yIChwcHBvcyA9IDA7IHBwcG9zIDwgbGxsZW47IHBwcG9zICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChldmFsX3N0cmluZyhhLCBsc3RbcHBwb3NdKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgZnVuY3Rpb24gZXZhbF9zcGVjKGEsIGIpIHtcbiAgICAgICAgaWYgKChhID09PSBcIm5vbmVcIiB8fCAhYSkgJiYgIWIpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgYikge1xuICAgICAgICAgICAgcmV0dXJuIGV2YWxfc3RyaW5nKGEsIGIpO1xuICAgICAgICB9IGVsc2UgaWYgKCFiKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZXZhbF9saXN0KGEsIGIpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHNraXBzID0ge307XG4gICAgdmFyIHBhZ2VfaXRlbV9jb3VudDtcbiAgICBpZiAoYmlic2VjdGlvbiAmJiBiaWJzZWN0aW9uLnBhZ2Vfc3RhcnQgJiYgYmlic2VjdGlvbi5wYWdlX2xlbmd0aCkge1xuICAgICAgICBwYWdlX2l0ZW1fY291bnQgPSAwO1xuICAgICAgICBpZiAoYmlic2VjdGlvbi5wYWdlX3N0YXJ0ICE9PSB0cnVlKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGlucHV0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIHNraXBzW2lucHV0W2ldXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKGJpYnNlY3Rpb24ucGFnZV9zdGFydCA9PSBpbnB1dFtpXSkge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHByb2Nlc3NlZF9pdGVtX2lkcyA9IFtdO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gaW5wdXQubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGlmIChiaWJzZWN0aW9uICYmIGJpYnNlY3Rpb24ucGFnZV9zdGFydCAmJiBiaWJzZWN0aW9uLnBhZ2VfbGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAoc2tpcHNbaW5wdXRbaV1dKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpdGVtID0gdGhpcy5yZXRyaWV2ZUl0ZW0oaW5wdXRbaV0pO1xuICAgICAgICAgICAgaWYgKHBhZ2VfaXRlbV9jb3VudCA9PT0gYmlic2VjdGlvbi5wYWdlX2xlbmd0aCkge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXRlbSA9IGlucHV0W2ldO1xuICAgICAgICAgICAgaWYgKHNraXBzW2l0ZW0uaWRdKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJpYnNlY3Rpb24pIHtcbiAgICAgICAgICAgIGluY2x1ZGUgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKGJpYnNlY3Rpb24uaW5jbHVkZSkge1xuICAgICAgICAgICAgICAgIGluY2x1ZGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gYmlic2VjdGlvbi5pbmNsdWRlLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBzcGVjID0gYmlic2VjdGlvbi5pbmNsdWRlW2pdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXZhbF9zcGVjKHNwZWMudmFsdWUsIGl0ZW1bc3BlYy5maWVsZF0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbmNsdWRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChiaWJzZWN0aW9uLmV4Y2x1ZGUpIHtcbiAgICAgICAgICAgICAgICBhbnltYXRjaCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBiaWJzZWN0aW9uLmV4Y2x1ZGUubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHNwZWMgPSBiaWJzZWN0aW9uLmV4Y2x1ZGVbal07XG4gICAgICAgICAgICAgICAgICAgIGlmIChldmFsX3NwZWMoc3BlYy52YWx1ZSwgaXRlbVtzcGVjLmZpZWxkXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFueW1hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhbnltYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBpbmNsdWRlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChiaWJzZWN0aW9uLnNlbGVjdCkge1xuICAgICAgICAgICAgICAgIGluY2x1ZGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBhbGxtYXRjaCA9IHRydWU7XG4gICAgICAgICAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IGJpYnNlY3Rpb24uc2VsZWN0Lmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBzcGVjID0gYmlic2VjdGlvbi5zZWxlY3Rbal07XG4gICAgICAgICAgICAgICAgICAgIGlmICghZXZhbF9zcGVjKHNwZWMudmFsdWUsIGl0ZW1bc3BlYy5maWVsZF0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxtYXRjaCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhbGxtYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBpbmNsdWRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYmlic2VjdGlvbi5xdWFzaCkge1xuICAgICAgICAgICAgICAgIGFsbG1hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gYmlic2VjdGlvbi5xdWFzaC5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgc3BlYyA9IGJpYnNlY3Rpb24ucXVhc2hbal07XG4gICAgICAgICAgICAgICAgICAgIGlmICghZXZhbF9zcGVjKHNwZWMudmFsdWUsIGl0ZW1bc3BlYy5maWVsZF0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxtYXRjaCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhbGxtYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBpbmNsdWRlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFpbmNsdWRlKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYmliX2VudHJ5ID0gbmV3IENTTC5Ub2tlbihcImdyb3VwXCIsIENTTC5TVEFSVCk7XG4gICAgICAgIGJpYl9lbnRyeS5kZWNvcmF0aW9ucyA9IFtbXCJAYmlibGlvZ3JhcGh5XCIsIFwiZW50cnlcIl1dLmNvbmNhdCh0aGlzLmJpYmxpb2dyYXBoeS5vcHQubGF5b3V0X2RlY29yYXRpb25zKTtcbiAgICAgICAgdGhpcy5vdXRwdXQuc3RhcnRUYWcoXCJiaWJfZW50cnlcIiwgYmliX2VudHJ5KTtcbiAgICAgICAgaWYgKGl0ZW0uc3lzdGVtX2lkICYmIHRoaXMuc3lzLmVtYmVkQmlibGlvZ3JhcGh5RW50cnkpIHtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5pdGVtX2lkID0gaXRlbS5zeXN0ZW1faWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5jdXJyZW50LnZhbHVlKCkuc3lzdGVtX2lkID0gaXRlbS5pZDtcbiAgICAgICAgfVxuICAgICAgICBzb3J0ZWRJdGVtcyA9IFtbe2lkOiBcIlwiICsgaXRlbS5pZH0sIGl0ZW1dXTtcbiAgICAgICAgZW50cnlfaXRlbV9pZHMgPSBbXTtcbiAgICAgICAgaWYgKHRoaXMucmVnaXN0cnkucmVnaXN0cnlbaXRlbS5pZF0ubWFzdGVyIFxuICAgICAgICAgICAgJiYgIShiaWJzZWN0aW9uICYmIGJpYnNlY3Rpb24ucGFnZV9zdGFydCAmJiBiaWJzZWN0aW9uLnBhZ2VfbGVuZ3RoKSkge1xuICAgICAgICAgICAgY29sbGFwc2VfcGFyYWxsZWwgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5wYXJhbGxlbC5TdGFydENpdGF0aW9uKHNvcnRlZEl0ZW1zKTtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0LnF1ZXVlWzBdLnN0cmluZ3MuZGVsaW1pdGVyID0gXCIsIFwiO1xuICAgICAgICAgICAgdGhpcy50bXAudGVybV9wcmVkZWNlc3NvciA9IGZhbHNlO1xuICAgICAgICAgICAgZW50cnlfaXRlbV9pZHMucHVzaChcIlwiICsgQ1NMLmdldENpdGUuY2FsbCh0aGlzLCBpdGVtKSk7XG4gICAgICAgICAgICBza2lwc1tpdGVtLmlkXSA9IHRydWU7XG4gICAgICAgICAgICBzaWJsaW5ncyA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbaXRlbS5pZF0uc2libGluZ3M7XG4gICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gc2libGluZ3MubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgdmFyIGsgPSB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2l0ZW0uaWRdLnNpYmxpbmdzW2pdO1xuICAgICAgICAgICAgICAgIGV5ZXRlbSA9IHRoaXMucmV0cmlldmVJdGVtKGspO1xuICAgICAgICAgICAgICAgIGVudHJ5X2l0ZW1faWRzLnB1c2goXCJcIiArIENTTC5nZXRDaXRlLmNhbGwodGhpcywgZXlldGVtKSk7XG4gICAgICAgICAgICAgICAgc2tpcHNbZXlldGVtLmlkXSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnBhcmFsbGVsLkNvbXBvc2VTZXQoKTtcbiAgICAgICAgICAgIHRoaXMucGFyYWxsZWwuUHJ1bmVPdXRwdXRRdWV1ZSgpO1xuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2l0ZW0uaWRdLnNpYmxpbmdzKSB7XG4gICAgICAgICAgICB0aGlzLnBhcmFsbGVsLlN0YXJ0Q2l0YXRpb24oc29ydGVkSXRlbXMpO1xuICAgICAgICAgICAgdGhpcy50bXAudGVybV9wcmVkZWNlc3NvciA9IGZhbHNlO1xuICAgICAgICAgICAgZW50cnlfaXRlbV9pZHMucHVzaChcIlwiICsgQ1NMLmdldENpdGUuY2FsbCh0aGlzLCBpdGVtKSk7XG4gICAgICAgICAgICBpZiAoYmlic2VjdGlvbiAmJiBiaWJzZWN0aW9uLnBhZ2Vfc3RhcnQgJiYgYmlic2VjdGlvbi5wYWdlX2xlbmd0aCkge1xuICAgICAgICAgICAgICAgIHBhZ2VfaXRlbV9jb3VudCArPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVudHJ5X2l0ZW1fZGF0YS5wdXNoKFwiXCIpO1xuICAgICAgICB0aGlzLnRtcC5iaWJsaW9ncmFwaHlfcG9zICs9IDE7XG4gICAgICAgIHByb2Nlc3NlZF9pdGVtX2lkcy5wdXNoKGVudHJ5X2l0ZW1faWRzKTtcbiAgICAgICAgdGhpcy5vdXRwdXQuZW5kVGFnKFwiYmliX2VudHJ5XCIpO1xuICAgICAgICBpZiAodGhpcy5vdXRwdXQucXVldWVbMF0uYmxvYnMubGVuZ3RoICYmIHRoaXMub3V0cHV0LnF1ZXVlWzBdLmJsb2JzWzBdLmJsb2JzLmxlbmd0aCkge1xuICAgICAgICAgICAgaWYgKGNvbGxhcHNlX3BhcmFsbGVsIHx8ICF0aGlzLm91dHB1dC5xdWV1ZVswXS5ibG9ic1swXS5ibG9ic1swXS5zdHJpbmdzKSB7XG4gICAgICAgICAgICAgICAgdG9wYmxvYnMgPSB0aGlzLm91dHB1dC5xdWV1ZVswXS5ibG9icztcbiAgICAgICAgICAgICAgICBjb2xsYXBzZV9wYXJhbGxlbCA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0b3BibG9icyA9IHRoaXMub3V0cHV0LnF1ZXVlWzBdLmJsb2JzWzBdLmJsb2JzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdG9wYmxvYnNbMF0uc3RyaW5ncy5wcmVmaXggPSB0aGlzLmJpYmxpb2dyYXBoeS5vcHQubGF5b3V0X3ByZWZpeCArIHRvcGJsb2JzWzBdLnN0cmluZ3MucHJlZml4O1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXRoaXMub3V0cHV0LnF1ZXVlLmxlbmd0aDtqPGpsZW47ais9MSkge1xuICAgICAgICAgICAgQ1NMLk91dHB1dC5RdWV1ZS5wdXJnZUVtcHR5QmxvYnModGhpcy5vdXRwdXQucXVldWVbal0pO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXRoaXMub3V0cHV0LnF1ZXVlLmxlbmd0aDtqPGpsZW47ais9MSkge1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQuYWRqdXN0LnVwd2FyZCh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QubGVmdHdhcmQodGhpcy5vdXRwdXQucXVldWVbal0pO1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQuYWRqdXN0LmRvd253YXJkKHRoaXMub3V0cHV0LnF1ZXVlW2pdLHRydWUpO1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQuYWRqdXN0LmZpeCh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHJlcyA9IHRoaXMub3V0cHV0LnN0cmluZyh0aGlzLCB0aGlzLm91dHB1dC5xdWV1ZSlbMF07XG4gICAgICAgIGlmICghcmVzICYmIHRoaXMub3B0LnVwZGF0ZV9tb2RlID09PSBDU0wuTlVNRVJJQykge1xuICAgICAgICAgICAgdmFyIGVyciA9IChyZXQubGVuZ3RoICsgMSkgKyBcIi4gW0NTTCBTVFlMRSBFUlJPUjogcmVmZXJlbmNlIHdpdGggbm8gcHJpbnRlZCBmb3JtLl1cIlxuICAgICAgICAgICAgcmVzID0gQ1NMLk91dHB1dC5Gb3JtYXRzW3RoaXMub3B0Lm1vZGVdW1wiQGJpYmxpb2dyYXBoeS9lbnRyeVwiXSh0aGlzLCBlcnIpIFxuICAgICAgICB9XG4gICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgIHJldC5wdXNoKHJlcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIGRvbmUgPSBmYWxzZTtcbiAgICBpZiAoYmlic2VjdGlvbiAmJiBiaWJzZWN0aW9uLnBhZ2Vfc3RhcnQgJiYgYmlic2VjdGlvbi5wYWdlX2xlbmd0aCkge1xuICAgICAgICB2YXIgbGFzdF9leHBlY3RlZF9pZCA9IGlucHV0LnNsaWNlKC0xKVswXTtcbiAgICAgICAgdmFyIGxhc3Rfc2Vlbl9pZCA9IHByb2Nlc3NlZF9pdGVtX2lkcy5zbGljZSgtMSlbMF07XG4gICAgICAgIGlmICghbGFzdF9leHBlY3RlZF9pZCB8fCAhbGFzdF9zZWVuX2lkIHx8IGxhc3RfZXhwZWN0ZWRfaWQgPT0gbGFzdF9zZWVuX2lkKSB7XG4gICAgICAgICAgICBkb25lID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnRtcC5kaXNhbWJpZ19vdmVycmlkZSA9IGZhbHNlO1xuICAgIHJldHVybiBbcHJvY2Vzc2VkX2l0ZW1faWRzLCByZXQsIGRvbmVdO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuc2V0Q2l0YXRpb25JZCA9IGZ1bmN0aW9uIChjaXRhdGlvbiwgZm9yY2UpIHtcbiAgICB2YXIgcmV0LCBpZCwgZGlyZWN0aW9uO1xuICAgIHJldCA9IGZhbHNlO1xuICAgIGlmICghY2l0YXRpb24uY2l0YXRpb25JRCB8fCBmb3JjZSkge1xuICAgICAgICBpZCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDAwMDAwMDAwMDAwMCk7XG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICBkaXJlY3Rpb24gPSAwO1xuICAgICAgICAgICAgaWYgKCF0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJZFtpZF0pIHtcbiAgICAgICAgICAgICAgICBjaXRhdGlvbi5jaXRhdGlvbklEID0gXCJhXCIgKyBpZC50b1N0cmluZygzMik7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFkaXJlY3Rpb24gJiYgaWQgPCA1MDAwMDAwMDAwMDAwMCkge1xuICAgICAgICAgICAgICAgIGRpcmVjdGlvbiA9IDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRpcmVjdGlvbiA9IC0xO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gMSkge1xuICAgICAgICAgICAgICAgIGlkICs9IDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlkICs9IC0xO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldCA9IFwiXCIgKyBpZDtcbiAgICB9XG4gICAgdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWRbY2l0YXRpb24uY2l0YXRpb25JRF0gPSBjaXRhdGlvbjtcbiAgICByZXR1cm4gcmV0O1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUucmVidWlsZFByb2Nlc3NvclN0YXRlID0gZnVuY3Rpb24gKGNpdGF0aW9ucywgbW9kZSwgdW5jaXRlZEl0ZW1JRHMpIHtcbiAgICBpZiAoIWNpdGF0aW9ucykge1xuICAgICAgICBjaXRhdGlvbnMgPSBbXTtcbiAgICB9XG4gICAgaWYgKCFtb2RlKSB7XG4gICAgICAgIG1vZGUgPSAnaHRtbCc7XG4gICAgfVxuICAgIHZhciBkb25lSURzID0ge307XG4gICAgdmFyIGl0ZW1JRHMgPSBbXTtcbiAgICBmb3IgKHZhciBpPTAsaWxlbj1jaXRhdGlvbnMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgIGZvciAodmFyIGo9MCxqbGVuPWNpdGF0aW9uc1tpXS5jaXRhdGlvbkl0ZW1zLmxlbmd0aDtqPGpsZW47ais9MSkge1xuICAgICAgICAgICAgdmFyIGl0ZW1JRCA9IFwiXCIgKyBjaXRhdGlvbnNbaV0uY2l0YXRpb25JdGVtc1tqXS5pZDtcbiAgICAgICAgICAgIGlmICghZG9uZUlEc1tpdGVtSURdKSB7XG4gICAgICAgICAgICAgICAgaXRlbUlEcy5wdXNoKGl0ZW1JRCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkb25lSURzW2l0ZW1JRF0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudXBkYXRlSXRlbXMoaXRlbUlEcyk7XG4gICAgdmFyIHByZSA9IFtdO1xuICAgIHZhciBwb3N0ID0gW107XG4gICAgdmFyIHJldCA9IFtdO1xuICAgIHZhciBvbGRNb2RlID0gdGhpcy5vcHQubW9kZTtcbiAgICB0aGlzLnNldE91dHB1dEZvcm1hdChtb2RlKTtcbiAgICBmb3IgKHZhciBpPTAsaWxlbj1jaXRhdGlvbnMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgIHZhciByZXMgPSB0aGlzLnByb2Nlc3NDaXRhdGlvbkNsdXN0ZXIoY2l0YXRpb25zW2ldLHByZSxwb3N0LENTTC5BU1NVTUVfQUxMX0lURU1TX1JFR0lTVEVSRUQpO1xuICAgICAgICBwcmUucHVzaChbY2l0YXRpb25zW2ldLmNpdGF0aW9uSUQsY2l0YXRpb25zW2ldLnByb3BlcnRpZXMubm90ZUluZGV4XSk7XG4gICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXJlc1sxXS5sZW5ndGg7ajxqbGVuO2orPTEpIHtcbiAgICAgICAgICAgIHZhciBpbmRleCA9IHJlc1sxXVtqXVswXTtcbiAgICAgICAgICAgIHJldFtpbmRleF0gPSBbXG4gICAgICAgICAgICAgICAgcHJlW2luZGV4XVswXSxcbiAgICAgICAgICAgICAgICBwcmVbaW5kZXhdWzFdLFxuICAgICAgICAgICAgICAgIHJlc1sxXVtqXVsxXVxuICAgICAgICAgICAgXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnVwZGF0ZVVuY2l0ZWRJdGVtcyh1bmNpdGVkSXRlbUlEcyk7XG4gICAgdGhpcy5zZXRPdXRwdXRGb3JtYXQob2xkTW9kZSk7XG4gICAgcmV0dXJuIHJldDtcbn1cbkNTTC5FbmdpbmUucHJvdG90eXBlLnJlc3RvcmVQcm9jZXNzb3JTdGF0ZSA9IGZ1bmN0aW9uIChjaXRhdGlvbnMpIHtcbiAgICB2YXIgaSwgaWxlbiwgaiwgamxlbiwgaXRlbSwgSXRlbSwgbmV3aXRlbSwgY2l0YXRpb25MaXN0LCBpdGVtTGlzdCwgc29ydGVkSXRlbXM7XG4gICAgY2l0YXRpb25MaXN0ID0gW107XG4gICAgaXRlbUxpc3QgPSBbXTtcbiAgICBpZiAoIWNpdGF0aW9ucykge1xuICAgICAgICBjaXRhdGlvbnMgPSBbXTtcbiAgICB9XG4gICAgdmFyIGluZGV4TnVtYmVycyA9IFtdO1xuICAgIHZhciBjaXRhdGlvbklkcyA9IHt9O1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBjaXRhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGlmIChjaXRhdGlvbklkc1tjaXRhdGlvbnNbaV0uY2l0YXRpb25JRF0pIHtcbiAgICAgICAgICAgIHRoaXMuc2V0Q2l0YXRpb25JZChjaXRhdGlvbnNbaV0sIHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIGNpdGF0aW9uSWRzW2NpdGF0aW9uc1tpXS5jaXRhdGlvbklEXSA9IHRydWU7XG4gICAgICAgIGluZGV4TnVtYmVycy5wdXNoKGNpdGF0aW9uc1tpXS5wcm9wZXJ0aWVzLmluZGV4KTtcbiAgICB9XG4gICAgdmFyIG9sZENpdGF0aW9ucyA9IGNpdGF0aW9ucy5zbGljZSgpO1xuICAgIG9sZENpdGF0aW9ucy5zb3J0KFxuICAgICAgICBmdW5jdGlvbiAoYSxiKSB7XG4gICAgICAgICAgICBpZiAoYS5wcm9wZXJ0aWVzLmluZGV4IDwgYi5wcm9wZXJ0aWVzLmluZGV4KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhLnByb3BlcnRpZXMuaW5kZXggPiBiLnByb3BlcnRpZXMuaW5kZXgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICApO1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBvbGRDaXRhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIG9sZENpdGF0aW9uc1tpXS5wcm9wZXJ0aWVzLmluZGV4ID0gaTtcbiAgICB9XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IG9sZENpdGF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgc29ydGVkSXRlbXMgPSBbXTtcbiAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IG9sZENpdGF0aW9uc1tpXS5jaXRhdGlvbkl0ZW1zLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgaXRlbSA9IG9sZENpdGF0aW9uc1tpXS5jaXRhdGlvbkl0ZW1zW2pdO1xuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBpdGVtLnNvcnRrZXlzKSB7XG4gICAgICAgICAgICAgICAgaXRlbS5zb3J0a2V5cyA9IFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgSXRlbSA9IHRoaXMucmV0cmlldmVJdGVtKFwiXCIgKyBpdGVtLmlkKTtcbiAgICAgICAgICAgIG5ld2l0ZW0gPSBbSXRlbSwgaXRlbV07XG4gICAgICAgICAgICBzb3J0ZWRJdGVtcy5wdXNoKG5ld2l0ZW0pO1xuICAgICAgICAgICAgb2xkQ2l0YXRpb25zW2ldLmNpdGF0aW9uSXRlbXNbal0uaXRlbSA9IEl0ZW07XG4gICAgICAgICAgICBpdGVtTGlzdC5wdXNoKFwiXCIgKyBpdGVtLmlkKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIW9sZENpdGF0aW9uc1tpXS5wcm9wZXJ0aWVzLnVuc29ydGVkKSB7XG4gICAgICAgICAgICBzb3J0ZWRJdGVtcy5zb3J0KHRoaXMuY2l0YXRpb24uc3J0LmNvbXBhcmVDb21wb3NpdGVLZXlzKTtcbiAgICAgICAgfVxuICAgICAgICBvbGRDaXRhdGlvbnNbaV0uc29ydGVkSXRlbXMgPSBzb3J0ZWRJdGVtcztcbiAgICAgICAgdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWRbb2xkQ2l0YXRpb25zW2ldLmNpdGF0aW9uSURdID0gb2xkQ2l0YXRpb25zW2ldO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZUl0ZW1zKGl0ZW1MaXN0KTtcbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gY2l0YXRpb25zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBjaXRhdGlvbkxpc3QucHVzaChbXCJcIiArIGNpdGF0aW9uc1tpXS5jaXRhdGlvbklELCBjaXRhdGlvbnNbaV0ucHJvcGVydGllcy5ub3RlSW5kZXhdKTtcbiAgICB9XG4gICAgdmFyIHJldCA9IFtdO1xuICAgIGlmIChjaXRhdGlvbnMgJiYgY2l0YXRpb25zLmxlbmd0aCkge1xuICAgICAgICByZXQgPSB0aGlzLnByb2Nlc3NDaXRhdGlvbkNsdXN0ZXIoY2l0YXRpb25zWzBdLCBbXSwgY2l0YXRpb25MaXN0LnNsaWNlKDEpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlZ2lzdHJ5ID0gbmV3IENTTC5SZWdpc3RyeSh0aGlzKTtcbiAgICAgICAgdGhpcy50bXAgPSBuZXcgQ1NMLkVuZ2luZS5UbXAoKTtcbiAgICAgICAgdGhpcy5kaXNhbWJpZ3VhdGUgPSBuZXcgQ1NMLkRpc2FtYmlndWF0aW9uKHRoaXMpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnVwZGF0ZUl0ZW1zID0gZnVuY3Rpb24gKGlkTGlzdCwgbm9zb3J0LCByZXJ1bl9hbWJpZ3MsIGltcGxpY2l0VXBkYXRlKSB7XG4gICAgdmFyIGRlYnVnID0gZmFsc2U7XG4gICAgdmFyIG9sZEFyZWEgPSB0aGlzLnRtcC5hcmVhO1xuICAgIHZhciBvbGRSb290ID0gdGhpcy50bXAucm9vdDtcbiAgICB2YXIgb2xkRXh0ZW5zaW9uID0gdGhpcy50bXAuZXh0ZW5zaW9uO1xuICAgIHRoaXMudG1wLmFyZWEgPSBcImNpdGF0aW9uXCI7XG4gICAgdGhpcy50bXAucm9vdCA9IFwiY2l0YXRpb25cIjtcbiAgICB0aGlzLnRtcC5leHRlbnNpb24gPSBcIlwiO1xuICAgIGlmICghaW1wbGljaXRVcGRhdGUpIHtcbiAgICAgICAgdGhpcy50bXAubG9hZGVkSXRlbUlEcyA9IHt9O1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdHJ5LmluaXQoaWRMaXN0KTtcblx0aWYgKHJlcnVuX2FtYmlncykge1xuXHRcdGZvciAodmFyIGFtYmlnIGluIHRoaXMucmVnaXN0cnkuYW1iaWdjaXRlcykge1xuXHRcdFx0dGhpcy5yZWdpc3RyeS5hbWJpZ3NUb3VjaGVkW2FtYmlnXSA9IHRydWU7XG5cdFx0fVxuXHR9XG4gICAgdGhpcy5yZWdpc3RyeS5kb2RlbGV0ZXModGhpcy5yZWdpc3RyeS5teWhhc2gpO1xuICAgIHRoaXMucmVnaXN0cnkuZG9pbnNlcnRzKHRoaXMucmVnaXN0cnkubXlsaXN0KTtcbiAgICB0aGlzLnJlZ2lzdHJ5LmRvcmVmcmVzaGVzKCk7XG4gICAgdGhpcy5yZWdpc3RyeS5yZWJ1aWxkbGlzdCgpO1xuICAgIHRoaXMucmVnaXN0cnkuc2V0c29ydGtleXMoKTtcbiAgICB0aGlzLnJlZ2lzdHJ5LnNldGRpc2FtYmlncygpO1xuICAgIGlmICghbm9zb3J0KSB7XG4gICAgICAgIHRoaXMucmVnaXN0cnkuc29ydHRva2VucygpO1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdHJ5LnJlbnVtYmVyKCk7XG4gICAgdGhpcy50bXAuZXh0ZW5zaW9uID0gb2xkRXh0ZW5zaW9uO1xuICAgIHRoaXMudG1wLmFyZWEgPSBvbGRBcmVhO1xuICAgIHRoaXMudG1wLnJvb3QgPSBvbGRSb290O1xuICAgIHJldHVybiB0aGlzLnJlZ2lzdHJ5LmdldFNvcnRlZElkcygpO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnVwZGF0ZVVuY2l0ZWRJdGVtcyA9IGZ1bmN0aW9uIChpZExpc3QsIG5vc29ydCkge1xuICAgIHZhciBkZWJ1ZyA9IGZhbHNlO1xuICAgIHZhciBvbGRBcmVhID0gdGhpcy50bXAuYXJlYTtcbiAgICB2YXIgb2xkUm9vdCA9IHRoaXMudG1wLnJvb3Q7XG4gICAgdmFyIG9sZEV4dGVuc2lvbiA9IHRoaXMudG1wLmV4dGVuc2lvbjtcbiAgICB0aGlzLnRtcC5hcmVhID0gXCJjaXRhdGlvblwiO1xuICAgIHRoaXMudG1wLnJvb3QgPSBcImNpdGF0aW9uXCJcbiAgICB0aGlzLnRtcC5leHRlbnNpb24gPSBcIlwiXG4gICAgdGhpcy50bXAubG9hZGVkSXRlbUlEcyA9IHt9O1xuICAgIGlmICghaWRMaXN0KSB7XG4gICAgICAgIGlkTGlzdCA9IFtdO1xuICAgIH1cbiAgICBpZiAoXCJvYmplY3RcIiA9PSB0eXBlb2YgaWRMaXN0KSB7XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09IHR5cGVvZiBpZExpc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgaWRIYXNoID0gaWRMaXN0O1xuICAgICAgICAgICAgaWRMaXN0ID0gW107XG4gICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaWRIYXNoKSB7XG4gICAgICAgICAgICAgICAgaWRMaXN0LnB1c2goa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChcIm51bWJlclwiID09IHR5cGVvZiBpZExpc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgaWRIYXNoID0ge307XG4gICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1pZExpc3QubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICAgICAgaWRIYXNoW2lkTGlzdFtpXV0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMucmVnaXN0cnkuaW5pdChpZExpc3QsIHRydWUpO1xuICAgIHRoaXMucmVnaXN0cnkuZG9wdXJnZShpZEhhc2gpO1xuICAgIHRoaXMucmVnaXN0cnkuZG9pbnNlcnRzKHRoaXMucmVnaXN0cnkubXlsaXN0KTtcbiAgICB0aGlzLnJlZ2lzdHJ5LmRvcmVmcmVzaGVzKCk7XG4gICAgdGhpcy5yZWdpc3RyeS5yZWJ1aWxkbGlzdCgpO1xuICAgIHRoaXMucmVnaXN0cnkuc2V0c29ydGtleXMoKTtcbiAgICB0aGlzLnJlZ2lzdHJ5LnNldGRpc2FtYmlncygpO1xuICAgIGlmICghbm9zb3J0KSB7XG4gICAgICAgIHRoaXMucmVnaXN0cnkuc29ydHRva2VucygpO1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdHJ5LnJlbnVtYmVyKCk7XG4gICAgdGhpcy50bXAuZXh0ZW5zaW9uID0gb2xkRXh0ZW5zaW9uO1xuICAgIHRoaXMudG1wLmFyZWEgPSBvbGRBcmVhO1xuICAgIHRoaXMudG1wLnJvb3QgPSBvbGRSb290O1xuICAgIHJldHVybiB0aGlzLnJlZ2lzdHJ5LmdldFNvcnRlZElkcygpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLmxvY2FsZVJlc29sdmUgPSBmdW5jdGlvbiAobGFuZ3N0ciwgZGVmYXVsdExvY2FsZSkge1xuICAgIHZhciByZXQsIGxhbmdsc3Q7XG4gICAgaWYgKCFkZWZhdWx0TG9jYWxlKSB7XG4gICAgICAgIGRlZmF1bHRMb2NhbGUgPSBcImVuLVVTXCI7XG4gICAgfVxuICAgIGlmICghbGFuZ3N0cikge1xuICAgICAgICBsYW5nc3RyID0gZGVmYXVsdExvY2FsZTtcbiAgICB9XG4gICAgcmV0ID0ge307XG4gICAgbGFuZ2xzdCA9IGxhbmdzdHIuc3BsaXQoL1tcXC1fXS8pO1xuICAgIHJldC5iYXNlID0gQ1NMLkxBTkdfQkFTRVNbbGFuZ2xzdFswXV07XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiByZXQuYmFzZSkge1xuICAgICAgICByZXR1cm4ge2Jhc2U6ZGVmYXVsdExvY2FsZSwgYmVzdDpsYW5nc3RyLCBiYXJlOmxhbmdsc3RbMF19O1xuICAgIH1cbiAgICBpZiAobGFuZ2xzdC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgcmV0LmdlbmVyaWMgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAobGFuZ2xzdC5sZW5ndGggPT09IDEgfHwgbGFuZ2xzdFsxXSA9PT0gXCJ4XCIpIHtcbiAgICAgICAgcmV0LmJlc3QgPSByZXQuYmFzZS5yZXBsYWNlKFwiX1wiLCBcIi1cIik7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0LmJlc3QgPSBsYW5nbHN0LnNsaWNlKDAsIDIpLmpvaW4oXCItXCIpO1xuICAgIH1cbiAgICByZXQuYmFzZSA9IHJldC5iYXNlLnJlcGxhY2UoXCJfXCIsIFwiLVwiKTtcbiAgICByZXQuYmFyZSA9IGxhbmdsc3RbMF07XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5sb2NhbGVDb25maWd1cmUgPSBmdW5jdGlvbiAobGFuZ3NwZWMsIGJlU2h5KSB7XG4gICAgdmFyIGxvY2FsZXhtbDtcbiAgICBpZiAoYmVTaHkgJiYgdGhpcy5sb2NhbGVbbGFuZ3NwZWMuYmVzdF0pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAobGFuZ3NwZWMuYmVzdCA9PT0gXCJlbi1VU1wiKSB7XG4gICAgICAgIGxvY2FsZXhtbCA9IENTTC5zZXR1cFhtbCh0aGlzLnN5cy5yZXRyaWV2ZUxvY2FsZShcImVuLVVTXCIpKTtcbiAgICAgICAgdGhpcy5sb2NhbGVTZXQobG9jYWxleG1sLCBcImVuLVVTXCIsIGxhbmdzcGVjLmJlc3QpO1xuICAgIH0gZWxzZSBpZiAobGFuZ3NwZWMuYmVzdCAhPT0gXCJlbi1VU1wiKSB7XG4gICAgICAgIGlmIChsYW5nc3BlYy5iYXNlICE9PSBsYW5nc3BlYy5iZXN0KSB7XG4gICAgICAgICAgICBsb2NhbGV4bWwgPSBDU0wuc2V0dXBYbWwodGhpcy5zeXMucmV0cmlldmVMb2NhbGUobGFuZ3NwZWMuYmFzZSkpO1xuICAgICAgICAgICAgdGhpcy5sb2NhbGVTZXQobG9jYWxleG1sLCBsYW5nc3BlYy5iYXNlLCBsYW5nc3BlYy5iZXN0KTtcbiAgICAgICAgfVxuICAgICAgICBsb2NhbGV4bWwgPSBDU0wuc2V0dXBYbWwodGhpcy5zeXMucmV0cmlldmVMb2NhbGUobGFuZ3NwZWMuYmVzdCkpO1xuICAgICAgICB0aGlzLmxvY2FsZVNldChsb2NhbGV4bWwsIGxhbmdzcGVjLmJlc3QsIGxhbmdzcGVjLmJlc3QpOyAgICAgICAgXG4gICAgfVxuICAgIHRoaXMubG9jYWxlU2V0KHRoaXMuY3NsWG1sLCBcIlwiLCBsYW5nc3BlYy5iZXN0KTtcbiAgICB0aGlzLmxvY2FsZVNldCh0aGlzLmNzbFhtbCwgbGFuZ3NwZWMuYmFyZSwgbGFuZ3NwZWMuYmVzdCk7XG4gICAgaWYgKGxhbmdzcGVjLmJhc2UgIT09IGxhbmdzcGVjLmJlc3QpIHtcbiAgICAgICAgdGhpcy5sb2NhbGVTZXQodGhpcy5jc2xYbWwsIGxhbmdzcGVjLmJhc2UsIGxhbmdzcGVjLmJlc3QpO1xuICAgIH1cbiAgICB0aGlzLmxvY2FsZVNldCh0aGlzLmNzbFhtbCwgbGFuZ3NwZWMuYmVzdCwgbGFuZ3NwZWMuYmVzdCk7XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLmxvY2FsZVtsYW5nc3BlYy5iZXN0XS50ZXJtc1tcInBhZ2UtcmFuZ2UtZGVsaW1pdGVyXCJdKSB7XG4gICAgICAgIGlmIChbXCJmclwiLCBcInB0XCJdLmluZGV4T2YobGFuZ3NwZWMuYmVzdC5zbGljZSgwLCAyKS50b0xvd2VyQ2FzZSgpKSA+IC0xKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nc3BlYy5iZXN0XS50ZXJtc1tcInBhZ2UtcmFuZ2UtZGVsaW1pdGVyXCJdID0gXCItXCI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nc3BlYy5iZXN0XS50ZXJtc1tcInBhZ2UtcmFuZ2UtZGVsaW1pdGVyXCJdID0gXCJcXHUyMDEzXCI7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLmxvY2FsZVtsYW5nc3BlYy5iZXN0XS50ZXJtc1tcInllYXItcmFuZ2UtZGVsaW1pdGVyXCJdKSB7XG4gICAgICAgIHRoaXMubG9jYWxlW2xhbmdzcGVjLmJlc3RdLnRlcm1zW1wieWVhci1yYW5nZS1kZWxpbWl0ZXJcIl0gPSBcIlxcdTIwMTNcIjtcbiAgICB9XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLmxvY2FsZVtsYW5nc3BlYy5iZXN0XS50ZXJtc1tcImNpdGF0aW9uLXJhbmdlLWRlbGltaXRlclwiXSkge1xuICAgICAgICB0aGlzLmxvY2FsZVtsYW5nc3BlYy5iZXN0XS50ZXJtc1tcImNpdGF0aW9uLXJhbmdlLWRlbGltaXRlclwiXSA9IFwiXFx1MjAxM1wiO1xuICAgIH1cbiAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ub3JtYWxpemVfbGFuZ19rZXlzX3RvX2xvd2VyY2FzZSkge1xuICAgICAgICB2YXIgbG9jYWxlTGlzdHMgPSBbXCJkZWZhdWx0LWxvY2FsZVwiLFwibG9jYWxlLXNvcnRcIixcImxvY2FsZS10cmFuc2xpdFwiLFwibG9jYWxlLXRyYW5zbGF0XCJdO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1sb2NhbGVMaXN0cy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXRoaXMub3B0W2xvY2FsZUxpc3RzW2ldXS5sZW5ndGg7ajxqbGVuO2orPTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wdFtsb2NhbGVMaXN0c1tpXV1bal0gPSB0aGlzLm9wdFtsb2NhbGVMaXN0c1tpXV1bal0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLm9wdC5sYW5nID0gdGhpcy5vcHQubGFuZy50b0xvd2VyQ2FzZSgpO1xuICAgIH1cbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5sb2NhbGVTZXQgPSBmdW5jdGlvbiAobXl4bWwsIGxhbmdfaW4sIGxhbmdfb3V0KSB7XG4gICAgdmFyIGJsb2IsIGxvY2FsZSwgbm9kZXMsIGF0dHJpYnV0ZXMsIHBvcywgcHBvcywgdGVybSwgZm9ybSwgdGVybW5hbWUsIHN0eWxlb3B0cywgYXR0ciwgZGF0ZSwgYXR0cm5hbWUsIGxlbiwgZ2VuZGVyZm9ybSwgdGFyZ2V0LCBpLCBpbGVuO1xuICAgIGxhbmdfaW4gPSBsYW5nX2luLnJlcGxhY2UoXCJfXCIsIFwiLVwiKTtcbiAgICBsYW5nX291dCA9IGxhbmdfb3V0LnJlcGxhY2UoXCJfXCIsIFwiLVwiKTtcbiAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ub3JtYWxpemVfbGFuZ19rZXlzX3RvX2xvd2VyY2FzZSkge1xuICAgICAgICBsYW5nX2luID0gbGFuZ19pbi50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBsYW5nX291dCA9IGxhbmdfb3V0LnRvTG93ZXJDYXNlKCk7XG4gICAgfVxuICAgIGlmICghdGhpcy5sb2NhbGVbbGFuZ19vdXRdKSB7XG4gICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XSA9IHt9O1xuICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0udGVybXMgPSB7fTtcbiAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9wdHMgPSB7fTtcbiAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9wdHNbXCJza2lwLXdvcmRzXCJdID0gQ1NMLlNLSVBfV09SRFM7XG4gICAgICAgIGlmICghdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9wdHNbXCJsZWFkaW5nLW5vaXNlLXdvcmRzXCJdKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcImxlYWRpbmctbm9pc2Utd29yZHNcIl0gPSBbXTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0uZGF0ZXMgPSB7fTtcbiAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9yZCA9IHsnMS4wLjEnOmZhbHNlLGtleXM6e319O1xuICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF1bXCJub3VuLWdlbmRlcnNcIl0gPSB7fTtcbiAgICB9XG4gICAgbG9jYWxlID0gbXl4bWwubWFrZVhtbCgpO1xuICAgIGlmIChteXhtbC5ub2RlTmFtZUlzKG15eG1sLmRhdGFPYmosICdsb2NhbGUnKSkge1xuICAgICAgICBsb2NhbGUgPSBteXhtbC5kYXRhT2JqO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG5vZGVzID0gbXl4bWwuZ2V0Tm9kZXNCeU5hbWUobXl4bWwuZGF0YU9iaiwgXCJsb2NhbGVcIik7XG4gICAgICAgIGZvciAocG9zID0gMCwgbGVuID0gbXl4bWwubnVtYmVyb2Zub2Rlcyhub2Rlcyk7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIGJsb2IgPSBub2Rlc1twb3NdO1xuICAgICAgICAgICAgaWYgKG15eG1sLmdldEF0dHJpYnV0ZVZhbHVlKGJsb2IsICdsYW5nJywgJ3htbCcpID09PSBsYW5nX2luKSB7XG4gICAgICAgICAgICAgICAgbG9jYWxlID0gYmxvYjtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBub2RlcyA9IG15eG1sLmdldE5vZGVzQnlOYW1lKGxvY2FsZSwgJ3R5cGUnKTtcbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gbXl4bWwubnVtYmVyb2Zub2Rlcyhub2Rlcyk7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIHR5cGVub2RlID0gbm9kZXNbaV07XG4gICAgICAgIHZhciB0eXBlID0gbXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUodHlwZW5vZGUsICduYW1lJyk7XG4gICAgICAgIHZhciBnZW5kZXIgPSBteXhtbC5nZXRBdHRyaWJ1dGVWYWx1ZSh0eXBlbm9kZSwgJ2dlbmRlcicpO1xuICAgICAgICB0aGlzLm9wdC5nZW5kZXJbdHlwZV0gPSBnZW5kZXI7XG4gICAgfVxuICAgIHZhciBoYXNDc2xPcmRpbmFsczEwMSA9IG15eG1sLmdldE5vZGVzQnlOYW1lKGxvY2FsZSwgJ3Rlcm0nLCAnb3JkaW5hbCcpLmxlbmd0aDtcbiAgICBpZiAoaGFzQ3NsT3JkaW5hbHMxMDEpIHtcbiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcmQua2V5cykge1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1trZXldO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcmQgPSB7XCIxLjAuMVwiOmZhbHNlLGtleXM6e319O1xuICAgIH1cbiAgICBub2RlcyA9IG15eG1sLmdldE5vZGVzQnlOYW1lKGxvY2FsZSwgJ3Rlcm0nKTtcbiAgICB2YXIgb3JkaW5hbHMxMDEgPSB7XCJsYXN0LWRpZ2l0XCI6e30sXCJsYXN0LXR3by1kaWdpdHNcIjp7fSxcIndob2xlLW51bWJlclwiOnt9fTtcbiAgICB2YXIgb3JkaW5hbHMxMDFfdG9nZ2xlID0gZmFsc2U7XG4gICAgdmFyIGdlbmRlcml6ZWRfdGVybXMgPSB7fTtcbiAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IG15eG1sLm51bWJlcm9mbm9kZXMobm9kZXMpOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIHRlcm0gPSBub2Rlc1twb3NdO1xuICAgICAgICB0ZXJtbmFtZSA9IG15eG1sLmdldEF0dHJpYnV0ZVZhbHVlKHRlcm0sICduYW1lJyk7XG4gICAgICAgIGlmICh0ZXJtbmFtZSA9PT0gXCJzdWIgdmVyYm9cIikge1xuICAgICAgICAgICAgdGVybW5hbWUgPSBcInN1Yi12ZXJib1wiO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0ZXJtbmFtZS5zbGljZSgwLDcpID09PSBcIm9yZGluYWxcIikge1xuICAgICAgICAgICAgdmFyIHRlcm1zdHJpbmcgPSBteXhtbC5nZXROb2RlVmFsdWUodGVybSk7XG4gICAgICAgICAgICBpZiAodGVybW5hbWUgPT09IFwib3JkaW5hbFwiKSB7XG4gICAgICAgICAgICAgICAgb3JkaW5hbHMxMDFfdG9nZ2xlID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gbXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUodGVybSwgJ21hdGNoJyk7XG4gICAgICAgICAgICAgICAgdmFyIHRlcm1zdHViID0gdGVybW5hbWUuc2xpY2UoOCk7XG4gICAgICAgICAgICAgICAgdmFyIGdlbmRlcmZvcm0gPSBteXhtbC5nZXRBdHRyaWJ1dGVWYWx1ZSh0ZXJtLCAnZ2VuZGVyLWZvcm0nKTtcbiAgICAgICAgICAgICAgICBpZiAoIWdlbmRlcmZvcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgZ2VuZGVyZm9ybSA9IFwibmV1dGVyXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBcImxhc3QtdHdvLWRpZ2l0c1wiO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGVybXN0dWIuc2xpY2UoMCwxKSA9PT0gXCIwXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gXCJsYXN0LWRpZ2l0XCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRlcm1zdHViLnNsaWNlKDAsMSkgPT09IFwiMFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRlcm1zdHViID0gdGVybXN0dWIuc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghb3JkaW5hbHMxMDFbbWF0Y2hdW3Rlcm1zdHViXSkge1xuICAgICAgICAgICAgICAgICAgICBvcmRpbmFsczEwMVttYXRjaF1bdGVybXN0dWJdID0ge307XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG9yZGluYWxzMTAxW21hdGNoXVt0ZXJtc3R1Yl1bZ2VuZGVyZm9ybV0gPSB0ZXJtbmFtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcmQua2V5c1t0ZXJtbmFtZV0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXSkge1xuICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXSA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIGZvcm0gPSBcImxvbmdcIjtcbiAgICAgICAgZ2VuZGVyZm9ybSA9IGZhbHNlO1xuICAgICAgICBpZiAobXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUodGVybSwgJ2Zvcm0nKSkge1xuICAgICAgICAgICAgZm9ybSA9IG15eG1sLmdldEF0dHJpYnV0ZVZhbHVlKHRlcm0sICdmb3JtJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG15eG1sLmdldEF0dHJpYnV0ZVZhbHVlKHRlcm0sICdnZW5kZXItZm9ybScpKSB7XG4gICAgICAgICAgICBnZW5kZXJmb3JtID0gbXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUodGVybSwgJ2dlbmRlci1mb3JtJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG15eG1sLmdldEF0dHJpYnV0ZVZhbHVlKHRlcm0sICdnZW5kZXInKSkge1xuICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdW1wibm91bi1nZW5kZXJzXCJdW3Rlcm1uYW1lXSA9IG15eG1sLmdldEF0dHJpYnV0ZVZhbHVlKHRlcm0sICdnZW5kZXInKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZ2VuZGVyZm9ybSkge1xuICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXVtnZW5kZXJmb3JtXSA9IHt9O1xuICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXVtnZW5kZXJmb3JtXVtmb3JtXSA9IFtdO1xuICAgICAgICAgICAgdGFyZ2V0ID0gdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXVtnZW5kZXJmb3JtXTtcbiAgICAgICAgICAgIGdlbmRlcml6ZWRfdGVybXNbdGVybW5hbWVdID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1t0ZXJtbmFtZV1bZm9ybV0gPSBbXTtcbiAgICAgICAgICAgIHRhcmdldCA9IHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1t0ZXJtbmFtZV07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG15eG1sLm51bWJlcm9mbm9kZXMobXl4bWwuZ2V0Tm9kZXNCeU5hbWUodGVybSwgJ211bHRpcGxlJykpKSB7XG4gICAgICAgICAgICB0YXJnZXRbZm9ybV1bMF0gPSBteXhtbC5nZXROb2RlVmFsdWUodGVybSwgJ3NpbmdsZScpO1xuICAgICAgICAgICAgaWYgKHRhcmdldFtmb3JtXVswXS5pbmRleE9mKFwiJXNcIikgPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMub3B0Lmhhc1BsYWNlaG9sZGVyVGVybSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0YXJnZXRbZm9ybV1bMV0gPSBteXhtbC5nZXROb2RlVmFsdWUodGVybSwgJ211bHRpcGxlJyk7XG4gICAgICAgICAgICBpZiAodGFyZ2V0W2Zvcm1dWzFdLmluZGV4T2YoXCIlc1wiKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHQuaGFzUGxhY2Vob2xkZXJUZXJtID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRhcmdldFtmb3JtXSA9IG15eG1sLmdldE5vZGVWYWx1ZSh0ZXJtKTtcbiAgICAgICAgICAgIGlmICh0YXJnZXRbZm9ybV0uaW5kZXhPZihcIiVzXCIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wdC5oYXNQbGFjZWhvbGRlclRlcm0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChvcmRpbmFsczEwMV90b2dnbGUpIHtcbiAgICAgICAgZm9yICh2YXIgaWtleSBpbiBnZW5kZXJpemVkX3Rlcm1zKSB7XG4gICAgICAgICAgICB2YXIgZ2VuZGVyX3NlZ21lbnRzID0ge307XG4gICAgICAgICAgICB2YXIgZm9ybV9zZWdtZW50cyA9IDA7XG4gICAgICAgICAgICBmb3IgKHZhciBqa2V5IGluIHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1tpa2V5XSkge1xuICAgICAgICAgICAgICAgIGlmIChbXCJtYXNjdWxpbmVcIixcImZlbWluaW5lXCJdLmluZGV4T2YoamtleSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBnZW5kZXJfc2VnbWVudHNbamtleV0gPSB0aGlzLmxvY2FsZVtsYW5nX291dF0udGVybXNbaWtleV1bamtleV07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZm9ybV9zZWdtZW50cyArPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghZm9ybV9zZWdtZW50cykge1xuICAgICAgICAgICAgICAgIGlmIChnZW5kZXJfc2VnbWVudHMuZmVtaW5pbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgamtleSBpbiBnZW5kZXJfc2VnbWVudHMuZmVtaW5pbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1tpa2V5XVtqa2V5XSA9IGdlbmRlcl9zZWdtZW50cy5mZW1pbmluZVtqa2V5XTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZ2VuZGVyX3NlZ21lbnRzLm1hc2N1bGluZSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqa2V5IGluIGdlbmRlcl9zZWdtZW50cy5tYXNjdWxpbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1tpa2V5XVtqa2V5XSA9IGdlbmRlcl9zZWdtZW50cy5tYXNjdWxpbmVbamtleV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9yZFsnMS4wLjEnXSA9IG9yZGluYWxzMTAxO1xuICAgIH1cbiAgICBmb3IgKHRlcm1uYW1lIGluIHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtcykge1xuICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gMjsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgZ2VuZGVyZm9ybSA9IENTTC5HRU5ERVJTW2ldO1xuICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1t0ZXJtbmFtZV1bZ2VuZGVyZm9ybV0pIHtcbiAgICAgICAgICAgICAgICBmb3IgKGZvcm0gaW4gdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1t0ZXJtbmFtZV1bZ2VuZGVyZm9ybV1bZm9ybV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1t0ZXJtbmFtZV1bZ2VuZGVyZm9ybV1bZm9ybV0gPSB0aGlzLmxvY2FsZVtsYW5nX291dF0udGVybXNbdGVybW5hbWVdW2Zvcm1dO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIG5vZGVzID0gbXl4bWwuZ2V0Tm9kZXNCeU5hbWUobG9jYWxlLCAnc3R5bGUtb3B0aW9ucycpO1xuICAgIGZvciAocG9zID0gMCwgbGVuID0gbXl4bWwubnVtYmVyb2Zub2Rlcyhub2Rlcyk7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgaWYgKHRydWUpIHtcbiAgICAgICAgICAgIHN0eWxlb3B0cyA9IG5vZGVzW3Bvc107XG4gICAgICAgICAgICBhdHRyaWJ1dGVzID0gbXl4bWwuYXR0cmlidXRlcyhzdHlsZW9wdHMpO1xuICAgICAgICAgICAgZm9yIChhdHRybmFtZSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cm5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhdHRybmFtZSA9PT0gXCJAcHVuY3R1YXRpb24taW4tcXVvdGVcIiB8fCBhdHRybmFtZSA9PT0gXCJAbGltaXQtZGF5LW9yZGluYWxzLXRvLWRheS0xXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzW2F0dHJuYW1lXSA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1thdHRybmFtZS5zbGljZSgxKV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1thdHRybmFtZS5zbGljZSgxKV0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdHRybmFtZSA9PT0gXCJAanVyaXNkaWN0aW9uLXByZWZlcmVuY2VcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGp1cmlzZGljdGlvbl9wcmVmZXJlbmNlID0gYXR0cmlidXRlc1thdHRybmFtZV0uc3BsaXQoL1xccyosXFxzKi8pO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9wdHNbYXR0cm5hbWUuc2xpY2UoMSldID0ganVyaXNkaWN0aW9uX3ByZWZlcmVuY2U7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0cm5hbWUgPT09IFwiQHNraXAtd29yZHNcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNraXBfd29yZHMgPSBhdHRyaWJ1dGVzW2F0dHJuYW1lXS5zcGxpdCgvXFxzKixcXHMqLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1thdHRybmFtZS5zbGljZSgxKV0gPSBza2lwX3dvcmRzO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF0dHJuYW1lID09PSBcIkBsZWFkaW5nLW5vaXNlLXdvcmRzXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWwgPSBhdHRyaWJ1dGVzW2F0dHJuYW1lXS5zcGxpdCgvXFxzKixcXHMqLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcImxlYWRpbmctbm9pc2Utd29yZHNcIl0gPSB2YWw7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0cm5hbWUgPT09IFwiQG5hbWUtYXMtc29ydC1vcmRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcIm5hbWUtYXMtc29ydC1vcmRlclwiXSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxzdCA9IGF0dHJpYnV0ZXNbYXR0cm5hbWVdLnNwbGl0KC9cXHMrLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1sc3QubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9wdHNbXCJuYW1lLWFzLXNvcnQtb3JkZXJcIl1bbHN0W2ldXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0cm5hbWUgPT09IFwiQG5hbWUtYXMtcmV2ZXJzZS1vcmRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcIm5hbWUtYXMtcmV2ZXJzZS1vcmRlclwiXSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxzdCA9IGF0dHJpYnV0ZXNbYXR0cm5hbWVdLnNwbGl0KC9cXHMrLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1sc3QubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9wdHNbXCJuYW1lLWFzLXJldmVyc2Utb3JkZXJcIl1bbHN0W2ldXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0cm5hbWUgPT09IFwiQG5hbWUtbmV2ZXItc2hvcnRcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9wdHNbXCJuYW1lLW5ldmVyLXNob3J0XCJdID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHN0ID0gYXR0cmlidXRlc1thdHRybmFtZV0uc3BsaXQoL1xccysvKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWxzdC5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcIm5hbWUtbmV2ZXItc2hvcnRcIl1bbHN0W2ldXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgbm9kZXMgPSBteXhtbC5nZXROb2Rlc0J5TmFtZShsb2NhbGUsICdkYXRlJyk7XG4gICAgZm9yIChwb3MgPSAwLCBsZW4gPSBteXhtbC5udW1iZXJvZm5vZGVzKG5vZGVzKTsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBpZiAodHJ1ZSkge1xuICAgICAgICAgICAgdmFyIGRhdGUgPSBub2Rlc1twb3NdO1xuICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLmRhdGVzW215eG1sLmdldEF0dHJpYnV0ZVZhbHVlKGRhdGUsIFwiZm9ybVwiKV0gPSBkYXRlO1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLmdldExvY2FsZU5hbWVzID0gZnVuY3Rpb24gKG15eG1sLCBwcmVmZXJyZWRMb2NhbGUpIHtcbiAgICB2YXIgc3R5bGV4bWwgPSBDU0wuc2V0dXBYbWwobXl4bWwpO1xuICAgIGZ1bmN0aW9uIGV4dGVuZExvY2FsZUxpc3QobG9jYWxlTGlzdCwgbG9jYWxlKSB7XG4gICAgICAgIHZhciBmb3JtcyA9IFtcImJhc2VcIiwgXCJiZXN0XCJdO1xuICAgICAgICBpZiAobG9jYWxlKSB7XG4gICAgICAgICAgICBub3JtYWxpemVkTG9jYWxlID0gQ1NMLmxvY2FsZVJlc29sdmUobG9jYWxlKTtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWZvcm1zLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRMb2NhbGVbZm9ybXNbaV1dICYmIGxvY2FsZUxpc3QuaW5kZXhPZihub3JtYWxpemVkTG9jYWxlW2Zvcm1zW2ldXSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvY2FsZUxpc3QucHVzaChub3JtYWxpemVkTG9jYWxlW2Zvcm1zW2ldXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIHNuaWZmTG9jYWxlT25PbmVOb2RlTmFtZShub2RlTmFtZSkge1xuICAgICAgICB2YXIgbm9kZXMgPSBzdHlsZXhtbC5nZXROb2Rlc0J5TmFtZShzdHlsZXhtbC5kYXRhT2JqLCBub2RlTmFtZSk7XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPW5vZGVzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICB2YXIgbm9kZUxvY2FsZXMgPSBzdHlsZXhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2Rlc1tpXSwgXCJsb2NhbGVcIik7XG4gICAgICAgICAgICBpZiAobm9kZUxvY2FsZXMpIHtcbiAgICAgICAgICAgICAgICBub2RlTG9jYWxlcyA9IG5vZGVMb2NhbGVzLnNwbGl0KC8gKy8pO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPW5vZGVMb2NhbGVzLmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXh0ZW5kTG9jYWxlTGlzdChsb2NhbGVJRHMsIG5vZGVMb2NhbGVzW2pdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIGxvY2FsZUlEcyA9IFtcImVuLVVTXCJdO1xuICAgIGV4dGVuZExvY2FsZUxpc3QobG9jYWxlSURzLCBwcmVmZXJyZWRMb2NhbGUpO1xuICAgIHZhciBzdHlsZU5vZGUgPSBzdHlsZXhtbC5nZXROb2Rlc0J5TmFtZShzdHlsZXhtbC5kYXRhT2JqLCBcInN0eWxlXCIpWzBdO1xuICAgIHZhciBkZWZhdWx0TG9jYWxlID0gc3R5bGV4bWwuZ2V0QXR0cmlidXRlVmFsdWUoc3R5bGVOb2RlLCBcImRlZmF1bHQtbG9jYWxlXCIpO1xuICAgIGV4dGVuZExvY2FsZUxpc3QobG9jYWxlSURzLCBkZWZhdWx0TG9jYWxlKTtcbiAgICB2YXIgbm9kZU5hbWVzID0gW1wibGF5b3V0XCIsIFwiaWZcIiwgXCJlbHNlLWlmXCIsIFwiY29uZGl0aW9uXCJdO1xuICAgIGZvciAodmFyIGk9MCxpbGVuPW5vZGVOYW1lcy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICBzbmlmZkxvY2FsZU9uT25lTm9kZU5hbWUoc3R5bGV4bWwsIGxvY2FsZUlEcywgbm9kZU5hbWVzW2ldKTtcbiAgICB9XG4gICAgcmV0dXJuIGxvY2FsZUlEcztcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlID0ge307XG5DU0wuTm9kZS5iaWJsaW9ncmFwaHkgPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5hcmVhID0gXCJiaWJsaW9ncmFwaHlcIjtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLnJvb3QgPSBcImJpYmxpb2dyYXBoeVwiO1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuZXh0ZW5zaW9uID0gXCJcIjtcbiAgICAgICAgICAgIHZhciBmdW5jID0gZnVuY3Rpb24oc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuYXJlYSA9IFwiYmlibGlvZ3JhcGh5XCI7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLnJvb3QgPSBcImJpYmxpb2dyYXBoeVwiO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5leHRlbnNpb24gPSBcIlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB9XG4gICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlLmNob29zZSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgdmFyIGZ1bmM7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmp1bXAucHVzaCh1bmRlZmluZWQsIENTTC5MSVRFUkFMKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuRU5EKSB7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmp1bXAucG9wKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfSxcbiAgICBjb25maWd1cmU6IGZ1bmN0aW9uIChzdGF0ZSwgcG9zKSB7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLkVORCkge1xuICAgICAgICAgICAgc3RhdGUuY29uZmlndXJlLmZhaWwucHVzaCgocG9zKSk7XG4gICAgICAgICAgICBzdGF0ZS5jb25maWd1cmUuc3VjY2VlZC5wdXNoKChwb3MpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0YXRlLmNvbmZpZ3VyZS5mYWlsLnBvcCgpO1xuICAgICAgICAgICAgc3RhdGUuY29uZmlndXJlLnN1Y2NlZWQucG9wKCk7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5jaXRhdGlvbiA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmFyZWEgPSBcImNpdGF0aW9uXCI7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5yb290ID0gXCJjaXRhdGlvblwiO1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuZXh0ZW5zaW9uID0gXCJcIjtcbiAgICAgICAgICAgIHZhciBmdW5jID0gZnVuY3Rpb24oc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuYXJlYSA9IFwiY2l0YXRpb25cIjtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAucm9vdCA9IFwiY2l0YXRpb25cIjtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZXh0ZW5zaW9uID0gXCJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQpIHtcbiAgICAgICAgICAgIHN0YXRlLm9wdC5ncm91cGVkX3NvcnQgPSBzdGF0ZS5vcHQueGNsYXNzID09PSBcImluLXRleHRcIiBcbiAgICAgICAgICAgICAgICAmJiAoc3RhdGUuY2l0YXRpb24ub3B0LmNvbGxhcHNlIFxuICAgICAgICAgICAgICAgICAgICAmJiBzdGF0ZS5jaXRhdGlvbi5vcHQuY29sbGFwc2UubGVuZ3RoKVxuICAgICAgICAgICAgICAgIHx8IChzdGF0ZS5jaXRhdGlvbi5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXJcbiAgICAgICAgICAgICAgICAgICAgJiYgc3RhdGUuY2l0YXRpb24ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyLmxlbmd0aClcbiAgICAgICAgICAgICAgICAmJiBzdGF0ZS5vcHQudXBkYXRlX21vZGUgIT09IENTTC5QT1NJVElPTlxuICAgICAgICAgICAgICAgICYmIHN0YXRlLm9wdC51cGRhdGVfbW9kZSAhPT0gQ1NMLk5VTUVSSUM7XG4gICAgICAgICAgICBpZiAoc3RhdGUub3B0Lmdyb3VwZWRfc29ydCBcbiAgICAgICAgICAgICAgICAmJiBzdGF0ZS5jaXRhdGlvbl9zb3J0Lm9wdC5zb3J0X2RpcmVjdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGZpcnN0a2V5ID0gc3RhdGUuY2l0YXRpb25fc29ydC5vcHQuc29ydF9kaXJlY3Rpb25zWzBdLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgc3RhdGUuY2l0YXRpb25fc29ydC5vcHQuc29ydF9kaXJlY3Rpb25zID0gW2ZpcnN0a2V5XS5jb25jYXQoc3RhdGUuY2l0YXRpb25fc29ydC5vcHQuc29ydF9kaXJlY3Rpb25zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLmNpdGF0aW9uLnNydCA9IG5ldyBDU0wuUmVnaXN0cnkuQ29tcGFyaWZpZXIoc3RhdGUsIFwiY2l0YXRpb25fc29ydFwiKTtcbiAgICAgICAgfVxuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZVtcIiNjb21tZW50XCJdID0ge1xuICAgICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlLmRhdGUgPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIHZhciBmdW5jLCBkYXRlX29iaiwgdG9rLCBsZW4sIHBvcywgcGFydCwgZHB4LCBwYXJ0cywgbXlwb3MsIHN0YXJ0LCBlbmQ7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUIHx8IHRoaXMudG9rZW50eXBlID09PSBDU0wuU0lOR0xFVE9OKSB7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5kYXRlX3BhcnRzID0gW107XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5kYXRlX3ZhcmlhYmxlcyA9IHRoaXMudmFyaWFibGVzO1xuICAgICAgICAgICAgaWYgKCFzdGF0ZS5idWlsZC5leHRlbnNpb24pIHtcbiAgICAgICAgICAgICAgICBDU0wuVXRpbC5zdWJzdGl0dXRlU3RhcnQuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5leHRlbnNpb24pIHtcbiAgICAgICAgICAgICAgICBmdW5jID0gQ1NMLmRhdGVNYWNyb0FzU29ydEtleTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIga2V5LCBkcDtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmVsZW1lbnRfcmVuZGVyZWRfb2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRvbmVzaWVzID0gW107XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5kYXRlcGFydHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZHAgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmFyaWFibGVzLmxlbmd0aFxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgIShzdGF0ZS50bXAuanVzdF9sb29raW5nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIHRoaXMudmFyaWFibGVzWzBdID09PSBcImFjY2Vzc2VkXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRlX29iaiA9IEl0ZW1bdGhpcy52YXJpYWJsZXNbMF1dO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBkYXRlX29iaikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVfb2JqID0ge1wiZGF0ZS1wYXJ0c1wiOiBbWzBdXSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5sb2NhdG9yX2RhdGVfYW5kX3JldmlzaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIHRoaXMudmFyaWFibGVzWzBdID09PSBcImxvY2F0b3ItZGF0ZVwiICYmIGl0ZW1bXCJsb2NhdG9yLWRhdGVcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVfb2JqID0gaXRlbVtcImxvY2F0b3ItZGF0ZVwiXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5kYXRlX29iamVjdCA9IGRhdGVfb2JqO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGVuID0gdGhpcy5kYXRlcGFydHMubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHRoaXMuZGF0ZXBhcnRzW3Bvc107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiBzdGF0ZS50bXAuZGF0ZV9vYmplY3RbKHBhcnQgKyAgXCJfZW5kXCIpXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcC5wdXNoKHBhcnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocGFydCA9PT0gXCJtb250aFwiICYmIFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiBzdGF0ZS50bXAuZGF0ZV9vYmplY3Quc2Vhc29uX2VuZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcC5wdXNoKHBhcnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGRweCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBbXCJ5ZWFyXCIsIFwibW9udGhcIiwgXCJkYXlcIl07XG4gICAgICAgICAgICAgICAgICAgICAgICBsZW4gPSBwYXJ0cy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHAuaW5kZXhPZihwYXJ0c1twb3NdKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRweC5wdXNoKHBhcnRzW3Bvc10pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGRwID0gZHB4LnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBteXBvcyA9IDI7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZW4gPSBkcC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gZHBbcG9zXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHN0YXRlLnRtcC5kYXRlX29iamVjdFtwYXJ0XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBzdGF0ZS50bXAuZGF0ZV9vYmplY3RbKHBhcnQgKyBcIl9lbmRcIildO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGFydCAhPT0gZW5kKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15cG9zID0gcG9zO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZGF0ZV9jb2xsYXBzZV9hdCA9IGRwLnNsaWNlKG15cG9zKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5kYXRlX29iamVjdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBpZiAoIUl0ZW1bdGhpcy52YXJpYWJsZXNbMF1dKSByZXR1cm47XG4gICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwuU3RhcnRWYXJpYWJsZSh0aGlzLnZhcmlhYmxlc1swXSk7XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LnN0YXJ0VGFnKFwiZGF0ZVwiLCB0aGlzKTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy52YXJpYWJsZXNbMF0gPT09IFwiaXNzdWVkXCJcbiAgICAgICAgICAgICAgICAgICAgJiYgSXRlbS50eXBlID09PSBcImxlZ2FsX2Nhc2VcIlxuICAgICAgICAgICAgICAgICAgICAmJiAhc3RhdGUudG1wLmV4dGVuc2lvblxuICAgICAgICAgICAgICAgICAgICAmJiBcIlwiICsgSXRlbVtcImNvbGxlY3Rpb24tbnVtYmVyXCJdID09PSBcIlwiICsgc3RhdGUudG1wLmRhdGVfb2JqZWN0LnllYXJcbiAgICAgICAgICAgICAgICAgICAgJiYgdGhpcy5kYXRlcGFydHMubGVuZ3RoID09PSAxXG4gICAgICAgICAgICAgICAgICAgICYmIHRoaXMuZGF0ZXBhcnRzWzBdID09PSBcInllYXJcIikge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc3RhdGUudG1wLmRhdGVfb2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmRhdGVfb2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LnNsaWNlKDAsIDQpID09PSBcInllYXJcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuaXNzdWVkX2RhdGUgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxzdCA9IHN0YXRlLm91dHB1dC5jdXJyZW50Lm15c3RhY2suc2xpY2UoLTIpWzBdLmJsb2JzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuaXNzdWVkX2RhdGUubGlzdCA9IGxzdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmlzc3VlZF9kYXRlLnBvcyA9IGxzdC5sZW5ndGggLSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFzdGF0ZS5idWlsZC5leHRlbnNpb24gJiYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuRU5EIHx8IHRoaXMudG9rZW50eXBlID09PSBDU0wuU0lOR0xFVE9OKSkge1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIGlmICghSXRlbVt0aGlzLnZhcmlhYmxlc1swXV0pIHJldHVybjtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuZW5kVGFnKCk7XG4gICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwuQ2xvc2VWYXJpYWJsZSh0aGlzLnZhcmlhYmxlc1swXSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB9XG4gICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQgfHwgdGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pIHtcbiAgICAgICAgICAgIGlmICghc3RhdGUuYnVpbGQuZXh0ZW5zaW9uKSB7XG4gICAgICAgICAgICAgICAgQ1NMLlV0aWwuc3Vic3RpdHV0ZUVuZC5jYWxsKHRoaXMsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGVbXCJkYXRlLXBhcnRcIl0gPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIHZhciBmdW5jLCBwb3MsIGxlbiwgZGVjb3IsIGZpcnN0X2RhdGUsIHZhbHVlLCB2YWx1ZV9lbmQsIHJlYWwsIGhhdmVfY29sbGFwc2VkLCBpbnZva2VkLCBwcmVjb25kaXRpb24sIGtub3duX3llYXIsIGJjLCBhZCwgYmNfZW5kLCBhZF9lbmQsIHJlYWR5LCBjdXJyLCBkY3VyciwgbnVtYmVyLCBudW0sIGZvcm1hdHRlciwgaXRlbSwgaSwgaWxlbjtcbiAgICAgICAgaWYgKCF0aGlzLnN0cmluZ3MuZm9ybSkge1xuICAgICAgICAgICAgdGhpcy5zdHJpbmdzLmZvcm0gPSBcImxvbmdcIjtcbiAgICAgICAgfVxuICAgICAgICBzdGF0ZS5idWlsZC5kYXRlX3BhcnRzLnB1c2godGhpcy5zdHJpbmdzLm5hbWUpO1xuICAgICAgICB2YXIgZGF0ZV92YXJpYWJsZSA9IHN0YXRlLmJ1aWxkLmRhdGVfdmFyaWFibGVzWzBdO1xuICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5kYXRlX29iamVjdCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZpcnN0X2RhdGUgPSB0cnVlO1xuICAgICAgICAgICAgdmFsdWUgPSBcIlwiO1xuICAgICAgICAgICAgdmFsdWVfZW5kID0gXCJcIjtcbiAgICAgICAgICAgIHN0YXRlLnRtcC5kb25lc2llcy5wdXNoKHRoaXMuc3RyaW5ncy5uYW1lKTtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZGF0ZV9vYmplY3QubGl0ZXJhbCAmJiBcInllYXJcIiA9PT0gdGhpcy5zdHJpbmdzLm5hbWUpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5BcHBlbmRUb1ZhcmlhYmxlKHN0YXRlLnRtcC5kYXRlX29iamVjdC5saXRlcmFsKTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHN0YXRlLnRtcC5kYXRlX29iamVjdC5saXRlcmFsLCB0aGlzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZGF0ZV9vYmplY3QpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlLnRtcC5kYXRlX29iamVjdFt0aGlzLnN0cmluZ3MubmFtZV07XG4gICAgICAgICAgICAgICAgdmFsdWVfZW5kID0gc3RhdGUudG1wLmRhdGVfb2JqZWN0Wyh0aGlzLnN0cmluZ3MubmFtZSArIFwiX2VuZFwiKV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoXCJ5ZWFyXCIgPT09IHRoaXMuc3RyaW5ncy5uYW1lICYmIHZhbHVlID09PSAwICYmICFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVhbCA9ICFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnM7XG4gICAgICAgICAgICBoYXZlX2NvbGxhcHNlZCA9IHN0YXRlLnRtcC5oYXZlX2NvbGxhcHNlZDtcbiAgICAgICAgICAgIGludm9rZWQgPSBzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0LmNvbGxhcHNlID09PSBcInllYXItc3VmZml4XCIgfHwgc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdC5jb2xsYXBzZSA9PT0gXCJ5ZWFyLXN1ZmZpeC1yYW5nZWRcIjtcbiAgICAgICAgICAgIHByZWNvbmRpdGlvbiA9IHN0YXRlLm9wdFtcImRpc2FtYmlndWF0ZS1hZGQteWVhci1zdWZmaXhcIl07XG4gICAgICAgICAgICBpZiAocmVhbCAmJiBwcmVjb25kaXRpb24gJiYgaW52b2tlZCkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC55ZWFyc191c2VkLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgICAgIGtub3duX3llYXIgPSBzdGF0ZS50bXAubGFzdF95ZWFyc191c2VkLmxlbmd0aCA+PSBzdGF0ZS50bXAueWVhcnNfdXNlZC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgaWYgKGtub3duX3llYXIgJiYgaGF2ZV9jb2xsYXBzZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5sYXN0X3llYXJzX3VzZWRbKHN0YXRlLnRtcC55ZWFyc191c2VkLmxlbmd0aCAtIDEpXSA9PT0gdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgYmMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBhZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGJjX2VuZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGFkX2VuZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChcInllYXJcIiA9PT0gdGhpcy5zdHJpbmdzLm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlSW50KHZhbHVlLCAxMCkgPCA1MDAgJiYgcGFyc2VJbnQodmFsdWUsIDEwKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkID0gc3RhdGUuZ2V0VGVybShcImFkXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJzZUludCh2YWx1ZSwgMTApIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYmMgPSBzdGF0ZS5nZXRUZXJtKFwiYmNcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IChwYXJzZUludCh2YWx1ZSwgMTApICogLTEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZV9lbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJzZUludCh2YWx1ZV9lbmQsIDEwKSA8IDUwMCAmJiBwYXJzZUludCh2YWx1ZV9lbmQsIDEwKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZF9lbmQgPSBzdGF0ZS5nZXRUZXJtKFwiYWRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyc2VJbnQodmFsdWVfZW5kLCAxMCkgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYmNfZW5kID0gc3RhdGUuZ2V0VGVybShcImJjXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlX2VuZCA9IChwYXJzZUludCh2YWx1ZV9lbmQsIDEwKSAqIC0xKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5BcHBlbmRUb1ZhcmlhYmxlKHZhbHVlKTtcbiAgICAgICAgICAgICAgICB2YXIgbW9udGhuYW1laWQgPSBcIlwiK3N0YXRlLnRtcC5kYXRlX29iamVjdC5tb250aDtcbiAgICAgICAgICAgICAgICB3aGlsZSAobW9udGhuYW1laWQubGVuZ3RoIDwgMikge1xuICAgICAgICAgICAgICAgICAgICBtb250aG5hbWVpZCA9IFwiMFwiK21vbnRobmFtZWlkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBtb250aG5hbWVpZCA9IFwibW9udGgtXCIrbW9udGhuYW1laWQ7XG4gICAgICAgICAgICAgICAgdmFyIGdlbmRlciA9IHN0YXRlLmxvY2FsZVtzdGF0ZS5vcHQubGFuZ11bXCJub3VuLWdlbmRlcnNcIl1bbW9udGhuYW1laWRdO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cmluZ3MuZm9ybSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbXlmb3JtID0gdGhpcy5zdHJpbmdzLmZvcm07XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cmluZ3MubmFtZSA9PT0gXCJkYXlcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG15Zm9ybSA9PT0gXCJvcmRpbmFsXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBzdGF0ZS5sb2NhbGVbc3RhdGUub3B0LmxhbmddLm9wdHNbXCJsaW1pdC1kYXktb3JkaW5hbHMtdG8tZGF5LTFcIl1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAoXCJcIiArIHZhbHVlKSAhPT0gXCIxXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBteWZvcm0gPSBcIm51bWVyaWNcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IENTTC5VdGlsLkRhdGVzW3RoaXMuc3RyaW5ncy5uYW1lXVtteWZvcm1dKHN0YXRlLCB2YWx1ZSwgZ2VuZGVyLCB0aGlzLmRlZmF1bHRfbG9jYWxlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFwibW9udGhcIiA9PT0gdGhpcy5zdHJpbmdzLm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuc3RyaXBfcGVyaW9kcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMuZGVjb3JhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcIkBzdHJpcC1wZXJpb2RzXCIgPT09IHRoaXMuZGVjb3JhdGlvbnNbaV1bMF0gJiYgXCJ0cnVlXCIgPT09IHRoaXMuZGVjb3JhdGlvbnNbaV1bMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlX2VuZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVfZW5kID0gQ1NMLlV0aWwuRGF0ZXNbdGhpcy5zdHJpbmdzLm5hbWVdW215Zm9ybV0oc3RhdGUsIHZhbHVlX2VuZCwgZ2VuZGVyLCAoXCJhY2Nlc3NlZFwiID09PSBkYXRlX3ZhcmlhYmxlKSwgXCJfZW5kXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5zdHJpcF9wZXJpb2RzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVfZW5kID0gdmFsdWVfZW5kLnJlcGxhY2UoL1xcLi9nLCBcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLmRlY29yYXRpb25zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJAc3RyaXAtcGVyaW9kc1wiID09PSB0aGlzLmRlY29yYXRpb25zW2ldWzBdICYmIFwidHJ1ZVwiID09PSB0aGlzLmRlY29yYXRpb25zW2ldWzFdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZV9lbmQgPSB2YWx1ZV9lbmQucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChcImVtcHR5XCIpO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZGF0ZV9jb2xsYXBzZV9hdC5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVhZHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBsZW4gPSBzdGF0ZS50bXAuZGF0ZV9jb2xsYXBzZV9hdC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSA9IHN0YXRlLnRtcC5kYXRlX2NvbGxhcHNlX2F0W3Bvc107XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmRvbmVzaWVzLmluZGV4T2YoaXRlbSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZHkgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocmVhZHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcIlwiICsgdmFsdWVfZW5kICE9PSBcIjBcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5kYXRlcHV0LnF1ZXVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdF9kYXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdFtcInllYXItcmFuZ2UtZm9ybWF0XCJdXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIHN0YXRlLm9wdFtcInllYXItcmFuZ2UtZm9ybWF0XCJdICE9PSBcImV4cGFuZGVkXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgIXN0YXRlLnRtcC5kYXRlX29iamVjdC5kYXlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgIXN0YXRlLnRtcC5kYXRlX29iamVjdC5tb250aFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAhc3RhdGUudG1wLmRhdGVfb2JqZWN0LnNlYXNvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiB0aGlzLnN0cmluZ3MubmFtZSA9PT0gXCJ5ZWFyXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgdmFsdWUgJiYgdmFsdWVfZW5kKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlX2VuZCA9IHN0YXRlLmZ1bi55ZWFyX21hbmdsZXIodmFsdWUgKyBcIi1cIiArIHZhbHVlX2VuZCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByYW5nZV9kZWxpbWl0ZXIgPSBzdGF0ZS5nZXRUZXJtKFwieWVhci1yYW5nZS1kZWxpbWl0ZXJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlX2VuZCA9IHZhbHVlX2VuZC5zbGljZSh2YWx1ZV9lbmQuaW5kZXhPZihyYW5nZV9kZWxpbWl0ZXIpICsgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmRhdGVwdXQuYXBwZW5kKHZhbHVlX2VuZCwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpcnN0X2RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuZGF0ZXB1dC5jdXJyZW50LnZhbHVlKClbMF0uc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodmFsdWUsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VyciA9IHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyLmJsb2JzWyhjdXJyLmJsb2JzLmxlbmd0aCAtIDEpXS5zdHJpbmdzLnN1ZmZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHN0YXRlLmdldFRlcm0oXCJ5ZWFyLXJhbmdlLWRlbGltaXRlclwiKSwgXCJlbXB0eVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRjdXJyID0gc3RhdGUuZGF0ZXB1dC5jdXJyZW50LnZhbHVlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyLmJsb2JzID0gY3Vyci5ibG9icy5jb25jYXQoZGN1cnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuZGF0ZXB1dC5zdHJpbmcoc3RhdGUsIHN0YXRlLmRhdGVwdXQucXVldWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRhdGVfY29sbGFwc2VfYXQgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodmFsdWUsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kYXRlX2NvbGxhcHNlX2F0LmluZGV4T2YodGhpcy5zdHJpbmdzLm5hbWUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJcIiArIHZhbHVlX2VuZCAhPT0gXCIwXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmRhdGVwdXQucXVldWUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdF9kYXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5kYXRlcHV0Lm9wZW5MZXZlbChcImVtcHR5XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5kYXRlcHV0LmFwcGVuZCh2YWx1ZV9lbmQsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3RfZGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuZGF0ZXB1dC5jdXJyZW50LnZhbHVlKCkuYmxvYnNbMF0uc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuZGF0ZXB1dC5hcHBlbmQoYmMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuZGF0ZXB1dC5hcHBlbmQoYWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmRhdGVwdXQuY2xvc2VMZXZlbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodmFsdWUsIHRoaXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYmMpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZChiYyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhZCkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKGFkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJtb250aFwiID09PSB0aGlzLnN0cmluZ3MubmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZGF0ZV9vYmplY3Quc2Vhc29uKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gXCJcIiArIHN0YXRlLnRtcC5kYXRlX29iamVjdC5zZWFzb247XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5tYXRjaCgvXlsxLTRdJC8pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAudmFyaWFibGVfc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHN0YXRlLmdldFRlcm0oKFwic2Vhc29uLTBcIiArIHZhbHVlKSksIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHZhbHVlLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLnRtcC52YWx1ZSA9IFtdO1xuICAgICAgICAgICAgaWYgKEl0ZW1bZGF0ZV92YXJpYWJsZV0gJiYgKHZhbHVlIHx8IHN0YXRlLnRtcC5oYXZlX2NvbGxhcHNlZCkgJiYgIXN0YXRlLm9wdC5oYXNfeWVhcl9zdWZmaXggJiYgXCJ5ZWFyXCIgPT09IHRoaXMuc3RyaW5ncy5uYW1lICYmICFzdGF0ZS50bXAuanVzdF9sb29raW5nKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdICYmIHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLnllYXJfc3VmZml4ICE9PSBmYWxzZSAmJiAhc3RhdGUudG1wLmhhc19kb25lX3llYXJfc3VmZml4KSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5oYXNfZG9uZV95ZWFyX3N1ZmZpeCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIG51bSA9IHBhcnNlSW50KHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLnllYXJfc3VmZml4LCAxMCk7XG4gICAgICAgICAgICAgICAgICAgIG51bWJlciA9IG5ldyBDU0wuTnVtZXJpY0Jsb2IoZmFsc2UsIG51bSwgdGhpcywgSXRlbS5pZCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3VjY2Vzc29yX3ByZWZpeCA9IHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5sYXlvdXRfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNwbGljZV9wcmVmaXggPSBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubGF5b3V0X2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyID0gbmV3IENTTC5VdGlsLlN1ZmZpeGF0b3IoQ1NMLlNVRkZJWF9DSEFSUyk7XG4gICAgICAgICAgICAgICAgICAgIG51bWJlci5zZXRGb3JtYXR0ZXIoZm9ybWF0dGVyKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQuY29sbGFwc2UgPT09IFwieWVhci1zdWZmaXgtcmFuZ2VkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlci5yYW5nZV9wcmVmaXggPSBzdGF0ZS5nZXRUZXJtKFwiY2l0YXRpb24tcmFuZ2UtZGVsaW1pdGVyXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuc3VjY2Vzc29yX3ByZWZpeCA9IHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdFtcInllYXItc3VmZml4LWRlbGltaXRlclwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLnN1Y2Nlc3Nvcl9wcmVmaXggPSBzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0W1wieWVhci1zdWZmaXgtZGVsaW1pdGVyXCJdO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLnN1Y2Nlc3Nvcl9wcmVmaXggPSBzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0LmxheW91dF9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbnVtYmVyLlVHTFlfREVMSU1JVEVSX1NVUFBSRVNTX0hBQ0sgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKG51bWJlciwgXCJsaXRlcmFsXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZVtcImVsc2UtaWZcIl0gPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIENTTC5Db25kaXRpb25zLlRvcE5vZGUuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfSxcbiAgICBjb25maWd1cmU6IGZ1bmN0aW9uIChzdGF0ZSwgcG9zKSB7XG4gICAgICAgIENTTC5Db25kaXRpb25zLkNvbmZpZ3VyZS5jYWxsKHRoaXMsIHN0YXRlLCBwb3MpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlW1wiZWxzZVwiXSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfSxcbiAgICBjb25maWd1cmU6IGZ1bmN0aW9uIChzdGF0ZSwgcG9zKSB7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICBzdGF0ZS5jb25maWd1cmUuZmFpbFsoc3RhdGUuY29uZmlndXJlLmZhaWwubGVuZ3RoIC0gMSldID0gcG9zO1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGVbXCJldC1hbFwiXSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmFyZWEgPT09IFwiY2l0YXRpb25cIiB8fCBzdGF0ZS5idWlsZC5hcmVhID09PSBcImJpYmxpb2dyYXBoeVwiKSB7XG4gICAgICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ldGFsX25vZGUgPSB0aGlzO1xuICAgICAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgdGhpcy5zdHJpbmdzLnRlcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmV0YWxfdGVybSA9IHRoaXMuc3RyaW5ncy50ZXJtO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5ncm91cCA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQsIHJlYWxHcm91cCkge1xuICAgICAgICB2YXIgZnVuYywgZXhlY3MsIGRvbmVfdmFycztcbiAgICAgICAgdGhpcy5yZWFsR3JvdXAgPSByZWFsR3JvdXA7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICBDU0wuVXRpbC5zdWJzdGl0dXRlU3RhcnQuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5zdWJzdGl0dXRlX2xldmVsLnZhbHVlKCkpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC5zdWJzdGl0dXRlX2xldmVsLnJlcGxhY2UoKHN0YXRlLmJ1aWxkLnN1YnN0aXR1dGVfbGV2ZWwudmFsdWUoKSArIDEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghdGhpcy5qdXJpcykge1xuICAgICAgICAgICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5zdGFydFRhZyhcImdyb3VwXCIsIHRoaXMpO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cmluZ3MubGFiZWxfZm9ybV9vdmVycmlkZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5sYWJlbF9mb3JtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAubGFiZWxfZm9ybSA9IHRoaXMuc3RyaW5ncy5sYWJlbF9mb3JtX292ZXJyaWRlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cmluZ3MubGFiZWxfY2FwaXRhbGl6ZV9pZl9maXJzdF9vdmVycmlkZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5sYWJlbF9jYXBpdGFsaXplX2lmX2ZpcnN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAubGFiZWxfY2FwaXRhbGl6ZV9pZl9maXJzdCA9IHRoaXMuc3RyaW5ncy5sYWJlbF9jYXBpdGFsaXplX2lmX2ZpcnN0X292ZXJyaWRlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlYWxHcm91cCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY29uZGl0aW9uID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHZhciBmb3JjZV9zdXBwcmVzcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmdyb3VwX2NvbnRleHQubXlzdGFjay5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkucGFyZW50ID0gc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLm91dHB1dF90aXA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGxhYmVsX2Zvcm0gPSBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAubGFiZWxfZm9ybTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFsYWJlbF9mb3JtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9mb3JtID0gdGhpcy5zdHJpbmdzLmxhYmVsX2Zvcm1fb3ZlcnJpZGU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGxhYmVsX2NhcGl0YWxpemVfaWZfZmlyc3QgPSBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAubGFiZWxfY2FwaXRhbGl6ZV9pZl9maXJzdDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFsYWJlbF9jYXBpdGFsaXplX2lmX2ZpcnN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9jYXBpdGFsaXplX2lmX2ZpcnN0ID0gdGhpcy5zdHJpbmdzLmxhYmVsX2NhcGl0YWxpemVfaWZfZmlyc3Q7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbiA9IHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb247XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JjZV9zdXBwcmVzcyA9IHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5mb3JjZV9zdXBwcmVzcztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0cmluZ3MucmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdDogdGhpcy5zdHJpbmdzLnJlamVjdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3Q6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlX3N1cHByZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmVfdmFycyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RyaW5ncy5yZXF1aXJlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdDogdGhpcy5zdHJpbmdzLnJlcXVpcmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90OiBmYWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZV92YXJzID0gW107XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBvbGRfdGVybV9wcmVkZWNlc3Nvcjogc3RhdGUudG1wLnRlcm1fcHJlZGVjZXNzb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXJtX2ludGVuZGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlX2F0dGVtcHQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFibGVfc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZV9zdWNjZXNzX3BhcmVudDogc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnZhcmlhYmxlX3N1Y2Nlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRfdGlwOiBzdGF0ZS5vdXRwdXQuY3VycmVudC50aXAsXG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9mb3JtOiBsYWJlbF9mb3JtLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfY2FwaXRhbGl6ZV9pZl9maXJzdDogbGFiZWxfY2FwaXRhbGl6ZV9pZl9maXJzdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFsbGVsX2NvbmRpdGlvbnM6IHRoaXMuc3RyaW5ncy5zZXRfcGFyYWxsZWxfY29uZGl0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uOiBjb25kaXRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JjZV9zdXBwcmVzczogZm9yY2Vfc3VwcHJlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICBkb25lX3ZhcnM6IHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5kb25lX3ZhcnMuc2xpY2UoKVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgZXhlY3MgPSBbXTtcbiAgICAgICAgICAgIGV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICB0aGlzLmV4ZWNzID0gZXhlY3MuY29uY2F0KHRoaXMuZXhlY3MpO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RyaW5nc1tcImhhcy1wdWJsaXNoZXItYW5kLXB1Ymxpc2hlci1wbGFjZVwiXSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkW1wicHVibGlzaGVyLXNwZWNpYWxcIl0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RyaW5nc1tcInN1Ymdyb3VwLWRlbGltaXRlclwiXVxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgSXRlbS5wdWJsaXNoZXIgJiYgSXRlbVtcInB1Ymxpc2hlci1wbGFjZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHB1Ymxpc2hlcl9sc3QgPSBJdGVtLnB1Ymxpc2hlci5zcGxpdCgvO1xccyovKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwdWJsaXNoZXJfcGxhY2VfbHN0ID0gSXRlbVtcInB1Ymxpc2hlci1wbGFjZVwiXS5zcGxpdCgvO1xccyovKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwdWJsaXNoZXJfbHN0Lmxlbmd0aCA+IDFcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBwdWJsaXNoZXJfbHN0Lmxlbmd0aCA9PT0gcHVibGlzaGVyX3BsYWNlX2xzdC5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wdWJsaXNoZXJPdXRwdXQgPSBuZXcgQ1NMLlB1Ymxpc2hlck91dHB1dChzdGF0ZSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucHVibGlzaGVyT3V0cHV0W1wicHVibGlzaGVyLWxpc3RcIl0gPSBwdWJsaXNoZXJfbHN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnB1Ymxpc2hlck91dHB1dFtcInB1Ymxpc2hlci1wbGFjZS1saXN0XCJdID0gcHVibGlzaGVyX3BsYWNlX2xzdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuanVyaXMpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciB4PTAseGxlbj10YXJnZXQubGVuZ3RoO3g8eGxlbjt4KyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdGFyZ2V0W3hdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgY2hvb3NlX3N0YXJ0ID0gbmV3IENTTC5Ub2tlbihcImNob29zZVwiLCBDU0wuU1RBUlQpO1xuICAgICAgICAgICAgICAgIENTTC5Ob2RlLmNob29zZS5idWlsZC5jYWxsKGNob29zZV9zdGFydCwgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICAgICAgdmFyIGlmX3N0YXJ0ID0gbmV3IENTTC5Ub2tlbihcImlmXCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChtYWNyb05hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnN5cy5yZXRyaWV2ZVN0eWxlTW9kdWxlIHx8ICFDU0wuTU9EVUxFX01BQ1JPU1ttYWNyb05hbWVdIHx8ICFJdGVtLmp1cmlzZGljdGlvbikgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGp1cmlzZGljdGlvbkxpc3QgPSBzdGF0ZS5nZXRKdXJpc2RpY3Rpb25MaXN0KEl0ZW0uanVyaXNkaWN0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUub3B0Lmp1cmlzZGljdGlvbnNfc2VlbltqdXJpc2RpY3Rpb25MaXN0WzBdXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSBzdGF0ZS5yZXRyaWV2ZUFsbFN0eWxlTW9kdWxlcyhqdXJpc2RpY3Rpb25MaXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqdXJpc2RpY3Rpb24gaW4gcmVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYWNyb0NvdW50ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuanVyaXNbanVyaXNkaWN0aW9uXSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbXlYbWwgPSBDU0wuc2V0dXBYbWwocmVzW2p1cmlzZGljdGlvbl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbXlOb2RlcyA9IG15WG1sLmdldE5vZGVzQnlOYW1lKG15WG1sLmRhdGFPYmosIFwibGF3LW1vZHVsZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bXlOb2Rlcy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG15VHlwZXMgPSBteVhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShteU5vZGVzW2ldLFwidHlwZXNcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXlUeXBlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmp1cmlzW2p1cmlzZGljdGlvbl0udHlwZXMgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteVR5cGVzID0gIG15VHlwZXMuc3BsaXQoL1xccysvKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqPTAsamxlbj1teVR5cGVzLmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmp1cmlzW2p1cmlzZGljdGlvbl0udHlwZXNbbXlUeXBlc1tqXV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLmp1cmlzW2p1cmlzZGljdGlvbl0udHlwZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmp1cmlzW2p1cmlzZGljdGlvbl0udHlwZXMgPSBDU0wuTU9EVUxFX1RZUEVTO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBteU5vZGVzID0gbXlYbWwuZ2V0Tm9kZXNCeU5hbWUobXlYbWwuZGF0YU9iaiwgXCJtYWNyb1wiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bXlOb2Rlcy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG15TmFtZSA9IG15WG1sLmdldEF0dHJpYnV0ZVZhbHVlKG15Tm9kZXNbaV0sIFwibmFtZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghQ1NMLk1PRFVMRV9NQUNST1NbbXlOYW1lXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENTTC5kZWJ1ZyhcIkNTTDogc2tpcHBpbmcgbm9uLW1vZHVsYXIgbWFjcm8gbmFtZSBcXFwiXCIgKyBteU5hbWUgKyBcIlxcXCIgaW4gbW9kdWxlIGNvbnRleHRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFjcm9Db3VudCsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuanVyaXNbanVyaXNkaWN0aW9uXVtteU5hbWVdID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZFRva2VuTGlzdHMobXlOb2Rlc1tpXSwgc3RhdGUuanVyaXNbanVyaXNkaWN0aW9uXVtteU5hbWVdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmNvbmZpZ3VyZVRva2VuTGlzdChzdGF0ZS5qdXJpc1tqdXJpc2RpY3Rpb25dW215TmFtZV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49anVyaXNkaWN0aW9uTGlzdC5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqdXJpc2RpY3Rpb24gPSBqdXJpc2RpY3Rpb25MaXN0W2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN0YXRlLmp1cmlzW2p1cmlzZGljdGlvbl0gJiYgc3RhdGUuanVyaXNbanVyaXNkaWN0aW9uXS50eXBlc1tJdGVtLnR5cGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEl0ZW1bXCJiZXN0LWp1cmlzZGljdGlvblwiXSA9IGp1cmlzZGljdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0odGhpcy5qdXJpcyk7XG4gICAgICAgICAgICAgICAgaWZfc3RhcnQudGVzdHMucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICBpZl9zdGFydC50ZXN0ID0gc3RhdGUuZnVuLm1hdGNoLmFueShpZl9zdGFydCwgc3RhdGUsIGlmX3N0YXJ0LnRlc3RzKTtcbiAgICAgICAgICAgICAgICB0YXJnZXQucHVzaChpZl9zdGFydCk7XG4gICAgICAgICAgICAgICAgdmFyIHRleHRfbm9kZSA9IG5ldyBDU0wuVG9rZW4oXCJ0ZXh0XCIsIENTTC5TSU5HTEVUT04pO1xuICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5leHQgPSAwO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuanVyaXNbSXRlbVtcImJlc3QtanVyaXNkaWN0aW9uXCJdXVt0aGlzLmp1cmlzXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG5leHQgPCBzdGF0ZS5qdXJpc1tJdGVtW1wiYmVzdC1qdXJpc2RpY3Rpb25cIl1dW3RoaXMuanVyaXNdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSBDU0wudG9rZW5FeGVjLmNhbGwoc3RhdGUsIHN0YXRlLmp1cmlzW0l0ZW1bXCJiZXN0LWp1cmlzZGljdGlvblwiXV1bdGhpcy5qdXJpc11bbmV4dF0sIEl0ZW0sIGl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRleHRfbm9kZS5qdXJpcyA9IHRoaXMuanVyaXM7XG4gICAgICAgICAgICAgICAgdGV4dF9ub2RlLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LnB1c2godGV4dF9ub2RlKTtcbiAgICAgICAgICAgICAgICB2YXIgaWZfZW5kID0gbmV3IENTTC5Ub2tlbihcImlmXCIsIENTTC5FTkQpO1xuICAgICAgICAgICAgICAgIENTTC5Ob2RlW1wiaWZcIl0uYnVpbGQuY2FsbChpZl9lbmQsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIHZhciBlbHNlX3N0YXJ0ID0gbmV3IENTTC5Ub2tlbihcImVsc2VcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgICAgICAgICBDU0wuTm9kZVtcImVsc2VcIl0uYnVpbGQuY2FsbChlbHNlX3N0YXJ0LCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQpIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZFtcInB1Ymxpc2hlci1zcGVjaWFsXCJdKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUuYnVpbGRbXCJwdWJsaXNoZXItc3BlY2lhbFwiXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2Ygc3RhdGVbc3RhdGUuYnVpbGQucm9vdF0ub3B0W1wibmFtZS1kZWxpbWl0ZXJcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnB1Ymxpc2hlck91dHB1dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnB1Ymxpc2hlck91dHB1dC5yZW5kZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wdWJsaXNoZXJPdXRwdXQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuZW5kVGFnKCk7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucmVhbEdyb3VwKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBmbGFncyA9IHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmNvbmRpdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmZvcmNlX3N1cHByZXNzID0gZmxhZ3MuZm9yY2Vfc3VwcHJlc3M7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFmbGFncy5mb3JjZV9zdXBwcmVzcyAmJiAoZmxhZ3MudmFyaWFibGVfc3VjY2VzcyB8fCAoZmxhZ3MudGVybV9pbnRlbmRlZCAmJiAhZmxhZ3MudmFyaWFibGVfYXR0ZW1wdCkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNKdXJpc0xvY2F0b3JMYWJlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBibG9icyA9IHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkuYmxvYnM7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zID0gc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5ibG9icy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAuanVzdF9sb29raW5nICYmIFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiBmbGFncy5wYXJhbGxlbF9jb25kaXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFsbGVsX2NvbmRpdGlvbl9vYmplY3QgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2JzOiBibG9icyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uczogZmxhZ3MucGFyYWxsZWxfY29uZGl0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IEl0ZW0uaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvczogcG9zXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5wYXJhbGxlbF9jb25kaXRpb25hbF9ibG9ic19saXN0LnB1c2gocGFyYWxsZWxfY29uZGl0aW9uX29iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAudGVybV9wcmVkZWNlc3NvciA9IGZsYWdzLm9sZF90ZXJtX3ByZWRlY2Vzc29yO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnZhcmlhYmxlX2F0dGVtcHQgPSBmbGFncy52YXJpYWJsZV9hdHRlbXB0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzLmZvcmNlX3N1cHByZXNzICYmICFzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuY29uZGl0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnZhcmlhYmxlX2F0dGVtcHQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9zdWNjZXNzID0gZmxhZ3MudmFyaWFibGVfc3VjY2Vzc19wYXJlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49ZmxhZ3MuZG9uZV92YXJzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZG9uZV92YXJzLmluZGV4T2YoZmxhZ3MuZG9uZV92YXJzW2ldKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZG9uZV92YXJzID0gc3RhdGUudG1wLmRvbmVfdmFycy5zbGljZSgwLCBpKS5jb25jYXQoc3RhdGUudG1wLmRvbmVfdmFycy5zbGljZShpKzEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLmJsb2JzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5ibG9icy5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICBpZiAodGhpcy5qdXJpcykge1xuICAgICAgICAgICAgICAgIHZhciBlbHNlX2VuZCA9IG5ldyBDU0wuVG9rZW4oXCJlbHNlXCIsIENTTC5FTkQpO1xuICAgICAgICAgICAgICAgIENTTC5Ob2RlW1wiZWxzZVwiXS5idWlsZC5jYWxsKGVsc2VfZW5kLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB2YXIgY2hvb3NlX2VuZCA9IG5ldyBDU0wuVG9rZW4oXCJjaG9vc2VcIiwgQ1NMLkVORCk7XG4gICAgICAgICAgICAgICAgQ1NMLk5vZGUuY2hvb3NlLmJ1aWxkLmNhbGwoY2hvb3NlX2VuZCwgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuRU5EKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuanVyaXMpIHtcbiAgICAgICAgICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5zdWJzdGl0dXRlX2xldmVsLnZhbHVlKCkpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC5zdWJzdGl0dXRlX2xldmVsLnJlcGxhY2UoKHN0YXRlLmJ1aWxkLnN1YnN0aXR1dGVfbGV2ZWwudmFsdWUoKSAtIDEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIENTTC5VdGlsLnN1YnN0aXR1dGVFbmQuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlW1wiaWZcIl0gPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIENTTC5Db25kaXRpb25zLlRvcE5vZGUuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfSxcbiAgICBjb25maWd1cmU6IGZ1bmN0aW9uIChzdGF0ZSwgcG9zKSB7XG4gICAgICAgIENTTC5Db25kaXRpb25zLkNvbmZpZ3VyZS5jYWxsKHRoaXMsIHN0YXRlLCBwb3MpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlW1wiY29uZGl0aW9uc1wiXSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIHN0YXRlLnRtcC5jb25kaXRpb25zLmFkZE1hdGNoKHRoaXMubWF0Y2gpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLkVORCkge1xuICAgICAgICAgICAgc3RhdGUudG1wLmNvbmRpdGlvbnMubWF0Y2hDb21iaW5lKCk7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZVtcImNvbmRpdGlvblwiXSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU0lOR0xFVE9OKSB7XG4gICAgICAgICAgICB2YXIgdGVzdCA9IHN0YXRlLmZ1bi5tYXRjaFt0aGlzLm1hdGNoXSh0aGlzLCBzdGF0ZSwgdGhpcy50ZXN0cyk7XG4gICAgICAgICAgICBzdGF0ZS50bXAuY29uZGl0aW9ucy5hZGRUZXN0KHRlc3QpO1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkNvbmRpdGlvbnMgPSB7fTtcbkNTTC5Db25kaXRpb25zLlRvcE5vZGUgPSBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgIHZhciBmdW5jO1xuICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUIHx8IHRoaXMudG9rZW50eXBlID09PSBDU0wuU0lOR0xFVE9OKSB7XG4gICAgICAgIGlmICh0aGlzLmxvY2FsZSkge1xuICAgICAgICAgICAgc3RhdGUub3B0LmxhbmcgPSB0aGlzLmxvY2FsZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMudGVzdHMgfHwgIXRoaXMudGVzdHMubGVuZ3RoKSB7XG4gICAgICAgICAgICBzdGF0ZS50bXAuY29uZGl0aW9ucyA9IG5ldyBDU0wuQ29uZGl0aW9ucy5FbmdpbmUoc3RhdGUsIHRoaXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50ZXN0ID0gc3RhdGUuZnVuLm1hdGNoW3RoaXMubWF0Y2hdKHRoaXMsIHN0YXRlLCB0aGlzLnRlc3RzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQgfHwgdGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pIHtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxlX2RlZmF1bHQpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLm9sZF9sb2NhbGUgPSB0aGlzLmxvY2FsZV9kZWZhdWx0O1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jbG9zZUxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgICAgICAgICAgc3RhdGUub3B0LmxhbmcgPSB0aGlzLmxvY2FsZV9kZWZhdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG5leHQgPSB0aGlzW3N0YXRlLnRtcC5qdW1wLnZhbHVlKCldO1xuICAgICAgICAgICAgcmV0dXJuIG5leHQ7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgaWYgKHRoaXMubG9jYWxlX2RlZmF1bHQpIHtcbiAgICAgICAgICAgIHN0YXRlLm9wdC5sYW5nID0gdGhpcy5sb2NhbGVfZGVmYXVsdDtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuQ29uZGl0aW9ucy5Db25maWd1cmUgPSBmdW5jdGlvbiAoc3RhdGUsIHBvcykge1xuICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgIHRoaXMuZmFpbCA9IHN0YXRlLmNvbmZpZ3VyZS5mYWlsLnNsaWNlKC0xKVswXTtcbiAgICAgICAgdGhpcy5zdWNjZWVkID0gdGhpcy5uZXh0O1xuICAgICAgICBzdGF0ZS5jb25maWd1cmUuZmFpbFsoc3RhdGUuY29uZmlndXJlLmZhaWwubGVuZ3RoIC0gMSldID0gcG9zO1xuICAgIH0gZWxzZSBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pIHtcbiAgICAgICAgdGhpcy5mYWlsID0gdGhpcy5uZXh0O1xuICAgICAgICB0aGlzLnN1Y2NlZWQgPSBzdGF0ZS5jb25maWd1cmUuc3VjY2VlZC5zbGljZSgtMSlbMF07XG4gICAgICAgIHN0YXRlLmNvbmZpZ3VyZS5mYWlsWyhzdGF0ZS5jb25maWd1cmUuZmFpbC5sZW5ndGggLSAxKV0gPSBwb3M7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdWNjZWVkID0gc3RhdGUuY29uZmlndXJlLnN1Y2NlZWQuc2xpY2UoLTEpWzBdO1xuICAgICAgICB0aGlzLmZhaWwgPSB0aGlzLm5leHQ7XG4gICAgfVxufTtcbkNTTC5Db25kaXRpb25zLkVuZ2luZSA9IGZ1bmN0aW9uIChzdGF0ZSwgdG9rZW4pIHtcbiAgICB0aGlzLnRva2VuID0gdG9rZW47XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xufTtcbkNTTC5Db25kaXRpb25zLkVuZ2luZS5wcm90b3R5cGUuYWRkVGVzdCA9IGZ1bmN0aW9uICh0ZXN0KSB7XG4gICAgdGhpcy50b2tlbi50ZXN0cy5wdXNoKHRlc3QpO1xufTtcbkNTTC5Db25kaXRpb25zLkVuZ2luZS5wcm90b3R5cGUuYWRkTWF0Y2ggPSBmdW5jdGlvbiAobWF0Y2gpIHtcbiAgICB0aGlzLnRva2VuLm1hdGNoID0gbWF0Y2g7XG59O1xuQ1NMLkNvbmRpdGlvbnMuRW5naW5lLnByb3RvdHlwZS5tYXRjaENvbWJpbmUgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy50b2tlbi50ZXN0ID0gdGhpcy5zdGF0ZS5mdW4ubWF0Y2hbdGhpcy50b2tlbi5tYXRjaF0odGhpcy50b2tlbiwgdGhpcy5zdGF0ZSwgdGhpcy50b2tlbi50ZXN0cyk7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5pbmZvID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TVEFSVCkge1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuc2tpcCA9IFwiaW5mb1wiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuc2tpcCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUuaW5zdGl0dXRpb24gPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIGlmIChbQ1NMLlNJTkdMRVRPTiwgQ1NMLlNUQVJUXS5pbmRleE9mKHRoaXMudG9rZW50eXBlKSA+IC0xKSB7XG4gICAgICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgdGhpcy5zdHJpbmdzLmRlbGltaXRlcikge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuaW5zdGl0dXRpb25fZGVsaW1pdGVyID0gdGhpcy5zdHJpbmdzLmRlbGltaXRlcjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuaW5zdGl0dXRpb25fZGVsaW1pdGVyID0gc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgbXlhbmQsIGFuZF9kZWZhdWx0X3ByZWZpeCwgYW5kX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICBpZiAoXCJ0ZXh0XCIgPT09IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJhbmRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfdGVybSA9IHN0YXRlLmdldFRlcm0oXCJhbmRcIiwgXCJsb25nXCIsIDApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJzeW1ib2xcIiA9PT0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImFuZFwiKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZXhwZWN0X2FuZF9zeW1ib2xfZm9ybSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfdGVybSA9IHN0YXRlLmdldFRlcm0oXCJhbmRcIiwgXCJzeW1ib2xcIiwgMCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF90ZXJtID0gXCImXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwibm9uZVwiID09PSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiYW5kXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3Rlcm0gPSBzdGF0ZS50bXAuaW5zdGl0dXRpb25fZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMuYW5kX3Rlcm0gJiYgc3RhdGUudG1wLmFuZF90ZXJtKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3Rlcm0gPSBzdGF0ZS5nZXRUZXJtKFwiYW5kXCIsIFwibG9uZ1wiLCAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKENTTC5TVEFSVFNXSVRIX1JPTUFORVNRVUVfUkVHRVhQLnRlc3QodGhpcy5hbmRfdGVybSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X3NpbmdsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfbXVsdGlwbGUgPSBcIiwgXCI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2Ygc3RhdGUudG1wLmluc3RpdHV0aW9uX2RlbGltaXRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X211bHRpcGxlID0gc3RhdGUudG1wLmluc3RpdHV0aW9uX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9zdWZmaXggPSBcIiBcIjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X211bHRpcGxlID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfc3VmZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiKSA9PT0gXCJhbHdheXNcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlID0gc3RhdGUudG1wLmluc3RpdHV0aW9uX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiKSA9PT0gXCJuZXZlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZF9wcmVmaXhfbXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuYW5kID0ge307XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB0aGlzLmFuZF90ZXJtKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodGhpcy5hbmRfdGVybSwgXCJlbXB0eVwiLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQuc2luZ2xlID0gc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5zdWZmaXggPSB0aGlzLmFuZF9zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodGhpcy5hbmRfdGVybSwgXCJlbXB0eVwiLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQubXVsdGlwbGUgPSBzdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLm11bHRpcGxlLnN0cmluZ3MucHJlZml4ID0gdGhpcy5hbmRfcHJlZml4X211bHRpcGxlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZS5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuYW5kX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgIT09IHRoaXMuc3RyaW5ncy5kZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQuc2luZ2xlID0gbmV3IENTTC5CbG9iKHN0YXRlLnRtcC5pbnN0aXR1dGlvbl9kZWxpbWl0ZXIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5zdWZmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZSA9IG5ldyBDU0wuQmxvYihzdGF0ZS50bXAuaW5zdGl0dXRpb25fZGVsaW1pdGVyKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQubXVsdGlwbGUuc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZS5zdHJpbmdzLnN1ZmZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQuaW5zdGl0dXRpb24gPSB0aGlzO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9LFxuICAgIGNvbmZpZ3VyZTogZnVuY3Rpb24gKHN0YXRlLCBwb3MpIHtcbiAgICAgICAgaWYgKFtDU0wuU0lOR0xFVE9OLCBDU0wuU1RBUlRdLmluZGV4T2YodGhpcy50b2tlbnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmhhc19pbnN0aXR1dGlvbiA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZVtcImluc3RpdHV0aW9uLXBhcnRcIl0gPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIHZhciBmdW5jO1xuICAgICAgICBpZiAoXCJsb25nXCIgPT09IHRoaXMuc3RyaW5ncy5uYW1lKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zdHJpbmdzW1wiaWYtc2hvcnRcIl0pIHtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQuaW5zdGl0dXRpb25wYXJ0W1wibG9uZy13aXRoLXNob3J0XCJdID0gdGhpcztcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQuaW5zdGl0dXRpb25wYXJ0W1wibG9uZ1wiXSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChcInNob3J0XCIgPT09IHRoaXMuc3RyaW5ncy5uYW1lKSB7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5pbnN0aXR1dGlvbnBhcnRbXCJzaG9ydFwiXSA9IHRoaXM7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUua2V5ID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB0YXJnZXQgPSBzdGF0ZVtzdGF0ZS5idWlsZC5yb290ICsgXCJfc29ydFwiXS50b2tlbnM7XG4gICAgICAgIHZhciBmdW5jLCBpLCBpbGVuO1xuICAgICAgICB2YXIgZGVidWcgPSBmYWxzZTtcbiAgICAgICAgdmFyIHN0YXJ0X2tleSA9IG5ldyBDU0wuVG9rZW4oXCJrZXlcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgc3RhdGUudG1wLnJvb3QgPSBzdGF0ZS5idWlsZC5yb290O1xuICAgICAgICBzdGFydF9rZXkuc3RyaW5nc1tcImV0LWFsLW1pblwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC1taW5cIik7XG4gICAgICAgIHN0YXJ0X2tleS5zdHJpbmdzW1wiZXQtYWwtdXNlLWZpcnN0XCJdID0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImV0LWFsLXVzZS1maXJzdFwiKTtcbiAgICAgICAgc3RhcnRfa2V5LnN0cmluZ3NbXCJldC1hbC11c2UtbGFzdFwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtbGFzdFwiKTtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgc3RhdGUudG1wLmRvbmVfdmFycyA9IFtdO1xuICAgICAgICB9O1xuICAgICAgICBzdGFydF9rZXkuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zb3J0X2RpcmVjdGlvbiA9IHRoaXMuc3RyaW5ncy5zb3J0X2RpcmVjdGlvbjtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChcImVtcHR5XCIpO1xuICAgICAgICB9O1xuICAgICAgICBzdGFydF9rZXkuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgdmFyIHNvcnRfZGlyZWN0aW9uID0gW107XG4gICAgICAgIGlmICh0aGlzLnN0cmluZ3Muc29ydF9kaXJlY3Rpb24gPT09IENTTC5ERVNDRU5ESU5HKSB7XG4gICAgICAgICAgICBzb3J0X2RpcmVjdGlvbi5wdXNoKDEpO1xuICAgICAgICAgICAgc29ydF9kaXJlY3Rpb24ucHVzaCgtMSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzb3J0X2RpcmVjdGlvbi5wdXNoKC0xKTtcbiAgICAgICAgICAgIHNvcnRfZGlyZWN0aW9uLnB1c2goMSk7XG4gICAgICAgIH1cbiAgICAgICAgc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LnNvcnRfZGlyZWN0aW9ucy5wdXNoKHNvcnRfZGlyZWN0aW9uKTtcbiAgICAgICAgaWYgKENTTC5EQVRFX1ZBUklBQkxFUy5pbmRleE9mKHRoaXMudmFyaWFibGVzWzBdKSA+IC0xKSB7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5kYXRlX2tleSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgc3RhdGUudG1wLnNvcnRfa2V5X2ZsYWcgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC1taW5cIikpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXBbXCJldC1hbC1taW5cIl0gPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtbWluXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtZmlyc3RcIikpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXBbXCJldC1hbC11c2UtZmlyc3RcIl0gPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWZpcnN0XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKFwiYm9vbGVhblwiID09PSB0eXBlb2Ygc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImV0LWFsLXVzZS1sYXN0XCIpKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWxhc3RcIl0gPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWxhc3RcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHN0YXJ0X2tleS5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB0YXJnZXQucHVzaChzdGFydF9rZXkpO1xuICAgICAgICBpZiAodGhpcy52YXJpYWJsZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgdmFyaWFibGUgPSB0aGlzLnZhcmlhYmxlc1swXTtcbiAgICAgICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJjaXRhdGlvbi1udW1iZXJcIikge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5hcmVhID09PSBcImNpdGF0aW9uXCIgJiYgc3RhdGUuYnVpbGQuZXh0ZW5zaW9uID09PSBcIl9zb3J0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zb3J0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5yb290ID09PSBcImJpYmxpb2dyYXBoeVwiICYmIHN0YXRlLmJ1aWxkLmV4dGVuc2lvbiA9PT0gXCJfc29ydFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5jaXRhdGlvbl9udW1iZXJfc29ydF91c2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKENTTC5DUkVBVE9SUy5pbmRleE9mKHZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5hbWVzX3N0YXJ0X3Rva2VuID0gbmV3IENTTC5Ub2tlbihcIm5hbWVzXCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICAgICAgbmFtZXNfc3RhcnRfdG9rZW4udG9rZW50eXBlID0gQ1NMLlNUQVJUO1xuICAgICAgICAgICAgICAgIG5hbWVzX3N0YXJ0X3Rva2VuLnZhcmlhYmxlcyA9IHRoaXMudmFyaWFibGVzO1xuICAgICAgICAgICAgICAgIENTTC5Ob2RlLm5hbWVzLmJ1aWxkLmNhbGwobmFtZXNfc3RhcnRfdG9rZW4sIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIHZhciBuYW1lX3Rva2VuID0gbmV3IENTTC5Ub2tlbihcIm5hbWVcIiwgQ1NMLlNJTkdMRVRPTik7XG4gICAgICAgICAgICAgICAgbmFtZV90b2tlbi50b2tlbnR5cGUgPSBDU0wuU0lOR0xFVE9OO1xuICAgICAgICAgICAgICAgIG5hbWVfdG9rZW4uc3RyaW5nc1tcIm5hbWUtYXMtc29ydC1vcmRlclwiXSA9IFwiYWxsXCI7XG4gICAgICAgICAgICAgICAgbmFtZV90b2tlbi5zdHJpbmdzW1wic29ydC1zZXBhcmF0b3JcIl0gPSBcIiBcIjtcbiAgICAgICAgICAgICAgICBuYW1lX3Rva2VuLnN0cmluZ3NbXCJldC1hbC11c2UtbGFzdFwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtbGFzdFwiKTtcbiAgICAgICAgICAgICAgICBuYW1lX3Rva2VuLnN0cmluZ3NbXCJldC1hbC1taW5cIl0gPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtbWluXCIpO1xuICAgICAgICAgICAgICAgIG5hbWVfdG9rZW4uc3RyaW5nc1tcImV0LWFsLXVzZS1maXJzdFwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtZmlyc3RcIik7XG4gICAgICAgICAgICAgICAgQ1NMLk5vZGUubmFtZS5idWlsZC5jYWxsKG5hbWVfdG9rZW4sIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIHZhciBpbnN0aXR1dGlvbl90b2tlbiA9IG5ldyBDU0wuVG9rZW4oXCJpbnN0aXR1dGlvblwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgICAgICBpbnN0aXR1dGlvbl90b2tlbi50b2tlbnR5cGUgPSBDU0wuU0lOR0xFVE9OO1xuICAgICAgICAgICAgICAgIENTTC5Ob2RlLmluc3RpdHV0aW9uLmJ1aWxkLmNhbGwoaW5zdGl0dXRpb25fdG9rZW4sIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIHZhciBuYW1lc19lbmRfdG9rZW4gPSBuZXcgQ1NMLlRva2VuKFwibmFtZXNcIiwgQ1NMLkVORCk7XG4gICAgICAgICAgICAgICAgbmFtZXNfZW5kX3Rva2VuLnRva2VudHlwZSA9IENTTC5FTkQ7XG4gICAgICAgICAgICAgICAgQ1NMLk5vZGUubmFtZXMuYnVpbGQuY2FsbChuYW1lc19lbmRfdG9rZW4sIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgc2luZ2xlX3RleHQgPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgICAgICBzaW5nbGVfdGV4dC5kYXRlcGFydHMgPSB0aGlzLmRhdGVwYXJ0cztcbiAgICAgICAgICAgICAgICBpZiAoQ1NMLk5VTUVSSUNfVkFSSUFCTEVTLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG51bSwgbTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwiY2l0YXRpb24tbnVtYmVyXCIgPT09IHZhcmlhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtID0gc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uc2VxLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9IEl0ZW1bdmFyaWFibGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG51bSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9IENTTC5VdGlsLnBhZGRpbmcobnVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQobnVtLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhcmlhYmxlID09PSBcImNpdGF0aW9uLWxhYmVsXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyaWdyYXBoID0gc3RhdGUuZ2V0Q2l0YXRpb25MYWJlbChJdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodHJpZ3JhcGgsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQ1NMLkRBVEVfVkFSSUFCTEVTLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IENTTC5kYXRlQXNTb3J0S2V5O1xuICAgICAgICAgICAgICAgICAgICBzaW5nbGVfdGV4dC52YXJpYWJsZXMgPSB0aGlzLnZhcmlhYmxlcztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwidGl0bGVcIiA9PT0gdmFyaWFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFiYnJldmZhbSA9IFwidGl0bGVcIjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFiYnJmYWxsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHZhciBhbHR2YXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRyYW5zZmFsbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBzdGF0ZS50cmFuc2Zvcm0uZ2V0T3V0cHV0RnVuY3Rpb24odGhpcy52YXJpYWJsZXMsIGFiYnJldmZhbSwgYWJicmZhbGwsIGFsdHZhciwgdHJhbnNmYWxsKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFydmFsID0gSXRlbVt2YXJpYWJsZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHZhcnZhbCwgXCJlbXB0eVwiKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2luZ2xlX3RleHQuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICB0YXJnZXQucHVzaChzaW5nbGVfdGV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7IC8vIG1hY3JvXG4gICAgICAgICAgICB2YXIgdG9rZW4gPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgIHRva2VuLnBvc3Rwb25lZF9tYWNybyA9IHRoaXMucG9zdHBvbmVkX21hY3JvO1xuICAgICAgICAgICAgQ1NMLmV4cGFuZE1hY3JvLmNhbGwoc3RhdGUsIHRva2VuLCB0YXJnZXQpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBlbmRfa2V5ID0gbmV3IENTTC5Ub2tlbihcImtleVwiLCBDU0wuRU5EKTtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgdmFyIGtleXN0cmluZyA9IHN0YXRlLm91dHB1dC5zdHJpbmcoc3RhdGUsIHN0YXRlLm91dHB1dC5xdWV1ZSk7XG4gICAgICAgICAgICBpZiAoc3RhdGUuc3lzLm5vcm1hbGl6ZVVuaWNvZGUpIHtcbiAgICAgICAgICAgICAgICBrZXlzdHJpbmcgPSBzdGF0ZS5zeXMubm9ybWFsaXplVW5pY29kZShrZXlzdHJpbmcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAga2V5c3RyaW5nID0ga2V5c3RyaW5nID8gKGtleXN0cmluZy5zcGxpdChcIiBcIikuam9pbihzdGF0ZS5vcHQuc29ydF9zZXApICsgc3RhdGUub3B0LnNvcnRfc2VwKSA6IFwiXCI7XG4gICAgICAgICAgICBpZiAoXCJcIiA9PT0ga2V5c3RyaW5nKSB7XG4gICAgICAgICAgICAgICAga2V5c3RyaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgIT09IHR5cGVvZiBrZXlzdHJpbmcgfHwgc3RhdGUudG1wLmVtcHR5X2RhdGUpIHtcbiAgICAgICAgICAgICAgICBrZXlzdHJpbmcgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmVtcHR5X2RhdGUgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlW3N0YXRlW3N0YXRlLnRtcC5hcmVhXS5yb290ICsgXCJfc29ydFwiXS5rZXlzLnB1c2goa2V5c3RyaW5nKTtcbiAgICAgICAgICAgIHN0YXRlLnRtcC52YWx1ZSA9IFtdO1xuICAgICAgICB9O1xuICAgICAgICBlbmRfa2V5LmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIGlmIChzdGF0ZS5idWlsZC5kYXRlX2tleSkge1xuICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmFyZWEgPT09IFwiY2l0YXRpb25cIiAmJiBzdGF0ZS5idWlsZC5leHRlbnNpb24gPT09IFwiX3NvcnRcIikge1xuICAgICAgICAgICAgICAgIHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5zb3J0X2RpcmVjdGlvbnMucHVzaChbLTEsMV0pO1xuICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHllYXJfc3VmZml4ID0gc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcueWVhcl9zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIGlmICgheWVhcl9zdWZmaXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHllYXJfc3VmZml4ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gQ1NMLlV0aWwucGFkZGluZyhcIlwiICsgeWVhcl9zdWZmaXgpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ua2V5cy5wdXNoKGtleSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVuZF9rZXkuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmRhdGVfa2V5ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtbWluXCJdID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWZpcnN0XCJdID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWxhc3RcIl0gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBzdGF0ZS50bXAuc29ydF9rZXlfZmxhZyA9IGZhbHNlO1xuICAgICAgICB9O1xuICAgICAgICBlbmRfa2V5LmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIHRhcmdldC5wdXNoKGVuZF9rZXkpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlLmxhYmVsID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB2YXIgZGVidWcgPSBmYWxzZTtcbiAgICAgICAgaWYgKHRoaXMuc3RyaW5ncy50ZXJtKSB7XG4gICAgICAgICAgICB2YXIgcGx1cmFsID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoIXRoaXMuc3RyaW5ncy5mb3JtKSB7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIHZhciB0ZXJtdHh0ID0gQ1NMLmV2YWx1YXRlTGFiZWwodGhpcywgc3RhdGUsIEl0ZW0sIGl0ZW0pO1xuICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIHRoaXMuc3RyaW5ncy50ZXJtID09PSBcImxvY2F0b3JcIikge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5TdGFydFZhcmlhYmxlKFwibGFiZWxcIik7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkFwcGVuZFRvVmFyaWFibGUoaXRlbS5sYWJlbCk7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uc2VjdGlvbl9mb3JtX292ZXJyaWRlID0gdGhpcy5zdHJpbmdzLmZvcm07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0ZXJtdHh0KSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC50ZXJtX2ludGVuZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgQ1NMLlVQREFURV9HUk9VUF9DT05URVhUX0NPTkRJVElPTihzdGF0ZSwgdGVybXR4dCk7XG4gICAgICAgICAgICAgICAgaWYgKHRlcm10eHQuaW5kZXhPZihcIiVzXCIpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJpbmdzLmNhcGl0YWxpemVfaWZfZmlyc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLnRlcm1fcHJlZGVjZXNzb3IgJiYgIShzdGF0ZS5vcHRbXCJjbGFzc1wiXSA9PT0gXCJpbi10ZXh0XCIgJiYgc3RhdGUudG1wLmFyZWEgPT09IFwiY2l0YXRpb25cIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXJtdHh0ID0gQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzW1wiY2FwaXRhbGl6ZS1maXJzdFwiXShzdGF0ZSwgdGVybXR4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh0ZXJtdHh0LCB0aGlzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgdGhpcy5zdHJpbmdzLnRlcm0gPT09IFwibG9jYXRvclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkNsb3NlVmFyaWFibGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIG5hbWV2YXJzID0gc3RhdGUuYnVpbGQubmFtZXNfdmFyaWFibGVzLnNsaWNlKC0xKVswXTtcbiAgICAgICAgICAgIGlmICghc3RhdGUuYnVpbGQubmFtZV9sYWJlbCkge1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVfbGFiZWwgPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gbmFtZXZhcnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5idWlsZC5uYW1lX2xhYmVsW25hbWV2YXJzW2ldXSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC5uYW1lX2xhYmVsW25hbWV2YXJzW2ldXSA9IHt9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghc3RhdGUuYnVpbGQubmFtZV9mbGFnKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBuYW1ldmFycy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZV9sYWJlbFtuYW1ldmFyc1tpXV0uYmVmb3JlID0gdGhpcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gbmFtZXZhcnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVfbGFiZWxbbmFtZXZhcnNbaV1dLmFmdGVyID0gdGhpcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUubGF5b3V0ID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB2YXIgZnVuYywgcHJlZml4X3Rva2VuLCBzdWZmaXhfdG9rZW4sIHRvaztcbiAgICAgICAgZnVuY3Rpb24gc2V0U3VmZml4KCkge1xuICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmFyZWEgPT09IFwiYmlibGlvZ3JhcGh5XCIpIHtcbiAgICAgICAgICAgICAgICBzdWZmaXhfdG9rZW4gPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24oc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RfbG9jYWxlID0gc3RhdGUudG1wLmNpdGVfbG9jYWxlc1tzdGF0ZS50bXAuY2l0ZV9sb2NhbGVzLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmNpdGVfYWZmaXhlc1tzdGF0ZS50bXAuYXJlYV1bc3RhdGUudG1wLmxhc3RfY2l0ZV9sb2NhbGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBzdGF0ZS50bXAuY2l0ZV9hZmZpeGVzW3N0YXRlLnRtcC5hcmVhXVtzdGF0ZS50bXAubGFzdF9jaXRlX2xvY2FsZV0uc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3VmZml4ID0gc3RhdGUuYmlibGlvZ3JhcGh5Lm9wdC5sYXlvdXRfc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciB0b3BibG9iID0gc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC51c2luZ19kaXNwbGF5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3BibG9iLmJsb2JzW3RvcGJsb2IuYmxvYnMubGVuZ3RoLTFdLnN0cmluZ3Muc3VmZml4ID0gc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9wYmxvYi5zdHJpbmdzLnN1ZmZpeCA9IHN1ZmZpeDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuYmlibGlvZ3JhcGh5Lm9wdFtcInNlY29uZC1maWVsZC1hbGlnblwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmVuZFRhZyhcImJpYl9vdGhlclwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgc3VmZml4X3Rva2VuLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LnB1c2goc3VmZml4X3Rva2VuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TVEFSVCkge1xuICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxlX3Jhdykge1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmN1cnJlbnRfZGVmYXVsdF9sb2NhbGUgPSB0aGlzLmxvY2FsZV9yYXc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmN1cnJlbnRfZGVmYXVsdF9sb2NhbGUgPSBzdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuYXBwbHlfY2l0YXRpb25fd3JhcHBlclxuICAgICAgICAgICAgICAgICAgICAmJiBzdGF0ZS5zeXMud3JhcENpdGF0aW9uRW50cnlcbiAgICAgICAgICAgICAgICAgICAgJiYgIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmdcbiAgICAgICAgICAgICAgICAgICAgJiYgSXRlbS5zeXN0ZW1faWQgXG4gICAgICAgICAgICAgICAgICAgICYmIHN0YXRlLnRtcC5hcmVhID09PSBcImNpdGF0aW9uXCIpIHsgXG4gICAgICAgICAgICAgICAgICAgIGNpdGVfZW50cnkgPSBuZXcgQ1NMLlRva2VuKFwiZ3JvdXBcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgICAgICAgICAgICAgY2l0ZV9lbnRyeS5kZWNvcmF0aW9ucyA9IFtbXCJAY2l0ZVwiLCBcImVudHJ5XCJdXTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LnN0YXJ0VGFnKFwiY2l0ZV9lbnRyeVwiLCBjaXRlX2VudHJ5KTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5pdGVtX2lkID0gSXRlbS5zeXN0ZW1faWQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLmxvY2F0b3JfdHh0ID0gaXRlbS5sb2NhdG9yX3R4dDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkuc3VmZml4X3R4dCA9IGl0ZW0uc3VmZml4X3R4dDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TVEFSVCAmJiAhc3RhdGUudG1wLmNpdGVfYWZmaXhlc1tzdGF0ZS5idWlsZC5hcmVhXSkge1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5kb25lX3ZhcnMgPSBbXTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LnN1cHByZXNzZWRKdXJpc2RpY3Rpb25zW0l0ZW1bXCJjb3VudHJ5XCJdXVxuICAgICAgICAgICAgICAgICAgICAmJiBJdGVtW1wiY291bnRyeVwiXVxuICAgICAgICAgICAgICAgICAgICAmJiBbXCJ0cmVhdHlcIiwgXCJwYXRlbnRcIl0uaW5kZXhPZihJdGVtLnR5cGUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZG9uZV92YXJzLnB1c2goXCJjb3VudHJ5XCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcgJiYgc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0gJiYgc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0ucGFyYWxsZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRvbmVfdmFycy5wdXNoKFwiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAucmVuZGVyZWRfbmFtZSA9IGZhbHNlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuc29ydF9rZXlfZmxhZyA9IGZhbHNlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAubmFtZXNldF9jb3VudGVyID0gMDtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRvayA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMucnRsX3N1cHBvcnQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFtcImFyXCIsIFwiaGVcIiwgXCJmYVwiLCBcInVyXCIsIFwieWlcIiwgXCJwc1wiLCBcInN5clwiXS5pbmRleE9mKEl0ZW0ubGFuZ3VhZ2UpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvayA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvay5zdHJpbmdzLnByZWZpeCA9IFwiXFx1MjAyYlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9rLnN0cmluZ3Muc3VmZml4ID0gXCJcXHUyMDJjXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbCh0b2spO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMucnRsX3N1cHBvcnQgJiYgZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0cmluZ3MucHJlZml4ID0gdGhpcy5zdHJpbmdzLnByZWZpeC5yZXBsYWNlKC9cXCgoLnwkKS9nLFwiKFxcdTIwMGUkMVwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5zdHJpbmdzLnN1ZmZpeC5yZXBsYWNlKC9cXCkoLnwkKS9nLFwiKVxcdTIwMGUkMVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5hcmVhID09PSBcImNpdGF0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICBwcmVmaXhfdG9rZW4gPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzcDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS5wcmVmaXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXN0X3ByZWZpeCA9IGl0ZW0ucHJlZml4LnJlcGxhY2UoLzxbXj5dKz4vZywgXCJcIikucmVwbGFjZSgvW1wiJ1xcdTIwMWRcXHUyMDE5XFx1MDBiYlxcdTIwMmZcXHUwMGEwIF0rJC9nLFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlc3RfY2hhciA9IHRlc3RfcHJlZml4LnNsaWNlKC0xKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZXN0X3ByZWZpeC5tYXRjaChDU0wuRU5EU1dJVEhfUk9NQU5FU1FVRV9SRUdFWFApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3AgPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQ1NMLlRFUk1JTkFMX1BVTkNUVUFUSU9OLnNsaWNlKDAsLTEpLmluZGV4T2YodGVzdF9jaGFyKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3AgPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGVzdF9jaGFyLm1hdGNoKC9bXFwpXFxdLDAtOV0vKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwID0gXCIgXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWdub3JlUHJlZGVjZXNzb3IgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChDU0wuVEVSTUlOQUxfUFVOQ1RVQVRJT04uc2xpY2UoMCwtMSkuaW5kZXhPZih0ZXN0X2NoYXIpID4gLTEgJiYgaXRlbS5wcmVmaXgudHJpbSgpLmluZGV4T2YoXCIgXCIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAudGVybV9wcmVkZWNlc3NvciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlnbm9yZVByZWRlY2Vzc29yID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmVmaXggPSAoaXRlbS5wcmVmaXggKyBzcCkucmVwbGFjZSgvXFxzKy9nLCBcIiBcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXggPSBzdGF0ZS5vdXRwdXQuY2hlY2tOZXN0ZWRCcmFjZS51cGRhdGUocHJlZml4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQocHJlZml4LCB0aGlzLCBmYWxzZSwgaWdub3JlUHJlZGVjZXNzb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBwcmVmaXhfdG9rZW4uZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICB0YXJnZXQucHVzaChwcmVmaXhfdG9rZW4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBteV90b2s7XG4gICAgICAgIGlmICh0aGlzLmxvY2FsZV9yYXcpIHtcbiAgICAgICAgICAgIG15X3RvayA9IG5ldyBDU0wuVG9rZW4oXCJkdW1teVwiLCBDU0wuU1RBUlQpO1xuICAgICAgICAgICAgbXlfdG9rLmxvY2FsZSA9IHRoaXMubG9jYWxlX3JhdztcbiAgICAgICAgICAgIG15X3Rvay5zdHJpbmdzLmRlbGltaXRlciA9IHRoaXMuc3RyaW5ncy5kZWxpbWl0ZXI7XG4gICAgICAgICAgICBteV90b2suc3RyaW5ncy5zdWZmaXggPSB0aGlzLnN0cmluZ3Muc3VmZml4O1xuICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAuY2l0ZV9hZmZpeGVzW3N0YXRlLmJ1aWxkLmFyZWFdKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmNpdGVfYWZmaXhlc1tzdGF0ZS5idWlsZC5hcmVhXSA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5sYXlvdXRfZmxhZyA9IHRydWU7XG4gICAgICAgICAgICBpZiAoIXRoaXMubG9jYWxlX3Jhdykge1xuICAgICAgICAgICAgICAgIHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQudG9wZGVjb3IgPSBbdGhpcy5kZWNvcmF0aW9uc107XG4gICAgICAgICAgICAgICAgc3RhdGVbKHN0YXRlLnRtcC5hcmVhICsgXCJfc29ydFwiKV0ub3B0LnRvcGRlY29yID0gW3RoaXMuZGVjb3JhdGlvbnNdO1xuICAgICAgICAgICAgICAgIHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5sYXlvdXRfcHJlZml4ID0gdGhpcy5zdHJpbmdzLnByZWZpeDtcbiAgICAgICAgICAgICAgICBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubGF5b3V0X3N1ZmZpeCA9IHRoaXMuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICAgICAgc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LmxheW91dF9kZWxpbWl0ZXIgPSB0aGlzLnN0cmluZ3MuZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgIHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5sYXlvdXRfZGVjb3JhdGlvbnMgPSB0aGlzLmRlY29yYXRpb25zO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY2l0ZV9hZmZpeGVzW3N0YXRlLmJ1aWxkLmFyZWFdKSB7XG4gICAgICAgICAgICAgICAgICAgIHRvayA9IG5ldyBDU0wuVG9rZW4oXCJlbHNlXCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICAgICAgICAgIENTTC5Ob2RlW1wiZWxzZVwiXS5idWlsZC5jYWxsKHRvaywgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSAvLyAhdGhpcy5sb2NhbGVfcmF3XG4gICAgICAgICAgICBpZiAodGhpcy5sb2NhbGVfcmF3KSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5idWlsZC5sYXlvdXRfbG9jYWxlX2ZsYWcpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNob29zZV90b2sgPSBuZXcgQ1NMLlRva2VuKFwiY2hvb3NlXCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICAgICAgICAgIENTTC5Ob2RlLmNob29zZS5idWlsZC5jYWxsKGNob29zZV90b2ssIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICBteV90b2submFtZSA9IFwiaWZcIjtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLkF0dHJpYnV0ZXNbXCJAbG9jYWxlLWludGVybmFsXCJdLmNhbGwobXlfdG9rLCBzdGF0ZSwgdGhpcy5sb2NhbGVfcmF3KTtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLk5vZGVbXCJpZlwiXS5idWlsZC5jYWxsKG15X3Rvaywgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbXlfdG9rLm5hbWUgPSBcImVsc2UtaWZcIjtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLkF0dHJpYnV0ZXNbXCJAbG9jYWxlLWludGVybmFsXCJdLmNhbGwobXlfdG9rLCBzdGF0ZSwgdGhpcy5sb2NhbGVfcmF3KTtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLk5vZGVbXCJlbHNlLWlmXCJdLmJ1aWxkLmNhbGwobXlfdG9rLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmNpdGVfYWZmaXhlc1tzdGF0ZS5idWlsZC5hcmVhXVtteV90b2subG9jYWxlXSA9IHt9O1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5jaXRlX2FmZml4ZXNbc3RhdGUuYnVpbGQuYXJlYV1bbXlfdG9rLmxvY2FsZV0uZGVsaW1pdGVyID0gdGhpcy5zdHJpbmdzLmRlbGltaXRlcjtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuY2l0ZV9hZmZpeGVzW3N0YXRlLmJ1aWxkLmFyZWFdW215X3Rvay5sb2NhbGVdLnN1ZmZpeCA9IHRoaXMuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuRU5EKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5sb2NhbGVfcmF3KSB7XG4gICAgICAgICAgICAgICAgc2V0U3VmZml4KCk7XG4gICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5idWlsZC5sYXlvdXRfbG9jYWxlX2ZsYWcpIHtcbiAgICAgICAgICAgICAgICAgICAgbXlfdG9rLm5hbWUgPSBcImlmXCI7XG4gICAgICAgICAgICAgICAgICAgIG15X3Rvay50b2tlbnR5cGUgPSBDU0wuRU5EO1xuICAgICAgICAgICAgICAgICAgICBDU0wuQXR0cmlidXRlc1tcIkBsb2NhbGUtaW50ZXJuYWxcIl0uY2FsbChteV90b2ssIHN0YXRlLCB0aGlzLmxvY2FsZV9yYXcpO1xuICAgICAgICAgICAgICAgICAgICBDU0wuTm9kZVtcImlmXCJdLmJ1aWxkLmNhbGwobXlfdG9rLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQubGF5b3V0X2xvY2FsZV9mbGFnID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBteV90b2submFtZSA9IFwiZWxzZS1pZlwiO1xuICAgICAgICAgICAgICAgICAgICBteV90b2sudG9rZW50eXBlID0gQ1NMLkVORDtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLkF0dHJpYnV0ZXNbXCJAbG9jYWxlLWludGVybmFsXCJdLmNhbGwobXlfdG9rLCBzdGF0ZSwgdGhpcy5sb2NhbGVfcmF3KTtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLk5vZGVbXCJlbHNlLWlmXCJdLmJ1aWxkLmNhbGwobXlfdG9rLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXRoaXMubG9jYWxlX3Jhdykge1xuICAgICAgICAgICAgICAgIHNldFN1ZmZpeCgpO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY2l0ZV9hZmZpeGVzW3N0YXRlLmJ1aWxkLmFyZWFdKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5sYXlvdXRfbG9jYWxlX2ZsYWcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvayA9IG5ldyBDU0wuVG9rZW4oXCJlbHNlXCIsIENTTC5FTkQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLk5vZGVbXCJlbHNlXCJdLmJ1aWxkLmNhbGwodG9rLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvayA9IG5ldyBDU0wuVG9rZW4oXCJjaG9vc2VcIiwgQ1NMLkVORCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBDU0wuTm9kZS5jaG9vc2UuYnVpbGQuY2FsbCh0b2ssIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkX2xheW91dF9sb2NhbGVfZmxhZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmFyZWEgPT09IFwiY2l0YXRpb25cIikge1xuICAgICAgICAgICAgICAgICAgICBzdWZmaXhfdG9rZW4gPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS5zdWZmaXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uc3VmZml4Lm1hdGNoKENTTC5TVEFSVFNXSVRIX1JPTUFORVNRVUVfUkVHRVhQKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8fCBbJ1snLCcoJ10uaW5kZXhPZihpdGVtLnN1ZmZpeC5zbGljZSgwLDEpKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwID0gXCIgXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdWZmaXggPSBpdGVtLnN1ZmZpeDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VmZml4ID0gc3RhdGUub3V0cHV0LmNoZWNrTmVzdGVkQnJhY2UudXBkYXRlKHN1ZmZpeCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQoKHNwICsgc3VmZml4KSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHN1ZmZpeF90b2tlbi5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXQucHVzaChzdWZmaXhfdG9rZW4pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jbG9zZUxldmVsKCk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuYXBwbHlfY2l0YXRpb25fd3JhcHBlclxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgc3RhdGUuc3lzLndyYXBDaXRhdGlvbkVudHJ5XG4gICAgICAgICAgICAgICAgICAgICAgICAmJiAhc3RhdGUudG1wLmp1c3RfbG9va2luZ1xuICAgICAgICAgICAgICAgICAgICAgICAgJiYgSXRlbS5zeXN0ZW1faWQgXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiBzdGF0ZS50bXAuYXJlYSA9PT0gXCJjaXRhdGlvblwiKSB7IFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmVuZFRhZygpOyAvLyBjbG9zZXMgY2l0YXRpb24gbGluayB3cmFwcGVyXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmxheW91dF9mbGFnID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQubGF5b3V0X2xvY2FsZV9mbGFnID0gZmFsc2U7XG4gICAgICAgICAgICB9IC8vICF0aGlzLmxheW91dF9yYXdcbiAgICAgICAgfVxuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlLm1hY3JvID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge31cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5OYW1lT3V0cHV0ID0gZnVuY3Rpb24oc3RhdGUsIEl0ZW0sIGl0ZW0sIHZhcmlhYmxlcykge1xuICAgIHRoaXMuZGVidWcgPSBmYWxzZTtcbiAgICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gICAgdGhpcy5JdGVtID0gSXRlbTtcbiAgICB0aGlzLml0ZW0gPSBpdGVtO1xuICAgIHRoaXMubmFtZXNldF9iYXNlID0gMDtcbiAgICB0aGlzLmV0YWxfc3BlYyA9IHt9O1xuICAgIHRoaXMuX2ZpcnN0X2NyZWF0b3JfdmFyaWFibGUgPSBmYWxzZTtcbiAgICB0aGlzLl9wbGVhc2VfY2hvcCA9IGZhbHNlO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKG5hbWVzKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUudG1wLnRlcm1fcHJlZGVjZXNzb3IpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS50bXAuc3Vic2VxdWVudF9hdXRob3Jfc3Vic3RpdHV0ZV9vayA9IGZhbHNlO1xuICAgIH1cbiAgICBpZiAodGhpcy5uYW1lc2V0X29mZnNldCkge1xuICAgICAgICB0aGlzLm5hbWVzZXRfYmFzZSA9IHRoaXMubmFtZXNldF9iYXNlICsgdGhpcy5uYW1lc2V0X29mZnNldDtcbiAgICB9XG4gICAgdGhpcy5uYW1lc2V0X29mZnNldCA9IDA7XG4gICAgdGhpcy5uYW1lcyA9IG5hbWVzO1xuICAgIHRoaXMudmFyaWFibGVzID0gbmFtZXMudmFyaWFibGVzO1xuICAgIHRoaXMuc3RhdGUudG1wLnZhbHVlID0gW107XG4gICAgdGhpcy5zdGF0ZS50bXAucmVuZGVyZWRfbmFtZSA9IFtdO1xuICAgIHRoaXMuc3RhdGUudG1wLmxhYmVsX2Jsb2IgPSBmYWxzZTtcbiAgICB0aGlzLnN0YXRlLnRtcC5ldGFsX25vZGUgPSBmYWxzZTtcbiAgICB0aGlzLnN0YXRlLnRtcC5ldGFsX3Rlcm0gPSBmYWxzZTtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMudmFyaWFibGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAodGhpcy5JdGVtW3RoaXMudmFyaWFibGVzW2ldXSAmJiB0aGlzLkl0ZW1bdGhpcy52YXJpYWJsZXNbaV1dLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudmFsdWUgPSB0aGlzLnN0YXRlLnRtcC52YWx1ZS5jb25jYXQodGhpcy5JdGVtW3RoaXMudmFyaWFibGVzW2ldXSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpc1tcImV0LWFsXCJdID0gdW5kZWZpbmVkO1xuICAgIHRoaXNbXCJ3aXRoXCJdID0gdW5kZWZpbmVkO1xuICAgIHRoaXMubmFtZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmluc3RpdHV0aW9ucGFydCA9IHt9O1xuICAgIHRoaXMuc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnZhcmlhYmxlX2F0dGVtcHQgPSB0cnVlO1xuICAgIHRoaXMubGFiZWxWYXJpYWJsZSA9IHRoaXMudmFyaWFibGVzWzBdO1xuICAgIGlmICghdGhpcy5zdGF0ZS50bXAudmFsdWUubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLnJlaW5pdCA9IGZ1bmN0aW9uIChuYW1lcywgbGFiZWxWYXJpYWJsZSkge1xuICAgIHRoaXMubGFiZWxWYXJpYWJsZSA9IGxhYmVsVmFyaWFibGU7XG4gICAgaWYgKHRoaXMuc3RhdGUudG1wLmNhbl9zdWJzdGl0dXRlLnZhbHVlKCkpIHtcbiAgICAgICAgdGhpcy5uYW1lc2V0X29mZnNldCA9IDA7XG4gICAgICAgIHRoaXMudmFyaWFibGVzID0gbmFtZXMudmFyaWFibGVzO1xuICAgICAgICB2YXIgb2xkdmFsID0gdGhpcy5zdGF0ZS50bXAudmFsdWUuc2xpY2UoKTtcbiAgICAgICAgdGhpcy5zdGF0ZS50bXAudmFsdWUgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLnZhcmlhYmxlcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLkl0ZW1bdGhpcy52YXJpYWJsZXNbaV1dICYmIHRoaXMuSXRlbVt0aGlzLnZhcmlhYmxlc1tpXV0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudmFsdWUgPSB0aGlzLnN0YXRlLnRtcC52YWx1ZS5jb25jYXQodGhpcy5JdGVtW3RoaXMudmFyaWFibGVzW2ldXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLnZhbHVlLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuY2FuX3N1YnN0aXR1dGUucmVwbGFjZShmYWxzZSwgQ1NMLkxJVEVSQUwpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RhdGUudG1wLnZhbHVlID0gb2xkdmFsO1xuICAgIH1cbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUub3V0cHV0TmFtZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgdmFyIHZhcmlhYmxlcyA9IHRoaXMudmFyaWFibGVzO1xuICAgIGlmICh0aGlzLmluc3RpdHV0aW9uLmFuZCkge1xuICAgICAgICBpZiAoIXRoaXMuaW5zdGl0dXRpb24uYW5kLnNpbmdsZS5ibG9icyB8fCAhdGhpcy5pbnN0aXR1dGlvbi5hbmQuc2luZ2xlLmJsb2JzLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5pbnN0aXR1dGlvbi5hbmQuc2luZ2xlLmJsb2JzID0gdGhpcy5uYW1lLmFuZC5zaW5nbGUuYmxvYnM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmluc3RpdHV0aW9uLmFuZC5tdWx0aXBsZS5ibG9icyB8fCAhdGhpcy5pbnN0aXR1dGlvbi5hbmQubXVsdGlwbGUuYmxvYnMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uLmFuZC5tdWx0aXBsZS5ibG9icyA9IHRoaXMubmFtZS5hbmQubXVsdGlwbGUuYmxvYnM7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy52YXJpYWJsZV9vZmZzZXQgPSB7fTtcbiAgICBpZiAodGhpcy5mYW1pbHkpIHtcbiAgICAgICAgdGhpcy5mYW1pbHlfZGVjb3IgPSBDU0wuVXRpbC5jbG9uZVRva2VuKHRoaXMuZmFtaWx5KTtcbiAgICAgICAgdGhpcy5mYW1pbHlfZGVjb3Iuc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICB0aGlzLmZhbWlseV9kZWNvci5zdHJpbmdzLnN1ZmZpeCA9IFwiXCI7XG4gICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSB0aGlzLmZhbWlseS5leGVjcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHRoaXMuZmFtaWx5LmV4ZWNzW2ldLmNhbGwodGhpcy5mYW1pbHlfZGVjb3IsIHRoaXMuc3RhdGUsIHRoaXMuSXRlbSk7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmZhbWlseV9kZWNvciA9IGZhbHNlO1xuICAgIH1cbiAgICBpZiAodGhpcy5naXZlbikge1xuICAgICAgICB0aGlzLmdpdmVuX2RlY29yID0gQ1NMLlV0aWwuY2xvbmVUb2tlbih0aGlzLmdpdmVuKTtcbiAgICAgICAgdGhpcy5naXZlbl9kZWNvci5zdHJpbmdzLnByZWZpeCA9IFwiXCI7XG4gICAgICAgIHRoaXMuZ2l2ZW5fZGVjb3Iuc3RyaW5ncy5zdWZmaXggPSBcIlwiO1xuICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gdGhpcy5naXZlbi5leGVjcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHRoaXMuZ2l2ZW4uZXhlY3NbaV0uY2FsbCh0aGlzLmdpdmVuX2RlY29yLCB0aGlzLnN0YXRlLCB0aGlzLkl0ZW0pO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5naXZlbl9kZWNvciA9IGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLmdldEV0QWxDb25maWcoKTtcbiAgICB0aGlzLmRpdmlkZUFuZFRyYW5zbGl0ZXJhdGVOYW1lcygpO1xuICAgIHRoaXMudHJ1bmNhdGVQZXJzb25hbE5hbWVMaXN0cygpO1xuICAgIHRoaXMuZGlzYW1iaWdOYW1lcygpO1xuICAgIHRoaXMuY29uc3RyYWluTmFtZXMoKTtcbiAgICBpZiAodGhpcy5uYW1lLnN0cmluZ3MuZm9ybSA9PT0gXCJjb3VudFwiKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5leHRlbnNpb24gfHwgdGhpcy5uYW1lc19jb3VudCAhPSAwKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQodGhpcy5uYW1lc19jb3VudCwgXCJlbXB0eVwiKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnZhcmlhYmxlX3N1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zZXRFdEFsUGFyYW1ldGVycygpO1xuICAgIHRoaXMuc2V0Q29tbW9uVGVybSgpO1xuICAgIHRoaXMuc3RhdGUudG1wLm5hbWVfbm9kZSA9IHt9O1xuICAgIHRoaXMuc3RhdGUudG1wLm5hbWVfbm9kZS5jaGlsZHJlbiA9IFtdO1xuICAgIHRoaXMucmVuZGVyQWxsTmFtZXMoKTtcbiAgICB2YXIgYmxvYl9saXN0ID0gW107XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IHZhcmlhYmxlcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIHYgPSB2YXJpYWJsZXNbaV07XG4gICAgICAgIHZhciBpbnN0aXR1dGlvbl9zZXRzID0gW107XG4gICAgICAgIHZhciBpbnN0aXR1dGlvbnMgPSBmYWxzZTtcbiAgICAgICAgdmFyIHZhcmJsb2IgPSBudWxsO1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3Bvb2ZfaW5zdGl0dXRpb25hbF9hZmZpbGlhdGlvbnMpIHtcbiAgICAgICAgICAgIHZhcmJsb2IgPSB0aGlzLl9qb2luKFt0aGlzLmZyZWV0ZXJzW3ZdXSwgXCJcIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgIGluc3RpdHV0aW9uX3NldHMucHVzaCh0aGlzLmpvaW5QZXJzb25zQW5kSW5zdGl0dXRpb25zKFt0aGlzLnBlcnNvbnNbdl1bal0sIHRoaXMuaW5zdGl0dXRpb25zW3ZdW2pdXSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHZhciBwb3MgPSB0aGlzLm5hbWVzZXRfYmFzZSArIHRoaXMudmFyaWFibGVfb2Zmc2V0W3ZdO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBwb3MgKz0gMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaW5zdGl0dXRpb25zID0gdGhpcy5qb2luSW5zdGl0dXRpb25TZXRzKGluc3RpdHV0aW9uX3NldHMsIHBvcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgdmFyYmxvYiA9IHRoaXMuam9pbkZyZWV0ZXJzQW5kSW5zdGl0dXRpb25TZXRzKFt0aGlzLmZyZWV0ZXJzW3ZdLCBpbnN0aXR1dGlvbnNdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmFyYmxvYikge1xuICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnRtcC5leHRlbnNpb24pIHtcbiAgICAgICAgICAgICAgICB2YXJibG9iID0gdGhpcy5fYXBwbHlMYWJlbHModmFyYmxvYiwgdik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBibG9iX2xpc3QucHVzaCh2YXJibG9iKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5jb21tb25fdGVybSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQub3BlbkxldmVsKFwiZW1wdHlcIik7XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLnN0cmluZ3MuZGVsaW1pdGVyID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZXMsIFwiZGVsaW1pdGVyXCIsIFwibmFtZXMtZGVsaW1pdGVyXCIpO1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBibG9iX2xpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChibG9iX2xpc3RbaV0sIFwibGl0ZXJhbFwiLCB0cnVlKTtcbiAgICB9XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQuY2xvc2VMZXZlbChcImVtcHR5XCIpO1xuICAgIHZhciBibG9iID0gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgdmFyIG5hbWVzVG9rZW4gPSBDU0wuVXRpbC5jbG9uZVRva2VuKHRoaXMubmFtZXMpO1xuICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChibG9iLCBuYW1lc1Rva2VuKTtcbiAgICBpZiAodGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3Nvcl9uYW1lKSB7XG4gICAgICAgIHRoaXMuc3RhdGUudG1wLnRlcm1fcHJlZGVjZXNzb3IgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUudG9wID0gdGhpcy5zdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpO1xuICAgIGlmICh2YXJpYWJsZXNbMF0gIT09IFwiYXV0aG9yaXR5XCIpIHtcbiAgICAgICAgdmFyIG5hbWVfbm9kZV9zdHJpbmcgPSBbXTtcbiAgICAgICAgdmFyIG5hbWVvYmpzID0gdGhpcy5JdGVtW3ZhcmlhYmxlc1swXV07XG4gICAgICAgIGlmIChuYW1lb2Jqcykge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBuYW1lb2Jqcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICB2YXIgc3Vic3RyaW5nID0gQ1NMLlV0aWwuTmFtZXMuZ2V0UmF3TmFtZShuYW1lb2Jqc1tpXSk7XG4gICAgICAgICAgICAgICAgaWYgKHN1YnN0cmluZykge1xuICAgICAgICAgICAgICAgICAgICBuYW1lX25vZGVfc3RyaW5nLnB1c2goc3Vic3RyaW5nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbmFtZV9ub2RlX3N0cmluZyA9IG5hbWVfbm9kZV9zdHJpbmcuam9pbihcIiwgXCIpO1xuICAgICAgICBpZiAobmFtZV9ub2RlX3N0cmluZykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLnN0cmluZyA9IG5hbWVfbm9kZV9zdHJpbmc7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuc3RhdGUudG1wLm5hbWVfbm9kZS5zdHJpbmcgJiYgIXRoaXMuc3RhdGUudG1wLmZpcnN0X25hbWVfc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuc3RhdGUudG1wLmZpcnN0X25hbWVfc3RyaW5nID0gdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLnN0cmluZztcbiAgICB9XG4gICAgaWYgKFwiY2xhc3NpY1wiID09PSB0aGlzLkl0ZW0udHlwZSkge1xuICAgICAgICB2YXIgYXV0aG9yX3RpdGxlID0gW107XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5maXJzdF9uYW1lX3N0cmluZykge1xuICAgICAgICAgICAgYXV0aG9yX3RpdGxlLnB1c2godGhpcy5zdGF0ZS50bXAuZmlyc3RfbmFtZV9zdHJpbmcpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLkl0ZW0udGl0bGUpIHtcbiAgICAgICAgICAgIGF1dGhvcl90aXRsZS5wdXNoKHRoaXMuSXRlbS50aXRsZSk7XG4gICAgICAgIH1cbiAgICAgICAgYXV0aG9yX3RpdGxlID0gYXV0aG9yX3RpdGxlLmpvaW4oXCIsIFwiKTtcbiAgICAgICAgaWYgKGF1dGhvcl90aXRsZSAmJiB0aGlzLnN0YXRlLnN5cy5nZXRBYmJyZXZpYXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudHJhbnNmb3JtLmxvYWRBYmJyZXZpYXRpb24oXCJkZWZhdWx0XCIsIFwiY2xhc3NpY1wiLCBhdXRob3JfdGl0bGUpO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbXCJkZWZhdWx0XCJdLmNsYXNzaWNbYXV0aG9yX3RpdGxlXSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmRvbmVfdmFycy5wdXNoKFwidGl0bGVcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHRoaXMuc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbXCJkZWZhdWx0XCJdLmNsYXNzaWNbYXV0aG9yX3RpdGxlXSwgXCJlbXB0eVwiLCB0cnVlKTtcbiAgICAgICAgICAgICAgICBibG9iID0gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG5cdFx0XHRcdHRoaXMuc3RhdGUudG1wLm5hbWVfbm9kZS50b3AuYmxvYnMucG9wKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLnRvcC5ibG9icy5wdXNoKGJsb2IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2NvbGxhcHNlQXV0aG9yKCk7XG4gICAgdGhpcy52YXJpYWJsZXMgPSBbXTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2FwcGx5TGFiZWxzID0gZnVuY3Rpb24gKGJsb2IsIHYpIHtcbiAgICB2YXIgdHh0O1xuICAgIGlmICghdGhpcy5sYWJlbCB8fCAhdGhpcy5sYWJlbFt0aGlzLmxhYmVsVmFyaWFibGVdKSB7XG4gICAgICAgIHJldHVybiBibG9iO1xuICAgIH1cbiAgICB2YXIgcGx1cmFsID0gMDtcbiAgICB2YXIgbnVtID0gdGhpcy5mcmVldGVyc19jb3VudFt2XSArIHRoaXMuaW5zdGl0dXRpb25zX2NvdW50W3ZdO1xuICAgIGlmIChudW0gPiAxKSB7XG4gICAgICAgIHBsdXJhbCA9IDE7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLnBlcnNvbnNbdl0ubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBudW0gKz0gdGhpcy5wZXJzb25zX2NvdW50W3ZdW2ldO1xuICAgICAgICB9XG4gICAgICAgIGlmIChudW0gPiAxKSB7XG4gICAgICAgICAgICBwbHVyYWwgPSAxO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmxhYmVsW3RoaXMubGFiZWxWYXJpYWJsZV0uYmVmb3JlKSB7XG4gICAgICAgIGlmIChcIm51bWJlclwiID09PSB0eXBlb2YgdGhpcy5sYWJlbFt0aGlzLmxhYmVsVmFyaWFibGVdLmJlZm9yZS5zdHJpbmdzLnBsdXJhbCkge1xuICAgICAgICAgICAgcGx1cmFsID0gdGhpcy5sYWJlbFt0aGlzLmxhYmVsVmFyaWFibGVdLmJlZm9yZS5zdHJpbmdzLnBsdXJhbDtcbiAgICAgICAgfVxuICAgICAgICB0eHQgPSB0aGlzLl9idWlsZExhYmVsKHYsIHBsdXJhbCwgXCJiZWZvcmVcIiwgdGhpcy5sYWJlbFZhcmlhYmxlKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQub3BlbkxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZCh0eHQsIHRoaXMubGFiZWxbdGhpcy5sYWJlbFZhcmlhYmxlXS5iZWZvcmUsIHRydWUpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoYmxvYiwgXCJsaXRlcmFsXCIsIHRydWUpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5jbG9zZUxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgIGJsb2IgPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMubGFiZWxbdGhpcy5sYWJlbFZhcmlhYmxlXS5hZnRlcikge1xuICAgICAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIHRoaXMubGFiZWxbdGhpcy5sYWJlbFZhcmlhYmxlXS5hZnRlci5zdHJpbmdzLnBsdXJhbCkge1xuICAgICAgICAgICAgcGx1cmFsID0gdGhpcy5sYWJlbFt0aGlzLmxhYmVsVmFyaWFibGVdLmFmdGVyLnN0cmluZ3MucGx1cmFsO1xuICAgICAgICB9XG4gICAgICAgIHR4dCA9IHRoaXMuX2J1aWxkTGFiZWwodiwgcGx1cmFsLCBcImFmdGVyXCIsIHRoaXMubGFiZWxWYXJpYWJsZSk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChcImVtcHR5XCIpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoYmxvYiwgXCJsaXRlcmFsXCIsIHRydWUpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQodHh0LCB0aGlzLmxhYmVsW3RoaXMubGFiZWxWYXJpYWJsZV0uYWZ0ZXIsIHRydWUpO1xuICAgICAgICB0aGlzLnN0YXRlLnRtcC5sYWJlbF9ibG9iID0gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZCh0aGlzLnN0YXRlLnRtcC5sYWJlbF9ibG9iLFwibGl0ZXJhbFwiLHRydWUpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5jbG9zZUxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgIGJsb2IgPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICB9XG4gICAgcmV0dXJuIGJsb2I7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9idWlsZExhYmVsID0gZnVuY3Rpb24gKHRlcm0sIHBsdXJhbCwgcG9zaXRpb24sIHYpIHtcbiAgICBpZiAodGhpcy5jb21tb25fdGVybSkge1xuICAgICAgICB0ZXJtID0gdGhpcy5jb21tb25fdGVybTtcbiAgICB9XG4gICAgdmFyIHJldCA9IGZhbHNlO1xuICAgIHZhciBub2RlID0gdGhpcy5sYWJlbFt2XVtwb3NpdGlvbl07XG4gICAgaWYgKG5vZGUpIHtcbiAgICAgICAgcmV0ID0gQ1NMLmNhc3RMYWJlbCh0aGlzLnN0YXRlLCBub2RlLCB0ZXJtLCBwbHVyYWwsIENTTC5UT0xFUkFOVCk7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9jb2xsYXBzZUF1dGhvciA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgbXlxdWV1ZSwgbXlzdHIsIG9sZGNoYXJzO1xuICAgIGlmICh0aGlzLm5hbWVzZXRfYmFzZSA9PT0gMCAmJiB0aGlzLkl0ZW1bdGhpcy52YXJpYWJsZXNbMF1dICYmICF0aGlzLl9maXJzdF9jcmVhdG9yX3ZhcmlhYmxlKSB7XG4gICAgICAgIHRoaXMuX2ZpcnN0X2NyZWF0b3JfdmFyaWFibGUgPSB0aGlzLnZhcmlhYmxlc1swXTtcbiAgICB9XG4gICAgaWYgKCh0aGlzLml0ZW0gJiYgdGhpcy5pdGVtW1wic3VwcHJlc3MtYXV0aG9yXCJdICYmIHRoaXMuX2ZpcnN0X2NyZWF0b3JfdmFyaWFibGUgPT0gdGhpcy52YXJpYWJsZXNbMF0pXG4gICAgICAgIHx8ICh0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jb2xsYXBzZSBcbiAgICAgICAgICAgICYmIHRoaXMuc3RhdGVbdGhpcy5zdGF0ZS50bXAuYXJlYV0ub3B0LmNvbGxhcHNlLmxlbmd0aClcbiAgICAgICAgfHwgKHRoaXMuc3RhdGVbdGhpcy5zdGF0ZS50bXAuYXJlYV0ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyIFxuICAgICAgICAgICAgJiYgdGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXIubGVuZ3RoKSkge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS50bXAuYXV0aG9yc3RyaW5nX3JlcXVlc3QpIHtcbiAgICAgICAgICAgIG15c3RyID0gXCJcIjtcbiAgICAgICAgICAgIG15cXVldWUgPSB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUudG9wLmJsb2JzLnNsaWNlKC0xKVswXS5ibG9icztcbiAgICAgICAgICAgIG9sZGNoYXJzID0gdGhpcy5zdGF0ZS50bXAub2Zmc2V0X2NoYXJhY3RlcnM7XG4gICAgICAgICAgICBpZiAobXlxdWV1ZSkge1xuICAgICAgICAgICAgICAgIG15c3RyID0gdGhpcy5zdGF0ZS5vdXRwdXQuc3RyaW5nKHRoaXMuc3RhdGUsIG15cXVldWUsIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzID0gb2xkY2hhcnM7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LmF1dGhvcnN0cmluZ3NbdGhpcy5JdGVtLmlkXSA9IG15c3RyO1xuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLnN0YXRlLnRtcC5qdXN0X2xvb2tpbmdcbiAgICAgICAgICAgICAgICAgICAmJiAhdGhpcy5zdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgJiYgKHRoaXMuaXRlbVtcInN1cHByZXNzLWF1dGhvclwiXSB8fCAodGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5vcHQuY29sbGFwc2UgJiYgdGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5vcHQuY29sbGFwc2UubGVuZ3RoKSB8fCB0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlciAmJiB0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlcikpIHtcbiAgICAgICAgICAgIG15c3RyID0gXCJcIjtcbiAgICAgICAgICAgIG15cXVldWUgPSB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUudG9wLmJsb2JzLnNsaWNlKC0xKVswXS5ibG9icztcbiAgICAgICAgICAgIG9sZGNoYXJzID0gdGhpcy5zdGF0ZS50bXAub2Zmc2V0X2NoYXJhY3RlcnM7XG4gICAgICAgICAgICBpZiAobXlxdWV1ZSkge1xuICAgICAgICAgICAgICAgIG15c3RyID0gdGhpcy5zdGF0ZS5vdXRwdXQuc3RyaW5nKHRoaXMuc3RhdGUsIG15cXVldWUsIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChteXN0ciA9PT0gdGhpcy5zdGF0ZS50bXAubGFzdF9wcmltYXJ5X25hbWVzX3N0cmluZykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLml0ZW1bXCJzdXBwcmVzcy1hdXRob3JcIl0gfHwgKHRoaXMuc3RhdGVbdGhpcy5zdGF0ZS50bXAuYXJlYV0ub3B0LmNvbGxhcHNlICYmIHRoaXMuc3RhdGVbdGhpcy5zdGF0ZS50bXAuYXJlYV0ub3B0LmNvbGxhcHNlLmxlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLnRvcC5ibG9icy5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLmNoaWxkcmVuID0gW107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzID0gb2xkY2hhcnM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlciAmJiB0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC51c2VfY2l0ZV9ncm91cF9kZWxpbWl0ZXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAubGFzdF9wcmltYXJ5X25hbWVzX3N0cmluZyA9IG15c3RyO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlcy5pbmRleE9mKHRoaXMuX2ZpcnN0X2NyZWF0b3JfdmFyaWFibGUpID4gLTEgJiYgdGhpcy5pdGVtICYmIHRoaXMuaXRlbVtcInN1cHByZXNzLWF1dGhvclwiXSAmJiB0aGlzLkl0ZW0udHlwZSAhPT0gXCJsZWdhbF9jYXNlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLnRvcC5ibG9icy5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLmNoaWxkcmVuID0gW107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzID0gb2xkY2hhcnM7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnRlcm1fcHJlZGVjZXNzb3IgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuaGF2ZV9jb2xsYXBzZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXIgJiYgdGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudXNlX2NpdGVfZ3JvdXBfZGVsaW1pdGVyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmlzUGVyc29uID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlLmxpdGVyYWxcbiAgICAgICAgfHwgKCF2YWx1ZS5naXZlbiAmJiB2YWx1ZS5mYW1pbHkgJiYgdmFsdWUuaXNJbnN0aXR1dGlvbikpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS50cnVuY2F0ZVBlcnNvbmFsTmFtZUxpc3RzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciB2LCBpLCBpbGVuLCBqLCBqbGVuLCBjaG9wdmFyLCB2YWx1ZXM7XG4gICAgdGhpcy5mcmVldGVyc19jb3VudCA9IHt9O1xuICAgIHRoaXMucGVyc29uc19jb3VudCA9IHt9O1xuICAgIHRoaXMuaW5zdGl0dXRpb25zX2NvdW50ID0ge307XG4gICAgZm9yICh2IGluIHRoaXMuZnJlZXRlcnMpIHtcbiAgICAgICAgaWYgKHRoaXMuZnJlZXRlcnMuaGFzT3duUHJvcGVydHkodikpIHtcbiAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNfY291bnRbdl0gPSB0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aDtcbiAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNbdl0gPSB0aGlzLl90cnVuY2F0ZU5hbWVMaXN0KHRoaXMuZnJlZXRlcnMsIHYpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodiBpbiB0aGlzLnBlcnNvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMucGVyc29ucy5oYXNPd25Qcm9wZXJ0eSh2KSkge1xuICAgICAgICAgICAgdGhpcy5pbnN0aXR1dGlvbnNfY291bnRbdl0gPSB0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGg7XG4gICAgICAgICAgICB0aGlzLl90cnVuY2F0ZU5hbWVMaXN0KHRoaXMuaW5zdGl0dXRpb25zLCB2KTtcbiAgICAgICAgICAgIHRoaXMucGVyc29uc1t2XSA9IHRoaXMucGVyc29uc1t2XS5zbGljZSgwLCB0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGgpO1xuICAgICAgICAgICAgdGhpcy5wZXJzb25zX2NvdW50W3ZdID0gW107XG4gICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gdGhpcy5wZXJzb25zW3ZdLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgIHRoaXMucGVyc29uc19jb3VudFt2XVtqXSA9IHRoaXMucGVyc29uc1t2XVtqXS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgdGhpcy5wZXJzb25zW3ZdW2pdID0gdGhpcy5fdHJ1bmNhdGVOYW1lTGlzdCh0aGlzLnBlcnNvbnMsIHYsIGopO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmV0YWxfbWluID09PSAxICYmIHRoaXMuZXRhbF91c2VfZmlyc3QgPT09IDEgXG4gICAgICAgICYmICEodGhpcy5zdGF0ZS50bXAuZXh0ZW5zaW9uXG4gICAgICAgICAgICAgfHwgdGhpcy5zdGF0ZS50bXAuanVzdF9sb29raW5nKSkge1xuICAgICAgICBjaG9wdmFyID0gdjtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjaG9wdmFyID0gZmFsc2U7XG4gICAgfVxuICAgIGlmIChjaG9wdmFyIHx8IHRoaXMuX3BsZWFzZV9jaG9wKSB7XG4gICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSB0aGlzLnZhcmlhYmxlcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHYgPSB0aGlzLnZhcmlhYmxlc1tpXTtcbiAgICAgICAgICAgIGlmICh0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wbGVhc2VfY2hvcCA9PT0gdikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWV0ZXJzW3ZdID0gdGhpcy5mcmVldGVyc1t2XS5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmVldGVyc19jb3VudFt2XSArPSAtMTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGxlYXNlX2Nob3AgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNob3B2YXIgJiYgIXRoaXMuX3BsZWFzZV9jaG9wKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNbdl0gPSB0aGlzLmZyZWV0ZXJzW3ZdLnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWV0ZXJzX2NvdW50W3ZdID0gMTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnN0aXR1dGlvbnNbdl0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJzb25zW3ZdID0gW107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BsZWFzZV9jaG9wID0gY2hvcHZhcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKHZhciBqPTAsamxlbiA9IHRoaXMucGVyc29uc1t2XS5sZW5ndGg7ajxqbGVuO2orKykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnBlcnNvbnNbdl1bal0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wbGVhc2VfY2hvcCA9PT0gdikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJzb25zW3ZdW2pdID0gdGhpcy5wZXJzb25zW3ZdW2pdLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJzb25zX2NvdW50W3ZdW2pdICs9IC0xO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGxlYXNlX2Nob3AgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNob3B2YXIgJiYgIXRoaXMuX3BsZWFzZV9jaG9wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWV0ZXJzW3ZdID0gdGhpcy5wZXJzb25zW3ZdW2pdLnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmVldGVyc19jb3VudFt2XSA9IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uc1t2XSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJzb25zW3ZdID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BsZWFzZV9jaG9wID0gY2hvcHZhcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wbGVhc2VfY2hvcCA9PT0gdikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uc1t2XSA9IHRoaXMuaW5zdGl0dXRpb25zW3ZdLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uc19jb3VudFt2XSArPSAtMTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGxlYXNlX2Nob3AgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNob3B2YXIgJiYgIXRoaXMuX3BsZWFzZV9jaG9wKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zdGl0dXRpb25zW3ZdID0gdGhpcy5pbnN0aXR1dGlvbnNbdl0uc2xpY2UoMCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zdGl0dXRpb25zX2NvdW50W3ZdID0gMTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gW107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BsZWFzZV9jaG9wID0gY2hvcHZhcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IHRoaXMudmFyaWFibGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAodGhpcy5pbnN0aXR1dGlvbnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLm5hbWVzZXRfb2Zmc2V0ICs9IDE7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49dGhpcy5wZXJzb25zW3ZdLmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5wZXJzb25zW3ZdW2pdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXNldF9vZmZzZXQgKz0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX3RydW5jYXRlTmFtZUxpc3QgPSBmdW5jdGlvbiAoY29udGFpbmVyLCB2YXJpYWJsZSwgaW5kZXgpIHtcbiAgICB2YXIgbHN0O1xuICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgaW5kZXgpIHtcbiAgICAgICAgbHN0ID0gY29udGFpbmVyW3ZhcmlhYmxlXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBsc3QgPSBjb250YWluZXJbdmFyaWFibGVdW2luZGV4XTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RhdGVbdGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5yb290XS5vcHQubWF4X251bWJlcl9vZl9uYW1lcyBcbiAgICAgICAgJiYgbHN0Lmxlbmd0aCA+IDUwIFxuICAgICAgICAmJiBsc3QubGVuZ3RoID4gKHRoaXMuc3RhdGVbdGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5yb290XS5vcHQubWF4X251bWJlcl9vZl9uYW1lcyArIDIpKSB7XG4gICAgICAgIHZhciBsaW1pdCA9IHRoaXMuc3RhdGVbdGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5yb290XS5vcHQubWF4X251bWJlcl9vZl9uYW1lcztcbiAgICAgICAgbHN0ID0gbHN0LnNsaWNlKDAsIGxpbWl0KzEpLmNvbmNhdChsc3Quc2xpY2UoLTEpKTtcbiAgICB9XG4gICAgcmV0dXJuIGxzdDtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5kaXZpZGVBbmRUcmFuc2xpdGVyYXRlTmFtZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGksIGlsZW4sIGosIGpsZW47XG4gICAgdmFyIEl0ZW0gPSB0aGlzLkl0ZW07XG4gICAgdmFyIHZhcmlhYmxlcyA9IHRoaXMudmFyaWFibGVzO1xuICAgIHRoaXMudmFybmFtZXMgPSB2YXJpYWJsZXMuc2xpY2UoKTtcbiAgICB0aGlzLmZyZWV0ZXJzID0ge307XG4gICAgdGhpcy5wZXJzb25zID0ge307XG4gICAgdGhpcy5pbnN0aXR1dGlvbnMgPSB7fTtcbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gdmFyaWFibGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgdiA9IHZhcmlhYmxlc1tpXTtcbiAgICAgICAgdGhpcy52YXJpYWJsZV9vZmZzZXRbdl0gPSB0aGlzLm5hbWVzZXRfb2Zmc2V0O1xuICAgICAgICB2YXIgdmFsdWVzID0gdGhpcy5fbm9ybWFsaXplVmFyaWFibGVWYWx1ZShJdGVtLCB2KTtcbiAgICAgICAgaWYgKHRoaXMubmFtZS5zdHJpbmdzW1wic3VwcHJlc3MtbWluXCJdICYmIHZhbHVlcy5sZW5ndGggPj0gdGhpcy5uYW1lLnN0cmluZ3NbXCJzdXBwcmVzcy1taW5cIl0pIHtcbiAgICAgICAgICAgIHZhbHVlcyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm5hbWUuc3RyaW5nc1tcInN1cHByZXNzLW1heFwiXSAmJiB2YWx1ZXMubGVuZ3RoIDw9IHRoaXMubmFtZS5zdHJpbmdzW1wic3VwcHJlc3MtbWF4XCJdKSB7XG4gICAgICAgICAgICB2YWx1ZXMgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9nZXRGcmVldGVycyh2LCB2YWx1ZXMpO1xuICAgICAgICB0aGlzLl9nZXRQZXJzb25zQW5kSW5zdGl0dXRpb25zKHYsIHZhbHVlcyk7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnNwb29mX2luc3RpdHV0aW9uYWxfYWZmaWxpYXRpb25zKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5uYW1lLnN0cmluZ3NbXCJzdXBwcmVzcy1taW5cIl0gPT09IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZyZWV0ZXJzW3ZdID0gW107XG4gICAgICAgICAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IHRoaXMucGVyc29uc1t2XS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJzb25zW3ZdW2pdID0gW107XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3NbXCJzdXBwcmVzcy1taW5cIl0gPT09IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uc1t2XSA9IFtdO1xuICAgICAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNbdl0gPSB0aGlzLmZyZWV0ZXJzW3ZdLmNvbmNhdCh0aGlzLnBlcnNvbnNbdl0pO1xuICAgICAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSB0aGlzLnBlcnNvbnNbdl0ubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBrbGVuID0gdGhpcy5wZXJzb25zW3ZdW2pdLmxlbmd0aDsgayA8IGtsZW47IGsgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmVldGVyc1t2XS5wdXNoKHRoaXMucGVyc29uc1t2XVtqXVtrXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5wZXJzb25zW3ZdID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9ub3JtYWxpemVWYXJpYWJsZVZhbHVlID0gZnVuY3Rpb24gKEl0ZW0sIHZhcmlhYmxlKSB7XG4gICAgdmFyIG5hbWVzLCBuYW1lLCBpLCBpbGVuO1xuICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgSXRlbVt2YXJpYWJsZV0gfHwgXCJudW1iZXJcIiA9PT0gdHlwZW9mIEl0ZW1bdmFyaWFibGVdKSB7XG4gICAgICAgIENTTC5kZWJ1ZyhcIm5hbWUgdmFyaWFibGUgXFxcIlwiICsgdmFyaWFibGUgKyBcIlxcXCIgaXMgc3RyaW5nIG9yIG51bWJlciwgbm90IGFycmF5LiBBdHRlbXB0aW5nIHRvIGZpeC5cIik7XG4gICAgICAgIG5hbWVzID0gW3tsaXRlcmFsOiBJdGVtW3ZhcmlhYmxlXSArIFwiXCJ9XTtcbiAgICB9IGVsc2UgaWYgKCFJdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICBuYW1lcyA9IFtdO1xuICAgIH0gZWxzZSBpZiAoXCJudW1iZXJcIiAhPT0gdHlwZW9mIEl0ZW1bdmFyaWFibGVdLmxlbmd0aCkge1xuICAgICAgICBDU0wuZGVidWcoXCJuYW1lIHZhcmlhYmxlIFxcXCJcIiArIHZhcmlhYmxlICsgXCJcXFwiIGlzIG9iamVjdCwgbm90IGFycmF5LiBBdHRlbXB0aW5nIHRvIGZpeC5cIik7XG4gICAgICAgIEl0ZW1bdmFyaWFibGVdID0gW0l0ZW1bdmFyaWFibGVdXTtcbiAgICAgICAgbmFtZXMgPSBJdGVtW3ZhcmlhYmxlXS5zbGljZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG5hbWVzID0gSXRlbVt2YXJpYWJsZV0uc2xpY2UoKTtcbiAgICB9XG4gICAgcmV0dXJuIG5hbWVzO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fZ2V0RnJlZXRlcnMgPSBmdW5jdGlvbiAodiwgdmFsdWVzKSB7XG4gICAgdGhpcy5mcmVldGVyc1t2XSA9IFtdO1xuICAgIGlmICh0aGlzLnN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnNwb29mX2luc3RpdHV0aW9uYWxfYWZmaWxpYXRpb25zKSB7XG4gICAgICAgIGZvciAodmFyIGk9dmFsdWVzLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pc1BlcnNvbih2YWx1ZXNbaV0pKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fY2hlY2tOaWNrbmFtZSh2YWx1ZXMucG9wKCkpO1xuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWV0ZXJzW3ZdLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKHZhciBpPXZhbHVlcy5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVzLnBvcCgpO1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNQZXJzb24odmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fY2hlY2tOaWNrbmFtZSh2YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmZyZWV0ZXJzW3ZdLnB1c2godmFsdWUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMuZnJlZXRlcnNbdl0ucmV2ZXJzZSgpO1xuICAgIGlmICh0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aCkge1xuICAgICAgICB0aGlzLm5hbWVzZXRfb2Zmc2V0ICs9IDE7XG4gICAgfVxufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fZ2V0UGVyc29uc0FuZEluc3RpdHV0aW9ucyA9IGZ1bmN0aW9uICh2LCB2YWx1ZXMpIHtcbiAgICB0aGlzLnBlcnNvbnNbdl0gPSBbXTtcbiAgICB0aGlzLmluc3RpdHV0aW9uc1t2XSA9IFtdO1xuICAgIGlmICghdGhpcy5zdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5zcG9vZl9pbnN0aXR1dGlvbmFsX2FmZmlsaWF0aW9ucykgcmV0dXJuO1xuICAgIHZhciBwZXJzb25zID0gW107XG4gICAgdmFyIGhhc19hZmZpbGlhdGVzID0gZmFsc2U7XG4gICAgdmFyIGZpcnN0ID0gdHJ1ZTtcbiAgICBmb3IgKHZhciBpID0gdmFsdWVzLmxlbmd0aCAtIDE7IGkgPiAtMTsgaSArPSAtMSkge1xuICAgICAgICBpZiAodGhpcy5pc1BlcnNvbih2YWx1ZXNbaV0pKSB7XG4gICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLl9jaGVja05pY2tuYW1lKHZhbHVlc1tpXSk7XG4gICAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICBwZXJzb25zLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaGFzX2FmZmlsaWF0ZXMgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5pbnN0aXR1dGlvbnNbdl0ucHVzaCh2YWx1ZXNbaV0pO1xuICAgICAgICAgICAgaWYgKCFmaXJzdCkge1xuICAgICAgICAgICAgICAgIHBlcnNvbnMucmV2ZXJzZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMucGVyc29uc1t2XS5wdXNoKHBlcnNvbnMpO1xuICAgICAgICAgICAgICAgIHBlcnNvbnMgPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZpcnN0ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGhhc19hZmZpbGlhdGVzKSB7XG4gICAgICAgIHBlcnNvbnMucmV2ZXJzZSgpO1xuICAgICAgICB0aGlzLnBlcnNvbnNbdl0ucHVzaChwZXJzb25zKTtcbiAgICAgICAgdGhpcy5wZXJzb25zW3ZdLnJldmVyc2UoKTtcbiAgICAgICAgdGhpcy5pbnN0aXR1dGlvbnNbdl0ucmV2ZXJzZSgpO1xuICAgIH1cbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2NsZWFyVmFsdWVzID0gZnVuY3Rpb24gKHZhbHVlcykge1xuICAgIGZvciAodmFyIGkgPSB2YWx1ZXMubGVuZ3RoIC0gMTsgaSA+IC0xOyBpICs9IC0xKSB7XG4gICAgICAgIHZhbHVlcy5wb3AoKTtcbiAgICB9XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9jaGVja05pY2tuYW1lID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICBpZiAoW1wiaW50ZXJ2aWV3XCIsIFwicGVyc29uYWxfY29tbXVuaWNhdGlvblwiXS5pbmRleE9mKHRoaXMuSXRlbS50eXBlKSA+IC0xKSB7XG4gICAgICAgIHZhciBhdXRob3IgPSBcIlwiO1xuICAgICAgICBhdXRob3IgPSBDU0wuVXRpbC5OYW1lcy5nZXRSYXdOYW1lKG5hbWUpO1xuICAgICAgICBpZiAoYXV0aG9yICYmIHRoaXMuc3RhdGUuc3lzLmdldEFiYnJldmlhdGlvbiAmJiAhKHRoaXMuaXRlbSAmJiB0aGlzLml0ZW1bXCJzdXBwcmVzcy1hdXRob3JcIl0pKSB7XG4gICAgICAgICAgICB2YXIgbm9ybWFsaXplZEtleSA9IGF1dGhvcjtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLnN5cy5ub3JtYWxpemVBYmJyZXZzS2V5KSB7XG4gICAgICAgICAgICAgICAgbm9ybWFsaXplZEtleSA9IHRoaXMuc3RhdGUuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkoXCJhdXRob3JcIiwgYXV0aG9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc3RhdGUudHJhbnNmb3JtLmxvYWRBYmJyZXZpYXRpb24oXCJkZWZhdWx0XCIsIFwibmlja25hbWVcIiwgbm9ybWFsaXplZEtleSk7XG4gICAgICAgICAgICB2YXIgbXlMb2NhbE5hbWUgPSB0aGlzLnN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW1wiZGVmYXVsdFwiXS5uaWNrbmFtZVtub3JtYWxpemVkS2V5XTtcbiAgICAgICAgICAgIGlmIChteUxvY2FsTmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChteUxvY2FsTmFtZSA9PT0gXCIhaGVyZT4+PlwiKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuYW1lID0ge2ZhbWlseTpteUxvY2FsTmFtZSxnaXZlbjonJ307XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBuYW1lO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmpvaW5QZXJzb25zID0gZnVuY3Rpb24gKGJsb2JzLCBwb3MsIGosIHRva2VubmFtZSkge1xuICAgIHZhciByZXQ7XG4gICAgaWYgKCF0b2tlbm5hbWUpIHtcbiAgICAgICAgdG9rZW5uYW1lID0gXCJuYW1lXCI7XG4gICAgfVxuICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygaikge1xuICAgICAgICBpZiAodGhpcy5ldGFsX3NwZWNbcG9zXS5mcmVldGVycyA9PT0gMSkge1xuICAgICAgICAgICByZXQgPSB0aGlzLl9qb2luRXRBbChibG9icywgdG9rZW5uYW1lKTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmV0YWxfc3BlY1twb3NdLmZyZWV0ZXJzID09PSAyKSB7XG4gICAgICAgICAgICByZXQgPSB0aGlzLl9qb2luRWxsaXBzaXMoYmxvYnMsIHRva2VubmFtZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuc3RhdGUudG1wLnNvcnRfa2V5X2ZsYWcpIHtcbiAgICAgICAgICAgIHJldCA9IHRoaXMuX2pvaW5BbmQoYmxvYnMsIHRva2VubmFtZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXQgPSB0aGlzLl9qb2luKGJsb2JzLCBcIiBcIik7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5ldGFsX3NwZWNbcG9zXS5wZXJzb25zW2pdID09PSAxKSB7XG4gICAgICAgICAgICByZXQgPSB0aGlzLl9qb2luRXRBbChibG9icywgdG9rZW5uYW1lKTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmV0YWxfc3BlY1twb3NdLnBlcnNvbnNbal0gPT09IDIpIHtcbiAgICAgICAgICAgIHJldCA9IHRoaXMuX2pvaW5FbGxpcHNpcyhibG9icywgdG9rZW5uYW1lKTtcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5zdGF0ZS50bXAuc29ydF9rZXlfZmxhZykge1xuICAgICAgICAgICAgcmV0ID0gdGhpcy5fam9pbkFuZChibG9icywgdG9rZW5uYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldCA9IHRoaXMuX2pvaW4oYmxvYnMsIFwiIFwiKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5qb2luSW5zdGl0dXRpb25TZXRzID0gZnVuY3Rpb24gKGJsb2JzLCBwb3MpIHtcbiAgICB2YXIgcmV0O1xuICAgIGlmICh0aGlzLmV0YWxfc3BlY1twb3NdLmluc3RpdHV0aW9ucyA9PT0gMSkge1xuICAgICAgICByZXQgPSB0aGlzLl9qb2luRXRBbChibG9icywgXCJpbnN0aXR1dGlvblwiKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZXRhbF9zcGVjW3Bvc10uaW5zdGl0dXRpb25zID09PSAyKSB7XG4gICAgICAgIHJldCA9IHRoaXMuX2pvaW5FbGxpcHNpcyhibG9icywgXCJpbnN0aXR1dGlvblwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXQgPSB0aGlzLl9qb2luQW5kKGJsb2JzLCBcImluc3RpdHV0aW9uXCIpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5qb2luUGVyc29uc0FuZEluc3RpdHV0aW9ucyA9IGZ1bmN0aW9uIChibG9icykge1xuICAgIHJldHVybiB0aGlzLl9qb2luKGJsb2JzLCB0aGlzLnN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcik7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmpvaW5GcmVldGVyc0FuZEluc3RpdHV0aW9uU2V0cyA9IGZ1bmN0aW9uIChibG9icykge1xuICAgIHZhciByZXQgPSB0aGlzLl9qb2luKGJsb2JzLCBcIltuZXZlciBoZXJlXVwiLCB0aGlzW1wid2l0aFwiXS5zaW5nbGUsIHRoaXNbXCJ3aXRoXCJdLm11bHRpcGxlKTtcbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fam9pbkV0QWwgPSBmdW5jdGlvbiAoYmxvYnMsIHRva2VubmFtZSkge1xuICAgIHZhciBibG9iID0gdGhpcy5fam9pbihibG9icywgdGhpcy5zdGF0ZS50bXAubmFtZV9kZWxpbWl0ZXIpO1xuICAgIHRoaXMuc3RhdGUub3V0cHV0Lm9wZW5MZXZlbCh0aGlzLl9nZXRUb2tlbih0b2tlbm5hbWUpKTtcbiAgICB0aGlzLnN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkuc3RyaW5ncy5kZWxpbWl0ZXIgPSBcIlwiO1xuICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChibG9iLCBcImxpdGVyYWxcIiwgdHJ1ZSk7XG4gICAgaWYgKGJsb2JzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHRoaXNbXCJldC1hbFwiXS5tdWx0aXBsZSwgXCJsaXRlcmFsXCIsIHRydWUpO1xuICAgIH0gZWxzZSBpZiAoYmxvYnMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZCh0aGlzW1wiZXQtYWxcIl0uc2luZ2xlLCBcImxpdGVyYWxcIiwgdHJ1ZSk7XG4gICAgfVxuICAgIHRoaXMuc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoKTtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9qb2luRWxsaXBzaXMgPSBmdW5jdGlvbiAoYmxvYnMsIHRva2VubmFtZSkge1xuICAgIHJldHVybiB0aGlzLl9qb2luKGJsb2JzLCB0aGlzLnN0YXRlLnRtcC5uYW1lX2RlbGltaXRlciwgdGhpcy5uYW1lLmVsbGlwc2lzLnNpbmdsZSwgdGhpcy5uYW1lLmVsbGlwc2lzLm11bHRpcGxlLCB0b2tlbm5hbWUpO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fam9pbkFuZCA9IGZ1bmN0aW9uIChibG9icywgdG9rZW5uYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuX2pvaW4oYmxvYnMsIHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzW3Rva2VubmFtZV0sIFwiZGVsaW1pdGVyXCIsICh0b2tlbm5hbWUgKyBcIi1kZWxpbWl0ZXJcIiksIFwiLCBcIiksIHRoaXNbdG9rZW5uYW1lXS5hbmQuc2luZ2xlLCB0aGlzW3Rva2VubmFtZV0uYW5kLm11bHRpcGxlLCB0b2tlbm5hbWUpO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fam9pbiA9IGZ1bmN0aW9uIChibG9icywgZGVsaW1pdGVyLCBzaW5nbGUsIG11bHRpcGxlLCB0b2tlbm5hbWUpIHtcbiAgICB2YXIgaSwgaWxlbjtcbiAgICBpZiAoIWJsb2JzKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgZm9yIChpID0gYmxvYnMubGVuZ3RoIC0gMTsgaSA+IC0xOyBpICs9IC0xKSB7XG4gICAgICAgIGlmICghYmxvYnNbaV0gfHwgYmxvYnNbaV0ubGVuZ3RoID09PSAwIHx8ICFibG9ic1tpXS5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGJsb2JzID0gYmxvYnMuc2xpY2UoMCwgaSkuY29uY2F0KGJsb2JzLnNsaWNlKGkgKyAxKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFibG9icy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSBpZiAoc2luZ2xlICYmIGJsb2JzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICBpZiAoc2luZ2xlKSB7XG4gICAgICAgICAgICBzaW5nbGUgPSBuZXcgQ1NMLkJsb2Ioc2luZ2xlLmJsb2JzLHNpbmdsZSk7XG4gICAgICAgIH1cbiAgICAgICAgYmxvYnMgPSBbYmxvYnNbMF0sIHNpbmdsZSwgYmxvYnNbMV1dO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBkZWxpbWl0ZXJfb2Zmc2V0O1xuICAgICAgICBpZiAobXVsdGlwbGUpIHtcbiAgICAgICAgICAgIGRlbGltaXRlcl9vZmZzZXQgPSAyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVsaW1pdGVyX29mZnNldCA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGJsb2JzLmxlbmd0aCAtIGRlbGltaXRlcl9vZmZzZXQ7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGJsb2JzW2ldLnN0cmluZ3Muc3VmZml4ICs9IGRlbGltaXRlcjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYmxvYnMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgdmFyIGJsb2IgPSBibG9icy5wb3AoKTtcbiAgICAgICAgICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgICAgICAgICAgIG11bHRpcGxlID0gbmV3IENTTC5CbG9iKG11bHRpcGxlLmJsb2JzLG11bHRpcGxlKTtcbiAgICAgICAgICAgICAgICBibG9icy5wdXNoKG11bHRpcGxlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHNpbmdsZSkge1xuICAgICAgICAgICAgICAgICAgICBzaW5nbGUgPSBuZXcgQ1NMLkJsb2Ioc2luZ2xlLmJsb2JzLHNpbmdsZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJsb2JzLnB1c2goc2luZ2xlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJsb2JzLnB1c2goYmxvYik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQub3BlbkxldmVsKCk7XG4gICAgaWYgKHNpbmdsZSAmJiBtdWx0aXBsZSkge1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkuc3RyaW5ncy5kZWxpbWl0ZXIgPSBcIlwiO1xuICAgIH1cbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gYmxvYnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChibG9ic1tpXSwgZmFsc2UsIHRydWUpO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlLm91dHB1dC5jbG9zZUxldmVsKCk7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fZ2V0VG9rZW4gPSBmdW5jdGlvbiAodG9rZW5uYW1lKSB7XG4gICAgdmFyIHRva2VuID0gdGhpc1t0b2tlbm5hbWVdO1xuICAgIGlmICh0b2tlbm5hbWUgPT09IFwiaW5zdGl0dXRpb25cIikge1xuICAgICAgICB2YXIgbmV3dG9rZW4gPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgIHJldHVybiBuZXd0b2tlbjtcbiAgICB9XG4gICAgcmV0dXJuIHRva2VuO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLnNldENvbW1vblRlcm0gPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHZhcmlhYmxlcyA9IHRoaXMudmFyaWFibGVzO1xuICAgIHZhciB2YXJuYW1lcyA9IHZhcmlhYmxlcy5zbGljZSgpO1xuICAgIHZhcm5hbWVzLnNvcnQoKTtcbiAgICB0aGlzLmNvbW1vbl90ZXJtID0gdmFybmFtZXMuam9pbihcIlwiKTtcbiAgICBpZiAoIXRoaXMuY29tbW9uX3Rlcm0pIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB2YXIgaGFzX3Rlcm0gPSBmYWxzZTtcbiAgICBpZiAodGhpcy5sYWJlbCAmJiB0aGlzLmxhYmVsW3RoaXMudmFyaWFibGVzWzBdXSkge1xuICAgICAgICBpZiAodGhpcy5sYWJlbFt0aGlzLnZhcmlhYmxlc1swXV0uYmVmb3JlKSB7XG4gICAgICAgICAgICBoYXNfdGVybSA9IHRoaXMuc3RhdGUuZ2V0VGVybSh0aGlzLmNvbW1vbl90ZXJtLCB0aGlzLmxhYmVsW3RoaXMudmFyaWFibGVzWzBdXS5iZWZvcmUuc3RyaW5ncy5mb3JtLCAwKTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmxhYmVsW3RoaXMudmFyaWFibGVzWzBdXS5hZnRlcikge1xuICAgICAgICAgICAgaGFzX3Rlcm0gPSB0aGlzLnN0YXRlLmdldFRlcm0odGhpcy5jb21tb25fdGVybSwgdGhpcy5sYWJlbFt0aGlzLnZhcmlhYmxlc1swXV0uYWZ0ZXIuc3RyaW5ncy5mb3JtLCAwKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXRoaXMuc3RhdGUubG9jYWxlW3RoaXMuc3RhdGUub3B0LmxhbmddLnRlcm1zW3RoaXMuY29tbW9uX3Rlcm1dXG4gICAgICAgIHx8ICFoYXNfdGVybVxuICAgICAgICB8fCB0aGlzLnZhcmlhYmxlcy5sZW5ndGggPCAyKSB7XG4gICAgICAgIHRoaXMuY29tbW9uX3Rlcm0gPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgZnJlZXRlcnNfb2Zmc2V0ID0gMDtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMudmFyaWFibGVzLmxlbmd0aCAtIDE7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIHYgPSB0aGlzLnZhcmlhYmxlc1tpXTtcbiAgICAgICAgdmFyIHZ2ID0gdGhpcy52YXJpYWJsZXNbaSArIDFdO1xuICAgICAgICBpZiAodGhpcy5mcmVldGVyc1t2XS5sZW5ndGggfHwgdGhpcy5mcmVldGVyc1t2dl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5ldGFsX3NwZWNbdl0uZnJlZXRlcnMgIT09IHRoaXMuZXRhbF9zcGVjW3Z2XS5mcmVldGVyc1xuICAgICAgICAgICAgICAgIHx8ICF0aGlzLl9jb21wYXJlTmFtZXNldHModGhpcy5mcmVldGVyc1t2XSwgdGhpcy5mcmVldGVyc1t2dl0pKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb21tb25fdGVybSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZyZWV0ZXJzX29mZnNldCArPSAxO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnBlcnNvbnNbdl0ubGVuZ3RoICE9PSB0aGlzLnBlcnNvbnNbdnZdLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5jb21tb25fdGVybSA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gdGhpcy5wZXJzb25zW3ZdLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZXRhbF9zcGVjW3ZdLnBlcnNvbnNbal0gIT09IHRoaXMuZXRhbF9zcGVjW3Z2XS5wZXJzb25zW2pdXG4gICAgICAgICAgICAgICAgfHwgIXRoaXMuX2NvbXBhcmVOYW1lc2V0cyh0aGlzLnBlcnNvbnNbdl1bal0sIHRoaXMucGVyc29uc1t2dl1bal0pKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb21tb25fdGVybSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2NvbXBhcmVOYW1lc2V0cyA9IGZ1bmN0aW9uIChiYXNlX25hbWVzZXQsIG5hbWVzZXQpIHtcbiAgICBpZiAoYmFzZV9uYW1lc2V0Lmxlbmd0aCAhPT0gbmFtZXNldC5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG5hbWVzZXQubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciBuYW1lID0gbmFtZXNldFtpXTtcbiAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSBDU0wuTkFNRV9QQVJUUy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIHZhciBwYXJ0ID0gQ1NMLk5BTUVfUEFSVFNbal07XG4gICAgICAgICAgICBpZiAoIWJhc2VfbmFtZXNldFtpXSB8fCBiYXNlX25hbWVzZXRbaV1bcGFydF0gIT0gbmFtZXNldFtpXVtwYXJ0XSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5jb25zdHJhaW5OYW1lcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLm5hbWVzX2NvdW50ID0gMDtcbiAgICB2YXIgcG9zO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy52YXJpYWJsZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciB2ID0gdGhpcy52YXJpYWJsZXNbaV07XG4gICAgICAgIHBvcyA9IHRoaXMubmFtZXNldF9iYXNlICsgaTtcbiAgICAgICAgaWYgKHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5uYW1lc19tYXgucHVzaCh0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aCwgXCJsaXRlcmFsXCIpO1xuICAgICAgICAgICAgdGhpcy5faW1wb3NlTmFtZUNvbnN0cmFpbnRzKHRoaXMuZnJlZXRlcnMsIHRoaXMuZnJlZXRlcnNfY291bnQsIHYsIHBvcyk7XG4gICAgICAgICAgICB0aGlzLm5hbWVzX2NvdW50ICs9IHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLm5hbWVzX21heC5wdXNoKHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aCwgXCJsaXRlcmFsXCIpO1xuICAgICAgICAgICAgdGhpcy5faW1wb3NlTmFtZUNvbnN0cmFpbnRzKHRoaXMuaW5zdGl0dXRpb25zLCB0aGlzLmluc3RpdHV0aW9uc19jb3VudCwgdiwgcG9zKTtcbiAgICAgICAgICAgIHRoaXMucGVyc29uc1t2XSA9IHRoaXMucGVyc29uc1t2XS5zbGljZSgwLCB0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGgpO1xuICAgICAgICAgICAgdGhpcy5uYW1lc19jb3VudCArPSB0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSB0aGlzLnBlcnNvbnNbdl0ubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5wZXJzb25zW3ZdW2pdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLm5hbWVzX21heC5wdXNoKHRoaXMucGVyc29uc1t2XVtqXS5sZW5ndGgsIFwibGl0ZXJhbFwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9pbXBvc2VOYW1lQ29uc3RyYWludHModGhpcy5wZXJzb25zW3ZdLCB0aGlzLnBlcnNvbnNfY291bnRbdl0sIGosIHBvcyk7XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lc19jb3VudCArPSB0aGlzLnBlcnNvbnNbdl1bal0ubGVuZ3RoO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5faW1wb3NlTmFtZUNvbnN0cmFpbnRzID0gZnVuY3Rpb24gKGxzdCwgY291bnQsIGtleSwgcG9zKSB7XG4gICAgdmFyIGRpc3BsYXlfbmFtZXMgPSBsc3Rba2V5XTtcbiAgICB2YXIgZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGggPSB0aGlzLnN0YXRlLnRtcFtcImV0LWFsLW1pblwiXTtcbiAgICBpZiAodGhpcy5zdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3JlcXVlc3QgJiYgdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfcmVxdWVzdC5uYW1lc1twb3NdKSB7XG4gICAgICAgICAgICBkaXNjcmV0aW9uYXJ5X25hbWVzX2xlbmd0aCA9IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3JlcXVlc3QubmFtZXNbcG9zXTtcbiAgICAgICAgfSBlbHNlIGlmIChjb3VudFtrZXldID49IHRoaXMuZXRhbF9taW4pIHtcbiAgICAgICAgICAgIGRpc2NyZXRpb25hcnlfbmFtZXNfbGVuZ3RoID0gdGhpcy5ldGFsX3VzZV9maXJzdDtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19yZXF1ZXN0IFxuICAgICAgICAgICAgJiYgdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfcmVxdWVzdC5uYW1lc1twb3NdID4gdGhpcy5ldGFsX3VzZV9maXJzdCkge1xuICAgICAgICAgICAgaWYgKGNvdW50W2tleV0gPCB0aGlzLmV0YWxfbWluKSB7XG4gICAgICAgICAgICAgICAgZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGggPSBjb3VudFtrZXldO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkaXNjcmV0aW9uYXJ5X25hbWVzX2xlbmd0aCA9IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3JlcXVlc3QubmFtZXNbcG9zXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChjb3VudFtrZXldID49IHRoaXMuZXRhbF9taW4pIHtcbiAgICAgICAgICAgIGRpc2NyZXRpb25hcnlfbmFtZXNfbGVuZ3RoID0gdGhpcy5ldGFsX3VzZV9maXJzdDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5ldGFsX3VzZV9sYXN0ICYmIGRpc2NyZXRpb25hcnlfbmFtZXNfbGVuZ3RoID4gKHRoaXMuZXRhbF9taW4gLSAyKSkge1xuICAgICAgICAgICAgZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGggPSB0aGlzLmV0YWxfbWluIC0gMjtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgc2FuZSA9IHRoaXMuZXRhbF9taW4gPj0gdGhpcy5ldGFsX3VzZV9maXJzdDtcbiAgICB2YXIgb3Zlcmxlbmd0aCA9IGNvdW50W2tleV0gPiBkaXNjcmV0aW9uYXJ5X25hbWVzX2xlbmd0aDtcbiAgICBpZiAoZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGggPiBjb3VudFtrZXldKSB7XG4gICAgICAgIGRpc2NyZXRpb25hcnlfbmFtZXNfbGVuZ3RoID0gZGlzcGxheV9uYW1lcy5sZW5ndGg7XG4gICAgfVxuICAgIGlmIChzYW5lICYmIG92ZXJsZW5ndGgpIHtcbiAgICAgICAgaWYgKHRoaXMuZXRhbF91c2VfbGFzdCkge1xuICAgICAgICAgICAgbHN0W2tleV0gPSBkaXNwbGF5X25hbWVzLnNsaWNlKDAsIGRpc2NyZXRpb25hcnlfbmFtZXNfbGVuZ3RoKS5jb25jYXQoZGlzcGxheV9uYW1lcy5zbGljZSgtMSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbHN0W2tleV0gPSBkaXNwbGF5X25hbWVzLnNsaWNlKDAsIGRpc2NyZXRpb25hcnlfbmFtZXNfbGVuZ3RoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5uYW1lc1twb3NdID0gbHN0W2tleV0ubGVuZ3RoO1xuICAgIHRoaXMuc3RhdGUuZGlzYW1iaWd1YXRlLnBhZEJhc2UodGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmRpc2FtYmlnTmFtZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHBvcztcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMudmFyaWFibGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgdiA9IHRoaXMudmFyaWFibGVzW2ldO1xuICAgICAgICBwb3MgPSB0aGlzLm5hbWVzZXRfYmFzZSArIGk7XG4gICAgICAgIGlmICh0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5fcnVuRGlzYW1iaWdOYW1lcyh0aGlzLmZyZWV0ZXJzW3ZdLCBwb3MpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zW3Bvc10pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbcG9zXSA9IFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49dGhpcy5pbnN0aXR1dGlvbnNbdl0ubGVuZ3RoO2o8amxlbjtqKz0xKSB7XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbcG9zXVtqXSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbcG9zXS5wdXNoKDIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IHRoaXMucGVyc29uc1t2XS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnBlcnNvbnNbdl1bal0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcnVuRGlzYW1iaWdOYW1lcyh0aGlzLnBlcnNvbnNbdl1bal0sIHBvcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9ydW5EaXNhbWJpZ05hbWVzID0gZnVuY3Rpb24gKGxzdCwgcG9zKSB7XG4gICAgdmFyIGNoaywgbXlmb3JtLCBteWluaXRpYWxzLCBwYXJhbSwgaSwgaWxlbiwgcGFyYW14O1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBsc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGlmICghbHN0W2ldLmdpdmVuICYmICFsc3RbaV0uZmFtaWx5KSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBteWluaXRpYWxzID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJpbml0aWFsaXplLXdpdGhcIik7XG4gICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkubmFtZXJlZy5hZGRuYW1lKFwiXCIgKyB0aGlzLkl0ZW0uaWQsIGxzdFtpXSwgaSk7XG4gICAgICAgIGNoayA9IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVuc1twb3NdO1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGNoaykge1xuICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSBwb3MgKyAxOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbal0pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zW2pdID0gW107XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNoayA9IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVuc1twb3NdW2ldO1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGNoaykge1xuICAgICAgICAgICAgbXlmb3JtID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJmb3JtXCIsIFwibmFtZS1mb3JtXCIsIFwibG9uZ1wiKTtcbiAgICAgICAgICAgIHBhcmFtID0gdGhpcy5zdGF0ZS5yZWdpc3RyeS5uYW1lcmVnLmV2YWxuYW1lKFwiXCIgKyB0aGlzLkl0ZW0uaWQsIGxzdFtpXSwgaSwgMCwgbXlmb3JtLCBteWluaXRpYWxzKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVuc1twb3NdLnB1c2gocGFyYW0pO1xuICAgICAgICB9XG4gICAgICAgIG15Zm9ybSA9IHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiZm9ybVwiLCBcIm5hbWUtZm9ybVwiLCBcImxvbmdcIik7XG4gICAgICAgIHBhcmFteCA9IHRoaXMuc3RhdGUucmVnaXN0cnkubmFtZXJlZy5ldmFsbmFtZShcIlwiICsgdGhpcy5JdGVtLmlkLCBsc3RbaV0sIGksIDAsIG15Zm9ybSwgbXlpbml0aWFscyk7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19yZXF1ZXN0KSB7XG4gICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zW3Bvc11baV07XG4gICAgICAgICAgICBpZiAodmFsID09PSAxICYmIFxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0gPT09IFwiYnktY2l0ZVwiICYmIFxuICAgICAgICAgICAgICAgIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJpbml0aWFsaXplLXdpdGhcIilcbiAgICAgICAgICAgICAgICAgfHwgXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGxzdFtpXS5naXZlbikpIHtcbiAgICAgICAgICAgICAgICB2YWwgPSAyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFyYW0gPSB2YWw7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiXSAmJiBsc3RbaV0uZ2l2ZW4pIHtcbiAgICAgICAgICAgICAgICBwYXJhbSA9IHRoaXMuc3RhdGUucmVnaXN0cnkubmFtZXJlZy5ldmFsbmFtZShcIlwiICsgdGhpcy5JdGVtLmlkLCBsc3RbaV0sIGksIHBhcmFtLCB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImZvcm1cIiwgXCJuYW1lLWZvcm1cIiwgXCJsb25nXCIpLCB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImluaXRpYWxpemUtd2l0aFwiKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwYXJhbSA9IHBhcmFteDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuc3RhdGUudG1wLmp1c3RfbG9va2luZyAmJiB0aGlzLml0ZW0gJiYgdGhpcy5pdGVtLnBvc2l0aW9uID09PSBDU0wuUE9TSVRJT05fRklSU1QpIHtcbiAgICAgICAgICAgIGlmIChwYXJhbXggPiBwYXJhbSkge1xuICAgICAgICAgICAgICAgIHBhcmFtID0gcGFyYW14O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS50bXAuc29ydF9rZXlfZmxhZykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zW3Bvc11baV0gPSBwYXJhbTtcbiAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgbXlpbml0aWFsc1xuICAgICAgICAgICAgICAgICYmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5uYW1lLnN0cmluZ3NbXCJpbml0aWFsaXplXCJdXG4gICAgICAgICAgICAgICAgICAgIHx8IHRydWUgPT09IHRoaXMubmFtZS5zdHJpbmdzW1wiaW5pdGlhbGl6ZVwiXSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy51c2VfaW5pdGlhbHMgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmdldEV0QWxDb25maWcgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGl0ZW0gPSB0aGlzLml0ZW07XG4gICAgdGhpc1tcImV0LWFsXCJdID0ge307XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHRoaXMuZXRhbF90ZXJtLCB0aGlzLmV0YWxfc3R5bGUsIHRydWUpO1xuICAgIHRoaXNbXCJldC1hbFwiXS5zaW5nbGUgPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICB0aGlzW1wiZXQtYWxcIl0uc2luZ2xlLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5ldGFsX3N1ZmZpeDtcbiAgICB0aGlzW1wiZXQtYWxcIl0uc2luZ2xlLnN0cmluZ3MucHJlZml4ID0gdGhpcy5ldGFsX3ByZWZpeF9zaW5nbGU7XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHRoaXMuZXRhbF90ZXJtLCB0aGlzLmV0YWxfc3R5bGUsIHRydWUpO1xuICAgIHRoaXNbXCJldC1hbFwiXS5tdWx0aXBsZSA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgIHRoaXNbXCJldC1hbFwiXS5tdWx0aXBsZS5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuZXRhbF9zdWZmaXg7XG4gICAgdGhpc1tcImV0LWFsXCJdLm11bHRpcGxlLnN0cmluZ3MucHJlZml4ID0gdGhpcy5ldGFsX3ByZWZpeF9tdWx0aXBsZTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGl0ZW0pIHtcbiAgICAgICAgaXRlbSA9IHt9O1xuICAgIH1cbiAgICBpZiAoaXRlbS5wb3NpdGlvbikge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJldC1hbC1zdWJzZXF1ZW50LW1pblwiKSkge1xuICAgICAgICAgICAgdGhpcy5ldGFsX21pbiA9IHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiZXQtYWwtc3Vic2VxdWVudC1taW5cIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfbWluID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJldC1hbC1taW5cIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiZXQtYWwtc3Vic2VxdWVudC11c2UtZmlyc3RcIikpIHtcbiAgICAgICAgICAgIHRoaXMuZXRhbF91c2VfZmlyc3QgPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImV0LWFsLXN1YnNlcXVlbnQtdXNlLWZpcnN0XCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ldGFsX3VzZV9maXJzdCA9IHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiZXQtYWwtdXNlLWZpcnN0XCIpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wW1wiZXQtYWwtbWluXCJdKSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfbWluID0gdGhpcy5zdGF0ZS50bXBbXCJldC1hbC1taW5cIl07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfbWluID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJldC1hbC1taW5cIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wW1wiZXQtYWwtdXNlLWZpcnN0XCJdKSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfdXNlX2ZpcnN0ID0gdGhpcy5zdGF0ZS50bXBbXCJldC1hbC11c2UtZmlyc3RcIl07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfdXNlX2ZpcnN0ID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJldC1hbC11c2UtZmlyc3RcIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwiYm9vbGVhblwiID09PSB0eXBlb2YgdGhpcy5zdGF0ZS50bXBbXCJldC1hbC11c2UtbGFzdFwiXSkge1xuICAgICAgICAgICAgdGhpcy5ldGFsX3VzZV9sYXN0ID0gdGhpcy5zdGF0ZS50bXBbXCJldC1hbC11c2UtbGFzdFwiXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZXRhbF91c2VfbGFzdCA9IHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiZXQtYWwtdXNlLWxhc3RcIik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCF0aGlzLnN0YXRlLnRtcFtcImV0LWFsLW1pblwiXSkge1xuICAgICAgICB0aGlzLnN0YXRlLnRtcFtcImV0LWFsLW1pblwiXSA9IHRoaXMuZXRhbF9taW47XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLnNldEV0QWxQYXJhbWV0ZXJzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBpLCBpbGVuLCBqLCBqbGVuO1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSB0aGlzLnZhcmlhYmxlcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIHYgPSB0aGlzLnZhcmlhYmxlc1tpXTtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLmV0YWxfc3BlY1t2XSkge1xuICAgICAgICAgICAgdGhpcy5ldGFsX3NwZWNbdl0gPSB7ZnJlZXRlcnM6MCxpbnN0aXR1dGlvbnM6MCxwZXJzb25zOltdfTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmV0YWxfc3BlY1t0aGlzLm5hbWVzZXRfYmFzZSArIGldID0gdGhpcy5ldGFsX3NwZWNbdl07XG4gICAgICAgIGlmICh0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5fc2V0RXRBbFBhcmFtZXRlcihcImZyZWV0ZXJzXCIsIHYpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSB0aGlzLnBlcnNvbnNbdl0ubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMuZXRhbF9zcGVjW3ZdW2pdKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ldGFsX3NwZWNbdl0ucGVyc29uc1tqXSA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLl9zZXRFdEFsUGFyYW1ldGVyKFwicGVyc29uc1wiLCB2LCBqKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5pbnN0aXR1dGlvbnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLl9zZXRFdEFsUGFyYW1ldGVyKFwiaW5zdGl0dXRpb25zXCIsIHYpO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fc2V0RXRBbFBhcmFtZXRlciA9IGZ1bmN0aW9uICh0eXBlLCB2LCBqKSB7XG4gICAgdmFyIGxzdCwgY291bnQ7XG4gICAgaWYgKHR5cGUgPT09IFwicGVyc29uc1wiKSB7XG4gICAgICAgIGxzdCA9IHRoaXMucGVyc29uc1t2XVtqXTtcbiAgICAgICAgY291bnQgPSB0aGlzLnBlcnNvbnNfY291bnRbdl1bal07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbHN0ID0gdGhpc1t0eXBlXVt2XTtcbiAgICAgICAgY291bnQgPSB0aGlzW3R5cGUgKyBcIl9jb3VudFwiXVt2XTtcbiAgICB9XG4gICAgaWYgKGxzdC5sZW5ndGggPCBjb3VudCAmJiAhdGhpcy5zdGF0ZS50bXAuc29ydF9rZXlfZmxhZykge1xuICAgICAgICBpZiAodGhpcy5ldGFsX3VzZV9sYXN0KSB7XG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gXCJwZXJzb25zXCIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1t2XS5wZXJzb25zW2pdID0gMlxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1t2XVt0eXBlXSA9IDI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gXCJwZXJzb25zXCIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1t2XS5wZXJzb25zW2pdID0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ldGFsX3NwZWNbdl1bdHlwZV0gPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHR5cGUgPT09IFwicGVyc29uc1wiKSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1t2XS5wZXJzb25zW2pdID0gMDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZXRhbF9zcGVjW3ZdW3R5cGVdID0gMDtcbiAgICAgICAgfVxuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5yZW5kZXJBbGxOYW1lcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcG9zO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy52YXJpYWJsZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciB2ID0gdGhpcy52YXJpYWJsZXNbaV07XG4gICAgICAgIGlmICh0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aCB8fCB0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5zdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuY29uZGl0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuanVzdF9kaWRfbnVtYmVyID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcG9zID0gdGhpcy5uYW1lc2V0X2Jhc2UgKyBpO1xuICAgICAgICBpZiAodGhpcy5mcmVldGVyc1t2XS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNbdl0gPSB0aGlzLl9yZW5kZXJOYW1lcyh2LCB0aGlzLmZyZWV0ZXJzW3ZdLCBwb3MpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gdGhpcy5pbnN0aXR1dGlvbnNbdl0ubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICB0aGlzLnBlcnNvbnNbdl1bal0gPSB0aGlzLl9yZW5kZXJOYW1lcyh2LCB0aGlzLnBlcnNvbnNbdl1bal0sIHBvcywgaik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5yZW5kZXJJbnN0aXR1dGlvbk5hbWVzKCk7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLnJlbmRlckluc3RpdHV0aW9uTmFtZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLnZhcmlhYmxlcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIHYgPSB0aGlzLnZhcmlhYmxlc1tpXTtcbiAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSB0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIHZhciBpbnN0aXR1dGlvbiwgaW5zdGl0dXRpb25fc2hvcnQsIGluc3RpdHV0aW9uX2xvbmcsIHNob3J0X3N0eWxlLCBsb25nX3N0eWxlO1xuICAgICAgICAgICAgdmFyIG5hbWUgPSB0aGlzLmluc3RpdHV0aW9uc1t2XVtqXTtcbiAgICAgICAgICAgIHZhciBqLCByZXQsIG9wdExhbmdUYWcsIGpsZW4sIGtleSwgbG9jYWxlc2V0cztcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5leHRlbnNpb24pIHtcbiAgICAgICAgICAgICAgICBsb2NhbGVzZXRzID0gW1wic29ydFwiXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZS5pc0luc3RpdHV0aW9uIHx8IG5hbWUubGl0ZXJhbCkge1xuICAgICAgICAgICAgICAgIGxvY2FsZXNldHMgPSB0aGlzLnN0YXRlLm9wdFsnY2l0ZS1sYW5nLXByZWZzJ10uaW5zdGl0dXRpb25zO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2NhbGVzZXRzID0gdGhpcy5zdGF0ZS5vcHRbJ2NpdGUtbGFuZy1wcmVmcyddLnBlcnNvbnM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgc2xvdCA9IHtwcmltYXJ5Oidsb2NhbGUtb3JpZycsc2Vjb25kYXJ5OmZhbHNlLHRlcnRpYXJ5OmZhbHNlfTtcblx0ICAgICAgICBpZiAobG9jYWxlc2V0cykge1xuXHRcdCAgICAgICAgdmFyIHNsb3RuYW1lcyA9IFtcInByaW1hcnlcIiwgXCJzZWNvbmRhcnlcIiwgXCJ0ZXJ0aWFyeVwiXTtcblx0XHQgICAgICAgIGZvciAodmFyIGsgPSAwLCBrbGVuID0gc2xvdG5hbWVzLmxlbmd0aDsgayA8IGtsZW47IGsgKz0gMSkge1xuXHRcdFx0ICAgICAgICBpZiAobG9jYWxlc2V0cy5sZW5ndGggLSAxIDwgIGspIHtcblx0XHRcdFx0ICAgICAgICBicmVhaztcblx0XHRcdCAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAobG9jYWxlc2V0c1trXSkge1xuXHRcdFx0ICAgICAgICAgICAgc2xvdFtzbG90bmFtZXNba11dID0gJ2xvY2FsZS0nICsgbG9jYWxlc2V0c1trXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXHRcdCAgICAgICAgfVxuXHQgICAgICAgIH0gZWxzZSB7XG5cdFx0ICAgICAgICBzbG90LnByaW1hcnkgPSAnbG9jYWxlLXRyYW5zbGF0Jztcblx0ICAgICAgICB9XG5cdCAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLmFyZWEgIT09IFwiYmlibGlvZ3JhcGh5XCJcblx0XHQgICAgICAgICYmICEodGhpcy5zdGF0ZS50bXAuYXJlYSA9PT0gXCJjaXRhdGlvblwiXG5cdFx0XHQgICAgICAgICAmJiB0aGlzLnN0YXRlLm9wdC54Y2xhc3MgPT09IFwibm90ZVwiXG5cdFx0XHQgICAgICAgICAmJiB0aGlzLml0ZW0gJiYgIXRoaXMuaXRlbS5wb3NpdGlvbikpIHtcblx0XHQgICAgICAgIHNsb3Quc2Vjb25kYXJ5ID0gZmFsc2U7XG5cdFx0ICAgICAgICBzbG90LnRlcnRpYXJ5ID0gZmFsc2U7XG5cdCAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHJlcztcbiAgICAgICAgICAgIHRoaXMuc2V0UmVuZGVyZWROYW1lKG5hbWUpO1xuICAgICAgICAgICAgdmFyIGluc3RpdHV0aW9uID0gdGhpcy5fcmVuZGVySW5zdGl0dXRpb25OYW1lKHYsIG5hbWUsIHNsb3QsIGopO1xuICAgICAgICAgICAgdGhpcy5pbnN0aXR1dGlvbnNbdl1bal0gPSBpbnN0aXR1dGlvbjtcbiAgICAgICAgfVxuICAgIH1cbn1cbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fcmVuZGVySW5zdGl0dXRpb25OYW1lID0gZnVuY3Rpb24gKHYsIG5hbWUsIHNsb3QsIGopIHtcbiAgICB2YXIgc2Vjb25kYXJ5LCB0ZXJ0aWFyeSwgbG9uZ19zdHlsZSwgc2hvcnRfc3R5bGUsIGluc3RpdHV0aW9uLCBpbnN0aXR1dGlvbl9zaG9ydCwgaW5zdGl0dXRpb25fbG9uZztcbiAgICB2YXIgcmVzID0gdGhpcy5nZXROYW1lKG5hbWUsIHNsb3QucHJpbWFyeSwgdHJ1ZSk7XG4gICAgdmFyIHByaW1hcnkgPSByZXMubmFtZTtcbiAgICB2YXIgdXNlZE9yaWcgPSByZXMudXNlZE9yaWc7XG4gICAgaWYgKHByaW1hcnkpIHtcbiAgICAgICAgcHJpbWFyeSA9IHRoaXMuZml4dXBJbnN0aXR1dGlvbihwcmltYXJ5LCB2LCBqKTtcbiAgICB9XG5cdHNlY29uZGFyeSA9IGZhbHNlO1xuXHRpZiAoc2xvdC5zZWNvbmRhcnkpIHtcbiAgICAgICAgcmVzID0gdGhpcy5nZXROYW1lKG5hbWUsIHNsb3Quc2Vjb25kYXJ5LCBmYWxzZSwgdXNlZE9yaWcpO1xuICAgICAgICB2YXIgc2Vjb25kYXJ5ID0gcmVzLm5hbWU7XG4gICAgICAgIHVzZWRPcmlnID0gcmVzLnVzZWRPcmlnO1xuICAgICAgICBpZiAoc2Vjb25kYXJ5KSB7XG5cdFx0XHRzZWNvbmRhcnkgPSB0aGlzLmZpeHVwSW5zdGl0dXRpb24oc2Vjb25kYXJ5LCB2LCBqKTtcbiAgICAgICAgfVxuXHR9XG5cdHRlcnRpYXJ5ID0gZmFsc2U7XG5cdGlmIChzbG90LnRlcnRpYXJ5KSB7XG4gICAgICAgIHJlcyA9IHRoaXMuZ2V0TmFtZShuYW1lLCBzbG90LnRlcnRpYXJ5LCBmYWxzZSwgdXNlZE9yaWcpO1xuICAgICAgICB0ZXJ0aWFyeSA9IHJlcy5uYW1lO1xuICAgICAgICBpZiAodGVydGlhcnkpIHtcblx0XHRcdHRlcnRpYXJ5ID0gdGhpcy5maXh1cEluc3RpdHV0aW9uKHRlcnRpYXJ5LCB2LCBqKTtcbiAgICAgICAgfVxuXHR9XG4gICAgdmFyIG4gPSB7XG4gICAgICAgIGw6IHtcbiAgICAgICAgICAgIHByaTogZmFsc2UsXG4gICAgICAgICAgICBzZWM6IGZhbHNlLFxuICAgICAgICAgICAgdGVyOiBmYWxzZVxuICAgICAgICB9LFxuICAgICAgICBzOiB7XG4gICAgICAgICAgICBwcmk6IGZhbHNlLFxuICAgICAgICAgICAgc2VjOiBmYWxzZSxcbiAgICAgICAgICAgIHRlcjogZmFsc2VcbiAgICAgICAgfVxuICAgIH07XG4gICAgaWYgKHByaW1hcnkpIHtcbiAgICAgICAgbi5sLnByaSA9IHByaW1hcnlbXCJsb25nXCJdO1xuICAgICAgICBuLnMucHJpID0gcHJpbWFyeVtcInNob3J0XCJdLmxlbmd0aCA/IHByaW1hcnlbXCJzaG9ydFwiXSA6IHByaW1hcnlbXCJsb25nXCJdO1xuICAgIH1cbiAgICBpZiAoc2Vjb25kYXJ5KSB7XG4gICAgICAgIG4ubC5zZWMgPSBzZWNvbmRhcnlbXCJsb25nXCJdO1xuICAgICAgICBuLnMuc2VjID0gc2Vjb25kYXJ5W1wic2hvcnRcIl0ubGVuZ3RoID8gc2Vjb25kYXJ5W1wic2hvcnRcIl0gOiBzZWNvbmRhcnlbXCJsb25nXCJdO1xuICAgIH1cbiAgICBpZiAodGVydGlhcnkpIHtcbiAgICAgICAgbi5sLnRlciA9IHRlcnRpYXJ5W1wibG9uZ1wiXTtcbiAgICAgICAgbi5zLnRlciA9IHRlcnRpYXJ5W1wic2hvcnRcIl0ubGVuZ3RoID8gdGVydGlhcnlbXCJzaG9ydFwiXSA6IHRlcnRpYXJ5W1wibG9uZ1wiXTtcbiAgICB9XG4gICAgc3dpdGNoICh0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3NbXCJpbnN0aXR1dGlvbi1wYXJ0c1wiXSkge1xuICAgIGNhc2UgXCJzaG9ydFwiOlxuICAgICAgICBpZiAocHJpbWFyeVtcInNob3J0XCJdLmxlbmd0aCkge1xuICAgICAgICAgICAgc2hvcnRfc3R5bGUgPSB0aGlzLl9nZXRTaG9ydFN0eWxlKCk7XG4gICAgICAgICAgICBpbnN0aXR1dGlvbiA9IFt0aGlzLl9jb21wb3NlT25lSW5zdGl0dXRpb25QYXJ0KFtuLnMucHJpLCBuLnMuc2VjLCBuLnMudGVyXSwgc2xvdCwgc2hvcnRfc3R5bGUsIHYpXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvbmdfc3R5bGUgPSB0aGlzLl9nZXRMb25nU3R5bGUocHJpbWFyeSwgdiwgaik7XG4gICAgICAgICAgICBpbnN0aXR1dGlvbiA9IFt0aGlzLl9jb21wb3NlT25lSW5zdGl0dXRpb25QYXJ0KFtuLmwucHJpLCBuLmwuc2VjLCBuLmwudGVyXSwgc2xvdCwgbG9uZ19zdHlsZSwgdildO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIGNhc2UgXCJzaG9ydC1sb25nXCI6XG4gICAgICAgIGxvbmdfc3R5bGUgPSB0aGlzLl9nZXRMb25nU3R5bGUocHJpbWFyeSwgdiwgaik7XG4gICAgICAgIHNob3J0X3N0eWxlID0gdGhpcy5fZ2V0U2hvcnRTdHlsZSgpO1xuICAgICAgICBpbnN0aXR1dGlvbl9zaG9ydCA9IHRoaXMuX3JlbmRlck9uZUluc3RpdHV0aW9uUGFydChwcmltYXJ5W1wic2hvcnRcIl0sIHNob3J0X3N0eWxlKTtcbiAgICAgICAgaW5zdGl0dXRpb25fbG9uZyA9IHRoaXMuX2NvbXBvc2VPbmVJbnN0aXR1dGlvblBhcnQoW24ubC5wcmksIG4ubC5zZWMsIG4ubC50ZXJdLCBzbG90LCBsb25nX3N0eWxlLCB2KTtcbiAgICAgICAgaW5zdGl0dXRpb24gPSBbaW5zdGl0dXRpb25fc2hvcnQsIGluc3RpdHV0aW9uX2xvbmddO1xuICAgICAgICBicmVhaztcbiAgICBjYXNlIFwibG9uZy1zaG9ydFwiOlxuICAgICAgICBsb25nX3N0eWxlID0gdGhpcy5fZ2V0TG9uZ1N0eWxlKHByaW1hcnksIHYsIGopO1xuICAgICAgICBzaG9ydF9zdHlsZSA9IHRoaXMuX2dldFNob3J0U3R5bGUoKTtcbiAgICAgICAgaW5zdGl0dXRpb25fc2hvcnQgPSB0aGlzLl9yZW5kZXJPbmVJbnN0aXR1dGlvblBhcnQocHJpbWFyeVtcInNob3J0XCJdLCBzaG9ydF9zdHlsZSk7XG4gICAgICAgIGluc3RpdHV0aW9uX2xvbmcgPSB0aGlzLl9jb21wb3NlT25lSW5zdGl0dXRpb25QYXJ0KFtuLmwucHJpLCBuLmwuc2VjLCBuLmwudGVyXSwgc2xvdCwgbG9uZ19zdHlsZSwgdik7XG4gICAgICAgIGluc3RpdHV0aW9uID0gW2luc3RpdHV0aW9uX2xvbmcsIGluc3RpdHV0aW9uX3Nob3J0XTtcbiAgICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgICAgbG9uZ19zdHlsZSA9IHRoaXMuX2dldExvbmdTdHlsZShwcmltYXJ5LCB2LCBqKTtcbiAgICAgICAgaW5zdGl0dXRpb24gPSBbdGhpcy5fY29tcG9zZU9uZUluc3RpdHV0aW9uUGFydChbbi5sLnByaSwgbi5sLnNlYywgbi5sLnRlcl0sIHNsb3QsIGxvbmdfc3R5bGUsIHYpXTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIHZhciBibG9iID0gdGhpcy5fam9pbihpbnN0aXR1dGlvbiwgXCIgXCIpO1xuICAgIHRoaXMuc3RhdGUudG1wLm5hbWVfbm9kZS5jaGlsZHJlbi5wdXNoKGJsb2IpO1xuICAgIHJldHVybiBibG9iO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fY29tcG9zZU9uZUluc3RpdHV0aW9uUGFydCA9IGZ1bmN0aW9uIChuYW1lcywgc2xvdCwgc3R5bGUsIHYpIHtcbiAgICB2YXIgcHJpbWFyeSA9IGZhbHNlLCBzZWNvbmRhcnkgPSBmYWxzZSwgdGVydGlhcnkgPSBmYWxzZSwgcHJpbWFyeV90b2ssIHNlY29uZGFyeV90b2ssIHRlcnRpYXJ5X3RvaztcbiAgICBpZiAobmFtZXNbMF0pIHtcbiAgICAgICAgcHJpbWFyeV90b2sgPSBDU0wuVXRpbC5jbG9uZVRva2VuKHN0eWxlKTtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUub3B0LmNpdGVBZmZpeGVzW3Nsb3QucHJpbWFyeV0pe1xuICAgICAgICAgICAgaWYgKFwiPGk+XCIgPT09IHRoaXMuc3RhdGUub3B0LmNpdGVBZmZpeGVzLmluc3RpdHV0aW9uc1tzbG90LnByaW1hcnldLnByZWZpeCkge1xuICAgICAgICAgICAgICAgIHZhciBoYXNJdGFsaWMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHByaW1hcnlfdG9rLmRlY29yYXRpb25zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3R5bGUuZGVjb3JhdGlvbnNbaV1bMF0gPT09IFwiQGZvbnQtc3R5bGVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgcHJpbWFyeV90b2suZGVjb3JhdGlvbnNbaV1bMV0gPT09IFwiaXRhbGljXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhc0l0YWxpYyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFoYXNJdGFsaWMpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeV90b2suZGVjb3JhdGlvbnMucHVzaChbXCJAZm9udC1zdHlsZVwiLCBcIml0YWxpY1wiXSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcHJpbWFyeSA9IHRoaXMuX3JlbmRlck9uZUluc3RpdHV0aW9uUGFydChuYW1lc1swXSwgcHJpbWFyeV90b2spO1xuICAgICB9XG4gICAgaWYgKG5hbWVzWzFdKSB7XG4gICAgICAgIHNlY29uZGFyeSA9IHRoaXMuX3JlbmRlck9uZUluc3RpdHV0aW9uUGFydChuYW1lc1sxXSwgc3R5bGUpO1xuICAgIH1cbiAgICBpZiAobmFtZXNbMl0pIHtcbiAgICAgICAgdGVydGlhcnkgPSB0aGlzLl9yZW5kZXJPbmVJbnN0aXR1dGlvblBhcnQobmFtZXNbMl0sIHN0eWxlKTtcbiAgICB9XG4gICAgdmFyIGluc3RpdHV0aW9uYmxvYjtcbiAgICBpZiAoc2Vjb25kYXJ5IHx8IHRlcnRpYXJ5KSB7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChcImVtcHR5XCIpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQocHJpbWFyeSk7XG4gICAgICAgIHNlY29uZGFyeV90b2sgPSBDU0wuVXRpbC5jbG9uZVRva2VuKHN0eWxlKTtcbiAgICAgICAgaWYgKHNsb3Quc2Vjb25kYXJ5KSB7XG4gICAgICAgICAgICBzZWNvbmRhcnlfdG9rLnN0cmluZ3MucHJlZml4ID0gdGhpcy5zdGF0ZS5vcHQuY2l0ZUFmZml4ZXMuaW5zdGl0dXRpb25zW3Nsb3Quc2Vjb25kYXJ5XS5wcmVmaXg7XG4gICAgICAgICAgICBzZWNvbmRhcnlfdG9rLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5zdGF0ZS5vcHQuY2l0ZUFmZml4ZXMuaW5zdGl0dXRpb25zW3Nsb3Quc2Vjb25kYXJ5XS5zdWZmaXg7XG4gICAgICAgICAgICBpZiAoIXNlY29uZGFyeV90b2suc3RyaW5ncy5wcmVmaXgpIHtcbiAgICAgICAgICAgICAgICBzZWNvbmRhcnlfdG9rLnN0cmluZ3MucHJlZml4ID0gXCIgXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHNlY29uZGFyeV9vdXRlciA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgc2Vjb25kYXJ5X291dGVyLmRlY29yYXRpb25zLnB1c2goW1wiQGZvbnQtc3R5bGVcIiwgXCJub3JtYWxcIl0pO1xuICAgICAgICBzZWNvbmRhcnlfb3V0ZXIuZGVjb3JhdGlvbnMucHVzaChbXCJAZm9udC13ZWlnaHRcIiwgXCJub3JtYWxcIl0pO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5vcGVuTGV2ZWwoc2Vjb25kYXJ5X291dGVyKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHNlY29uZGFyeSwgc2Vjb25kYXJ5X3Rvayk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoKTtcbiAgICAgICAgdGVydGlhcnlfdG9rID0gQ1NMLlV0aWwuY2xvbmVUb2tlbihzdHlsZSk7XG4gICAgICAgIGlmIChzbG90LnRlcnRpYXJ5KSB7XG4gICAgICAgICAgICB0ZXJ0aWFyeV90b2suc3RyaW5ncy5wcmVmaXggPSB0aGlzLnN0YXRlLm9wdC5jaXRlQWZmaXhlcy5pbnN0aXR1dGlvbnNbc2xvdC50ZXJ0aWFyeV0ucHJlZml4O1xuICAgICAgICAgICAgdGVydGlhcnlfdG9rLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5zdGF0ZS5vcHQuY2l0ZUFmZml4ZXMuaW5zdGl0dXRpb25zW3Nsb3QudGVydGlhcnldLnN1ZmZpeDtcbiAgICAgICAgICAgIGlmICghdGVydGlhcnlfdG9rLnN0cmluZ3MucHJlZml4KSB7XG4gICAgICAgICAgICAgICAgdGVydGlhcnlfdG9rLnN0cmluZ3MucHJlZml4ID0gXCIgXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHRlcnRpYXJ5X291dGVyID0gbmV3IENTTC5Ub2tlbigpO1xuICAgICAgICB0ZXJ0aWFyeV9vdXRlci5kZWNvcmF0aW9ucy5wdXNoKFtcIkBmb250LXN0eWxlXCIsIFwibm9ybWFsXCJdKTtcbiAgICAgICAgdGVydGlhcnlfb3V0ZXIuZGVjb3JhdGlvbnMucHVzaChbXCJAZm9udC13ZWlnaHRcIiwgXCJub3JtYWxcIl0pO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5vcGVuTGV2ZWwodGVydGlhcnlfb3V0ZXIpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQodGVydGlhcnksIHRlcnRpYXJ5X3Rvayk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuY2xvc2VMZXZlbCgpO1xuICAgICAgICBpbnN0aXR1dGlvbmJsb2IgPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBpbnN0aXR1dGlvbmJsb2IgPSBwcmltYXJ5O1xuICAgIH1cbiAgICByZXR1cm4gaW5zdGl0dXRpb25ibG9iO1xufVxuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9yZW5kZXJPbmVJbnN0aXR1dGlvblBhcnQgPSBmdW5jdGlvbiAoYmxvYnMsIHN0eWxlKSB7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBibG9icy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKGJsb2JzW2ldKSB7XG4gICAgICAgICAgICB2YXIgc3RyID0gYmxvYnNbaV07XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS50bXAuc3RyaXBfcGVyaW9kcykge1xuICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC9cXC4vZywgXCJcIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gc3R5bGUuZGVjb3JhdGlvbnMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcIkBzdHJpcC1wZXJpb2RzXCIgPT09IHN0eWxlLmRlY29yYXRpb25zW2pdWzBdICYmIFwidHJ1ZVwiID09PSBzdHlsZS5kZWNvcmF0aW9uc1tqXVsxXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoL1xcLi9nLCBcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAudmFyaWFibGVfc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS5yZXBsYWNlKGZhbHNlLCBDU0wuTElURVJBTCk7XG4gICAgICAgICAgICBpZiAoc3RyID09PSBcIiFoZXJlPj4+XCIpIHtcbiAgICAgICAgICAgICAgICBibG9ic1tpXSA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoc3RyLCBzdHlsZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgYmxvYnNbaV0gPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInBhcnQtc2VwYXJhdG9yXCJdKSB7XG4gICAgICAgIHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInBhcnQtc2VwYXJhdG9yXCJdID0gdGhpcy5zdGF0ZS50bXAubmFtZV9kZWxpbWl0ZXI7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9qb2luKGJsb2JzLCB0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3NbXCJwYXJ0LXNlcGFyYXRvclwiXSk7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9yZW5kZXJOYW1lcyA9IGZ1bmN0aW9uICh2LCB2YWx1ZXMsIHBvcywgaikge1xuICAgIHZhciByZXQgPSBmYWxzZTtcbiAgICBpZiAodmFsdWVzLmxlbmd0aCkge1xuICAgICAgICB2YXIgbmFtZXMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB2YWx1ZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICB2YXIgbmFtZSA9IHZhbHVlc1tpXTtcbiAgICAgICAgICAgIHZhciByZXQsIG9wdExhbmdUYWcsIGpsZW4sIGtleSwgbG9jYWxlc2V0cztcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5leHRlbnNpb24pIHtcbiAgICAgICAgICAgICAgICBsb2NhbGVzZXRzID0gW1wic29ydFwiXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZS5pc0luc3RpdHV0aW9uIHx8IG5hbWUubGl0ZXJhbCkge1xuICAgICAgICAgICAgICAgIGxvY2FsZXNldHMgPSB0aGlzLnN0YXRlLm9wdFsnY2l0ZS1sYW5nLXByZWZzJ10uaW5zdGl0dXRpb25zO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2NhbGVzZXRzID0gdGhpcy5zdGF0ZS5vcHRbJ2NpdGUtbGFuZy1wcmVmcyddLnBlcnNvbnM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgc2xvdCA9IHtwcmltYXJ5Oidsb2NhbGUtb3JpZycsc2Vjb25kYXJ5OmZhbHNlLHRlcnRpYXJ5OmZhbHNlfTtcblx0ICAgICAgICBpZiAobG9jYWxlc2V0cykge1xuXHRcdCAgICAgICAgdmFyIHNsb3RuYW1lcyA9IFtcInByaW1hcnlcIiwgXCJzZWNvbmRhcnlcIiwgXCJ0ZXJ0aWFyeVwiXTtcblx0XHQgICAgICAgIGZvciAodmFyIGsgPSAwLCBrbGVuID0gc2xvdG5hbWVzLmxlbmd0aDsgayA8IGtsZW47IGsgKz0gMSkge1xuXHRcdFx0ICAgICAgICBpZiAobG9jYWxlc2V0cy5sZW5ndGggLSAxIDwgIGspIHtcblx0XHRcdFx0ICAgICAgICBicmVhaztcblx0XHRcdCAgICAgICAgfVxuXHRcdFx0ICAgICAgICBzbG90W3Nsb3RuYW1lc1trXV0gPSAnbG9jYWxlLScgKyBsb2NhbGVzZXRzW2tdO1xuXHRcdCAgICAgICAgfVxuXHQgICAgICAgIH0gZWxzZSB7XG5cdFx0ICAgICAgICBzbG90LnByaW1hcnkgPSAnbG9jYWxlLXRyYW5zbGF0Jztcblx0ICAgICAgICB9XG5cdCAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLnNvcnRfa2V5X2ZsYWcgfHwgKHRoaXMuc3RhdGUudG1wLmFyZWEgIT09IFwiYmlibGlvZ3JhcGh5XCJcblx0XHQgICAgICAgICYmICEodGhpcy5zdGF0ZS50bXAuYXJlYSA9PT0gXCJjaXRhdGlvblwiXG5cdFx0XHQgICAgICAgICAmJiB0aGlzLnN0YXRlLm9wdC54Y2xhc3MgPT09IFwibm90ZVwiXG5cdFx0XHQgICAgICAgICAmJiB0aGlzLml0ZW0gJiYgIXRoaXMuaXRlbS5wb3NpdGlvbikpKSB7XG5cdFx0ICAgICAgICBzbG90LnNlY29uZGFyeSA9IGZhbHNlO1xuXHRcdCAgICAgICAgc2xvdC50ZXJ0aWFyeSA9IGZhbHNlO1xuXHQgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0UmVuZGVyZWROYW1lKG5hbWUpO1xuICAgICAgICAgICAgaWYgKCFuYW1lLmxpdGVyYWwgJiYgIW5hbWUuaXNJbnN0aXR1dGlvbikge1xuICAgICAgICAgICAgICAgIHZhciBuYW1lQmxvYiA9IHRoaXMuX3JlbmRlclBlcnNvbmFsTmFtZSh2LCBuYW1lLCBzbG90LCBwb3MsIGksIGopO1xuICAgICAgICAgICAgICAgIHZhciBuYW1lVG9rZW4gPSBDU0wuVXRpbC5jbG9uZVRva2VuKHRoaXMubmFtZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKG5hbWVCbG9iLCBuYW1lVG9rZW4sIHRydWUpO1xuICAgICAgICAgICAgICAgIG5hbWVzLnB1c2godGhpcy5zdGF0ZS5vdXRwdXQucG9wKCkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuYW1lcy5wdXNoKHRoaXMuX3JlbmRlckluc3RpdHV0aW9uTmFtZSh2LCBuYW1lLCBzbG90LCBqKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0ID0gdGhpcy5qb2luUGVyc29ucyhuYW1lcywgcG9zLCBqKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldFxufVxuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9yZW5kZXJQZXJzb25hbE5hbWUgPSBmdW5jdGlvbiAodiwgbmFtZSwgc2xvdCwgcG9zLCBpLCBqKSB7XG4gICAgdmFyIHJlcyA9IHRoaXMuZ2V0TmFtZShuYW1lLCBzbG90LnByaW1hcnksIHRydWUpO1xuICAgIHZhciBwcmltYXJ5ID0gdGhpcy5fcmVuZGVyT25lUGVyc29uYWxOYW1lKHJlcy5uYW1lLCBwb3MsIGksIGopO1xuXHR2YXIgc2Vjb25kYXJ5ID0gZmFsc2U7XG5cdGlmIChzbG90LnNlY29uZGFyeSkge1xuICAgICAgICByZXMgPSB0aGlzLmdldE5hbWUobmFtZSwgc2xvdC5zZWNvbmRhcnksIGZhbHNlLCByZXMudXNlZE9yaWcpO1xuICAgICAgICBpZiAocmVzLm5hbWUpIHtcblx0XHRcdHNlY29uZGFyeSA9IHRoaXMuX3JlbmRlck9uZVBlcnNvbmFsTmFtZShyZXMubmFtZSwgcG9zLCBpLCBqKTtcbiAgICAgICAgfVxuXHR9XG5cdHZhciB0ZXJ0aWFyeSA9IGZhbHNlO1xuXHRpZiAoc2xvdC50ZXJ0aWFyeSkge1xuICAgICAgICByZXMgPSB0aGlzLmdldE5hbWUobmFtZSwgc2xvdC50ZXJ0aWFyeSwgZmFsc2UsIHJlcy51c2VkT3JpZyk7XG4gICAgICAgIGlmIChyZXMubmFtZSkge1xuXHRcdFx0dGVydGlhcnkgPSB0aGlzLl9yZW5kZXJPbmVQZXJzb25hbE5hbWUocmVzLm5hbWUsIHBvcywgaSwgaik7XG4gICAgICAgIH1cblx0fVxuICAgIHZhciBwZXJzb25ibG9iO1xuICAgIGlmIChzZWNvbmRhcnkgfHwgdGVydGlhcnkpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQub3BlbkxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChwcmltYXJ5KTtcbiAgICAgICAgdmFyIHNlY29uZGFyeV90b2sgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgIGlmIChzbG90LnNlY29uZGFyeSkge1xuICAgICAgICAgICAgc2Vjb25kYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCA9IHRoaXMuc3RhdGUub3B0LmNpdGVBZmZpeGVzLnBlcnNvbnNbc2xvdC5zZWNvbmRhcnldLnByZWZpeDtcbiAgICAgICAgICAgIHNlY29uZGFyeV90b2suc3RyaW5ncy5zdWZmaXggPSB0aGlzLnN0YXRlLm9wdC5jaXRlQWZmaXhlcy5wZXJzb25zW3Nsb3Quc2Vjb25kYXJ5XS5zdWZmaXg7XG4gICAgICAgICAgICBpZiAoIXNlY29uZGFyeV90b2suc3RyaW5ncy5wcmVmaXgpIHtcbiAgICAgICAgICAgICAgICBzZWNvbmRhcnlfdG9rLnN0cmluZ3MucHJlZml4ID0gXCIgXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHNlY29uZGFyeSwgc2Vjb25kYXJ5X3Rvayk7XG4gICAgICAgIHZhciB0ZXJ0aWFyeV90b2sgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgIGlmIChzbG90LnRlcnRpYXJ5KSB7XG4gICAgICAgICAgICB0ZXJ0aWFyeV90b2suc3RyaW5ncy5wcmVmaXggPSB0aGlzLnN0YXRlLm9wdC5jaXRlQWZmaXhlcy5wZXJzb25zW3Nsb3QudGVydGlhcnldLnByZWZpeDtcbiAgICAgICAgICAgIHRlcnRpYXJ5X3Rvay5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuc3RhdGUub3B0LmNpdGVBZmZpeGVzLnBlcnNvbnNbc2xvdC50ZXJ0aWFyeV0uc3VmZml4O1xuICAgICAgICAgICAgaWYgKCF0ZXJ0aWFyeV90b2suc3RyaW5ncy5wcmVmaXgpIHtcbiAgICAgICAgICAgICAgICB0ZXJ0aWFyeV90b2suc3RyaW5ncy5wcmVmaXggPSBcIiBcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQodGVydGlhcnksIHRlcnRpYXJ5X3Rvayk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoKTtcbiAgICAgICAgcGVyc29uYmxvYiA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHBlcnNvbmJsb2IgPSBwcmltYXJ5O1xuICAgIH1cbiAgICByZXR1cm4gcGVyc29uYmxvYjtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2lzUm9tYW5lc3F1ZSA9IGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgdmFyIHJldCA9IDI7XG4gICAgaWYgKCFuYW1lLmZhbWlseS5yZXBsYWNlKC9cXFwiL2csICcnKS5tYXRjaChDU0wuUk9NQU5FU1FVRV9SRUdFWFApKSB7XG4gICAgICAgIHJldCA9IDA7XG4gICAgfVxuICAgIGlmICghcmV0ICYmIG5hbWUuZ2l2ZW4gJiYgbmFtZS5naXZlbi5tYXRjaChDU0wuU1RBUlRTV0lUSF9ST01BTkVTUVVFX1JFR0VYUCkpIHtcbiAgICAgICAgcmV0ID0gMTtcbiAgICB9XG4gICAgaWYgKHJldCA9PSAyKSB7XG4gICAgICAgIGlmIChuYW1lLm11bHRpICYmIG5hbWUubXVsdGkubWFpbikge1xuICAgICAgICAgICAgdmFyIHRvcF9sb2NhbGUgPSBuYW1lLm11bHRpLm1haW4uc2xpY2UoMCwgMik7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5JdGVtLmxhbmd1YWdlKSB7XG4gICAgICAgICAgICB0b3BfbG9jYWxlID0gdGhpcy5JdGVtLmxhbmd1YWdlLnNsaWNlKDAsIDIpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChbXCJqYVwiLCBcInpoXCJdLmluZGV4T2YodG9wX2xvY2FsZSkgPiAtMSkge1xuICAgICAgICAgICAgcmV0ID0gMTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fcmVuZGVyT25lUGVyc29uYWxOYW1lID0gZnVuY3Rpb24gKHZhbHVlLCBwb3MsIGksIGopIHtcbiAgICB2YXIgbmFtZSA9IHZhbHVlO1xuICAgIHZhciBkcm9wcGluZ19wYXJ0aWNsZSA9IHRoaXMuX2Ryb3BwaW5nUGFydGljbGUobmFtZSwgcG9zLCBqKTtcbiAgICB2YXIgZmFtaWx5ID0gdGhpcy5fZmFtaWx5TmFtZShuYW1lKTtcbiAgICB2YXIgbm9uX2Ryb3BwaW5nX3BhcnRpY2xlID0gdGhpcy5fbm9uRHJvcHBpbmdQYXJ0aWNsZShuYW1lKTtcbiAgICB2YXIgZ2l2ZW4gPSB0aGlzLl9naXZlbk5hbWUobmFtZSwgcG9zLCBpKTtcbiAgICB2YXIgc3VmZml4ID0gdGhpcy5fbmFtZVN1ZmZpeChuYW1lKTtcbiAgICBpZiAoZ2l2ZW4gPT09IGZhbHNlKSB7XG4gICAgICAgIGRyb3BwaW5nX3BhcnRpY2xlID0gZmFsc2U7XG4gICAgICAgIHN1ZmZpeCA9IGZhbHNlO1xuICAgIH1cbiAgICB2YXIgc29ydF9zZXAgPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcInNvcnQtc2VwYXJhdG9yXCIpO1xuICAgIGlmICghc29ydF9zZXApIHtcbiAgICAgICAgc29ydF9zZXAgPSBcIlwiO1xuICAgIH1cbiAgICB2YXIgc3VmZml4X3NlcDtcbiAgICBpZiAobmFtZVtcImNvbW1hLXN1ZmZpeFwiXSkge1xuICAgICAgICBzdWZmaXhfc2VwID0gXCIsIFwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHN1ZmZpeF9zZXAgPSBcIiBcIjtcbiAgICB9XG4gICAgdmFyIHJvbWFuZXNxdWUgPSB0aGlzLl9pc1JvbWFuZXNxdWUobmFtZSk7XG4gICAgZnVuY3Rpb24gaGFzSm9pbmluZ1B1bmN0dWF0aW9uKGJsb2IpIHtcbiAgICAgICAgaWYgKCFibG9iKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2IuYmxvYnMpIHtcbiAgICAgICAgICAgIGlmIChbXCJcXHUyMDE5XCIsIFwiXFwnXCIsIFwiLVwiLCBcIiBcIl0uaW5kZXhPZihibG9iLmJsb2JzLnNsaWNlKC0xKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gaGFzSm9pbmluZ1B1bmN0dWF0aW9uKGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHZhciBoYXNfaHlwaGVuYXRlZF9ub25fZHJvcHBpbmdfcGFydGljbGUgPSBoYXNKb2luaW5nUHVuY3R1YXRpb24obm9uX2Ryb3BwaW5nX3BhcnRpY2xlKTtcbiAgICB2YXIgYmxvYiwgbWVyZ2VkLCBmaXJzdCwgc2Vjb25kO1xuICAgIGlmIChyb21hbmVzcXVlID09PSAwKSB7XG4gICAgICAgIGJsb2IgPSB0aGlzLl9qb2luKFtub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseSwgZ2l2ZW5dLCBcIlwiKTtcbiAgICB9IGVsc2UgaWYgKHJvbWFuZXNxdWUgPT09IDEgfHwgbmFtZVtcInN0YXRpYy1vcmRlcmluZ1wiXSkgeyAvLyBlbnRyeSBsaWtlcyBzb3J0IG9yZGVyXG4gICAgICAgIGJsb2IgPSB0aGlzLl9qb2luKFtub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseSwgZ2l2ZW5dLCBcIiBcIik7XG4gICAgfSBlbHNlIGlmIChuYW1lW1wicmV2ZXJzZS1vcmRlcmluZ1wiXSkgeyAvLyBlbnRyeSBsaWtlcyByZXZlcnNlIG9yZGVyXG4gICAgICAgIGJsb2IgPSB0aGlzLl9qb2luKFtnaXZlbiwgbm9uX2Ryb3BwaW5nX3BhcnRpY2xlLCBmYW1pbHldLCBcIiBcIik7XG4gICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlLnRtcC5zb3J0X2tleV9mbGFnKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLm9wdFtcImRlbW90ZS1ub24tZHJvcHBpbmctcGFydGljbGVcIl0gPT09IFwibmV2ZXJcIikge1xuICAgICAgICAgICAgZmlyc3QgPSB0aGlzLl9qb2luKFtub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseSwgZHJvcHBpbmdfcGFydGljbGVdLCBcIiBcIik7XG4gICAgICAgICAgICBtZXJnZWQgPSB0aGlzLl9qb2luKFtmaXJzdCwgZ2l2ZW5dLCB0aGlzLnN0YXRlLm9wdC5zb3J0X3NlcCk7XG4gICAgICAgICAgICBibG9iID0gdGhpcy5fam9pbihbbWVyZ2VkLCBzdWZmaXhdLCBcIiBcIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZWNvbmQgPSB0aGlzLl9qb2luKFtnaXZlbiwgZHJvcHBpbmdfcGFydGljbGUsIG5vbl9kcm9wcGluZ19wYXJ0aWNsZV0sIFwiIFwiKTtcbiAgICAgICAgICAgIG1lcmdlZCA9IHRoaXMuX2pvaW4oW2ZhbWlseSwgc2Vjb25kXSwgdGhpcy5zdGF0ZS5vcHQuc29ydF9zZXApO1xuICAgICAgICAgICAgYmxvYiA9IHRoaXMuX2pvaW4oW21lcmdlZCwgc3VmZml4XSwgXCIgXCIpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcIm5hbWUtYXMtc29ydC1vcmRlclwiKSA9PT0gXCJhbGxcIiB8fCAodGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJuYW1lLWFzLXNvcnQtb3JkZXJcIikgPT09IFwiZmlyc3RcIiAmJiBpID09PSAwICYmIChqID09PSAwIHx8IFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBqKSkpIHtcbiAgICAgICAgaWYgKFtcIkxvcmRcIiwgXCJMYWR5XCJdLmluZGV4T2YobmFtZS5naXZlbikgPiAtMSkge1xuICAgICAgICAgICAgc29ydF9zZXAgPSBcIiwgXCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFtcImFsd2F5c1wiLCBcImRpc3BsYXktYW5kLXNvcnRcIl0uaW5kZXhPZih0aGlzLnN0YXRlLm9wdFtcImRlbW90ZS1ub24tZHJvcHBpbmctcGFydGljbGVcIl0pID4gLTEpIHtcbiAgICAgICAgICAgIHNlY29uZCA9IHRoaXMuX2pvaW4oW2dpdmVuLCBkcm9wcGluZ19wYXJ0aWNsZV0sIChuYW1lW1wiY29tbWEtZHJvcHBpbmctcGFydGljbGVcIl0gKyBcIiBcIikpO1xuICAgICAgICAgICAgc2Vjb25kID0gdGhpcy5fam9pbihbc2Vjb25kLCBub25fZHJvcHBpbmdfcGFydGljbGVdLCBcIiBcIik7XG4gICAgICAgICAgICBpZiAoc2Vjb25kICYmIHRoaXMuZ2l2ZW4pIHtcbiAgICAgICAgICAgICAgICBzZWNvbmQuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmdpdmVuLnN0cmluZ3MucHJlZml4O1xuICAgICAgICAgICAgICAgIHNlY29uZC5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuZ2l2ZW4uc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZmFtaWx5ICYmIHRoaXMuZmFtaWx5KSB7XG4gICAgICAgICAgICAgICAgZmFtaWx5LnN0cmluZ3MucHJlZml4ID0gdGhpcy5mYW1pbHkuc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgICAgICAgICAgZmFtaWx5LnN0cmluZ3Muc3VmZml4ID0gdGhpcy5mYW1pbHkuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtZXJnZWQgPSB0aGlzLl9qb2luKFtmYW1pbHksIHNlY29uZF0sIHNvcnRfc2VwKTtcbiAgICAgICAgICAgIGJsb2IgPSB0aGlzLl9qb2luKFttZXJnZWQsIHN1ZmZpeF0sIHNvcnRfc2VwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChoYXNfaHlwaGVuYXRlZF9ub25fZHJvcHBpbmdfcGFydGljbGUpIHtcbiAgICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMuX2pvaW4oW25vbl9kcm9wcGluZ19wYXJ0aWNsZSwgZmFtaWx5XSwgXCJcIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy5fam9pbihbbm9uX2Ryb3BwaW5nX3BhcnRpY2xlLCBmYW1pbHldLCBcIiBcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZmlyc3QgJiYgdGhpcy5mYW1pbHkpIHtcbiAgICAgICAgICAgICAgICBmaXJzdC5zdHJpbmdzLnByZWZpeCA9IHRoaXMuZmFtaWx5LnN0cmluZ3MucHJlZml4O1xuICAgICAgICAgICAgICAgIGZpcnN0LnN0cmluZ3Muc3VmZml4ID0gdGhpcy5mYW1pbHkuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZWNvbmQgPSB0aGlzLl9qb2luKFtnaXZlbiwgZHJvcHBpbmdfcGFydGljbGVdLCAobmFtZVtcImNvbW1hLWRyb3BwaW5nLXBhcnRpY2xlXCJdICsgXCIgXCIpKTtcbiAgICAgICAgICAgIGlmIChzZWNvbmQgJiYgdGhpcy5naXZlbikge1xuICAgICAgICAgICAgICAgIHNlY29uZC5zdHJpbmdzLnByZWZpeCA9IHRoaXMuZ2l2ZW4uc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgICAgICAgICAgc2Vjb25kLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5naXZlbi5zdHJpbmdzLnN1ZmZpeDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1lcmdlZCA9IHRoaXMuX2pvaW4oW2ZpcnN0LCBzZWNvbmRdLCBzb3J0X3NlcCk7XG4gICAgICAgICAgICBibG9iID0gdGhpcy5fam9pbihbbWVyZ2VkLCBzdWZmaXhdLCBzb3J0X3NlcCk7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgeyAvLyBwbGFpbiB2YW5pbGxhXG4gICAgICAgIGlmIChuYW1lW1wiZHJvcHBpbmctcGFydGljbGVcIl0gJiYgbmFtZS5mYW1pbHkgJiYgIW5hbWVbXCJub24tZHJvcHBpbmctcGFydGljbGVcIl0pIHtcbiAgICAgICAgICAgIGlmIChbXCInXCIsXCJcXHUwMmJjXCIsXCJcXHUyMDE5XCIsXCItXCJdLmluZGV4T2YobmFtZVtcImRyb3BwaW5nLXBhcnRpY2xlXCJdLnNsaWNlKC0xKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIGZhbWlseSA9IHRoaXMuX2pvaW4oW2Ryb3BwaW5nX3BhcnRpY2xlLCBmYW1pbHldLCBcIlwiKTtcbiAgICAgICAgICAgICAgICBkcm9wcGluZ19wYXJ0aWNsZSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3Nvcikge1xuICAgICAgICB9XG4gICAgICAgIHZhciBzcGFjZSA9IFwiIFwiO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJpbml0aWFsaXplLXdpdGhcIilcbiAgICAgICAgICAgICYmIHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiaW5pdGlhbGl6ZS13aXRoXCIpLm1hdGNoKC9bXFx1MDBhMFxcdWZlZmZdLylcbiAgICAgICAgICAgICYmIFtcImZyXCIsIFwicnVcIiwgXCJjc1wiXS5pbmRleE9mKHRoaXMuc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0uc2xpY2UoMCwgMikpID4gLTEpIHtcbiAgICAgICAgICAgIHNwYWNlID0gXCJcXHUwMGEwXCJcbiAgICAgICAgfVxuICAgICAgICBpZiAoaGFzX2h5cGhlbmF0ZWRfbm9uX2Ryb3BwaW5nX3BhcnRpY2xlKSB7XG4gICAgICAgICAgICBzZWNvbmQgPSB0aGlzLl9qb2luKFtub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseV0sIFwiXCIpO1xuICAgICAgICAgICAgc2Vjb25kID0gdGhpcy5fam9pbihbZHJvcHBpbmdfcGFydGljbGUsIHNlY29uZF0sIHNwYWNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNlY29uZCA9IHRoaXMuX2pvaW4oW2Ryb3BwaW5nX3BhcnRpY2xlLCBub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseV0sIHNwYWNlKTtcbiAgICAgICAgfVxuICAgICAgICBzZWNvbmQgPSB0aGlzLl9qb2luKFtzZWNvbmQsIHN1ZmZpeF0sIHN1ZmZpeF9zZXApO1xuICAgICAgICBpZiAoc2Vjb25kICYmIHRoaXMuZmFtaWx5KSB7XG4gICAgICAgICAgICBzZWNvbmQuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmZhbWlseS5zdHJpbmdzLnByZWZpeDtcbiAgICAgICAgICAgIHNlY29uZC5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuZmFtaWx5LnN0cmluZ3Muc3VmZml4O1xuICAgICAgICB9XG4gICAgICAgIGlmIChnaXZlbiAmJiB0aGlzLmdpdmVuKSB7XG4gICAgICAgICAgICBnaXZlbi5zdHJpbmdzLnByZWZpeCA9IHRoaXMuZ2l2ZW4uc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgICAgICBnaXZlbi5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuZ2l2ZW4uc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNlY29uZC5zdHJpbmdzLnByZWZpeCkge1xuICAgICAgICAgICAgbmFtZVtcImNvbW1hLWRyb3BwaW5nLXBhcnRpY2xlXCJdID0gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICBibG9iID0gdGhpcy5fam9pbihbZ2l2ZW4sIHNlY29uZF0sIChuYW1lW1wiY29tbWEtZHJvcHBpbmctcGFydGljbGVcIl0gKyBzcGFjZSkpO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9zdWNjZXNzID0gdHJ1ZTtcbiAgICB0aGlzLnN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS5yZXBsYWNlKGZhbHNlLCBDU0wuTElURVJBTCk7XG4gICAgdGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3NvciA9IHRydWU7XG4gICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLmNoaWxkcmVuLnB1c2goYmxvYik7XG4gICAgcmV0dXJuIGJsb2I7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9ub3JtYWxpemVOYW1lSW5wdXQgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICB2YXIgbmFtZSA9IHtcbiAgICAgICAgbGl0ZXJhbDp2YWx1ZS5saXRlcmFsLFxuICAgICAgICBmYW1pbHk6dmFsdWUuZmFtaWx5LFxuICAgICAgICBpc0luc3RpdHV0aW9uOnZhbHVlLmlzSW5zdGl0dXRpb24sXG4gICAgICAgIGdpdmVuOnZhbHVlLmdpdmVuLFxuICAgICAgICBzdWZmaXg6dmFsdWUuc3VmZml4LFxuICAgICAgICBcImNvbW1hLXN1ZmZpeFwiOnZhbHVlW1wiY29tbWEtc3VmZml4XCJdLFxuICAgICAgICBcIm5vbi1kcm9wcGluZy1wYXJ0aWNsZVwiOnZhbHVlW1wibm9uLWRyb3BwaW5nLXBhcnRpY2xlXCJdLFxuICAgICAgICBcImRyb3BwaW5nLXBhcnRpY2xlXCI6dmFsdWVbXCJkcm9wcGluZy1wYXJ0aWNsZVwiXSxcbiAgICAgICAgXCJzdGF0aWMtb3JkZXJpbmdcIjp2YWx1ZVtcInN0YXRpYy1vcmRlcmluZ1wiXSxcbiAgICAgICAgXCJzdGF0aWMtcGFydGljbGVzXCI6dmFsdWVbXCJzdGF0aWMtcGFydGljbGVzXCJdLFxuICAgICAgICBcInJldmVyc2Utb3JkZXJpbmdcIjp2YWx1ZVtcInJldmVyc2Utb3JkZXJpbmdcIl0sXG4gICAgICAgIFwiZnVsbC1mb3JtLWFsd2F5c1wiOiB2YWx1ZVtcImZ1bGwtZm9ybS1hbHdheXNcIl0sXG4gICAgICAgIFwicGFyc2UtbmFtZXNcIjp2YWx1ZVtcInBhcnNlLW5hbWVzXCJdLFxuICAgICAgICBcImNvbW1hLWRyb3BwaW5nLXBhcnRpY2xlXCI6IFwiXCIsXG4gICAgICAgIGJsb2NrX2luaXRpYWxpemU6dmFsdWUuYmxvY2tfaW5pdGlhbGl6ZSxcbiAgICAgICAgbXVsdGk6dmFsdWUubXVsdGlcbiAgICB9O1xuICAgIHRoaXMuX3BhcnNlTmFtZShuYW1lKTtcbiAgICByZXR1cm4gbmFtZTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX3N0cmlwUGVyaW9kcyA9IGZ1bmN0aW9uICh0b2tuYW1lLCBzdHIpIHtcbiAgICB2YXIgZGVjb3JfdG9rID0gdGhpc1t0b2tuYW1lICsgXCJfZGVjb3JcIl07XG4gICAgaWYgKHN0cikge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS50bXAuc3RyaXBfcGVyaW9kcykge1xuICAgICAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoL1xcLi9nLCBcIlwiKTtcbiAgICAgICAgfSBlbHNlICBpZiAoZGVjb3JfdG9rKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGRlY29yX3Rvay5kZWNvcmF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoXCJAc3RyaXAtcGVyaW9kc1wiID09PSBkZWNvcl90b2suZGVjb3JhdGlvbnNbaV1bMF0gJiYgXCJ0cnVlXCIgPT09IGRlY29yX3Rvay5kZWNvcmF0aW9uc1tpXVsxXSkge1xuICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHN0cjtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX25vbkRyb3BwaW5nUGFydGljbGUgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIHZhciBuZHAgPSBuYW1lW1wibm9uLWRyb3BwaW5nLXBhcnRpY2xlXCJdO1xuICAgIGlmIChuZHAgJiYgdGhpcy5zdGF0ZS50bXAuc29ydF9rZXlfZmxhZykge1xuICAgICAgICBuZHAgPSBuZHAucmVwbGFjZSgvW1xcJ1xcdTIwMTldLywgXCJcIik7XG4gICAgfVxuICAgIHZhciBzdHIgPSB0aGlzLl9zdHJpcFBlcmlvZHMoXCJmYW1pbHlcIiwgbmRwKTtcbiAgICBpZiAodGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHN0ciwgdGhpcy5mYW1pbHlfZGVjb3IsIHRydWUpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fZHJvcHBpbmdQYXJ0aWNsZSA9IGZ1bmN0aW9uIChuYW1lLCBwb3MsIGopIHtcbiAgICB2YXIgZHAgPSBuYW1lW1wiZHJvcHBpbmctcGFydGljbGVcIl07XG4gICAgaWYgKGRwICYmIHRoaXMuc3RhdGUudG1wLnNvcnRfa2V5X2ZsYWcpIHtcbiAgICAgICAgZHAgPSBkcC5yZXBsYWNlKC9bXFwnXFx1MjAxOV0vLCBcIlwiKTtcbiAgICB9XG4gICAgdmFyIHN0ciA9IHRoaXMuX3N0cmlwUGVyaW9kcyhcImdpdmVuXCIsIGRwKTtcbiAgICBpZiAobmFtZVtcImRyb3BwaW5nLXBhcnRpY2xlXCJdICYmIG5hbWVbXCJkcm9wcGluZy1wYXJ0aWNsZVwiXS5tYXRjaCgvXmV0Lj9hbFteYS16XSQvKSkge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJldC1hbC11c2UtbGFzdFwiKSkge1xuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBqKSB7IFxuICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9zcGVjW3Bvc10uZnJlZXRlcnMgPSAyO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1twb3NdLnBlcnNvbnMgPSAyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBqKSB7IFxuICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9zcGVjW3Bvc10uZnJlZXRlcnMgPSAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1twb3NdLnBlcnNvbnMgPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG5hbWVbXCJjb21tYS1kcm9wcGluZy1wYXJ0aWNsZVwiXSA9IFwiXCI7XG4gICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoc3RyLCB0aGlzLmdpdmVuX2RlY29yLCB0cnVlKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2ZhbWlseU5hbWUgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIHZhciBzdHIgPSB0aGlzLl9zdHJpcFBlcmlvZHMoXCJmYW1pbHlcIiwgbmFtZS5mYW1pbHkpO1xuICAgIGlmICh0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoc3RyLCB0aGlzLmZhbWlseV9kZWNvciwgdHJ1ZSkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9naXZlbk5hbWUgPSBmdW5jdGlvbiAobmFtZSwgcG9zLCBpKSB7XG4gICAgdmFyIHJldDtcbiAgICB2YXIgZm9ybUlzU2hvcnQgPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImZvcm1cIiwgXCJuYW1lLWZvcm1cIiwgXCJsb25nXCIpICE9PSBcImxvbmdcIjtcbiAgICB2YXIgaW5pdGlhbGl6ZUlzVHVybmVkT24gPSAhKHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiaW5pdGlhbGl6ZVwiKSA9PT0gZmFsc2UpO1xuICAgIHZhciBoYXNJbml0aWFsaXplV2l0aCA9IFwic3RyaW5nXCIgPT09IHR5cGVvZiB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImluaXRpYWxpemUtd2l0aFwiKSAmJiAhbmFtZS5ibG9ja19pbml0aWFsaXplO1xuICAgIHZhciBpbkJpYmxpb2dyYXBoeSA9IHRoaXMuc3RhdGUudG1wLmFyZWEuc2xpY2UoMCwgMTIpID09PSBcImJpYmxpb2dyYXBoeVwiO1xuICAgIHZhciBkZWZhdWx0TGV2ZWw7XG4gICAgdmFyIHVzZUxldmVsO1xuICAgIGlmIChuYW1lW1wiZnVsbC1mb3JtLWFsd2F5c1wiXSkge1xuICAgICAgICB1c2VMZXZlbCA9IDI7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGZvcm1Jc1Nob3J0KSB7XG4gICAgICAgICAgICBkZWZhdWx0TGV2ZWwgPSAwO1xuICAgICAgICB9IGVsc2UgaWYgKGhhc0luaXRpYWxpemVXaXRoKSB7XG4gICAgICAgICAgICBkZWZhdWx0TGV2ZWwgPSAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVmYXVsdExldmVsID0gMjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcmVxdWVzdGVkTGV2ZWwgPSB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbcG9zXVtpXTtcbiAgICAgICAgaWYgKHJlcXVlc3RlZExldmVsID4gZGVmYXVsdExldmVsKSB7XG4gICAgICAgICAgICB1c2VMZXZlbCA9IHJlcXVlc3RlZExldmVsO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXNlTGV2ZWwgPSBkZWZhdWx0TGV2ZWw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIGdkcm9wdCA9IHRoaXMuc3RhdGUuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl07XG4gICBpZiAoZ2Ryb3B0ICYmIGdkcm9wdC5zbGljZSgtMTQpID09PSBcIi13aXRoLWluaXRpYWxzXCIpIHtcbiAgICAgICAgaGFzSW5pdGlhbGl6ZVdpdGggPSB0cnVlO1xuICAgIH1cbiAgICBpZiAobmFtZS5mYW1pbHkgJiYgdXNlTGV2ZWwgPT09IDEpIHtcbiAgICAgICAgaWYgKGhhc0luaXRpYWxpemVXaXRoKSB7XG4gICAgICAgICAgICB2YXIgaW5pdGlhbGl6ZV93aXRoID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJpbml0aWFsaXplLXdpdGhcIiwgZmFsc2UsIFwiXCIpO1xuICAgICAgICAgICAgbmFtZS5naXZlbiA9IENTTC5VdGlsLk5hbWVzLmluaXRpYWxpemVXaXRoKHRoaXMuc3RhdGUsIG5hbWUuZ2l2ZW4sIGluaXRpYWxpemVfd2l0aCwgIWluaXRpYWxpemVJc1R1cm5lZE9uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5hbWUuZ2l2ZW4gPSBDU0wuVXRpbC5OYW1lcy51bkluaXRpYWxpemUodGhpcy5zdGF0ZSwgbmFtZS5naXZlbik7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHVzZUxldmVsID09PSAwKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2UgaWYgKHVzZUxldmVsID09PSAyKSB7XG4gICAgICAgIG5hbWUuZ2l2ZW4gPSBDU0wuVXRpbC5OYW1lcy51bkluaXRpYWxpemUodGhpcy5zdGF0ZSwgbmFtZS5naXZlbik7XG4gICAgfVxuICAgIHZhciBzdHIgPSB0aGlzLl9zdHJpcFBlcmlvZHMoXCJnaXZlblwiLCBuYW1lLmdpdmVuKTtcbiAgICB2YXIgcmVuZGVyZWQgPSB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoc3RyLCB0aGlzLmdpdmVuX2RlY29yLCB0cnVlKTtcbiAgICBpZiAocmVuZGVyZWQpIHtcbiAgICAgICAgcmV0ID0gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG5cdCAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9uYW1lU3VmZml4ID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICB2YXIgc3RyID0gbmFtZS5zdWZmaXgsIHJldDtcbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiaW5pdGlhbGl6ZS13aXRoXCIpKSB7XG4gICAgICAgIHN0ciA9IENTTC5VdGlsLk5hbWVzLmluaXRpYWxpemVXaXRoKHRoaXMuc3RhdGUsIG5hbWUuc3VmZml4LCB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImluaXRpYWxpemUtd2l0aFwiKSwgdHJ1ZSk7XG4gICAgfVxuICAgIHN0ciA9IHRoaXMuX3N0cmlwUGVyaW9kcyhcImZhbWlseVwiLCBzdHIpO1xuICAgIHZhciB0b1N1ZmZpeCA9ICcnO1xuICAgIGlmIChzdHIgJiYgc3RyLnNsaWNlKC0xKSA9PT0gJy4nKSB7XG5cdHN0ciA9IHN0ci5zbGljZSgwLCAtMSk7XG5cdHRvU3VmZml4ID0gJy4nO1xuICAgIH1cbiAgICB2YXIgcmVuZGVyZWQgPSB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoc3RyLCBcImVtcHR5XCIsIHRydWUpO1xuICAgIGlmIChyZW5kZXJlZCkge1xuICAgICAgICByZXQgPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcblx0cmV0LnN0cmluZ3Muc3VmZml4ID0gdG9TdWZmaXggKyByZXQuc3RyaW5ncy5zdWZmaXg7XG5cdHJldHVybiByZXQ7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2dldExvbmdTdHlsZSA9IGZ1bmN0aW9uIChuYW1lLCB2LCBpKSB7XG4gICAgdmFyIGxvbmdfc3R5bGUsIHNob3J0X3N0eWxlO1xuICAgIGlmIChuYW1lW1wic2hvcnRcIl0ubGVuZ3RoKSB7XG4gICAgICAgIGlmICh0aGlzLmluc3RpdHV0aW9ucGFydFtcImxvbmctd2l0aC1zaG9ydFwiXSkge1xuICAgICAgICAgICAgbG9uZ19zdHlsZSA9IHRoaXMuaW5zdGl0dXRpb25wYXJ0W1wibG9uZy13aXRoLXNob3J0XCJdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9uZ19zdHlsZSA9IHRoaXMuaW5zdGl0dXRpb25wYXJ0W1wibG9uZ1wiXTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGxvbmdfc3R5bGUgPSB0aGlzLmluc3RpdHV0aW9ucGFydFtcImxvbmdcIl07XG4gICAgfVxuICAgIGlmICghbG9uZ19zdHlsZSkge1xuICAgICAgICBsb25nX3N0eWxlID0gbmV3IENTTC5Ub2tlbigpO1xuICAgIH1cbiAgICByZXR1cm4gbG9uZ19zdHlsZTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2dldFNob3J0U3R5bGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHNob3J0X3N0eWxlO1xuICAgIGlmICh0aGlzLmluc3RpdHV0aW9ucGFydFtcInNob3J0XCJdKSB7XG4gICAgICAgIHNob3J0X3N0eWxlID0gdGhpcy5pbnN0aXR1dGlvbnBhcnRbXCJzaG9ydFwiXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzaG9ydF9zdHlsZSA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICB9XG4gICAgcmV0dXJuIHNob3J0X3N0eWxlO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fcGFyc2VOYW1lID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICB2YXIgbSwgaWR4O1xuICAgIGlmICghbmFtZVtcInBhcnNlLW5hbWVzXCJdICYmIFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiBuYW1lW1wicGFyc2UtbmFtZXNcIl0pIHtcbiAgICAgICAgcmV0dXJuIG5hbWU7XG4gICAgfVxuICAgIGlmIChuYW1lLmZhbWlseSAmJiAhbmFtZS5naXZlbiAmJiBuYW1lLmlzSW5zdGl0dXRpb24pIHtcbiAgICAgICAgbmFtZS5saXRlcmFsID0gbmFtZS5mYW1pbHk7XG4gICAgICAgIG5hbWUuZmFtaWx5ID0gdW5kZWZpbmVkO1xuICAgICAgICBuYW1lLmlzSW5zdGl0dXRpb24gPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHZhciBub3BhcnNlO1xuICAgIGlmIChuYW1lLmZhbWlseSBcbiAgICAgICAgJiYgKG5hbWUuZmFtaWx5LnNsaWNlKDAsIDEpID09PSAnXCInICYmIG5hbWUuZmFtaWx5LnNsaWNlKC0xKSA9PT0gJ1wiJylcbiAgICAgICAgfHwgKCFuYW1lW1wicGFyc2UtbmFtZXNcIl0gJiYgXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIG5hbWVbXCJwYXJzZS1uYW1lc1wiXSkpIHtcbiAgICAgICAgbmFtZS5mYW1pbHkgPSBuYW1lLmZhbWlseS5zbGljZSgxLCAtMSk7XG4gICAgICAgIG5vcGFyc2UgPSB0cnVlO1xuICAgICAgICBuYW1lW1wicGFyc2UtbmFtZXNcIl0gPSAwO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG5vcGFyc2UgPSBmYWxzZTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMucGFyc2VfbmFtZXMpIHtcbiAgICAgICAgaWYgKCFuYW1lW1wibm9uLWRyb3BwaW5nLXBhcnRpY2xlXCJdICYmIG5hbWUuZmFtaWx5ICYmICFub3BhcnNlICYmIG5hbWUuZ2l2ZW4pIHtcbiAgICAgICAgICAgIGlmICghbmFtZVtcInN0YXRpYy1wYXJ0aWNsZXNcIl0pIHtcbiAgICAgICAgICAgICAgICBDU0wucGFyc2VQYXJ0aWNsZXMobmFtZSwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAobmFtZSwgc2xvdExvY2FsZXNldCwgZmFsbGJhY2ssIHN0b3BPcmlnKSB7XG4gICAgaWYgKHN0b3BPcmlnICYmIHNsb3RMb2NhbGVzZXQgPT09ICdsb2NhbGUtb3JpZycpIHtcbiAgICAgICAgcmV0dXJuIHtuYW1lOmZhbHNlLHVzZWRPcmlnOnN0b3BPcmlnfTtcbiAgICB9XG4gICAgaWYgKCFuYW1lLmZhbWlseSkge1xuICAgICAgICBuYW1lLmZhbWlseSA9IFwiXCI7XG4gICAgfVxuICAgIGlmICghbmFtZS5naXZlbikge1xuICAgICAgICBuYW1lLmdpdmVuID0gXCJcIjtcbiAgICB9XG4gICAgdmFyIG5hbWVfcGFyYW1zID0ge307XG4gICAgbmFtZV9wYXJhbXNbXCJzdGF0aWMtb3JkZXJpbmdcIl0gPSB0aGlzLmdldFN0YXRpY09yZGVyKG5hbWUpO1xuICAgIHZhciBmb3VuZFRhZyA9IHRydWU7XG4gICAgaWYgKHNsb3RMb2NhbGVzZXQgIT09ICdsb2NhbGUtb3JpZycpIHtcbiAgICAgICAgZm91bmRUYWcgPSBmYWxzZTtcbiAgICAgICAgaWYgKG5hbWUubXVsdGkpIHtcbiAgICAgICAgICAgIHZhciBsYW5nVGFncyA9IHRoaXMuc3RhdGUub3B0W3Nsb3RMb2NhbGVzZXRdXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGxhbmdUYWdzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIGxhbmdUYWcgPSBsYW5nVGFnc1tpXTtcbiAgICAgICAgICAgICAgICBpZiAobmFtZS5tdWx0aS5fa2V5W2xhbmdUYWddKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvdW5kVGFnID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlzSW5zdGl0dXRpb24gPSBuYW1lLmlzSW5zdGl0dXRpb247XG4gICAgICAgICAgICAgICAgICAgIG5hbWUgPSBuYW1lLm11bHRpLl9rZXlbbGFuZ1RhZ107XG4gICAgICAgICAgICAgICAgICAgIG5hbWUuaXNJbnN0aXR1dGlvbiA9IGlzSW5zdGl0dXRpb247XG4gICAgICAgICAgICAgICAgICAgIG5hbWVfcGFyYW1zID0gdGhpcy5nZXROYW1lUGFyYW1zKGxhbmdUYWcpO1xuICAgICAgICAgICAgICAgICAgICBuYW1lX3BhcmFtcy50cmFuc2xpdGVyYXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWZvdW5kVGFnKSB7XG4gICAgICAgIHZhciBsYW5nVGFnID0gZmFsc2U7XG4gICAgICAgIGlmIChuYW1lLm11bHRpICYmIG5hbWUubXVsdGkubWFpbikge1xuICAgICAgICAgICAgbGFuZ1RhZyA9IG5hbWUubXVsdGkubWFpbjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLkl0ZW0ubGFuZ3VhZ2UpIHtcbiAgICAgICAgICAgIGxhbmdUYWcgPSB0aGlzLkl0ZW0ubGFuZ3VhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxhbmdUYWcpIHtcbiAgICAgICAgICAgIG5hbWVfcGFyYW1zID0gdGhpcy5nZXROYW1lUGFyYW1zKGxhbmdUYWcpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghZmFsbGJhY2sgJiYgIWZvdW5kVGFnKSB7XG4gICAgICAgIHJldHVybiB7bmFtZTpmYWxzZSx1c2VkT3JpZzpzdG9wT3JpZ307XG4gICAgfVxuICAgIGlmICghbmFtZS5mYW1pbHkpIHtcbiAgICAgICAgbmFtZS5mYW1pbHkgPSBcIlwiO1xuICAgIH1cbiAgICBpZiAoIW5hbWUuZ2l2ZW4pIHtcbiAgICAgICAgbmFtZS5naXZlbiA9IFwiXCI7XG4gICAgfVxuICAgIG5hbWUgPSB7XG4gICAgICAgIGZhbWlseTpuYW1lLmZhbWlseSxcbiAgICAgICAgZ2l2ZW46bmFtZS5naXZlbixcbiAgICAgICAgXCJub24tZHJvcHBpbmctcGFydGljbGVcIjpuYW1lW1wibm9uLWRyb3BwaW5nLXBhcnRpY2xlXCJdLFxuICAgICAgICBcImRyb3BwaW5nLXBhcnRpY2xlXCI6bmFtZVtcImRyb3BwaW5nLXBhcnRpY2xlXCJdLFxuICAgICAgICBzdWZmaXg6bmFtZS5zdWZmaXgsXG4gICAgICAgIFwic3RhdGljLW9yZGVyaW5nXCI6bmFtZV9wYXJhbXNbXCJzdGF0aWMtb3JkZXJpbmdcIl0sXG4gICAgICAgIFwic3RhdGljLXBhcnRpY2xlc1wiOm5hbWVbXCJzdGF0aWMtcGFydGljbGVzXCJdLFxuICAgICAgICBcInJldmVyc2Utb3JkZXJpbmdcIjpuYW1lX3BhcmFtc1tcInJldmVyc2Utb3JkZXJpbmdcIl0sXG4gICAgICAgIFwiZnVsbC1mb3JtLWFsd2F5c1wiOiBuYW1lX3BhcmFtc1tcImZ1bGwtZm9ybS1hbHdheXNcIl0sXG4gICAgICAgIFwicGFyc2UtbmFtZXNcIjpuYW1lW1wicGFyc2UtbmFtZXNcIl0sXG4gICAgICAgIFwiY29tbWEtc3VmZml4XCI6bmFtZVtcImNvbW1hLXN1ZmZpeFwiXSxcbiAgICAgICAgXCJjb21tYS1kcm9wcGluZy1wYXJ0aWNsZVwiOm5hbWVbXCJjb21tYS1kcm9wcGluZy1wYXJ0aWNsZVwiXSxcbiAgICAgICAgdHJhbnNsaXRlcmF0ZWQ6IG5hbWVfcGFyYW1zLnRyYW5zbGl0ZXJhdGVkLFxuICAgICAgICBibG9ja19pbml0aWFsaXplOiBuYW1lX3BhcmFtc1tcImJsb2NrLWluaXRpYWxpemVcIl0sXG4gICAgICAgIGxpdGVyYWw6bmFtZS5saXRlcmFsLFxuICAgICAgICBpc0luc3RpdHV0aW9uOm5hbWUuaXNJbnN0aXR1dGlvbixcbiAgICAgICAgbXVsdGk6bmFtZS5tdWx0aVxuICAgIH07XG4gICAgaWYgKCFuYW1lLmxpdGVyYWwgJiYgKCFuYW1lLmdpdmVuICYmIG5hbWUuZmFtaWx5ICYmIG5hbWUuaXNJbnN0aXR1dGlvbikpIHtcbiAgICAgICAgbmFtZS5saXRlcmFsID0gbmFtZS5mYW1pbHk7XG4gICAgfVxuICAgIGlmIChuYW1lLmxpdGVyYWwpIHtcbiAgICAgICAgZGVsZXRlIG5hbWUuZmFtaWx5O1xuICAgICAgICBkZWxldGUgbmFtZS5naXZlbjtcbiAgICB9XG4gICAgbmFtZSA9IHRoaXMuX25vcm1hbGl6ZU5hbWVJbnB1dChuYW1lKTtcbiAgICB2YXIgdXNlZE9yaWc7XG4gICAgaWYgKHN0b3BPcmlnKSB7XG4gICAgICAgIHVzZWRPcmlnID0gc3RvcE9yaWc7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdXNlZE9yaWcgPSAhZm91bmRUYWc7XG4gICAgfVxuICAgIHJldHVybiB7bmFtZTpuYW1lLHVzZWRPcmlnOnVzZWRPcmlnfTtcbn1cbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5nZXROYW1lUGFyYW1zID0gZnVuY3Rpb24gKGxhbmdUYWcpIHtcbiAgICB2YXIgcmV0ID0ge307XG4gICAgdmFyIGxhbmdzcGVjID0gQ1NMLmxvY2FsZVJlc29sdmUodGhpcy5JdGVtLmxhbmd1YWdlLCB0aGlzLnN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdKTtcbiAgICB2YXIgdHJ5X2xvY2FsZSA9IHRoaXMuc3RhdGUubG9jYWxlW2xhbmdzcGVjLmJlc3RdID8gbGFuZ3NwZWMuYmVzdCA6IHRoaXMuc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF07XG4gICAgdmFyIG5hbWVfYXNfc29ydF9vcmRlciA9IHRoaXMuc3RhdGUubG9jYWxlW3RyeV9sb2NhbGVdLm9wdHNbXCJuYW1lLWFzLXNvcnQtb3JkZXJcIl1cbiAgICB2YXIgbmFtZV9hc19yZXZlcnNlX29yZGVyID0gdGhpcy5zdGF0ZS5sb2NhbGVbdHJ5X2xvY2FsZV0ub3B0c1tcIm5hbWUtYXMtcmV2ZXJzZS1vcmRlclwiXVxuICAgIHZhciBuYW1lX25ldmVyX3Nob3J0ID0gdGhpcy5zdGF0ZS5sb2NhbGVbdHJ5X2xvY2FsZV0ub3B0c1tcIm5hbWUtbmV2ZXItc2hvcnRcIl1cbiAgICB2YXIgZmllbGRfbGFuZ19iYXJlID0gbGFuZ1RhZy5zcGxpdChcIi1cIilbMF07XG4gICAgaWYgKG5hbWVfYXNfc29ydF9vcmRlciAmJiBuYW1lX2FzX3NvcnRfb3JkZXJbZmllbGRfbGFuZ19iYXJlXSkge1xuICAgICAgICByZXRbXCJzdGF0aWMtb3JkZXJpbmdcIl0gPSB0cnVlO1xuICAgICAgICByZXRbXCJyZXZlcnNlLW9yZGVyaW5nXCJdID0gZmFsc2U7XG4gICAgfVxuICAgIGlmIChuYW1lX2FzX3JldmVyc2Vfb3JkZXIgJiYgbmFtZV9hc19yZXZlcnNlX29yZGVyW2ZpZWxkX2xhbmdfYmFyZV0pIHtcbiAgICAgICAgcmV0W1wicmV2ZXJzZS1vcmRlcmluZ1wiXSA9IHRydWU7XG4gICAgICAgIHJldFtcInN0YXRpYy1vcmRlcmluZ1wiXSA9IGZhbHNlO1xuICAgIH1cbiAgICBpZiAobmFtZV9uZXZlcl9zaG9ydCAmJiBuYW1lX25ldmVyX3Nob3J0W2ZpZWxkX2xhbmdfYmFyZV0pIHtcbiAgICAgICAgcmV0W1wiZnVsbC1mb3JtLWFsd2F5c1wiXSA9IHRydWU7XG4gICAgfVxuICAgIGlmIChyZXRbXCJzdGF0aWMtb3JkZXJpbmdcIl0pIHtcbiAgICAgICAgcmV0W1wiYmxvY2staW5pdGlhbGl6ZVwiXSA9IHRydWU7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuc2V0UmVuZGVyZWROYW1lID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICBpZiAodGhpcy5zdGF0ZS50bXAuYXJlYSA9PT0gXCJiaWJsaW9ncmFwaHlcIikge1xuICAgICAgICB2YXIgc3RybmFtZSA9IFwiXCI7XG4gICAgICAgIGZvciAodmFyIGo9MCxqbGVuPUNTTC5OQU1FX1BBUlRTLmxlbmd0aDtqPGpsZW47ais9MSkge1xuICAgICAgICAgICAgaWYgKG5hbWVbQ1NMLk5BTUVfUEFSVFNbal1dKSB7XG4gICAgICAgICAgICAgICAgc3RybmFtZSArPSBuYW1lW0NTTC5OQU1FX1BBUlRTW2pdXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN0YXRlLnRtcC5yZW5kZXJlZF9uYW1lLnB1c2goc3RybmFtZSk7XG4gICAgfVxufVxuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmZpeHVwSW5zdGl0dXRpb24gPSBmdW5jdGlvbiAobmFtZSwgdmFybmFtZSwgbGlzdHBvcykge1xuICAgIGlmICh0aGlzLnN0YXRlLnN5cy5nZXRIdW1hbkZvcm0gJiYgXCJsZWdhbF9jYXNlXCIgPT09IHRoaXMuSXRlbS50eXBlICYmIFwiYXV0aG9yaXR5XCIgPT09IHZhcm5hbWUpIHtcbiAgICAgICAgbmFtZS5saXRlcmFsID0gdGhpcy5zdGF0ZS5zeXMuZ2V0SHVtYW5Gb3JtKHRoaXMuSXRlbS5qdXJpc2RpY3Rpb24sIG5hbWUubGl0ZXJhbCwgdHJ1ZSk7XG4gICAgfVxuICAgIG5hbWUgPSB0aGlzLl9zcGxpdEluc3RpdHV0aW9uKG5hbWUsIHZhcm5hbWUsIGxpc3Rwb3MpO1xuICAgIGlmICh0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3NbXCJyZXZlcnNlLW9yZGVyXCJdKSB7XG4gICAgICAgIG5hbWVbXCJsb25nXCJdLnJldmVyc2UoKTtcbiAgICB9XG4gICAgdmFyIGxvbmdfZm9ybSA9IG5hbWVbXCJsb25nXCJdO1xuICAgIHZhciBzaG9ydF9mb3JtID0gbmFtZVtcImxvbmdcIl0uc2xpY2UoKTtcbiAgICB2YXIgdXNlX3Nob3J0X2Zvcm0gPSBmYWxzZTtcbiAgICBpZiAodGhpcy5zdGF0ZS5zeXMuZ2V0QWJicmV2aWF0aW9uKSB7XG4gICAgICAgIHZhciBqdXJpc2RpY3Rpb24gPSB0aGlzLkl0ZW0uanVyaXNkaWN0aW9uO1xuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IGxvbmdfZm9ybS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gbG9uZ19mb3JtW2pdO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkpIHtcbiAgICAgICAgICAgICAgICBub3JtYWxpemVkS2V5ID0gdGhpcy5zdGF0ZS5zeXMubm9ybWFsaXplQWJicmV2c0tleSh2YXJuYW1lLCBsb25nX2Zvcm1bal0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAganVyaXNkaWN0aW9uID0gdGhpcy5zdGF0ZS50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihqdXJpc2RpY3Rpb24sIFwiaW5zdGl0dXRpb24tcGFydFwiLCBub3JtYWxpemVkS2V5KTtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bXCJpbnN0aXR1dGlvbi1wYXJ0XCJdW25vcm1hbGl6ZWRLZXldKSB7XG4gICAgICAgICAgICAgICAgc2hvcnRfZm9ybVtqXSA9IHRoaXMuc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXVtcImluc3RpdHV0aW9uLXBhcnRcIl1bbm9ybWFsaXplZEtleV07XG4gICAgICAgICAgICAgICAgdXNlX3Nob3J0X2Zvcm0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh1c2Vfc2hvcnRfZm9ybSkge1xuICAgICAgICBuYW1lW1wic2hvcnRcIl0gPSBzaG9ydF9mb3JtO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG5hbWVbXCJzaG9ydFwiXSA9IFtdO1xuICAgIH1cbiAgICByZXR1cm4gbmFtZTtcbn1cbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5nZXRTdGF0aWNPcmRlciA9IGZ1bmN0aW9uIChuYW1lLCByZWZyZXNoKSB7XG4gICAgdmFyIHN0YXRpY19vcmRlcmluZ192YWwgPSBmYWxzZTtcbiAgICBpZiAoIXJlZnJlc2ggJiYgbmFtZVtcInN0YXRpYy1vcmRlcmluZ1wiXSkge1xuICAgICAgICBzdGF0aWNfb3JkZXJpbmdfdmFsID0gdHJ1ZTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuX2lzUm9tYW5lc3F1ZShuYW1lKSA9PT0gMCkge1xuICAgICAgICBzdGF0aWNfb3JkZXJpbmdfdmFsID0gdHJ1ZTtcbiAgICB9IGVsc2UgaWYgKCghbmFtZS5tdWx0aSB8fCAhbmFtZS5tdWx0aS5tYWluKSAmJiB0aGlzLkl0ZW0ubGFuZ3VhZ2UgJiYgWyd2aScsICdodSddLmluZGV4T2YodGhpcy5JdGVtLmxhbmd1YWdlKSA+IC0xKSB7XG4gICAgICAgIHN0YXRpY19vcmRlcmluZ192YWwgPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAobmFtZS5tdWx0aSAmJiBuYW1lLm11bHRpLm1haW4gJiYgWyd2aScsICdodSddLmluZGV4T2YobmFtZS5tdWx0aS5tYWluLnNsaWNlKDAsMikpID4gLTEpIHtcbiAgICAgICAgc3RhdGljX29yZGVyaW5nX3ZhbCA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUub3B0WydhdXRvLXZpZXRuYW1lc2UtbmFtZXMnXVxuICAgICAgICAgICAgJiYgKENTTC5WSUVUTkFNRVNFX05BTUVTLmV4ZWMobmFtZS5mYW1pbHkgKyBcIiBcIiArIG5hbWUuZ2l2ZW4pXG4gICAgICAgICAgICAgICAgJiYgQ1NMLlZJRVROQU1FU0VfU1BFQ0lBTFMuZXhlYyhuYW1lLmZhbWlseSArIG5hbWUuZ2l2ZW4pKSkge1xuICAgICAgICAgICAgc3RhdGljX29yZGVyaW5nX3ZhbCA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHN0YXRpY19vcmRlcmluZ192YWw7XG59XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX3NwbGl0SW5zdGl0dXRpb24gPSBmdW5jdGlvbiAodmFsdWUsIHYsIGkpIHtcbiAgICB2YXIgcmV0ID0ge307XG4gICAgaWYgKCF2YWx1ZS5saXRlcmFsICYmIHZhbHVlLmZhbWlseSkge1xuICAgICAgICB2YWx1ZS5saXRlcmFsID0gdmFsdWUuZmFtaWx5O1xuICAgICAgICBkZWxldGUgdmFsdWUuZmFtaWx5O1xuICAgIH1cbiAgICB2YXIgc3BsaXRJbnN0aXR1dGlvbiA9IHZhbHVlLmxpdGVyYWwucmVwbGFjZSgvXFxzKlxcfFxccyovZywgXCJ8XCIpO1xuICAgIHNwbGl0SW5zdGl0dXRpb24gPSBzcGxpdEluc3RpdHV0aW9uLnNwbGl0KFwifFwiKTtcbiAgICBpZiAodGhpcy5pbnN0aXR1dGlvbi5zdHJpbmdzLmZvcm0gPT09IFwic2hvcnRcIiAmJiB0aGlzLnN0YXRlLnN5cy5nZXRBYmJyZXZpYXRpb24pIHtcbiAgICAgICAgdmFyIGp1cmlzZGljdGlvbiA9IHRoaXMuSXRlbS5qdXJpc2RpY3Rpb247XG4gICAgICAgIGZvciAodmFyIGogPSBzcGxpdEluc3RpdHV0aW9uLmxlbmd0aDsgaiA+IDA7IGogKz0gLTEpIHtcbiAgICAgICAgICAgIHZhciBzdHIgPSBzcGxpdEluc3RpdHV0aW9uLnNsaWNlKDAsIGopLmpvaW4oXCJ8XCIpO1xuICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRLZXkgPSBzdHI7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5zeXMubm9ybWFsaXplQWJicmV2c0tleSkge1xuICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRLZXkgPSB0aGlzLnN0YXRlLnN5cy5ub3JtYWxpemVBYmJyZXZzS2V5KHYsIHN0cik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBqdXJpc2RpY3Rpb24gPSB0aGlzLnN0YXRlLnRyYW5zZm9ybS5sb2FkQWJicmV2aWF0aW9uKGp1cmlzZGljdGlvbiwgXCJpbnN0aXR1dGlvbi1lbnRpcmVcIiwgbm9ybWFsaXplZEtleSk7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dW1wiaW5zdGl0dXRpb24tZW50aXJlXCJdW25vcm1hbGl6ZWRLZXldKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNwbGl0THN0ID0gdGhpcy5zdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dW1wiaW5zdGl0dXRpb24tZW50aXJlXCJdW25vcm1hbGl6ZWRLZXldO1xuICAgICAgICAgICAgICAgIHNwbGl0THN0ID0gdGhpcy5zdGF0ZS50cmFuc2Zvcm0ucXVhc2hDaGVjayhzcGxpdExzdCk7XG4gICAgICAgICAgICAgICAgdmFyIHNwbGl0U3BsaXRMc3QgPSBzcGxpdExzdC5zcGxpdCgvPj5bMC05XXs0fT4+Lyk7XG4gICAgICAgICAgICAgICAgdmFyIG0gPSBzcGxpdExzdC5tYXRjaCgvPj4oWzAtOV17NH0pPj4vKTtcbiAgICAgICAgICAgICAgICBzcGxpdExzdCA9IHNwbGl0U3BsaXRMc3QucG9wKCk7XG4gICAgICAgICAgICAgICAgaWYgKHNwbGl0U3BsaXRMc3QubGVuZ3RoID4gMCAmJiB0aGlzLkl0ZW1bXCJvcmlnaW5hbC1kYXRlXCJdICYmIHRoaXMuSXRlbVtcIm9yaWdpbmFsLWRhdGVcIl0ueWVhcikge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrPW0ubGVuZ3RoIC0gMTsgayA+IDA7IGsgKz0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJzZUludCh0aGlzLkl0ZW1bXCJvcmlnaW5hbC1kYXRlXCJdLnllYXIsIDEwKSA+PSBwYXJzZUludChtW2tdLCAxMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHNwbGl0THN0ID0gc3BsaXRTcGxpdExzdC5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzcGxpdExzdCA9IHNwbGl0THN0LnJlcGxhY2UoL1xccypcXHxcXHMqL2csIFwifFwiKTtcbiAgICAgICAgICAgICAgICBzcGxpdEluc3RpdHV0aW9uID0gW3NwbGl0THN0XTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBzcGxpdEluc3RpdHV0aW9uLnJldmVyc2UoKTtcbiAgICByZXRbXCJsb25nXCJdID0gdGhpcy5fdHJpbUluc3RpdHV0aW9uKHNwbGl0SW5zdGl0dXRpb24sIHYsIGkpO1xuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl90cmltSW5zdGl0dXRpb24gPSBmdW5jdGlvbiAoc3VidW5pdHMsIHYsIGkpIHtcbiAgICB2YXIgdXNlX2ZpcnN0ID0gZmFsc2U7XG4gICAgdmFyIGFwcGVuZF9sYXN0ID0gZmFsc2U7XG4gICAgdmFyIHMgPSBzdWJ1bml0cy5zbGljZSgpO1xuICAgIHZhciBzdG9wX2xhc3QgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5pbnN0aXR1dGlvbikge1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInVzZS1maXJzdFwiXSkge1xuICAgICAgICAgICAgdXNlX2ZpcnN0ID0gdGhpcy5pbnN0aXR1dGlvbi5zdHJpbmdzW1widXNlLWZpcnN0XCJdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgdGhpcy5pbnN0aXR1dGlvbi5zdHJpbmdzW1wic3RvcC1sYXN0XCJdKSB7XG4gICAgICAgICAgICBzdG9wX2xhc3QgPSB0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3NbXCJzdG9wLWxhc3RcIl07XG4gICAgICAgIH0gZWxzZSBpZiAoXCJhdXRob3JpdHlcIiA9PT0gdiAmJiB0aGlzLnN0YXRlLnRtcC5hdXRob3JpdHlfc3RvcF9sYXN0KSB7XG4gICAgICAgICAgICBzdG9wX2xhc3QgPSB0aGlzLnN0YXRlLnRtcC5hdXRob3JpdHlfc3RvcF9sYXN0O1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdG9wX2xhc3QpIHtcbiAgICAgICAgICAgIHMgPSBzLnNsaWNlKDAsIHN0b3BfbGFzdCk7XG4gICAgICAgICAgICBzdWJ1bml0cyA9IHN1YnVuaXRzLnNsaWNlKDAsIHN0b3BfbGFzdCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3NbXCJ1c2UtbGFzdFwiXSkge1xuICAgICAgICAgICAgYXBwZW5kX2xhc3QgPSB0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3NbXCJ1c2UtbGFzdFwiXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJhdXRob3JpdHlcIiA9PT0gdikge1xuICAgICAgICAgICAgaWYgKHN0b3BfbGFzdCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmF1dGhvcml0eV9zdG9wX2xhc3QgPSBzdG9wX2xhc3Q7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBwZW5kX2xhc3QpICB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuYXV0aG9yaXR5X3N0b3BfbGFzdCArPSAoYXBwZW5kX2xhc3QgKiAtMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGZhbHNlID09PSB1c2VfZmlyc3QpIHtcbiAgICAgICAgaWYgKHRoaXMucGVyc29uc1t2XS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHVzZV9maXJzdCA9IHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInN1YnN0aXR1dGUtdXNlLWZpcnN0XCJdO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdXNlX2ZpcnN0KSB7XG4gICAgICAgICAgICB1c2VfZmlyc3QgPSAwO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChmYWxzZSA9PT0gYXBwZW5kX2xhc3QpIHtcbiAgICAgICAgaWYgKCF1c2VfZmlyc3QpIHtcbiAgICAgICAgICAgIGFwcGVuZF9sYXN0ID0gc3VidW5pdHMubGVuZ3RoO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXBwZW5kX2xhc3QgPSAwO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh1c2VfZmlyc3QgPiBzdWJ1bml0cy5sZW5ndGggLSBhcHBlbmRfbGFzdCkge1xuICAgICAgICB1c2VfZmlyc3QgPSBzdWJ1bml0cy5sZW5ndGggLSBhcHBlbmRfbGFzdDtcbiAgICB9XG4gICAgc3VidW5pdHMgPSBzdWJ1bml0cy5zbGljZSgwLCB1c2VfZmlyc3QpO1xuICAgIHMgPSBzLnNsaWNlKHVzZV9maXJzdCk7XG4gICAgaWYgKGFwcGVuZF9sYXN0KSB7XG4gICAgICAgIGlmIChhcHBlbmRfbGFzdCA+IHMubGVuZ3RoKSB7XG4gICAgICAgICAgICBhcHBlbmRfbGFzdCA9IHMubGVuZ3RoO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhcHBlbmRfbGFzdCkge1xuICAgICAgICAgICAgc3VidW5pdHMgPSBzdWJ1bml0cy5jb25jYXQocy5zbGljZSgocy5sZW5ndGggLSBhcHBlbmRfbGFzdCkpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc3VidW5pdHM7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuUHVibGlzaGVyT3V0cHV0ID0gZnVuY3Rpb24gKHN0YXRlLCBncm91cF90b2spIHtcbiAgICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gICAgdGhpcy5ncm91cF90b2sgPSBncm91cF90b2s7XG4gICAgdGhpcy52YXJsaXN0ID0gW107XG59O1xuQ1NMLlB1Ymxpc2hlck91dHB1dC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuY2xlYXJWYXJzKCk7XG4gICAgdGhpcy5jb21wb3NlQW5kQmxvYigpO1xuICAgIHRoaXMuY29tcG9zZUVsZW1lbnRzKCk7XG4gICAgdGhpcy5jb21wb3NlUHVibGlzaGVycygpO1xuICAgIHRoaXMuam9pblB1Ymxpc2hlcnMoKTtcbn07XG5DU0wuUHVibGlzaGVyT3V0cHV0LnByb3RvdHlwZS5jb21wb3NlQW5kQmxvYiA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmFuZF9ibG9iID0ge307XG4gICAgdmFyIGFuZF90ZXJtID0gZmFsc2U7XG4gICAgaWYgKHRoaXMuZ3JvdXBfdG9rLnN0cmluZ3MuYW5kID09PSBcInRleHRcIikge1xuICAgICAgICBhbmRfdGVybSA9IHRoaXMuc3RhdGUuZ2V0VGVybShcImFuZFwiKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZ3JvdXBfdG9rLnN0cmluZ3MuYW5kID09PSBcInN5bWJvbFwiKSB7XG4gICAgICAgIGFuZF90ZXJtID0gXCImXCI7XG4gICAgfVxuICAgIHZhciB0b2sgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgdG9rLnN0cmluZ3Muc3VmZml4ID0gXCIgXCI7XG4gICAgdG9rLnN0cmluZ3MucHJlZml4ID0gXCIgXCI7XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKGFuZF90ZXJtLCB0b2ssIHRydWUpO1xuICAgIHZhciBub19kZWxpbSA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgIHRvay5zdHJpbmdzLnByZWZpeCA9IHRoaXMuZ3JvdXBfdG9rLnN0cmluZ3NbXCJzdWJncm91cC1kZWxpbWl0ZXJcIl07XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKGFuZF90ZXJtLCB0b2ssIHRydWUpO1xuICAgIHZhciB3aXRoX2RlbGltID0gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgdGhpcy5hbmRfYmxvYi5zaW5nbGUgPSBmYWxzZTtcbiAgICB0aGlzLmFuZF9ibG9iLm11bHRpcGxlID0gZmFsc2U7XG4gICAgaWYgKGFuZF90ZXJtKSB7XG4gICAgICAgIGlmICh0aGlzLmdyb3VwX3Rvay5zdHJpbmdzW1wic3ViZ3JvdXAtZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIl0gPT09IFwiYWx3YXlzXCIpIHtcbiAgICAgICAgICAgIHRoaXMuYW5kX2Jsb2Iuc2luZ2xlID0gd2l0aF9kZWxpbTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmdyb3VwX3Rvay5zdHJpbmdzW1wic3ViZ3JvdXAtZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIl0gPT09IFwibmV2ZXJcIikge1xuICAgICAgICAgICAgdGhpcy5hbmRfYmxvYi5zaW5nbGUgPSBub19kZWxpbTtcbiAgICAgICAgICAgIHRoaXMuYW5kX2Jsb2IubXVsdGlwbGUgPSBub19kZWxpbTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYW5kX2Jsb2Iuc2luZ2xlID0gbm9fZGVsaW07XG4gICAgICAgICAgICB0aGlzLmFuZF9ibG9iLm11bHRpcGxlID0gd2l0aF9kZWxpbTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuUHVibGlzaGVyT3V0cHV0LnByb3RvdHlwZS5jb21wb3NlRWxlbWVudHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSAyOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciB2YXJuYW1lID0gW1wicHVibGlzaGVyXCIsIFwicHVibGlzaGVyLXBsYWNlXCJdW2ldO1xuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IHRoaXNbXCJwdWJsaXNoZXItbGlzdFwiXS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIHZhciBzdHIgPSB0aGlzW3Zhcm5hbWUgKyBcIi1saXN0XCJdW2pdO1xuICAgICAgICAgICAgdmFyIHRvayA9IHRoaXNbdmFybmFtZSArIFwiLXRva2VuXCJdO1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHN0ciwgdG9rLCB0cnVlKTtcbiAgICAgICAgICAgIHRoaXNbdmFybmFtZSArIFwiLWxpc3RcIl1bal0gPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuUHVibGlzaGVyT3V0cHV0LnByb3RvdHlwZS5jb21wb3NlUHVibGlzaGVycyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgYmxvYnM7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzW1wicHVibGlzaGVyLWxpc3RcIl0ubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciBvcmRlcmVkX2xpc3QgPSBbXTtcbiAgICAgICAgYmxvYnMgPSBbdGhpc1t0aGlzLnZhcmxpc3RbMF0gKyBcIi1saXN0XCJdW2ldLCB0aGlzW3RoaXMudmFybGlzdFsxXSArIFwiLWxpc3RcIl1baV1dO1xuICAgICAgICB0aGlzW1wicHVibGlzaGVyLWxpc3RcIl1baV0gPSB0aGlzLl9qb2luKGJsb2JzLCB0aGlzLmdyb3VwX3Rvay5zdHJpbmdzLmRlbGltaXRlcik7XG4gICAgfVxufTtcbkNTTC5QdWJsaXNoZXJPdXRwdXQucHJvdG90eXBlLmpvaW5QdWJsaXNoZXJzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBibG9icyA9IHRoaXNbXCJwdWJsaXNoZXItbGlzdFwiXTtcbiAgICB2YXIgZGVsaW0gPSB0aGlzLm5hbWVfZGVsaW1pdGVyO1xuICAgIHZhciBwdWJsaXNoZXJzID0gdGhpcy5fam9pbihibG9icywgdGhpcy5ncm91cF90b2suc3RyaW5nc1tcInN1Ymdyb3VwLWRlbGltaXRlclwiXSwgdGhpcy5hbmRfYmxvYi5zaW5nbGUsIHRoaXMuYW5kX2Jsb2IubXVsdGlwbGUsIHRoaXMuZ3JvdXBfdG9rKTtcbiAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQocHVibGlzaGVycywgXCJsaXRlcmFsXCIpO1xufTtcbkNTTC5QdWJsaXNoZXJPdXRwdXQucHJvdG90eXBlLl9qb2luID0gQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9qb2luO1xuQ1NMLlB1Ymxpc2hlck91dHB1dC5wcm90b3R5cGUuX2dldFRva2VuID0gQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9nZXRUb2tlbjtcbkNTTC5QdWJsaXNoZXJPdXRwdXQucHJvdG90eXBlLmNsZWFyVmFycyA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnN0YXRlLnRtcFtcInB1Ymxpc2hlci1saXN0XCJdID0gZmFsc2U7XG4gICAgdGhpcy5zdGF0ZS50bXBbXCJwdWJsaXNoZXItcGxhY2UtbGlzdFwiXSA9IGZhbHNlO1xuICAgIHRoaXMuc3RhdGUudG1wW1wicHVibGlzaGVyLWdyb3VwLXRva2VuXCJdID0gZmFsc2U7XG4gICAgdGhpcy5zdGF0ZS50bXBbXCJwdWJsaXNoZXItdG9rZW5cIl0gPSBmYWxzZTtcbiAgICB0aGlzLnN0YXRlLnRtcFtcInB1Ymxpc2hlci1wbGFjZS10b2tlblwiXSA9IGZhbHNlO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLmV2YWx1YXRlTGFiZWwgPSBmdW5jdGlvbiAobm9kZSwgc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICB2YXIgbXl0ZXJtO1xuICAgIGlmIChcImxvY2F0b3JcIiA9PT0gbm9kZS5zdHJpbmdzLnRlcm0pIHtcbiAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS5sYWJlbCkge1xuICAgICAgICAgICAgaWYgKGl0ZW0ubGFiZWwgPT09IFwic3ViIHZlcmJvXCIpIHtcbiAgICAgICAgICAgICAgICBteXRlcm0gPSBcInN1Yi12ZXJib1wiO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBteXRlcm0gPSBpdGVtLmxhYmVsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghbXl0ZXJtKSB7XG4gICAgICAgICAgICBteXRlcm0gPSBcInBhZ2VcIjtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIG15dGVybSA9IG5vZGUuc3RyaW5ncy50ZXJtO1xuICAgIH1cbiAgICB2YXIgcGx1cmFsID0gbm9kZS5zdHJpbmdzLnBsdXJhbDtcbiAgICBpZiAoXCJudW1iZXJcIiAhPT0gdHlwZW9mIHBsdXJhbCkge1xuICAgICAgICB2YXIgdGhlSXRlbSA9IG5vZGUuc3RyaW5ncy50ZXJtID09PSBcImxvY2F0b3JcIiA/IGl0ZW0gOiBJdGVtO1xuICAgICAgICBzdGF0ZS5wcm9jZXNzTnVtYmVyKGZhbHNlLCB0aGVJdGVtLCBub2RlLnN0cmluZ3MudGVybSwgSXRlbS50eXBlKTtcbiAgICAgICAgcGx1cmFsID0gc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW25vZGUuc3RyaW5ncy50ZXJtXS5wbHVyYWw7XG4gICAgICAgIGlmICghc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW25vZGUuc3RyaW5ncy50ZXJtXS5sYWJlbEZvcm1cbiAgICAgICAgICAgJiYgIXN0YXRlLnRtcC5zaGFkb3dfbnVtYmVyc1tub2RlLnN0cmluZ3MudGVybV0ubGFiZWxEZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW25vZGUuc3RyaW5ncy50ZXJtXS5sYWJlbEZvcm0gPSBub2RlLnN0cmluZ3MuZm9ybTtcbiAgICAgICAgICAgIHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVyc1tub2RlLnN0cmluZ3MudGVybV0ubGFiZWxDYXBpdGFsaXplSWZGaXJzdCA9IG5vZGUuc3RyaW5ncy5jYXBpdGFsaXplX2lmX2ZpcnN0O1xuICAgICAgICAgICAgc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW25vZGUuc3RyaW5ncy50ZXJtXS5sYWJlbERlY29yYXRpb25zID0gbm9kZS5kZWNvcmF0aW9ucy5zbGljZSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChbXCJsb2NhdG9yXCIsIFwibnVtYmVyXCIsIFwicGFnZVwiXS5pbmRleE9mKG5vZGUuc3RyaW5ncy50ZXJtKSA+IC0xICYmIHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVyc1tub2RlLnN0cmluZ3MudGVybV0ubGFiZWwpIHtcbiAgICAgICAgICAgIG15dGVybSA9IHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVyc1tub2RlLnN0cmluZ3MudGVybV0ubGFiZWw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUuZGVjb3JhdGlvbnMgJiYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmNzbF9yZXZlcnNlX2xvb2t1cF9zdXBwb3J0IHx8IHN0YXRlLnN5cy5jc2xfcmV2ZXJzZV9sb29rdXBfc3VwcG9ydCkpIHtcbiAgICAgICAgICAgIG5vZGUuZGVjb3JhdGlvbnMucmV2ZXJzZSgpO1xuICAgICAgICAgICAgbm9kZS5kZWNvcmF0aW9ucy5wdXNoKFtcIkBzaG93aWRcIixcInRydWVcIiwgbm9kZS5jc2xpZF0pO1xuICAgICAgICAgICAgbm9kZS5kZWNvcmF0aW9ucy5yZXZlcnNlKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIENTTC5jYXN0TGFiZWwoc3RhdGUsIG5vZGUsIG15dGVybSwgcGx1cmFsLCBDU0wuVE9MRVJBTlQpO1xufTtcbkNTTC5jYXN0TGFiZWwgPSBmdW5jdGlvbiAoc3RhdGUsIG5vZGUsIHRlcm0sIHBsdXJhbCwgbW9kZSkge1xuICAgIHZhciBsYWJlbF9mb3JtID0gbm9kZS5zdHJpbmdzLmZvcm07XG4gICAgdmFyIGxhYmVsX2NhcGl0YWxpemVfaWZfZmlyc3QgPSBub2RlLnN0cmluZ3MuY2FwaXRhbGl6ZV9pZl9maXJzdDtcbiAgICBpZiAoc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmxhYmVsX2Zvcm0gJiYgbGFiZWxfZm9ybSAhPT0gXCJzdGF0aWNcIikge1xuICAgICAgICBsYWJlbF9mb3JtID0gc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmxhYmVsX2Zvcm07XG4gICAgfVxuICAgIGlmIChzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAubGFiZWxfY2FwaXRhbGl6ZV9pZl9maXJzdCkge1xuICAgICAgICBsYWJlbF9jYXBpdGFsaXplX2lmX2ZpcnN0ID0gc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmxhYmVsX2NhcGl0YWxpemVfaWZfZmlyc3Q7XG4gICAgfVxuICAgIHZhciByZXQgPSBzdGF0ZS5nZXRUZXJtKHRlcm0sIGxhYmVsX2Zvcm0sIHBsdXJhbCwgZmFsc2UsIG1vZGUsIG5vZGUuZGVmYXVsdF9sb2NhbGUpO1xuICAgIGlmIChsYWJlbF9jYXBpdGFsaXplX2lmX2ZpcnN0KSB7XG4gICAgICAgIHJldCA9IENTTC5PdXRwdXQuRm9ybWF0dGVyc1tcImNhcGl0YWxpemUtZmlyc3RcIl0oc3RhdGUsIHJldCk7XG4gICAgfVxuICAgIGlmIChzdGF0ZS50bXAuc3RyaXBfcGVyaW9kcykge1xuICAgICAgICByZXQgPSByZXQucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gbm9kZS5kZWNvcmF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChcIkBzdHJpcC1wZXJpb2RzXCIgPT09IG5vZGUuZGVjb3JhdGlvbnNbaV1bMF0gJiYgXCJ0cnVlXCIgPT09IG5vZGUuZGVjb3JhdGlvbnNbaV1bMV0pIHtcbiAgICAgICAgICAgICAgICByZXQgPSByZXQucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5uYW1lID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB2YXIgZnVuYywgcG9zLCBsZW4sIGF0dHJuYW1lO1xuICAgICAgICBpZiAoW0NTTC5TSU5HTEVUT04sIENTTC5TVEFSVF0uaW5kZXhPZih0aGlzLnRva2VudHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBzdGF0ZS50bXAucm9vdCkge1xuICAgICAgICAgICAgICAgIHZhciBvbGRUbXBSb290ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5yb290ID0gXCJjaXRhdGlvblwiO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgb2xkVG1wUm9vdCA9IHN0YXRlLnRtcC5yb290O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC1zdWJzZXF1ZW50LW1pblwiKVxuICAgICAgICAgICAgICAgICYmIChzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtc3Vic2VxdWVudC1taW5cIikgIT09IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC1taW5cIikpKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUub3B0LnVwZGF0ZV9tb2RlID0gQ1NMLlBPU0lUSU9OO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC1zdWJzZXF1ZW50LXVzZS1maXJzdFwiKVxuICAgICAgICAgICAgICAgICYmIChzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtc3Vic2VxdWVudC11c2UtZmlyc3RcIikgIT09IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtZmlyc3RcIikpKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUub3B0LnVwZGF0ZV9tb2RlID0gQ1NMLlBPU0lUSU9OO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGUudG1wLnJvb3QgPSBvbGRUbXBSb290O1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ldGFsX3Rlcm0gPSBcImV0LWFsXCI7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyID0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImRlbGltaXRlclwiLCBcIm5hbWUtZGVsaW1pdGVyXCIsIFwiLCBcIik7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZGVsaW1pdGVyLXByZWNlZGVzLWV0LWFsXCJdID0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImRlbGltaXRlci1wcmVjZWRlcy1ldC1hbFwiKTtcbiAgICAgICAgICAgICAgICBpZiAoXCJ0ZXh0XCIgPT09IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJhbmRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfdGVybSA9IHN0YXRlLmdldFRlcm0oXCJhbmRcIiwgXCJsb25nXCIsIDApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJzeW1ib2xcIiA9PT0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImFuZFwiKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZXhwZWN0X2FuZF9zeW1ib2xfZm9ybSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfdGVybSA9IHN0YXRlLmdldFRlcm0oXCJhbmRcIiwgXCJzeW1ib2xcIiwgMCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF90ZXJtID0gXCImXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmFuZF90ZXJtID0gdGhpcy5hbmRfdGVybTtcbiAgICAgICAgICAgICAgICBpZiAoQ1NMLlNUQVJUU1dJVEhfUk9NQU5FU1FVRV9SRUdFWFAudGVzdCh0aGlzLmFuZF90ZXJtKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlID0gXCIgXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZSA9IFwiLCBcIjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBzdGF0ZS50bXAubmFtZV9kZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZSA9IHN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9zdWZmaXggPSBcIiBcIjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X211bHRpcGxlID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfc3VmZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiKSA9PT0gXCJhbHdheXNcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlID0gc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImRlbGltaXRlci1wcmVjZWRlcy1sYXN0XCIpID09PSBcIm5ldmVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X211bHRpcGxlID0gXCIgXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiKSA9PT0gXCJhZnRlci1pbnZlcnRlZC1uYW1lXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYW5kX3ByZWZpeF9zaW5nbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3ByZWZpeF9zaW5nbGUgPSBzdGF0ZS50bXAubmFtZV9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X211bHRpcGxlID0gXCIgXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5hbmQgPSB7fTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImFuZFwiKSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHRoaXMuYW5kX3Rlcm0sIFwiZW1wdHlcIiwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLnNpbmdsZSA9IHN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQuc2luZ2xlLnN0cmluZ3MucHJlZml4ID0gdGhpcy5hbmRfcHJlZml4X3NpbmdsZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQuc2luZ2xlLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5hbmRfc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHRoaXMuYW5kX3Rlcm0sIFwiZW1wdHlcIiwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLm11bHRpcGxlID0gc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZS5zdHJpbmdzLnByZWZpeCA9IHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQubXVsdGlwbGUuc3RyaW5ncy5zdWZmaXggPSB0aGlzLmFuZF9zdWZmaXg7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS50bXAubmFtZV9kZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQuc2luZ2xlID0gbmV3IENTTC5CbG9iKHN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLnNpbmdsZS5zdHJpbmdzLnByZWZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLnNpbmdsZS5zdHJpbmdzLnN1ZmZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLm11bHRpcGxlID0gbmV3IENTTC5CbG9iKHN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLm11bHRpcGxlLnN0cmluZ3MucHJlZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQubXVsdGlwbGUuc3RyaW5ncy5zdWZmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmVsbGlwc2lzID0ge307XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtbGFzdFwiKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVsbGlwc2lzX3Rlcm0gPSBcIlxcdTIwMjZcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGxpcHNpc19wcmVmaXhfc2luZ2xlID0gXCIgXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWxsaXBzaXNfcHJlZml4X211bHRpcGxlID0gIHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXJcIiwgXCJuYW1lLWRlbGltaXRlclwiLCBcIiwgXCIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVsbGlwc2lzX3N1ZmZpeCA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVsbGlwc2lzLnNpbmdsZSA9IG5ldyBDU0wuQmxvYih0aGlzLmVsbGlwc2lzX3Rlcm0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVsbGlwc2lzLnNpbmdsZS5zdHJpbmdzLnByZWZpeCA9IHRoaXMuZWxsaXBzaXNfcHJlZml4X3NpbmdsZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGxpcHNpcy5zaW5nbGUuc3RyaW5ncy5zdWZmaXggPSB0aGlzLmVsbGlwc2lzX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGxpcHNpcy5tdWx0aXBsZSA9IG5ldyBDU0wuQmxvYih0aGlzLmVsbGlwc2lzX3Rlcm0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVsbGlwc2lzLm11bHRpcGxlLnN0cmluZ3MucHJlZml4ID0gdGhpcy5lbGxpcHNpc19wcmVmaXhfbXVsdGlwbGU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWxsaXBzaXMubXVsdGlwbGUuc3RyaW5ncy5zdWZmaXggPSB0aGlzLmVsbGlwc2lzX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBzdGF0ZS50bXBbXCJldC1hbC1taW5cIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtbWluXCJdID0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImV0LWFsLW1pblwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBzdGF0ZS50bXBbXCJldC1hbC11c2UtZmlyc3RcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWZpcnN0XCJdID0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImV0LWFsLXVzZS1maXJzdFwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBzdGF0ZS50bXBbXCJldC1hbC11c2UtbGFzdFwiXSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXBbXCJldC1hbC11c2UtbGFzdFwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtbGFzdFwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5uYW1lID0gdGhpcztcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5uYW1lX2ZsYWcgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB9XG4gICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlW1wibmFtZS1wYXJ0XCJdID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICBzdGF0ZS5idWlsZFt0aGlzLnN0cmluZ3MubmFtZV0gPSB0aGlzO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlLm5hbWVzID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB2YXIgZnVuYywgbGVuLCBwb3MsIGF0dHJuYW1lO1xuICAgICAgICB2YXIgZGVidWcgPSBmYWxzZTtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQgfHwgdGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pIHtcbiAgICAgICAgICAgIENTTC5VdGlsLnN1YnN0aXR1dGVTdGFydC5jYWxsKHRoaXMsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuc3Vic3RpdHV0ZV9sZXZlbC5wdXNoKDEpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNJTkdMRVRPTikge1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZXNfdmFyaWFibGVzLnB1c2godGhpcy52YXJpYWJsZXMpO1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIHZhciBsYWJlbFZhcmlhYmxlID0gc3RhdGUubmFtZU91dHB1dC5sYWJlbFZhcmlhYmxlO1xuICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQucmVpbml0KHRoaXMsIGxhYmVsVmFyaWFibGUpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TVEFSVCkge1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZXNfZmxhZyA9IHRydWU7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5uYW1lc19sZXZlbCArPSAxO1xuICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLm5hbWVzX2xldmVsID09PSAxKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZXNfdmFyaWFibGVzID0gW107XG4gICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZV9sYWJlbCA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZXNfdmFyaWFibGVzLnB1c2godGhpcy52YXJpYWJsZXMpO1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS5wdXNoKHRydWUpO1xuICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLlN0YXJ0VmFyaWFibGUoXCJuYW1lc1wiLHRoaXMudmFyaWFibGVzWzBdKTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lT3V0cHV0LmluaXQodGhpcyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLkVORCkge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSAzOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgdmFyIGtleSA9IFtcImZhbWlseVwiLCBcImdpdmVuXCIsIFwiZXQtYWxcIl1baV07XG4gICAgICAgICAgICAgICAgdGhpc1trZXldID0gc3RhdGUuYnVpbGRba2V5XTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuYnVpbGQubmFtZXNfbGV2ZWwgPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYnVpbGRba2V5XSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmxhYmVsID0gc3RhdGUuYnVpbGQubmFtZV9sYWJlbDtcbiAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5uYW1lc19sZXZlbCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVfbGFiZWwgPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVzX2xldmVsICs9IC0xO1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZXNfdmFyaWFibGVzLnBvcCgpO1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZXRhbF9ub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9zdHlsZSA9IHN0YXRlLnRtcC5ldGFsX25vZGU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldGFsX3N0eWxlID0gXCJlbXB0eVwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfdGVybSA9IHN0YXRlLmdldFRlcm0oc3RhdGUudG1wLmV0YWxfdGVybSwgXCJsb25nXCIsIDApO1xuICAgICAgICAgICAgICAgIGlmIChDU0wuU1RBUlRTV0lUSF9ST01BTkVTUVVFX1JFR0VYUC50ZXN0KHRoaXMuZXRhbF90ZXJtKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV0YWxfcHJlZml4X3NpbmdsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV0YWxfcHJlZml4X211bHRpcGxlID0gc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wW1wiZGVsaW1pdGVyLXByZWNlZGVzLWV0LWFsXCJdID09PSBcImFsd2F5c1wiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV0YWxfcHJlZml4X3NpbmdsZSA9IHN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS50bXBbXCJkZWxpbWl0ZXItcHJlY2VkZXMtZXQtYWxcIl0gPT09IFwibmV2ZXJcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldGFsX3ByZWZpeF9tdWx0aXBsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnRtcFtcImRlbGltaXRlci1wcmVjZWRlcy1ldC1hbFwiXSA9PT0gXCJhZnRlci1pbnZlcnRlZC1uYW1lXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9wcmVmaXhfc2luZ2xlID0gc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldGFsX3ByZWZpeF9tdWx0aXBsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9zdWZmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9wcmVmaXhfc2luZ2xlID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldGFsX3ByZWZpeF9tdWx0aXBsZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9zdWZmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IDM7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IFtcImZhbWlseVwiLCBcImdpdmVuXCJdW2ldO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lT3V0cHV0W2tleV0gPSB0aGlzW2tleV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXRbXCJ3aXRoXCJdID0gdGhpc1tcIndpdGhcIl07XG4gICAgICAgICAgICAgICAgdmFyIG15d2l0aCA9IFwid2l0aFwiO1xuICAgICAgICAgICAgICAgIHZhciB3aXRoX2RlZmF1bHRfcHJlZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICB2YXIgd2l0aF9zdWZmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgIGlmIChDU0wuU1RBUlRTV0lUSF9ST01BTkVTUVVFX1JFR0VYUC50ZXN0KG15d2l0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgd2l0aF9kZWZhdWx0X3ByZWZpeCA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB3aXRoX3N1ZmZpeCA9IFwiIFwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgdGhld2l0aCA9IHt9O1xuICAgICAgICAgICAgICAgIHRoZXdpdGguc2luZ2xlID0gbmV3IENTTC5CbG9iKG15d2l0aCk7XG4gICAgICAgICAgICAgICAgdGhld2l0aC5zaW5nbGUuc3RyaW5ncy5zdWZmaXggPSB3aXRoX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICB0aGV3aXRoLm11bHRpcGxlID0gbmV3IENTTC5CbG9iKG15d2l0aCk7XG4gICAgICAgICAgICAgICAgdGhld2l0aC5tdWx0aXBsZS5zdHJpbmdzLnN1ZmZpeCA9IHdpdGhfc3VmZml4O1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5pbmhlcml0T3B0KHN0YXRlLm5hbWVPdXRwdXQubmFtZSwgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiKSA9PT0gXCJhbHdheXNcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGV3aXRoLnNpbmdsZS5zdHJpbmdzLnByZWZpeCA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXJcIiwgXCJuYW1lcy1kZWxpbWl0ZXJcIik7XG4gICAgICAgICAgICAgICAgICAgIHRoZXdpdGgubXVsdGlwbGUuc3RyaW5ncy5wcmVmaXggPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZGVsaW1pdGVyXCIsIFwibmFtZXMtZGVsaW1pdGVyXCIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUuaW5oZXJpdE9wdChzdGF0ZS5uYW1lT3V0cHV0Lm5hbWUsIFwiZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIikgPT09IFwiY29udGV4dHVhbFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoZXdpdGguc2luZ2xlLnN0cmluZ3MucHJlZml4ID0gd2l0aF9kZWZhdWx0X3ByZWZpeDtcbiAgICAgICAgICAgICAgICAgICAgdGhld2l0aC5tdWx0aXBsZS5zdHJpbmdzLnByZWZpeCA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXJcIiwgXCJuYW1lcy1kZWxpbWl0ZXJcIik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5pbmhlcml0T3B0KHN0YXRlLm5hbWVPdXRwdXQubmFtZSwgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiKSA9PT0gXCJhZnRlci1pbnZlcnRlZC1uYW1lXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhld2l0aC5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZGVsaW1pdGVyXCIsIFwibmFtZXMtZGVsaW1pdGVyXCIpO1xuICAgICAgICAgICAgICAgICAgICB0aGV3aXRoLm11bHRpcGxlLnN0cmluZ3MucHJlZml4ID0gd2l0aF9kZWZhdWx0X3ByZWZpeDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGV3aXRoLnNpbmdsZS5zdHJpbmdzLnByZWZpeCA9IHdpdGhfZGVmYXVsdF9wcmVmaXg7XG4gICAgICAgICAgICAgICAgICAgIHRoZXdpdGgubXVsdGlwbGUuc3RyaW5ncy5wcmVmaXggPSB3aXRoX2RlZmF1bHRfcHJlZml4O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lT3V0cHV0W1wid2l0aFwiXSA9IHRoZXdpdGg7XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5sYWJlbCA9IHRoaXMubGFiZWw7XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5ldGFsX3N0eWxlID0gdGhpcy5ldGFsX3N0eWxlO1xuICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQuZXRhbF90ZXJtID0gdGhpcy5ldGFsX3Rlcm07XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5ldGFsX3ByZWZpeF9zaW5nbGUgPSB0aGlzLmV0YWxfcHJlZml4X3NpbmdsZTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lT3V0cHV0LmV0YWxfcHJlZml4X211bHRpcGxlID0gdGhpcy5ldGFsX3ByZWZpeF9tdWx0aXBsZTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lT3V0cHV0LmV0YWxfc3VmZml4ID0gdGhpcy5ldGFsX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lT3V0cHV0Lm91dHB1dE5hbWVzKCk7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWZpcnN0XCJdID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcFtcImV0LWFsLW1pblwiXSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXBbXCJldC1hbC11c2UtbGFzdFwiXSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAuY2FuX3N1YnN0aXR1dGUucG9wKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmNhbl9zdWJzdGl0dXRlLnJlcGxhY2UoZmFsc2UsIENTTC5MSVRFUkFMKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwuQ2xvc2VWYXJpYWJsZShcIm5hbWVzXCIpO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY2FuX3N1YnN0aXR1dGUubXlzdGFjay5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmNhbl9ibG9ja19zdWJzdGl0dXRlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVfZmxhZyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQgfHwgdGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLnN1YnN0aXR1dGVfbGV2ZWwucG9wKCk7XG4gICAgICAgICAgICBDU0wuVXRpbC5zdWJzdGl0dXRlRW5kLmNhbGwodGhpcywgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5udW1iZXIgPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIHZhciBmdW5jO1xuICAgICAgICBDU0wuVXRpbC5zdWJzdGl0dXRlU3RhcnQuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgaWYgKHRoaXMuc3RyaW5ncy5mb3JtID09PSBcInJvbWFuXCIpIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybWF0dGVyID0gc3RhdGUuZnVuLnJvbWFuaXplcjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0cmluZ3MuZm9ybSA9PT0gXCJvcmRpbmFsXCIpIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybWF0dGVyID0gc3RhdGUuZnVuLm9yZGluYWxpemVyO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RyaW5ncy5mb3JtID09PSBcImxvbmctb3JkaW5hbFwiKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1hdHRlciA9IHN0YXRlLmZ1bi5sb25nX29yZGluYWxpemVyO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5zdWNjZXNzb3JfcHJlZml4KSB7XG4gICAgICAgICAgICB0aGlzLnN1Y2Nlc3Nvcl9wcmVmaXggPSBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubGF5b3V0X2RlbGltaXRlcjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMuc3BsaWNlX3ByZWZpeCkge1xuICAgICAgICAgICAgdGhpcy5zcGxpY2VfcHJlZml4ID0gc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LmxheW91dF9kZWxpbWl0ZXI7XG4gICAgICAgIH1cbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgdmFyIGksIGlsZW4sIG5ld2xzdCwgbHN0O1xuICAgICAgICAgICAgaWYgKHRoaXMudmFyaWFibGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgaXRlbSkge1xuICAgICAgICAgICAgICAgIHZhciBpdGVtID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgdmFybmFtZSwgbnVtLCBudW1iZXIsIG0sIGosIGpsZW47XG4gICAgICAgICAgICB2YXJuYW1lID0gdGhpcy52YXJpYWJsZXNbMF07XG4gICAgICAgICAgICBpZiAodmFybmFtZSA9PT0gXCJsb2NhdG9yXCIgJiYgc3RhdGUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLlN0YXJ0VmFyaWFibGUodGhpcy52YXJpYWJsZXNbMF0pO1xuICAgICAgICAgICAgaWYgKHRoaXMudmFyaWFibGVzWzBdID09PSBcImxvY2F0b3JcIikge1xuICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkFwcGVuZFRvVmFyaWFibGUoSXRlbS5zZWN0aW9uKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwuQXBwZW5kVG9WYXJpYWJsZShJdGVtW3RoaXMudmFyaWFibGVzWzBdXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgcmV4ID0gbmV3IFJlZ0V4cChcIig/OiZ8LCB8IGFuZCB8XCIgKyBzdGF0ZS5nZXRUZXJtKFwicGFnZS1yYW5nZS1kZWxpbWl0ZXJcIikgKyBcIilcIik7XG4gICAgICAgICAgICBpZiAodmFybmFtZSA9PT0gJ2NvbGxlY3Rpb24tbnVtYmVyJyAmJiBJdGVtLnR5cGUgPT09ICdsZWdhbF9jYXNlJykge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5yZW5kZXJzX2NvbGxlY3Rpb25fbnVtYmVyID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IEl0ZW1bdGhpcy52YXJpYWJsZXNbMF1dO1xuICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzO1xuICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5mb3JjZV9zdXBwcmVzcykge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh2YXJuYW1lID09PSBcImxvY2F0b3JcIikge1xuICAgICAgICAgICAgICAgIHN0YXRlLnByb2Nlc3NOdW1iZXIobm9kZSwgaXRlbSwgdmFybmFtZSwgSXRlbS50eXBlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuY29uZGl0aW9uICYmIEl0ZW1bdmFybmFtZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmp1c3RfZGlkX251bWJlciA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLnByb2Nlc3NOdW1iZXIobm9kZSwgSXRlbSwgdmFybmFtZSwgSXRlbS50eXBlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIENTTC5VdGlsLm91dHB1dE51bWVyaWNGaWVsZChzdGF0ZSwgdmFybmFtZSwgSXRlbS5pZCk7XG4gICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5DbG9zZVZhcmlhYmxlKFwibnVtYmVyXCIpO1xuICAgICAgICAgICAgaWYgKFtcImxvY2F0b3JcIiwgXCJsb2NhdG9yLWV4dHJhXCJdLmluZGV4T2YodGhpcy52YXJpYWJsZXNfcmVhbFswXSkgPiAtMVxuICAgICAgICAgICAgICAgJiYgIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZG9uZV92YXJzLnB1c2godGhpcy52YXJpYWJsZXNfcmVhbFswXSk7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmRvbmVfdmFycy5wdXNoKHRoaXMudmFyaWFibGVzX3JlYWxbMF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgICAgICBDU0wuVXRpbC5zdWJzdGl0dXRlRW5kLmNhbGwodGhpcywgc3RhdGUsIHRhcmdldCk7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUuc29ydCA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgdGFyZ2V0ID0gc3RhdGVbc3RhdGUuYnVpbGQucm9vdCArIFwiX3NvcnRcIl0udG9rZW5zO1xuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TVEFSVCkge1xuICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmFyZWEgPT09IFwiY2l0YXRpb25cIikge1xuICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vcHQuc29ydF9jaXRhdGlvbnMgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGUuYnVpbGQuYXJlYSA9IHN0YXRlLmJ1aWxkLnJvb3QgKyBcIl9zb3J0XCI7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5leHRlbnNpb24gPSBcIl9zb3J0XCI7XG4gICAgICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5vcHQuaGFzX2xheW91dF9sb2NhbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGxhbmdzcGVjID0gQ1NMLmxvY2FsZVJlc29sdmUoSXRlbS5sYW5ndWFnZSwgc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0pO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc29ydF9sb2NhbGVzID0gc3RhdGVbc3RhdGUudG1wLmFyZWEuc2xpY2UoMCwtNSldLm9wdC5zb3J0X2xvY2FsZXM7XG4gICAgICAgICAgICAgICAgICAgIHZhciBsYW5nRm9ySXRlbTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49c29ydF9sb2NhbGVzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFuZ0Zvckl0ZW0gPSBzb3J0X2xvY2FsZXNbaV1bbGFuZ3NwZWMuYmFyZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxhbmdGb3JJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFuZ0Zvckl0ZW0gPSBzb3J0X2xvY2FsZXNbaV1bbGFuZ3NwZWMuYmVzdF07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFuZ0Zvckl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIWxhbmdGb3JJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYW5nRm9ySXRlbSA9IHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5sYW5nX3NvcnRfaG9sZCA9IHN0YXRlLm9wdC5sYW5nO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vcHQubGFuZyA9IGxhbmdGb3JJdGVtO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQpIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmFyZWEgPSBzdGF0ZS5idWlsZC5yb290O1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuZXh0ZW5zaW9uID0gXCJcIjtcbiAgICAgICAgICAgIHZhciBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5oYXNfbGF5b3V0X2xvY2FsZSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vcHQubGFuZyA9IHN0YXRlLnRtcC5sYW5nX3NvcnRfaG9sZDtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnRtcC5sYW5nX3NvcnRfaG9sZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIH1cbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUuc3Vic3RpdHV0ZSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgdmFyIGZ1bmM7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmNhbl9ibG9ja19zdWJzdGl0dXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLnZhbHVlLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuY2FuX3N1YnN0aXR1dGUucmVwbGFjZShmYWxzZSwgQ1NMLkxJVEVSQUwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIH1cbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUudGV4dCA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgdmFyIHZhcmlhYmxlLCBmdW5jLCBmb3JtLCBwbHVyYWwsIGlkLCBudW0sIG51bWJlciwgZm9ybWF0dGVyLCBmaXJzdG91dHB1dCwgc3BlY2lhbGRlbGltaXRlciwgbGFiZWwsIG15bmFtZSwgbmFtZXMsIG5hbWUsIHllYXIsIHN1ZmZpeCwgdGVybSwgZHAsIGxlbiwgcG9zLCBuLCBtLCB2YWx1ZSwgZmxhZztcbiAgICAgICAgaWYgKHRoaXMucG9zdHBvbmVkX21hY3JvKSB7XG4gICAgICAgICAgICB2YXIgZ3JvdXBfc3RhcnQgPSBDU0wuVXRpbC5jbG9uZVRva2VuKHRoaXMpO1xuICAgICAgICAgICAgZ3JvdXBfc3RhcnQubmFtZSA9IFwiZ3JvdXBcIjtcbiAgICAgICAgICAgIGdyb3VwX3N0YXJ0LnRva2VudHlwZSA9IENTTC5TVEFSVDtcbiAgICAgICAgICAgIENTTC5Ob2RlLmdyb3VwLmJ1aWxkLmNhbGwoZ3JvdXBfc3RhcnQsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgQ1NMLmV4cGFuZE1hY3JvLmNhbGwoc3RhdGUsIHRoaXMsIHRhcmdldCk7XG4gICAgICAgICAgICB2YXIgZ3JvdXBfZW5kID0gQ1NMLlV0aWwuY2xvbmVUb2tlbih0aGlzKTtcbiAgICAgICAgICAgIGdyb3VwX2VuZC5uYW1lID0gXCJncm91cFwiO1xuICAgICAgICAgICAgZ3JvdXBfZW5kLnRva2VudHlwZSA9IENTTC5FTkQ7XG4gICAgICAgICAgICBpZiAodGhpcy5wb3N0cG9uZWRfbWFjcm8gPT09ICdqdXJpcy1sb2NhdG9yLWxhYmVsJykge1xuICAgICAgICAgICAgICAgIGdyb3VwX2VuZC5pc0p1cmlzTG9jYXRvckxhYmVsID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIENTTC5Ob2RlLmdyb3VwLmJ1aWxkLmNhbGwoZ3JvdXBfZW5kLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIENTTC5VdGlsLnN1YnN0aXR1dGVTdGFydC5jYWxsKHRoaXMsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgaWYgKCF0aGlzLnZhcmlhYmxlc19yZWFsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy52YXJpYWJsZXNfcmVhbCA9IFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF0aGlzLnZhcmlhYmxlcykge1xuICAgICAgICAgICAgICAgIHRoaXMudmFyaWFibGVzID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3JtID0gXCJsb25nXCI7XG4gICAgICAgICAgICBwbHVyYWwgPSAwO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RyaW5ncy5mb3JtKSB7XG4gICAgICAgICAgICAgICAgZm9ybSA9IHRoaXMuc3RyaW5ncy5mb3JtO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuc3RyaW5ncy5wbHVyYWwpIHtcbiAgICAgICAgICAgICAgICBwbHVyYWwgPSB0aGlzLnN0cmluZ3MucGx1cmFsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKFwiY2l0YXRpb24tbnVtYmVyXCIgPT09IHRoaXMudmFyaWFibGVzX3JlYWxbMF0gfHwgXCJ5ZWFyLXN1ZmZpeFwiID09PSB0aGlzLnZhcmlhYmxlc19yZWFsWzBdIHx8IFwiY2l0YXRpb24tbGFiZWxcIiA9PT0gdGhpcy52YXJpYWJsZXNfcmVhbFswXSkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlc19yZWFsWzBdID09PSBcImNpdGF0aW9uLW51bWJlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5yb290ID09PSBcImNpdGF0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC51cGRhdGVfbW9kZSA9IENTTC5OVU1FUklDO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5yb290ID09PSBcImJpYmxpb2dyYXBoeVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vcHQuYmliX21vZGUgPSBDU0wuTlVNRVJJQztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuYnVpbGQuYXJlYSA9PT0gXCJiaWJsaW9ncmFwaHlfc29ydFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnRfdXNlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKFwiY2l0YXRpb24tbnVtYmVyXCIgPT09IHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQuY29sbGFwc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmFuZ2VfcHJlZml4ID0gc3RhdGUuZ2V0VGVybShcImNpdGF0aW9uLXJhbmdlLWRlbGltaXRlclwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnN1Y2Nlc3Nvcl9wcmVmaXggPSBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubGF5b3V0X2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zcGxpY2VfcHJlZml4ID0gc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LmxheW91dF9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkID0gXCJcIiArIEl0ZW0uaWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtW1wiYXV0aG9yLW9ubHlcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmVsZW1lbnRfdHJhY2UucmVwbGFjZShcImRvLW5vdC1zdXBwcmVzcy1tZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZmVyZW5jZV90ZXJtID0gc3RhdGUuZ2V0VGVybShcInJlZmVyZW5jZVwiLCBcImxvbmdcIiwgXCJzaW5ndWxhclwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiByZWZlcmVuY2VfdGVybSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlX3Rlcm0gPSBcInJlZmVyZW5jZVwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlcm0gPSBDU0wuT3V0cHV0LkZvcm1hdHRlcnNbXCJjYXBpdGFsaXplLWZpcnN0XCJdKHN0YXRlLCByZWZlcmVuY2VfdGVybSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodGVybSArIFwiIFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmxhc3RfZWxlbWVudF90cmFjZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW1bXCJzdXBwcmVzcy1hdXRob3JcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5sYXN0X2VsZW1lbnRfdHJhY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5lbGVtZW50X3RyYWNlLnJlcGxhY2UoXCJzdXBwcmVzcy1tZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAubGFzdF9lbGVtZW50X3RyYWNlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9IHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2lkXS5zZXE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5jaXRhdGlvbl9udW1iZXJfc2x1Zykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHN0YXRlLm9wdC5jaXRhdGlvbl9udW1iZXJfc2x1ZywgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyID0gbmV3IENTTC5OdW1lcmljQmxvYihmYWxzZSwgbnVtLCB0aGlzLCBJdGVtLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5pbl9jaXRlX3ByZWRlY2Vzc29yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlci5zdXBwcmVzc19zcGxpY2VfcHJlZml4ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKG51bWJlciwgXCJsaXRlcmFsXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy52YXJpYWJsZXNfcmVhbFswXSA9PT0gXCJ5ZWFyLXN1ZmZpeFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5oYXNfeWVhcl9zdWZmaXggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdC5jb2xsYXBzZSA9PT0gXCJ5ZWFyLXN1ZmZpeC1yYW5nZWRcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yYW5nZV9wcmVmaXggPSBzdGF0ZS5nZXRUZXJtKFwiY2l0YXRpb24tcmFuZ2UtZGVsaW1pdGVyXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3VjY2Vzc29yX3ByZWZpeCA9IHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5sYXlvdXRfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdFtcInllYXItc3VmZml4LWRlbGltaXRlclwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWNjZXNzb3JfcHJlZml4ID0gc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0W1wieWVhci1zdWZmaXgtZGVsaW1pdGVyXCJdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXSAmJiBzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy55ZWFyX3N1ZmZpeCAhPT0gZmFsc2UgJiYgIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW0gPSBwYXJzZUludChzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy55ZWFyX3N1ZmZpeCwgMTApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3VjY2Vzc29yX3ByZWZpeCA9IHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlciA9IG5ldyBDU0wuTnVtZXJpY0Jsb2IoZmFsc2UsIG51bSwgdGhpcywgSXRlbS5pZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyID0gbmV3IENTTC5VdGlsLlN1ZmZpeGF0b3IoQ1NMLlNVRkZJWF9DSEFSUyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLnNldEZvcm1hdHRlcihmb3JtYXR0ZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQobnVtYmVyLCBcImxpdGVyYWxcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RvdXRwdXQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1zdGF0ZS50bXAuZ3JvdXBfY29udGV4dC5teXN0YWNrLmxlbmd0aDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZsYWdzID0gc3RhdGUudG1wLmdyb3VwX2NvbnRleHQubXlzdGFja1tpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmbGFncy52YXJpYWJsZV9zdWNjZXNzICYmIChmbGFncy52YXJpYWJsZV9hdHRlbXB0IHx8ICghZmxhZ3MudmFyaWFibGVfYXR0ZW1wdCAmJiAhZmxhZ3MudGVybV9pbnRlbmRlZCkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdG91dHB1dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWFsZGVsaW1pdGVyID0gc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdFtcInllYXItc3VmZml4LWRlbGltaXRlclwiXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3RvdXRwdXQgJiYgc3BlY2lhbGRlbGltaXRlciAmJiAhc3RhdGUudG1wLnNvcnRfa2V5X2ZsYWcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSBzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0W1wieWVhci1zdWZmaXgtZGVsaW1pdGVyXCJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy52YXJpYWJsZXNfcmVhbFswXSA9PT0gXCJjaXRhdGlvbi1sYWJlbFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5oYXNfeWVhcl9zdWZmaXggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IEl0ZW1bXCJjaXRhdGlvbi1sYWJlbFwiXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGFiZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IHN0YXRlLmdldENpdGF0aW9uTGFiZWwoSXRlbSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXSAmJiBzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy55ZWFyX3N1ZmZpeCAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtID0gcGFyc2VJbnQoc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcueWVhcl9zdWZmaXgsIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VmZml4ID0gc3RhdGUuZnVuLnN1ZmZpeGF0b3IuZm9ybWF0KG51bSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsICs9IHN1ZmZpeDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQobGFiZWwsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJpbmdzLnRlcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdlbmRlciA9IHN0YXRlLm9wdC5nZW5kZXJbSXRlbS50eXBlXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXJtID0gdGhpcy5zdHJpbmdzLnRlcm07XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXJtID0gc3RhdGUuZ2V0VGVybSh0ZXJtLCBmb3JtLCBwbHVyYWwsIGdlbmRlciwgQ1NMLlRPTEVSQU5ULCB0aGlzLmRlZmF1bHRfbG9jYWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBteXRlcm07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVybSAhPT0gXCJcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC50ZXJtX2ludGVuZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIENTTC5VUERBVEVfR1JPVVBfQ09OVEVYVF9DT05ESVRJT04oc3RhdGUsIHRlcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAudGVybV9wcmVkZWNlc3NvciAmJiAhKHN0YXRlLm9wdFtcImNsYXNzXCJdID09PSBcImluLXRleHRcIiAmJiBzdGF0ZS50bXAuYXJlYSA9PT0gXCJjaXRhdGlvblwiKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15dGVybSA9IENTTC5PdXRwdXQuRm9ybWF0dGVyc1tcImNhcGl0YWxpemUtZmlyc3RcIl0oc3RhdGUsIHRlcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBteXRlcm0gPSB0ZXJtO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5zdHJpcF9wZXJpb2RzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXl0ZXJtID0gbXl0ZXJtLnJlcGxhY2UoL1xcLi9nLCBcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLmRlY29yYXRpb25zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJAc3RyaXAtcGVyaW9kc1wiID09PSB0aGlzLmRlY29yYXRpb25zW2ldWzBdICYmIFwidHJ1ZVwiID09PSB0aGlzLmRlY29yYXRpb25zW2ldWzFdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteXRlcm0gPSBteXRlcm0ucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKG15dGVybSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQudGVybSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC5mb3JtID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLnBsdXJhbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy52YXJpYWJsZXNfcmVhbC5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmFyaWFibGVzX3JlYWxbMF0gIT09IFwibG9jYXRvclwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmhhdmVfY29sbGFwc2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyYWxsZWxfdmFyaWFibGUgPSB0aGlzLnZhcmlhYmxlc1swXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbGxlbF92YXJpYWJsZSA9PT0gXCJ0aXRsZVwiIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIChmb3JtID09PSBcInNob3J0XCIgfHwgSXRlbVtcInRpdGxlLXNob3J0XCJdKSkgeyBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbGxlbF92YXJpYWJsZSA9IFwidGl0bGUtc2hvcnRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLlN0YXJ0VmFyaWFibGUocGFyYWxsZWxfdmFyaWFibGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwuQXBwZW5kVG9WYXJpYWJsZShJdGVtW3BhcmFsbGVsX3ZhcmlhYmxlXSxwYXJhbGxlbF92YXJpYWJsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24gJiYgSXRlbVt0aGlzLnZhcmlhYmxlc1swXV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuanVzdF9kaWRfbnVtYmVyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKENTTC5NVUxUSV9GSUVMRFMuaW5kZXhPZih0aGlzLnZhcmlhYmxlc19yZWFsWzBdKSA+IC0xXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCBbXCJsYW5ndWFnZS1uYW1lXCIsIFwibGFuZ3VhZ2UtbmFtZS1vcmlnaW5hbFwiXS5pbmRleE9mKHRoaXMudmFyaWFibGVzX3JlYWxbMF0pID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhYmJyZXZmYW0gPSB0aGlzLnZhcmlhYmxlc1swXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhYmJyZmFsbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFsdHZhciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyYW5zZmFsbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm0gPT09IFwic2hvcnRcIiB8fCBbXCJjb3VudHJ5XCIsIFwianVyaXNkaWN0aW9uXCJdLmluZGV4T2YodGhpcy52YXJpYWJsZXNfcmVhbFswXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlc19yZWFsWzBdID09PSBcImNvbnRhaW5lci10aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsdHZhciA9IFwiam91cm5hbEFiYnJldmlhdGlvblwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy52YXJpYWJsZXNfcmVhbFswXSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsdHZhciA9IFwidGl0bGUtc2hvcnRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFiYnJldmZhbSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmV4dGVuc2lvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zZmFsbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zZmFsbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWJicmZhbGwgPSB0cnVlO1xuXHRcdFx0XHRcdFx0fVxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyA9IHN0YXRlLnRyYW5zZm9ybS5nZXRPdXRwdXRGdW5jdGlvbih0aGlzLnZhcmlhYmxlcywgYWJicmV2ZmFtLCBhYmJyZmFsbCwgYWx0dmFyLCB0cmFuc2ZhbGwpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKENTTC5DSVRFX0ZJRUxEUy5pbmRleE9mKHRoaXMudmFyaWFibGVzX3JlYWxbMF0pID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW1bdGhpcy52YXJpYWJsZXNbMF1dKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wcm9jZXNzTnVtYmVyKHRoaXMsIGl0ZW0sIHRoaXMudmFyaWFibGVzWzBdLCBJdGVtLnR5cGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLlV0aWwub3V0cHV0TnVtZXJpY0ZpZWxkKHN0YXRlLCB0aGlzLnZhcmlhYmxlc1swXSwgSXRlbS5pZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoW1wibG9jYXRvclwiLCBcImxvY2F0b3ItZXh0cmFcIl0uaW5kZXhPZih0aGlzLnZhcmlhYmxlc19yZWFsWzBdKSA+IC0xXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAhc3RhdGUudG1wLmp1c3RfbG9va2luZykgeyBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZG9uZV92YXJzLnB1c2godGhpcy52YXJpYWJsZXNfcmVhbFswXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlICBpZiAoW1wicGFnZVwiLCBcInBhZ2UtZmlyc3RcIiwgXCJjaGFwdGVyLW51bWJlclwiLCBcImNvbGxlY3Rpb24tbnVtYmVyXCIsIFwiZWRpdGlvblwiLCBcImlzc3VlXCIsIFwibnVtYmVyXCIsIFwibnVtYmVyLW9mLXBhZ2VzXCIsIFwibnVtYmVyLW9mLXZvbHVtZXNcIiwgXCJ2b2x1bWVcIl0uaW5kZXhPZih0aGlzLnZhcmlhYmxlc19yZWFsWzBdKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnByb2Nlc3NOdW1iZXIodGhpcywgSXRlbSwgdGhpcy52YXJpYWJsZXNbMF0sIEl0ZW0udHlwZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENTTC5VdGlsLm91dHB1dE51bWVyaWNGaWVsZChzdGF0ZSwgdGhpcy52YXJpYWJsZXNbMF0sIEl0ZW0uaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoW1wiVVJMXCIsIFwiRE9JXCJdLmluZGV4T2YodGhpcy52YXJpYWJsZXNfcmVhbFswXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52YXJpYWJsZXNbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gc3RhdGUuZ2V0VmFyaWFibGUoSXRlbSwgdGhpcy52YXJpYWJsZXNbMF0sIGZvcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLndyYXBfdXJsX2FuZF9kb2kpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmRlY29yYXRpb25zLmxlbmd0aCB8fCB0aGlzLmRlY29yYXRpb25zWzBdWzBdICE9PSBcIkBcIiArIHRoaXMudmFyaWFibGVzWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52YXJpYWJsZXNfcmVhbFswXSA9PT0gXCJET0lcIiAmJiB0aGlzLnN0cmluZ3MucHJlZml4ID09PSBcImh0dHBzOi8vZG9pLm9yZy9cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZXRva2VuID0gQ1NMLlV0aWwuY2xvbmVUb2tlbih0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JvdXBibG9iID0gbmV3IENTTC5CbG9iKG51bGwsIG51bGwsIFwidXJsLXdyYXBwZXJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBibG9iLmRlY29yYXRpb25zLnB1c2goW1wiQERPSVwiLCBcInRydWVcIl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvXmh0dHBzPzpcXC9cXC9kb2lcXC5vcmdcXC8vLCBcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUubWF0Y2goL15odHRwcz86XFwvXFwvLykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZWZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZWZpeCA9IFwiaHR0cHM6Ly9kb2kub3JnL1wiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJlZml4YmxvYiA9IG5ldyBDU0wuQmxvYihwcmVmaXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZWJsb2IgPSBuZXcgQ1NMLkJsb2IodmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb25ldG9rZW4uc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwYmxvYi5wdXNoKHByZWZpeGJsb2IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwYmxvYi5wdXNoKHZhbHVlYmxvYik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZChncm91cGJsb2IsIGNsb25ldG9rZW4sIGZhbHNlLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSBbW1wiQFwiICsgdGhpcy52YXJpYWJsZXNbMF0sIFwidHJ1ZVwiXV0uY29uY2F0KHRoaXMuZGVjb3JhdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodmFsdWUsIHRoaXMsIGZhbHNlLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHZhbHVlLCB0aGlzLCBmYWxzZSwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVjb3JhdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpPXRoaXMuZGVjb3JhdGlvbnMubGVuZ3RoLTE7IGk+LTE7IGktLSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlY29yYXRpb25zW2ldWzBdID09PSBcIkBcIiArIHRoaXMudmFyaWFibGVzWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSB0aGlzLmRlY29yYXRpb25zLnNsaWNlKDAsIGkpLmNvbmNhdCh0aGlzLmRlY29yYXRpb25zLnNsaWNlKGkrMSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHZhbHVlLCB0aGlzLCBmYWxzZSwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudmFyaWFibGVzX3JlYWxbMF0gPT09IFwic2VjdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gc3RhdGUuZ2V0VmFyaWFibGUoSXRlbSwgdGhpcy52YXJpYWJsZXNbMF0sIGZvcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodmFsdWUsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy52YXJpYWJsZXNfcmVhbFswXSA9PT0gXCJoZXJlaW5hZnRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBzdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tcImRlZmF1bHRcIl1bXCJoZXJlaW5hZnRlclwiXVtJdGVtLmlkXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHZhbHVlLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlc1swXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZS5nZXRWYXJpYWJsZShJdGVtLCB0aGlzLnZhcmlhYmxlc1swXSwgZm9ybSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IFwiXCIgKyB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnNwbGl0KFwiXFxcXFwiKS5qb2luKFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodmFsdWUsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkNsb3NlVmFyaWFibGUoXCJ0ZXh0XCIpO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0cmluZ3MudmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnRlcm1faW50ZW5kZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLlVQREFURV9HUk9VUF9DT05URVhUX0NPTkRJVElPTihzdGF0ZSwgdGhpcy5zdHJpbmdzLnZhbHVlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodGhpcy5zdHJpbmdzLnZhbHVlLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgICAgICAgICAgQ1NMLlV0aWwuc3Vic3RpdHV0ZUVuZC5jYWxsKHRoaXMsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkF0dHJpYnV0ZXMgPSB7fTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGdlbnJlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBhcmcgPSBhcmcucmVwbGFjZShcIi1cIiwgXCIgXCIpO1xuICAgIHZhciBmdW5jID0gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgdmFyIHJldDtcbiAgICAgICAgaWYgKGFyZyA9PT0gSXRlbS5nZW5yZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLnRlc3RzLnB1c2goZnVuYyk7XG59XG5DU0wuQXR0cmlidXRlc1tcIkBkaXNhbWJpZ3VhdGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcgPT09IFwidHJ1ZVwiKSB7XG4gICAgICAgIHN0YXRlLm9wdC5oYXNfZGlzYW1iaWd1YXRlID0gdHJ1ZTtcbiAgICAgICAgdmFyIGZ1bmMgPSBmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5hcmVhID09PSBcImJpYmxpb2dyYXBoeVwiKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kaXNhbWJpZ3VhdGVfY291bnQgPCBzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5kaXNhbWJpZ3VhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRpc2FtYmlndWF0ZV9jb3VudCArPSAxO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5kaXNhbWJpZ3VhdGVfbWF4TWF4ICs9IDE7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5kaXNhbWJpZ3VhdGVcbiAgICAgICAgICAgICAgICAgICAgJiYgc3RhdGUudG1wLmRpc2FtYmlndWF0ZV9jb3VudCA8IHN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5kaXNhbWJpZ3VhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRpc2FtYmlndWF0ZV9jb3VudCArPSAxO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMudGVzdHMucHVzaChmdW5jKTtcbiAgICB9IGVsc2UgaWYgKGFyZyA9PT0gXCJjaGVjay1hbWJpZ3VpdHktYW5kLWJhY2tyZWZlcmVuY2VcIikge1xuICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZGlzYW1iaWd1YXRlICYmIHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdW1wiY2l0YXRpb24tY291bnRcIl0gPiAxKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMudGVzdHMucHVzaChmdW5jKTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaXMtbnVtZXJpY1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnLCBqb2luZXIpIHtcbiAgICB2YXIgdmFyaWFibGVzID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24odmFyaWFibGUpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICB2YXIgbXlpdGVtID0gSXRlbTtcbiAgICAgICAgICAgIGlmIChbXCJsb2NhdG9yXCIsXCJsb2NhdG9yLWV4dHJhXCJdLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBteWl0ZW0gPSBpdGVtO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBteWl0ZW0pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoQ1NMLk5VTUVSSUNfVkFSSUFCTEVTLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5zaGFkb3dfbnVtYmVyc1t2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUucHJvY2Vzc051bWJlcihmYWxzZSwgbXlpdGVtLCB2YXJpYWJsZSwgSXRlbS50eXBlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG15aXRlbVt2YXJpYWJsZV0gJiYgc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW3ZhcmlhYmxlXS5udW1lcmljKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoW1widGl0bGVcIiwgXCJsb2NhdG9yLWV4dHJhXCIsXCJ2ZXJzaW9uXCJdLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBpZiAobXlpdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAobXlpdGVtW3ZhcmlhYmxlXS5zbGljZSgtMSkgPT09IFwiXCIgKyBwYXJzZUludChteWl0ZW1bdmFyaWFibGVdLnNsaWNlKC0xKSwgMTApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHZhciBpPTA7IGk8dmFyaWFibGVzLmxlbmd0aDsgaSs9MSkge1xuICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QodmFyaWFibGVzW2ldKSk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGlzLXVuY2VydGFpbi1kYXRlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgdmFyaWFibGVzID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24gKG15dmFyaWFibGUpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChJdGVtW215dmFyaWFibGVdICYmIEl0ZW1bbXl2YXJpYWJsZV0uY2lyY2EpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPXZhcmlhYmxlcy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KHZhcmlhYmxlc1tpXSkpO1xuICAgIH07XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbG9jYXRvclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHRyeWxhYmVscyA9IGFyZy5yZXBsYWNlKFwic3ViIHZlcmJvXCIsIFwic3ViLXZlcmJvXCIpO1xuICAgIHRyeWxhYmVscyA9IHRyeWxhYmVscy5zcGxpdCgvXFxzKy8pO1xuICAgIHZhciBtYWtldGVzdCA9IGZ1bmN0aW9uICh0cnlsYWJlbCkge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgdmFyIGxhYmVsO1xuICAgICAgICAgICAgc3RhdGUucHJvY2Vzc051bWJlcihmYWxzZSwgaXRlbSwgXCJsb2NhdG9yXCIpO1xuICAgICAgICAgICAgbGFiZWwgPSBzdGF0ZS50bXAuc2hhZG93X251bWJlcnMubG9jYXRvci5sYWJlbDtcbiAgICAgICAgICAgIGlmICh0cnlsYWJlbCA9PT0gbGFiZWwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPXRyeWxhYmVscy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KHRyeWxhYmVsc1tpXSkpO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBwb3NpdGlvblwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHRyeXBvc2l0aW9uO1xuICAgIHN0YXRlLm9wdC51cGRhdGVfbW9kZSA9IENTTC5QT1NJVElPTjtcbiAgICBzdGF0ZS5wYXJhbGxlbC51c2VfcGFyYWxsZWxzID0gbnVsbDtcbiAgICB2YXIgdHJ5cG9zaXRpb25zID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24odHJ5cG9zaXRpb24pIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLmFyZWEgPT09IFwiYmlibGlvZ3JhcGh5XCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXRlbSAmJiBcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgaXRlbS5wb3NpdGlvbikge1xuICAgICAgICAgICAgICAgIGl0ZW0ucG9zaXRpb24gPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGl0ZW0gJiYgdHlwZW9mIGl0ZW0ucG9zaXRpb24gPT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5wb3NpdGlvbiA9PT0gMCAmJiB0cnlwb3NpdGlvbiA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRyeXBvc2l0aW9uID4gMCAmJiBpdGVtLnBvc2l0aW9uID49IHRyeXBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHJ5cG9zaXRpb24gPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHZhciBpPTAsaWxlbj10cnlwb3NpdGlvbnMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgIHZhciB0cnlwb3NpdGlvbiA9IHRyeXBvc2l0aW9uc1tpXTtcbiAgICAgICAgaWYgKHRyeXBvc2l0aW9uID09PSBcImZpcnN0XCIpIHtcbiAgICAgICAgICAgIHRyeXBvc2l0aW9uID0gQ1NMLlBPU0lUSU9OX0ZJUlNUO1xuICAgICAgICB9IGVsc2UgaWYgKHRyeXBvc2l0aW9uID09PSBcInN1YnNlcXVlbnRcIikge1xuICAgICAgICAgICAgdHJ5cG9zaXRpb24gPSBDU0wuUE9TSVRJT05fU1VCU0VRVUVOVDtcbiAgICAgICAgfSBlbHNlIGlmICh0cnlwb3NpdGlvbiA9PT0gXCJpYmlkXCIpIHtcbiAgICAgICAgICAgIHRyeXBvc2l0aW9uID0gQ1NMLlBPU0lUSU9OX0lCSUQ7XG4gICAgICAgIH0gZWxzZSBpZiAodHJ5cG9zaXRpb24gPT09IFwiaWJpZC13aXRoLWxvY2F0b3JcIikge1xuICAgICAgICAgICAgdHJ5cG9zaXRpb24gPSBDU0wuUE9TSVRJT05fSUJJRF9XSVRIX0xPQ0FUT1I7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwibmVhci1ub3RlXCIgPT09IHRyeXBvc2l0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLnRlc3RzLnB1c2goZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtLnBvc2l0aW9uID49IENTTC5QT1NJVElPTl9TVUJTRVFVRU5UICYmIGl0ZW1bXCJuZWFyLW5vdGVcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKFwiZmFyLW5vdGVcIiA9PT0gdHJ5cG9zaXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMudGVzdHMucHVzaChmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW0ucG9zaXRpb24gPT0gQ1NMLlBPU0lUSU9OX1NVQlNFUVVFTlQgJiYgIWl0ZW1bXCJuZWFyLW5vdGVcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KHRyeXBvc2l0aW9uKSk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAdHlwZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHR5cGVzID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24gKG15dHlwZSkge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oSXRlbSxpdGVtKSB7XG4gICAgICAgICAgICB2YXIgcmV0ID0gKEl0ZW0udHlwZSA9PT0gbXl0eXBlKTtcbiAgICAgICAgICAgIGlmIChyZXQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHZhciB0ZXN0cyA9IFtdO1xuICAgIGZvciAodmFyIGk9MCxpbGVuPXR5cGVzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICB0ZXN0cy5wdXNoKG1ha2V0ZXN0KHR5cGVzW2ldKSk7XG4gICAgfVxuICAgIHRoaXMudGVzdHMucHVzaChzdGF0ZS5mdW4ubWF0Y2guYW55KHRoaXMsIHN0YXRlLCB0ZXN0cykpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHZhcmlhYmxlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgZnVuYztcbiAgICB0aGlzLnZhcmlhYmxlcyA9IGFyZy5zcGxpdCgvXFxzKy8pO1xuICAgIHRoaXMudmFyaWFibGVzX3JlYWwgPSB0aGlzLnZhcmlhYmxlcy5zbGljZSgpO1xuICAgIGlmIChcImxhYmVsXCIgPT09IHRoaXMubmFtZSAmJiB0aGlzLnZhcmlhYmxlc1swXSkge1xuICAgICAgICB0aGlzLnN0cmluZ3MudGVybSA9IHRoaXMudmFyaWFibGVzWzBdO1xuICAgIH0gZWxzZSBpZiAoW1wibmFtZXNcIiwgXCJkYXRlXCIsIFwidGV4dFwiLCBcIm51bWJlclwiXS5pbmRleE9mKHRoaXMubmFtZSkgPiAtMSkge1xuICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy52YXJpYWJsZXMubGVuZ3RoIC0gMTsgaSA+IC0xOyBpICs9IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy52YXJpYWJsZXMucG9wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLnZhcmlhYmxlc19yZWFsLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kb25lX3ZhcnMuaW5kZXhPZih0aGlzLnZhcmlhYmxlc19yZWFsW2ldKSA9PT0gLTEgXG4gICAgICAgICAgICAgICAgICAgICYmICEoaXRlbSAmJiBJdGVtLnR5cGUgPT09IFwibGVnYWxfY2FzZVwiICYmIGl0ZW1bXCJzdXBwcmVzcy1hdXRob3JcIl0gJiYgdGhpcy52YXJpYWJsZXNfcmVhbFtpXSA9PT0gXCJ0aXRsZVwiKVxuICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZhcmlhYmxlcy5wdXNoKHRoaXMudmFyaWFibGVzX3JlYWxbaV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmNhbl9ibG9ja19zdWJzdGl0dXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5kb25lX3ZhcnMucHVzaCh0aGlzLnZhcmlhYmxlc19yZWFsW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgdmFyIG15ZGF0ZTtcbiAgICAgICAgICAgIHZhciBvdXRwdXQgPSBmYWxzZTtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMudmFyaWFibGVzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhcmlhYmxlID0gdGhpcy52YXJpYWJsZXNbaV07XG4gICAgICAgICAgICAgICAgaWYgKFtcImF1dGhvcml0eVwiLCBcImNvbW1pdHRlZVwiXS5pbmRleE9mKHZhcmlhYmxlKSA+IC0xXG4gICAgICAgICAgICAgICAgICAgICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiBJdGVtW3ZhcmlhYmxlXVxuICAgICAgICAgICAgICAgICAgICAmJiBcIm5hbWVzXCIgPT09IHRoaXMubmFtZSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY3JlYXRvclBhcmVudHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcmF3TmFtZXMgPSBJdGVtW3ZhcmlhYmxlXS5zcGxpdCgvXFxzKjtcXHMqLyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciByYXdNdWx0aU5hbWVzID0ge307XG4gICAgICAgICAgICAgICAgICAgIGlmIChJdGVtLm11bHRpICYmIEl0ZW0ubXVsdGkuX2tleXNbdmFyaWFibGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBsYW5nVGFnIGluIEl0ZW0ubXVsdGkuX2tleXNbdmFyaWFibGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF3TXVsdGlOYW1lc1tsYW5nVGFnXSA9IEl0ZW0ubXVsdGkuX2tleXNbdmFyaWFibGVdW2xhbmdUYWddLnNwbGl0KC9cXHMqO1xccyovKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmF3TXVsdGlOYW1lc1tsYW5nVGFnXS5sZW5ndGggIT09IHJhd05hbWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhd05hbWVzID0gW0l0ZW1bdmFyaWFibGVdXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhd011bHRpTmFtZXMgPSBJdGVtLm11bHRpLl9rZXlzW3ZhcmlhYmxlXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IHJhd05hbWVzLmxlbmd0aDsgaiA8IGpsZW47IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNyZWF0b3JQYXJlbnQgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGl0ZXJhbDpyYXdOYW1lc1tqXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdWx0aTp7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9rZXk6e31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbGFuZ1RhZyBpbiByYXdNdWx0aU5hbWVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNyZWF0b3JDaGlsZCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGl0ZXJhbDpyYXdNdWx0aU5hbWVzW2xhbmdUYWddW2pdXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0b3JQYXJlbnQubXVsdGkuX2tleVtsYW5nVGFnXSA9IGNyZWF0b3JDaGlsZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJhd05hbWVzW2pdID0gY3JlYXRvclBhcmVudDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBJdGVtW3ZhcmlhYmxlXSA9IHJhd05hbWVzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdHJpbmdzLmZvcm0gPT09IFwic2hvcnRcIiAmJiAhSXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhcmlhYmxlID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlID0gXCJ0aXRsZS1zaG9ydFwiO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhcmlhYmxlID09PSBcImNvbnRhaW5lci10aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZSA9IFwiam91cm5hbEFiYnJldmlhdGlvblwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJ5ZWFyLXN1ZmZpeFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQ1NMLkRBVEVfVkFSSUFCTEVTLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmxvY2F0b3JfZGF0ZV9hbmRfcmV2aXNpb24gJiYgXCJsb2NhdG9yLWRhdGVcIiA9PT0gdmFyaWFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoSXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBJdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhdGVwYXJ0cy5pbmRleE9mKGtleSkgPT09IC0xICYmIFwibGl0ZXJhbFwiICE9PSBrZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChJdGVtW3ZhcmlhYmxlXVtrZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvdXRwdXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJsb2NhdG9yXCIgPT09IHZhcmlhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW0ubG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwibG9jYXRvci1leHRyYVwiID09PSB2YXJpYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtW1wibG9jYXRvci1leHRyYVwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFtcImNpdGF0aW9uLW51bWJlclwiLFwiY2l0YXRpb24tbGFiZWxcIl0uaW5kZXhPZih2YXJpYWJsZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCIgPT09IHZhcmlhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW1bXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChcImhlcmVpbmFmdGVyXCIgPT09IHZhcmlhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tcImRlZmF1bHRcIl0uaGVyZWluYWZ0ZXJbSXRlbS5pZF1cbiAgICAgICAgICAgICAgICAgICAgICAgICYmIHN0YXRlLnN5cy5nZXRBYmJyZXZpYXRpb25cbiAgICAgICAgICAgICAgICAgICAgICAgICYmIEl0ZW0uaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChcIm9iamVjdFwiID09PSB0eXBlb2YgSXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKEl0ZW1bdmFyaWFibGVdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIEl0ZW1bdmFyaWFibGVdICYmIEl0ZW1bdmFyaWFibGVdKSB7XG4gICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIEl0ZW1bdmFyaWFibGVdKSB7XG4gICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAob3V0cHV0KSB7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvdXRwdXQpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLnZhcmlhYmxlc19yZWFsLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2YXJpYWJsZSA9IHRoaXMudmFyaWFibGVzX3JlYWxbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YXJpYWJsZSAhPT0gXCJjaXRhdGlvbi1udW1iZXJcIiB8fCBzdGF0ZS50bXAuYXJlYSAhPT0gXCJiaWJsaW9ncmFwaHlcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmNpdGVfcmVuZGVyc19jb250ZW50ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAudmFyaWFibGVfc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY2FuX3N1YnN0aXR1dGUudmFsdWUoKSBcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIHN0YXRlLnRtcC5hcmVhID09PSBcImJpYmxpb2dyYXBoeVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiBcInN0cmluZ1wiID09PSB0eXBlb2YgSXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5uYW1lX25vZGUudG9wID0gc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5yZW5kZXJlZF9uYW1lLnB1c2goSXRlbVt2YXJpYWJsZV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS5yZXBsYWNlKGZhbHNlLCAgQ1NMLkxJVEVSQUwpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAudmFyaWFibGVfYXR0ZW1wdCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICB9IGVsc2UgaWYgKFtcImlmXCIsICBcImVsc2UtaWZcIiwgXCJjb25kaXRpb25cIl0uaW5kZXhPZih0aGlzLm5hbWUpID4gLTEpIHtcbiAgICAgICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24gKHZhcmlhYmxlKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oSXRlbSxpdGVtKXtcbiAgICAgICAgICAgICAgICB2YXIgbXlpdGVtID0gSXRlbTtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBbXCJsb2NhdG9yXCIsIFwibG9jYXRvci1leHRyYVwiLCBcImZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlclwiLCBcImxvY2F0b3ItZGF0ZVwiXS5pbmRleE9mKHZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIG15aXRlbSA9IGl0ZW07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJoZXJlaW5hZnRlclwiICYmIHN0YXRlLnN5cy5nZXRBYmJyZXZpYXRpb24gJiYgbXlpdGVtLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tcImRlZmF1bHRcIl0uaGVyZWluYWZ0ZXJbbXlpdGVtLmlkXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG15aXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFwibnVtYmVyXCIgPT09IHR5cGVvZiBteWl0ZW1bdmFyaWFibGVdIHx8IFwic3RyaW5nXCIgPT09IHR5cGVvZiBteWl0ZW1bdmFyaWFibGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChcIm9iamVjdFwiID09PSB0eXBlb2YgbXlpdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG15aXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXlpdGVtW3ZhcmlhYmxlXVtrZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy52YXJpYWJsZXMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QodGhpcy52YXJpYWJsZXNbaV0pKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBwYWdlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgdHJ5bGFiZWxzID0gYXJnLnJlcGxhY2UoXCJzdWIgdmVyYm9cIiwgXCJzdWItdmVyYm9cIik7XG4gICAgdHJ5bGFiZWxzID0gdHJ5bGFiZWxzLnNwbGl0KC9cXHMrLyk7XG4gICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24gKHRyeWxhYmVsKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICB2YXIgbGFiZWw7XG4gICAgICAgICAgICBzdGF0ZS5wcm9jZXNzTnVtYmVyKGZhbHNlLCBJdGVtLCBcInBhZ2VcIiwgSXRlbS50eXBlKTtcbiAgICAgICAgICAgIGlmICghc3RhdGUudG1wLnNoYWRvd19udW1iZXJzLnBhZ2UubGFiZWwpIHtcbiAgICAgICAgICAgICAgICBsYWJlbCA9IFwicGFnZVwiO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS50bXAuc2hhZG93X251bWJlcnMucGFnZS5sYWJlbCA9PT0gXCJzdWIgdmVyYm9cIikge1xuICAgICAgICAgICAgICAgIGxhYmVsID0gXCJzdWItdmVyYm9cIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGFiZWwgPSBzdGF0ZS50bXAuc2hhZG93X251bWJlcnMucGFnZS5sYWJlbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0cnlsYWJlbCA9PT0gbGFiZWwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPXRyeWxhYmVscy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KHRyeWxhYmVsc1tpXSkpO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBudW1iZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB0cnlsYWJlbHMgPSBhcmcucmVwbGFjZShcInN1YiB2ZXJib1wiLCBcInN1Yi12ZXJib1wiKTtcbiAgICB0cnlsYWJlbHMgPSB0cnlsYWJlbHMuc3BsaXQoL1xccysvKTtcbiAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbih0cnlsYWJlbCkge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIHZhciBsYWJlbDtcbiAgICAgICAgICAgIHN0YXRlLnByb2Nlc3NOdW1iZXIoZmFsc2UsIEl0ZW0sIFwibnVtYmVyXCIsIEl0ZW0udHlwZSk7XG4gICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5zaGFkb3dfbnVtYmVycy5udW1iZXIubGFiZWwpIHtcbiAgICAgICAgICAgICAgICBsYWJlbCA9IFwibnVtYmVyXCI7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVycy5udW1iZXIubGFiZWwgPT09IFwic3ViIHZlcmJvXCIpIHtcbiAgICAgICAgICAgICAgICBsYWJlbCA9IFwic3ViLXZlcmJvXCI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxhYmVsID0gc3RhdGUudG1wLnNoYWRvd19udW1iZXJzLm51bWJlci5sYWJlbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0cnlsYWJlbCA9PT0gbGFiZWwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPXRyeWxhYmVscy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KHRyeWxhYmVsc1tpXSkpO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBqdXJpc2RpY3Rpb25cIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB0cnlqdXJpc2RpY3Rpb25zID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgZm9yICh2YXIgaT0wLGlsZW49dHJ5anVyaXNkaWN0aW9ucy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdHJ5anVyaXNkaWN0aW9uc1tpXSA9IHRyeWp1cmlzZGljdGlvbnNbaV0uc3BsaXQoXCI6XCIpO1xuICAgIH1cbiAgICB2YXIgbWFrZXRlc3RzID0gZnVuY3Rpb24gKHRyeWp1cmlzZGljdGlvbikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oSXRlbSxpdGVtKXtcbiAgICAgICAgICAgIGlmICghSXRlbS5qdXJpc2RpY3Rpb24pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIganVyaXNkaWN0aW9ucyA9IEl0ZW0uanVyaXNkaWN0aW9uLnNwbGl0KFwiOlwiKTtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWp1cmlzZGljdGlvbnMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICAgICAganVyaXNkaWN0aW9uc1tpXSA9IGp1cmlzZGljdGlvbnNbaV0uc3BsaXQoXCI6XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yIChpPXRyeWp1cmlzZGljdGlvbi5sZW5ndGg7aT4wO2krPS0xKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRyeWp1cmlzZGljdGlvblN0ciA9IHRyeWp1cmlzZGljdGlvbi5zbGljZSgwLGkpLmpvaW4oXCI6XCIpO1xuICAgICAgICAgICAgICAgIHZhciBqdXJpc2RpY3Rpb24gPSBqdXJpc2RpY3Rpb25zLnNsaWNlKDAsaSkuam9pbihcIjpcIik7XG4gICAgICAgICAgICAgICAgaWYgKHRyeWp1cmlzZGljdGlvblN0ciAhPT0ganVyaXNkaWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHZhciBpPTAsaWxlbj10cnlqdXJpc2RpY3Rpb25zLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICB2YXIgdHJ5anVyaXNkaWN0aW9uU2xpY2UgPSB0cnlqdXJpc2RpY3Rpb25zW2ldLnNsaWNlKCk7XG4gICAgICAgIHRoaXMudGVzdHMucHVzaChtYWtldGVzdHModHJ5anVyaXNkaWN0aW9uU2xpY2UpKTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAY29udGV4dFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIGZ1bmMgPSBmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuXHRcdHZhciBhcmVhID0gc3RhdGUudG1wLmFyZWEuc2xpY2UoMCwgYXJnLmxlbmd0aCk7XG5cdFx0aWYgKGFyZWEgPT09IGFyZykge1xuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXHRcdHJldHVybiBmYWxzZTtcbiAgICB9O1xuICAgIHRoaXMudGVzdHMucHVzaChmdW5jKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBoYXMteWVhci1vbmx5XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgdHJ5ZGF0ZXMgPSBhcmcuc3BsaXQoL1xccysvKTtcbiAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbiAodHJ5ZGF0ZSkge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oSXRlbSxpdGVtKXtcbiAgICAgICAgICAgIHZhciBkYXRlID0gSXRlbVt0cnlkYXRlXTtcbiAgICAgICAgICAgIGlmICghZGF0ZSB8fCBkYXRlLm1vbnRoIHx8IGRhdGUuc2Vhc29uKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHZhciBpPTAsaWxlbj10cnlkYXRlcy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KHRyeWRhdGVzW2ldKSk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGhhcy10by1tb250aC1vci1zZWFzb25cIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB0cnlkYXRlcyA9IGFyZy5zcGxpdCgvXFxzKy8pO1xuICAgIHZhciBtYWtldGVzdCA9IGZ1bmN0aW9uICh0cnlkYXRlKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihJdGVtLGl0ZW0pe1xuICAgICAgICAgICAgdmFyIGRhdGUgPSBJdGVtW3RyeWRhdGVdO1xuICAgICAgICAgICAgaWYgKCFkYXRlIHx8ICghZGF0ZS5tb250aCAmJiAhZGF0ZS5zZWFzb24pIHx8IGRhdGUuZGF5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHZhciBpPTAsaWxlbj10cnlkYXRlcy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KHRyeWRhdGVzW2ldKSk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGhhcy1kYXlcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB0cnlkYXRlcyA9IGFyZy5zcGxpdCgvXFxzKy8pO1xuICAgIHZhciBtYWtldGVzdCA9IGZ1bmN0aW9uICh0cnlkYXRlKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihJdGVtLGl0ZW0pe1xuICAgICAgICAgICAgdmFyIGRhdGUgPSBJdGVtW3RyeWRhdGVdO1xuICAgICAgICAgICAgaWYgKCFkYXRlIHx8ICFkYXRlLmRheSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2YXIgaT0wLGlsZW49dHJ5ZGF0ZXMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgIHRoaXMudGVzdHMucHVzaChtYWtldGVzdCh0cnlkYXRlc1tpXSkpO1xuICAgIH07XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc3VianVyaXNkaWN0aW9uc1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHRyeXN1Ymp1cmlzZGljdGlvbnMgPSBwYXJzZUludChhcmcsIDEwKTtcbiAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgIHZhciBzdWJqdXJpc2RpY3Rpb25zID0gMDtcbiAgICAgICAgaWYgKEl0ZW0uanVyaXNkaWN0aW9uKSB7XG4gICAgICAgICAgICBzdWJqdXJpc2RpY3Rpb25zID0gSXRlbS5qdXJpc2RpY3Rpb24uc3BsaXQoXCI6XCIpLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3VianVyaXNkaWN0aW9ucykge1xuICAgICAgICAgICAgc3VianVyaXNkaWN0aW9ucyArPSAtMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3VianVyaXNkaWN0aW9ucyA+PSB0cnlzdWJqdXJpc2RpY3Rpb25zKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcbiAgICB0aGlzLnRlc3RzLnB1c2goZnVuYyk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaXMtcGx1cmFsXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgIHZhciBuYW1lTGlzdCA9IEl0ZW1bYXJnXTtcbiAgICAgICAgaWYgKG5hbWVMaXN0ICYmIG5hbWVMaXN0Lmxlbmd0aCkge1xuICAgICAgICAgICAgdmFyIHBlcnNvbnMgPSAwO1xuICAgICAgICAgICAgdmFyIGluc3RpdHV0aW9ucyA9IDA7XG4gICAgICAgICAgICB2YXIgbGFzdF9pc19wZXJzb24gPSBmYWxzZTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gbmFtZUxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnNwb29mX2luc3RpdHV0aW9uYWxfYWZmaWxpYXRpb25zXG4gICAgICAgICAgICAgICAgICAgICYmIChuYW1lTGlzdFtpXS5saXRlcmFsIHx8IChuYW1lTGlzdFtpXS5pc0luc3RpdHV0aW9uICYmIG5hbWVMaXN0W2ldLmZhbWlseSAmJiAhbmFtZUxpc3RbaV0uZ2l2ZW4pKSkge1xuICAgICAgICAgICAgICAgICAgICBpbnN0aXR1dGlvbnMgKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgbGFzdF9pc19wZXJzb24gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwZXJzb25zICs9IDE7XG4gICAgICAgICAgICAgICAgICAgIGxhc3RfaXNfcGVyc29uID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocGVyc29ucyA+IDEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGl0dXRpb25zID4gMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0aXR1dGlvbnMgJiYgbGFzdF9pc19wZXJzb24pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcbiAgICB0aGlzLnRlc3RzLnB1c2goZnVuYyk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbG9jYWxlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgZnVuYywgcmV0LCBsZW4sIHBvcywgdmFyaWFibGUsIG15aXRlbSwgbGFuZ3NwZWMsIGxhbmcsIGxzdCwgaSwgaWxlbiwgZmFsbGJhY2s7XG4gICAgdmFyIGxvY2FsZV9kZWZhdWx0ID0gc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF07XG4gICAgaWYgKHRoaXMubmFtZSA9PT0gXCJsYXlvdXRcIikge1xuICAgICAgICB0aGlzLmxvY2FsZV9yYXcgPSBhcmc7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICB2YXIgbG9jYWxlcyA9IGFyZy5zcGxpdCgvXFxzKy8pO1xuICAgICAgICAgICAgdmFyIHNvcnRfbG9jYWxlID0ge307XG4gICAgICAgICAgICB2YXIgbG9jYWxlTWFzdGVyID0gQ1NMLmxvY2FsZVJlc29sdmUobG9jYWxlc1swXSwgbG9jYWxlX2RlZmF1bHQpO1xuICAgICAgICAgICAgaWYgKGxvY2FsZU1hc3Rlci5nZW5lcmljKSB7XG4gICAgICAgICAgICAgICAgc29ydF9sb2NhbGVbbG9jYWxlTWFzdGVyLmdlbmVyaWNdID0gbG9jYWxlTWFzdGVyLmJlc3Q7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHNvcnRfbG9jYWxlW2xvY2FsZU1hc3Rlci5iZXN0XSA9IGxvY2FsZU1hc3Rlci5iZXN0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaT0xLGlsZW49bG9jYWxlcy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgICAgICB2YXIgbG9jYWxlU2VydmFudCA9IENTTC5sb2NhbGVSZXNvbHZlKGxvY2FsZXNbaV0sIGxvY2FsZV9kZWZhdWx0KTtcbiAgICAgICAgICAgICAgICBpZiAobG9jYWxlU2VydmFudC5nZW5lcmljKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvcnRfbG9jYWxlW2xvY2FsZVNlcnZhbnQuZ2VuZXJpY10gPSBsb2NhbGVNYXN0ZXIuYmVzdDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzb3J0X2xvY2FsZVtsb2NhbGVTZXJ2YW50LmJlc3RdID0gbG9jYWxlTWFzdGVyLmJlc3Q7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LnNvcnRfbG9jYWxlcy5wdXNoKHNvcnRfbG9jYWxlKTtcbiAgICAgICAgfVxuICAgICAgICBzdGF0ZS5vcHQuaGFzX2xheW91dF9sb2NhbGUgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxzdCA9IGFyZy5zcGxpdCgvXFxzKy8pO1xuICAgICAgICB2YXIgbG9jYWxlX2JhcmVzID0gW107XG4gICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBsc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBsYW5nID0gbHN0W2ldO1xuICAgICAgICAgICAgbGFuZ3NwZWMgPSBDU0wubG9jYWxlUmVzb2x2ZShsYW5nLCBsb2NhbGVfZGVmYXVsdCk7XG4gICAgICAgICAgICBpZiAobHN0W2ldLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgIGxvY2FsZV9iYXJlcy5wdXNoKGxhbmdzcGVjLmJhcmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGUubG9jYWxlQ29uZmlndXJlKGxhbmdzcGVjLCB0cnVlKTtcbiAgICAgICAgICAgIGxzdFtpXSA9IGxhbmdzcGVjO1xuICAgICAgICB9XG4gICAgICAgIHZhciBsb2NhbGVfbGlzdCA9IGxzdC5zbGljZSgpO1xuICAgICAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbiAobG9jYWxlX2xpc3QsIGxvY2FsZV9kZWZhdWx0LGxvY2FsZV9iYXJlcykge1xuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgdmFyIGtleSwgcmVzO1xuICAgICAgICAgICAgICAgIHJldCA9IFtdO1xuICAgICAgICAgICAgICAgIHJlcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciBsYW5nc3BlYyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciBsYW5nO1xuICAgICAgICAgICAgICAgIGlmICghSXRlbS5sYW5ndWFnZSkge1xuICAgICAgICAgICAgICAgICAgICBsYW5nID0gbG9jYWxlX2RlZmF1bHQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGFuZyA9IEl0ZW0ubGFuZ3VhZ2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxhbmdzcGVjID0gQ1NMLmxvY2FsZVJlc29sdmUobGFuZywgbG9jYWxlX2RlZmF1bHQpO1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBsb2NhbGVfbGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxhbmdzcGVjLmJlc3QgPT09IGxvY2FsZV9saXN0W2ldLmJlc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXJlcyAmJiBsb2NhbGVfYmFyZXMuaW5kZXhPZihsYW5nc3BlYy5iYXJlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KGxvY2FsZV9saXN0LGxvY2FsZV9kZWZhdWx0LGxvY2FsZV9iYXJlcykpO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBhdXRob3JpdHktcmVzaWR1ZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgc3VjY2VlZCA9IChhcmcgPT09IFwidHJ1ZVwiKSA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIGlmICghSXRlbS5hdXRob3JpdHkgfHwgIUl0ZW0uYXV0aG9yaXR5WzBdIHx8ICFJdGVtLmF1dGhvcml0eVswXS5mYW1pbHkpIHJldHVybiAhc3VjY2VlZDtcbiAgICAgICAgICAgIHZhciB2YXJMZW4gPSBJdGVtLmF1dGhvcml0eVswXS5mYW1pbHkuc3BsaXQoXCJ8XCIpLmxlbmd0aDtcbiAgICAgICAgICAgIHZhciBzdG9wTGFzdCA9IHN0YXRlLnRtcC5hdXRob3JpdHlfc3RvcF9sYXN0O1xuICAgICAgICAgICAgaWYgKCh2YXJMZW4gKyBzdG9wTGFzdCkgPiAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN1Y2NlZWQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiAhc3VjY2VlZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QoKSk7XG59XG5DU0wuQXR0cmlidXRlc1tcIkBsb2NhbGUtaW50ZXJuYWxcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciBmdW5jLCByZXQsIGxlbiwgcG9zLCB2YXJpYWJsZSwgbXlpdGVtLCBsYW5nc3BlYywgbGFuZywgbHN0LCBpLCBpbGVuLCBmYWxsYmFjaztcbiAgICAgICAgbHN0ID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgICAgIHRoaXMubG9jYWxlX2JhcmVzID0gW107XG4gICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBsc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBsYW5nID0gbHN0W2ldO1xuICAgICAgICAgICAgbGFuZ3NwZWMgPSBDU0wubG9jYWxlUmVzb2x2ZShsYW5nLCBzdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXSk7XG4gICAgICAgICAgICBpZiAobHN0W2ldLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlX2JhcmVzLnB1c2gobGFuZ3NwZWMuYmFyZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZS5sb2NhbGVDb25maWd1cmUobGFuZ3NwZWMpO1xuICAgICAgICAgICAgbHN0W2ldID0gbGFuZ3NwZWM7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sb2NhbGVfZGVmYXVsdCA9IHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdO1xuICAgICAgICB0aGlzLmxvY2FsZSA9IGxzdFswXS5iZXN0O1xuICAgICAgICB0aGlzLmxvY2FsZV9saXN0ID0gbHN0LnNsaWNlKCk7XG4gICAgICAgIHZhciBtYWtldGVzdCA9IGZ1bmN0aW9uIChtZSkge1xuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgdmFyIGtleSwgcmVzO1xuICAgICAgICAgICAgICAgIHJldCA9IFtdO1xuICAgICAgICAgICAgICAgIHJlcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciBsYW5nc3BlYyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChJdGVtLmxhbmd1YWdlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhbmcgPSBJdGVtLmxhbmd1YWdlO1xuICAgICAgICAgICAgICAgICAgICBsYW5nc3BlYyA9IENTTC5sb2NhbGVSZXNvbHZlKGxhbmcsIHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxhbmdzcGVjLmJlc3QgPT09IHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYW5nc3BlYyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChsYW5nc3BlYykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gbWUubG9jYWxlX2xpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFuZ3NwZWMuYmVzdCA9PT0gbWUubG9jYWxlX2xpc3RbaV0uYmVzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5sYW5nID0gbWUubG9jYWxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5sYXN0X2NpdGVfbG9jYWxlID0gbWUubG9jYWxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5vcGVuTGV2ZWwoXCJlbXB0eVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLm5ld19sb2NhbGUgPSBtZS5sb2NhbGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXJlcyAmJiBtZS5sb2NhbGVfYmFyZXMuaW5kZXhPZihsYW5nc3BlYy5iYXJlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vcHQubGFuZyA9IG1lLmxvY2FsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5sYXN0X2NpdGVfbG9jYWxlID0gbWUubG9jYWxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChcImVtcHR5XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5uZXdfbG9jYWxlID0gbWUubG9jYWxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBtZSA9IHRoaXM7XG4gICAgICAgIHRoaXMudGVzdHMucHVzaChtYWtldGVzdChtZSkpO1xufVxuQ1NMLkF0dHJpYnV0ZXNbXCJAaXMtcGFyYWxsZWxcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB2YWx1ZXMgPSBhcmcuc3BsaXQoXCIgXCIpO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdmFsdWVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAodmFsdWVzW2ldID09PSBcInRydWVcIikge1xuICAgICAgICAgICAgdmFsdWVzW2ldID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZXNbaV0gPT09IFwiZmFsc2VcIikge1xuICAgICAgICAgICAgdmFsdWVzW2ldID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5zdHJpbmdzLnNldF9wYXJhbGxlbF9jb25kaXRpb24gPSB2YWx1ZXM7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAanVyaXNkaWN0aW9uLWRlcHRoXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3MuanVyaXNkaWN0aW9uX2RlcHRoID0gcGFyc2VJbnQoYXJnLCAxMCk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAcmVxdWlyZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzLnJlcXVpcmUgPSBhcmc7XG59XG5DU0wuQXR0cmlidXRlc1tcIkByZWplY3RcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5ncy5yZWplY3QgPSBhcmc7XG59XG5DU0wuQXR0cmlidXRlc1tcIkBnZW5kZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuZ2VuZGVyID0gYXJnO1xufVxuQ1NMLkF0dHJpYnV0ZXNbXCJAY3NsaWRcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuY3NsaWQgPSBwYXJzZUludChhcmcsIDEwKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBjYXBpdGFsaXplLWlmLWZpcnN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3MuY2FwaXRhbGl6ZV9pZl9maXJzdF9vdmVycmlkZSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBsYWJlbC1jYXBpdGFsaXplLWlmLWZpcnN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3MubGFiZWxfY2FwaXRhbGl6ZV9pZl9maXJzdF9vdmVycmlkZSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBsYWJlbC1mb3JtXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3MubGFiZWxfZm9ybV9vdmVycmlkZSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBwYXJ0LXNlcGFyYXRvclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wicGFydC1zZXBhcmF0b3JcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbGVhZGluZy1ub2lzZS13b3Jkc1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpc1tcImxlYWRpbmctbm9pc2Utd29yZHNcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbmFtZS1uZXZlci1zaG9ydFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpc1tcIm5hbWUtbmV2ZXItc2hvcnRcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAY2xhc3NcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLm9wdFtcImNsYXNzXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHZlcnNpb25cIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLm9wdC52ZXJzaW9uID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHZhbHVlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3MudmFsdWUgPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbmFtZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzLm5hbWUgPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZm9ybVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzLmZvcm0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZGF0ZS1wYXJ0c1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wiZGF0ZS1wYXJ0c1wiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkByYW5nZS1kZWxpbWl0ZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5nc1tcInJhbmdlLWRlbGltaXRlclwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBtYWNyb1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5wb3N0cG9uZWRfbWFjcm8gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAdGVybVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJzdWIgdmVyYm9cIikge1xuICAgICAgICB0aGlzLnN0cmluZ3MudGVybSA9IFwic3ViLXZlcmJvXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzLnRlcm0gPSBhcmc7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHhtbG5zXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHt9O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbGFuZ1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZykge1xuICAgICAgICBzdGF0ZS5idWlsZC5sYW5nID0gYXJnO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBsaW5nb1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbWFjcm8taGFzLWRhdGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXNbXCJtYWNyby1oYXMtZGF0ZVwiXSA9IHRydWU7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc3VmZml4XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3Muc3VmZml4ID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHByZWZpeFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzLnByZWZpeCA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBkZWxpbWl0ZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5ncy5kZWxpbWl0ZXIgPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbWF0Y2hcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMubWF0Y2ggPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbmFtZXMtbWluXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgdmFsID0gcGFyc2VJbnQoYXJnLCAxMCk7XG4gICAgaWYgKHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzIDwgdmFsKSB7XG4gICAgICAgIHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzID0gdmFsO1xuICAgIH1cbiAgICB0aGlzLnN0cmluZ3NbXCJldC1hbC1taW5cIl0gPSB2YWw7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbmFtZXMtdXNlLWZpcnN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJldC1hbC11c2UtZmlyc3RcIl0gPSBwYXJzZUludChhcmcsIDEwKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuYW1lcy11c2UtbGFzdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzW1wiZXQtYWwtdXNlLWxhc3RcIl0gPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc3RyaW5nc1tcImV0LWFsLXVzZS1sYXN0XCJdID0gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHNvcnRcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcgPT09IFwiZGVzY2VuZGluZ1wiKSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncy5zb3J0X2RpcmVjdGlvbiA9IENTTC5ERVNDRU5ESU5HO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBwbHVyYWxcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChcImFsd2F5c1wiID09PSBhcmcgfHwgXCJ0cnVlXCIgPT09IGFyZykge1xuICAgICAgICB0aGlzLnN0cmluZ3MucGx1cmFsID0gMTtcbiAgICB9IGVsc2UgaWYgKFwibmV2ZXJcIiA9PT0gYXJnIHx8IFwiZmFsc2VcIiA9PT0gYXJnKSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncy5wbHVyYWwgPSAwO1xuICAgIH0gZWxzZSBpZiAoXCJjb250ZXh0dWFsXCIgPT09IGFyZykge1xuICAgICAgICB0aGlzLnN0cmluZ3MucGx1cmFsID0gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGhhcy1wdWJsaXNoZXItYW5kLXB1Ymxpc2hlci1wbGFjZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wiaGFzLXB1Ymxpc2hlci1hbmQtcHVibGlzaGVyLXBsYWNlXCJdID0gdHJ1ZTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBwdWJsaXNoZXItZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5nc1tcInB1Ymxpc2hlci1kZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBwdWJsaXNoZXItZGVsaW1pdGVyXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJwdWJsaXNoZXItZGVsaW1pdGVyXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHB1Ymxpc2hlci1hbmRcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5nc1tcInB1Ymxpc2hlci1hbmRcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbmV3ZGF0ZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChDU0wuR0lWRU5OQU1FX0RJU0FNQklHVUFUSU9OX1JVTEVTLmluZGV4T2YoYXJnKSA+IC0xKSB7XG4gICAgICAgIHN0YXRlLmNpdGF0aW9uLm9wdFtcImdpdmVubmFtZS1kaXNhbWJpZ3VhdGlvbi1ydWxlXCJdID0gYXJnO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBjb2xsYXBzZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZykge1xuICAgICAgICBzdGF0ZVt0aGlzLm5hbWVdLm9wdC5jb2xsYXBzZSA9IGFyZztcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAY2l0ZS1ncm91cC1kZWxpbWl0ZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcpIHtcbiAgICAgICAgc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlciA9IGFyZztcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbmFtZXMtZGVsaW1pdGVyXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJuYW1lcy1kZWxpbWl0ZXJcIiwgYXJnKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuYW1lLWZvcm1cIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLnNldE9wdCh0aGlzLCBcIm5hbWUtZm9ybVwiLCBhcmcpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHN1Ymdyb3VwLWRlbGltaXRlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wic3ViZ3JvdXAtZGVsaW1pdGVyXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHN1Ymdyb3VwLWRlbGltaXRlci1wcmVjZWRlcy1sYXN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJzdWJncm91cC1kZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuYW1lLWRlbGltaXRlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwibmFtZS1kZWxpbWl0ZXJcIiwgYXJnKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBldC1hbC1taW5cIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB2YWwgPSBwYXJzZUludChhcmcsIDEwKTtcbiAgICBpZiAoc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0Lm1heF9udW1iZXJfb2ZfbmFtZXMgPCB2YWwpIHtcbiAgICAgICAgc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0Lm1heF9udW1iZXJfb2ZfbmFtZXMgPSB2YWw7XG4gICAgfVxuICAgIHN0YXRlLnNldE9wdCh0aGlzLCBcImV0LWFsLW1pblwiLCB2YWwpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGV0LWFsLXVzZS1maXJzdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWZpcnN0XCIsIHBhcnNlSW50KGFyZywgMTApKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBldC1hbC11c2UtbGFzdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWxhc3RcIiwgdHJ1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWxhc3RcIiwgZmFsc2UpO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBldC1hbC1zdWJzZXF1ZW50LW1pblwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHZhbCA9IHBhcnNlSW50KGFyZywgMTApO1xuICAgIGlmIChzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubWF4X251bWJlcl9vZl9uYW1lcyA8IHZhbCkge1xuICAgICAgICBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubWF4X251bWJlcl9vZl9uYW1lcyA9IHZhbDtcbiAgICB9XG4gICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwiZXQtYWwtc3Vic2VxdWVudC1taW5cIiwgdmFsKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBldC1hbC1zdWJzZXF1ZW50LXVzZS1maXJzdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwiZXQtYWwtc3Vic2VxdWVudC11c2UtZmlyc3RcIiwgcGFyc2VJbnQoYXJnLCAxMCkpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHN1cHByZXNzLW1pblwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wic3VwcHJlc3MtbWluXCJdID0gcGFyc2VJbnQoYXJnLCAxMCk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc3VwcHJlc3MtbWF4XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJzdXBwcmVzcy1tYXhcIl0gPSBwYXJzZUludChhcmcsIDEwKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBhbmRcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLnNldE9wdCh0aGlzLCBcImFuZFwiLCBhcmcpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGRlbGltaXRlci1wcmVjZWRlcy1sYXN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiLCBhcmcpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGRlbGltaXRlci1wcmVjZWRlcy1ldC1hbFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwiZGVsaW1pdGVyLXByZWNlZGVzLWV0LWFsXCIsIGFyZyk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaW5pdGlhbGl6ZS13aXRoXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJpbml0aWFsaXplLXdpdGhcIiwgYXJnKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBpbml0aWFsaXplXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnID09PSBcImZhbHNlXCIpIHtcbiAgICAgICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwiaW5pdGlhbGl6ZVwiLCBmYWxzZSk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQG5hbWUtYXMtcmV2ZXJzZS1vcmRlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpc1tcIm5hbWUtYXMtcmV2ZXJzZS1vcmRlclwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuYW1lLWFzLXNvcnQtb3JkZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmICh0aGlzLm5hbWUgPT09IFwic3R5bGUtb3B0aW9uc1wiKSB7XG4gICAgICAgIHRoaXNbXCJuYW1lLWFzLXNvcnQtb3JkZXJcIl0gPSBhcmc7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwibmFtZS1hcy1zb3J0LW9yZGVyXCIsIGFyZyk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHNvcnQtc2VwYXJhdG9yXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJzb3J0LXNlcGFyYXRvclwiLCBhcmcpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHllYXItc3VmZml4LWRlbGltaXRlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGVbdGhpcy5uYW1lXS5vcHRbXCJ5ZWFyLXN1ZmZpeC1kZWxpbWl0ZXJcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAYWZ0ZXItY29sbGFwc2UtZGVsaW1pdGVyXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZVt0aGlzLm5hbWVdLm9wdFtcImFmdGVyLWNvbGxhcHNlLWRlbGltaXRlclwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBzdWJzZXF1ZW50LWF1dGhvci1zdWJzdGl0dXRlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZVt0aGlzLm5hbWVdLm9wdFtcInN1YnNlcXVlbnQtYXV0aG9yLXN1YnN0aXR1dGVcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc3Vic2VxdWVudC1hdXRob3Itc3Vic3RpdHV0ZS1ydWxlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZVt0aGlzLm5hbWVdLm9wdFtcInN1YnNlcXVlbnQtYXV0aG9yLXN1YnN0aXR1dGUtcnVsZVwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBkaXNhbWJpZ3VhdGUtYWRkLW5hbWVzXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnID09PSBcInRydWVcIikge1xuICAgICAgICBzdGF0ZS5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLW5hbWVzXCJdID0gdHJ1ZTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZGlzYW1iaWd1YXRlLWFkZC1naXZlbm5hbWVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcgPT09IFwidHJ1ZVwiKSB7XG4gICAgICAgIHN0YXRlLm9wdFtcImRpc2FtYmlndWF0ZS1hZGQtZ2l2ZW5uYW1lXCJdID0gdHJ1ZTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZGlzYW1iaWd1YXRlLWFkZC15ZWFyLXN1ZmZpeFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJ0cnVlXCIgJiYgc3RhdGUub3B0LnhjbGFzcyAhPT0gXCJudW1lcmljXCIpIHtcbiAgICAgICAgc3RhdGUub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC15ZWFyLXN1ZmZpeFwiXSA9IHRydWU7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHNlY29uZC1maWVsZC1hbGlnblwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJmbHVzaFwiIHx8IGFyZyA9PT0gXCJtYXJnaW5cIikge1xuICAgICAgICBzdGF0ZVt0aGlzLm5hbWVdLm9wdFtcInNlY29uZC1maWVsZC1hbGlnblwiXSA9IGFyZztcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaGFuZ2luZy1pbmRlbnRcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcgPT09IFwidHJ1ZVwiKSB7XG4gICAgICAgIHN0YXRlW3RoaXMubmFtZV0ub3B0LmhhbmdpbmdpbmRlbnQgPSAyO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBsaW5lLXNwYWNpbmdcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcgJiYgYXJnLm1hdGNoKC9eWy4wLTldKyQvKSkge1xuICAgICAgICBzdGF0ZVt0aGlzLm5hbWVdLm9wdFtcImxpbmUtc3BhY2luZ1wiXSA9IHBhcnNlRmxvYXQoYXJnLCAxMCk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGVudHJ5LXNwYWNpbmdcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcgJiYgYXJnLm1hdGNoKC9eWy4wLTldKyQvKSkge1xuICAgICAgICBzdGF0ZVt0aGlzLm5hbWVdLm9wdFtcImVudHJ5LXNwYWNpbmdcIl0gPSBwYXJzZUZsb2F0KGFyZywgMTApO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuZWFyLW5vdGUtZGlzdGFuY2VcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlW3RoaXMubmFtZV0ub3B0W1wibmVhci1ub3RlLWRpc3RhbmNlXCJdID0gcGFyc2VJbnQoYXJnLCAxMCk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAdGV4dC1jYXNlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICBpZiAoYXJnID09PSBcIm5vcm1hbFwiKSB7XG4gICAgICAgICAgICB0aGlzLnRleHRfY2FzZV9ub3JtYWwgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zdHJpbmdzW1widGV4dC1jYXNlXCJdID0gYXJnO1xuICAgICAgICAgICAgaWYgKGFyZyA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgdmFyIG0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgZGVmYXVsdF9sb2NhbGUgPSBzdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXS5zbGljZSgwLCAyKTtcbiAgICAgICAgICAgICAgICBpZiAoSXRlbS5qdXJpc2RpY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHJpbmdzW1widGV4dC1jYXNlXCJdID0gXCJwYXNzdGhyb3VnaFwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHBhZ2UtcmFuZ2UtZm9ybWF0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5vcHRbXCJwYWdlLXJhbmdlLWZvcm1hdFwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkB5ZWFyLXJhbmdlLWZvcm1hdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGUub3B0W1wieWVhci1yYW5nZS1mb3JtYXRcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZGVmYXVsdC1sb2NhbGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmICh0aGlzLm5hbWUgPT09ICdzdHlsZScpIHtcbiAgICAgICAgdmFyIGxzdCwgbGVuLCBwb3MsIG0sIHJldDtcbiAgICAgICAgdmFyIG0gPSBhcmcubWF0Y2goLy14LShzb3J0fHRyYW5zbGl0fHRyYW5zbGF0KS0vZyk7XG4gICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IG0ubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgbVtwb3NdID0gbVtwb3NdLnJlcGxhY2UoL14teC0vLCBcIlwiKS5yZXBsYWNlKC8tJC8sIFwiXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxzdCA9IGFyZy5zcGxpdCgvLXgtKD86c29ydHx0cmFuc2xpdHx0cmFuc2xhdCktLyk7XG4gICAgICAgIHJldCA9IFtsc3RbMF1dO1xuICAgICAgICBmb3IgKHBvcyA9IDEsIGxlbiA9IGxzdC5sZW5ndGg7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIHJldC5wdXNoKG1bcG9zIC0gMV0pO1xuICAgICAgICAgICAgcmV0LnB1c2gobHN0W3Bvc10pO1xuICAgICAgICB9XG4gICAgICAgIGxzdCA9IHJldC5zbGljZSgpO1xuICAgICAgICBsZW4gPSBsc3QubGVuZ3RoO1xuICAgICAgICBmb3IgKHBvcyA9IDE7IHBvcyA8IGxlbjsgcG9zICs9IDIpIHtcbiAgICAgICAgICAgIHN0YXRlLm9wdFsoXCJsb2NhbGUtXCIgKyBsc3RbcG9zXSldLnB1c2gobHN0Wyhwb3MgKyAxKV0ucmVwbGFjZSgvXlxccyovZywgXCJcIikucmVwbGFjZSgvXFxzKiQvZywgXCJcIikpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICBzdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXSA9IGxzdC5zbGljZSgwLCAxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdID0gW1wiZW5cIl07XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGFyZyA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgdGhpcy5kZWZhdWx0X2xvY2FsZSA9IHRydWU7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGRlZmF1bHQtbG9jYWxlLXNvcnRcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciBsc3QsIGxlbiwgcG9zLCBtLCByZXQ7XG4gICAgc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGUtc29ydFwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBkZW1vdGUtbm9uLWRyb3BwaW5nLXBhcnRpY2xlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5vcHRbXCJkZW1vdGUtbm9uLWRyb3BwaW5nLXBhcnRpY2xlXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGluaXRpYWxpemUtd2l0aC1oeXBoZW5cIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcgPT09IFwiZmFsc2VcIikge1xuICAgICAgICBzdGF0ZS5vcHRbXCJpbml0aWFsaXplLXdpdGgtaHlwaGVuXCJdID0gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGluc3RpdHV0aW9uLXBhcnRzXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJpbnN0aXR1dGlvbi1wYXJ0c1wiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBpZi1zaG9ydFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzW1wiaWYtc2hvcnRcIl0gPSB0cnVlO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBzdWJzdGl0dXRlLXVzZS1maXJzdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wic3Vic3RpdHV0ZS11c2UtZmlyc3RcIl0gPSBwYXJzZUludChhcmcsIDEwKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkB1c2UtZmlyc3RcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5nc1tcInVzZS1maXJzdFwiXSA9IHBhcnNlSW50KGFyZywgMTApO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHN0b3AtbGFzdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wic3RvcC1sYXN0XCJdID0gcGFyc2VJbnQoYXJnLCAxMCkgKiAtMTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkB1c2UtbGFzdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1widXNlLWxhc3RcIl0gPSBwYXJzZUludChhcmcsIDEwKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkByZXZlcnNlLW9yZGVyXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoXCJ0cnVlXCIgPT09IGFyZykge1xuICAgICAgICB0aGlzLnN0cmluZ3NbXCJyZXZlcnNlLW9yZGVyXCJdID0gdHJ1ZTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZGlzcGxheVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKHN0YXRlLmJpYmxpb2dyYXBoeS50b2tlbnMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIHN0YXRlLm9wdC51c2luZ19kaXNwbGF5ID0gdHJ1ZTtcbiAgICB9XG4gICAgdGhpcy5zdHJpbmdzLmNscyA9IGFyZztcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5TdGFjayA9IGZ1bmN0aW9uICh2YWwsIGxpdGVyYWwpIHtcbiAgICB0aGlzLm15c3RhY2sgPSBbXTtcbiAgICBpZiAobGl0ZXJhbCB8fCB2YWwpIHtcbiAgICAgICAgdGhpcy5teXN0YWNrLnB1c2godmFsKTtcbiAgICB9XG4gICAgdGhpcy50aXAgPSB0aGlzLm15c3RhY2tbMF07XG59O1xuQ1NMLlN0YWNrLnByb3RvdHlwZS5wdXNoID0gZnVuY3Rpb24gKHZhbCwgbGl0ZXJhbCkge1xuICAgIGlmIChsaXRlcmFsIHx8IHZhbCkge1xuICAgICAgICB0aGlzLm15c3RhY2sucHVzaCh2YWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubXlzdGFjay5wdXNoKFwiXCIpO1xuICAgIH1cbiAgICB0aGlzLnRpcCA9IHRoaXMubXlzdGFja1t0aGlzLm15c3RhY2subGVuZ3RoIC0gMV07XG59O1xuQ1NMLlN0YWNrLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLm15c3RhY2sgPSBbXTtcbiAgICB0aGlzLnRpcCA9IHt9O1xufTtcbkNTTC5TdGFjay5wcm90b3R5cGUucmVwbGFjZSA9IGZ1bmN0aW9uICh2YWwsIGxpdGVyYWwpIHtcbiAgICBpZiAodGhpcy5teXN0YWNrLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBcIkludGVybmFsIENTTCBwcm9jZXNzb3IgZXJyb3I6IGF0dGVtcHQgdG8gcmVwbGFjZSBub25leGlzdGVudCBzdGFjayBpdGVtIHdpdGggXCIgKyB2YWw7XG4gICAgfVxuICAgIGlmIChsaXRlcmFsIHx8IHZhbCkge1xuICAgICAgICB0aGlzLm15c3RhY2tbKHRoaXMubXlzdGFjay5sZW5ndGggLSAxKV0gPSB2YWw7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5teXN0YWNrWyh0aGlzLm15c3RhY2subGVuZ3RoIC0gMSldID0gXCJcIjtcbiAgICB9XG4gICAgdGhpcy50aXAgPSB0aGlzLm15c3RhY2tbdGhpcy5teXN0YWNrLmxlbmd0aCAtIDFdO1xufTtcbkNTTC5TdGFjay5wcm90b3R5cGUucG9wID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciByZXQgPSB0aGlzLm15c3RhY2sucG9wKCk7XG4gICAgaWYgKHRoaXMubXlzdGFjay5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy50aXAgPSB0aGlzLm15c3RhY2tbdGhpcy5teXN0YWNrLmxlbmd0aCAtIDFdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudGlwID0ge307XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLlN0YWNrLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5teXN0YWNrLnNsaWNlKC0xKVswXTtcbn07XG5DU0wuU3RhY2sucHJvdG90eXBlLmxlbmd0aCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5teXN0YWNrLmxlbmd0aDtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5QYXJhbGxlbCA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICB0aGlzLnNldHMgPSBuZXcgQ1NMLlN0YWNrKFtdKTtcbiAgICB0aGlzLnRyeV9jaXRlID0gdHJ1ZTtcbiAgICB0aGlzLnVzZV9wYXJhbGxlbHMgPSBmYWxzZTtcbiAgICB0aGlzLm1pZFZhcnMgPSBbXCJzZWN0aW9uXCIsIFwidm9sdW1lXCIsIFwiY29udGFpbmVyLXRpdGxlXCIsIFwiY29sbGVjdGlvbi1udW1iZXJcIiwgXCJpc3N1ZVwiLCBcInBhZ2UtZmlyc3RcIiwgXCJwYWdlXCIsIFwibnVtYmVyXCJdO1xuICAgIHRoaXMuaWdub3JlVmFyc0xhd0dlbmVyYWwgPSBbXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIiwgXCJsb2NhdG9yXCIsIFwibGFiZWxcIixcInBhZ2UtZmlyc3RcIixcInBhZ2VcIixcImdlbnJlXCJdO1xuICAgIHRoaXMuaWdub3JlVmFyc0xhd1Byb2NlZHVyYWxIaXN0b3J5ID0gW1wiaXNzdWVkXCIsIFwiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCIsIFwibG9jYXRvclwiLCBcImxhYmVsXCIsXCJwYWdlLWZpcnN0XCIsXCJwYWdlXCIsXCJnZW5yZVwiLFwianVyaXNkaWN0aW9uXCJdO1xuICAgIHRoaXMuaWdub3JlVmFyc09yZGVycyA9IFtcImZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlclwiXTtcbiAgICB0aGlzLmlnbm9yZVZhcnNPdGhlciA9IFtcImZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlclwiLCBcImxvY2F0b3JcIiwgXCJsYWJlbFwiLFwic2VjdGlvblwiLFwicGFnZS1maXJzdFwiLFwicGFnZVwiXTtcbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLmlzTWlkID0gZnVuY3Rpb24gKHZhcmlhYmxlKSB7XG4gICAgcmV0dXJuICh0aGlzLm1pZFZhcnMuaW5kZXhPZih2YXJpYWJsZSkgPiAtMSk7XG59O1xuQ1NMLlBhcmFsbGVsLnByb3RvdHlwZS5TdGFydENpdGF0aW9uID0gZnVuY3Rpb24gKHNvcnRlZEl0ZW1zLCBvdXQpIHtcbiAgICB0aGlzLnBhcmFsbGVsX2NvbmRpdGlvbmFsX2Jsb2JzX2xpc3QgPSBbXTtcbiAgICBpZiAodGhpcy51c2VfcGFyYWxsZWxzKSB7XG4gICAgICAgIHRoaXMuc29ydGVkSXRlbXMgPSBzb3J0ZWRJdGVtcztcbiAgICAgICAgdGhpcy5zb3J0ZWRJdGVtc1BvcyA9IC0xO1xuICAgICAgICB0aGlzLnNldHMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5zZXRzLnB1c2goW10pO1xuICAgICAgICB0aGlzLmluX3NlcmllcyA9IHRydWU7XG4gICAgICAgIHRoaXMuZGVsaW1fY291bnRlciA9IDA7XG4gICAgICAgIHRoaXMuZGVsaW1fcG9pbnRlcnMgPSBbXTtcbiAgICAgICAgaWYgKG91dCkge1xuICAgICAgICAgICAgdGhpcy5vdXQgPSBvdXQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm91dCA9IHRoaXMuc3RhdGUub3V0cHV0LnF1ZXVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubWFzdGVyX3dhc19uZXV0cmFsX2NpdGUgPSB0cnVlO1xuICAgIH1cbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLlN0YXJ0Q2l0ZSA9IGZ1bmN0aW9uIChJdGVtLCBpdGVtLCBwcmV2SXRlbUlEKSB7XG4gICAgdmFyIHBvc2l0aW9uLCBsZW4sIHBvcywgeCwgY3VyciwgbWFzdGVyLCBsYXN0X2lkLCBwcmV2X2xvY2F0b3IsIGN1cnJfbG9jYXRvciwgaXNfbWFzdGVyLCBwYXJhbGxlbDtcbiAgICBpZiAodGhpcy51c2VfcGFyYWxsZWxzKSB7XG4gICAgICAgIGlmICh0aGlzLnNldHMudmFsdWUoKS5sZW5ndGggJiYgdGhpcy5zZXRzLnZhbHVlKClbMF0uaXRlbUlkID09IEl0ZW0uaWQpIHtcbiAgICAgICAgICAgIHRoaXMuQ29tcG9zZVNldCgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc29ydGVkSXRlbXNQb3MgKz0gMTtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICAgIHBvc2l0aW9uID0gaXRlbS5wb3NpdGlvbjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRyeV9jaXRlID0gdHJ1ZTtcbiAgICAgICAgdmFyIGhhc19yZXF1aXJlZF92YXIgPSBmYWxzZTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBDU0wuUEFSQUxMRUxfTUFUQ0hfVkFSUy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChJdGVtW0NTTC5QQVJBTExFTF9NQVRDSF9WQVJTW2ldXSkge1xuICAgICAgICAgICAgICAgIGhhc19yZXF1aXJlZF92YXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBiYXNpY3Nfb2sgPSB0cnVlO1xuICAgICAgICB2YXIgbGFzdF9jaXRlID0gdGhpcy5zZXRzLnZhbHVlKCkuc2xpY2UoLTEpWzBdO1xuICAgICAgICBpZiAobGFzdF9jaXRlICYmIGxhc3RfY2l0ZS5JdGVtKSB7XG4gICAgICAgICAgICB2YXIgbGFzdEp1cmlzID0gbGFzdF9jaXRlLkl0ZW0uanVyaXNkaWN0aW9uID8gbGFzdF9jaXRlLkl0ZW0uanVyaXNkaWN0aW9uLnNwbGl0KFwiOlwiKVswXSA6IFwiXCI7XG4gICAgICAgICAgICB2YXIgdGhpc0p1cmlzID0gSXRlbS5qdXJpc2RpY3Rpb24gPyBJdGVtLmp1cmlzZGljdGlvbi5zcGxpdChcIjpcIilbMF0gOiBcIlwiO1xuICAgICAgICAgICAgaWYgKGxhc3RfY2l0ZS5JdGVtLnRpdGxlICE9PSBJdGVtLnRpdGxlKSB7XG4gICAgICAgICAgICAgICAgYmFzaWNzX29rID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGxhc3RKdXJpcyAhPT0gdGhpc0p1cmlzKSB7XG4gICAgICAgICAgICAgICAgYmFzaWNzX29rID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGxhc3RfY2l0ZS5JdGVtLnR5cGUgIT09IEl0ZW0udHlwZSkge1xuICAgICAgICAgICAgICAgIGJhc2ljc19vayA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChbXCJhcnRpY2xlLWpvdXJuYWxcIixcImFydGljbGUtbWFnYXppbmVcIl0uaW5kZXhPZihJdGVtLnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuaGFuZGxlX3BhcmFsbGVsX2FydGljbGVzXG4gICAgICAgICAgICAgICAgICAgfHwgbGFzdF9jaXRlLkl0ZW1bXCJjb250YWluZXItdGl0bGVcIl0gIT09IEl0ZW1bXCJjb250YWluZXItdGl0bGVcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgYmFzaWNzX29rID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghYmFzaWNzX29rIHx8ICFoYXNfcmVxdWlyZWRfdmFyIHx8IENTTC5QQVJBTExFTF9UWVBFUy5pbmRleE9mKEl0ZW0udHlwZSkgPT09IC0xKSB7XG4gICAgICAgICAgICB0aGlzLnRyeV9jaXRlID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmICh0aGlzLmluX3Nlcmllcykge1xuICAgICAgICAgICAgICAgIHRoaXMuaW5fc2VyaWVzID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaXRlID0ge307XG4gICAgICAgIHRoaXMuY2l0ZS5mcm9udCA9IFtdO1xuICAgICAgICB0aGlzLmNpdGUubWlkID0gW107XG4gICAgICAgIHRoaXMuY2l0ZS5iYWNrID0gW107XG4gICAgICAgIHRoaXMuY2l0ZS5mcm9udF9jb2xsYXBzZSA9IHt9O1xuICAgICAgICB0aGlzLmNpdGUuYmFja19mb3JjZW1lID0gW107XG4gICAgICAgIHRoaXMuY2l0ZS5wb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgICB0aGlzLmNpdGUuSXRlbSA9IEl0ZW07XG4gICAgICAgIHRoaXMuY2l0ZS5pdGVtSWQgPSBcIlwiICsgSXRlbS5pZDtcbiAgICAgICAgdGhpcy5jaXRlLnByZXZJdGVtSUQgPSBcIlwiICsgcHJldkl0ZW1JRDtcbiAgICAgICAgdGhpcy50YXJnZXQgPSBcImZyb250XCI7XG4gICAgICAgIGlmIChbXCJ0cmVhdHlcIl0uaW5kZXhPZihJdGVtLnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgIHRoaXMuaWdub3JlVmFycyA9IHRoaXMuaWdub3JlVmFyc09yZGVycztcbiAgICAgICAgfSBlbHNlIGlmIChbXCJhcnRpY2xlLWpvdXJuYWxcIixcImFydGljbGUtbWFnYXppbmVcIl0uaW5kZXhPZihJdGVtLnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgIHRoaXMuaWdub3JlVmFycyA9IHRoaXMuaWdub3JlVmFyc090aGVyO1xuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0gJiYgaXRlbS5wcmVmaXgpIHtcbiAgICAgICAgICAgIHRoaXMuaWdub3JlVmFycyA9IHRoaXMuaWdub3JlVmFyc0xhd1Byb2NlZHVyYWxIaXN0b3J5O1xuICAgICAgICAgICAgdGhpcy5jaXRlLnVzZVByb2NlZHVyYWxIaXN0b3J5ID0gdHJ1ZTtcbiAgICAgICAgICAgIHZhciBwcmV2ID0gdGhpcy5zZXRzLnZhbHVlKClbKHRoaXMuc2V0cy52YWx1ZSgpLmxlbmd0aCAtIDEpXTtcbiAgICAgICAgICAgIGlmIChwcmV2ICYmIHByZXYuYmFjaykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9cHJldi5iYWNrLmxlbmd0aC0xO2k+LTE7aSs9LTEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXYuYmFja1tpXSAmJiBwcmV2W3ByZXYuYmFja1tpXV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwcmV2W3ByZXYuYmFja1tpXV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmlnbm9yZVZhcnMgPSB0aGlzLmlnbm9yZVZhcnNMYXdHZW5lcmFsO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnNvcnRlZEl0ZW1zICYmIHRoaXMuc29ydGVkSXRlbXNQb3MgPiAwICYmIHRoaXMuc29ydGVkSXRlbXNQb3MgPCB0aGlzLnNvcnRlZEl0ZW1zLmxlbmd0aCkge1xuICAgICAgICAgICAgY3VyciA9IHRoaXMuc29ydGVkSXRlbXNbdGhpcy5zb3J0ZWRJdGVtc1Bvc11bMV07XG4gICAgICAgICAgICBsYXN0X2lkID0gXCJcIiArIHRoaXMuc29ydGVkSXRlbXNbKHRoaXMuc29ydGVkSXRlbXNQb3MgLSAxKV1bMV0uaWQ7XG4gICAgICAgICAgICBtYXN0ZXIgPSB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2xhc3RfaWRdLnBhcmFsbGVsO1xuICAgICAgICAgICAgcHJldl9sb2NhdG9yID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAobWFzdGVyID09IGN1cnIuaWQpIHtcbiAgICAgICAgICAgICAgICBsZW4gPSB0aGlzLnNvcnRlZEl0ZW1zUG9zIC0gMTtcbiAgICAgICAgICAgICAgICBmb3IgKHBvcyA9IGxlbjsgcG9zID4gLTE7IHBvcyArPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zb3J0ZWRJdGVtc1twb3NdWzFdLmlkID09IEl0ZW0uaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZfbG9jYXRvciA9IHRoaXMuc29ydGVkSXRlbXNbcG9zXVsxXS5sb2NhdG9yO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY3Vycl9sb2NhdG9yID0gdGhpcy5zb3J0ZWRJdGVtc1t0aGlzLnNvcnRlZEl0ZW1zUG9zXVsxXS5sb2NhdG9yO1xuICAgICAgICAgICAgICAgIGlmICghcHJldl9sb2NhdG9yICYmIGN1cnJfbG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICBjdXJyLnBvc2l0aW9uID0gQ1NMLlBPU0lUSU9OX0lCSURfV0lUSF9MT0NBVE9SO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY3Vycl9sb2NhdG9yID09PSBwcmV2X2xvY2F0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgY3Vyci5wb3NpdGlvbiA9IENTTC5QT1NJVElPTl9JQklEO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnIucG9zaXRpb24gPSBDU0wuUE9TSVRJT05fSUJJRF9XSVRIX0xPQ0FUT1I7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0pIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0ucGFyYWxsZWwgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudHJ5X2NpdGUgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMuZm9yY2VfY29sbGFwc2UgPSBmYWxzZTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmZvcmNlX2NvbGxhcHNlID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLnBhcmFsbGVsKSB7XG4gICAgICAgICAgICB0aGlzLmZvcmNlX2NvbGxhcHNlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLlN0YXJ0VmFyaWFibGUgPSBmdW5jdGlvbiAodmFyaWFibGUsIHJlYWxfdmFyaWFibGUpIHtcbiAgICBpZiAodGhpcy51c2VfcGFyYWxsZWxzICYmICh0aGlzLnRyeV9jaXRlIHx8IHRoaXMuZm9yY2VfY29sbGFwc2UpKSB7XG4gICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJuYW1lc1wiKSB7XG4gICAgICAgICAgICB0aGlzLnZhcmlhYmxlID0gdmFyaWFibGUgKyBcIjpcIiArIHRoaXMudGFyZ2V0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy52YXJpYWJsZSA9IHZhcmlhYmxlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmlnbm9yZVZhcnMuaW5kZXhPZih2YXJpYWJsZSkgPiAtMSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJjb250YWluZXItdGl0bGVcIiAmJiB0aGlzLnNldHMudmFsdWUoKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMubWFzdGVyX3dhc19uZXV0cmFsX2NpdGUgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRhdGEgPSB7fTtcbiAgICAgICAgdGhpcy5kYXRhLnZhbHVlID0gXCJcIjtcbiAgICAgICAgdGhpcy5kYXRhLmJsb2JzID0gW107XG4gICAgICAgIHZhciBpc19taWQgPSB0aGlzLmlzTWlkKHZhcmlhYmxlKTtcbiAgICAgICAgaWYgKHJlYWxfdmFyaWFibGUgPT09IFwiYXV0aG9yaXR5XCIgJiYgdGhpcy52YXJpYWJsZSA9PT0gXCJuYW1lczpmcm9udFwiICYmIHRoaXMuc2V0cy52YWx1ZSgpLmxlbmd0aCkge1xuICAgICAgICAgICAgdmFyIHByZXYgPSB0aGlzLnNldHMudmFsdWUoKVsodGhpcy5zZXRzLnZhbHVlKCkubGVuZ3RoIC0gMSldLkl0ZW07XG4gICAgICAgICAgICB2YXIgdGhpc0F1dGhvcml0eSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHRoaXMuY2l0ZS5JdGVtLmF1dGhvcml0eSAmJiB0aGlzLmNpdGUuSXRlbS5hdXRob3JpdHkubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpc0F1dGhvcml0eSA9IHRoaXMuY2l0ZS5JdGVtLmF1dGhvcml0eVswXS5saXRlcmFsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHRoYXRBdXRob3JpdHkgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChwcmV2LmF1dGhvcml0eSAmJiBwcmV2LmF1dGhvcml0eS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aGF0QXV0aG9yaXR5ID0gcHJldi5hdXRob3JpdHlbMF0ubGl0ZXJhbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzQXV0aG9yaXR5ICE9PSB0aGF0QXV0aG9yaXR5KSB7XG4gICAgICAgICAgICAgICAgdGhpcy50cnlfY2l0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5pbl9zZXJpZXMgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50YXJnZXQgPT09IFwiZnJvbnRcIiAmJiBpc19taWQpIHtcbiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gXCJtaWRcIjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRhcmdldCA9PT0gXCJtaWRcIiAmJiAhaXNfbWlkICYmIHRoaXMuY2l0ZS5JdGVtLnRpdGxlICYmIHZhcmlhYmxlICE9PSBcIm5hbWVzXCIpIHtcbiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gXCJiYWNrXCI7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy50YXJnZXQgPT09IFwiYmFja1wiICYmIGlzX21pZCkge1xuICAgICAgICAgICAgdGhpcy50cnlfY2l0ZSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmluX3NlcmllcyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgdGhpcy5jaXRlLmZyb250LnB1c2godGhpcy52YXJpYWJsZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoQ1NMLlBBUkFMTEVMX0NPTExBUFNJTkdfTUlEX1ZBUlNFVC5pbmRleE9mKHZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICBpZiAoW1wiYXJ0aWNsZS1qb3VybmFsXCIsXCJhcnRpY2xlLW1hZ2F6aW5lXCJdLmluZGV4T2YodGhpcy5jaXRlLkl0ZW0udHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5taWQucHVzaCh0aGlzLnZhcmlhYmxlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaXRlLmZyb250LnB1c2godGhpcy52YXJpYWJsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNpdGVbdGhpcy50YXJnZXRdLnB1c2godGhpcy52YXJpYWJsZSk7XG4gICAgICAgIH1cbiAgIH1cbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLkFwcGVuZEJsb2JQb2ludGVyID0gZnVuY3Rpb24gKGJsb2IpIHtcbiAgICBpZiAodGhpcy51c2VfcGFyYWxsZWxzKSB7XG4gICAgICAgIGlmICh0aGlzLmlnbm9yZVZhcnMuaW5kZXhPZih0aGlzLnZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudXNlX3BhcmFsbGVscyAmJiAodGhpcy5mb3JjZV9jb2xsYXBzZSB8fCB0aGlzLnRyeV9jaXRlKSkge1xuICAgICAgICAgICAgaWYgKFtcImFydGljbGUtam91cm5hbFwiLCBcImFydGljbGUtbWFnYXppbmVcIl0uaW5kZXhPZih0aGlzLmNpdGUuSXRlbS50eXBlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgaWYgKFtcInZvbHVtZVwiLFwicGFnZVwiLFwicGFnZS1maXJzdFwiLFwiaXNzdWVcIl0uaW5kZXhPZih0aGlzLnZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKFwiY29udGFpbmVyLXRpdGxlXCIgPT09IHRoaXMudmFyaWFibGUgJiYgdGhpcy5jaXRlLm1pZC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy52YXJpYWJsZSAmJiAodGhpcy50cnlfY2l0ZSB8fCB0aGlzLmZvcmNlX2NvbGxhcHNlKSAmJiBibG9iICYmIGJsb2IuYmxvYnMpIHtcbiAgICAgICAgICAgICAgICBpZiAoISh0aGlzLmNpdGUudXNlUHJvY2VkdXJhbEhpc3RvcnkgJiYgdGhpcy50YXJnZXQgPT09IFwiYmFja1wiKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEuYmxvYnMucHVzaChbYmxvYiwgYmxvYi5ibG9icy5sZW5ndGhdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLlBhcmFsbGVsLnByb3RvdHlwZS5BcHBlbmRUb1ZhcmlhYmxlID0gZnVuY3Rpb24gKHN0ciwgdmFybmFtZSkge1xuICAgIGlmICh0aGlzLnVzZV9wYXJhbGxlbHMpIHtcbiAgICAgICAgaWYgKHRoaXMuaWdub3JlVmFycy5pbmRleE9mKHRoaXMudmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50cnlfY2l0ZSB8fCB0aGlzLmZvcmNlX2NvbGxhcHNlKSB7XG4gICAgICAgICAgICBpZiAodGhpcy50YXJnZXQgIT09IFwiYmFja1wiIHx8IHRydWUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGEudmFsdWUgKz0gXCI6OlwiICsgc3RyO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgcHJldiA9IHRoaXMuc2V0cy52YWx1ZSgpWyh0aGlzLnNldHMudmFsdWUoKS5sZW5ndGggLSAxKV07XG4gICAgICAgICAgICAgICAgaWYgKHByZXYpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZbdGhpcy52YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2W3RoaXMudmFyaWFibGVdLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXRhLnZhbHVlICs9IFwiOjpcIiArIHN0cjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLkNsb3NlVmFyaWFibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMudXNlX3BhcmFsbGVscykge1xuICAgICAgICBpZiAodGhpcy5pZ25vcmVWYXJzLmluZGV4T2YodGhpcy52YXJpYWJsZSkgPiAtMSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRyeV9jaXRlIHx8IHRoaXMuZm9yY2VfY29sbGFwc2UpIHtcbiAgICAgICAgICAgIHRoaXMuY2l0ZVt0aGlzLnZhcmlhYmxlXSA9IHRoaXMuZGF0YTtcbiAgICAgICAgICAgIGlmICh0aGlzLnNldHMudmFsdWUoKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgdmFyIHByZXYgPSB0aGlzLnNldHMudmFsdWUoKVsodGhpcy5zZXRzLnZhbHVlKCkubGVuZ3RoIC0gMSldO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldCA9PT0gXCJmcm9udFwiICYmIHRoaXMudmFyaWFibGUgPT09IFwiaXNzdWVkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YS52YWx1ZSAmJiB0aGlzLm1hc3Rlcl93YXNfbmV1dHJhbF9jaXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhcmdldCA9IFwibWlkXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0ID09PSBcImZyb250XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKChwcmV2W3RoaXMudmFyaWFibGVdIHx8IHRoaXMuZGF0YS52YWx1ZSkgJiYgKCFwcmV2W3RoaXMudmFyaWFibGVdIHx8IHRoaXMuZGF0YS52YWx1ZSAhPT0gcHJldlt0aGlzLnZhcmlhYmxlXS52YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcImlzc3VlZFwiICE9PSB0aGlzLnZhcmlhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbl9zZXJpZXMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50YXJnZXQgPT09IFwibWlkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKENTTC5QQVJBTExFTF9DT0xMQVBTSU5HX01JRF9WQVJTRVQuaW5kZXhPZih0aGlzLnZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldlt0aGlzLnZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2W3RoaXMudmFyaWFibGVdLnZhbHVlID09PSB0aGlzLmRhdGEudmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaXRlLmZyb250X2NvbGxhcHNlW3RoaXMudmFyaWFibGVdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNpdGUuZnJvbnRfY29sbGFwc2VbdGhpcy52YXJpYWJsZV0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5mcm9udF9jb2xsYXBzZVt0aGlzLnZhcmlhYmxlXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRhcmdldCA9PT0gXCJiYWNrXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZbdGhpcy52YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhdGEudmFsdWUgIT09IHByZXZbdGhpcy52YXJpYWJsZV0udmFsdWUgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgdGhpcy5zZXRzLnZhbHVlKCkuc2xpY2UoLTEpWzBdLmJhY2tfZm9yY2VtZS5pbmRleE9mKHRoaXMudmFyaWFibGUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5fc2VyaWVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy52YXJpYWJsZSA9IGZhbHNlO1xuICAgIH1cbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLkNsb3NlQ2l0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgeCwgcG9zLCBsZW4sIGhhc19pc3N1ZWQsIHVzZV9qb3VybmFsX2luZm8sIHZvbHVtZV9wb3MsIGNvbnRhaW5lcl90aXRsZV9wb3MsIHNlY3Rpb25fcG9zO1xuICAgIGlmICh0aGlzLnVzZV9wYXJhbGxlbHMgJiYgKHRoaXMuZm9yY2VfY29sbGFwc2UgfHwgdGhpcy50cnlfY2l0ZSkpIHtcbiAgICAgICAgdXNlX2pvdXJuYWxfaW5mbyA9IGZhbHNlO1xuICAgICAgICBpZiAoIXRoaXMuY2l0ZS5mcm9udF9jb2xsYXBzZVtcImNvbnRhaW5lci10aXRsZVwiXSkge1xuICAgICAgICAgICAgdXNlX2pvdXJuYWxfaW5mbyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuY2l0ZS5mcm9udF9jb2xsYXBzZS52b2x1bWUgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICB1c2Vfam91cm5hbF9pbmZvID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5jaXRlLmZyb250X2NvbGxhcHNlW1wiY29sbGVjdGlvbi1udW1iZXJcIl0gPT09IGZhbHNlKSB7XG4gICAgICAgICAgICB1c2Vfam91cm5hbF9pbmZvID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5jaXRlLmZyb250X2NvbGxhcHNlLnNlY3Rpb24gPT09IGZhbHNlKSB7XG4gICAgICAgICAgICB1c2Vfam91cm5hbF9pbmZvID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodXNlX2pvdXJuYWxfaW5mbykge1xuICAgICAgICAgICAgdGhpcy5jaXRlLnVzZV9qb3VybmFsX2luZm8gPSB0cnVlO1xuICAgICAgICAgICAgc2VjdGlvbl9wb3MgPSB0aGlzLmNpdGUuZnJvbnQuaW5kZXhPZihcInNlY3Rpb25cIik7XG4gICAgICAgICAgICBpZiAoc2VjdGlvbl9wb3MgPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5mcm9udCA9IHRoaXMuY2l0ZS5mcm9udC5zbGljZSgwLHNlY3Rpb25fcG9zKS5jb25jYXQodGhpcy5jaXRlLmZyb250LnNsaWNlKHNlY3Rpb25fcG9zICsgMSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdm9sdW1lX3BvcyA9IHRoaXMuY2l0ZS5mcm9udC5pbmRleE9mKFwidm9sdW1lXCIpO1xuICAgICAgICAgICAgaWYgKHZvbHVtZV9wb3MgPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5mcm9udCA9IHRoaXMuY2l0ZS5mcm9udC5zbGljZSgwLHZvbHVtZV9wb3MpLmNvbmNhdCh0aGlzLmNpdGUuZnJvbnQuc2xpY2Uodm9sdW1lX3BvcyArIDEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnRhaW5lcl90aXRsZV9wb3MgPSB0aGlzLmNpdGUuZnJvbnQuaW5kZXhPZihcImNvbnRhaW5lci10aXRsZVwiKTtcbiAgICAgICAgICAgIGlmIChjb250YWluZXJfdGl0bGVfcG9zID4gLTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNpdGUuZnJvbnQgPSB0aGlzLmNpdGUuZnJvbnQuc2xpY2UoMCxjb250YWluZXJfdGl0bGVfcG9zKS5jb25jYXQodGhpcy5jaXRlLmZyb250LnNsaWNlKGNvbnRhaW5lcl90aXRsZV9wb3MgKyAxKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgY29sbGVjdGlvbl9udW1iZXJfcG9zID0gdGhpcy5jaXRlLmZyb250LmluZGV4T2YoXCJjb2xsZWN0aW9uLW51bWJlclwiKTtcbiAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uX251bWJlcl9wb3MgPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5mcm9udCA9IHRoaXMuY2l0ZS5mcm9udC5zbGljZSgwLGNvbGxlY3Rpb25fbnVtYmVyX3BvcykuY29uY2F0KHRoaXMuY2l0ZS5mcm9udC5zbGljZShjb2xsZWN0aW9uX251bWJlcl9wb3MgKyAxKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmluX3NlcmllcyAmJiAhdGhpcy5mb3JjZV9jb2xsYXBzZSkge1xuICAgICAgICAgICAgdGhpcy5Db21wb3NlU2V0KHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnNldHMudmFsdWUoKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHZhciBoYXNfZGF0ZSA9IGZhbHNlO1xuICAgICAgICAgICAgZm9yIChwb3MgPSAwLCBsZW4gPSB0aGlzLmNpdGUuYmFjay5sZW5ndGg7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgICAgICB4ID0gdGhpcy5jaXRlLmJhY2tbcG9zXTtcbiAgICAgICAgICAgICAgICBpZiAoeCA9PT0gXCJpc3N1ZWRcIiAmJiB0aGlzLmNpdGVbXCJpc3N1ZWRcIl0gJiYgdGhpcy5jaXRlW1wiaXNzdWVkXCJdLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhc19kYXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFoYXNfZGF0ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5iYWNrX2ZvcmNlbWUucHVzaChcImlzc3VlZFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBpZHggPSB0aGlzLmNpdGUuZnJvbnQuaW5kZXhPZihcImlzc3VlZFwiKTtcbiAgICAgICAgICAgIGlmIChpZHggPT09IC0xIHx8IHRoaXMubWFzdGVyX3dhc19uZXV0cmFsX2NpdGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNpdGUuYmFja19mb3JjZW1lID0gdGhpcy5zZXRzLnZhbHVlKCkuc2xpY2UoLTEpWzBdLmJhY2tfZm9yY2VtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpZHggPiAtMSkge1xuICAgICAgICAgICAgICAgIHZhciBwcmV2ID0gdGhpcy5zZXRzLnZhbHVlKClbdGhpcy5zZXRzLnZhbHVlKCkubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICAgICAgaWYgKCFwcmV2W1wiaXNzdWVkXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5mcm9udCA9IHRoaXMuY2l0ZS5mcm9udC5zbGljZSgwLCBpZHgpLmNvbmNhdCh0aGlzLmNpdGUuZnJvbnQuc2xpY2UoaWR4ICsgMSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLm1hc3Rlcl93YXNfbmV1dHJhbF9jaXRlICYmIHRoaXMuY2l0ZS5taWQuaW5kZXhPZihcIm5hbWVzOm1pZFwiKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaXRlLmZyb250LnB1c2goXCJuYW1lczptaWRcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRzLnZhbHVlKCkucHVzaCh0aGlzLmNpdGUpO1xuICAgIH1cbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLkNvbXBvc2VTZXQgPSBmdW5jdGlvbiAobmV4dF9vdXRwdXRfaW5fcHJvZ3Jlc3MpIHtcbiAgICB2YXIgY2l0ZSwgcG9zLCBtYXN0ZXIsIGxlbjtcbiAgICBpZiAodGhpcy51c2VfcGFyYWxsZWxzICYmICh0aGlzLmZvcmNlX2NvbGxhcHNlIHx8IHRoaXMudHJ5X2NpdGUpKSB7XG4gICAgICAgIHZhciBsZW5ndGhDaGVjayA9IHRoaXMuc2V0cy52YWx1ZSgpLmxlbmd0aDtcbiAgICAgICAgaWYgKHRoaXMuc2V0cy52YWx1ZSgpLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmluX3Nlcmllcykge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0cy52YWx1ZSgpLnBvcCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGVsaW1fY291bnRlciArPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGVuID0gdGhpcy5zZXRzLnZhbHVlKCkubGVuZ3RoO1xuICAgICAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgY2l0ZSA9IHRoaXMuc2V0cy52YWx1ZSgpW3Bvc107XG4gICAgICAgICAgICAgICAgaWYgKHBvcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlbGltX2NvdW50ZXIgKz0gMTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWNpdGUuSXRlbS50aXRsZSAmJiBjaXRlLnVzZV9qb3VybmFsX2luZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVsaW1fcG9pbnRlcnMucHVzaChmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlbGltX3BvaW50ZXJzLnB1c2godGhpcy5kZWxpbV9jb3VudGVyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlbGltX2NvdW50ZXIgKz0gMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKENTTC5QT1NJVElPTl9GSVJTVCA9PT0gY2l0ZS5wb3NpdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBpZiAocG9zID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUuaXRlbUlkXS5tYXN0ZXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtjaXRlLml0ZW1JZF0uc2libGluZ3MgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbY2l0ZS5pdGVtSWRdLnBhcmFsbGVsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2l0ZS5wcmV2SXRlbUlEKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUucHJldkl0ZW1JRF0ucGFyYWxsZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtjaXRlLml0ZW1JZF0ucGFyYWxsZWwgPSBjaXRlLnByZXZJdGVtSUQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtjaXRlLml0ZW1JZF0ucGFyYWxsZWwgPSB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUucHJldkl0ZW1JRF0ucGFyYWxsZWw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbY2l0ZS5pdGVtSWRdLnNpYmxpbmdzID0gdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtjaXRlLnByZXZJdGVtSURdLnNpYmxpbmdzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtjaXRlLml0ZW1JZF0uc2libGluZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtjaXRlLml0ZW1JZF0uc2libGluZ3MgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLmRlYnVnKFwiV0FSTklORzogYWRkaW5nIG1pc3Npbmcgc2libGluZ3MgYXJyYXkgdG8gcmVnaXN0cnkgb2JqZWN0XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUuaXRlbUlkXS5zaWJsaW5ncy5wdXNoKGNpdGUuaXRlbUlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0cy5wdXNoKFtdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobGVuZ3RoQ2hlY2sgPCAyKSB7XG4gICAgICAgICAgICB0aGlzLnB1cmdlR3JvdXBzSWZQYXJhbGxlbChmYWxzZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnB1cmdlR3JvdXBzSWZQYXJhbGxlbCh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmluX3NlcmllcyA9IHRydWU7XG4gICAgfVxufTtcbkNTTC5QYXJhbGxlbC5wcm90b3R5cGUuUHJ1bmVPdXRwdXRRdWV1ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgbGVuLCBwb3MsIHNlcmllcywgcHBvcywgbGxlbiwgY2l0ZTtcbiAgICBpZiAodGhpcy51c2VfcGFyYWxsZWxzKSB7XG4gICAgICAgIGxlbiA9IHRoaXMuc2V0cy5teXN0YWNrLmxlbmd0aDtcbiAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICBzZXJpZXMgPSB0aGlzLnNldHMubXlzdGFja1twb3NdO1xuICAgICAgICAgICAgaWYgKHNlcmllcy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgbGxlbiA9IHNlcmllcy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgZm9yIChwcG9zID0gMDsgcHBvcyA8IGxsZW47IHBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBjaXRlID0gc2VyaWVzW3Bwb3NdO1xuICAgICAgICAgICAgICAgICAgICBpZiAocHBvcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJnZVZhcmlhYmxlQmxvYnMoY2l0ZSwgY2l0ZS5iYWNrKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcG9zID09PSAoc2VyaWVzLmxlbmd0aCAtIDEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmdlVmFyaWFibGVCbG9icyhjaXRlLCBjaXRlLmZyb250LmNvbmNhdChjaXRlLmJhY2tfZm9yY2VtZSkpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXJnZVZhcmlhYmxlQmxvYnMoY2l0ZSwgY2l0ZS5mcm9udC5jb25jYXQoY2l0ZS5iYWNrKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLlBhcmFsbGVsLnByb3RvdHlwZS5wdXJnZVZhcmlhYmxlQmxvYnMgPSBmdW5jdGlvbiAoY2l0ZSwgdmFybmFtZXMpIHtcbiAgICB2YXIgbGVuLCBwb3MsIHZhcm5hbWUsIGIsIGxsZW4sIHBwb3MsIG91dDtcbiAgICBpZiAodGhpcy51c2VfcGFyYWxsZWxzKSB7XG4gICAgICAgIG91dCA9IHRoaXMuc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKTtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBvdXQubGVuZ3RoKSB7XG4gICAgICAgICAgICBvdXQgPSBvdXQuYmxvYnM7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChwb3MgPSAwLCBsZW4gPSB0aGlzLmRlbGltX3BvaW50ZXJzLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgcHBvcyA9IHRoaXMuZGVsaW1fcG9pbnRlcnNbcG9zXTtcbiAgICAgICAgICAgIGlmIChwcG9zICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIG91dFtwcG9zXS5wYXJhbGxlbF9kZWxpbWl0ZXIgPSBcIiwgXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGVuID0gdmFybmFtZXMubGVuZ3RoIC0gMTtcbiAgICAgICAgZm9yIChwb3MgPSBsZW47IHBvcyA+IC0xOyBwb3MgKz0gLTEpIHtcbiAgICAgICAgICAgIHZhcm5hbWUgPSB2YXJuYW1lc1twb3NdO1xuICAgICAgICAgICAgaWYgKGNpdGVbdmFybmFtZV0pIHtcbiAgICAgICAgICAgICAgICBsbGVuID0gY2l0ZVt2YXJuYW1lXS5ibG9icy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgICAgIGZvciAocHBvcyA9IGxsZW47IHBwb3MgPiAtMTsgcHBvcyArPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBiID0gY2l0ZVt2YXJuYW1lXS5ibG9ic1twcG9zXTtcbiAgICAgICAgICAgICAgICAgICAgYlswXS5ibG9icyA9IGJbMF0uYmxvYnMuc2xpY2UoMCwgYlsxXSkuY29uY2F0KGJbMF0uYmxvYnMuc2xpY2UoKGJbMV0gKyAxKSkpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5oYXNfcHVyZ2VkX3BhcmFsbGVsID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJbMF0gJiYgYlswXS5zdHJpbmdzICYmIFwic3RyaW5nXCIgPT0gdHlwZW9mIGJbMF0uc3RyaW5ncy5vb3BzXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiBiWzBdLnBhcmVudCAmJiBiWzBdLnBhcmVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYlswXS5wYXJlbnQucGFyZW50LnN0cmluZ3MuZGVsaW1pdGVyID0gYlswXS5zdHJpbmdzLm9vcHM7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLlBhcmFsbGVsLnByb3RvdHlwZS5wdXJnZUdyb3Vwc0lmUGFyYWxsZWwgPSBmdW5jdGlvbiAob3JpZ2luYWxfY29uZGl0aW9uKSB7XG4gICAgZm9yICh2YXIgaSA9IHRoaXMucGFyYWxsZWxfY29uZGl0aW9uYWxfYmxvYnNfbGlzdC5sZW5ndGggLSAxOyBpID4gLTE7IGkgKz0gLTEpIHtcbiAgICAgICAgdmFyIG9iaiA9IHRoaXMucGFyYWxsZWxfY29uZGl0aW9uYWxfYmxvYnNfbGlzdFtpXTtcbiAgICAgICAgdmFyIHB1cmdlbWUgPSB0cnVlO1xuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IG9iai5jb25kaXRpb25zLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgaWYgKCEoIW9iai5jb25kaXRpb25zW2pdID09PSAhIW9yaWdpbmFsX2NvbmRpdGlvblxuICAgICAgICAgICAgICAgIHx8IChcIm1hc3RlclwiID09PSBvYmouY29uZGl0aW9uc1tqXVxuICAgICAgICAgICAgICAgICAgICAmJiAhdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtvYmouaWRdLm1hc3RlcilcbiAgICAgICAgICAgICAgICB8fCAoXCJzZXJ2YW50XCIgPT09IG9iai5jb25kaXRpb25zW2pdXG4gICAgICAgICAgICAgICAgICAgICYmICF0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W29iai5pZF0ucGFyYWxsZWwpKSkge1xuICAgICAgICAgICAgICAgIHZhciBwdXJnZW1lID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHB1cmdlbWUpIHtcbiAgICAgICAgICAgIHZhciBidWZmZXIgPSBbXTtcbiAgICAgICAgICAgIHdoaWxlIChvYmouYmxvYnMubGVuZ3RoID4gb2JqLnBvcykge1xuICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKG9iai5ibG9icy5wb3AoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYnVmZmVyLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGJ1ZmZlci5wb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHdoaWxlIChidWZmZXIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgb2JqLmJsb2JzLnB1c2goYnVmZmVyLnBvcCgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBhcmFsbGVsX2NvbmRpdGlvbmFsX2Jsb2JzX2xpc3QucG9wKCk7XG4gICAgfVxufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuVXRpbCA9IHt9O1xuQ1NMLlV0aWwuTWF0Y2ggPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5hbnkgPSBmdW5jdGlvbiAodG9rZW4sIHN0YXRlLCB0ZXN0cykge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCwgaWxlbj10ZXN0cy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gdGVzdHNbaV0oSXRlbSwgaXRlbSk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH07XG4gICAgfTtcbiAgICB0aGlzLm5vbmUgPSBmdW5jdGlvbiAodG9rZW4sIHN0YXRlLCB0ZXN0cykge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRlc3RzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB0ZXN0c1tpXShJdGVtLGl0ZW0pO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgIH07XG4gICAgdGhpcy5hbGwgPSBmdW5jdGlvbiAodG9rZW4sIHN0YXRlLCB0ZXN0cykge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRlc3RzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB0ZXN0c1tpXShJdGVtLGl0ZW0pO1xuICAgICAgICAgICAgICAgIGlmICghcmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICB9O1xuICAgIHRoaXNbdW5kZWZpbmVkXSA9IHRoaXMuYWxsO1xuICAgIHRoaXMubmFuZCA9IGZ1bmN0aW9uICh0b2tlbiwgc3RhdGUsIHRlc3RzKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGVzdHMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHRlc3RzW2ldKEl0ZW0saXRlbSk7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9O1xuICAgIH07XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuVHJhbnNmb3JtID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdmFyIGRlYnVnID0gZmFsc2UsIGFiYnJldmlhdGlvbnMsIHRva2VuLCBmaWVsZG5hbWUsIGFiYnJldl9mYW1pbHksIG9wdDtcbiAgICB0aGlzLmFiYnJldnMgPSB7fTtcbiAgICB0aGlzLmFiYnJldnNbXCJkZWZhdWx0XCJdID0gbmV3IHN0YXRlLnN5cy5BYmJyZXZpYXRpb25TZWdtZW50cygpO1xuICAgIHRoaXMuZ2V0VGV4dFN1YkZpZWxkID0gZ2V0VGV4dFN1YkZpZWxkO1xuICAgIGZ1bmN0aW9uIGdldENvdW50cnlPckp1cmlzZGljdGlvbih2YXJpYWJsZSwgbm9ybWFsaXplZEtleSwgcXVhc2hDb3VudHJ5KSB7XG4gICAgICAgIHZhciB2YWx1ZSA9IFwiXCI7XG4gICAgICAgIGlmIChzdGF0ZS5zeXMuZ2V0SHVtYW5Gb3JtKSB7XG4gICAgICAgICAgICBpZiAodmFyaWFibGUgPT09IFwiY291bnRyeVwiKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZS5zeXMuZ2V0SHVtYW5Gb3JtKG5vcm1hbGl6ZWRLZXkudG9Mb3dlckNhc2UoKSwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc3BsaXQoXCJ8XCIpWzBdO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh2YXJpYWJsZSA9PT0gXCJqdXJpc2RpY3Rpb25cIikge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gc3RhdGUuc3lzLmdldEh1bWFuRm9ybShub3JtYWxpemVkS2V5LnRvTG93ZXJDYXNlKCksIGZhbHNlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICBpZiAoIXF1YXNoQ291bnRyeSkge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnNwbGl0KFwifFwiKS5zbGljZSgxKS5qb2luKFwiLCBcIik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBcIlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblx0ICAgIH1cblx0ICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgZnVuY3Rpb24gYWJicmV2aWF0ZShzdGF0ZSwgdG9rLCBJdGVtLCBhbHR2YXIsIGJhc2V2YWx1ZSwgZmFtaWx5X3ZhciwgdXNlX2ZpZWxkLCBmb3JtKSB7XG4gICAgICAgIHZhciB2YWx1ZSA9IFwiXCI7XG4gICAgICAgIHZhciBteWFiYnJldl9mYW1pbHkgPSBDU0wuRklFTERfQ0FURUdPUllfUkVNQVBbZmFtaWx5X3Zhcl07XG4gICAgICAgIGlmICghbXlhYmJyZXZfZmFtaWx5KSB7XG4gICAgICAgICAgICByZXR1cm4gYmFzZXZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHZhciB2YXJpYWJsZSA9IGZhbWlseV92YXI7XG4gICAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gYmFzZXZhbHVlO1xuICAgICAgICBpZiAoc3RhdGUuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkpIHtcbiAgICAgICAgICAgIG5vcm1hbGl6ZWRLZXkgPSBzdGF0ZS5zeXMubm9ybWFsaXplQWJicmV2c0tleShmYW1pbHlfdmFyLCBiYXNldmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBxdWFzaENvdW50cnkgPSBmYWxzZTtcbiAgICAgICAgaWYgKHZhcmlhYmxlID09PSBcImp1cmlzZGljdGlvblwiICYmIG5vcm1hbGl6ZWRLZXkpIHtcbiAgICAgICAgICAgIHF1YXNoQ291bnRyeSA9IG5vcm1hbGl6ZWRLZXkuaW5kZXhPZihcIjpcIikgPT09IC0xO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGF0ZS5zeXMuZ2V0QWJicmV2aWF0aW9uKSB7XG4gICAgICAgICAgICBpZiAoW1wianVyaXNkaWN0aW9uXCIsIFwiY291bnRyeVwiLCBcImxhbmd1YWdlLW5hbWVcIiwgXCJsYW5ndWFnZS1uYW1lLW9yaWdpbmFsXCJdLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICB2YXIgbG9hZEp1cmlzZGljdGlvbiA9IFwiZGVmYXVsdFwiO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChJdGVtLmp1cmlzZGljdGlvbikge1xuICAgICAgICAgICAgICAgIHZhciBsb2FkSnVyaXNkaWN0aW9uID0gSXRlbS5qdXJpc2RpY3Rpb247XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBsb2FkSnVyaXNkaWN0aW9uID0gXCJkZWZhdWx0XCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIganVyaXNkaWN0aW9uID0gc3RhdGUudHJhbnNmb3JtLmxvYWRBYmJyZXZpYXRpb24obG9hZEp1cmlzZGljdGlvbiwgbXlhYmJyZXZfZmFtaWx5LCBub3JtYWxpemVkS2V5LCBJdGVtLnR5cGUpO1xuICAgICAgICAgICAgaWYgKHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bbXlhYmJyZXZfZmFtaWx5XSAmJiBub3JtYWxpemVkS2V5KSB7XG4gICAgICAgICAgICAgICAgdmFyIGFiYnJldiA9IHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bbXlhYmJyZXZfZmFtaWx5XVtub3JtYWxpemVkS2V5XTtcbiAgICAgICAgICAgICAgICBpZiAodG9rLnN0cmluZ3MuZm9ybSA9PT0gXCJzaG9ydFwiICYmIGFiYnJldikge1xuICAgICAgICAgICAgICAgICAgICBpZiAocXVhc2hDb3VudHJ5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFiYnJldjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG5cdCAgICAgICAgICAgICAgICB2YWx1ZSA9IGdldENvdW50cnlPckp1cmlzZGljdGlvbih2YXJpYWJsZSwgbm9ybWFsaXplZEtleSwgcXVhc2hDb3VudHJ5KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF2YWx1ZSBcbiAgICAgICAgICAgICYmICghc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMucmVxdWlyZV9leHBsaWNpdF9sZWdhbF9jYXNlX3RpdGxlX3Nob3J0IHx8IEl0ZW0udHlwZSAhPT0gJ2xlZ2FsX2Nhc2UnKSBcbiAgICAgICAgICAgICYmIGFsdHZhciAmJiBJdGVtW2FsdHZhcl0gJiYgdXNlX2ZpZWxkKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IEl0ZW1bYWx0dmFyXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXZhbHVlICYmICFzdGF0ZS5zeXMuZ2V0QWJicmV2aWF0aW9uICYmIHN0YXRlLnN5cy5nZXRIdW1hbkZvcm0pIHtcblx0ICAgICAgICB2YWx1ZSA9IGdldENvdW50cnlPckp1cmlzZGljdGlvbih2YXJpYWJsZSwgbm9ybWFsaXplZEtleSwgcXVhc2hDb3VudHJ5KTtcblx0ICAgIH1cbiAgICAgICAgaWYgKCF2YWx1ZSAmJiAhcXVhc2hDb3VudHJ5ICYmICghc3RhdGUuc3lzLmdldEh1bWFuRm9ybSB8fCB2YXJpYWJsZSAhPT0gXCJqdXJpc2RpY3Rpb25cIikpIHtcbiAgICAgICAgICAgIHZhbHVlID0gYmFzZXZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgZnVuY3Rpb24gZ2V0RmllbGRMb2NhbGUoSXRlbSxmaWVsZCkge1xuICAgICAgICB2YXIgcmV0ID0gc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0uc2xpY2UoMCwgMilcbiAgICAgICAgdmFyIGxvY2FsZVJleDtcbiAgICAgICAgaWYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnN0cmljdF90ZXh0X2Nhc2VfbG9jYWxlcykge1xuICAgICAgICAgICAgbG9jYWxlUmV4ID0gbmV3IFJlZ0V4cChcIl4oW2EtekEtWl17Mn0pKD86JHwtLip8IC4qKVwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvY2FsZVJleCA9IG5ldyBSZWdFeHAoXCJeKFthLXpBLVpdezJ9KSg/OiR8LS4qfC4qKVwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoSXRlbS5sYW5ndWFnZSkge1xuICAgICAgICAgICAgdmFyIG0gPSAoXCJcIiArIEl0ZW0ubGFuZ3VhZ2UpLm1hdGNoKGxvY2FsZVJleCk7XG4gICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgIHJldCA9IG1bMV07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldCA9IFwidGxoXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKEl0ZW0ubXVsdGkgJiYgSXRlbS5tdWx0aSAmJiBJdGVtLm11bHRpLm1haW4gJiYgSXRlbS5tdWx0aS5tYWluW2ZpZWxkXSkge1xuICAgICAgICAgICAgcmV0ID0gSXRlbS5tdWx0aS5tYWluW2ZpZWxkXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnN0cmljdF90ZXh0X2Nhc2VfbG9jYWxlc1xuICAgICAgICAgICB8fCBzdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ub3JtYWxpemVfbGFuZ19rZXlzX3RvX2xvd2VyY2FzZSkge1xuICAgICAgICAgICAgcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuICAgIGZ1bmN0aW9uIGdldFRleHRTdWJGaWVsZCAoSXRlbSwgZmllbGQsIGxvY2FsZV90eXBlLCB1c2VfZGVmYXVsdCwgc3RvcE9yaWcpIHtcbiAgICAgICAgdmFyIG0sIGxzdCwgb3B0LCBvLCBvbywgcG9zLCBrZXksIHJldCwgbGVuLCBteXJldCwgb3B0cztcbiAgICAgICAgdmFyIHVzZWRPcmlnID0gc3RvcE9yaWc7XG4gICAgICAgIHZhciB1c2luZ09yaWcgPSBmYWxzZTtcbiAgICAgICAgaWYgKCFJdGVtW2ZpZWxkXSkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBuYW1lOlwiXCIsXG4gICAgICAgICAgICAgICAgdXNlZE9yaWc6c3RvcE9yaWcsXG4gICAgICAgICAgICAgICAgdG9rZW46IENTTC5VdGlsLmNsb25lVG9rZW4odGhpcylcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgcmV0ID0ge25hbWU6XCJcIiwgdXNlZE9yaWc6c3RvcE9yaWcsbG9jYWxlOmdldEZpZWxkTG9jYWxlKEl0ZW0sZmllbGQpfTtcbiAgICAgICAgb3B0cyA9IHN0YXRlLm9wdFtsb2NhbGVfdHlwZV07XG4gICAgICAgIHZhciBoYXNWYWwgPSBmYWxzZTtcbiAgICAgICAgdmFyIGp1cmlzZGljdGlvbk5hbWUgPSBmYWxzZTtcbiAgICAgICAgaWYgKGxvY2FsZV90eXBlID09PSAnbG9jYWxlLW9yaWcnKSB7XG4gICAgICAgICAgICBpZiAoc3RvcE9yaWcpIHtcbiAgICAgICAgICAgICAgICByZXQgPSB7bmFtZTpcIlwiLCB1c2VkT3JpZzpzdG9wT3JpZ307XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldCA9IHtuYW1lOkl0ZW1bZmllbGRdLCB1c2VkT3JpZzpmYWxzZSwgbG9jYWxlOmdldEZpZWxkTG9jYWxlKEl0ZW0sZmllbGQpfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGhhc1ZhbCA9IHRydWU7XG4gICAgICAgICAgICB1c2luZ09yaWcgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKHVzZV9kZWZhdWx0ICYmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygb3B0cyB8fCBvcHRzLmxlbmd0aCA9PT0gMCkpIHtcbiAgICAgICAgICAgIHZhciByZXQgPSB7bmFtZTpJdGVtW2ZpZWxkXSwgdXNlZE9yaWc6dHJ1ZSwgbG9jYWxlOmdldEZpZWxkTG9jYWxlKEl0ZW0sZmllbGQpfTtcbiAgICAgICAgICAgIGhhc1ZhbCA9IHRydWU7XG4gICAgICAgICAgICB1c2luZ09yaWcgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghaGFzVmFsKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG9wdHMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgb3B0ID0gb3B0c1tpXTtcbiAgICAgICAgICAgICAgICBvID0gb3B0LnNwbGl0KC9bXFwtX10vKVswXTtcbiAgICAgICAgICAgICAgICBpZiAob3B0ICYmIEl0ZW0ubXVsdGkgJiYgSXRlbS5tdWx0aS5fa2V5c1tmaWVsZF0gJiYgSXRlbS5tdWx0aS5fa2V5c1tmaWVsZF1bb3B0XSkge1xuICAgICAgICAgICAgICAgICAgICByZXQubmFtZSA9IEl0ZW0ubXVsdGkuX2tleXNbZmllbGRdW29wdF07XG4gICAgICAgICAgICAgICAgICAgIHJldC5sb2NhbGUgPSBvcHQ7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobyAmJiBJdGVtLm11bHRpICYmIEl0ZW0ubXVsdGkuX2tleXNbZmllbGRdICYmIEl0ZW0ubXVsdGkuX2tleXNbZmllbGRdW29dKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldC5uYW1lID0gSXRlbS5tdWx0aS5fa2V5c1tmaWVsZF1bb107XG4gICAgICAgICAgICAgICAgICAgIHJldC5sb2NhbGUgPSBvO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXJldC5uYW1lICYmIHVzZV9kZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgcmV0ID0ge25hbWU6SXRlbVtmaWVsZF0sIHVzZWRPcmlnOnRydWUsIGxvY2FsZTpnZXRGaWVsZExvY2FsZShJdGVtLGZpZWxkKX07XG4gICAgICAgICAgICAgICAgdXNpbmdPcmlnID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXQudG9rZW4gPSBDU0wuVXRpbC5jbG9uZVRva2VuKHRoaXMpO1xuICAgICAgICBpZiAoW1widGl0bGVcIiwgXCJjb250YWluZXItdGl0bGVcIl0uaW5kZXhPZihmaWVsZCkgPiAtMSkge1xuICAgICAgICAgICAgaWYgKCF1c2VkT3JpZ1xuICAgICAgICAgICAgICAgICYmICghcmV0LnRva2VuLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl1cbiAgICAgICAgICAgICAgICAgICAgfHwgcmV0LnRva2VuLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPT09IFwic2VudGVuY2VcIlxuICAgICAgICAgICAgICAgICAgICB8fCByZXQudG9rZW4uc3RyaW5nc1tcInRleHQtY2FzZVwiXSA9PT0gXCJub3JtYWxcIikpIHtcbiAgICAgICAgICAgICAgICB2YXIgbG9jYWxlID0gdXNpbmdPcmlnID8gZmFsc2UgOiByZXQubG9jYWxlO1xuICAgICAgICAgICAgICAgIHZhciBzZWcgPSBmaWVsZC5zbGljZSgwLC01KTtcbiAgICAgICAgICAgICAgICB2YXIgc2VudGVuY2VDYXNlID0gcmV0LnRva2VuLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPT09IFwic2VudGVuY2VcIiA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXQubmFtZSA9IENTTC50aXRsZWNhc2VTZW50ZW5jZU9yTm9ybWFsKHN0YXRlLCBJdGVtLCBzZWcsIGxvY2FsZSwgc2VudGVuY2VDYXNlKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgcmV0LnRva2VuLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG4gICAgZnVuY3Rpb24gbG9hZEFiYnJldmlhdGlvbihqdXJpc2RpY3Rpb24sIGNhdGVnb3J5LCBvcmlnLCBpdGVtVHlwZSkge1xuICAgICAgICB2YXIgcG9zLCBsZW47XG4gICAgICAgIGlmICghanVyaXNkaWN0aW9uKSB7XG4gICAgICAgICAgICBqdXJpc2RpY3Rpb24gPSBcImRlZmF1bHRcIjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIW9yaWcpIHtcbiAgICAgICAgICAgIGlmICghc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl0gPSBuZXcgc3RhdGUuc3lzLkFiYnJldmlhdGlvblNlZ21lbnRzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bY2F0ZWdvcnldKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXVtjYXRlZ29yeV0gPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBqdXJpc2RpY3Rpb247XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0YXRlLnN5cy5nZXRBYmJyZXZpYXRpb24pIHtcbiAgICAgICAgICAgIGp1cmlzZGljdGlvbiA9IHN0YXRlLnN5cy5nZXRBYmJyZXZpYXRpb24oc3RhdGUub3B0LnN0eWxlSUQsIHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzLCBqdXJpc2RpY3Rpb24sIGNhdGVnb3J5LCBvcmlnLCBpdGVtVHlwZSwgdHJ1ZSk7XG4gICAgICAgICAgICBpZiAoIWp1cmlzZGljdGlvbikge1xuICAgICAgICAgICAgICAgIGp1cmlzZGljdGlvbiA9IFwiZGVmYXVsdFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBqdXJpc2RpY3Rpb247XG4gICAgfVxuICAgIHRoaXMubG9hZEFiYnJldmlhdGlvbiA9IGxvYWRBYmJyZXZpYXRpb247XG4gICAgZnVuY3Rpb24gcHVibGlzaGVyQ2hlY2sgKHRvaywgSXRlbSwgcHJpbWFyeSwgZmFtaWx5X3Zhcikge1xuICAgICAgICB2YXIgdmFybmFtZSA9IHRvay52YXJpYWJsZXNbMF07XG4gICAgICAgIGlmIChzdGF0ZS5wdWJsaXNoZXJPdXRwdXQgJiYgcHJpbWFyeSkge1xuICAgICAgICAgICAgaWYgKFtcInB1Ymxpc2hlclwiLFwicHVibGlzaGVyLXBsYWNlXCJdLmluZGV4T2YodmFybmFtZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5wdWJsaXNoZXJPdXRwdXRbdmFybmFtZSArIFwiLXRva2VuXCJdID0gdG9rO1xuICAgICAgICAgICAgICAgIHN0YXRlLnB1Ymxpc2hlck91dHB1dC52YXJsaXN0LnB1c2godmFybmFtZSk7XG4gICAgICAgICAgICAgICAgdmFyIGxzdCA9IHByaW1hcnkuc3BsaXQoLztcXHMqLyk7XG4gICAgICAgICAgICAgICAgaWYgKGxzdC5sZW5ndGggPT09IHN0YXRlLnB1Ymxpc2hlck91dHB1dFt2YXJuYW1lICsgXCItbGlzdFwiXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUucHVibGlzaGVyT3V0cHV0W3Zhcm5hbWUgKyBcIi1saXN0XCJdID0gbHN0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGxzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgbHN0W2ldID0gYWJicmV2aWF0ZShzdGF0ZSwgdG9rLCBJdGVtLCBmYWxzZSwgbHN0W2ldLCBmYW1pbHlfdmFyLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wW3Zhcm5hbWUgKyBcIi10b2tlblwiXSA9IHRvaztcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGdldE91dHB1dEZ1bmN0aW9uKHZhcmlhYmxlcywgZmFtaWx5X3ZhciwgYWJicmV2aWF0aW9uX2ZhbGxiYWNrLCBhbHRlcm5hdGl2ZV92YXJuYW1lLCB0cmFuc2Zvcm1fZmFsbGJhY2spIHtcbiAgICAgICAgdmFyIGxvY2FsZXNldHM7XG4gICAgICAgIHZhciBsYW5nUHJlZnMgPSBDU0wuTGFuZ1ByZWZzTWFwW3ZhcmlhYmxlc1swXV07XG4gICAgICAgIGlmICghbGFuZ1ByZWZzKSB7XG4gICAgICAgICAgICBsb2NhbGVzZXRzID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2NhbGVzZXRzID0gc3RhdGUub3B0WydjaXRlLWxhbmctcHJlZnMnXVtsYW5nUHJlZnNdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0sIHVzZWRPcmlnKSB7XG4gICAgICAgICAgICB2YXIgcHJpbWFyeSwgcHJpbWFyeV9sb2NhbGUsIHNlY29uZGFyeSwgc2Vjb25kYXJ5X2xvY2FsZSwgdGVydGlhcnksIHRlcnRpYXJ5X2xvY2FsZSwgcHJpbWFyeV90b2ssIGdyb3VwX3Rvaywga2V5O1xuICAgICAgICAgICAgaWYgKCF2YXJpYWJsZXNbMF0gfHwgKCFJdGVtW3ZhcmlhYmxlc1swXV0gJiYgIUl0ZW1bYWx0ZXJuYXRpdmVfdmFybmFtZV0pKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgc2xvdCA9IHtwcmltYXJ5OmZhbHNlLCBzZWNvbmRhcnk6ZmFsc2UsIHRlcnRpYXJ5OmZhbHNlfTtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuYXJlYS5zbGljZSgtNSkgPT09IFwiX3NvcnRcIikge1xuICAgICAgICAgICAgICAgIHNsb3QucHJpbWFyeSA9ICdsb2NhbGUtc29ydCc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChsb2NhbGVzZXRzKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzbG90bmFtZXMgPSBbXCJwcmltYXJ5XCIsIFwic2Vjb25kYXJ5XCIsIFwidGVydGlhcnlcIl07XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gc2xvdG5hbWVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvY2FsZXNldHMubGVuZ3RoIC0gMSA8ICBpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobG9jYWxlc2V0c1tpXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsb3Rbc2xvdG5hbWVzW2ldXSA9ICdsb2NhbGUtJyArIGxvY2FsZXNldHNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzbG90LnByaW1hcnkgPSAnbG9jYWxlLW9yaWcnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh2YXJpYWJsZXNbMF0gPT09IFwidGl0bGUtc2hvcnRcIiBcbiAgICAgICAgICAgICAgICB8fCAoc3RhdGUudG1wLmFyZWEgIT09IFwiYmlibGlvZ3JhcGh5XCJcbiAgICAgICAgICAgICAgICAgICAgJiYgIShzdGF0ZS50bXAuYXJlYSA9PT0gXCJjaXRhdGlvblwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgJiYgc3RhdGUub3B0LnhjbGFzcyA9PT0gXCJub3RlXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAmJiBpdGVtICYmICFpdGVtLnBvc2l0aW9uKSkpIHtcbiAgICAgICAgICAgICAgICBzbG90LnNlY29uZGFyeSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHNsb3QudGVydGlhcnkgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXBbXCJwdWJsaXNoZXItbGlzdFwiXSkge1xuICAgICAgICAgICAgICAgIGlmICh2YXJpYWJsZXNbMF0gPT09IFwicHVibGlzaGVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wW1wicHVibGlzaGVyLXRva2VuXCJdID0gdGhpcztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhcmlhYmxlc1swXSA9PT0gXCJwdWJsaXNoZXItcGxhY2VcIikge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXBbXCJwdWJsaXNoZXItcGxhY2UtdG9rZW5cIl0gPSB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciByZXMgPSBnZXRUZXh0U3ViRmllbGQuY2FsbCh0aGlzLCBJdGVtLCB2YXJpYWJsZXNbMF0sIHNsb3QucHJpbWFyeSwgdHJ1ZSk7XG4gICAgICAgICAgICBwcmltYXJ5ID0gcmVzLm5hbWU7XG4gICAgICAgICAgICBwcmltYXJ5X2xvY2FsZSA9IHJlcy5sb2NhbGU7XG4gICAgICAgICAgICB2YXIgcHJpbWFyeV90b2sgPSByZXMudG9rZW47XG4gICAgICAgICAgICB2YXIgcHJpbWFyeVVzZWRPcmlnID0gcmVzLnVzZWRPcmlnO1xuICAgICAgICAgICAgaWYgKHB1Ymxpc2hlckNoZWNrKHRoaXMsIEl0ZW0sIHByaW1hcnksIGZhbWlseV92YXIpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZWNvbmRhcnkgPSBmYWxzZTtcbiAgICAgICAgICAgIHRlcnRpYXJ5ID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoc2xvdC5zZWNvbmRhcnkpIHtcbiAgICAgICAgICAgICAgICByZXMgPSBnZXRUZXh0U3ViRmllbGQuY2FsbCh0aGlzLCBJdGVtLCB2YXJpYWJsZXNbMF0sIHNsb3Quc2Vjb25kYXJ5LCBmYWxzZSwgcmVzLnVzZWRPcmlnKTtcbiAgICAgICAgICAgICAgICBzZWNvbmRhcnkgPSByZXMubmFtZTtcbiAgICAgICAgICAgICAgICBzZWNvbmRhcnlfbG9jYWxlID0gcmVzLmxvY2FsZTtcbiAgICAgICAgICAgICAgICB2YXIgc2Vjb25kYXJ5X3RvayA9IHJlcy50b2tlbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzbG90LnRlcnRpYXJ5KSB7XG4gICAgICAgICAgICAgICAgcmVzID0gZ2V0VGV4dFN1YkZpZWxkLmNhbGwodGhpcywgSXRlbSwgdmFyaWFibGVzWzBdLCBzbG90LnRlcnRpYXJ5LCBmYWxzZSwgcmVzLnVzZWRPcmlnKTtcbiAgICAgICAgICAgICAgICB0ZXJ0aWFyeSA9IHJlcy5uYW1lO1xuICAgICAgICAgICAgICAgIHRlcnRpYXJ5X2xvY2FsZSA9IHJlcy5sb2NhbGU7XG4gICAgICAgICAgICAgICAgdmFyIHRlcnRpYXJ5X3RvayA9IHJlcy50b2tlbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChmYW1pbHlfdmFyKSB7XG4gICAgICAgICAgICAgICAgcHJpbWFyeSA9IGFiYnJldmlhdGUoc3RhdGUsIHByaW1hcnlfdG9rLCBJdGVtLCBhbHRlcm5hdGl2ZV92YXJuYW1lLCBwcmltYXJ5LCBmYW1pbHlfdmFyLCB0cnVlKTtcbiAgICAgICAgICAgICAgICBpZiAocHJpbWFyeSkge1xuICAgICAgICAgICAgICAgICAgICBwcmltYXJ5ID0gcXVhc2hDaGVjayhwcmltYXJ5KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHNlY29uZGFyeSkge1xuICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnkgPSBhYmJyZXZpYXRlKHN0YXRlLCBzZWNvbmRhcnlfdG9rLCBJdGVtLCBmYWxzZSwgc2Vjb25kYXJ5LCBmYW1pbHlfdmFyLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRlcnRpYXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHRlcnRpYXJ5ID0gYWJicmV2aWF0ZShzdGF0ZSwgdGVydGlhcnlfdG9rLCBJdGVtLCBmYWxzZSwgdGVydGlhcnksIGZhbWlseV92YXIsIHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBwcmltYXJ5UHJlZml4O1xuICAgICAgICAgICAgaWYgKHNsb3QucHJpbWFyeSA9PT0gXCJsb2NhbGUtdHJhbnNsaXRcIikge1xuICAgICAgICAgICAgICAgIHByaW1hcnlQcmVmaXggPSBzdGF0ZS5vcHQuY2l0ZUFmZml4ZXNbbGFuZ1ByZWZzXVtzbG90LnByaW1hcnldLnByZWZpeDtcbiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAocHJpbWFyeVByZWZpeCA9PT0gXCI8aT5cIiAmJiB2YXJpYWJsZXNbMF0gPT09ICd0aXRsZScgJiYgIXByaW1hcnlVc2VkT3JpZykge1xuICAgICAgICAgICAgICAgIHZhciBoYXNJdGFsaWMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHByaW1hcnlfdG9rLmRlY29yYXRpb25zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJpbWFyeV90b2suZGVjb3JhdGlvbnNbaV1bMF0gPT09IFwiQGZvbnQtc3R5bGVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgcHJpbWFyeV90b2suZGVjb3JhdGlvbnNbaV1bMV0gPT09IFwiaXRhbGljXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhc0l0YWxpYyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFoYXNJdGFsaWMpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeV90b2suZGVjb3JhdGlvbnMucHVzaChbXCJAZm9udC1zdHlsZVwiLCBcIml0YWxpY1wiXSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocHJpbWFyeV9sb2NhbGUgIT09IFwiZW5cIiAmJiBwcmltYXJ5X3Rvay5zdHJpbmdzW1widGV4dC1jYXNlXCJdID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgICAgICBwcmltYXJ5X3Rvay5zdHJpbmdzW1widGV4dC1jYXNlXCJdID0gXCJwYXNzdGhyb3VnaFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKFwidGl0bGVcIiA9PT0gdmFyaWFibGVzWzBdKSB7XG4gICAgICAgICAgICAgICAgcHJpbWFyeSA9IENTTC5kZW1vdGVOb2lzZVdvcmRzKHN0YXRlLCBwcmltYXJ5LCB0aGlzW1wibGVhZGluZy1ub2lzZS13b3Jkc1wiXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc2Vjb25kYXJ5IHx8IHRlcnRpYXJ5KSB7XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChcImVtcHR5XCIpO1xuICAgICAgICAgICAgICAgIHByaW1hcnlfdG9rLnN0cmluZ3Muc3VmZml4ID0gcHJpbWFyeV90b2suc3RyaW5ncy5zdWZmaXgucmVwbGFjZSgvWyAuLF0rJC8sXCJcIik7XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZChwcmltYXJ5LCBwcmltYXJ5X3Rvayk7XG4gICAgICAgICAgICAgICAgaWYgKHNlY29uZGFyeSkge1xuICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnlfdG9rLnN0cmluZ3MucHJlZml4ID0gc3RhdGUub3B0LmNpdGVBZmZpeGVzW2xhbmdQcmVmc11bc2xvdC5zZWNvbmRhcnldLnByZWZpeDtcbiAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5X3Rvay5zdHJpbmdzLnN1ZmZpeCA9IHN0YXRlLm9wdC5jaXRlQWZmaXhlc1tsYW5nUHJlZnNdW3Nsb3Quc2Vjb25kYXJ5XS5zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIGlmICghc2Vjb25kYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBzZWNvbmRhcnlfdG9rLmRlY29yYXRpb25zLmxlbmd0aCAtIDE7IGkgPiAtMTsgaSArPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFsnQHF1b3Rlcy90cnVlJywgJ0Bmb250LXN0eWxlL2l0YWxpYycsICdAZm9udC1zdHlsZS9vYmxpcXVlJywgJ0Bmb250LXdlaWdodC9ib2xkJ10uaW5kZXhPZihzZWNvbmRhcnlfdG9rLmRlY29yYXRpb25zW2ldLmpvaW4oJy8nKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY29uZGFyeV90b2suZGVjb3JhdGlvbnMgPSBzZWNvbmRhcnlfdG9rLmRlY29yYXRpb25zLnNsaWNlKDAsIGkpLmNvbmNhdChzZWNvbmRhcnlfdG9rLmRlY29yYXRpb25zLnNsaWNlKGkgKyAxKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoc2Vjb25kYXJ5X2xvY2FsZSAhPT0gXCJlblwiICYmIHNlY29uZGFyeV90b2suc3RyaW5nc1tcInRleHQtY2FzZVwiXSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnlfdG9rLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPSBcInBhc3N0aHJvdWdoXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIHNlY29uZGFyeV9vdXRlciA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5X291dGVyLmRlY29yYXRpb25zLnB1c2goW1wiQGZvbnQtc3R5bGVcIiwgXCJub3JtYWxcIl0pO1xuICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnlfb3V0ZXIuZGVjb3JhdGlvbnMucHVzaChbXCJAZm9udC13ZWlnaHRcIiwgXCJub3JtYWxcIl0pO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQub3BlbkxldmVsKHNlY29uZGFyeV9vdXRlcik7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQoc2Vjb25kYXJ5LCBzZWNvbmRhcnlfdG9rKTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJsb2Jfb2JqID0gc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJsb2JzX3BvcyA9IHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkuYmxvYnMubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLmNpdGUuZnJvbnQucHVzaCh2YXJpYWJsZXNbMF0gKyBcIjpzZWNvbmRhcnlcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5jaXRlW3ZhcmlhYmxlc1swXSArIFwiOnNlY29uZGFyeVwiXSA9IHtibG9iczpbW2Jsb2Jfb2JqLCBibG9ic19wb3NdXX07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRlcnRpYXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHRlcnRpYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCA9IHN0YXRlLm9wdC5jaXRlQWZmaXhlc1tsYW5nUHJlZnNdW3Nsb3QudGVydGlhcnldLnByZWZpeDtcbiAgICAgICAgICAgICAgICAgICAgdGVydGlhcnlfdG9rLnN0cmluZ3Muc3VmZml4ID0gc3RhdGUub3B0LmNpdGVBZmZpeGVzW2xhbmdQcmVmc11bc2xvdC50ZXJ0aWFyeV0uc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRlcnRpYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVydGlhcnlfdG9rLnN0cmluZ3MucHJlZml4ID0gXCIgXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRlcnRpYXJ5X3Rvay5kZWNvcmF0aW9ucy5sZW5ndGggLSAxOyBpID4gLTE7IGkgKz0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChbJ0BxdW90ZXMvdHJ1ZScsICdAZm9udC1zdHlsZS9pdGFsaWMnLCAnQGZvbnQtc3R5bGUvb2JsaXF1ZScsICdAZm9udC13ZWlnaHQvYm9sZCddLmluZGV4T2YodGVydGlhcnlfdG9rLmRlY29yYXRpb25zW2ldLmpvaW4oJy8nKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlcnRpYXJ5X3Rvay5kZWNvcmF0aW9ucyA9IHRlcnRpYXJ5X3Rvay5kZWNvcmF0aW9ucy5zbGljZSgwLCBpKS5jb25jYXQodGVydGlhcnlfdG9rLmRlY29yYXRpb25zLnNsaWNlKGkgKyAxKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAodGVydGlhcnlfbG9jYWxlICE9PSBcImVuXCIgJiYgdGVydGlhcnlfdG9rLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPT09IFwidGl0bGVcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVydGlhcnlfdG9rLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPSBcInBhc3N0aHJvdWdoXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIHRlcnRpYXJ5X291dGVyID0gbmV3IENTTC5Ub2tlbigpO1xuICAgICAgICAgICAgICAgICAgICB0ZXJ0aWFyeV9vdXRlci5kZWNvcmF0aW9ucy5wdXNoKFtcIkBmb250LXN0eWxlXCIsIFwibm9ybWFsXCJdKTtcbiAgICAgICAgICAgICAgICAgICAgdGVydGlhcnlfb3V0ZXIuZGVjb3JhdGlvbnMucHVzaChbXCJAZm9udC13ZWlnaHRcIiwgXCJub3JtYWxcIl0pO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQub3BlbkxldmVsKHRlcnRpYXJ5X291dGVyKTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh0ZXJ0aWFyeSwgdGVydGlhcnlfdG9rKTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJsb2Jfb2JqID0gc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJsb2JzX3BvcyA9IHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkuYmxvYnMubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLmNpdGUuZnJvbnQucHVzaCh2YXJpYWJsZXNbMF0gKyBcIjp0ZXJ0aWFyeVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLmNpdGVbdmFyaWFibGVzWzBdICsgXCI6dGVydGlhcnlcIl0gPSB7YmxvYnM6W1tibG9iX29iaiwgYmxvYnNfcG9zXV19O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jbG9zZUxldmVsKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQocHJpbWFyeSwgcHJpbWFyeV90b2spO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH07XG4gICAgfVxuICAgIHRoaXMuZ2V0T3V0cHV0RnVuY3Rpb24gPSBnZXRPdXRwdXRGdW5jdGlvbjtcbiAgICBmdW5jdGlvbiBxdWFzaENoZWNrKHZhbHVlKSB7XG4gICAgICAgIHZhciBtID0gdmFsdWUubWF0Y2goL14hKFstLF9hLXpdKyk+Pj4vKTtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgIHZhciBmaWVsZHMgPSBtWzFdLnNwbGl0KFwiLFwiKTtcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UobVswXS5sZW5ndGgpO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBmaWVsZHMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kb25lX3ZhcnMuaW5kZXhPZihmaWVsZHNbaV0pID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZG9uZV92YXJzLnB1c2goZmllbGRzW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICB0aGlzLnF1YXNoQ2hlY2sgPSBxdWFzaENoZWNrO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlRva2VuID0gZnVuY3Rpb24gKG5hbWUsIHRva2VudHlwZSkge1xuICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgdGhpcy5zdHJpbmdzID0ge307XG4gICAgdGhpcy5zdHJpbmdzLmRlbGltaXRlciA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnN0cmluZ3MucHJlZml4ID0gXCJcIjtcbiAgICB0aGlzLnN0cmluZ3Muc3VmZml4ID0gXCJcIjtcbiAgICB0aGlzLmRlY29yYXRpb25zID0gW107XG4gICAgdGhpcy52YXJpYWJsZXMgPSBbXTtcbiAgICB0aGlzLmV4ZWNzID0gW107XG4gICAgdGhpcy50b2tlbnR5cGUgPSB0b2tlbnR5cGU7XG4gICAgdGhpcy5ldmFsdWF0b3IgPSBmYWxzZTtcbiAgICB0aGlzLnRlc3RzID0gW107XG4gICAgdGhpcy5yYXd0ZXN0cyA9IFtdO1xuICAgIHRoaXMuc3VjY2VlZCA9IGZhbHNlO1xuICAgIHRoaXMuZmFpbCA9IGZhbHNlO1xuICAgIHRoaXMubmV4dCA9IGZhbHNlO1xufTtcbkNTTC5VdGlsLmNsb25lVG9rZW4gPSBmdW5jdGlvbiAodG9rZW4pIHtcbiAgICB2YXIgbmV3dG9rLCBrZXksIHBvcywgbGVuO1xuICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgdG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIHRva2VuO1xuICAgIH1cbiAgICBuZXd0b2sgPSBuZXcgQ1NMLlRva2VuKHRva2VuLm5hbWUsIHRva2VuLnRva2VudHlwZSk7XG4gICAgZm9yICh2YXIga2V5IGluIHRva2VuLnN0cmluZ3MpIHtcbiAgICAgICAgaWYgKHRva2VuLnN0cmluZ3MuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgbmV3dG9rLnN0cmluZ3Nba2V5XSA9IHRva2VuLnN0cmluZ3Nba2V5XTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodG9rZW4uZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgbmV3dG9rLmRlY29yYXRpb25zID0gW107XG4gICAgICAgIGZvciAocG9zID0gMCwgbGVuID0gdG9rZW4uZGVjb3JhdGlvbnMubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICBuZXd0b2suZGVjb3JhdGlvbnMucHVzaCh0b2tlbi5kZWNvcmF0aW9uc1twb3NdLnNsaWNlKCkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0b2tlbi52YXJpYWJsZXMpIHtcbiAgICAgICAgbmV3dG9rLnZhcmlhYmxlcyA9IHRva2VuLnZhcmlhYmxlcy5zbGljZSgpO1xuICAgIH1cbiAgICBpZiAodG9rZW4uZXhlY3MpIHtcbiAgICAgICAgbmV3dG9rLmV4ZWNzID0gdG9rZW4uZXhlY3Muc2xpY2UoKTtcbiAgICAgICAgbmV3dG9rLnRlc3RzID0gdG9rZW4udGVzdHMuc2xpY2UoKTtcbiAgICAgICAgbmV3dG9rLnJhd3Rlc3RzID0gdG9rZW4udGVzdHMuc2xpY2UoKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ld3Rvaztcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5BbWJpZ0NvbmZpZyA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLm1heHZhbHMgPSBbXTtcbiAgICB0aGlzLm1pbnZhbCA9IDE7XG4gICAgdGhpcy5uYW1lcyA9IFtdO1xuICAgIHRoaXMuZ2l2ZW5zID0gW107XG4gICAgdGhpcy55ZWFyX3N1ZmZpeCA9IGZhbHNlO1xuICAgIHRoaXMuZGlzYW1iaWd1YXRlID0gMDtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5CbG9iID0gZnVuY3Rpb24gKHN0ciwgdG9rZW4sIGxldmVsbmFtZSkge1xuICAgIHZhciBsZW4sIHBvcywga2V5O1xuICAgIHRoaXMubGV2ZWxuYW1lID0gbGV2ZWxuYW1lO1xuICAgIGlmICh0b2tlbikge1xuICAgICAgICB0aGlzLnN0cmluZ3MgPSB7XCJwcmVmaXhcIjpcIlwiLFwic3VmZml4XCI6XCJcIn07XG4gICAgICAgIGZvciAodmFyIGtleSBpbiB0b2tlbi5zdHJpbmdzKSB7XG4gICAgICAgICAgICBpZiAodG9rZW4uc3RyaW5ncy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdHJpbmdzW2tleV0gPSB0b2tlbi5zdHJpbmdzW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kZWNvcmF0aW9ucyA9IFtdO1xuICAgICAgICBpZiAodG9rZW4uZGVjb3JhdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbGVuID0gMDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxlbiA9IHRva2VuLmRlY29yYXRpb25zLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIHRoaXMuZGVjb3JhdGlvbnMucHVzaCh0b2tlbi5kZWNvcmF0aW9uc1twb3NdLnNsaWNlKCkpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzID0ge307XG4gICAgICAgIHRoaXMuc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICB0aGlzLnN0cmluZ3Muc3VmZml4ID0gXCJcIjtcbiAgICAgICAgdGhpcy5zdHJpbmdzLmRlbGltaXRlciA9IFwiXCI7XG4gICAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSBbXTtcbiAgICB9XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBzdHIpIHtcbiAgICAgICAgdGhpcy5ibG9icyA9IHN0cjtcbiAgICB9IGVsc2UgaWYgKHN0cikge1xuICAgICAgICB0aGlzLmJsb2JzID0gW3N0cl07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5ibG9icyA9IFtdO1xuICAgIH1cbiAgICB0aGlzLmFsbGRlY29yID0gW3RoaXMuZGVjb3JhdGlvbnNdO1xufTtcbkNTTC5CbG9iLnByb3RvdHlwZS5wdXNoID0gZnVuY3Rpb24gKGJsb2IpIHtcbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHRoaXMuYmxvYnMpIHtcbiAgICAgICAgdGhyb3cgXCJBdHRlbXB0IHRvIHB1c2ggYmxvYiBvbnRvIHN0cmluZyBvYmplY3RcIjtcbiAgICB9IGVsc2UgaWYgKGZhbHNlICE9PSBibG9iKSB7XG4gICAgICAgIGJsb2IuYWxsZGVjb3IgPSBibG9iLmFsbGRlY29yLmNvbmNhdCh0aGlzLmFsbGRlY29yKTtcbiAgICAgICAgdGhpcy5ibG9icy5wdXNoKGJsb2IpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5OdW1lcmljQmxvYiA9IGZ1bmN0aW9uIChwYXJ0aWNsZSwgbnVtLCBtb3RoZXJfdG9rZW4sIGlkKSB7XG4gICAgdGhpcy5pZCA9IGlkO1xuICAgIHRoaXMuYWxsZGVjb3IgPSBbXTtcbiAgICB0aGlzLm51bSA9IG51bTtcbiAgICB0aGlzLnBhcnRpY2xlID0gcGFydGljbGU7XG4gICAgdGhpcy5ibG9icyA9IG51bS50b1N0cmluZygpO1xuICAgIHRoaXMuc3RhdHVzID0gQ1NMLlNUQVJUO1xuICAgIHRoaXMuc3RyaW5ncyA9IHt9O1xuICAgIGlmIChtb3RoZXJfdG9rZW4pIHtcbiAgICAgICAgdGhpcy5nZW5kZXIgPSBtb3RoZXJfdG9rZW4uZ2VuZGVyO1xuICAgICAgICB0aGlzLmRlY29yYXRpb25zID0gbW90aGVyX3Rva2VuLmRlY29yYXRpb25zO1xuICAgICAgICB0aGlzLnN0cmluZ3MucHJlZml4ID0gbW90aGVyX3Rva2VuLnN0cmluZ3MucHJlZml4O1xuICAgICAgICB0aGlzLnN0cmluZ3Muc3VmZml4ID0gbW90aGVyX3Rva2VuLnN0cmluZ3Muc3VmZml4O1xuICAgICAgICB0aGlzLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPSBtb3RoZXJfdG9rZW4uc3RyaW5nc1tcInRleHQtY2FzZVwiXTtcbiAgICAgICAgdGhpcy5zdWNjZXNzb3JfcHJlZml4ID0gbW90aGVyX3Rva2VuLnN1Y2Nlc3Nvcl9wcmVmaXg7XG4gICAgICAgIHRoaXMucmFuZ2VfcHJlZml4ID0gbW90aGVyX3Rva2VuLnJhbmdlX3ByZWZpeDtcbiAgICAgICAgdGhpcy5zcGxpY2VfcHJlZml4ID0gbW90aGVyX3Rva2VuLnNwbGljZV9wcmVmaXg7XG4gICAgICAgIHRoaXMuZm9ybWF0dGVyID0gbW90aGVyX3Rva2VuLmZvcm1hdHRlcjtcbiAgICAgICAgaWYgKCF0aGlzLmZvcm1hdHRlcikge1xuICAgICAgICAgICAgdGhpcy5mb3JtYXR0ZXIgPSAgbmV3IENTTC5PdXRwdXQuRGVmYXVsdEZvcm1hdHRlcigpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmZvcm1hdHRlcikge1xuICAgICAgICAgICAgdGhpcy50eXBlID0gdGhpcy5mb3JtYXR0ZXIuZm9ybWF0KDEpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5kZWNvcmF0aW9ucyA9IFtdO1xuICAgICAgICB0aGlzLnN0cmluZ3MucHJlZml4ID0gXCJcIjtcbiAgICAgICAgdGhpcy5zdHJpbmdzLnN1ZmZpeCA9IFwiXCI7XG4gICAgICAgIHRoaXMuc3VjY2Vzc29yX3ByZWZpeCA9IFwiXCI7XG4gICAgICAgIHRoaXMucmFuZ2VfcHJlZml4ID0gXCJcIjtcbiAgICAgICAgdGhpcy5zcGxpY2VfcHJlZml4ID0gXCJcIjtcbiAgICAgICAgdGhpcy5mb3JtYXR0ZXIgPSBuZXcgQ1NMLk91dHB1dC5EZWZhdWx0Rm9ybWF0dGVyKCk7XG4gICAgfVxufTtcbkNTTC5OdW1lcmljQmxvYi5wcm90b3R5cGUuc2V0Rm9ybWF0dGVyID0gZnVuY3Rpb24gKGZvcm1hdHRlcikge1xuICAgIHRoaXMuZm9ybWF0dGVyID0gZm9ybWF0dGVyO1xuICAgIHRoaXMudHlwZSA9IHRoaXMuZm9ybWF0dGVyLmZvcm1hdCgxKTtcbn07XG5DU0wuT3V0cHV0LkRlZmF1bHRGb3JtYXR0ZXIgPSBmdW5jdGlvbiAoKSB7fTtcbkNTTC5PdXRwdXQuRGVmYXVsdEZvcm1hdHRlci5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24gKG51bSkge1xuICAgIHJldHVybiBudW0udG9TdHJpbmcoKTtcbn07XG5DU0wuTnVtZXJpY0Jsb2IucHJvdG90eXBlLmNoZWNrTmV4dCA9IGZ1bmN0aW9uIChuZXh0LHN0YXJ0KSB7XG4gICAgaWYgKHN0YXJ0KSB7XG4gICAgICAgIHRoaXMuc3RhdHVzID0gQ1NMLlNUQVJUO1xuICAgICAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIG5leHQpIHtcbiAgICAgICAgICAgIGlmIChuZXh0Lm51bSA9PT0gKHRoaXMubnVtICsgMSkpIHtcbiAgICAgICAgICAgICAgICBuZXh0LnN0YXR1cyA9IENTTC5TVUNDRVNTT1I7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5leHQuc3RhdHVzID0gQ1NMLlNFRU47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKCEgbmV4dCB8fCAhbmV4dC5udW0gfHwgdGhpcy50eXBlICE9PSBuZXh0LnR5cGUgfHwgbmV4dC5udW0gIT09ICh0aGlzLm51bSArIDEpKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyA9PT0gQ1NMLlNVQ0NFU1NPUl9PRl9TVUNDRVNTT1IpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gQ1NMLkVORDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIG5leHQpIHsgXG4gICAgICAgICAgIG5leHQuc3RhdHVzID0gQ1NMLlNFRU47XG4gICAgICAgIH1cbiAgICB9IGVsc2UgeyAvLyBuZXh0IG51bWJlciBpcyBpbiB0aGUgc2VxdWVuY2VcbiAgICAgICAgaWYgKHRoaXMuc3RhdHVzID09PSBDU0wuU1RBUlQgfHwgdGhpcy5zdGF0dXMgPT09IENTTC5TRUVOKSB7XG4gICAgICAgICAgICBuZXh0LnN0YXR1cyA9IENTTC5TVUNDRVNTT1I7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0dXMgPT09IENTTC5TVUNDRVNTT1IgfHwgdGhpcy5zdGF0dXMgPT09IENTTC5TVUNDRVNTT1JfT0ZfU1VDQ0VTU09SKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5yYW5nZV9wcmVmaXgpIHtcbiAgICAgICAgICAgICAgICBuZXh0LnN0YXR1cyA9IENTTC5TVUNDRVNTT1JfT0ZfU1VDQ0VTU09SO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gQ1NMLlNVUFBSRVNTO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXh0LnN0YXR1cyA9IENTTC5TVUNDRVNTT1I7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLk51bWVyaWNCbG9iLnByb3RvdHlwZS5jaGVja0xhc3QgPSBmdW5jdGlvbiAobGFzdCkge1xuICAgIGlmICh0aGlzLnN0YXR1cyA9PT0gQ1NMLlNFRU4gXG4gICAgfHwgKGxhc3QubnVtICE9PSAodGhpcy5udW0gLSAxKSAmJiB0aGlzLnN0YXR1cyA9PT0gQ1NMLlNVQ0NFU1NPUikpIHtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBDU0wuU1VDQ0VTU09SO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlV0aWwuZml4RGF0ZU5vZGUgPSBmdW5jdGlvbiAocGFyZW50LCBwb3MsIG5vZGUpIHtcbiAgICB2YXIgZm9ybSwgdmFyaWFibGUsIGRhdGV4bWwsIHN1Ym5vZGUsIHBhcnRuYW1lLCBhdHRyLCB2YWwsIHByZWZpeCwgc3VmZml4LCBjaGlsZHJlbiwga2V5LCBzdWJjaGlsZHJlbiwga2tleSwgZGlzcGxheSwgY3NsaWQ7XG4gICAgdmFyIGxpbmdvID0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUobm9kZSwgXCJsaW5nb1wiKTtcbiAgICB2YXIgZGVmYXVsdF9sb2NhbGUgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2RlLCBcImRlZmF1bHQtbG9jYWxlXCIpO1xuICAgIHRoaXMuYnVpbGQuZGF0ZV9rZXkgPSB0cnVlO1xuICAgIGZvcm0gPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2RlLCBcImZvcm1cIik7XG4gICAgdmFyIGxpbmdvO1xuICAgIGlmIChkZWZhdWx0X2xvY2FsZSkge1xuICAgICAgICBsaW5nbyA9IHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbGluZ28gPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2RlLCBcImxpbmdvXCIpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuZ2V0RGF0ZShmb3JtLCBkZWZhdWx0X2xvY2FsZSkpIHtcbiAgICAgICAgcmV0dXJuIHBhcmVudDtcbiAgICB9XG4gICAgdmFyIGRhdGVwYXJ0cyA9IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwiZGF0ZS1wYXJ0c1wiKTtcbiAgICB2YXJpYWJsZSA9IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwidmFyaWFibGVcIik7XG4gICAgcHJlZml4ID0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUobm9kZSwgXCJwcmVmaXhcIik7XG4gICAgc3VmZml4ID0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUobm9kZSwgXCJzdWZmaXhcIik7XG4gICAgZGlzcGxheSA9IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwiZGlzcGxheVwiKTtcbiAgICBjc2xpZCA9IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwiY3NsaWRcIik7XG4gICAgZGF0ZXhtbCA9IHRoaXMuY3NsWG1sLm5vZGVDb3B5KHRoaXMuZ2V0RGF0ZShmb3JtLCBkZWZhdWx0X2xvY2FsZSkpO1xuICAgIHRoaXMuY3NsWG1sLnNldEF0dHJpYnV0ZShkYXRleG1sLCAnbGluZ28nLCB0aGlzLm9wdC5sYW5nKTtcbiAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGUoZGF0ZXhtbCwgJ2Zvcm0nLCBmb3JtKTtcbiAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGUoZGF0ZXhtbCwgJ2RhdGUtcGFydHMnLCBkYXRlcGFydHMpO1xuICAgIHRoaXMuY3NsWG1sLnNldEF0dHJpYnV0ZShkYXRleG1sLCBcImNzbGlkXCIsIGNzbGlkKTtcbiAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGUoZGF0ZXhtbCwgJ3ZhcmlhYmxlJywgdmFyaWFibGUpO1xuICAgIHRoaXMuY3NsWG1sLnNldEF0dHJpYnV0ZShkYXRleG1sLCAnZGVmYXVsdC1sb2NhbGUnLCBkZWZhdWx0X2xvY2FsZSk7XG4gICAgaWYgKHByZWZpeCkge1xuICAgICAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGUoZGF0ZXhtbCwgXCJwcmVmaXhcIiwgcHJlZml4KTtcbiAgICB9XG4gICAgaWYgKHN1ZmZpeCkge1xuICAgICAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGUoZGF0ZXhtbCwgXCJzdWZmaXhcIiwgc3VmZml4KTtcbiAgICB9XG4gICAgaWYgKGRpc3BsYXkpIHtcbiAgICAgICAgdGhpcy5jc2xYbWwuc2V0QXR0cmlidXRlKGRhdGV4bWwsIFwiZGlzcGxheVwiLCBkaXNwbGF5KTtcbiAgICB9XG4gICAgY2hpbGRyZW4gPSB0aGlzLmNzbFhtbC5jaGlsZHJlbihkYXRleG1sKTtcbiAgICBmb3IgKHZhciBrZXkgaW4gY2hpbGRyZW4pIHtcbiAgICAgICAgc3Vibm9kZSA9IGNoaWxkcmVuW2tleV07XG4gICAgICAgIGlmIChcImRhdGUtcGFydFwiID09PSB0aGlzLmNzbFhtbC5ub2RlbmFtZShzdWJub2RlKSkge1xuICAgICAgICAgICAgcGFydG5hbWUgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShzdWJub2RlLCBcIm5hbWVcIik7XG4gICAgICAgICAgICBpZiAoZGVmYXVsdF9sb2NhbGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGVPbk5vZGVJZGVudGlmaWVkQnlOYW1lQXR0cmlidXRlKGRhdGV4bWwsIFwiZGF0ZS1wYXJ0XCIsIHBhcnRuYW1lLCBcIkBkZWZhdWx0LWxvY2FsZVwiLCBcInRydWVcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2hpbGRyZW4gPSB0aGlzLmNzbFhtbC5jaGlsZHJlbihub2RlKTtcbiAgICBmb3IgKHZhciBrZXkgaW4gY2hpbGRyZW4pIHtcbiAgICAgICAgc3Vibm9kZSA9IGNoaWxkcmVuW2tleV07XG4gICAgICAgIGlmIChcImRhdGUtcGFydFwiID09PSB0aGlzLmNzbFhtbC5ub2RlbmFtZShzdWJub2RlKSkge1xuICAgICAgICAgICAgcGFydG5hbWUgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShzdWJub2RlLCBcIm5hbWVcIik7XG4gICAgICAgICAgICBzdWJjaGlsZHJlbiA9IHRoaXMuY3NsWG1sLmF0dHJpYnV0ZXMoc3Vibm9kZSk7XG4gICAgICAgICAgICBmb3IgKGF0dHIgaW4gc3ViY2hpbGRyZW4pIHtcbiAgICAgICAgICAgICAgICBpZiAoXCJAbmFtZVwiID09PSBhdHRyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobGluZ28gJiYgbGluZ28gIT09IHRoaXMub3B0LmxhbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFtcIkBzdWZmaXhcIiwgXCJAcHJlZml4XCIsIFwiQGZvcm1cIl0uaW5kZXhPZihhdHRyKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YWwgPSBzdWJjaGlsZHJlblthdHRyXTtcbiAgICAgICAgICAgICAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGVPbk5vZGVJZGVudGlmaWVkQnlOYW1lQXR0cmlidXRlKGRhdGV4bWwsIFwiZGF0ZS1wYXJ0XCIsIHBhcnRuYW1lLCBhdHRyLCB2YWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChcInllYXJcIiA9PT0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUobm9kZSwgXCJkYXRlLXBhcnRzXCIpKSB7XG4gICAgICAgIHRoaXMuY3NsWG1sLmRlbGV0ZU5vZGVCeU5hbWVBdHRyaWJ1dGUoZGF0ZXhtbCwgJ21vbnRoJyk7XG4gICAgICAgIHRoaXMuY3NsWG1sLmRlbGV0ZU5vZGVCeU5hbWVBdHRyaWJ1dGUoZGF0ZXhtbCwgJ2RheScpO1xuICAgIH0gZWxzZSBpZiAoXCJ5ZWFyLW1vbnRoXCIgPT09IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwiZGF0ZS1wYXJ0c1wiKSkge1xuICAgICAgICB0aGlzLmNzbFhtbC5kZWxldGVOb2RlQnlOYW1lQXR0cmlidXRlKGRhdGV4bWwsICdkYXknKTtcbiAgICB9IGVsc2UgaWYgKFwibW9udGgtZGF5XCIgPT09IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwiZGF0ZS1wYXJ0c1wiKSkge1xuICAgICAgICB2YXIgY2hpbGROb2RlcyA9IHRoaXMuY3NsWG1sLmNoaWxkcmVuKGRhdGV4bWwpO1xuICAgICAgICBmb3IgKHZhciBpPTEsaWxlbj10aGlzLmNzbFhtbC5udW1iZXJvZm5vZGVzKGNoaWxkTm9kZXMpO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShjaGlsZE5vZGVzW2ldLCAnbmFtZScpID09PSBcInllYXJcIikge1xuICAgICAgICAgICAgICAgIHRoaXMuY3NsWG1sLnNldEF0dHJpYnV0ZShjaGlsZE5vZGVzW2ktMV0sIFwic3VmZml4XCIsIFwiXCIpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuY3NsWG1sLmRlbGV0ZU5vZGVCeU5hbWVBdHRyaWJ1dGUoZGF0ZXhtbCwgJ3llYXInKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY3NsWG1sLmluc2VydENoaWxkTm9kZUFmdGVyKHBhcmVudCwgbm9kZSwgcG9zLCBkYXRleG1sKTtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5kYXRlTWFjcm9Bc1NvcnRLZXkgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICBDU0wuZGF0ZUFzU29ydEtleS5jYWxsKHRoaXMsIHN0YXRlLCBJdGVtLCB0cnVlKTtcbn07XG5DU0wuZGF0ZUFzU29ydEtleSA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXNNYWNybykge1xuICAgIHZhciBkcCwgZWxlbSwgdmFsdWUsIGUsIHlyLCBwcmVmaXgsIGksIGlsZW4sIG51bTtcbiAgICB2YXIgdmFyaWFibGUgPSB0aGlzLnZhcmlhYmxlc1swXTtcbiAgICB2YXIgbWFjcm9GbGFnID0gXCJlbXB0eVwiO1xuICAgIGlmIChpc01hY3JvICYmIHN0YXRlLnRtcC5leHRlbnNpb24pIHtcbiAgICAgICAgbWFjcm9GbGFnID0gXCJtYWNyby13aXRoLWRhdGVcIjtcbiAgICB9XG4gICAgZHAgPSBJdGVtW3ZhcmlhYmxlXTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGRwKSB7XG4gICAgICAgIGRwID0ge1wiZGF0ZS1wYXJ0c1wiOiBbWzBdXSB9O1xuICAgICAgICBpZiAoIWRwLnllYXIpIHtcbiAgICAgICAgICAgIHN0YXRlLnRtcC5lbXB0eV9kYXRlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMuZGF0ZXBhcnRzKSB7XG4gICAgICAgIHRoaXMuZGF0ZXBhcnRzID0gW1wieWVhclwiLCBcIm1vbnRoXCIsIFwiZGF5XCJdO1xuICAgIH1cbiAgICBpZiAoZHAucmF3KSB7XG4gICAgICAgIGRwID0gc3RhdGUuZnVuLmRhdGVwYXJzZXIucGFyc2VEYXRlVG9BcnJheShkcC5yYXcpO1xuICAgIH0gZWxzZSBpZiAoZHBbXCJkYXRlLXBhcnRzXCJdKSB7XG4gICAgICAgIGRwID0gc3RhdGUuZGF0ZVBhcnNlQXJyYXkoZHApO1xuICAgIH1cbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGRwKSB7XG4gICAgICAgIGRwID0ge307XG4gICAgfVxuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBDU0wuREFURV9QQVJUU19JTlRFUk5BTC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgZWxlbSA9IENTTC5EQVRFX1BBUlRTX0lOVEVSTkFMW2ldO1xuICAgICAgICB2YWx1ZSA9IDA7XG4gICAgICAgIGUgPSBlbGVtO1xuICAgICAgICBpZiAoZS5zbGljZSgtNCkgPT09IFwiX2VuZFwiKSB7XG4gICAgICAgICAgICBlID0gZS5zbGljZSgwLCAtNCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRwW2VsZW1dICYmIHRoaXMuZGF0ZXBhcnRzLmluZGV4T2YoZSkgPiAtMSkge1xuICAgICAgICAgICAgdmFsdWUgPSBkcFtlbGVtXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZWxlbS5zbGljZSgwLCA0KSA9PT0gXCJ5ZWFyXCIpIHtcbiAgICAgICAgICAgIHlyID0gQ1NMLlV0aWwuRGF0ZXNbZV0ubnVtZXJpYyhzdGF0ZSwgdmFsdWUpO1xuICAgICAgICAgICAgdmFyIHByZWZpeCA9IFwiWVwiO1xuICAgICAgICAgICAgaWYgKHlyWzBdID09PSBcIi1cIikge1xuICAgICAgICAgICAgICAgIHByZWZpeCA9IFwiWFwiO1xuICAgICAgICAgICAgICAgIHlyID0geXIuc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgeXIgPSA5OTk5IC0gcGFyc2VJbnQoeXIsIDEwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQoQ1NMLlV0aWwuRGF0ZXNbZWxlbS5zbGljZSgwLCA0KV0ubnVtZXJpYyhzdGF0ZSwgKHByZWZpeCArIHlyKSksIG1hY3JvRmxhZyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YWx1ZSA9IENTTC5VdGlsLkRhdGVzW2VdW1wibnVtZXJpYy1sZWFkaW5nLXplcm9zXCJdKHN0YXRlLCB2YWx1ZSk7XG4gICAgICAgICAgICBpZiAoIXZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBcIjAwXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHZhbHVlLCBtYWNyb0ZsYWcpO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmRhdGVQYXJzZUFycmF5ID0gZnVuY3Rpb24gKGRhdGVfb2JqKSB7XG4gICAgdmFyIHJldCwgZmllbGQsIGRwb3MsIHBwb3MsIGRwLCBleHRzLCBsbGVuLCBwb3MsIGxlbiwgcHBwb3MsIGxsbGVuO1xuICAgIHJldCA9IHt9O1xuICAgIGZvciAoZmllbGQgaW4gZGF0ZV9vYmopIHtcbiAgICAgICAgaWYgKGZpZWxkID09PSBcImRhdGUtcGFydHNcIikge1xuICAgICAgICAgICAgZHAgPSBkYXRlX29ialtcImRhdGUtcGFydHNcIl07XG4gICAgICAgICAgICBpZiAoZHAubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIGlmIChkcFswXS5sZW5ndGggIT09IGRwWzFdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBDU0wuZXJyb3IoXCJDU0wgZGF0YSBlcnJvcjogZWxlbWVudCBtaXNtYXRjaCBpbiBkYXRlIHJhbmdlIGlucHV0LlwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBleHRzID0gW1wiXCIsIFwiX2VuZFwiXTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gZHAubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSBDU0wuREFURV9QQVJUUy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzTmFOKHBhcnNlSW50KGRwW2ldW2pdLCAxMCkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXRbKENTTC5EQVRFX1BBUlRTW2pdICsgZXh0c1tpXSldID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0WyhDU0wuREFURV9QQVJUU1tqXSArIGV4dHNbaV0pXSA9IHBhcnNlSW50KGRwW2ldW2pdLCAxMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZGF0ZV9vYmouaGFzT3duUHJvcGVydHkoZmllbGQpKSB7XG4gICAgICAgICAgICBpZiAoZmllbGQgPT09IFwibGl0ZXJhbFwiICYmIFwib2JqZWN0XCIgPT09IHR5cGVvZiBkYXRlX29iai5saXRlcmFsICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiBkYXRlX29iai5saXRlcmFsLnBhcnQpIHtcbiAgICAgICAgICAgICAgICBDU0wuZGVidWcoXCJXYXJuaW5nOiBmaXhpbmcgdXAgd2VpcmQgbGl0ZXJhbCBkYXRlIHZhbHVlXCIpO1xuICAgICAgICAgICAgICAgIHJldC5saXRlcmFsID0gZGF0ZV9vYmoubGl0ZXJhbC5wYXJ0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXRbZmllbGRdID0gZGF0ZV9vYmpbZmllbGRdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuVXRpbC5OYW1lcyA9IHt9O1xuQ1NMLlV0aWwuTmFtZXMuY29tcGFyZU5hbWVzZXRzID0gQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9jb21wYXJlTmFtZXNldHM7XG5DU0wuVXRpbC5OYW1lcy51bkluaXRpYWxpemUgPSBmdW5jdGlvbiAoc3RhdGUsIG5hbWUpIHtcbiAgICB2YXIgaSwgaWxlbiwgbmFtZWxpc3QsIHB1bmN0bGlzdCwgcmV0O1xuICAgIGlmICghbmFtZSkge1xuICAgICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gICAgbmFtZWxpc3QgPSBuYW1lLnNwbGl0KC8oPzpcXC18XFxzKykvKTtcbiAgICBwdW5jdGxpc3QgPSBuYW1lLm1hdGNoKC8oXFwtfFxccyspL2cpO1xuICAgIHJldCA9IFwiXCI7XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IG5hbWVsaXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICByZXQgKz0gbmFtZWxpc3RbaV07XG4gICAgICAgIGlmIChpIDwgaWxlbiAtIDEpIHtcbiAgICAgICAgICAgIHJldCArPSBwdW5jdGxpc3RbaV07XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuVXRpbC5OYW1lcy5pbml0aWFsaXplV2l0aCA9IGZ1bmN0aW9uIChzdGF0ZSwgbmFtZSwgdGVybWluYXRvciwgbm9ybWFsaXplT25seSkge1xuICAgIHZhciBpLCBpbGVuLCBqLCBqbGVuLCBuLCBtLCBtbSwgc3RyLCBsc3QsIHJldDtcbiAgICBpZiAoIW5hbWUpIHtcbiAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuICAgIGlmICghdGVybWluYXRvcikge1xuICAgICAgICB0ZXJtaW5hdG9yID0gXCJcIjtcbiAgICB9XG4gICAgaWYgKFtcIkxvcmRcIiwgXCJMYWR5XCJdLmluZGV4T2YobmFtZSkgPiAtMVxuICAgICAgICB8fCAoIW5hbWUubWF0Y2goQ1NMLlNUQVJUU1dJVEhfUk9NQU5FU1FVRV9SRUdFWFApXG4gICAgICAgICAgICAmJiAhdGVybWluYXRvci5tYXRjaChcIiVzXCIpKSkge1xuICAgICAgICByZXR1cm4gbmFtZTtcbiAgICB9XG4gICAgdmFyIG5hbWVsaXN0ID0gbmFtZTtcbiAgICBpZiAoc3RhdGUub3B0W1wiaW5pdGlhbGl6ZS13aXRoLWh5cGhlblwiXSA9PT0gZmFsc2UpIHtcbiAgICAgICAgbmFtZWxpc3QgPSBuYW1lbGlzdC5yZXBsYWNlKC9cXC0vZywgXCIgXCIpO1xuICAgIH1cbiAgICBuYW1lbGlzdCA9IG5hbWVsaXN0LnJlcGxhY2UoL1xccypcXC1cXHMqL2csIFwiLVwiKS5yZXBsYWNlKC9cXHMrL2csIFwiIFwiKTtcbiAgICBuYW1lbGlzdCA9IG5hbWVsaXN0LnJlcGxhY2UoLy0oW2Etel0pL2csIFwiXFx1MjAxMyQxXCIpO1xuICAgIG1tID0gbmFtZWxpc3QubWF0Y2goL1tcXC1cXHNdKy9nKTtcbiAgICBsc3QgPSBuYW1lbGlzdC5zcGxpdCgvW1xcLVxcc10rLyk7XG4gICAgaWYgKGxzdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgbmFtZWxpc3QgPSBtbTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBuYW1lbGlzdCA9IFtsc3RbMF1dO1xuICAgICAgICBmb3IgKGkgPSAxLCBpbGVuID0gbHN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgbmFtZWxpc3QucHVzaChtbVtpIC0gMV0pO1xuICAgICAgICAgICAgbmFtZWxpc3QucHVzaChsc3RbaV0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGxzdCA9IG5hbWVsaXN0O1xuICAgIGZvciAoaSA9IGxzdC5sZW5ndGggLTE7IGkgPiAtMTsgaSArPSAtMSkge1xuICAgICAgICBpZiAobHN0W2ldICYmIGxzdFtpXS5zbGljZSgwLCAtMSkuaW5kZXhPZihcIi5cIikgPiAtMSkge1xuICAgICAgICAgICAgdmFyIGxzdGVuZCA9IGxzdC5zbGljZShpICsgMSk7XG4gICAgICAgICAgICB2YXIgbHN0bWlkID0gbHN0W2ldLnNsaWNlKDAsIC0xKS5zcGxpdChcIi5cIik7XG4gICAgICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCwgaSk7XG4gICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gbHN0bWlkLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgIGxzdC5wdXNoKGxzdG1pZFtqXSArIFwiLlwiKTtcbiAgICAgICAgICAgICAgICBpZiAoaiA8IGxzdG1pZC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGxzdC5wdXNoKFwiIFwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsc3QgPSBsc3QuY29uY2F0KGxzdGVuZCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKG5vcm1hbGl6ZU9ubHkpIHtcbiAgICAgICAgcmV0ID0gQ1NMLlV0aWwuTmFtZXMuZG9Ob3JtYWxpemUoc3RhdGUsIGxzdCwgdGVybWluYXRvcik7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0ID0gQ1NMLlV0aWwuTmFtZXMuZG9Jbml0aWFsaXplKHN0YXRlLCBsc3QsIHRlcm1pbmF0b3IpO1xuICAgIH1cbiAgICByZXQgPSByZXQucmVwbGFjZSgvXFx1MjAxMyhbYS16XSkvZywgXCItJDFcIik7XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuVXRpbC5OYW1lcy5kb05vcm1hbGl6ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgbmFtZWxpc3QsIHRlcm1pbmF0b3IsIG1vZGUpIHtcbiAgICB2YXIgaSwgaWxlbjtcbiAgICB0ZXJtaW5hdG9yID0gdGVybWluYXRvciA/IHRlcm1pbmF0b3IgOiBcIlwiO1xuICAgIHZhciBpc0FiYnJldiA9IFtdO1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBuYW1lbGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKG5hbWVsaXN0W2ldLmxlbmd0aCA+IDEgJiYgbmFtZWxpc3RbaV0uc2xpY2UoLTEpID09PSBcIi5cIikge1xuICAgICAgICAgICAgbmFtZWxpc3RbaV0gPSBuYW1lbGlzdFtpXS5zbGljZSgwLCAtMSk7XG4gICAgICAgICAgICBpc0FiYnJldi5wdXNoKHRydWUpO1xuICAgICAgICB9IGVsc2UgaWYgKG5hbWVsaXN0W2ldLmxlbmd0aCA9PT0gMSAmJiBuYW1lbGlzdFtpXS50b1VwcGVyQ2FzZSgpID09PSBuYW1lbGlzdFtpXSkge1xuICAgICAgICAgICAgaXNBYmJyZXYucHVzaCh0cnVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlzQWJicmV2LnB1c2goZmFsc2UpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHZhciByZXQgPSBbXTtcbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gbmFtZWxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAyKSB7XG4gICAgICAgIGlmIChpc0FiYnJldltpXSkge1xuICAgICAgICAgICAgaWYgKGkgPCBuYW1lbGlzdC5sZW5ndGggLSAyKSB7XG4gICAgICAgICAgICAgICAgbmFtZWxpc3RbaSArIDFdID0gXCJcIjtcbiAgICAgICAgICAgICAgICB2YXIgb25seVNwYWNlID0gdGVybWluYXRvci5tYXRjaCgvXltcXHUwMDA5XFx1MDAwYVxcdTAwMGJcXHUwMDBjXFx1MDAwZFxcdTAwMjBcXHUwMGEwXSskLylcbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgIG9ubHlTcGFjZVxuICAgICAgICAgICAgICAgICAgICB8fCAoXG4gICAgICAgICAgICAgICAgICAgICAgICAoIXRlcm1pbmF0b3IgfHwgKHRlcm1pbmF0b3Iuc2xpY2UoLTEpICYmICF0ZXJtaW5hdG9yLnNsaWNlKC0xKS5tYXRjaCgvW1xcdTAwMDlcXHUwMDBhXFx1MDAwYlxcdTAwMGNcXHUwMDBkXFx1MDAyMFxcdTAwYTBdLykpKVxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgbmFtZWxpc3RbaV0ubGVuZ3RoICYmIG5hbWVsaXN0W2ldLm1hdGNoKENTTC5BTExfUk9NQU5FU1FVRV9SRUdFWFApXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiAobmFtZWxpc3RbaV0ubGVuZ3RoID4gMSB8fCBuYW1lbGlzdFtpICsgMl0ubGVuZ3RoID4gMSlcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBuYW1lbGlzdFtpICsgMV0gPSBcIiBcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG5hbWVsaXN0W2kgKyAyXS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVsaXN0W2ldID0gbmFtZWxpc3RbaV0gKyB0ZXJtaW5hdG9yLnJlcGxhY2UoL1xcdWZlZmYkLywgXCJcIik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZWxpc3RbaV0gPSBuYW1lbGlzdFtpXSArIHRlcm1pbmF0b3I7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGkgPT09IG5hbWVsaXN0Lmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICBuYW1lbGlzdFtpXSA9IG5hbWVsaXN0W2ldICsgdGVybWluYXRvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbmFtZWxpc3Quam9pbihcIlwiKS5yZXBsYWNlKC9bXFx1MDAwOVxcdTAwMGFcXHUwMDBiXFx1MDAwY1xcdTAwMGRcXHUwMDIwXFx1ZmVmZlxcdTAwYTBdKyQvLFwiXCIpLnJlcGxhY2UoL1xccypcXC1cXHMqL2csIFwiLVwiKS5yZXBsYWNlKC9bXFx1MDAwOVxcdTAwMGFcXHUwMDBiXFx1MDAwY1xcdTAwMGRcXHUwMDIwXSsvZywgXCIgXCIpO1xufTtcbkNTTC5VdGlsLk5hbWVzLmRvSW5pdGlhbGl6ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgbmFtZWxpc3QsIHRlcm1pbmF0b3IsIG1vZGUpIHtcbiAgICB2YXIgaSwgaWxlbiwgbSwgaiwgamxlbiwgbHN0LCBuO1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBuYW1lbGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDIpIHtcbiAgICAgICAgbiA9IG5hbWVsaXN0W2ldO1xuICAgICAgICBpZiAoIW4pIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIG0gPSBuLm1hdGNoKENTTC5OQU1FX0lOSVRJQUxfUkVHRVhQKTtcbiAgICAgICAgaWYgKCFtICYmICghbi5tYXRjaChDU0wuU1RBUlRTV0lUSF9ST01BTkVTUVVFX1JFR0VYUCkgJiYgbi5sZW5ndGggPiAxICYmIHRlcm1pbmF0b3IubWF0Y2goXCIlc1wiKSkpIHtcbiAgICAgICAgICAgIG0gPSBuLm1hdGNoKC8oLikoLiopLyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG0gJiYgbVsxXSA9PT0gbVsxXS50b1VwcGVyQ2FzZSgpKSB7XG4gICAgICAgICAgICB2YXIgZXh0cmEgPSBcIlwiO1xuICAgICAgICAgICAgaWYgKG1bMl0pIHtcbiAgICAgICAgICAgICAgICB2YXIgcyA9IFwiXCI7XG4gICAgICAgICAgICAgICAgbHN0ID0gbVsyXS5zcGxpdChcIlwiKTtcbiAgICAgICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gbHN0Lmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGxzdFtqXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGMgPT09IGMudG9VcHBlckNhc2UoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcyArPSBjO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMubGVuZ3RoIDwgbVsyXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgZXh0cmEgPSBzLnRvTG9jYWxlTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmFtZWxpc3RbaV0gPSBtWzFdLnRvTG9jYWxlVXBwZXJDYXNlKCkgKyBleHRyYTtcbiAgICAgICAgICAgIGlmIChpIDwgKGlsZW4gLSAxKSkge1xuICAgICAgICAgICAgICAgIGlmICh0ZXJtaW5hdG9yLm1hdGNoKFwiJXNcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZWxpc3RbaV0gPSB0ZXJtaW5hdG9yLnJlcGxhY2UoXCIlc1wiLCBuYW1lbGlzdFtpXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWVsaXN0W2kgKyAxXS5pbmRleE9mKFwiLVwiKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lbGlzdFtpICsgMV0gPSB0ZXJtaW5hdG9yICsgbmFtZWxpc3RbaSArIDFdO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWxpc3RbaSArIDFdID0gdGVybWluYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHRlcm1pbmF0b3IubWF0Y2goXCIlc1wiKSkge1xuICAgICAgICAgICAgICAgICAgICBuYW1lbGlzdFtpXSA9IHRlcm1pbmF0b3IucmVwbGFjZShcIiVzXCIsIG5hbWVsaXN0W2ldKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuYW1lbGlzdC5wdXNoKHRlcm1pbmF0b3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChuLm1hdGNoKENTTC5ST01BTkVTUVVFX1JFR0VYUCkpIHtcbiAgICAgICAgICAgIG5hbWVsaXN0W2ldID0gXCIgXCIgKyBuO1xuICAgICAgICB9XG4gICAgfVxuICAgIHZhciByZXQgPSBuYW1lbGlzdC5qb2luKFwiXCIpO1xuICAgIHJldCA9IHJldC5yZXBsYWNlKC9bXFx1MDAwOVxcdTAwMGFcXHUwMDBiXFx1MDAwY1xcdTAwMGRcXHUwMDIwXFx1ZmVmZlxcdTAwYTBdKyQvLFwiXCIpLnJlcGxhY2UoL1xccypcXC1cXHMqL2csIFwiLVwiKS5yZXBsYWNlKC9bXFx1MDAwOVxcdTAwMGFcXHUwMDBiXFx1MDAwY1xcdTAwMGRcXHUwMDIwXSsvZywgXCIgXCIpO1xuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLlV0aWwuTmFtZXMuZ2V0UmF3TmFtZSA9IGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgdmFyIHJldCA9IFtdO1xuICAgIGlmIChuYW1lLmdpdmVuKSB7XG4gICAgICAgIHJldC5wdXNoKG5hbWUuZ2l2ZW4pO1xuICAgIH1cbiAgICBpZiAobmFtZS5mYW1pbHkpIHtcbiAgICAgICAgcmV0LnB1c2gobmFtZS5mYW1pbHkpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0LmpvaW4oXCIgXCIpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlV0aWwuRGF0ZXMgPSB7fTtcbkNTTC5VdGlsLkRhdGVzLnllYXIgPSB7fTtcbkNTTC5VdGlsLkRhdGVzLnllYXJbXCJsb25nXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBudW0pIHtcbiAgICBpZiAoIW51bSkge1xuICAgICAgICBpZiAoXCJib29sZWFuXCIgPT09IHR5cGVvZiBudW0pIHtcbiAgICAgICAgICAgIG51bSA9IFwiXCI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBudW0gPSAwO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudW0udG9TdHJpbmcoKTtcbn07XG5DU0wuVXRpbC5EYXRlcy55ZWFyLmltcGVyaWFsID0gZnVuY3Rpb24gKHN0YXRlLCBudW0sIGVuZCwgbWFrZVNob3J0KSB7XG4gICAgdmFyIHllYXIgPSBcIlwiO1xuICAgIGlmICghbnVtKSB7XG4gICAgICAgIGlmIChcImJvb2xlYW5cIiA9PT0gdHlwZW9mIG51bSkge1xuICAgICAgICAgICAgbnVtID0gXCJcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG51bSA9IDA7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZW5kID0gZW5kID8gXCJfZW5kXCIgOiBcIlwiO1xuICAgIHZhciBtb250aCA9IHN0YXRlLnRtcC5kYXRlX29iamVjdFtcIm1vbnRoXCIgKyBlbmRdO1xuICAgIG1vbnRoID0gbW9udGggPyBcIlwiK21vbnRoIDogXCIxXCI7XG4gICAgd2hpbGUgKG1vbnRoLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgbW9udGggPSBcIjBcIiArIG1vbnRoO1xuICAgIH1cbiAgICB2YXIgZGF5ID0gc3RhdGUudG1wLmRhdGVfb2JqZWN0W1wiZGF5XCIgKyBlbmRdO1xuICAgIGRheSA9IGRheSA/IFwiXCIrZGF5IDogXCIxXCI7XG4gICAgd2hpbGUgKGRheS5sZW5ndGggPCAyKSB7XG4gICAgICAgIGRheSA9IFwiMFwiICsgZGF5O1xuICAgIH1cbiAgICB2YXIgZGF0ZSA9IHBhcnNlSW50KG51bSArIG1vbnRoICsgZGF5LCAxMCk7XG4gICAgdmFyIGxhYmVsO1xuICAgIHZhciBvZmZzZXQ7XG4gICAgaWYgKGRhdGUgPj0gMTg2ODA5MDggJiYgZGF0ZSA8IDE5MTIwNzMwKSB7XG4gICAgICAgIGxhYmVsID0gJ1xcdTY2MGVcXHU2Y2JiJztcbiAgICAgICAgb2Zmc2V0ID0gMTg2NztcbiAgICB9IGVsc2UgaWYgKGRhdGUgPj0gMTkxMjA3MzAgJiYgZGF0ZSA8IDE5MjYxMjI1KSB7XG4gICAgICAgIGxhYmVsID0gJ1xcdTU5MjdcXHU2YjYzJztcbiAgICAgICAgb2Zmc2V0ID0gMTkxMTtcbiAgICB9IGVsc2UgaWYgKGRhdGUgPj0gMTkyNjEyMjUgJiYgZGF0ZSA8IDE5ODkwMTA4KSB7XG4gICAgICAgIGxhYmVsID0gJ1xcdTY2MmRcXHU1NDhjJztcbiAgICAgICAgb2Zmc2V0ID0gMTkyNTtcbiAgICB9IGVsc2UgaWYgKGRhdGUgPj0gMTk4OTAxMDgpIHtcbiAgICAgICAgbGFiZWwgPSAnXFx1NWU3M1xcdTYyMTAnO1xuICAgICAgICBvZmZzZXQgPSAxOTg4O1xuICAgIH1cbiAgICBpZiAobGFiZWwgJiYgb2Zmc2V0KSB7XG4gICAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gbGFiZWw7XG4gICAgICAgIGlmIChzdGF0ZS5zeXMubm9ybWFsaXplQWJicmV2c0tleSkge1xuICAgICAgICAgICAgbm9ybWFsaXplZEtleSA9IHN0YXRlLnN5cy5ub3JtYWxpemVBYmJyZXZzS2V5KFwibnVtYmVyXCIsIGxhYmVsKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzWydkZWZhdWx0J11bJ251bWJlciddW25vcm1hbGl6ZWRLZXldKSB7XG4gICAgICAgICAgICBzdGF0ZS50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbignZGVmYXVsdCcsIFwibnVtYmVyXCIsIG5vcm1hbGl6ZWRLZXkpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1snZGVmYXVsdCddWydudW1iZXInXVtub3JtYWxpemVkS2V5XSkge1xuICAgICAgICAgICAgbGFiZWwgPSBzdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1snZGVmYXVsdCddWydudW1iZXInXVtub3JtYWxpemVkS2V5XTtcbiAgICAgICAgfTtcbiAgICAgICAgeWVhciA9IGxhYmVsICsgKG51bSAtIG9mZnNldCk7XG4gICAgfVxuICAgIHJldHVybiB5ZWFyO1xufTtcbkNTTC5VdGlsLkRhdGVzLnllYXJbXCJzaG9ydFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgbnVtKSB7XG4gICAgbnVtID0gbnVtLnRvU3RyaW5nKCk7XG4gICAgaWYgKG51bSAmJiBudW0ubGVuZ3RoID09PSA0KSB7XG4gICAgICAgIHJldHVybiBudW0uc3Vic3RyKDIpO1xuICAgIH1cbn07XG5DU0wuVXRpbC5EYXRlcy55ZWFyLm51bWVyaWMgPSBmdW5jdGlvbiAoc3RhdGUsIG51bSkge1xuICAgIHZhciBtLCBwcmU7XG4gICAgbnVtID0gXCJcIiArIG51bTtcbiAgICB2YXIgbSA9IG51bS5tYXRjaCgvKFswLTldKikkLyk7XG4gICAgaWYgKG0pIHtcbiAgICAgICAgcHJlID0gbnVtLnNsaWNlKDAsIG1bMV0ubGVuZ3RoICogLTEpO1xuICAgICAgICBudW0gPSBtWzFdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHByZSA9IG51bTtcbiAgICAgICAgbnVtID0gXCJcIjtcbiAgICB9XG4gICAgd2hpbGUgKG51bS5sZW5ndGggPCA0KSB7XG4gICAgICAgIG51bSA9IFwiMFwiICsgbnVtO1xuICAgIH1cbiAgICByZXR1cm4gKHByZSArIG51bSk7XG59O1xuQ1NMLlV0aWwuRGF0ZXMubm9ybWFsaXplTW9udGggPSBmdW5jdGlvbiAobnVtLCB1c2VTZWFzb24pIHtcbiAgICB2YXIgcmV0O1xuICAgIGlmICghbnVtKSB7XG4gICAgICAgIG51bSA9IDA7XG4gICAgfVxuICAgIG51bSA9IFwiXCIgKyBudW07XG4gICAgaWYgKCFudW0ubWF0Y2goL15bMC05XSskLykpIHtcbiAgICAgICAgbnVtID0gMDtcbiAgICB9XG4gICAgbnVtID0gcGFyc2VJbnQobnVtLCAxMCk7XG4gICAgaWYgKHVzZVNlYXNvbikge1xuICAgICAgICB2YXIgcmVzID0ge3N0dWI6IFwibW9udGgtXCIsIG51bTogbnVtfTtcbiAgICAgICAgaWYgKHJlcy5udW0gPCAxIHx8IHJlcy5udW0gPiAyMCkge1xuICAgICAgICAgICAgcmVzLm51bSA9IDA7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzLm51bSA+IDE2KSB7XG4gICAgICAgICAgICByZXMuc3R1YiA9IFwic2Vhc29uLVwiO1xuICAgICAgICAgICAgcmVzLm51bSA9IHJlcy5udW0gLSAxNjtcbiAgICAgICAgfSBlbHNlIGlmIChyZXMubnVtID4gMTIpIHtcbiAgICAgICAgICAgIHJlcy5zdHViID0gXCJzZWFzb24tXCI7XG4gICAgICAgICAgICByZXMubnVtID0gcmVzLm51bSAtIDEyO1xuICAgICAgICB9XG4gICAgICAgIHJldCA9IHJlcztcbiAgICB9IGVsc2Uge1xuICAgICAgICBpZiAobnVtIDwgMSB8fCBudW0gPiAxMikge1xuICAgICAgICAgICAgbnVtID0gMDtcbiAgICAgICAgfVxuICAgICAgICByZXQgPSBudW07XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59XG5DU0wuVXRpbC5EYXRlcy5tb250aCA9IHt9O1xuQ1NMLlV0aWwuRGF0ZXMubW9udGgubnVtZXJpYyA9IGZ1bmN0aW9uIChzdGF0ZSwgbnVtKSB7XG4gICAgdmFyIG51bSA9IENTTC5VdGlsLkRhdGVzLm5vcm1hbGl6ZU1vbnRoKG51bSk7XG4gICAgaWYgKCFudW0pIHtcbiAgICAgICAgbnVtID0gXCJcIjtcbiAgICB9XG4gICAgcmV0dXJuIG51bTtcbn07XG5DU0wuVXRpbC5EYXRlcy5tb250aFtcIm51bWVyaWMtbGVhZGluZy16ZXJvc1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgbnVtKSB7XG4gICAgdmFyIG51bSA9IENTTC5VdGlsLkRhdGVzLm5vcm1hbGl6ZU1vbnRoKG51bSk7XG4gICAgaWYgKCFudW0pIHtcbiAgICAgICAgbnVtID0gXCJcIjtcbiAgICB9IGVsc2Uge1xuICAgICAgICBudW0gPSBcIlwiICsgbnVtO1xuICAgICAgICB3aGlsZSAobnVtLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgICAgIG51bSA9IFwiMFwiICsgbnVtO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudW07XG59O1xuQ1NMLlV0aWwuRGF0ZXMubW9udGhbXCJsb25nXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBudW0sIGdlbmRlciwgZm9yY2VEZWZhdWx0TG9jYWxlKSB7XG4gICAgdmFyIHJlcyA9IENTTC5VdGlsLkRhdGVzLm5vcm1hbGl6ZU1vbnRoKG51bSwgdHJ1ZSk7XG4gICAgdmFyIG51bSA9IHJlcy5udW07XG4gICAgaWYgKCFudW0pIHtcbiAgICAgICAgbnVtID0gXCJcIjtcbiAgICB9IGVsc2Uge1xuICAgICAgICBudW0gPSBcIlwiICsgbnVtO1xuICAgICAgICB3aGlsZSAobnVtLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgICAgIG51bSA9IFwiMFwiICsgbnVtO1xuICAgICAgICB9XG4gICAgICAgIG51bSA9IHN0YXRlLmdldFRlcm0ocmVzLnN0dWIgKyBudW0sIFwibG9uZ1wiLCAwLCAwLCBmYWxzZSwgZm9yY2VEZWZhdWx0TG9jYWxlKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bTtcbn07XG5DU0wuVXRpbC5EYXRlcy5tb250aFtcInNob3J0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBudW0sIGdlbmRlciwgZm9yY2VEZWZhdWx0TG9jYWxlKSB7XG4gICAgdmFyIHJlcyA9IENTTC5VdGlsLkRhdGVzLm5vcm1hbGl6ZU1vbnRoKG51bSwgdHJ1ZSk7XG4gICAgdmFyIG51bSA9IHJlcy5udW07XG4gICAgaWYgKCFudW0pIHtcbiAgICAgICAgbnVtID0gXCJcIjtcbiAgICB9IGVsc2Uge1xuICAgICAgICBudW0gPSBcIlwiICsgbnVtO1xuICAgICAgICB3aGlsZSAobnVtLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgICAgIG51bSA9IFwiMFwiICsgbnVtO1xuICAgICAgICB9XG4gICAgICAgIG51bSA9IHN0YXRlLmdldFRlcm0ocmVzLnN0dWIgKyBudW0sIFwic2hvcnRcIiwgMCwgMCwgZmFsc2UsIGZvcmNlRGVmYXVsdExvY2FsZSk7XG4gICAgfVxuICAgIHJldHVybiBudW07XG59O1xuQ1NMLlV0aWwuRGF0ZXMuZGF5ID0ge307XG5DU0wuVXRpbC5EYXRlcy5kYXkubnVtZXJpYyA9IGZ1bmN0aW9uIChzdGF0ZSwgbnVtKSB7XG4gICAgcmV0dXJuIG51bS50b1N0cmluZygpO1xufTtcbkNTTC5VdGlsLkRhdGVzLmRheVtcImxvbmdcIl0gPSBDU0wuVXRpbC5EYXRlcy5kYXkubnVtZXJpYztcbkNTTC5VdGlsLkRhdGVzLmRheVtcIm51bWVyaWMtbGVhZGluZy16ZXJvc1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgbnVtKSB7XG4gICAgaWYgKCFudW0pIHtcbiAgICAgICAgbnVtID0gMDtcbiAgICB9XG4gICAgbnVtID0gbnVtLnRvU3RyaW5nKCk7XG4gICAgd2hpbGUgKG51bS5sZW5ndGggPCAyKSB7XG4gICAgICAgIG51bSA9IFwiMFwiICsgbnVtO1xuICAgIH1cbiAgICByZXR1cm4gbnVtLnRvU3RyaW5nKCk7XG59O1xuQ1NMLlV0aWwuRGF0ZXMuZGF5Lm9yZGluYWwgPSBmdW5jdGlvbiAoc3RhdGUsIG51bSwgZ2VuZGVyKSB7XG4gICAgcmV0dXJuIHN0YXRlLmZ1bi5vcmRpbmFsaXplci5mb3JtYXQobnVtLCBnZW5kZXIpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlV0aWwuU29ydCA9IHt9O1xuQ1NMLlV0aWwuU29ydC5zdHJpcF9wcmVwb3NpdGlvbnMgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgdmFyIG07XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBzdHIpIHtcbiAgICAgICAgbSA9IHN0ci50b0xvY2FsZUxvd2VyQ2FzZSgpO1xuICAgICAgICBtID0gc3RyLm1hdGNoKC9eKChhfGFufHRoZSlcXHMrKS8pO1xuICAgIH1cbiAgICBpZiAobSkge1xuICAgICAgICBzdHIgPSBzdHIuc3Vic3RyKG1bMV0ubGVuZ3RoKTtcbiAgICB9XG4gICAgcmV0dXJuIHN0cjtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5VdGlsLnN1YnN0aXR1dGVTdGFydCA9IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgdmFyIGVsZW1lbnRfdHJhY2UsIGRpc3BsYXksIGJpYl9maXJzdCwgZnVuYywgY2hvb3NlX3N0YXJ0LCBpZl9zdGFydCwgbm9kZXR5cGVzO1xuICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLmRlY29yYXRpb25zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKFwiQHN0cmlwLXBlcmlvZHNcIiA9PT0gdGhpcy5kZWNvcmF0aW9uc1tpXVswXSAmJiBcInRydWVcIiA9PT0gdGhpcy5kZWNvcmF0aW9uc1tpXVsxXSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5zdHJpcF9wZXJpb2RzICs9IDE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICBpZiAodGhpcy5kZWNvcmF0aW9ucyAmJiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuY3NsX3JldmVyc2VfbG9va3VwX3N1cHBvcnQgfHwgc3RhdGUuc3lzLmNzbF9yZXZlcnNlX2xvb2t1cF9zdXBwb3J0KSkge1xuICAgICAgICB0aGlzLmRlY29yYXRpb25zLnJldmVyc2UoKTtcbiAgICAgICAgdGhpcy5kZWNvcmF0aW9ucy5wdXNoKFtcIkBzaG93aWRcIixcInRydWVcIiwgdGhpcy5jc2xpZF0pO1xuICAgICAgICB0aGlzLmRlY29yYXRpb25zLnJldmVyc2UoKTtcbiAgICB9XG4gICAgbm9kZXR5cGVzID0gW1wibnVtYmVyXCIsIFwiZGF0ZVwiLCBcIm5hbWVzXCJdO1xuICAgIGlmICgoXCJ0ZXh0XCIgPT09IHRoaXMubmFtZSAmJiAhdGhpcy5wb3N0cG9uZWRfbWFjcm8pIHx8IG5vZGV0eXBlcy5pbmRleE9mKHRoaXMubmFtZSkgPiAtMSkge1xuICAgICAgICBlbGVtZW50X3RyYWNlID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLmVsZW1lbnRfdHJhY2UudmFsdWUoKSA9PT0gXCJhdXRob3JcIiB8fCBcIm5hbWVzXCIgPT09IHRoaXMubmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW1bXCJhdXRob3Itb25seVwiXSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZWxlbWVudF90cmFjZS5wdXNoKFwiZG8tbm90LXN1cHByZXNzLW1lXCIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbSAmJiBpdGVtW1wic3VwcHJlc3MtYXV0aG9yXCJdKSB7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtW1wiYXV0aG9yLW9ubHlcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmVsZW1lbnRfdHJhY2UucHVzaChcInN1cHByZXNzLW1lXCIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbSAmJiBpdGVtW1wic3VwcHJlc3MtYXV0aG9yXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5lbGVtZW50X3RyYWNlLnB1c2goXCJkby1ub3Qtc3VwcHJlc3MtbWVcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZWxlbWVudF90cmFjZSk7XG4gICAgfVxuICAgIGRpc3BsYXkgPSB0aGlzLnN0cmluZ3MuY2xzO1xuICAgIHRoaXMuc3RyaW5ncy5jbHMgPSBmYWxzZTtcbiAgICBpZiAoc3RhdGUuYnVpbGQucmVuZGVyX25lc3RpbmdfbGV2ZWwgPT09IDApIHtcbiAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmFyZWEgPT09IFwiYmlibGlvZ3JhcGh5XCIgJiYgc3RhdGUuYmlibGlvZ3JhcGh5Lm9wdFtcInNlY29uZC1maWVsZC1hbGlnblwiXSkge1xuICAgICAgICAgICAgYmliX2ZpcnN0ID0gbmV3IENTTC5Ub2tlbihcImdyb3VwXCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICBiaWJfZmlyc3QuZGVjb3JhdGlvbnMgPSBbW1wiQGRpc3BsYXlcIiwgXCJsZWZ0LW1hcmdpblwiXV07XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAucmVuZGVyX3NlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgYmliX2ZpcnN0LnN0cmluZ3MuZmlyc3RfYmxvYiA9IEl0ZW0uaWQ7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5zdGFydFRhZyhcImJpYl9maXJzdFwiLCBiaWJfZmlyc3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBiaWJfZmlyc3QuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIHRhcmdldC5wdXNoKGJpYl9maXJzdCk7XG4gICAgICAgIH0gZWxzZSBpZiAoQ1NMLkRJU1BMQVlfQ0xBU1NFUy5pbmRleE9mKGRpc3BsYXkpID4gLTEpIHtcbiAgICAgICAgICAgIGJpYl9maXJzdCA9IG5ldyBDU0wuVG9rZW4oXCJncm91cFwiLCBDU0wuU1RBUlQpO1xuICAgICAgICAgICAgYmliX2ZpcnN0LmRlY29yYXRpb25zID0gW1tcIkBkaXNwbGF5XCIsIGRpc3BsYXldXTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBiaWJfZmlyc3Quc3RyaW5ncy5maXJzdF9ibG9iID0gSXRlbS5pZDtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuc3RhcnRUYWcoXCJiaWJfZmlyc3RcIiwgYmliX2ZpcnN0KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBiaWJfZmlyc3QuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIHRhcmdldC5wdXNoKGJpYl9maXJzdCk7XG4gICAgICAgIH1cbiAgICAgICAgc3RhdGUuYnVpbGQuY2xzID0gZGlzcGxheTtcbiAgICB9XG4gICAgc3RhdGUuYnVpbGQucmVuZGVyX25lc3RpbmdfbGV2ZWwgKz0gMTtcbiAgICBpZiAoc3RhdGUuYnVpbGQuc3Vic3RpdHV0ZV9sZXZlbC52YWx1ZSgpID09PSAxKSB7XG4gICAgICAgIGNob29zZV9zdGFydCA9IG5ldyBDU0wuVG9rZW4oXCJjaG9vc2VcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgQ1NMLk5vZGUuY2hvb3NlLmJ1aWxkLmNhbGwoY2hvb3NlX3N0YXJ0LCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgaWZfc3RhcnQgPSBuZXcgQ1NMLlRva2VuKFwiaWZcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChJdGVtLGl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY2FuX3N1YnN0aXR1dGUudmFsdWUoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9O1xuICAgICAgICBpZl9zdGFydC50ZXN0cy5wdXNoKGZ1bmMpO1xuICAgICAgICBpZl9zdGFydC50ZXN0ID0gc3RhdGUuZnVuLm1hdGNoLmFueSh0aGlzLCBzdGF0ZSwgaWZfc3RhcnQudGVzdHMpO1xuICAgICAgICB0YXJnZXQucHVzaChpZl9zdGFydCk7XG4gICAgfVxuICAgIGlmIChzdGF0ZS5zeXMudmFyaWFibGVXcmFwcGVyXG4gICAgICAgICYmIHRoaXMudmFyaWFibGVzX3JlYWxcbiAgICAgICAgJiYgdGhpcy52YXJpYWJsZXNfcmVhbC5sZW5ndGgpIHtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAuanVzdF9sb29raW5nICYmICFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICB2YXIgdmFyaWFibGVfZW50cnkgPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU1RBUlQpO1xuICAgICAgICAgICAgICAgIHZhcmlhYmxlX2VudHJ5LmRlY29yYXRpb25zID0gW1tcIkBzaG93aWRcIiwgXCJ0cnVlXCJdXTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuc3RhcnRUYWcoXCJ2YXJpYWJsZV9lbnRyeVwiLCB2YXJpYWJsZV9lbnRyeSk7XG4gICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gbnVsbDtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IGl0ZW0ucG9zaXRpb247XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghcG9zaXRpb24pIHBvc2l0aW9uID0gMDtcbiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb25NYXAgPSBbXG4gICAgICAgICAgICAgICAgICAgIFwiZmlyc3RcIixcbiAgICAgICAgICAgICAgICAgICAgXCJzdWJzZXF1ZW50XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiaWJpZFwiLFxuICAgICAgICAgICAgICAgICAgICBcImliaWQtd2l0aC1sb2NhdG9yXCJcbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgdmFyIG5vdGVOdW1iZXIgPSAwO1xuICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW0ubm90ZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIG5vdGVOdW1iZXIgPSBpdGVtLm5vdGVJbmRleDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGZpcnN0UmVmZXJlbmNlTm90ZU51bWJlciA9IDA7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbVsnZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgZmlyc3RSZWZlcmVuY2VOb3RlTnVtYmVyID0gaXRlbVsnZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyJ107XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBjaXRhdGlvbk51bWJlciA9IDA7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbVsnY2l0YXRpb24tbnVtYmVyJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgY2l0YXRpb25OdW1iZXIgPSBpdGVtWydjaXRhdGlvbi1udW1iZXInXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtLmluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIGluZGV4ID0gaXRlbS5pbmRleDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgaXRlbURhdGE6IEl0ZW0sXG4gICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlTmFtZXM6IHRoaXMudmFyaWFibGVzLFxuICAgICAgICAgICAgICAgICAgICBjb250ZXh0OiBzdGF0ZS50bXAuYXJlYSxcbiAgICAgICAgICAgICAgICAgICAgeGNsYXNzOiBzdGF0ZS5vcHQueGNsYXNzLFxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogcG9zaXRpb25NYXBbcG9zaXRpb25dLFxuICAgICAgICAgICAgICAgICAgICBcIm5vdGUtbnVtYmVyXCI6IG5vdGVOdW1iZXIsXG4gICAgICAgICAgICAgICAgICAgIFwiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCI6IGZpcnN0UmVmZXJlbmNlTm90ZU51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgXCJjaXRhdGlvbi1udW1iZXJcIjogY2l0YXRpb25OdW1iZXIsXG4gICAgICAgICAgICAgICAgICAgIFwiaW5kZXhcIjogaW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIFwibW9kZVwiOiBzdGF0ZS5vcHQubW9kZVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5wYXJhbXMgPSBwYXJhbXM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgIH1cbn07XG5DU0wuVXRpbC5zdWJzdGl0dXRlRW5kID0gZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICB2YXIgZnVuYywgYmliX2ZpcnN0X2VuZCwgYmliX290aGVyLCBpZl9lbmQsIGNob29zZV9lbmQsIHRvcGxldmVsLCBoYXN2YWwsIGF1dGhvcl9zdWJzdGl0dXRlLCBzdHI7XG4gICAgaWYgKHN0YXRlLnN5cy52YXJpYWJsZVdyYXBwZXJcbiAgICAgICAgJiYgKHRoaXMuaGFzVmFyaWFibGUgfHwgKHRoaXMudmFyaWFibGVzX3JlYWwgJiYgdGhpcy52YXJpYWJsZXNfcmVhbC5sZW5ndGgpKSkge1xuICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLEl0ZW0pIHtcbiAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZyAmJiAhc3RhdGUudG1wLnN1cHByZXNzX2RlY29yYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmVuZFRhZyhcInZhcmlhYmxlX2VudHJ5XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICB9XG4gICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMuZGVjb3JhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBpZiAoXCJAc3RyaXAtcGVyaW9kc1wiID09PSB0aGlzLmRlY29yYXRpb25zW2ldWzBdICYmIFwidHJ1ZVwiID09PSB0aGlzLmRlY29yYXRpb25zW2ldWzFdKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLnN0cmlwX3BlcmlvZHMgKz0gLTE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICBzdGF0ZS5idWlsZC5yZW5kZXJfbmVzdGluZ19sZXZlbCArPSAtMTtcbiAgICBpZiAoc3RhdGUuYnVpbGQucmVuZGVyX25lc3RpbmdfbGV2ZWwgPT09IDApIHtcbiAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmNscykge1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5lbmRUYWcoXCJiaWJfZmlyc3RcIik7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuY2xzID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhdGUuYnVpbGQuYXJlYSA9PT0gXCJiaWJsaW9ncmFwaHlcIiAmJiBzdGF0ZS5iaWJsaW9ncmFwaHkub3B0W1wic2Vjb25kLWZpZWxkLWFsaWduXCJdKSB7XG4gICAgICAgICAgICBiaWJfZmlyc3RfZW5kID0gbmV3IENTTC5Ub2tlbihcImdyb3VwXCIsIENTTC5FTkQpO1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLnJlbmRlcl9zZWVuKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5lbmRUYWcoXCJiaWJfZmlyc3RcIik7IC8vIGNsb3NlcyBiaWJfZmlyc3RcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYmliX2ZpcnN0X2VuZC5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgdGFyZ2V0LnB1c2goYmliX2ZpcnN0X2VuZCk7XG4gICAgICAgICAgICBiaWJfb3RoZXIgPSBuZXcgQ1NMLlRva2VuKFwiZ3JvdXBcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgICAgIGJpYl9vdGhlci5kZWNvcmF0aW9ucyA9IFtbXCJAZGlzcGxheVwiLCBcInJpZ2h0LWlubGluZVwiXV07XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAucmVuZGVyX3NlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLnJlbmRlcl9zZWVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LnN0YXJ0VGFnKFwiYmliX290aGVyXCIsIGJpYl9vdGhlcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJpYl9vdGhlci5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgdGFyZ2V0LnB1c2goYmliX290aGVyKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoc3RhdGUuYnVpbGQuc3Vic3RpdHV0ZV9sZXZlbC52YWx1ZSgpID09PSAxKSB7XG4gICAgICAgIGlmX2VuZCA9IG5ldyBDU0wuVG9rZW4oXCJpZlwiLCBDU0wuRU5EKTtcbiAgICAgICAgdGFyZ2V0LnB1c2goaWZfZW5kKTtcbiAgICAgICAgY2hvb3NlX2VuZCA9IG5ldyBDU0wuVG9rZW4oXCJjaG9vc2VcIiwgQ1NMLkVORCk7XG4gICAgICAgIENTTC5Ob2RlLmNob29zZS5idWlsZC5jYWxsKGNob29zZV9lbmQsIHN0YXRlLCB0YXJnZXQpO1xuICAgIH1cbiAgICBpZiAoXCJuYW1lc1wiID09PSB0aGlzLm5hbWUgfHwgKFwidGV4dFwiID09PSB0aGlzLm5hbWUgJiYgdGhpcy52YXJpYWJsZXNfcmVhbCAhPT0gXCJ0aXRsZVwiKSkge1xuICAgICAgICBhdXRob3Jfc3Vic3RpdHV0ZSA9IG5ldyBDU0wuVG9rZW4oXCJ0ZXh0XCIsIENTTC5TSU5HTEVUT04pO1xuICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLmFyZWEgIT09IFwiYmlibGlvZ3JhcGh5XCIpIHJldHVybjtcbiAgICAgICAgICAgIGlmIChcInN0cmluZ1wiICE9PSB0eXBlb2Ygc3RhdGUuYmlibGlvZ3JhcGh5Lm9wdFtcInN1YnNlcXVlbnQtYXV0aG9yLXN1YnN0aXR1dGVcIl0pIHJldHVybjtcbiAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlc19yZWFsICYmICFJdGVtW3RoaXMudmFyaWFibGVzX3JlYWxdKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLnN1YnN0aXR1dGVkX3ZhcmlhYmxlICE9PSB0aGlzLnZhcmlhYmxlc19yZWFsKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHN1YnJ1bGUgPSBzdGF0ZS5iaWJsaW9ncmFwaHkub3B0W1wic3Vic2VxdWVudC1hdXRob3Itc3Vic3RpdHV0ZS1ydWxlXCJdO1xuICAgICAgICAgICAgdmFyIGksIGlsZW47XG4gICAgICAgICAgICB2YXIgcHJpbnRpbmcgPSAhc3RhdGUudG1wLnN1cHByZXNzX2RlY29yYXRpb25zO1xuICAgICAgICAgICAgaWYgKHByaW50aW5nICYmIHN0YXRlLnRtcC5zdWJzZXF1ZW50X2F1dGhvcl9zdWJzdGl0dXRlX29rKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5yZW5kZXJlZF9uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcInBhcnRpYWwtZWFjaFwiID09PSBzdWJydWxlIHx8IFwicGFydGlhbC1maXJzdFwiID09PSBzdWJydWxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZG9zdWIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVkX25hbWUgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBzdGF0ZS50bXAubmFtZV9ub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gc3RhdGUudG1wLnJlbmRlcmVkX25hbWVbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRvc3ViXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIHN0YXRlLnRtcC5sYXN0X3JlbmRlcmVkX25hbWUgJiYgc3RhdGUudG1wLmxhc3RfcmVuZGVyZWRfbmFtZS5sZW5ndGggPiAoaSAtIDEpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIG5hbWUgJiYgIW5hbWUubG9jYWxlQ29tcGFyZShzdGF0ZS50bXAubGFzdF9yZW5kZXJlZF9uYW1lW2ldKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBuZXcgQ1NMLkJsb2Ioc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdFtcInN1YnNlcXVlbnQtYXV0aG9yLXN1YnN0aXR1dGVcIl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAubmFtZV9ub2RlLmNoaWxkcmVuW2ldLmJsb2JzID0gW3N0cl07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcInBhcnRpYWwtZmlyc3RcIiA9PT0gc3VicnVsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9zdWIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvc3ViID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkX25hbWUucHVzaChuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5sYXN0X3JlbmRlcmVkX25hbWUgPSByZW5kZXJlZF9uYW1lO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwiY29tcGxldGUtZWFjaFwiID09PSBzdWJydWxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRfbmFtZSA9IHN0YXRlLnRtcC5yZW5kZXJlZF9uYW1lLmpvaW4oXCIsXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkX25hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmxhc3RfcmVuZGVyZWRfbmFtZSAmJiAhcmVuZGVyZWRfbmFtZS5sb2NhbGVDb21wYXJlKHN0YXRlLnRtcC5sYXN0X3JlbmRlcmVkX25hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBzdGF0ZS50bXAubmFtZV9ub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gbmV3IENTTC5CbG9iKHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHRbXCJzdWJzZXF1ZW50LWF1dGhvci1zdWJzdGl0dXRlXCJdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5uYW1lX25vZGUuY2hpbGRyZW5baV0uYmxvYnMgPSBbc3RyXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAubGFzdF9yZW5kZXJlZF9uYW1lID0gcmVuZGVyZWRfbmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZF9uYW1lID0gc3RhdGUudG1wLnJlbmRlcmVkX25hbWUuam9pbihcIixcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVyZWRfbmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAubGFzdF9yZW5kZXJlZF9uYW1lICYmICFyZW5kZXJlZF9uYW1lLmxvY2FsZUNvbXBhcmUoc3RhdGUudG1wLmxhc3RfcmVuZGVyZWRfbmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gbmV3IENTTC5CbG9iKHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHRbXCJzdWJzZXF1ZW50LWF1dGhvci1zdWJzdGl0dXRlXCJdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5sYWJlbF9ibG9iKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAubmFtZV9ub2RlLnRvcC5ibG9icyA9IFtzdHIsc3RhdGUudG1wLmxhYmVsX2Jsb2JdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnRtcC5uYW1lX25vZGUudG9wLmJsb2JzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLm5hbWVfbm9kZS50b3AuYmxvYnNbMF0uYmxvYnMgPSBbc3RyXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5uYW1lX25vZGUudG9wLmJsb2JzID0gW3N0cl07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLnN1YnN0aXR1dGVkX3ZhcmlhYmxlID0gdGhpcy52YXJpYWJsZXNfcmVhbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmxhc3RfcmVuZGVyZWRfbmFtZSA9IHJlbmRlcmVkX25hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLnN1YnNlcXVlbnRfYXV0aG9yX3N1YnN0aXR1dGVfb2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICB9XG4gICAgaWYgKChcInRleHRcIiA9PT0gdGhpcy5uYW1lICYmICF0aGlzLnBvc3Rwb25lZF9tYWNybykgfHwgW1wibnVtYmVyXCIsIFwiZGF0ZVwiLCBcIm5hbWVzXCJdLmluZGV4T2YodGhpcy5uYW1lKSA+IC0xKSB7XG4gICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgIHN0YXRlLnRtcC5lbGVtZW50X3RyYWNlLnBvcCgpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlV0aWwucGFkZGluZyA9IGZ1bmN0aW9uIChudW0pIHtcbiAgICB2YXIgbSA9IG51bS5tYXRjaCgvXFxzKigtezAsMX1bMC05XSspLyk7XG4gICAgaWYgKG0pIHtcbiAgICAgICAgbnVtID0gcGFyc2VJbnQobVsxXSwgMTApO1xuICAgICAgICBpZiAobnVtIDwgMCkge1xuICAgICAgICAgICAgbnVtID0gOTk5OTk5OTk5OTk5OTk5OTk5OTkgKyBudW07XG4gICAgICAgIH1cbiAgICAgICAgbnVtID0gXCJcIiArIG51bTtcbiAgICAgICAgd2hpbGUgKG51bS5sZW5ndGggPCAyMCkge1xuICAgICAgICAgICAgbnVtID0gXCIwXCIgKyBudW07XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bTtcbn07XG5DU0wuVXRpbC5Mb25nT3JkaW5hbGl6ZXIgPSBmdW5jdGlvbiAoKSB7fTtcbkNTTC5VdGlsLkxvbmdPcmRpbmFsaXplci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbn07XG5DU0wuVXRpbC5Mb25nT3JkaW5hbGl6ZXIucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uIChudW0sIGdlbmRlcikge1xuICAgIGlmIChudW0gPCAxMCkge1xuICAgICAgICBudW0gPSBcIjBcIiArIG51bTtcbiAgICB9XG4gICAgdmFyIHJldCA9IENTTC5FbmdpbmUuZ2V0RmllbGQoXG4gICAgICAgIENTTC5MT09TRSwgXG4gICAgICAgIHRoaXMuc3RhdGUubG9jYWxlW3RoaXMuc3RhdGUub3B0LmxhbmddLnRlcm1zLFxuICAgICAgICBcImxvbmctb3JkaW5hbC1cIiArIG51bSxcbiAgICAgICAgXCJsb25nXCIsIFxuICAgICAgICAwLCBcbiAgICAgICAgZ2VuZGVyXG4gICAgKTtcbiAgICBpZiAoIXJldCkge1xuICAgICAgICByZXQgPSB0aGlzLnN0YXRlLmZ1bi5vcmRpbmFsaXplci5mb3JtYXQobnVtLCBnZW5kZXIpO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlLnRtcC5jaXRlX3JlbmRlcnNfY29udGVudCA9IHRydWU7XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuVXRpbC5PcmRpbmFsaXplciA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICB0aGlzLnN1ZmZpeGVzID0ge307XG59O1xuQ1NMLlV0aWwuT3JkaW5hbGl6ZXIucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCF0aGlzLnN1ZmZpeGVzW3RoaXMuc3RhdGUub3B0LmxhbmddKSB7XG4gICAgICAgIHRoaXMuc3VmZml4ZXNbdGhpcy5zdGF0ZS5vcHQubGFuZ10gPSB7fTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSAzOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICB2YXIgZ2VuZGVyID0gW3VuZGVmaW5lZCwgXCJtYXNjdWxpbmVcIiwgXCJmZW1pbmluZVwiXVtpXTtcbiAgICAgICAgICAgIHRoaXMuc3VmZml4ZXNbdGhpcy5zdGF0ZS5vcHQubGFuZ11bZ2VuZGVyXSA9IFtdO1xuICAgICAgICAgICAgZm9yICh2YXIgaiA9IDE7IGogPCA1OyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICB2YXIgb3JkaW5hbCA9IHRoaXMuc3RhdGUuZ2V0VGVybShcIm9yZGluYWwtMFwiICsgaiwgXCJsb25nXCIsIGZhbHNlLCBnZW5kZXIpO1xuICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygb3JkaW5hbCkge1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zdWZmaXhlc1t0aGlzLnN0YXRlLm9wdC5sYW5nXVtnZW5kZXJdO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5zdWZmaXhlc1t0aGlzLnN0YXRlLm9wdC5sYW5nXVtnZW5kZXJdLnB1c2gob3JkaW5hbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLlV0aWwuT3JkaW5hbGl6ZXIucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uIChudW0sIGdlbmRlcikge1xuICAgIHZhciBzdHI7XG4gICAgbnVtID0gcGFyc2VJbnQobnVtLCAxMCk7XG4gICAgc3RyID0gXCJcIiArIG51bTtcbiAgICB2YXIgc3VmZml4ID0gXCJcIjtcbiAgICB2YXIgdHJ5Z2VuZGVycyA9IFtdO1xuICAgIGlmIChnZW5kZXIpIHtcbiAgICAgICAgdHJ5Z2VuZGVycy5wdXNoKGdlbmRlcik7XG4gICAgfVxuICAgIHRyeWdlbmRlcnMucHVzaChcIm5ldXRlclwiKTtcbiAgICBpZiAodGhpcy5zdGF0ZS5sb2NhbGVbdGhpcy5zdGF0ZS5vcHQubGFuZ10ub3JkW1wiMS4wLjFcIl0pIHtcbiAgICAgICAgc3VmZml4ID0gdGhpcy5zdGF0ZS5nZXRUZXJtKFwib3JkaW5hbFwiLGZhbHNlLDAsZ2VuZGVyKTtcbiAgICAgICAgdmFyIHRyeWdlbmRlcjtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0cnlnZW5kZXJzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgdHJ5Z2VuZGVyID0gdHJ5Z2VuZGVyc1tpXTtcbiAgICAgICAgICAgIHZhciBvcmRpbmZvID0gdGhpcy5zdGF0ZS5sb2NhbGVbdGhpcy5zdGF0ZS5vcHQubGFuZ10ub3JkW1wiMS4wLjFcIl07XG4gICAgICAgICAgICBpZiAob3JkaW5mb1tcIndob2xlLW51bWJlclwiXVtzdHJdICYmIG9yZGluZm9bXCJ3aG9sZS1udW1iZXJcIl1bc3RyXVt0cnlnZW5kZXJdKSB7XG4gICAgICAgICAgICAgICAgc3VmZml4ID0gdGhpcy5zdGF0ZS5nZXRUZXJtKHRoaXMuc3RhdGUubG9jYWxlW3RoaXMuc3RhdGUub3B0LmxhbmddLm9yZFtcIjEuMC4xXCJdW1wid2hvbGUtbnVtYmVyXCJdW3N0cl1bdHJ5Z2VuZGVyXSxmYWxzZSwwLGdlbmRlcik7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG9yZGluZm9bXCJsYXN0LXR3by1kaWdpdHNcIl1bc3RyLnNsaWNlKHN0ci5sZW5ndGggLSAyKV0gJiYgb3JkaW5mb1tcImxhc3QtdHdvLWRpZ2l0c1wiXVtzdHIuc2xpY2Uoc3RyLmxlbmd0aCAtIDIpXVt0cnlnZW5kZXJdKSB7XG4gICAgICAgICAgICAgICAgc3VmZml4ID0gdGhpcy5zdGF0ZS5nZXRUZXJtKHRoaXMuc3RhdGUubG9jYWxlW3RoaXMuc3RhdGUub3B0LmxhbmddLm9yZFtcIjEuMC4xXCJdW1wibGFzdC10d28tZGlnaXRzXCJdW3N0ci5zbGljZShzdHIubGVuZ3RoIC0gMildW3RyeWdlbmRlcl0sZmFsc2UsMCxnZW5kZXIpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChvcmRpbmZvW1wibGFzdC1kaWdpdFwiXVtzdHIuc2xpY2Uoc3RyLmxlbmd0aCAtIDEpXSAmJiBvcmRpbmZvW1wibGFzdC1kaWdpdFwiXVtzdHIuc2xpY2Uoc3RyLmxlbmd0aCAtIDEpXVt0cnlnZW5kZXJdKSB7XG4gICAgICAgICAgICAgICAgc3VmZml4ID0gdGhpcy5zdGF0ZS5nZXRUZXJtKHRoaXMuc3RhdGUubG9jYWxlW3RoaXMuc3RhdGUub3B0LmxhbmddLm9yZFtcIjEuMC4xXCJdW1wibGFzdC1kaWdpdFwiXVtzdHIuc2xpY2Uoc3RyLmxlbmd0aCAtIDEpXVt0cnlnZW5kZXJdLGZhbHNlLDAsZ2VuZGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdWZmaXgpIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghZ2VuZGVyKSB7XG4gICAgICAgICAgICBnZW5kZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zdGF0ZS5mdW4ub3JkaW5hbGl6ZXIuaW5pdCgpO1xuICAgICAgICBpZiAoKG51bSAvIDEwKSAlIDEwID09PSAxIHx8IChudW0gPiAxMCAmJiBudW0gPCAyMCkpIHtcbiAgICAgICAgICAgIHN1ZmZpeCA9IHRoaXMuc3VmZml4ZXNbdGhpcy5zdGF0ZS5vcHQubGFuZ11bZ2VuZGVyXVszXTtcbiAgICAgICAgfSBlbHNlIGlmIChudW0gJSAxMCA9PT0gMSAmJiBudW0gJSAxMDAgIT09IDExKSB7XG4gICAgICAgICAgICBzdWZmaXggPSB0aGlzLnN1ZmZpeGVzW3RoaXMuc3RhdGUub3B0LmxhbmddW2dlbmRlcl1bMF07XG4gICAgICAgIH0gZWxzZSBpZiAobnVtICUgMTAgPT09IDIgJiYgbnVtICUgMTAwICE9PSAxMikge1xuICAgICAgICAgICAgc3VmZml4ID0gdGhpcy5zdWZmaXhlc1t0aGlzLnN0YXRlLm9wdC5sYW5nXVtnZW5kZXJdWzFdO1xuICAgICAgICB9IGVsc2UgaWYgKG51bSAlIDEwID09PSAzICYmIG51bSAlIDEwMCAhPT0gMTMpIHtcbiAgICAgICAgICAgIHN1ZmZpeCA9IHRoaXMuc3VmZml4ZXNbdGhpcy5zdGF0ZS5vcHQubGFuZ11bZ2VuZGVyXVsyXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1ZmZpeCA9IHRoaXMuc3VmZml4ZXNbdGhpcy5zdGF0ZS5vcHQubGFuZ11bZ2VuZGVyXVszXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBzdHIgPSBzdHIgKz0gc3VmZml4O1xuICAgIHJldHVybiBzdHI7XG59O1xuQ1NMLlV0aWwuUm9tYW5pemVyID0gZnVuY3Rpb24gKCkge307XG5DU0wuVXRpbC5Sb21hbml6ZXIucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uIChudW0pIHtcbiAgICB2YXIgcmV0LCBwb3MsIG4sIG51bXN0ciwgbGVuO1xuICAgIHJldCA9IFwiXCI7XG4gICAgaWYgKG51bSA8IDYwMDApIHtcbiAgICAgICAgbnVtc3RyID0gbnVtLnRvU3RyaW5nKCkuc3BsaXQoXCJcIik7XG4gICAgICAgIG51bXN0ci5yZXZlcnNlKCk7XG4gICAgICAgIHBvcyA9IDA7XG4gICAgICAgIG4gPSAwO1xuICAgICAgICBsZW4gPSBudW1zdHIubGVuZ3RoO1xuICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIG4gPSBwYXJzZUludChudW1zdHJbcG9zXSwgMTApO1xuICAgICAgICAgICAgcmV0ID0gQ1NMLlJPTUFOX05VTUVSQUxTW3Bvc11bbl0gKyByZXQ7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuVXRpbC5TdWZmaXhhdG9yID0gZnVuY3Rpb24gKHNsaXN0KSB7XG4gICAgaWYgKCFzbGlzdCkge1xuICAgICAgICBzbGlzdCA9IENTTC5TVUZGSVhfQ0hBUlM7XG4gICAgfVxuICAgIHRoaXMuc2xpc3QgPSBzbGlzdC5zcGxpdChcIixcIik7XG59O1xuQ1NMLlV0aWwuU3VmZml4YXRvci5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24gKE4pIHtcbiAgICB2YXIgWDtcbiAgICBOICs9IDE7XG4gICAgdmFyIGtleSA9IFwiXCI7XG4gICAgZG8ge1xuICAgICAgICBYID0gKChOICUgMjYpID09PSAwKSA/IDI2IDogKE4gJSAyNik7XG4gICAgICAgIHZhciBrZXkgPSB0aGlzLnNsaXN0W1gtMV0gKyBrZXk7XG4gICAgICAgIE4gPSAoTiAtIFgpIC8gMjY7XG4gICAgfSB3aGlsZSAoIE4gIT09IDAgKTtcbiAgICByZXR1cm4ga2V5O1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnByb2Nlc3NOdW1iZXIgPSBmdW5jdGlvbiAobm9kZSwgSXRlbU9iamVjdCwgdmFyaWFibGUsIHR5cGUpIHtcbiAgICB2YXIgdmFsLCBtLCBpLCBpbGVuLCBqLCBqbGVuO1xuICAgIHZhciBkZWJ1ZyA9IGZhbHNlO1xuICAgIHZhciBtZSA9IHRoaXM7XG4gICAgZnVuY3Rpb24gbm9ybWFsaXplRmllbGRWYWx1ZShzdHIsIGRlZmF1bHRMYWJlbCkge1xuICAgICAgICBzdHIgPSBzdHIudHJpbSgpO1xuICAgICAgICB2YXIgbSA9IHN0ci5tYXRjaCgvXihbXiBdKykvKTtcbiAgICAgICAgaWYgKG0gJiYgIUNTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTW21bMV1dKSB7XG4gICAgICAgICAgICB2YXIgZW1iZWRkZWRMYWJlbCA9IG51bGw7XG4gICAgICAgICAgICBpZiAodmFyaWFibGUgPT09IFwibG9jYXRvclwiICkge1xuICAgICAgICAgICAgICAgIGlmIChJdGVtT2JqZWN0LmxhYmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGVtYmVkZGVkTGFiZWwgPSBDU0wuU1RBVFVURV9TVUJESVZfU1RSSU5HU19SRVZFUlNFW0l0ZW1PYmplY3QubGFiZWxdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGVtYmVkZGVkTGFiZWwgPSBcInAuXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBlbWJlZGRlZExhYmVsID0gQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1NfUkVWRVJTRVt2YXJpYWJsZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZW1iZWRkZWRMYWJlbCkge1xuICAgICAgICAgICAgICAgIHN0ciA9IGVtYmVkZGVkTGFiZWwgKyBcIiBcIiArIHN0cjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RyO1xuICAgIH1cbiAgICBmdW5jdGlvbiBjb21wb3NlTnVtYmVySW5mbyhvcmlnTGFiZWwsIGxhYmVsLCB2YWwsIGpvaW5pbmdTdWZmaXgpIHtcbiAgICAgICAgam9pbmluZ1N1ZmZpeCA9IGpvaW5pbmdTdWZmaXggPyBqb2luaW5nU3VmZml4IDogXCJcIjtcbiAgICAgICAgdmFyIGluZm8gPSB7fTtcbiAgICAgICAgaWYgKCFsYWJlbCAmJiAhQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1NfUkVWRVJTRVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICBsYWJlbCA9IFwidmFyOlwiK3ZhcmlhYmxlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsYWJlbCkge1xuICAgICAgICAgICAgdmFyIG0gPSBsYWJlbC5tYXRjaCgvKFxccyopKFteXFxzXSspKFxccyopLyk7XG4gICAgICAgICAgICBpbmZvLmxhYmVsID0gbVsyXTtcbiAgICAgICAgICAgIGluZm8ub3JpZ0xhYmVsID0gb3JpZ0xhYmVsO1xuICAgICAgICAgICAgaW5mby5sYWJlbFN1ZmZpeCA9IG1bM10gPyBtWzNdIDogXCJcIjtcbiAgICAgICAgICAgIGluZm8ucGx1cmFsID0gMDtcbiAgICAgICAgICAgIGluZm8ubGFiZWxWaXNpYmlsaXR5ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG0gPSB2YWwubWF0Y2goL14oWzAtOV0qW2EtekEtWl0rMCopPyhbMC05XSsoPzpbYS16QS1aXSp8Wy0sYS16QS1aXSspKSQvKTtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgIGluZm8ucGFydGljbGUgPSBtWzFdID8gbVsxXSA6IFwiXCI7XG4gICAgICAgICAgICBpbmZvLnZhbHVlID0gbVsyXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGluZm8ucGFydGljbGUgPSBcIlwiO1xuICAgICAgICAgICAgaW5mby52YWx1ZSA9IHZhbDtcbiAgICAgICAgfVxuICAgICAgICBpbmZvLmpvaW5pbmdTdWZmaXggPSBqb2luaW5nU3VmZml4LnJlcGxhY2UoL1xccyotXFxzKi8sIFwiLVwiKTtcbiAgICAgICAgcmV0dXJuIGluZm87XG4gICAgfTtcbiAgICBmdW5jdGlvbiBmaXh1cFN1YnNlY3Rpb25zKGVsZW1zKSB7XG4gICAgICAgIGZvciAodmFyIGk9ZWxlbXMubGVuZ3RoLTI7aT4tMTtpLT0yKSB7XG4gICAgICAgICAgICBpZiAoZWxlbXNbaV0gPT09IFwiLVwiXG4gICAgICAgICAgICAgICAmJiBlbGVtc1tpLTFdLm1hdGNoKC9eKD86KD86W2Etel18W2Etel1bYS16XXxbYS16XVthLXpdW2Etel18W2Etel1bYS16XVthLXpdW2Etel0pXFwuICAqKSpbMC05XStbLGEtekEtWl0rJC8pXG4gICAgICAgICAgICAgICAmJiBlbGVtc1tpKzFdLm1hdGNoKC9eWyxhLXpBLVpdKyQvKSkge1xuICAgICAgICAgICAgICAgIGVsZW1zW2ktMV0gPSBlbGVtcy5zbGljZShpLTEsaSsyKS5qb2luKFwiXCIpO1xuICAgICAgICAgICAgICAgIGVsZW1zID0gZWxlbXMuc2xpY2UoMCxpKS5jb25jYXQoZWxlbXMuc2xpY2UoaSsyKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVsZW1zO1xuICAgIH1cbiAgICBmdW5jdGlvbiBwYXJzZVN0cmluZyhzdHIsIGRlZmF1bHRMYWJlbCkge1xuICAgICAgICBkZWZhdWx0TGFiZWwgPSBkZWZhdWx0TGFiZWwgPyBkZWZhdWx0TGFiZWwgOiBcIlwiO1xuICAgICAgICBzdHIgPSBub3JtYWxpemVGaWVsZFZhbHVlKHN0ciwgZGVmYXVsdExhYmVsKTtcbiAgICAgICAgdmFyIGVsZW1zID0gW107XG4gICAgICAgIHZhciBtID0gc3RyLm1hdGNoKC8oO1xccyt8LFxccyt8XFxzKlxcXFwqW1xcLVxcdTIwMTNdK1xccyp8XFxzKiZcXHMqKS9nKTtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgIHZhciBsc3QgPSBzdHIuc3BsaXQoLyg/OjtcXHMrfCxcXHMrfFxccypcXFxcKltcXC1cXHUyMDEzXStcXHMqfFxccyomXFxzKikvKTtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWxzdC5sZW5ndGgtMTsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICBlbGVtcy5wdXNoKGxzdFtpXSk7XG4gICAgICAgICAgICAgICAgZWxlbXMucHVzaChtW2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsZW1zLnB1c2gobHN0W2xzdC5sZW5ndGgtMV0pO1xuICAgICAgICAgICAgZWxlbXMgPSBmaXh1cFN1YnNlY3Rpb25zKGVsZW1zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBlbGVtcyA9IFtzdHJdO1xuICAgICAgICB9XG4gICAgICAgIHZhciB2YWx1ZXMgPSBbXTtcbiAgICAgICAgdmFyIGxhYmVsID0gZGVmYXVsdExhYmVsO1xuICAgICAgICB2YXIgb3JpZ0xhYmVsID0gXCJcIjtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49ZWxlbXMubGVuZ3RoO2k8aWxlbjtpICs9IDIpIHtcbiAgICAgICAgICAgIHZhciBtID0gZWxlbXNbaV0ubWF0Y2goLygoPzpefCApKD86W2Etel18W2Etel1bYS16XXxbYS16XVthLXpdW2Etel18W2Etel1bYS16XVthLXpdW2Etel0pKD86XFwufCApICopL2cpO1xuICAgICAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgICAgICB2YXIgbHN0ID0gZWxlbXNbaV0uc3BsaXQoLyg/Oig/Ol58ICkoPzpbYS16XXxbYS16XVthLXpdfFthLXpdW2Etel1bYS16XXxbYS16XVthLXpdW2Etel1bYS16XSkoPzpcXC58ICkgKikvKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqPWxzdC5sZW5ndGgtMTtqPjA7ai0tKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsc3Rbai0xXSAmJiAoIWxzdFtqXS5tYXRjaCgvXlswLTldKyhbLTssOmEtekEtWl0qKSQvKSB8fCAhbHN0W2otMV0ubWF0Y2goL15bMC05XSsoWy07LDphLXpBLVpdKikkLykpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsc3Rbai0xXSA9IGxzdFtqLTFdICsgbVtqLTFdICsgbHN0W2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgbHN0ID0gbHN0LnNsaWNlKDAsaikuY29uY2F0KGxzdC5zbGljZShqKzEpKVxuICAgICAgICAgICAgICAgICAgICAgICAgbSA9IG0uc2xpY2UoMCxqLTEpLmNvbmNhdChtLnNsaWNlKGopKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChtLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNsdWcgPSBtWzBdLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5vdEFsYWJlbCA9ICFDU0wuU1RBVFVURV9TVUJESVZfU1RSSU5HU1tzbHVnXVxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgIW1lLmdldFRlcm0oQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1Nbc2x1Z10pXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCAoW1wibG9jYXRvclwiLCBcIm51bWJlclwiXS5pbmRleE9mKHZhcmlhYmxlKSA9PT0gLTEgJiYgQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1Nbc2x1Z10gIT09IHZhcmlhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vdEFsYWJlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtID0gbS5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsc3RbMF0gPSBsc3RbMF0gKyBcIiBcIiArIHNsdWcgKyBcIiBcIiArIGxzdFsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCwxKS5jb25jYXQobHN0LnNsaWNlKDIpKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ0xhYmVsID0gc2x1ZztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqPTAsamxlbj1sc3QubGVuZ3RoOyBqPGpsZW47IGorKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAobHN0W2pdIHx8IGogPT09IChsc3QubGVuZ3RoLTEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmlsdGVyZWRPcmlnTGFiZWw7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IG1bai0xXSA/IG1bai0xXSA6IGxhYmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9yaWdMYWJlbCA9PT0gbGFiZWwudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWRPcmlnTGFiZWwgPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJlZE9yaWdMYWJlbCA9IG9yaWdMYWJlbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHIgPSBsc3Rbal0gPyBsc3Rbal0udHJpbSgpIDogXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID09PSAobHN0Lmxlbmd0aC0xKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKGNvbXBvc2VOdW1iZXJJbmZvKGZpbHRlcmVkT3JpZ0xhYmVsLCBsYWJlbCwgc3RyLCBlbGVtc1tpKzFdKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKGNvbXBvc2VOdW1iZXJJbmZvKGZpbHRlcmVkT3JpZ0xhYmVsLCBsYWJlbCwgc3RyKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBmaWx0ZXJlZE9yaWdMYWJlbDtcbiAgICAgICAgICAgICAgICBpZiAob3JpZ0xhYmVsID09PSBsYWJlbC50cmltKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWRPcmlnTGFiZWwgPSBcIlwiO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkT3JpZ0xhYmVsID0gb3JpZ0xhYmVsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaChjb21wb3NlTnVtYmVySW5mbyhmaWx0ZXJlZE9yaWdMYWJlbCwgbGFiZWwsIGVsZW1zW2ldLCBlbGVtc1tpKzFdKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlcztcbiAgICB9XG4gICAgZnVuY3Rpb24gc2V0U3BhY2VzKHZhbHVlcykge1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj12YWx1ZXMubGVuZ3RoLTE7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgaWYgKCF2YWx1ZXNbaV0uam9pbmluZ1N1ZmZpeCAmJiB2YWx1ZXNbaSsxXS5sYWJlbCkge1xuICAgICAgICAgICAgICAgIHZhbHVlc1tpXS5qb2luaW5nU3VmZml4ID0gXCIgXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gZml4TnVtZXJpY0FuZENvdW50KHZhbHVlcywgaSwgY3VycmVudExhYmVsSW5mbykge1xuICAgICAgICB2YXIgbWFzdGVyID0gdmFsdWVzW2N1cnJlbnRMYWJlbEluZm8ucG9zXTtcbiAgICAgICAgdmFyIHZhbCA9IHZhbHVlc1tpXS52YWx1ZTtcbiAgICAgICAgdmFyIGlzRXNjYXBlZEh5cGhlbiA9IG1hc3Rlci5qb2luaW5nU3VmZml4ID09PSBcIlxcXFwtXCI7XG4gICAgICAgIGlmICh2YWwucGFydGljbGUgJiYgdmFsLnBhcnRpY2xlICE9PSBtYXN0ZXIucGFydGljbGUpIHtcbiAgICAgICAgICAgIGN1cnJlbnRMYWJlbEluZm8uY29sbGFwc2libGUgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbVZhbCA9IHZhbC5tYXRjaCgvXlswLTldKyhbLSw6YS16QS1aXSopJC8pO1xuICAgICAgICB2YXIgbUN1cnJlbnRMYWJlbCA9IG1hc3Rlci52YWx1ZS5tYXRjaCgvXlswLTldKyhbLSw6YS16QS1aXSopJC8pO1xuICAgICAgICBpZiAoIXZhbCB8fCAhbVZhbCB8fCAhbUN1cnJlbnRMYWJlbCB8fCBpc0VzY2FwZWRIeXBoZW4pIHtcbiAgICAgICAgICAgIGN1cnJlbnRMYWJlbEluZm8uY29sbGFwc2libGUgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmICghdmFsIHx8ICFtQ3VycmVudExhYmVsKSB7XG4gICAgICAgICAgICAgICAgY3VycmVudExhYmVsSW5mby5udW1lcmljID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXNFc2NhcGVkSHlwaGVuKSB7XG4gICAgICAgICAgICAgICAgY3VycmVudExhYmVsSW5mby5jb3VudC0tO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICgobVZhbCAmJiBtVmFsWzFdKSB8fCAobUN1cnJlbnRMYWJlbCAmJiBtQ3VycmVudExhYmVsWzFdKSkge1xuICAgICAgICAgICAgY3VycmVudExhYmVsSW5mby5jb2xsYXBzaWJsZSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh1bmRlZmluZWQgPT09IHZhbHVlc1tpXS5jb2xsYXBzaWJsZSkge1xuICAgICAgICAgICAgZm9yICh2YXIgaj1pLGpsZW49aStjdXJyZW50TGFiZWxJbmZvLmNvdW50O2o8amxlbjtqKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoaXNOYU4ocGFyc2VJbnQodmFsdWVzW2pdLnZhbHVlKSkgJiYgIXZhbHVlc1tqXS52YWx1ZS5tYXRjaCgvXltpdnhsY21JVlhMQ01dKyQvKSkge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbal0uY29sbGFwc2libGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbal0uY29sbGFwc2libGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGN1cnJlbnRMYWJlbEluZm8uY29sbGFwc2libGUgPSB2YWx1ZXNbaV0uY29sbGFwc2libGU7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGlzQ29sbGFwc2libGUgPSBjdXJyZW50TGFiZWxJbmZvLmNvbGxhcHNpYmxlO1xuICAgICAgICBmb3IgKHZhciBqPWN1cnJlbnRMYWJlbEluZm8ucG9zLGpsZW49KGN1cnJlbnRMYWJlbEluZm8ucG9zICsgY3VycmVudExhYmVsSW5mby5jb3VudCk7IGo8amxlbjsgaisrKSB7XG4gICAgICAgICAgICBpZiAoY3VycmVudExhYmVsSW5mby5jb3VudCA+IDEgJiYgaXNDb2xsYXBzaWJsZSkge1xuICAgICAgICAgICAgICAgIHZhbHVlc1tqXS5wbHVyYWwgPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFsdWVzW2pdLm51bWVyaWMgPSBjdXJyZW50TGFiZWxJbmZvLm51bWVyaWM7XG4gICAgICAgICAgICB2YWx1ZXNbal0uY29sbGFwc2libGUgPSBjdXJyZW50TGFiZWxJbmZvLmNvbGxhcHNpYmxlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIGZpeExhYmVsVmlzaWJpbGl0eSh2YWx1ZXMsIGdyb3VwU3RhcnRQb3MsIGN1cnJlbnRMYWJlbEluZm8pIHtcbiAgICAgICAgaWYgKGN1cnJlbnRMYWJlbEluZm8ubGFiZWwuc2xpY2UoMCwgNCkgIT09IFwidmFyOlwiKSB7XG4gICAgICAgICAgICBpZiAoY3VycmVudExhYmVsSW5mby5wb3MgPT09IDApIHtcbiAgICAgICAgICAgICAgICBpZiAodmFyaWFibGUgPT09IFwibG9jYXRvclwiIHx8IHZhcmlhYmxlID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghbWUuZ2V0VGVybShDU0wuU1RBVFVURV9TVUJESVZfU1RSSU5HU1tjdXJyZW50TGFiZWxJbmZvLmxhYmVsXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc1tjdXJyZW50TGFiZWxJbmZvLnBvc10ubGFiZWxWaXNpYmlsaXR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoW1wibG9jYXRvclwiLCBcIm51bWJlclwiXS5pbmRleE9mKHZhcmlhYmxlKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTW2N1cnJlbnRMYWJlbEluZm8ubGFiZWxdICE9PSB2YXJpYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzWzBdLmxhYmVsVmlzaWJpbGl0eSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlc1tjdXJyZW50TGFiZWxJbmZvLnBvc10ubGFiZWxWaXNpYmlsaXR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBzZXRQbHVyYWxzQW5kTnVtZXJpY3ModmFsdWVzKSB7XG4gICAgICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIHZhciBncm91cFN0YXJ0UG9zID0gMDtcbiAgICAgICAgdmFyIGdyb3VwQ291bnQgPSAxO1xuICAgICAgICBmb3IgKHZhciBpPTEsaWxlbj12YWx1ZXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIHZhciBsYXN0VmFsID0gdmFsdWVzW2ktMV07XG4gICAgICAgICAgICB2YXIgdGhpc1ZhbCA9IHZhbHVlc1tpXTtcbiAgICAgICAgICAgIGlmIChsYXN0VmFsLmxhYmVsID09PSB0aGlzVmFsLmxhYmVsICYmIGxhc3RWYWwucGFydGljbGUgPT09IGxhc3RWYWwucGFydGljbGUpIHtcbiAgICAgICAgICAgICAgICBncm91cENvdW50Kys7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50TGFiZWxJbmZvID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh2YWx1ZXNbZ3JvdXBTdGFydFBvc10pKTtcbiAgICAgICAgICAgICAgICBjdXJyZW50TGFiZWxJbmZvLnBvcyA9IGdyb3VwU3RhcnRQb3M7XG4gICAgICAgICAgICAgICAgY3VycmVudExhYmVsSW5mby5jb3VudCA9IGdyb3VwQ291bnQ7XG4gICAgICAgICAgICAgICAgY3VycmVudExhYmVsSW5mby5udW1lcmljID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBmaXhOdW1lcmljQW5kQ291bnQodmFsdWVzLCBncm91cFN0YXJ0UG9zLCBjdXJyZW50TGFiZWxJbmZvKTtcbiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gMCB8fCAobGFzdFZhbC5sYWJlbCAhPT0gdGhpc1ZhbC5sYWJlbCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZml4TGFiZWxWaXNpYmlsaXR5KHZhbHVlcywgZ3JvdXBTdGFydFBvcywgY3VycmVudExhYmVsSW5mbyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGdyb3VwU3RhcnRQb3MgPSBpO1xuICAgICAgICAgICAgICAgIGdyb3VwQ291bnQgPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBjdXJyZW50TGFiZWxJbmZvID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh2YWx1ZXNbZ3JvdXBTdGFydFBvc10pKTtcbiAgICAgICAgY3VycmVudExhYmVsSW5mby5wb3MgPSBncm91cFN0YXJ0UG9zO1xuICAgICAgICBjdXJyZW50TGFiZWxJbmZvLmNvdW50ID0gZ3JvdXBDb3VudDtcbiAgICAgICAgY3VycmVudExhYmVsSW5mby5udW1lcmljID0gdHJ1ZTtcbiAgICAgICAgZml4TnVtZXJpY0FuZENvdW50KHZhbHVlcywgZ3JvdXBTdGFydFBvcywgY3VycmVudExhYmVsSW5mbyk7XG4gICAgICAgIGZpeExhYmVsVmlzaWJpbGl0eSh2YWx1ZXMsIGdyb3VwU3RhcnRQb3MsIGN1cnJlbnRMYWJlbEluZm8pO1xuICAgICAgICBpZiAodmFsdWVzLmxlbmd0aCAmJiB2YWx1ZXNbMF0ubnVtZXJpYyAmJiB2YXJpYWJsZS5zbGljZSgwLCAxMCkgPT09IFwibnVtYmVyLW9mLVwiKSB7XG4gICAgICAgICAgICBpZiAocGFyc2VJbnQoSXRlbU9iamVjdFt2YXJpYWJsZV0sIDEwKSA+IDEpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZXNbMF0ucGx1cmFsID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gICAgICAgIFxuICAgIGZ1bmN0aW9uIHNldFN0eWxpbmcodmFsdWVzKSB7XG4gICAgICAgIHZhciBtYXN0ZXJOb2RlID0gQ1NMLlV0aWwuY2xvbmVUb2tlbihub2RlKTtcbiAgICAgICAgdmFyIG1hc3RlclN0eWxpbmcgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgIGlmICghbWUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgZm9yICh2YXIgaj1tYXN0ZXJOb2RlLmRlY29yYXRpb25zLmxlbmd0aC0xO2o+LTE7ai0tKSB7XG4gICAgICAgICAgICAgICAgaWYgKG1hc3Rlck5vZGUuZGVjb3JhdGlvbnNbal1bMF0gPT09IFwiQHF1b3Rlc1wiKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hc3RlclN0eWxpbmcuZGVjb3JhdGlvbnMgPSBtYXN0ZXJTdHlsaW5nLmRlY29yYXRpb25zLmNvbmNhdChtYXN0ZXJOb2RlLmRlY29yYXRpb25zLnNsaWNlKGosIGorMSkpO1xuICAgICAgICAgICAgICAgICAgICBtYXN0ZXJOb2RlLmRlY29yYXRpb25zID0gbWFzdGVyTm9kZS5kZWNvcmF0aW9ucy5zbGljZSgwLCBqKS5jb25jYXQobWFzdGVyTm9kZS5kZWNvcmF0aW9ucy5zbGljZShqKzEpKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1hc3RlclN0eWxpbmcuc3RyaW5ncy5wcmVmaXggPSBtYXN0ZXJOb2RlLnN0cmluZ3MucHJlZml4O1xuICAgICAgICAgICAgbWFzdGVyTm9kZS5zdHJpbmdzLnByZWZpeCA9IFwiXCI7XG4gICAgICAgICAgICBtYXN0ZXJTdHlsaW5nLnN0cmluZ3Muc3VmZml4ID0gbWFzdGVyTm9kZS5zdHJpbmdzLnN1ZmZpeDtcbiAgICAgICAgICAgIG1hc3Rlck5vZGUuc3RyaW5ncy5zdWZmaXggPSBcIlwiO1xuICAgICAgICB9XG4gICAgICAgIHZhciBtYXN0ZXJMYWJlbCA9IHZhbHVlcy5sZW5ndGggPyB2YWx1ZXNbMF0ubGFiZWwgOiBudWxsO1xuICAgICAgICBpZiAodmFsdWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dmFsdWVzLmxlbmd0aDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgdmFsID0gdmFsdWVzW2ldO1xuICAgICAgICAgICAgICAgIHZhciBuZXdub2RlID0gQ1NMLlV0aWwuY2xvbmVUb2tlbihtYXN0ZXJOb2RlKTtcbiAgICAgICAgICAgICAgICBuZXdub2RlLmdlbmRlciA9IG5vZGUuZ2VuZGVyO1xuICAgICAgICAgICAgICAgIGlmIChtYXN0ZXJMYWJlbCA9PT0gdmFsLmxhYmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld25vZGUuZm9ybWF0dGVyID0gbm9kZS5mb3JtYXR0ZXI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh2YWwubnVtZXJpYykge1xuICAgICAgICAgICAgICAgICAgICBuZXdub2RlLnN1Y2Nlc3Nvcl9wcmVmaXggPSB2YWwuc3VjY2Vzc29yX3ByZWZpeDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmV3bm9kZS5zdHJpbmdzLnN1ZmZpeCA9IG5ld25vZGUuc3RyaW5ncy5zdWZmaXggKyBzdHJpcEh5cGhlbkJhY2tzbGFzaCh2YWwuam9pbmluZ1N1ZmZpeCk7XG4gICAgICAgICAgICAgICAgdmFsLnN0eWxpbmcgPSBuZXdub2RlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFtZS50bXAuanVzdF9sb29raW5nKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlc1swXS52YWx1ZS5zbGljZSgwLDEpID09PSBcIlxcXCJcIiAmJiB2YWx1ZXNbdmFsdWVzLmxlbmd0aC0xXS52YWx1ZS5zbGljZSgtMSkgPT09IFwiXFxcIlwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlc1swXS52YWx1ZSA9IHZhbHVlc1swXS52YWx1ZS5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzW3ZhbHVlcy5sZW5ndGgtMV0udmFsdWUgPSB2YWx1ZXNbdmFsdWVzLmxlbmd0aC0xXS52YWx1ZS5zbGljZSgwLC0xKTtcbiAgICAgICAgICAgICAgICAgICAgbWFzdGVyU3R5bGluZy5kZWNvcmF0aW9ucy5wdXNoKFtcIkBxdW90ZXNcIiwgdHJ1ZV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbWFzdGVyU3R5bGluZztcbiAgICB9XG4gICAgZnVuY3Rpb24gc3RyaXBIeXBoZW5CYWNrc2xhc2goam9pbmluZ1N1ZmZpeCkge1xuICAgICAgICByZXR1cm4gam9pbmluZ1N1ZmZpeC5yZXBsYWNlKFwiXFxcXC1cIiwgXCItXCIpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBmaXh1cFJhbmdlRGVsaW1pdGVyKHZhcmlhYmxlLCB2YWwsIHJhbmdlRGVsaW1pdGVyLCBpc051bWVyaWMpIHtcbiAgICAgICAgdmFyIGlzUGFnZSA9IGNoZWNrUGFnZSh2YXJpYWJsZSwgdmFsKTtcbiAgICAgICAgdmFyIGhhc1Rlcm0gPSBjaGVja1Rlcm0odmFyaWFibGUsIHZhbCk7XG4gICAgICAgIGlmIChoYXNUZXJtICYmIHJhbmdlRGVsaW1pdGVyID09PSBcIi1cIikge1xuICAgICAgICAgICAgaWYgKGlzTnVtZXJpYykge1xuICAgICAgICAgICAgICAgIGlmIChpc1BhZ2UgfHwgW1wibG9jYXRvclwiLCBcImlzc3VlXCIsIFwidm9sdW1lXCIsIFwiZWRpdGlvblwiLCBcIm51bWJlclwiXS5pbmRleE9mKHZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHJhbmdlRGVsaW1pdGVyID0gbWUuZ2V0VGVybShcInBhZ2UtcmFuZ2UtZGVsaW1pdGVyXCIpXG4gICAgICAgICAgICAgICAgICAgIGlmICghcmFuZ2VEZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlRGVsaW1pdGVyID0gXCJcXHUyMDEzXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHZhcmlhYmxlID09PSBcImNvbGxlY3Rpb24tbnVtYmVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2VEZWxpbWl0ZXIgPSBtZS5nZXRUZXJtKFwieWVhci1yYW5nZS1kZWxpbWl0ZXJcIik7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcmFuZ2VEZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlRGVsaW1pdGVyID0gXCJcXHUyMDEzXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJhbmdlRGVsaW1pdGVyO1xuICAgIH1cbiAgICBmdW5jdGlvbiBjaGVja1BhZ2UodmFyaWFibGUsIHZhbCkge1xuICAgICAgICByZXR1cm4gdmFyaWFibGUgPT09IFwicGFnZVwiIFxuICAgICAgICAgICAgfHwgKHZhcmlhYmxlID09PSBcImxvY2F0b3JcIiAmJiAoW1wicC5cIl0uaW5kZXhPZih2YWwubGFiZWwpID4gLTEgfHwgW1wicC5cIl0uaW5kZXhPZih2YWwub3JpZ0xhYmVsKSA+IC0xKSk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNoZWNrVGVybSh2YXJpYWJsZSwgdmFsKSB7XG4gICAgICAgIHZhciByZXQgPSB0cnVlO1xuICAgICAgICBpZiAodmFyaWFibGUgPT09IFwibG9jYXRvclwiKSB7XG4gICAgICAgICAgICB2YXIgbGFiZWw7XG4gICAgICAgICAgICBpZiAodmFsLm9yaWdMYWJlbCkge1xuICAgICAgICAgICAgICAgIGxhYmVsID0gdmFsLm9yaWdMYWJlbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGFiZWwgPSB2YWwubGFiZWw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXQgPSAhIW1lLmdldFRlcm0oQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1NbbGFiZWxdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICBmdW5jdGlvbiBtYW5nbGVQYWdlTnVtYmVycyh2YWx1ZXMsIGksIGN1cnJlbnRJbmZvKSB7XG4gICAgICAgIGlmIChpPDEpIHJldHVybjtcbiAgICAgICAgaWYgKGN1cnJlbnRJbmZvLmNvdW50ICE9PSAyKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZhbHVlc1tpLTFdLnBhcnRpY2xlICE9PSB2YWx1ZXNbaV0ucGFydGljbGUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmFsdWVzW2ktMV0uam9pbmluZ1N1ZmZpeCAhPT0gXCItXCIpIHtcbiAgICAgICAgICAgIGN1cnJlbnRJbmZvLmNvdW50ID0gMTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIW1lLm9wdFtcInBhZ2UtcmFuZ2UtZm9ybWF0XCJdICYmIHBhcnNlSW50KHZhbHVlc1tpLTFdLnZhbHVlLCAxMCkgPiBwYXJzZUludCh2YWx1ZXNbaV0udmFsdWUsIDEwKSkge1xuICAgICAgICAgICAgdmFsdWVzW2ktMV0uam9pbmluZ1N1ZmZpeCA9IGZpeHVwUmFuZ2VEZWxpbWl0ZXIodmFyaWFibGUsIHZhbHVlc1tpXSwgdmFsdWVzW2ktMV0uam9pbmluZ1N1ZmZpeCwgdHJ1ZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHZhbCA9IHZhbHVlc1tpXTtcbiAgICAgICAgdmFyIGlzUGFnZSA9IGNoZWNrUGFnZSh2YXJpYWJsZSwgdmFsKTtcbiAgICAgICAgaWYgKGlzUGFnZSAmJiAhaXNOYU4ocGFyc2VJbnQodmFsdWVzW2ktMV0udmFsdWUpKSAmJiAhaXNOYU4ocGFyc2VJbnQodmFsdWVzW2ldLnZhbHVlKSkpIHtcbiAgICAgICAgICAgIHZhciBzdHIgPSB2YWx1ZXNbaS0xXS5wYXJ0aWNsZSArIHZhbHVlc1tpLTFdLnZhbHVlICsgXCIgLSBcIiArIHZhbHVlc1tpXS5wYXJ0aWNsZSArIHZhbHVlc1tpXS52YWx1ZTtcbiAgICAgICAgICAgIHN0ciA9IG1lLmZ1bi5wYWdlX21hbmdsZXIoc3RyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICgoXCJcIiArIHZhbHVlc1tpLTFdLnZhbHVlKS5tYXRjaCgvXihbMC05XSt8W2l2eGxjbUlWWExDTV0rKSQvKSAmJiAoXCJcIiArIHZhbHVlc1tpXS52YWx1ZSkubWF0Y2goL14oWzAtOV0rfFtpdnhsY21JVlhMQ01dKykkLykpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZXNbaS0xXS5qb2luaW5nU3VmZml4ID0gbWUuZ2V0VGVybShcInBhZ2UtcmFuZ2UtZGVsaW1pdGVyXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RyID0gdmFsdWVzW2ktMV0udmFsdWUgKyBzdHJpcEh5cGhlbkJhY2tzbGFzaCh2YWx1ZXNbaS0xXS5qb2luaW5nU3VmZml4KSArIHZhbHVlc1tpXS52YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbSA9IHN0ci5tYXRjaCgvXigoPzpbMC05XSpbYS16QS1aXSswKikpPyhbMC05XSspKFxccypbXjAtOV0rXFxzKikoWy0sYS16QS1aXT8wKikoWzAtOV0rKSQvKTtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgIHZhciByYW5nZURlbGltaXRlciA9IG1bM107XG4gICAgICAgICAgICByYW5nZURlbGltaXRlciA9IGZpeHVwUmFuZ2VEZWxpbWl0ZXIodmFyaWFibGUsIHZhbCwgcmFuZ2VEZWxpbWl0ZXIsIHZhbHVlc1tpXS5udW1lcmljKTtcbiAgICAgICAgICAgIHZhbHVlc1tpLTFdLnBhcnRpY2xlID0gbVsxXTtcbiAgICAgICAgICAgIHZhbHVlc1tpLTFdLnZhbHVlID0gbVsyXTtcbiAgICAgICAgICAgIHZhbHVlc1tpLTFdLmpvaW5pbmdTdWZmaXggPSByYW5nZURlbGltaXRlcjtcbiAgICAgICAgICAgIHZhbHVlc1tpXS5wYXJ0aWNsZSA9IG1bNF07XG4gICAgICAgICAgICB2YWx1ZXNbaV0udmFsdWUgPSBtWzVdO1xuICAgICAgICB9XG4gICAgICAgIGN1cnJlbnRJbmZvLmNvdW50ID0gMDtcbiAgICB9XG4gICAgZnVuY3Rpb24gZml4UmFuZ2VzKHZhbHVlcykge1xuICAgICAgICBpZiAoIW5vZGUpIHJldHVybjtcbiAgICAgICAgaWYgKFtcInBhZ2VcIiwgXCJwYWdlLWZpcnN0XCIsIFwiY2hhcHRlci1udW1iZXJcIiwgXCJjb2xsZWN0aW9uLW51bWJlclwiLCBcImVkaXRpb25cIiwgXCJpc3N1ZVwiLCBcIm51bWJlclwiLCBcIm51bWJlci1vZi1wYWdlc1wiLCBcIm51bWJlci1vZi12b2x1bWVzXCIsIFwidm9sdW1lXCIsIFwibG9jYXRvclwiXS5pbmRleE9mKHZhcmlhYmxlKSA9PT0gLTEpIHJldHVybjtcbiAgICAgICAgdmFyIGN1cnJlbnRJbmZvID0ge1xuICAgICAgICAgICAgY291bnQ6IDAsXG4gICAgICAgICAgICBsYWJlbDogbnVsbCxcbiAgICAgICAgICAgIGxhc3RIYWRSYW5nZURlbGltaXRlcjogZmFsc2VcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj12YWx1ZXMubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdmFyIHZhbCA9IHZhbHVlc1tpXTtcbiAgICAgICAgICAgIGlmICghdmFsLmNvbGxhcHNpYmxlKSB7XG4gICAgICAgICAgICAgICAgY3VycmVudEluZm8uY291bnQgPSAwO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRJbmZvLmxhYmVsID0gbnVsbDtcbiAgICAgICAgICAgICAgICB2YXIgaXNOdW1lcmljID0gdmFsLm51bWVyaWM7XG4gICAgICAgICAgICAgICAgdmFsLmpvaW5pbmdTdWZmaXggPSBmaXh1cFJhbmdlRGVsaW1pdGVyKHZhcmlhYmxlLCB2YWwsIHZhbC5qb2luaW5nU3VmZml4LCBpc051bWVyaWMpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50SW5mby5sYWJlbCA9PT0gdmFsLmxhYmVsICYmIHZhbC5qb2luaW5nU3VmZml4ID09PSBcIi1cIikge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRJbmZvLmNvdW50ID0gMTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudEluZm8ubGFiZWwgPT09IHZhbC5sYWJlbCAmJiB2YWwuam9pbmluZ1N1ZmZpeCAhPT0gXCItXCIpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50SW5mby5jb3VudCsrO1xuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50SW5mby5jb3VudCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICBtYW5nbGVQYWdlTnVtYmVycyh2YWx1ZXMsIGksIGN1cnJlbnRJbmZvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRJbmZvLmxhYmVsICE9PSB2YWwubGFiZWwpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50SW5mby5sYWJlbCA9IHZhbC5sYWJlbDtcbiAgICAgICAgICAgICAgICBjdXJyZW50SW5mby5jb3VudCA9IDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRJbmZvLmNvdW50ID0gMTtcbiAgICAgICAgICAgICAgICBjdXJyZW50SW5mby5sYWJlbCA9IHZhbC5sYWJlbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoY3VycmVudEluZm8uY291bnQgPT09IDIpIHtcbiAgICAgICAgICAgIG1hbmdsZVBhZ2VOdW1iZXJzKHZhbHVlcywgdmFsdWVzLmxlbmd0aC0xLCBjdXJyZW50SW5mbyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gc2V0VmFyaWFibGVQYXJhbXMoc2hhZG93X251bWJlcnMsIHZhcmlhYmxlLCB2YWx1ZXMpIHtcbiAgICAgICAgdmFyIG9iaiA9IHNoYWRvd19udW1iZXJzW3ZhcmlhYmxlXTtcbiAgICAgICAgaWYgKHZhbHVlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIG9iai5udW1lcmljID0gdmFsdWVzWzBdLm51bWVyaWM7XG4gICAgICAgICAgICBvYmouY29sbGFwc2libGUgPSB2YWx1ZXNbMF0uY29sbGFwc2libGU7XG4gICAgICAgICAgICBvYmoucGx1cmFsID0gdmFsdWVzWzBdLnBsdXJhbDtcbiAgICAgICAgICAgIG9iai5sYWJlbCA9IENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTW3ZhbHVlc1swXS5sYWJlbF07XG4gICAgICAgICAgICBpZiAodmFyaWFibGUgPT09IFwibnVtYmVyXCIgJiYgb2JqLmxhYmVsID09PSBcImlzc3VlXCIgJiYgbWUuZ2V0VGVybShcIm51bWJlclwiKSkge1xuICAgICAgICAgICAgICAgIG9iai5sYWJlbCA9IFwibnVtYmVyXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKG5vZGUgJiYgdGhpcy50bXAuc2hhZG93X251bWJlcnNbdmFyaWFibGVdICYmIHRoaXMudG1wLnNoYWRvd19udW1iZXJzW3ZhcmlhYmxlXS52YWx1ZXMubGVuZ3RoKSB7XG4gICAgICAgIHZhciB2YWx1ZXMgPSB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1t2YXJpYWJsZV0udmFsdWVzO1xuICAgICAgICBmaXhSYW5nZXModmFsdWVzKTtcbiAgICAgICAgICAgIHRoaXMudG1wLnNoYWRvd19udW1iZXJzW3ZhcmlhYmxlXS5tYXN0ZXJTdHlsaW5nID0gc2V0U3R5bGluZyh2YWx1ZXMpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghdGhpcy50bXAuc2hhZG93X251bWJlcnNbdmFyaWFibGVdKSB7XG4gICAgICAgIHRoaXMudG1wLnNoYWRvd19udW1iZXJzW3ZhcmlhYmxlXSA9IHtcbiAgICAgICAgICAgIHZhbHVlczpbXVxuICAgICAgICB9O1xuICAgIH1cbiAgICBpZiAoIUl0ZW1PYmplY3QpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgbGFuZ3VhZ2VSb2xlID0gQ1NMLkxhbmdQcmVmc01hcFt2YXJpYWJsZV07XG4gICAgaWYgKGxhbmd1YWdlUm9sZSkge1xuICAgICAgICB2YXIgbG9jYWxlVHlwZSA9IHRoaXMub3B0W1wiY2l0ZS1sYW5nLXByZWZzXCJdW2xhbmd1YWdlUm9sZV1bMF07XG4gICAgICAgIHZhbCA9IHRoaXMudHJhbnNmb3JtLmdldFRleHRTdWJGaWVsZChJdGVtT2JqZWN0LCB2YXJpYWJsZSwgXCJsb2NhbGUtXCIrbG9jYWxlVHlwZSwgdHJ1ZSk7XG4gICAgICAgIHZhbCA9IHZhbC5uYW1lO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHZhbCA9IEl0ZW1PYmplY3RbdmFyaWFibGVdO1xuICAgIH1cbiAgICBpZiAodmFsICYmIHRoaXMuc3lzLmdldEFiYnJldmlhdGlvbikge1xuICAgICAgICB2YXIganVyaXNkaWN0aW9uID0gdGhpcy50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihJdGVtT2JqZWN0Lmp1cmlzZGljdGlvbiwgXCJudW1iZXJcIiwgdmFsKTtcbiAgICAgICAgaWYgKHRoaXMudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXS5udW1iZXIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl0ubnVtYmVyW3ZhbF0pIHtcbiAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl0ubnVtYmVyW3ZhbF07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgdGhpcy50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dLm51bWJlclt2YWxdKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl0ubnVtYmVyW3ZhbF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgdmFsICYmIChcInN0cmluZ1wiID09PSB0eXBlb2YgdmFsIHx8IFwibnVtYmVyXCIgPT09IHR5cGVvZiB2YWwpKSB7XG4gICAgICAgIGlmIChcIm51bWJlclwiID09PSB0eXBlb2YgdmFsKSB7XG4gICAgICAgICAgICB2YWwgPSBcIlwiICsgdmFsO1xuICAgICAgICB9XG4gICAgICAgIHZhciBkZWZhdWx0TGFiZWwgPSBDU0wuU1RBVFVURV9TVUJESVZfU1RSSU5HU19SRVZFUlNFW3ZhcmlhYmxlXTtcbiAgICAgICAgaWYgKCF0aGlzLnRtcC5zaGFkb3dfbnVtYmVycy52YWx1ZXMpIHtcbiAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBwYXJzZVN0cmluZyh2YWwsIGRlZmF1bHRMYWJlbCk7XG4gICAgICAgICAgICBzZXRTcGFjZXModmFsdWVzKTtcbiAgICAgICAgICAgIHNldFBsdXJhbHNBbmROdW1lcmljcyh2YWx1ZXMpO1xuICAgICAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbdmFyaWFibGVdLnZhbHVlcyA9IHZhbHVlcztcbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgICAgZml4UmFuZ2VzKHZhbHVlcyk7XG4gICAgICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1t2YXJpYWJsZV0ubWFzdGVyU3R5bGluZyA9IHNldFN0eWxpbmcodmFsdWVzKVxuICAgICAgICB9XG4gICAgICAgIHNldFZhcmlhYmxlUGFyYW1zKHRoaXMudG1wLnNoYWRvd19udW1iZXJzLCB2YXJpYWJsZSwgdmFsdWVzKTtcbiAgICB9XG59O1xuQ1NMLlV0aWwub3V0cHV0TnVtZXJpY0ZpZWxkID0gZnVuY3Rpb24oc3RhdGUsIHZhcm5hbWUsIGl0ZW1JRCkge1xuICAgIHN0YXRlLm91dHB1dC5vcGVuTGV2ZWwoc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW3Zhcm5hbWVdLm1hc3RlclN0eWxpbmcpO1xuICAgIHZhciBudW1zID0gc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW3Zhcm5hbWVdLnZhbHVlcztcbiAgICB2YXIgbWFzdGVyTGFiZWwgPSBudW1zLmxlbmd0aCA/IG51bXNbMF0ubGFiZWwgOiBudWxsO1xuICAgIHZhciBsYWJlbEZvcm0gPSBzdGF0ZS50bXAuc2hhZG93X251bWJlcnNbdmFybmFtZV0ubGFiZWxGb3JtO1xuICAgIHZhciBlbWJlZGRlZExhYmVsRm9ybTtcbiAgICBpZiAobGFiZWxGb3JtKSB7XG4gICAgICAgIGVtYmVkZGVkTGFiZWxGb3JtID0gbGFiZWxGb3JtXG4gICAgfSBlbHNlIHtcbiAgICAgICAgZW1iZWRkZWRMYWJlbEZvcm0gPSBcInNob3J0XCI7XG4gICAgfVxuICAgIHZhciBsYWJlbENhcGl0YWxpemVJZkZpcnN0ID0gc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW3Zhcm5hbWVdLmxhYmVsQ2FwaXRhbGl6ZUlmRmlyc3Q7XG4gICAgdmFyIGxhYmVsRGVjb3JhdGlvbnMgPSBzdGF0ZS50bXAuc2hhZG93X251bWJlcnNbdmFybmFtZV0ubGFiZWxEZWNvcmF0aW9ucztcbiAgICB2YXIgbGFzdExhYmVsTmFtZSA9IG51bGw7XG4gICAgZm9yICh2YXIgaT0wLGlsZW49bnVtcy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICB2YXIgbnVtID0gbnVtc1tpXTtcbiAgICAgICAgdmFyIGxhYmVsID0gXCJcIjtcbiAgICAgICAgaWYgKG51bS5sYWJlbCkge1xuICAgICAgICAgICAgdmFyIGxhYmVsTmFtZTtcbiAgICAgICAgICAgIGlmICgndmFyOicgPT09IG51bS5sYWJlbC5zbGljZSgwLDQpKSB7XG4gICAgICAgICAgICAgICAgbGFiZWxOYW1lID0gbnVtLmxhYmVsLnNsaWNlKDQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsYWJlbE5hbWUgPSBDU0wuU1RBVFVURV9TVUJESVZfU1RSSU5HU1tudW0ubGFiZWxdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGxhYmVsTmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChudW0ubGFiZWwgPT09IG1hc3RlckxhYmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhYmVsID0gc3RhdGUuZ2V0VGVybShsYWJlbE5hbWUsIGxhYmVsRm9ybSwgbnVtLnBsdXJhbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBzdGF0ZS5nZXRUZXJtKGxhYmVsTmFtZSwgZW1iZWRkZWRMYWJlbEZvcm0sIG51bS5wbHVyYWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobGFiZWxDYXBpdGFsaXplSWZGaXJzdCkge1xuICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IENTTC5PdXRwdXQuRm9ybWF0dGVyc1tcImNhcGl0YWxpemUtZmlyc3RcIl0oc3RhdGUsIGxhYmVsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGxhYmVsUGxhY2Vob2xkZXJQb3MgPSAtMTtcbiAgICAgICAgaWYgKGxhYmVsKSB7XG4gICAgICAgICAgICBsYWJlbFBsYWNlaG9sZGVyUG9zID0gbGFiZWwuaW5kZXhPZihcIiVzXCIpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBudW1TdHlsaW5nID0gQ1NMLlV0aWwuY2xvbmVUb2tlbihudW0uc3R5bGluZyk7XG4gICAgICAgIG51bVN0eWxpbmcuZm9ybWF0dGVyID0gbnVtLnN0eWxpbmcuZm9ybWF0dGVyO1xuICAgICAgICBudW1TdHlsaW5nLnR5cGUgPSBudW0uc3R5bGluZy50eXBlO1xuICAgICAgICBudW1TdHlsaW5nLm51bSA9IG51bS5zdHlsaW5nLm51bTtcbiAgICAgICAgbnVtU3R5bGluZy5nZW5kZXIgPSBudW0uc3R5bGluZy5nZW5kZXI7XG4gICAgICAgIGlmIChsYWJlbFBsYWNlaG9sZGVyUG9zID4gMCAmJiBsYWJlbFBsYWNlaG9sZGVyUG9zIDwgKGxhYmVsLmxlbmd0aC0yKSkge1xuICAgICAgICAgICAgbnVtU3R5bGluZy5zdHJpbmdzLnByZWZpeCArPSBsYWJlbC5zbGljZSgwLGxhYmVsUGxhY2Vob2xkZXJQb3MpO1xuICAgICAgICAgICAgbnVtU3R5bGluZy5zdHJpbmdzLnN1ZmZpeCA9IGxhYmVsLnNsaWNlKGxhYmVsUGxhY2Vob2xkZXJQb3MrMikgKyBudW1TdHlsaW5nLnN0cmluZ3Muc3VmZml4O1xuICAgICAgICB9IGVsc2UgaWYgKG51bS5sYWJlbFZpc2liaWxpdHkpIHtcbiAgICAgICAgICAgIGlmICghbGFiZWwpIHtcbiAgICAgICAgICAgICAgICBsYWJlbCA9IG51bS5sYWJlbDtcbiAgICAgICAgICAgICAgICBsYWJlbE5hbWUgPSBudW0ubGFiZWw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobGFiZWxQbGFjZWhvbGRlclBvcyA+IDApIHtcbiAgICAgICAgICAgICAgICB2YXIgcHJlZml4TGFiZWxTdHlsaW5nID0gbmV3IENTTC5Ub2tlbigpO1xuICAgICAgICAgICAgICAgIHByZWZpeExhYmVsU3R5bGluZy5kZWNvcmF0aW9ucyA9IGxhYmVsRGVjb3JhdGlvbnM7XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZChsYWJlbC5zbGljZSgwLGxhYmVsUGxhY2Vob2xkZXJQb3MpLCBwcmVmaXhMYWJlbFN0eWxpbmcpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChsYWJlbFBsYWNlaG9sZGVyUG9zID09PSAobGFiZWwubGVuZ3RoLTIpIHx8IGxhYmVsUGxhY2Vob2xkZXJQb3MgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZChsYWJlbCtudW0ubGFiZWxTdWZmaXgsIFwiZW1wdHlcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG51bS5jb2xsYXBzaWJsZSkge1xuICAgICAgICAgICAgaWYgKG51bS52YWx1ZS5tYXRjaCgvXlsxLTldWzAtOV0qJC8pKSB7XG4gICAgICAgICAgICAgICAgdmFyIGJsb2IgPSBuZXcgQ1NMLk51bWVyaWNCbG9iKG51bS5wYXJ0aWNsZSwgcGFyc2VJbnQobnVtLnZhbHVlLCAxMCksIG51bVN0eWxpbmcsIGl0ZW1JRCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBibG9iID0gbmV3IENTTC5OdW1lcmljQmxvYihudW0ucGFydGljbGUsIG51bS52YWx1ZSwgbnVtU3R5bGluZywgaXRlbUlEKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgYmxvYi5nZW5kZXIpIHtcbiAgICAgICAgICAgICAgICBibG9iLmdlbmRlciA9IHN0YXRlLmxvY2FsZVtzdGF0ZS5vcHQubGFuZ11bXCJub3VuLWdlbmRlcnNcIl1bdmFybmFtZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKGJsb2IsIFwibGl0ZXJhbFwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQobnVtLnBhcnRpY2xlICsgbnVtLnZhbHVlLCBudW1TdHlsaW5nKVxuICAgICAgICB9XG4gICAgICAgIGlmIChsYWJlbFBsYWNlaG9sZGVyUG9zID09PSAwICYmIGxhYmVsUGxhY2Vob2xkZXJQb3MgPCAobGFiZWwubGVuZ3RoLTIpKSB7XG4gICAgICAgICAgICBpZiAobGFzdExhYmVsTmFtZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGxhc3RMYWJlbE5hbWUgPSBsYWJlbE5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobGFiZWxOYW1lICE9PSBsYXN0TGFiZWxOYW1lIHx8IGkgPT09IChudW1zLmxlbmd0aC0xKSkge1xuICAgICAgICAgICAgICAgIHZhciBzdWZmaXhMYWJlbFN0eWxpbmcgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgICAgICAgICAgc3VmZml4TGFiZWxTdHlsaW5nLmRlY29yYXRpb25zID0gbGFiZWxEZWNvcmF0aW9ucztcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKGxhYmVsLnNsaWNlKGxhYmVsUGxhY2Vob2xkZXJQb3MrMiksIHN1ZmZpeExhYmVsU3R5bGluZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGFzdExhYmVsTmFtZSA9PT0gbGFiZWxOYW1lO1xuICAgICAgICBzdGF0ZS50bXAudGVybV9wcmVkZWNlc3NvciA9IHRydWU7XG4gICAgfVxuICAgIHN0YXRlLm91dHB1dC5jbG9zZUxldmVsKCk7XG59XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5VdGlsLlBhZ2VSYW5nZU1hbmdsZXIgPSB7fTtcbkNTTC5VdGlsLlBhZ2VSYW5nZU1hbmdsZXIuZ2V0RnVuY3Rpb24gPSBmdW5jdGlvbiAoc3RhdGUsIHJhbmdlVHlwZSkge1xuICAgIHZhciByYW5nZXJleCwgcG9zLCBsZW4sIHN0cmluZ2lmeSwgbGlzdGlmeSwgZXhwYW5kLCBtaW5pbWl6ZSwgbWluaW1pemVfaW50ZXJuYWwsIGNoaWNhZ28sIGxzdCwgbSwgYiwgZSwgcmV0LCBiZWdpbiwgZW5kLCByZXRfZnVuYywgcHBvcywgbGxlbjtcbiAgICB2YXIgcmFuZ2VfZGVsaW1pdGVyID0gc3RhdGUuZ2V0VGVybShyYW5nZVR5cGUgKyBcIi1yYW5nZS1kZWxpbWl0ZXJcIik7XG4gICAgcmFuZ2VyZXggPSAvKFswLTldKlthLXpBLVpdKzAqKT8oWzAtOV0rKVxccyooPzpcXHUyMDEzfC0pXFxzKihbMC05XSpbYS16QS1aXSswKik/KFswLTldKykvO1xuICAgIHN0cmluZ2lmeSA9IGZ1bmN0aW9uIChsc3QpIHtcbiAgICAgICAgbGVuID0gbHN0Lmxlbmd0aDtcbiAgICAgICAgZm9yIChwb3MgPSAxOyBwb3MgPCBsZW47IHBvcyArPSAyKSB7XG4gICAgICAgICAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIGxzdFtwb3NdKSB7XG4gICAgICAgICAgICAgICAgbHN0W3Bvc10gPSBsc3RbcG9zXS5qb2luKFwiXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciByZXQgPSBsc3Quam9pbihcIlwiKTtcbiAgICAgICAgcmV0ID0gcmV0LnJlcGxhY2UoLyhbXlxcXFxdKVxcLS9nLCBcIiQxXCIrc3RhdGUuZ2V0VGVybShyYW5nZVR5cGUgKyBcIi1yYW5nZS1kZWxpbWl0ZXJcIikpO1xuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH07XG4gICAgbGlzdGlmeSA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgdmFyIG0sIGxzdCwgcmV0O1xuICAgICAgICB2YXIgaHlwaGVucyA9IFwiXFxcXHMrXFxcXC1cXFxccytcIjtcbiAgICAgICAgdmFyIHRoaXNfcmFuZ2VfZGVsaW1pdGVyID0gcmFuZ2VfZGVsaW1pdGVyID09PSBcIi1cIiA/IFwiXCIgOiByYW5nZV9kZWxpbWl0ZXI7XG4gICAgICAgIHZhciBkZWxpbVJleCA9IG5ldyBSZWdFeHAoXCIoW15cXFxcXFxcXF0pWy1cIiArIHRoaXNfcmFuZ2VfZGVsaW1pdGVyICsgXCJcXFxcdTIwMTNdXCIsIFwiZ1wiKTtcbiAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoZGVsaW1SZXgsIFwiJDEgLSBcIikucmVwbGFjZSgvXFxzKy1cXHMrL2csIFwiIC0gXCIpO1xuICAgICAgICB2YXIgcmV4bSA9IG5ldyBSZWdFeHAoXCIoKD86WzAtOV0qW2EtekEtWl0rMCopP1swLTldK1wiICsgaHlwaGVucyArIFwiKD86WzAtOV0qW2EtekEtWl0rMCopP1swLTldKylcIiwgXCJnXCIpO1xuICAgICAgICB2YXIgcmV4bHN0ID0gbmV3IFJlZ0V4cChcIig/OlswLTldKlthLXpBLVpdKzAqKT9bMC05XStcIiArIGh5cGhlbnMgKyBcIig/OlswLTldKlthLXpBLVpdKzAqKT9bMC05XStcIik7XG4gICAgICAgIG0gPSBzdHIubWF0Y2gocmV4bSk7XG4gICAgICAgIGxzdCA9IHN0ci5zcGxpdChyZXhsc3QpO1xuICAgICAgICBpZiAobHN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0ID0gbTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldCA9IFtsc3RbMF1dO1xuICAgICAgICAgICAgZm9yIChwb3MgPSAxLCBsZW4gPSBsc3QubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2gobVtwb3MgLSAxXS5yZXBsYWNlKC9cXHMqXFwtXFxzKi9nLCBcIi1cIikpO1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKGxzdFtwb3NdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH07XG4gICAgZXhwYW5kID0gZnVuY3Rpb24gKHN0cikge1xuICAgICAgICBzdHIgPSBcIlwiICsgc3RyO1xuICAgICAgICBsc3QgPSBsaXN0aWZ5KHN0cik7XG4gICAgICAgIGxlbiA9IGxzdC5sZW5ndGg7XG4gICAgICAgIGZvciAocG9zID0gMTsgcG9zIDwgbGVuOyBwb3MgKz0gMikge1xuICAgICAgICAgICAgbSA9IGxzdFtwb3NdLm1hdGNoKHJhbmdlcmV4KTtcbiAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFtWzNdIHx8IG1bMV0gPT09IG1bM10pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1bNF0ubGVuZ3RoIDwgbVsyXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1bNF0gPSBtWzJdLnNsaWNlKDAsIChtWzJdLmxlbmd0aCAtIG1bNF0ubGVuZ3RoKSkgKyBtWzRdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJzZUludChtWzJdLCAxMCkgPCBwYXJzZUludChtWzRdLCAxMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1bM10gPSByYW5nZV9kZWxpbWl0ZXIgKyAobVsxXSA/IG1bMV0gOiBcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxzdFtwb3NdID0gbS5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgbHN0W3Bvc10pIHtcbiAgICAgICAgICAgICAgICBsc3RbcG9zXSA9IGxzdFtwb3NdLnJlcGxhY2UoL1xcLS9nLCByYW5nZV9kZWxpbWl0ZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsc3Q7XG4gICAgfTtcbiAgICBtaW5pbWl6ZSA9IGZ1bmN0aW9uIChsc3QsIG1pbmNoYXJzLCBpc3llYXIpIHtcbiAgICAgICAgbGVuID0gbHN0Lmxlbmd0aDtcbiAgICAgICAgZm9yICh2YXIgaSA9IDEsIGlsZW4gPSBsc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAyKSB7XG4gICAgICAgICAgICBsc3RbaV1bM10gPSBtaW5pbWl6ZV9pbnRlcm5hbChsc3RbaV1bMV0sIGxzdFtpXVszXSwgbWluY2hhcnMsIGlzeWVhcik7XG4gICAgICAgICAgICBpZiAobHN0W2ldWzJdLnNsaWNlKDEpID09PSBsc3RbaV1bMF0pIHtcbiAgICAgICAgICAgICAgICBsc3RbaV1bMl0gPSByYW5nZV9kZWxpbWl0ZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN0cmluZ2lmeShsc3QpO1xuICAgIH07XG4gICAgbWluaW1pemVfaW50ZXJuYWwgPSBmdW5jdGlvbiAoYmVnaW4sIGVuZCwgbWluY2hhcnMsIGlzeWVhcikge1xuICAgICAgICBpZiAoIW1pbmNoYXJzKSB7XG4gICAgICAgICAgICBtaW5jaGFycyA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgYiA9IChcIlwiICsgYmVnaW4pLnNwbGl0KFwiXCIpO1xuICAgICAgICBlID0gKFwiXCIgKyBlbmQpLnNwbGl0KFwiXCIpO1xuICAgICAgICByZXQgPSBlLnNsaWNlKCk7XG4gICAgICAgIHJldC5yZXZlcnNlKCk7XG4gICAgICAgIGlmIChiLmxlbmd0aCA9PT0gZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gYi5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoYltpXSA9PT0gZVtpXSAmJiByZXQubGVuZ3RoID4gbWluY2hhcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0LnBvcCgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtaW5jaGFycyAmJiBpc3llYXIgJiYgcmV0Lmxlbmd0aCA9PT0gMykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZyb250ID0gYi5zbGljZSgwLCBpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyb250LnJldmVyc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IHJldC5jb25jYXQoZnJvbnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXQucmV2ZXJzZSgpO1xuICAgICAgICByZXR1cm4gcmV0LmpvaW4oXCJcIik7XG4gICAgfTtcbiAgICBjaGljYWdvID0gZnVuY3Rpb24gKGxzdCkge1xuICAgICAgICBsZW4gPSBsc3QubGVuZ3RoO1xuICAgICAgICBmb3IgKHBvcyA9IDE7IHBvcyA8IGxlbjsgcG9zICs9IDIpIHtcbiAgICAgICAgICAgIGlmIChcIm9iamVjdFwiID09PSB0eXBlb2YgbHN0W3Bvc10pIHtcbiAgICAgICAgICAgICAgICBtID0gbHN0W3Bvc107XG4gICAgICAgICAgICAgICAgYmVnaW4gPSBwYXJzZUludChtWzFdLCAxMCk7XG4gICAgICAgICAgICAgICAgZW5kID0gcGFyc2VJbnQobVszXSwgMTApO1xuICAgICAgICAgICAgICAgIGlmIChiZWdpbiA+IDEwMCAmJiBiZWdpbiAlIDEwMCAmJiBwYXJzZUludCgoYmVnaW4gLyAxMDApLCAxMCkgPT09IHBhcnNlSW50KChlbmQgLyAxMDApLCAxMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgbVszXSA9IFwiXCIgKyAoZW5kICUgMTAwKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGJlZ2luID49IDEwMDAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG1bM10gPSBcIlwiICsgKGVuZCAlIDEwMDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChtWzJdLnNsaWNlKDEpID09PSBtWzBdKSB7XG4gICAgICAgICAgICAgICAgbVsyXSA9IHJhbmdlX2RlbGltaXRlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RyaW5naWZ5KGxzdCk7XG4gICAgfTtcbiAgICB2YXIgc25pZmYgPSBmdW5jdGlvbiAoc3RyLCBmdW5jLCBtaW5jaGFycywgaXN5ZWFyKSB7XG4gICAgICAgIHZhciByZXQ7XG5cdFx0c3RyID0gXCJcIiArIHN0cjtcblx0XHR2YXIgbHN0ID0gZXhwYW5kKHN0cik7XG4gICAgICAgIHZhciByZXQgPSBmdW5jKGxzdCwgbWluY2hhcnMsIGlzeWVhcik7XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuICAgIGlmICghc3RhdGUub3B0W3JhbmdlVHlwZSArIFwiLXJhbmdlLWZvcm1hdFwiXSkge1xuICAgICAgICByZXRfZnVuYyA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBzbmlmZihzdHIsIHN0cmluZ2lmeSk7XG4gICAgICAgIH07XG4gICAgfSBlbHNlIGlmIChzdGF0ZS5vcHRbcmFuZ2VUeXBlICsgXCItcmFuZ2UtZm9ybWF0XCJdID09PSBcImV4cGFuZGVkXCIpIHtcbiAgICAgICAgcmV0X2Z1bmMgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgICAgICByZXR1cm4gc25pZmYoc3RyLCBzdHJpbmdpZnkpO1xuICAgICAgICB9O1xuICAgIH0gZWxzZSBpZiAoc3RhdGUub3B0W3JhbmdlVHlwZSArIFwiLXJhbmdlLWZvcm1hdFwiXSA9PT0gXCJtaW5pbWFsXCIpIHtcbiAgICAgICAgcmV0X2Z1bmMgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgICAgICByZXR1cm4gc25pZmYoc3RyLCBtaW5pbWl6ZSk7XG4gICAgICAgIH07XG4gICAgfSBlbHNlIGlmIChzdGF0ZS5vcHRbcmFuZ2VUeXBlICsgXCItcmFuZ2UtZm9ybWF0XCJdID09PSBcIm1pbmltYWwtdHdvXCIpIHtcbiAgICAgICAgcmV0X2Z1bmMgPSBmdW5jdGlvbiAoc3RyLCBpc3llYXIpIHtcbiAgICAgICAgICAgIHJldHVybiBzbmlmZihzdHIsIG1pbmltaXplLCAyLCBpc3llYXIpO1xuICAgICAgICB9O1xuICAgIH0gZWxzZSBpZiAoc3RhdGUub3B0W3JhbmdlVHlwZSArIFwiLXJhbmdlLWZvcm1hdFwiXSA9PT0gXCJjaGljYWdvXCIpIHtcbiAgICAgICAgcmV0X2Z1bmMgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgICAgICByZXR1cm4gc25pZmYoc3RyLCBjaGljYWdvKTtcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHJldF9mdW5jO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlV0aWwuRmxpcEZsb3BwZXIgPSBmdW5jdGlvbihzdGF0ZSkge1xuICAgIHRoaXMucHJvY2Vzc1RhZ3MgPSBwcm9jZXNzVGFncztcbiAgICB2YXIgX25lc3RpbmdTdGF0ZSA9IFtdO1xuICAgIHZhciBfbmVzdGluZ0RhdGEgPSB7XG4gICAgICAgIFwiPHNwYW4gY2xhc3M9XFxcIm5vY2FzZVxcXCI+XCI6IHtcbiAgICAgICAgICAgIHR5cGU6IFwibm9jYXNlXCIsXG4gICAgICAgICAgICBvcGVuZXI6IFwiPHNwYW4gY2xhc3M9XFxcIm5vY2FzZVxcXCI+XCIsXG4gICAgICAgICAgICBjbG9zZXI6IFwiPC9zcGFuPlwiLFxuICAgICAgICAgICAgYXR0cjogbnVsbCxcbiAgICAgICAgICAgIG91dGVyOiBudWxsLFxuICAgICAgICAgICAgZmxpcGZsb3A6IG51bGxcbiAgICAgICAgfSxcbiAgICAgICAgXCI8c3BhbiBjbGFzcz1cXFwibm9kZWNvclxcXCI+XCI6IHtcbiAgICAgICAgICAgIHR5cGU6IFwibm9kZWNvclwiLFxuICAgICAgICAgICAgb3BlbmVyOiBcIjxzcGFuIGNsYXNzPVxcXCJub2RlY29yXFxcIj5cIixcbiAgICAgICAgICAgIGNsb3NlcjogXCI8L3NwYW4+XCIsXG4gICAgICAgICAgICBhdHRyOiBcIkBjbGFzc1wiLFxuICAgICAgICAgICAgb3V0ZXI6IFwibm9kZWNvclwiLFxuICAgICAgICAgICAgZmxpcGZsb3A6IHtcbiAgICAgICAgICAgICAgICBcIm5vZGVjb3JcIjogXCJub2RlY29yXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgXCI8c3BhbiBzdHlsZT1cXFwiZm9udC12YXJpYW50OnNtYWxsLWNhcHM7XFxcIj5cIjoge1xuICAgICAgICAgICAgdHlwZTogXCJ0YWdcIixcbiAgICAgICAgICAgIG9wZW5lcjogXCI8c3BhbiBzdHlsZT1cXFwiZm9udC12YXJpYW50OnNtYWxsLWNhcHM7XFxcIj5cIixcbiAgICAgICAgICAgIGNsb3NlcjogXCI8L3NwYW4+XCIsXG4gICAgICAgICAgICBhdHRyOiBcIkBmb250LXZhcmlhbnRcIixcbiAgICAgICAgICAgIG91dGVyOiBcInNtYWxsLWNhcHNcIixcbiAgICAgICAgICAgIGZsaXBmbG9wOiB7XG4gICAgICAgICAgICAgICAgXCJzbWFsbC1jYXBzXCI6IFwibm9ybWFsXCIsXG4gICAgICAgICAgICAgICAgXCJub3JtYWxcIjogXCJzbWFsbC1jYXBzXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgXCI8c2M+XCI6IHtcbiAgICAgICAgICAgIHR5cGU6IFwidGFnXCIsXG4gICAgICAgICAgICBvcGVuZXI6IFwiPHNjPlwiLFxuICAgICAgICAgICAgY2xvc2VyOiBcIjwvc2M+XCIsXG4gICAgICAgICAgICBhdHRyOiBcIkBmb250LXZhcmlhbnRcIixcbiAgICAgICAgICAgIG91dGVyOiBcInNtYWxsLWNhcHNcIixcbiAgICAgICAgICAgIGZsaXBmbG9wOiB7XG4gICAgICAgICAgICAgICAgXCJzbWFsbC1jYXBzXCI6IFwibm9ybWFsXCIsXG4gICAgICAgICAgICAgICAgXCJub3JtYWxcIjogXCJzbWFsbC1jYXBzXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgXCI8aT5cIjoge1xuICAgICAgICAgICAgdHlwZTogXCJ0YWdcIixcbiAgICAgICAgICAgIG9wZW5lcjogXCI8aT5cIixcbiAgICAgICAgICAgIGNsb3NlcjogXCI8L2k+XCIsXG4gICAgICAgICAgICBhdHRyOiBcIkBmb250LXN0eWxlXCIsXG4gICAgICAgICAgICBvdXRlcjogXCJpdGFsaWNcIixcbiAgICAgICAgICAgIGZsaXBmbG9wOiB7XG4gICAgICAgICAgICAgICAgXCJpdGFsaWNcIjogXCJub3JtYWxcIixcbiAgICAgICAgICAgICAgICBcIm5vcm1hbFwiOiBcIml0YWxpY1wiXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIFwiPGI+XCI6IHtcbiAgICAgICAgICAgIHR5cGU6IFwidGFnXCIsXG4gICAgICAgICAgICBvcGVuZXI6IFwiPGI+XCIsXG4gICAgICAgICAgICBjbG9zZXI6IFwiPC9iPlwiLFxuICAgICAgICAgICAgYXR0cjogXCJAZm9udC13ZWlnaHRcIixcbiAgICAgICAgICAgIG91dGVyOiBcImJvbGRcIixcbiAgICAgICAgICAgIGZsaXBmbG9wOiB7XG4gICAgICAgICAgICAgICAgXCJib2xkXCI6IFwibm9ybWFsXCIsXG4gICAgICAgICAgICAgICAgXCJub3JtYWxcIjogXCJib2xkXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgXCI8c3VwPlwiOiB7XG4gICAgICAgICAgICB0eXBlOiBcInRhZ1wiLFxuICAgICAgICAgICAgb3BlbmVyOiBcIjxzdXA+XCIsXG4gICAgICAgICAgICBjbG9zZXI6IFwiPC9zdXA+XCIsXG4gICAgICAgICAgICBhdHRyOiBcIkB2ZXJ0aWNhbC1hbGlnblwiLFxuICAgICAgICAgICAgb3V0ZXI6IFwic3VwXCIsXG4gICAgICAgICAgICBmbGlwZmxvcDoge1xuICAgICAgICAgICAgICAgIFwic3ViXCI6IFwic3VwXCIsXG4gICAgICAgICAgICAgICAgXCJzdXBcIjogXCJzdXBcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBcIjxzdWI+XCI6IHtcbiAgICAgICAgICAgIHR5cGU6IFwidGFnXCIsXG4gICAgICAgICAgICBvcGVuZXI6IFwiPHN1Yj5cIixcbiAgICAgICAgICAgIGNsb3NlcjogXCI8L3N1Yj5cIixcbiAgICAgICAgICAgIGF0dHI6IFwiQHZlcnRpY2FsLWFsaWduXCIsXG4gICAgICAgICAgICBvdXRlcjogXCJzdWJcIixcbiAgICAgICAgICAgIGZsaXBmbG9wOiB7XG4gICAgICAgICAgICAgICAgXCJzdXBcIjogXCJzdWJcIixcbiAgICAgICAgICAgICAgICBcInN1YlwiOiBcInN1YlwiXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIFwiIFxcXCJcIjoge1xuICAgICAgICAgICAgdHlwZTogXCJxdW90ZVwiLFxuICAgICAgICAgICAgb3BlbmVyOiBcIiBcXFwiXCIsXG4gICAgICAgICAgICBjbG9zZXI6IFwiXFxcIlwiLFxuICAgICAgICAgICAgYXR0cjogXCJAcXVvdGVzXCIsXG4gICAgICAgICAgICBvdXRlcjogXCJ0cnVlXCIsXG4gICAgICAgICAgICBmbGlwZmxvcDoge1xuICAgICAgICAgICAgICAgIFwidHJ1ZVwiOiBcImlubmVyXCIsXG4gICAgICAgICAgICAgICAgXCJpbm5lclwiOiBcInRydWVcIixcbiAgICAgICAgICAgICAgICBcImZhbHNlXCI6IFwidHJ1ZVwiXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIFwiIFxcJ1wiOiB7XG4gICAgICAgICAgICB0eXBlOiBcInF1b3RlXCIsXG4gICAgICAgICAgICBvcGVuZXI6IFwiIFxcJ1wiLFxuICAgICAgICAgICAgY2xvc2VyOiBcIlxcJ1wiLFxuICAgICAgICAgICAgYXR0cjogXCJAcXVvdGVzXCIsXG4gICAgICAgICAgICBvdXRlcjogXCJpbm5lclwiLFxuICAgICAgICAgICAgZmxpcGZsb3A6IHtcbiAgICAgICAgICAgICAgICBcInRydWVcIjogXCJpbm5lclwiLFxuICAgICAgICAgICAgICAgIFwiaW5uZXJcIjogXCJ0cnVlXCIsXG4gICAgICAgICAgICAgICAgXCJmYWxzZVwiOiBcInRydWVcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIF9uZXN0aW5nRGF0YVtcIihcXFwiXCJdID0gX25lc3RpbmdEYXRhW1wiIFxcXCJcIl1cbiAgICBfbmVzdGluZ0RhdGFbXCIoXFwnXCJdID0gX25lc3RpbmdEYXRhW1wiIFxcJ1wiXVxuICAgIHZhciBsb2NhbGVPcGVuUXVvdGUgPSBzdGF0ZS5nZXRUZXJtKFwib3Blbi1xdW90ZVwiKTtcbiAgICB2YXIgbG9jYWxlQ2xvc2VRdW90ZSA9IHN0YXRlLmdldFRlcm0oXCJjbG9zZS1xdW90ZVwiKTtcbiAgICB2YXIgbG9jYWxlT3BlbklubmVyUXVvdGUgPSBzdGF0ZS5nZXRUZXJtKFwib3Blbi1pbm5lci1xdW90ZVwiKTtcbiAgICB2YXIgbG9jYWxlQ2xvc2VJbm5lclF1b3RlID0gc3RhdGUuZ2V0VGVybShcImNsb3NlLWlubmVyLXF1b3RlXCIpO1xuICAgIGlmIChsb2NhbGVPcGVuUXVvdGUgJiYgbG9jYWxlQ2xvc2VRdW90ZSAmJiBbXCIgXFxcIlwiLFwiIFxcJ1wiLFwiXFxcIlwiLFwiXFwnXCJdLmluZGV4T2YobG9jYWxlT3BlblF1b3RlKSA9PT0gLTEpIHtcbiAgICAgICAgX25lc3RpbmdEYXRhW2xvY2FsZU9wZW5RdW90ZV0gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KF9uZXN0aW5nRGF0YVtcIiBcXFwiXCJdKSk7XG4gICAgICAgIF9uZXN0aW5nRGF0YVtsb2NhbGVPcGVuUXVvdGVdLm9wZW5lciA9IGxvY2FsZU9wZW5RdW90ZTtcbiAgICAgICAgX25lc3RpbmdEYXRhW2xvY2FsZU9wZW5RdW90ZV0uY2xvc2VyID0gbG9jYWxlQ2xvc2VRdW90ZTtcbiAgICB9XG4gICAgaWYgKGxvY2FsZU9wZW5Jbm5lclF1b3RlICYmIGxvY2FsZUNsb3NlSW5uZXJRdW90ZSAmJiBbXCIgXFxcIlwiLFwiIFxcJ1wiLFwiXFxcIlwiLFwiXFwnXCJdLmluZGV4T2YobG9jYWxlT3BlbklubmVyUXVvdGUpID09PSAtMSkge1xuICAgICAgICBfbmVzdGluZ0RhdGFbbG9jYWxlT3BlbklubmVyUXVvdGVdID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShfbmVzdGluZ0RhdGFbXCIgXFwnXCJdKSk7XG4gICAgICAgIF9uZXN0aW5nRGF0YVtsb2NhbGVPcGVuSW5uZXJRdW90ZV0ub3BlbmVyID0gbG9jYWxlT3BlbklubmVyUXVvdGU7XG4gICAgICAgIF9uZXN0aW5nRGF0YVtsb2NhbGVPcGVuSW5uZXJRdW90ZV0uY2xvc2VyID0gbG9jYWxlQ2xvc2VJbm5lclF1b3RlO1xuICAgIH1cbiAgICB2YXIgX25lc3RpbmdRdW90ZVJldmVyc2UgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHJldCA9IHt9O1xuICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKF9uZXN0aW5nRGF0YSk7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldO1xuICAgICAgICAgICAgaWYgKF9uZXN0aW5nRGF0YVtrZXldLnR5cGUgPT09IFwicXVvdGVcIikge1xuICAgICAgICAgICAgICAgIHJldFtfbmVzdGluZ0RhdGFba2V5XS5jbG9zZXJdID0gX25lc3RpbmdEYXRhW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9KCk7XG4gICAgdmFyIF9uZXN0aW5nRGF0YUF0dHIgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHJldCA9IHt9O1xuICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKF9uZXN0aW5nRGF0YSk7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldO1xuICAgICAgICAgICAgaWYgKF9uZXN0aW5nRGF0YVtrZXldLnR5cGUgPT09IFwibm9jYXNlXCIpIGNvbnRpbnVlO1xuICAgICAgICAgICAgdmFyIGF0dHIgPSBfbmVzdGluZ0RhdGFba2V5XS5hdHRyO1xuICAgICAgICAgICAgdmFyIG91dGVyID0gX25lc3RpbmdEYXRhW2tleV0ub3V0ZXI7XG4gICAgICAgICAgICB2YXIgaW5uZXIgPSBfbmVzdGluZ0RhdGFba2V5XS5mbGlwZmxvcFtfbmVzdGluZ0RhdGFba2V5XS5vdXRlcl07XG4gICAgICAgICAgICByZXRbYXR0ciArIFwiL1wiICsgb3V0ZXJdID0gX25lc3RpbmdEYXRhW2tleV07XG4gICAgICAgICAgICByZXRbYXR0ciArIFwiL1wiICsgaW5uZXJdID0gX25lc3RpbmdEYXRhW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9KCk7XG4gICAgZnVuY3Rpb24gX3NldE91dGVyUXVvdGVGb3JtKHF1b3QpIHtcbiAgICAgICAgdmFyIGZsaXAgPSB7XG4gICAgICAgICAgICBcIiBcXCdcIjogXCIgXFxcIlwiLFxuICAgICAgICAgICAgXCIgXFxcIlwiOiBcIiBcXCdcIixcbiAgICAgICAgICAgIFwiKFxcXCJcIjogXCIoXFwnXCIsXG4gICAgICAgICAgICBcIihcXCdcIjogXCIoXFxcIlwiXG4gICAgICAgIH1cbiAgICAgICAgX25lc3RpbmdEYXRhW3F1b3RdLm91dGVyID0gXCJ0cnVlXCI7XG4gICAgICAgIF9uZXN0aW5nRGF0YVtmbGlwW3F1b3RdXS5vdXRlciA9IFwiaW5uZXJcIjtcbiAgICB9XG4gICAgZnVuY3Rpb24gX2dldE5lc3RpbmdPcGVuZXJQYXJhbXMob3BlbmVyKSB7XG4gICAgICAgIHZhciBvcGVuZXJzID0gW107XG4gICAgICAgIHZhciBjbG9zZXI7XG4gICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoX25lc3RpbmdEYXRhKTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07XG4gICAgICAgICAgICBpZiAoX25lc3RpbmdEYXRhW29wZW5lcl0udHlwZSAhPT0gXCJxdW90ZVwiIHx8ICFfbmVzdGluZ0RhdGFbb3BlbmVyXSkge1xuICAgICAgICAgICAgICAgIG9wZW5lcnMucHVzaChrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciByZXQgPSBfbmVzdGluZ0RhdGFbb3BlbmVyXTtcbiAgICAgICAgcmV0Lm9wZW5lciA9IG5ldyBSZWdFeHAoXCJeKD86XCIgKyBvcGVuZXJzLm1hcChmdW5jdGlvbihzdHIpe3JldHVybiBzdHIucmVwbGFjZShcIihcIiwgXCJcXFxcKFwiKX0pLmpvaW4oXCJ8XCIpICsgXCIpXCIpOyBcbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG4gICAgdmFyIF9uZXN0aW5nUGFyYW1zID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciByZXQgPSB7fTtcbiAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhfbmVzdGluZ0RhdGEpO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTtcbiAgICAgICAgICAgIHJldFtrZXldID0gX2dldE5lc3RpbmdPcGVuZXJQYXJhbXMoa2V5KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH0oKVxuICAgIHZhciBfdGFnUmV4ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBvcGVuZXJzID0gW107XG4gICAgICAgIHZhciBjbG9zZXJzID0gW107XG4gICAgICAgIHZhciB2YWxzID0ge307XG4gICAgICAgIGZvciAodmFyIG9wZW5lciBpbiBfbmVzdGluZ1BhcmFtcykge1xuICAgICAgICAgICAgb3BlbmVycy5wdXNoKG9wZW5lcik7XG4gICAgICAgICAgICB2YWxzW19uZXN0aW5nUGFyYW1zW29wZW5lcl0uY2xvc2VyXSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh2YWxzKTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgdmFyIGNsb3NlciA9IGtleXNbaV07XG4gICAgICAgICAgICBjbG9zZXJzLnB1c2goY2xvc2VyKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgYWxsID0gb3BlbmVycy5jb25jYXQoY2xvc2VycykubWFwKGZ1bmN0aW9uKHN0cil7cmV0dXJuIHN0ci5yZXBsYWNlKFwiKFwiLCBcIlxcXFwoXCIpfSkuam9pbihcInxcIik7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBtYXRjaEFsbDogbmV3IFJlZ0V4cChcIigoPzpcIiArIGFsbCArIFwiKSlcIiwgXCJnXCIpLFxuICAgICAgICAgICAgc3BsaXRBbGw6IG5ldyBSZWdFeHAoXCIoPzpcIiArIGFsbCArIFwiKVwiLCBcImdcIiksXG4gICAgICAgICAgICBvcGVuOiBuZXcgUmVnRXhwKFwiKF4oPzpcIiArIG9wZW5lcnMubWFwKGZ1bmN0aW9uKHN0cil7cmV0dXJuIHN0ci5yZXBsYWNlKFwiKFwiLCBcIlxcXFwoXCIpfSkuam9pbihcInxcIikgKyBcIikkKVwiKSxcbiAgICAgICAgICAgIGNsb3NlOiBuZXcgUmVnRXhwKFwiKF4oPzpcIiArIGNsb3NlcnMuam9pbihcInxcIikgKyBcIikkKVwiKSxcbiAgICAgICAgfVxuICAgIH0oKTtcbiAgICBmdW5jdGlvbiBfbmVzdGluZ0ZpeCAodGFnLCBwb3MpIHtcbiAgICAgICAgcmV0dXJuIF9wdXNoTmVzdGluZ1N0YXRlKHRhZywgcG9zKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gX3B1c2hOZXN0aW5nU3RhdGUodGFnLCBwb3MpIHtcbiAgICAgICAgaWYgKHRhZy5tYXRjaChfdGFnUmV4Lm9wZW4pKSB7XG4gICAgICAgICAgICByZXR1cm4gX3RyeU9wZW4odGFnLCBwb3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIF90cnlDbG9zZSh0YWcsIHBvcyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gX3RyeU9wZW4odGFnLCBwb3MpIHtcbiAgICAgICAgdmFyIHBhcmFtcyA9IF9uZXN0aW5nU3RhdGVbX25lc3RpbmdTdGF0ZS5sZW5ndGggLSAxXTtcbiAgICAgICAgaWYgKCFwYXJhbXMgfHwgdGFnLm1hdGNoKHBhcmFtcy5vcGVuZXIpKSB7XG4gICAgICAgICAgICBfbmVzdGluZ1N0YXRlLnB1c2goe1xuICAgICAgICAgICAgICAgIHR5cGU6IF9uZXN0aW5nUGFyYW1zW3RhZ10udHlwZSxcbiAgICAgICAgICAgICAgICBvcGVuZXI6IF9uZXN0aW5nUGFyYW1zW3RhZ10ub3BlbmVyLFxuICAgICAgICAgICAgICAgIGNsb3NlcjogX25lc3RpbmdQYXJhbXNbdGFnXS5jbG9zZXIsXG4gICAgICAgICAgICAgICAgcG9zOiBwb3NcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgX25lc3RpbmdTdGF0ZS5wb3AoKVxuICAgICAgICAgICAgX25lc3RpbmdTdGF0ZS5wdXNoKHtcbiAgICAgICAgICAgICAgICB0eXBlOiBfbmVzdGluZ1BhcmFtc1t0YWddLnR5cGUsXG4gICAgICAgICAgICAgICAgb3BlbmVyOiBfbmVzdGluZ1BhcmFtc1t0YWddLm9wZW5lcixcbiAgICAgICAgICAgICAgICBjbG9zZXI6IF9uZXN0aW5nUGFyYW1zW3RhZ10uY2xvc2VyLFxuICAgICAgICAgICAgICAgIHBvczogcG9zXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgZml4dGFnOiBwYXJhbXMucG9zXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIF90cnlDbG9zZSh0YWcsIHBvcykge1xuICAgICAgICB2YXIgcGFyYW1zID0gX25lc3RpbmdTdGF0ZVtfbmVzdGluZ1N0YXRlLmxlbmd0aCAtIDFdO1xuICAgICAgICBpZiAocGFyYW1zICYmIHRhZyA9PT0gcGFyYW1zLmNsb3Nlcikge1xuICAgICAgICAgICAgX25lc3RpbmdTdGF0ZS5wb3AoKVxuICAgICAgICAgICAgaWYgKHBhcmFtcy50eXBlID09PSBcIm5vY2FzZVwiKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgbm9jYXNlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcGVuOiBwYXJhbXMucG9zLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2U6IHBvc1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgZml4dGFnOiBwYXJhbXMucG9zXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgZml4dGFnOiBwb3NcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIF9kb3BwZWxTdHJpbmcoc3RyKSB7XG4gICAgICAgIHZhciBmb3JjZWRTcGFjZXMgPSBbXTtcbiAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoLyg8c3BhbilcXHMrKHN0eWxlPVxcXCJmb250LXZhcmlhbnQ6KVxccyooc21hbGwtY2Fwcyk7P1xcXCJbXj5dKig+KS9nLCBcIiQxICQyJDM7XFxcIiQ0XCIpO1xuICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgvKDxzcGFuKVxccysoY2xhc3M9XFxcIm5vKD86Y2FzZXxkZWNvcilcXFwiKVtePl0qKD4pL2csIFwiJDEgJDIkM1wiKTtcbiAgICAgICAgdmFyIG1hdGNoID0gc3RyLm1hdGNoKF90YWdSZXgubWF0Y2hBbGwpO1xuICAgICAgICBpZiAoIW1hdGNoKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHRhZ3M6IFtdLFxuICAgICAgICAgICAgICAgIHN0cmluZ3M6IFtzdHJdLFxuICAgICAgICAgICAgICAgIGZvcmNlZFNwYWNlczogW11cbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHNwbGl0ID0gc3RyLnNwbGl0KF90YWdSZXguc3BsaXRBbGwpO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1tYXRjaC5sZW5ndGgtMTtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICBpZiAoX25lc3RpbmdEYXRhW21hdGNoW2ldXSkge1xuICAgICAgICAgICAgICAgIGlmIChzcGxpdFtpKzFdID09PSBcIlwiICYmIFtcIlxcXCJcIiwgXCInXCJdLmluZGV4T2YobWF0Y2hbaSsxXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBtYXRjaFtpKzFdID0gXCIgXCIgKyBtYXRjaFtpKzFdXG4gICAgICAgICAgICAgICAgICAgIGZvcmNlZFNwYWNlcy5wdXNoKHRydWUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZvcmNlZFNwYWNlcy5wdXNoKGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRhZ3M6IG1hdGNoLFxuICAgICAgICAgICAgc3RyaW5nczogc3BsaXQsXG4gICAgICAgICAgICBmb3JjZWRTcGFjZXM6IGZvcmNlZFNwYWNlc1xuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIF91bmRvcHBlbFN0cmluZyhvYmopIHtcbiAgICAgICAgdmFyIGxzdCA9IG9iai5zdHJpbmdzLnNsaWNlKC0xKTtcbiAgICAgICAgZm9yICh2YXIgaT1vYmoudGFncy5sZW5ndGgtMTsgaT4tMTsgaSs9LTEpIHtcbiAgICAgICAgICAgIGxzdC5wdXNoKG9iai50YWdzW2ldKTtcbiAgICAgICAgICAgIGxzdC5wdXNoKG9iai5zdHJpbmdzW2ldKTtcbiAgICAgICAgfVxuICAgICAgICBsc3QucmV2ZXJzZSgpO1xuICAgICAgICByZXR1cm4gbHN0LmpvaW4oXCJ8XCIpO1xuICAgIH1cbiAgICB2YXIgX1RhZ1JlZyA9IGZ1bmN0aW9uKGJsb2IpIHtcbiAgICAgICAgdGhpcy5zZXQgPSBzZXQ7XG4gICAgICAgIHRoaXMucGFpciA9IHBhaXI7XG4gICAgICAgIHRoaXMucG9wID0gcG9wO1xuICAgICAgICB2YXIgX3N0YWNrID0gW107XG4gICAgICAgIGZ1bmN0aW9uIHNldCh0YWcpIHtcbiAgICAgICAgICAgIHZhciBhdHRyID0gX25lc3RpbmdEYXRhW3RhZ10uYXR0cjtcbiAgICAgICAgICAgIHZhciBkZWNvciA9IG51bGw7XG4gICAgICAgICAgICBmb3IgKHZhciBpPV9zdGFjay5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICAgICAgICAgIHZhciBfZGVjb3IgPSBfc3RhY2tbaV07XG4gICAgICAgICAgICAgICAgaWYgKF9kZWNvclswXSA9PT0gYXR0cikge1xuICAgICAgICAgICAgICAgICAgICBkZWNvciA9IF9kZWNvcjtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFkZWNvcikge1xuICAgICAgICAgICAgICAgIHZhciBhbGxUaGVEZWNvciA9IFtzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0LmxheW91dF9kZWNvcmF0aW9uc10uY29uY2F0KGJsb2IuYWxsZGVjb3IpXG4gICAgICAgICAgICAgICAgb3V0ZXI6XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaT1hbGxUaGVEZWNvci5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGVjb3JzZXQgPSBhbGxUaGVEZWNvcltpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFkZWNvcnNldCkgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGo9ZGVjb3JzZXQubGVuZ3RoLTE7aj4tMTtqLS0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZGVjb3IgPSBkZWNvcnNldFtqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZGVjb3JbMF0gPT09IGF0dHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNvciA9IF9kZWNvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghZGVjb3IpIHtcbiAgICAgICAgICAgICAgICBkZWNvciA9IFthdHRyLCBfbmVzdGluZ0RhdGFbdGFnXS5vdXRlcl07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRlY29yID0gW2F0dHIsIF9uZXN0aW5nRGF0YVt0YWddLmZsaXBmbG9wW2RlY29yWzFdXV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfc3RhY2sucHVzaChkZWNvcik7XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gcGFpcigpIHtcbiAgICAgICAgICAgIHJldHVybiBfc3RhY2tbX3N0YWNrLmxlbmd0aC0xXTtcbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiBwb3AoKSB7XG4gICAgICAgICAgICBfc3RhY2sucG9wKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gX2Fwb3N0cm9waGVGb3JjZSh0YWcsIHN0cikge1xuICAgICAgICBpZiAodGFnID09PSBcIlxcJ1wiKSB7XG4gICAgICAgICAgICBpZiAoc3RyICYmIHN0ci5tYXRjaCgvXlteXFwsXFwuXFw/XFw6XFw7XFwgXS8pKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBcIiBcXCdcIiAmJiBzdHIgJiYgc3RyLm1hdGNoKC9eW1xcIF0vKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmdW5jdGlvbiBfdW5kb3BwZWxUb1F1ZXVlKGJsb2IsIGRvcHBlbCwgbGVhZGluZ1NwYWNlKSB7XG4gICAgICAgIHZhciBUT1AgPSBibG9iO1xuICAgICAgICB2YXIgZmlyc3RTdHJpbmcgPSB0cnVlO1xuICAgICAgICB2YXIgdGFnUmVnID0gbmV3IF9UYWdSZWcoYmxvYik7XG4gICAgICAgIGJsb2IuYmxvYnMgPSBbXTtcbiAgICAgICAgZnVuY3Rpb24gU3RhY2sgKGJsb2IpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBbYmxvYl07XG4gICAgICAgICAgICB0aGlzLmxhdGVzdCA9IGJsb2I7XG4gICAgICAgICAgICB0aGlzLmFkZFN0eWxpbmcgPSBmdW5jdGlvbihzdHIsIGRlY29yLCBmb3JjZWRTcGFjZSkge1xuICAgICAgICAgICAgICAgIGlmIChmaXJzdFN0cmluZykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RyLnNsaWNlKDAsIDEpID09PSBcIiBcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdHIuc2xpY2UoMCwgMSkgPT09IFwiIFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZmlyc3RTdHJpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5sYXRlc3QgPSB0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoLTFdO1xuICAgICAgICAgICAgICAgIGlmIChkZWNvcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHRoaXMubGF0ZXN0LmJsb2JzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBuZXcgQ1NMLkJsb2IoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLmJsb2JzID0gdGhpcy5sYXRlc3QuYmxvYnM7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5hbGxkZWNvciA9IHRoaXMubGF0ZXN0LmFsbGRlY29yLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhdGVzdC5ibG9icyA9IFtjaGlsZF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIHRvayA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld2Jsb2IgPSBuZXcgQ1NMLkJsb2IobnVsbCwgdG9rKTtcbiAgICAgICAgICAgICAgICAgICAgbmV3YmxvYi5hbGxkZWNvciA9IHRoaXMubGF0ZXN0LmFsbGRlY29yLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkZWNvclswXSA9PT0gXCJAY2xhc3NcIiAmJiBkZWNvclsxXSA9PT0gXCJub2RlY29yXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdkZWNvcnNldCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlZW4gPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbGxUaGVEZWNvciA9IFtzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0LmxheW91dF9kZWNvcmF0aW9uc10uY29uY2F0KG5ld2Jsb2IuYWxsZGVjb3IpXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpPWFsbFRoZURlY29yLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9kZWNvcnNldCA9IGFsbFRoZURlY29yW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghX2RlY29yc2V0KSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqPV9kZWNvcnNldC5sZW5ndGgtMTtqPi0xO2otLSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgX29sZGRlY29yID0gX2RlY29yc2V0W2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoW1wiQGZvbnQtd2VpZ2h0XCIsIFwiQGZvbnQtc3R5bGVcIiwgXCJAZm9udC12YXJpYW50XCJdLmluZGV4T2YoX29sZGRlY29yWzBdKSA+IC0xXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAhc2Vlbltfb2xkZGVjb3JbMF1dKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVjb3JbMV0gIT09IFwibm9ybWFsXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdibG9iLmRlY29yYXRpb25zLnB1c2goW19vbGRkZWNvclswXSwgXCJub3JtYWxcIl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld2RlY29yc2V0LnB1c2goW19vbGRkZWNvclswXSwgXCJub3JtYWxcIl0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWVuW19vbGRkZWNvclswXV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3YmxvYi5hbGxkZWNvci5wdXNoKG5ld2RlY29yc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld2Jsb2IuZGVjb3JhdGlvbnMucHVzaChkZWNvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdibG9iLmFsbGRlY29yLnB1c2goW2RlY29yXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXRlc3QuYmxvYnMucHVzaChuZXdibG9iKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFjay5wdXNoKG5ld2Jsb2IpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxhdGVzdCA9IG5ld2Jsb2I7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2sgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3YmxvYiA9IG5ldyBDU0wuQmxvYihudWxsLCB0b2spO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3YmxvYi5ibG9icyA9IHN0cjtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld2Jsb2IuYWxsZGVjb3IgPSB0aGlzLmxhdGVzdC5hbGxkZWNvci5zbGljZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXRlc3QuYmxvYnMucHVzaChuZXdibG9iKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5ldyBDU0wuQmxvYigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuYmxvYnMgPSBzdHI7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5hbGxkZWNvciA9IHRoaXMubGF0ZXN0LmFsbGRlY29yLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhdGVzdC5ibG9icy5wdXNoKGNoaWxkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucG9wU3R5bGluZyA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhY2sucG9wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHZhciBzdGFjayA9IG5ldyBTdGFjayhibG9iKTtcbiAgICAgICAgaWYgKGRvcHBlbC5zdHJpbmdzLmxlbmd0aCkge1xuICAgICAgICAgICAgdmFyIHN0ciA9IGRvcHBlbC5zdHJpbmdzWzBdO1xuICAgICAgICAgICAgaWYgKGxlYWRpbmdTcGFjZSkge1xuICAgICAgICAgICAgICAgIHN0ciA9IFwiIFwiICsgc3RyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhY2suYWRkU3R5bGluZyhzdHIpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWRvcHBlbC50YWdzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICB2YXIgdGFnID0gZG9wcGVsLnRhZ3NbaV07XG4gICAgICAgICAgICB2YXIgc3RyID0gZG9wcGVsLnN0cmluZ3NbaSsxXTtcbiAgICAgICAgICAgIGlmICh0YWcubWF0Y2goX3RhZ1JleC5vcGVuKSkge1xuICAgICAgICAgICAgICAgIHRhZ1JlZy5zZXQodGFnKTtcbiAgICAgICAgICAgICAgICBzdGFjay5hZGRTdHlsaW5nKHN0ciwgdGFnUmVnLnBhaXIoKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRhZ1JlZy5wb3AoKTtcbiAgICAgICAgICAgICAgICBzdGFjay5wb3BTdHlsaW5nKCk7XG4gICAgICAgICAgICAgICAgc3RhY2suYWRkU3R5bGluZyhzdHIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIHByb2Nlc3NUYWdzKGJsb2IpIHtcbiAgICAgICAgdmFyIHN0ciA9IGJsb2IuYmxvYnM7XG4gICAgICAgIHZhciBsZWFkaW5nU3BhY2UgPSBmYWxzZTtcbiAgICAgICAgaWYgKHN0ci5zbGljZSgwLCAxKSA9PT0gXCIgXCIgJiYgIXN0ci5tYXRjaCgvXlxccytbXFwnXFxcIl0vKSkge1xuICAgICAgICAgICAgbGVhZGluZ1NwYWNlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcmV4ID0gbmV3IFJlZ0V4cChcIihcIiArIENTTC5ST01BTkVTUVVFX1JFR0VYUC5zb3VyY2UgKyBcIilcXHUyMDE5KFwiICsgQ1NMLlJPTUFORVNRVUVfUkVHRVhQLnNvdXJjZSArIFwiKVwiLCBcImdcIilcbiAgICAgICAgdmFyIHN0ciA9IFwiIFwiICsgc3RyLnJlcGxhY2UocmV4LCBcIiQxXFwnJDJcIik7XG4gICAgICAgIHZhciBkb3BwZWwgPSBfZG9wcGVsU3RyaW5nKHN0cik7XG4gICAgICAgIGlmIChkb3BwZWwudGFncy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgdmFyIHF1b3RlRm9ybVNlZW4gPSBmYWxzZTtcbiAgICBcdGZvciAodmFyIGk9MCxpbGVuPWRvcHBlbC50YWdzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICB2YXIgdGFnID0gZG9wcGVsLnRhZ3NbaV07XG4gICAgICAgICAgICB2YXIgc3RyID0gZG9wcGVsLnN0cmluZ3NbaSsxXTtcbiAgICAgICAgICAgIGlmIChfYXBvc3Ryb3BoZUZvcmNlKHRhZywgc3RyKSkge1xuICAgICAgICAgICAgICAgIGlmICh0YWcgPT09IFwiIFxcJ1wiKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvcHBlbC5zdHJpbmdzW2krMV0gPSBcIiBcXHUyMDE5XCIgKyBkb3BwZWwuc3RyaW5nc1tpKzFdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRvcHBlbC5zdHJpbmdzW2krMV0gPSBcIlxcdTIwMTlcIiArIGRvcHBlbC5zdHJpbmdzW2krMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGRvcHBlbC50YWdzW2ldID0gXCJcIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIHRhZ0luZm87XG4gICAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGFnSW5mbyA9IF9uZXN0aW5nRml4KHRhZywgaSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0YWdJbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXModGFnSW5mbykuaW5kZXhPZihcImZpeHRhZ1wiKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhZy5tYXRjaChfdGFnUmV4LmNsb3NlKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiB0YWcgPT09IFwiXFwnXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9wcGVsLnN0cmluZ3NbaSsxXSA9IFwiXFx1MjAxOVwiICsgZG9wcGVsLnN0cmluZ3NbaSsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9wcGVsLnRhZ3NbaV0gPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmYWlsZWRUYWcgPSBkb3BwZWwudGFnc1t0YWdJbmZvLmZpeHRhZ107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb3BwZWwuZm9yY2VkU3BhY2VzW3RhZ0luZm8uZml4dGFnLTFdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWRUYWcgPSBmYWlsZWRUYWcuc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9wcGVsLnN0cmluZ3NbdGFnSW5mby5maXh0YWcrMV0gPSBmYWlsZWRUYWcgKyBkb3BwZWwuc3RyaW5nc1t0YWdJbmZvLmZpeHRhZysxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9wcGVsLnRhZ3NbdGFnSW5mby5maXh0YWddID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9uZXN0aW5nU3RhdGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfbmVzdGluZ1N0YXRlLnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnSW5mby5ub2Nhc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3BwZWwudGFnc1t0YWdJbmZvLm5vY2FzZS5vcGVuXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9wcGVsLnRhZ3NbdGFnSW5mby5ub2Nhc2UuY2xvc2VdID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGFnSW5mbyAmJiAodGFnSW5mby5maXh0YWd8fCB0YWdJbmZvLmZpeHRhZyA9PT0gMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9wcGVsLnN0cmluZ3NbaSsxXSA9IGRvcHBlbC50YWdzW2ldICsgZG9wcGVsLnN0cmluZ3NbaSsxXTtcbiAgICAgICAgICAgICAgICAgICAgZG9wcGVsLnRhZ3NbaV0gPSBcIlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBpPV9uZXN0aW5nU3RhdGUubGVuZ3RoLTE7aT4tMTtpLS0pIHtcbiAgICAgICAgICAgIHZhciB0YWdQb3MgPSBfbmVzdGluZ1N0YXRlW2ldLnBvc1xuICAgICAgICAgICAgdmFyIHRhZyA9IGRvcHBlbC50YWdzW3RhZ1Bvc107XG4gICAgICAgICAgICBpZiAodGFnID09PSBcIiBcXCdcIiB8fCB0YWcgPT09IFwiXFwnXCIpIHtcbiAgICAgICAgICAgICAgICBkb3BwZWwuc3RyaW5nc1t0YWdQb3MrMV0gPSBcIiBcXHUyMDE5XCIgKyBkb3BwZWwuc3RyaW5nc1t0YWdQb3MrMV07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRvcHBlbC5zdHJpbmdzW3RhZ1BvcysxXSA9IGRvcHBlbC50YWdzW3RhZ1Bvc10gKyBkb3BwZWwuc3RyaW5nc1t0YWdQb3MrMV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkb3BwZWwudGFnc1t0YWdQb3NdID0gXCJcIjtcbiAgICAgICAgICAgIF9uZXN0aW5nU3RhdGUucG9wKCk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaT1kb3BwZWwudGFncy5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICAgICAgaWYgKCFkb3BwZWwudGFnc1tpXSkge1xuICAgICAgICAgICAgICAgIGRvcHBlbC50YWdzID0gZG9wcGVsLnRhZ3Muc2xpY2UoMCxpKS5jb25jYXQoZG9wcGVsLnRhZ3Muc2xpY2UoaSsxKSk7XG4gICAgICAgICAgICAgICAgZG9wcGVsLnN0cmluZ3NbaV0gPSBkb3BwZWwuc3RyaW5nc1tpXSArIGRvcHBlbC5zdHJpbmdzW2krMV07XG4gICAgICAgICAgICAgICAgZG9wcGVsLnN0cmluZ3MgPSBkb3BwZWwuc3RyaW5ncy5zbGljZSgwLGkrMSkuY29uY2F0KGRvcHBlbC5zdHJpbmdzLnNsaWNlKGkrMikpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWRvcHBlbC50YWdzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICB2YXIgdGFnID0gZG9wcGVsLnRhZ3NbaV07XG4gICAgICAgICAgICB2YXIgZm9yY2VkU3BhY2UgPSBkb3BwZWwuZm9yY2VkU3BhY2VzW2ktMV07XG4gICAgICAgICAgICBpZiAoW1wiIFxcXCJcIiwgXCIgXFwnXCIsIFwiKFxcXCJcIiwgXCIoXFwnXCJdLmluZGV4T2YodGFnKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFxdW90ZUZvcm1TZWVuKSB7XG4gICAgICAgICAgICAgICAgICAgIF9zZXRPdXRlclF1b3RlRm9ybSh0YWcpO1xuICAgICAgICAgICAgICAgICAgICBxdW90ZUZvcm1TZWVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFmb3JjZWRTcGFjZSkge1xuICAgICAgICAgICAgICAgICAgICBkb3BwZWwuc3RyaW5nc1tpXSArPSB0YWcuc2xpY2UoMCwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIF91bmRvcHBlbFRvUXVldWUoYmxvYiwgZG9wcGVsLCBsZWFkaW5nU3BhY2UpO1xuICAgIH1cbn1cbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzID0gbmV3IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnBhc3N0aHJvdWdoID0gcGFzc3Rocm91Z2g7XG4gICAgdGhpcy5sb3dlcmNhc2UgPSBsb3dlcmNhc2U7XG4gICAgdGhpcy51cHBlcmNhc2UgPSB1cHBlcmNhc2U7XG4gICAgdGhpcy5zZW50ZW5jZSA9IHNlbnRlbmNlO1xuICAgIHRoaXMudGl0bGUgPSB0aXRsZTtcbiAgICB0aGlzW1wiY2FwaXRhbGl6ZS1maXJzdFwiXSA9IGNhcGl0YWxpemVGaXJzdDtcbiAgICB0aGlzW1wiY2FwaXRhbGl6ZS1hbGxcIl0gPSBjYXBpdGFsaXplQWxsO1xuICAgIHZhciByZXhTdHIgPSBcIig/OlxcdTIwMTh8XFx1MjAxOXxcXHUyMDFDfFxcdTIwMUR8IFxcXCJ8IFxcJ3xcXFwifFxcJ3xbLVxcdTIwMTNcXHUyMDE0XFwvLiw7PyE6XXxcXFxcW3xcXFxcXXxcXFxcKHxcXFxcKXw8c3BhbiBzdHlsZT1cXFwiZm9udC12YXJpYW50OiBzbWFsbC1jYXBzO1xcXCI+fDxzcGFuIGNsYXNzPVxcXCJubyg/OmNhc2V8ZGVjb3IpXFxcIj58PFxcL3NwYW4+fDxcXC8/KD86aXxzY3xifHN1YnxzdXApPilcIjtcbiAgICB2YXIgdGFnRG9wcGVsID0gbmV3IENTTC5Eb3BwZWxlcihyZXhTdHIsIGZ1bmN0aW9uKHN0cikge1xuICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyg8c3BhbilcXHMrKGNsYXNzPVxcXCJubyg/OmNhc2V8ZGVjb3IpXFxcIilbXj5dKig+KS9nLCBcIiQxICQyJDNcIikucmVwbGFjZSgvKDxzcGFuKVxccysoc3R5bGU9XFxcImZvbnQtdmFyaWFudDopXFxzKihzbWFsbC1jYXBzKTs/KFxcXCIpW14+XSooPikvZywgXCIkMSAkMiAkMzskNCQ1XCIpO1xuICAgIH0pO1xuICAgIHZhciB3b3JkRG9wcGVsID0gbmV3IENTTC5Eb3BwZWxlcihcIig/OltcXHUwMDIwXFx1MDBBMFxcdTIwMDAtXFx1MjAwQlxcdTIwNUZcXHUzMDAwXSspXCIpO1xuICAgIHZhciBfdGFnUGFyYW1zID0ge1xuICAgICAgICBcIjxzcGFuIHN0eWxlPVxcXCJmb250LXZhcmlhbnQ6IHNtYWxsLWNhcHM7XFxcIj5cIjogXCI8L3NwYW4+XCIsXG4gICAgICAgIFwiPHNwYW4gY2xhc3M9XFxcIm5vY2FzZVxcXCI+XCI6IFwiPC9zcGFuPlwiLFxuICAgICAgICBcIjxzcGFuIGNsYXNzPVxcXCJub2RlY29yXFxcIj5cIjogXCI8L3NwYW4+XCJcbiAgICB9XG4gICAgZnVuY3Rpb24gX2NhcGl0YWxpc2UgKHdvcmQsIGZvcmNlKSB7XG4gICAgICAgIHZhciBtID0gd29yZC5tYXRjaCgvKF5cXHMqKSgoPzpbXFwwLVxcdFxceDBCXFxmXFx4MEUtXFx1MjAyN1xcdTIwMkEtXFx1RDdGRlxcdUUwMDAtXFx1RkZGRl18W1xcdUQ4MDAtXFx1REJGRl1bXFx1REMwMC1cXHVERkZGXXxbXFx1RDgwMC1cXHVEQkZGXSg/IVtcXHVEQzAwLVxcdURGRkZdKXwoPzpbXlxcdUQ4MDAtXFx1REJGRl18XilbXFx1REMwMC1cXHVERkZGXSkpKC4qKS8pO1xuICAgICAgICBpZiAobSAmJiAhKG1bMl0ubWF0Y2goL15bXFx1MDM3MC1cXHUwM0ZGXSQvKSAmJiAhbVszXSkpIHtcbiAgICAgICAgICAgIHJldHVybiBtWzFdICsgbVsyXS50b1VwcGVyQ2FzZSgpICsgbVszXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gd29yZDtcbiAgICB9XG4gICAgZnVuY3Rpb24gX3RleHRjYXNlRW5naW5lKGNvbmZpZywgc3RyaW5nKSB7XG4gICAgICAgIGlmICghc3RyaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICBjb25maWcuZG9wcGVsID0gdGFnRG9wcGVsLnNwbGl0KHN0cmluZyk7XG4gICAgICAgIHZhciBxdW90ZVBhcmFtcyA9IHtcbiAgICAgICAgICAgIFwiIFxcXCJcIjoge1xuICAgICAgICAgICAgICAgIG9wZW5lcjogXCIgXFwnXCIsXG4gICAgICAgICAgICAgICAgY2xvc2VyOiBcIlxcXCJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwiIFxcJ1wiOiB7XG4gICAgICAgICAgICAgICAgb3BlbmVyOiBcIiBcXFwiXCIsXG4gICAgICAgICAgICAgICAgY2xvc2VyOiBcIlxcJ1wiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJcXHUyMDE4XCI6IHtcbiAgICAgICAgICAgICAgICBvcGVuZXI6IFwiXFx1MjAxOFwiLFxuICAgICAgICAgICAgICAgIGNsb3NlcjogXCJcXHUyMDE5XCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBcIlxcdTIwMUNcIjoge1xuICAgICAgICAgICAgICAgIG9wZW5lcjogXCJcXHUyMDFDXCIsXG4gICAgICAgICAgICAgICAgY2xvc2VyOiBcIlxcdTIwMURcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiBxdW90ZUZpeCAodGFnLCBwb3NpdGlvbnMpIHtcbiAgICAgICAgICAgIHZhciBtID0gdGFnLm1hdGNoKC8oXig/OlxcdTIwMTh8XFx1MjAxOXxcXHUyMDFDfFxcdTIwMUR8XFxcInxcXCcpfCg/OiBcXFwifCBcXCcpJCkvKTtcbiAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHB1c2hRdW90ZVN0YXRlKG1bMV0sIHBvc2l0aW9ucyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gcHVzaFF1b3RlU3RhdGUodGFnLCBwb3MpIHtcbiAgICAgICAgICAgIHZhciBpc09wZW5lciA9IFtcIlxcdTIwMUNcIiwgXCJcXHUyMDE4XCIsIFwiIFxcXCJcIiwgXCIgXFwnXCJdLmluZGV4T2YodGFnKSA+IC0xID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGlzT3BlbmVyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRyeU9wZW4odGFnLCBwb3MpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ5Q2xvc2UodGFnLCBwb3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZ1bmN0aW9uIHRyeU9wZW4odGFnLCBwb3MpIHtcbiAgICAgICAgICAgIGlmIChjb25maWcucXVvdGVTdGF0ZS5sZW5ndGggPT09IDAgfHwgdGFnID09PSBjb25maWcucXVvdGVTdGF0ZVtjb25maWcucXVvdGVTdGF0ZS5sZW5ndGggLSAxXS5vcGVuZXIpIHtcbiAgICAgICAgICAgICAgICBjb25maWcucXVvdGVTdGF0ZS5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgb3BlbmVyOiBxdW90ZVBhcmFtc1t0YWddLm9wZW5lcixcbiAgICAgICAgICAgICAgICAgICAgY2xvc2VyOiBxdW90ZVBhcmFtc1t0YWddLmNsb3NlcixcbiAgICAgICAgICAgICAgICAgICAgcG9zOiBwb3NcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBwcmV2UG9zID0gY29uZmlnLnF1b3RlU3RhdGVbY29uZmlnLnF1b3RlU3RhdGUubGVuZ3RoLTFdLnBvcztcbiAgICAgICAgICAgICAgICBjb25maWcucXVvdGVTdGF0ZS5wb3AoKVxuICAgICAgICAgICAgICAgIGNvbmZpZy5xdW90ZVN0YXRlLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBvcGVuZXI6IHF1b3RlUGFyYW1zW3RhZ10ub3BlbmVyLFxuICAgICAgICAgICAgICAgICAgICBjbG9zZXI6IHF1b3RlUGFyYW1zW3RhZ10uY2xvc2VyLFxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbnM6IHBvc1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2UG9zO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZ1bmN0aW9uIHRyeUNsb3NlKHRhZywgcG9zKSB7XG4gICAgICAgICAgICBpZiAoY29uZmlnLnF1b3RlU3RhdGUubGVuZ3RoID4gMCAmJiB0YWcgPT09IGNvbmZpZy5xdW90ZVN0YXRlW2NvbmZpZy5xdW90ZVN0YXRlLmxlbmd0aCAtIDFdLmNsb3Nlcikge1xuICAgICAgICAgICAgICAgIGNvbmZpZy5xdW90ZVN0YXRlLnBvcCgpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBwb3M7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbmZpZy5kb3BwZWwuc3RyaW5ncy5sZW5ndGggJiYgY29uZmlnLmRvcHBlbC5zdHJpbmdzWzBdLnRyaW0oKSkge1xuICAgICAgICAgICAgY29uZmlnLmRvcHBlbC5zdHJpbmdzWzBdID0gY29uZmlnLmNhcGl0YWxpc2VXb3Jkcyhjb25maWcuZG9wcGVsLnN0cmluZ3NbMF0sIDAsIGNvbmZpZy5kb3BwZWwudGFnc1swXSk7XG4gICAgICAgIH1cbiAgICBcdGZvciAodmFyIGk9MCxpbGVuPWNvbmZpZy5kb3BwZWwudGFncy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgdmFyIHRhZyA9IGNvbmZpZy5kb3BwZWwudGFnc1tpXTtcbiAgICAgICAgICAgIHZhciBzdHIgPSBjb25maWcuZG9wcGVsLnN0cmluZ3NbaSsxXTtcbiAgICAgICAgICAgIGlmIChjb25maWcudGFnU3RhdGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBpZiAoX3RhZ1BhcmFtc1t0YWddKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy50YWdTdGF0ZS5wdXNoKF90YWdQYXJhbXNbdGFnXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb25maWcudGFnU3RhdGUubGVuZ3RoICYmIHRhZyA9PT0gY29uZmlnLnRhZ1N0YXRlW2NvbmZpZy50YWdTdGF0ZS5sZW5ndGggLSAxXSkge1xuICAgICAgICAgICAgICAgICAgICBjb25maWcudGFnU3RhdGUucG9wKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNvbmZpZy5hZnRlclB1bmN0ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRhZy5tYXRjaCgvW1xcIVxcP1xcOl0kLykpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmFmdGVyUHVuY3QgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb25maWcudGFnU3RhdGUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnLmRvcHBlbC5zdHJpbmdzW2krMV0gPSBjb25maWcuY2FwaXRhbGlzZVdvcmRzKHN0ciwgaSsxLCBjb25maWcuZG9wcGVsLGNvbmZpZy5kb3BwZWwudGFnc1tpKzFdKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLmRvcHBlbC5zdHJpbmdzW2krMV0udHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnLmxhc3RXb3JkUG9zID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb25maWcucXVvdGVTdGF0ZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHZhciBxdW90ZVBvcyA9IHF1b3RlRml4KHRhZywgaSk7XG4gICAgICAgICAgICAgICAgaWYgKHF1b3RlUG9zIHx8IHF1b3RlUG9zID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBvcmlnQ2hhciA9IGNvbmZpZy5kb3BwZWwub3JpZ1N0cmluZ3NbcXVvdGVQb3MrMV0uc2xpY2UoMCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy5kb3BwZWwuc3RyaW5nc1txdW90ZVBvcysxXSA9IG9yaWdDaGFyICsgY29uZmlnLmRvcHBlbC5zdHJpbmdzW3F1b3RlUG9zKzFdLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICBjb25maWcubGFzdFdvcmRQb3MgPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb25maWcuaXNGaXJzdCkge1xuICAgICAgICAgICAgICAgIGlmIChzdHIudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy5pc0ZpcnN0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNvbmZpZy5hZnRlclB1bmN0KSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0ci50cmltKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmFmdGVyUHVuY3QgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbmZpZy5xdW90ZVN0YXRlKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1jb25maWcucXVvdGVTdGF0ZS5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgIHZhciBxdW90ZVBvcyA9IGNvbmZpZy5xdW90ZVN0YXRlW2ldLnBvcztcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHF1b3RlUG9zICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ0NoYXIgPSBjb25maWcuZG9wcGVsLm9yaWdTdHJpbmdzW3F1b3RlUG9zKzFdLnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgICAgICBjb25maWcuZG9wcGVsLnN0cmluZ3NbcXVvdGVQb3MrMV0gPSBvcmlnQ2hhciArIGNvbmZpZy5kb3BwZWwuc3RyaW5nc1txdW90ZVBvcysxXS5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbmZpZy5sYXN0V29yZFBvcykge1xuICAgICAgICAgICAgdmFyIGxhc3RXb3JkcyA9IHdvcmREb3BwZWwuc3BsaXQoY29uZmlnLmRvcHBlbC5zdHJpbmdzW2NvbmZpZy5sYXN0V29yZFBvcy5zdHJpbmdzXSk7XG4gICAgICAgICAgICB2YXIgbGFzdFdvcmQgPSBfY2FwaXRhbGlzZShsYXN0V29yZHMuc3RyaW5nc1tjb25maWcubGFzdFdvcmRQb3Mud29yZHNdKTtcbiAgICAgICAgICAgIGxhc3RXb3Jkcy5zdHJpbmdzW2NvbmZpZy5sYXN0V29yZFBvcy53b3Jkc10gPSBsYXN0V29yZDtcbiAgICAgICAgICAgIGNvbmZpZy5kb3BwZWwuc3RyaW5nc1tjb25maWcubGFzdFdvcmRQb3Muc3RyaW5nc10gPSB3b3JkRG9wcGVsLmpvaW4obGFzdFdvcmRzKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGFnRG9wcGVsLmpvaW4oY29uZmlnLmRvcHBlbCk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHBhc3N0aHJvdWdoIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBzdHI7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGxvd2VyY2FzZShzdGF0ZSwgc3RyaW5nKSB7XG4gICAgICAgIHZhciBjb25maWcgPSB7XG4gICAgICAgICAgICBxdW90ZVN0YXRlOiBudWxsLFxuICAgICAgICAgICAgY2FwaXRhbGlzZVdvcmRzOiBmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgICAgICAgICB2YXIgd29yZHMgPSBzdHIuc3BsaXQoXCIgXCIpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXdvcmRzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB3b3JkID0gd29yZHNbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmICh3b3JkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3b3Jkc1tpXSA9IHdvcmQudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gd29yZHMuam9pbihcIiBcIik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2tpcFdvcmRzUmV4OiBudWxsLFxuICAgICAgICAgICAgdGFnU3RhdGU6IFtdLFxuICAgICAgICAgICAgYWZ0ZXJQdW5jdDogbnVsbCxcbiAgICAgICAgICAgIGlzRmlyc3Q6IG51bGxcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gX3RleHRjYXNlRW5naW5lKGNvbmZpZywgc3RyaW5nKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gdXBwZXJjYXNlKHN0YXRlLCBzdHJpbmcpIHtcbiAgICAgICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgICAgICAgIHF1b3RlU3RhdGU6IG51bGwsXG4gICAgICAgICAgICBjYXBpdGFsaXNlV29yZHM6IGZ1bmN0aW9uKHN0cikge1xuICAgICAgICAgICAgICAgIHZhciB3b3JkcyA9IHN0ci5zcGxpdChcIiBcIik7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49d29yZHMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdvcmQgPSB3b3Jkc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2ldID0gd29yZC50b1VwcGVyQ2FzZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB3b3Jkcy5qb2luKFwiIFwiKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBza2lwV29yZHNSZXg6IG51bGwsXG4gICAgICAgICAgICB0YWdTdGF0ZTogW10sXG4gICAgICAgICAgICBhZnRlclB1bmN0OiBudWxsLFxuICAgICAgICAgICAgaXNGaXJzdDogbnVsbFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBfdGV4dGNhc2VFbmdpbmUoY29uZmlnLCBzdHJpbmcpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBzZW50ZW5jZShzdGF0ZSwgc3RyaW5nKSB7XG4gICAgICAgIHZhciBjb25maWcgPSB7XG4gICAgICAgICAgICBxdW90ZVN0YXRlOiBbXSxcbiAgICAgICAgICAgIGNhcGl0YWxpc2VXb3JkczogZnVuY3Rpb24oc3RyKSB7XG4gICAgICAgICAgICAgICAgdmFyIHdvcmRzID0gc3RyLnNwbGl0KFwiIFwiKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj13b3Jkcy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgd29yZCA9IHdvcmRzW2ldO1xuICAgICAgICAgICAgICAgICAgICBpZiAod29yZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5pc0ZpcnN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29yZHNbaV0gPSBfY2FwaXRhbGlzZSh3b3JkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuaXNGaXJzdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3Jkc1tpXSA9IHdvcmQudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gd29yZHMuam9pbihcIiBcIik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2tpcFdvcmRzUmV4OiBudWxsLFxuICAgICAgICAgICAgdGFnU3RhdGU6IFtdLFxuICAgICAgICAgICAgYWZ0ZXJQdW5jdDogbnVsbCxcbiAgICAgICAgICAgIGlzRmlyc3Q6IHRydWVcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gX3RleHRjYXNlRW5naW5lKGNvbmZpZywgc3RyaW5nKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gdGl0bGUoc3RhdGUsIHN0cmluZykge1xuICAgICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICAgICAgcXVvdGVTdGF0ZTogW10sXG4gICAgICAgICAgICBjYXBpdGFsaXNlV29yZHM6IGZ1bmN0aW9uKHN0ciwgaSwgZm9sbG93aW5nVGFnKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0ci50cmltKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdvcmRzID0gc3RyLnNwbGl0KC9bIFxcdTAwQTBdKy8pO1xuICAgICAgICAgICAgICAgICAgICB2YXIgd29yZGxlID0gd29yZERvcHBlbC5zcGxpdChzdHIpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgd29yZHMgPSB3b3JkbGUuc3RyaW5ncztcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49d29yZHMubGVuZ3RoO2o8amxlbjtqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3b3JkID0gd29yZHNbal07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXdvcmQpIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmQubGVuZ3RoID4gMSAmJiAhd29yZC50b0xvd2VyQ2FzZSgpLm1hdGNoKGNvbmZpZy5za2lwV29yZHNSZXgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29yZHNbal0gPSBfY2FwaXRhbGlzZSh3b3Jkc1tqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGogPT09ICh3b3Jkcy5sZW5ndGggLSAxKSAmJiBmb2xsb3dpbmdUYWcgPT09IFwiLVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29yZHNbal0gPSBfY2FwaXRhbGlzZSh3b3Jkc1tqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbmZpZy5pc0ZpcnN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29yZHNbal0gPSBfY2FwaXRhbGlzZSh3b3Jkc1tqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbmZpZy5hZnRlclB1bmN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29yZHNbal0gPSBfY2FwaXRhbGlzZSh3b3Jkc1tqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuYWZ0ZXJQdW5jdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmlzRmlyc3QgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5sYXN0V29yZFBvcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzOiBqXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc3RyID0gd29yZERvcHBlbC5qb2luKHdvcmRsZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBzdHI7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2tpcFdvcmRzUmV4OiBzdGF0ZS5sb2NhbGVbc3RhdGUub3B0LmxhbmddLm9wdHNbXCJza2lwLXdvcmRzLXJlZ2V4cFwiXSxcbiAgICAgICAgICAgIHRhZ1N0YXRlOiBbXSxcbiAgICAgICAgICAgIGFmdGVyUHVuY3Q6IGZhbHNlLFxuICAgICAgICAgICAgaXNGaXJzdDogdHJ1ZVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBfdGV4dGNhc2VFbmdpbmUoY29uZmlnLCBzdHJpbmcpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBjYXBpdGFsaXplRmlyc3Qoc3RhdGUsIHN0cmluZykge1xuICAgICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICAgICAgcXVvdGVTdGF0ZTogW10sXG4gICAgICAgICAgICBjYXBpdGFsaXNlV29yZHM6IGZ1bmN0aW9uKHN0cikge1xuICAgICAgICAgICAgICAgIHZhciB3b3JkcyA9IHN0ci5zcGxpdChcIiBcIik7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49d29yZHMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdvcmQgPSB3b3Jkc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuaXNGaXJzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2ldID0gX2NhcGl0YWxpc2Uod29yZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmlzRmlyc3QgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gd29yZHMuam9pbihcIiBcIik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2tpcFdvcmRzUmV4OiBudWxsLFxuICAgICAgICAgICAgdGFnU3RhdGU6IFtdLFxuICAgICAgICAgICAgYWZ0ZXJQdW5jdDogbnVsbCxcbiAgICAgICAgICAgIGlzRmlyc3Q6IHRydWVcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gX3RleHRjYXNlRW5naW5lKGNvbmZpZywgc3RyaW5nKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gY2FwaXRhbGl6ZUFsbCAoc3RhdGUsIHN0cmluZykge1xuICAgICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICAgICAgcXVvdGVTdGF0ZTogW10sXG4gICAgICAgICAgICBjYXBpdGFsaXNlV29yZHM6IGZ1bmN0aW9uKHN0cikge1xuICAgICAgICAgICAgICAgIHZhciB3b3JkcyA9IHN0ci5zcGxpdChcIiBcIik7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49d29yZHMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdvcmQgPSB3b3Jkc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2ldID0gX2NhcGl0YWxpc2Uod29yZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHdvcmRzLmpvaW4oXCIgXCIpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNraXBXb3Jkc1JleDogbnVsbCxcbiAgICAgICAgICAgIHRhZ1N0YXRlOiBbXSxcbiAgICAgICAgICAgIGFmdGVyUHVuY3Q6IG51bGwsXG4gICAgICAgICAgICBpc0ZpcnN0OiBudWxsXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIF90ZXh0Y2FzZUVuZ2luZShjb25maWcsIHN0cmluZyk7XG4gICAgfVxufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuT3V0cHV0LkZvcm1hdHMgPSBmdW5jdGlvbiAoKSB7fTtcbkNTTC5PdXRwdXQuRm9ybWF0cy5wcm90b3R5cGUuaHRtbCA9IHtcbiAgICBcInRleHRfZXNjYXBlXCI6IGZ1bmN0aW9uICh0ZXh0KSB7XG4gICAgICAgIGlmICghdGV4dCkge1xuICAgICAgICAgICAgdGV4dCA9IFwiXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSgvJi9nLCBcIiYjMzg7XCIpXG4gICAgICAgICAgICAucmVwbGFjZSgvPC9nLCBcIiYjNjA7XCIpXG4gICAgICAgICAgICAucmVwbGFjZSgvPi9nLCBcIiYjNjI7XCIpXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxzXFxzL2csIFwiXFx1MDBBMCBcIilcbiAgICAgICAgICAgIC5yZXBsYWNlKENTTC5TVVBFUlNDUklQVFNfUkVHRVhQLFxuICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oYUNoYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCI8c3VwPlwiICsgQ1NMLlNVUEVSU0NSSVBUU1thQ2hhcl0gKyBcIjwvc3VwPlwiO1xuICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgfSxcbiAgICBcImJpYnN0YXJ0XCI6IFwiPGRpdiBjbGFzcz1cXFwiY3NsLWJpYi1ib2R5XFxcIj5cXG5cIixcbiAgICBcImJpYmVuZFwiOiBcIjwvZGl2PlwiLFxuICAgIFwiQGZvbnQtc3R5bGUvaXRhbGljXCI6IFwiPGk+JSVTVFJJTkclJTwvaT5cIixcbiAgICBcIkBmb250LXN0eWxlL29ibGlxdWVcIjogXCI8ZW0+JSVTVFJJTkclJTwvZW0+XCIsXG4gICAgXCJAZm9udC1zdHlsZS9ub3JtYWxcIjogXCI8c3BhbiBzdHlsZT1cXFwiZm9udC1zdHlsZTpub3JtYWw7XFxcIj4lJVNUUklORyUlPC9zcGFuPlwiLFxuICAgIFwiQGZvbnQtdmFyaWFudC9zbWFsbC1jYXBzXCI6IFwiPHNwYW4gc3R5bGU9XFxcImZvbnQtdmFyaWFudDpzbWFsbC1jYXBzO1xcXCI+JSVTVFJJTkclJTwvc3Bhbj5cIixcbiAgICBcIkBwYXNzdGhyb3VnaC90cnVlXCI6IENTTC5PdXRwdXQuRm9ybWF0dGVycy5wYXNzdGhyb3VnaCxcbiAgICBcIkBmb250LXZhcmlhbnQvbm9ybWFsXCI6IFwiPHNwYW4gc3R5bGU9XFxcImZvbnQtdmFyaWFudDpub3JtYWw7XFxcIj4lJVNUUklORyUlPC9zcGFuPlwiLFxuICAgIFwiQGZvbnQtd2VpZ2h0L2JvbGRcIjogXCI8Yj4lJVNUUklORyUlPC9iPlwiLFxuICAgIFwiQGZvbnQtd2VpZ2h0L25vcm1hbFwiOiBcIjxzcGFuIHN0eWxlPVxcXCJmb250LXdlaWdodDpub3JtYWw7XFxcIj4lJVNUUklORyUlPC9zcGFuPlwiLFxuICAgIFwiQGZvbnQtd2VpZ2h0L2xpZ2h0XCI6IGZhbHNlLFxuICAgIFwiQHRleHQtZGVjb3JhdGlvbi9ub25lXCI6IFwiPHNwYW4gc3R5bGU9XFxcInRleHQtZGVjb3JhdGlvbjpub25lO1xcXCI+JSVTVFJJTkclJTwvc3Bhbj5cIixcbiAgICBcIkB0ZXh0LWRlY29yYXRpb24vdW5kZXJsaW5lXCI6IFwiPHNwYW4gc3R5bGU9XFxcInRleHQtZGVjb3JhdGlvbjp1bmRlcmxpbmU7XFxcIj4lJVNUUklORyUlPC9zcGFuPlwiLFxuICAgIFwiQHZlcnRpY2FsLWFsaWduL3N1cFwiOiBcIjxzdXA+JSVTVFJJTkclJTwvc3VwPlwiLFxuICAgIFwiQHZlcnRpY2FsLWFsaWduL3N1YlwiOiBcIjxzdWI+JSVTVFJJTkclJTwvc3ViPlwiLFxuICAgIFwiQHZlcnRpY2FsLWFsaWduL2Jhc2VsaW5lXCI6IFwiPHNwYW4gc3R5bGU9XFxcImJhc2VsaW5lXFxcIj4lJVNUUklORyUlPC9zcGFuPlwiLFxuICAgIFwiQHN0cmlwLXBlcmlvZHMvdHJ1ZVwiOiBDU0wuT3V0cHV0LkZvcm1hdHRlcnMucGFzc3Rocm91Z2gsXG4gICAgXCJAc3RyaXAtcGVyaW9kcy9mYWxzZVwiOiBDU0wuT3V0cHV0LkZvcm1hdHRlcnMucGFzc3Rocm91Z2gsXG4gICAgXCJAcXVvdGVzL3RydWVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5nZXRUZXJtKFwib3Blbi1xdW90ZVwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RhdGUuZ2V0VGVybShcIm9wZW4tcXVvdGVcIikgKyBzdHIgKyBzdGF0ZS5nZXRUZXJtKFwiY2xvc2UtcXVvdGVcIik7XG4gICAgfSxcbiAgICBcIkBxdW90ZXMvaW5uZXJcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBcIlxcdTIwMTlcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RhdGUuZ2V0VGVybShcIm9wZW4taW5uZXItcXVvdGVcIikgKyBzdHIgKyBzdGF0ZS5nZXRUZXJtKFwiY2xvc2UtaW5uZXItcXVvdGVcIik7XG4gICAgfSxcbiAgICBcIkBxdW90ZXMvZmFsc2VcIjogZmFsc2UsXG4gICAgXCJAY2l0ZS9lbnRyeVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gc3RhdGUuc3lzLndyYXBDaXRhdGlvbkVudHJ5KHN0ciwgdGhpcy5pdGVtX2lkLCB0aGlzLmxvY2F0b3JfdHh0LCB0aGlzLnN1ZmZpeF90eHQpO1xuXHR9LFxuICAgIFwiQGJpYmxpb2dyYXBoeS9lbnRyeVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICB2YXIgaW5zZXJ0ID0gXCJcIjtcbiAgICAgICAgaWYgKHN0YXRlLnN5cy5lbWJlZEJpYmxpb2dyYXBoeUVudHJ5KSB7XG4gICAgICAgICAgICBpbnNlcnQgPSBzdGF0ZS5zeXMuZW1iZWRCaWJsaW9ncmFwaHlFbnRyeSh0aGlzLml0ZW1faWQpICsgXCJcXG5cIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gXCIgIDxkaXYgY2xhc3M9XFxcImNzbC1lbnRyeVxcXCI+XCIgKyBzdHIgKyBcIjwvZGl2PlxcblwiICsgaW5zZXJ0O1xuICAgIH0sXG4gICAgXCJAZGlzcGxheS9ibG9ja1wiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gXCJcXG5cXG4gICAgPGRpdiBjbGFzcz1cXFwiY3NsLWJsb2NrXFxcIj5cIiArIHN0ciArIFwiPC9kaXY+XFxuXCI7XG4gICAgfSxcbiAgICBcIkBkaXNwbGF5L2xlZnQtbWFyZ2luXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBcIlxcbiAgICA8ZGl2IGNsYXNzPVxcXCJjc2wtbGVmdC1tYXJnaW5cXFwiPlwiICsgc3RyICsgXCI8L2Rpdj5cIjtcbiAgICB9LFxuICAgIFwiQGRpc3BsYXkvcmlnaHQtaW5saW5lXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBcIjxkaXYgY2xhc3M9XFxcImNzbC1yaWdodC1pbmxpbmVcXFwiPlwiICsgc3RyICsgXCI8L2Rpdj5cXG4gIFwiO1xuICAgIH0sXG4gICAgXCJAZGlzcGxheS9pbmRlbnRcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIFwiPGRpdiBjbGFzcz1cXFwiY3NsLWluZGVudFxcXCI+XCIgKyBzdHIgKyBcIjwvZGl2PlxcbiAgXCI7XG4gICAgfSxcbiAgICBcIkBzaG93aWQvdHJ1ZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0ciwgY3NsaWQpIHtcbiAgICAgICAgaWYgKCFzdGF0ZS50bXAuanVzdF9sb29raW5nICYmICEgc3RhdGUudG1wLnN1cHByZXNzX2RlY29yYXRpb25zKSB7XG4gICAgICAgICAgICBpZiAoY3NsaWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gXCI8c3BhbiBjbGFzcz1cXFwiXCIgKyBzdGF0ZS5vcHQubm9kZW5hbWVzW2NzbGlkXSArIFwiXFxcIiBjc2xpZD1cXFwiXCIgKyBjc2xpZCArIFwiXFxcIj5cIiArIHN0ciArIFwiPC9zcGFuPlwiO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnBhcmFtcyAmJiBcInN0cmluZ1wiID09PSB0eXBlb2Ygc3RyKSB7XG4gICAgICAgICAgICAgICAgdmFyIHByZVB1bmN0ID0gXCJcIjtcbiAgICAgICAgICAgICAgICBpZiAoc3RyKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtID0gc3RyLm1hdGNoKENTTC5WQVJJQUJMRV9XUkFQUEVSX1BSRVBVTkNUX1JFWCk7XG4gICAgICAgICAgICAgICAgICAgIHByZVB1bmN0ID0gbVsxXTtcbiAgICAgICAgICAgICAgICAgICAgc3RyID0gbVsyXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHBvc3RQdW5jdCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgaWYgKHN0ciAmJiBDU0wuU1dBUFBJTkdfUFVOQ1RVQVRJT04uaW5kZXhPZihzdHIuc2xpY2UoLTEpKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHBvc3RQdW5jdCA9IHN0ci5zbGljZSgtMSk7XG4gICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zbGljZSgwLC0xKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnN5cy52YXJpYWJsZVdyYXBwZXIodGhpcy5wYXJhbXMsIHByZVB1bmN0LCBzdHIsIHBvc3RQdW5jdCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdHI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gc3RyO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBcIkBVUkwvdHJ1ZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gXCI8YSBocmVmPVxcXCJcIiArIHN0ciArIFwiXFxcIj5cIiArIHN0ciArIFwiPC9hPlwiO1xuICAgIH0sXG4gICAgXCJARE9JL3RydWVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgdmFyIGRvaXVybCA9IHN0cjtcbiAgICAgICAgaWYgKCFzdHIubWF0Y2goL15odHRwcz86XFwvXFwvLykpIHtcbiAgICAgICAgICAgIGRvaXVybCA9IFwiaHR0cHM6Ly9kb2kub3JnL1wiICsgc3RyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBcIjxhIGhyZWY9XFxcIlwiICsgZG9pdXJsICsgXCJcXFwiPlwiICsgc3RyICsgXCI8L2E+XCI7XG4gICAgfVxufTtcbkNTTC5PdXRwdXQuRm9ybWF0cy5wcm90b3R5cGUudGV4dCA9IHtcbiAgICBcInRleHRfZXNjYXBlXCI6IGZ1bmN0aW9uICh0ZXh0KSB7XG4gICAgICAgIGlmICghdGV4dCkge1xuICAgICAgICAgICAgdGV4dCA9IFwiXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRleHQ7XG4gICAgfSxcbiAgICBcImJpYnN0YXJ0XCI6IFwiXCIsXG4gICAgXCJiaWJlbmRcIjogXCJcIixcbiAgICBcIkBmb250LXN0eWxlL2l0YWxpY1wiOiBmYWxzZSxcbiAgICBcIkBmb250LXN0eWxlL29ibGlxdWVcIjogZmFsc2UsXG4gICAgXCJAZm9udC1zdHlsZS9ub3JtYWxcIjogZmFsc2UsXG4gICAgXCJAZm9udC12YXJpYW50L3NtYWxsLWNhcHNcIjogZmFsc2UsXG4gICAgXCJAcGFzc3Rocm91Z2gvdHJ1ZVwiOiBDU0wuT3V0cHV0LkZvcm1hdHRlcnMucGFzc3Rocm91Z2gsXG4gICAgXCJAZm9udC12YXJpYW50L25vcm1hbFwiOiBmYWxzZSxcbiAgICBcIkBmb250LXdlaWdodC9ib2xkXCI6IGZhbHNlLFxuICAgIFwiQGZvbnQtd2VpZ2h0L25vcm1hbFwiOiBmYWxzZSxcbiAgICBcIkBmb250LXdlaWdodC9saWdodFwiOiBmYWxzZSxcbiAgICBcIkB0ZXh0LWRlY29yYXRpb24vbm9uZVwiOiBmYWxzZSxcbiAgICBcIkB0ZXh0LWRlY29yYXRpb24vdW5kZXJsaW5lXCI6IGZhbHNlLFxuICAgIFwiQHZlcnRpY2FsLWFsaWduL2Jhc2VsaW5lXCI6IGZhbHNlLFxuICAgIFwiQHZlcnRpY2FsLWFsaWduL3N1cFwiOiBmYWxzZSxcbiAgICBcIkB2ZXJ0aWNhbC1hbGlnbi9zdWJcIjogZmFsc2UsXG4gICAgXCJAc3RyaXAtcGVyaW9kcy90cnVlXCI6IENTTC5PdXRwdXQuRm9ybWF0dGVycy5wYXNzdGhyb3VnaCxcbiAgICBcIkBzdHJpcC1wZXJpb2RzL2ZhbHNlXCI6IENTTC5PdXRwdXQuRm9ybWF0dGVycy5wYXNzdGhyb3VnaCxcbiAgICBcIkBxdW90ZXMvdHJ1ZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHN0cikge1xuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLmdldFRlcm0oXCJvcGVuLXF1b3RlXCIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdGF0ZS5nZXRUZXJtKFwib3Blbi1xdW90ZVwiKSArIHN0ciArIHN0YXRlLmdldFRlcm0oXCJjbG9zZS1xdW90ZVwiKTtcbiAgICB9LFxuICAgIFwiQHF1b3Rlcy9pbm5lclwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHN0cikge1xuICAgICAgICAgICAgcmV0dXJuIFwiXFx1MjAxOVwiO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdGF0ZS5nZXRUZXJtKFwib3Blbi1pbm5lci1xdW90ZVwiKSArIHN0ciArIHN0YXRlLmdldFRlcm0oXCJjbG9zZS1pbm5lci1xdW90ZVwiKTtcbiAgICB9LFxuICAgIFwiQHF1b3Rlcy9mYWxzZVwiOiBmYWxzZSxcbiAgICBcIkBjaXRlL2VudHJ5XCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG5cdFx0cmV0dXJuIHN0YXRlLnN5cy53cmFwQ2l0YXRpb25FbnRyeShzdHIsIHRoaXMuaXRlbV9pZCwgdGhpcy5sb2NhdG9yX3R4dCwgdGhpcy5zdWZmaXhfdHh0KTtcblx0fSxcbiAgICBcIkBiaWJsaW9ncmFwaHkvZW50cnlcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIHN0citcIlxcblwiO1xuICAgIH0sXG4gICAgXCJAZGlzcGxheS9ibG9ja1wiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gXCJcXG5cIitzdHI7XG4gICAgfSxcbiAgICBcIkBkaXNwbGF5L2xlZnQtbWFyZ2luXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBzdHI7XG4gICAgfSxcbiAgICBcIkBkaXNwbGF5L3JpZ2h0LWlubGluZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gc3RyO1xuICAgIH0sXG4gICAgXCJAZGlzcGxheS9pbmRlbnRcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIFwiXFxuICAgIFwiK3N0cjtcbiAgICB9LFxuICAgIFwiQHNob3dpZC90cnVlXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyLCBjc2xpZCkge1xuICAgICAgICByZXR1cm4gc3RyO1xuICAgIH0sXG4gICAgXCJAVVJML3RydWVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIHN0cjtcbiAgICB9LFxuICAgIFwiQERPSS90cnVlXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBzdHI7XG4gICAgfVxufTtcbkNTTC5PdXRwdXQuRm9ybWF0cy5wcm90b3R5cGUucnRmID0ge1xuICAgIFwidGV4dF9lc2NhcGVcIjogZnVuY3Rpb24gKHRleHQpIHtcbiAgICAgICAgaWYgKCF0ZXh0KSB7XG4gICAgICAgICAgICB0ZXh0ID0gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGV4dFxuICAgICAgICAucmVwbGFjZSgvKFtcXFxce31dKS9nLCBcIlxcXFwkMVwiKVxuICAgICAgICAucmVwbGFjZShDU0wuU1VQRVJTQ1JJUFRTX1JFR0VYUCxcbiAgICAgICAgICAgICAgICAgZnVuY3Rpb24oYUNoYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBcIlxcXFxzdXBlciBcIiArIENTTC5TVVBFUlNDUklQVFNbYUNoYXJdICsgXCJcXFxcbm9zdXBlcnN1Ynt9XCI7XG4gICAgICAgICAgICAgICAgIH0pXG4gICAgICAgIC5yZXBsYWNlKC9bXFx1MDA3Ri1cXHVGRkZGXS9nLFxuICAgICAgICAgICAgICAgICBmdW5jdGlvbihhQ2hhcikgeyByZXR1cm4gXCJcXFxcdWMwXFxcXHVcIithQ2hhci5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKCkrXCJ7fVwiOyB9KVxuICAgICAgICAuc3BsaXQoXCJcXHRcIikuam9pbihcIlxcXFx0YWJ7fVwiKTtcbiAgICB9LFxuICAgIFwiQHBhc3N0aHJvdWdoL3RydWVcIjogQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzLnBhc3N0aHJvdWdoLFxuICAgIFwiQGZvbnQtc3R5bGUvaXRhbGljXCI6XCJ7XFxcXGl7fSUlU1RSSU5HJSV9XCIsXG4gICAgXCJAZm9udC1zdHlsZS9ub3JtYWxcIjpcIntcXFxcaTB7fSUlU1RSSU5HJSV9XCIsXG4gICAgXCJAZm9udC1zdHlsZS9vYmxpcXVlXCI6XCJ7XFxcXGl7fSUlU1RSSU5HJSV9XCIsXG4gICAgXCJAZm9udC12YXJpYW50L3NtYWxsLWNhcHNcIjpcIntcXFxcc2NhcHMgJSVTVFJJTkclJX1cIixcbiAgICBcIkBmb250LXZhcmlhbnQvbm9ybWFsXCI6XCJ7XFxcXHNjYXBzMHt9JSVTVFJJTkclJX1cIixcbiAgICBcIkBmb250LXdlaWdodC9ib2xkXCI6XCJ7XFxcXGJ7fSUlU1RSSU5HJSV9XCIsXG4gICAgXCJAZm9udC13ZWlnaHQvbm9ybWFsXCI6XCJ7XFxcXGIwe30lJVNUUklORyUlfVwiLFxuICAgIFwiQGZvbnQtd2VpZ2h0L2xpZ2h0XCI6ZmFsc2UsXG4gICAgXCJAdGV4dC1kZWNvcmF0aW9uL25vbmVcIjpmYWxzZSxcbiAgICBcIkB0ZXh0LWRlY29yYXRpb24vdW5kZXJsaW5lXCI6XCJ7XFxcXHVse30lJVNUUklORyUlfVwiLFxuICAgIFwiQHZlcnRpY2FsLWFsaWduL2Jhc2VsaW5lXCI6ZmFsc2UsXG4gICAgXCJAdmVydGljYWwtYWxpZ24vc3VwXCI6XCJcXFxcc3VwZXIgJSVTVFJJTkclJVxcXFxub3N1cGVyc3Vie31cIixcbiAgICBcIkB2ZXJ0aWNhbC1hbGlnbi9zdWJcIjpcIlxcXFxzdWIgJSVTVFJJTkclJVxcXFxub3N1cGVyc3Vie31cIixcbiAgICBcIkBzdHJpcC1wZXJpb2RzL3RydWVcIjogQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzLnBhc3N0aHJvdWdoLFxuICAgIFwiQHN0cmlwLXBlcmlvZHMvZmFsc2VcIjogQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzLnBhc3N0aHJvdWdoLFxuICAgIFwiQHF1b3Rlcy90cnVlXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygc3RyKSB7XG4gICAgICAgICAgICByZXR1cm4gQ1NMLk91dHB1dC5Gb3JtYXRzLnJ0Zi50ZXh0X2VzY2FwZShzdGF0ZS5nZXRUZXJtKFwib3Blbi1xdW90ZVwiKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIENTTC5PdXRwdXQuRm9ybWF0cy5ydGYudGV4dF9lc2NhcGUoc3RhdGUuZ2V0VGVybShcIm9wZW4tcXVvdGVcIikpICsgc3RyICsgQ1NMLk91dHB1dC5Gb3JtYXRzLnJ0Zi50ZXh0X2VzY2FwZShzdGF0ZS5nZXRUZXJtKFwiY2xvc2UtcXVvdGVcIikpO1xuICAgIH0sXG4gICAgXCJAcXVvdGVzL2lubmVyXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygc3RyKSB7XG4gICAgICAgICAgICByZXR1cm4gQ1NMLk91dHB1dC5Gb3JtYXRzLnJ0Zi50ZXh0X2VzY2FwZShcIlxcdTIwMTlcIik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIENTTC5PdXRwdXQuRm9ybWF0cy5ydGYudGV4dF9lc2NhcGUoc3RhdGUuZ2V0VGVybShcIm9wZW4taW5uZXItcXVvdGVcIikpICsgc3RyICsgQ1NMLk91dHB1dC5Gb3JtYXRzLnJ0Zi50ZXh0X2VzY2FwZShzdGF0ZS5nZXRUZXJtKFwiY2xvc2UtaW5uZXItcXVvdGVcIikpO1xuICAgIH0sXG4gICAgXCJAcXVvdGVzL2ZhbHNlXCI6IGZhbHNlLFxuICAgIFwiYmlic3RhcnRcIjpcIntcXFxccnRmIFwiLFxuICAgIFwiYmliZW5kXCI6XCJ9XCIsXG4gICAgXCJAZGlzcGxheS9ibG9ja1wiOiBcIlxcXFxsaW5le30lJVNUUklORyUlXFxcXGxpbmVcXHJcXG5cIixcbiAgICBcIkBjaXRlL2VudHJ5XCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG5cdFx0cmV0dXJuIHN0YXRlLnN5cy53cmFwQ2l0YXRpb25FbnRyeShzdHIsIHRoaXMuaXRlbV9pZCwgdGhpcy5sb2NhdG9yX3R4dCwgdGhpcy5zdWZmaXhfdHh0KTtcblx0fSxcbiAgICBcIkBiaWJsaW9ncmFwaHkvZW50cnlcIjogZnVuY3Rpb24oc3RhdGUsc3RyKXtcbiAgICAgICAgcmV0dXJuIHN0cjtcbiAgICB9LFxuICAgIFwiQGRpc3BsYXkvbGVmdC1tYXJnaW5cIjogZnVuY3Rpb24oc3RhdGUsc3RyKXtcbiAgICAgICAgcmV0dXJuIHN0citcIlxcXFx0YWIgXCI7XG4gICAgfSxcbiAgICBcIkBkaXNwbGF5L3JpZ2h0LWlubGluZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gc3RyK1wiXFxyXFxuXCI7XG4gICAgfSxcbiAgICBcIkBkaXNwbGF5L2luZGVudFwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gXCJcXG5cXFxcdGFiIFwiK3N0citcIlxcXFxsaW5lXFxyXFxuXCI7XG4gICAgfSxcbiAgICBcIkBzaG93aWQvdHJ1ZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0ciwgY3NsaWQpIHtcbiAgICAgICAgaWYgKCFzdGF0ZS50bXAuanVzdF9sb29raW5nICYmICEgc3RhdGUudG1wLnN1cHByZXNzX2RlY29yYXRpb25zKSB7XG4gICAgICAgICAgICB2YXIgcHJlUHVuY3QgPSBcIlwiO1xuICAgICAgICAgICAgaWYgKHN0cikge1xuICAgICAgICAgICAgICAgIHZhciBtID0gc3RyLm1hdGNoKENTTC5WQVJJQUJMRV9XUkFQUEVSX1BSRVBVTkNUX1JFWCk7XG4gICAgICAgICAgICAgICAgcHJlUHVuY3QgPSBtWzFdO1xuICAgICAgICAgICAgICAgIHN0ciA9IG1bMl07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgcG9zdFB1bmN0ID0gXCJcIjtcbiAgICAgICAgICAgIGlmIChzdHIgJiYgQ1NMLlNXQVBQSU5HX1BVTkNUVUFUSU9OLmluZGV4T2Yoc3RyLnNsaWNlKC0xKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIHBvc3RQdW5jdCA9IHN0ci5zbGljZSgtMSk7XG4gICAgICAgICAgICAgICAgc3RyID0gc3RyLnNsaWNlKDAsLTEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnN5cy52YXJpYWJsZVdyYXBwZXIodGhpcy5wYXJhbXMsIHByZVB1bmN0LCBzdHIsIHBvc3RQdW5jdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gc3RyO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBcIkBVUkwvdHJ1ZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gc3RyO1xuICAgIH0sXG4gICAgXCJARE9JL3RydWVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIHN0cjtcbiAgICB9XG59O1xuQ1NMLk91dHB1dC5Gb3JtYXRzID0gbmV3IENTTC5PdXRwdXQuRm9ybWF0cygpO1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuUmVnaXN0cnkgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICB2YXIgcG9zLCBsZW4sIHJldCwgaSwgaWxlbjtcbiAgICB0aGlzLmRlYnVnID0gZmFsc2U7XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xuICAgIHRoaXMucmVnaXN0cnkgPSB7fTtcbiAgICB0aGlzLnJlZmxpc3QgPSBbXTtcbiAgICB0aGlzLnJlZmhhc2ggPSB7fTtcbiAgICB0aGlzLm5hbWVyZWcgPSBuZXcgQ1NMLlJlZ2lzdHJ5Lk5hbWVSZWcoc3RhdGUpO1xuICAgIHRoaXMuY2l0YXRpb25yZWcgPSBuZXcgQ1NMLlJlZ2lzdHJ5LkNpdGF0aW9uUmVnKHN0YXRlKTtcbiAgICB0aGlzLmF1dGhvcnN0cmluZ3MgPSB7fTtcbiAgICB0aGlzLm15bGlzdCA9IFtdO1xuICAgIHRoaXMubXloYXNoID0ge307XG4gICAgdGhpcy5kZWxldGVzID0gW107XG4gICAgdGhpcy5pbnNlcnRzID0gW107XG4gICAgdGhpcy51bmNpdGVkID0ge307XG4gICAgdGhpcy5yZWZyZXNoZXMgPSB7fTtcbiAgICB0aGlzLmFrZXlzID0ge307XG4gICAgdGhpcy5vbGRzZXEgPSB7fTtcbiAgICB0aGlzLnJldHVybl9kYXRhID0ge307XG4gICAgdGhpcy5hbWJpZ2NpdGVzID0ge307XG4gICAgdGhpcy5hbWJpZ3Jlc2V0cyA9IHt9O1xuICAgIHRoaXMuc29ydGVyID0gbmV3IENTTC5SZWdpc3RyeS5Db21wYXJpZmllcihzdGF0ZSwgXCJiaWJsaW9ncmFwaHlfc29ydFwiKTtcbiAgICB0aGlzLmdldFNvcnRlZElkcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHJldCA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMucmVmbGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHJldC5wdXNoKFwiXCIgKyB0aGlzLnJlZmxpc3RbaV0uaWQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcbiAgICB0aGlzLmdldFNvcnRlZFJlZ2lzdHJ5SXRlbXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciByZXQgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLnJlZmxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICByZXQucHVzaCh0aGlzLnJlZmxpc3RbaV0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcbn07XG5DU0wuUmVnaXN0cnkucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoaXRlbUlEcywgdW5jaXRlZF9mbGFnKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgdGhpcy5vbGRzZXEgPSB7fTtcbiAgICBpZiAodW5jaXRlZF9mbGFnKSB7XG4gICAgICAgIHRoaXMudW5jaXRlZCA9IHt9O1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1pdGVtSURzLmxlbmd0aDtpPGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLm15aGFzaFtpdGVtSURzW2ldXSkge1xuICAgICAgICAgICAgICAgIHRoaXMubXlsaXN0LnB1c2goXCJcIiArIGl0ZW1JRHNbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy51bmNpdGVkW2l0ZW1JRHNbaV1dID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMubXloYXNoW2l0ZW1JRHNbaV1dID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnVuY2l0ZWQpIHtcbiAgICAgICAgICAgIGl0ZW1JRHMucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBteWhhc2ggPSB7fTtcbiAgICAgICAgZm9yIChpPWl0ZW1JRHMubGVuZ3RoLTE7aT4tMTsgaSArPSAtMSkge1xuICAgICAgICAgICAgaWYgKG15aGFzaFtpdGVtSURzW2ldXSkge1xuICAgICAgICAgICAgICAgIGl0ZW1JRHMgPSBpdGVtSURzLnNsaWNlKDAsIGkpLmNvbmNhdChpdGVtSURzLnNsaWNlKGkgKyAxKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG15aGFzaFtpdGVtSURzW2ldXSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5teWxpc3QgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49aXRlbUlEcy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgIHRoaXMubXlsaXN0LnB1c2goXCJcIiArIGl0ZW1JRHNbaV0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubXloYXNoID0gbXloYXNoO1xuICAgIH1cbiAgICB0aGlzLnJlZnJlc2hlcyA9IHt9O1xuICAgIHRoaXMudG91Y2hlZCA9IHt9O1xuICAgIHRoaXMuYW1iaWdzVG91Y2hlZCA9IHt9O1xuICAgIHRoaXMuYW1iaWdyZXNldHMgPSB7fTtcbn07XG5DU0wuUmVnaXN0cnkucHJvdG90eXBlLmRvcHVyZ2UgPSBmdW5jdGlvbiAobXloYXNoKSB7XG4gICAgZm9yICh2YXIgaT10aGlzLm15bGlzdC5sZW5ndGgtMTtpPi0xO2krPS0xKSB7XG4gICAgICAgIGlmICh0aGlzLmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbdGhpcy5teWxpc3RbaV1dICYmICFteWhhc2hbdGhpcy5teWxpc3RbaV1dKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubXloYXNoW3RoaXMubXlsaXN0W2ldXTtcbiAgICAgICAgICAgICAgICB0aGlzLm15bGlzdCA9IHRoaXMubXlsaXN0LnNsaWNlKDAsaSkuY29uY2F0KHRoaXMubXlsaXN0LnNsaWNlKGkrMSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMuZG9kZWxldGVzKHRoaXMubXloYXNoKTtcbn07XG5DU0wuUmVnaXN0cnkucHJvdG90eXBlLmRvZGVsZXRlcyA9IGZ1bmN0aW9uIChteWhhc2gpIHtcbiAgICB2YXIgb3RoZXJpdGVtcywga2V5LCBhbWJpZywgcG9zLCBsZW4sIGl0ZW1zLCBra2V5LCBteXBvcywgaWQ7XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBteWhhc2gpIHtcbiAgICAgICAgbXloYXNoID0ge307XG4gICAgICAgIG15aGFzaFtteWhhc2hdID0gdHJ1ZTtcbiAgICB9XG4gICAgZm9yICh2YXIga2V5IGluIHRoaXMucmVnaXN0cnkpIHtcbiAgICAgICAgaWYgKCFteWhhc2hba2V5XSkge1xuICAgICAgICAgICAgaWYgKHRoaXMudW5jaXRlZFtrZXldKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvdGhlcml0ZW1zID0gdGhpcy5uYW1lcmVnLmRlbGl0ZW1zKGtleSk7XG4gICAgICAgICAgICBmb3IgKGtrZXkgaW4gb3RoZXJpdGVtcykge1xuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaGVzW2trZXldID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFtYmlnID0gdGhpcy5yZWdpc3RyeVtrZXldLmFtYmlnO1xuICAgICAgICAgICAgbXlwb3MgPSB0aGlzLmFtYmlnY2l0ZXNbYW1iaWddLmluZGV4T2Yoa2V5KTtcbiAgICAgICAgICAgIGlmIChteXBvcyA+IC0xKSB7XG4gICAgICAgICAgICAgICAgaXRlbXMgPSB0aGlzLmFtYmlnY2l0ZXNbYW1iaWddLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5hbWJpZ2NpdGVzW2FtYmlnXSA9IGl0ZW1zLnNsaWNlKDAsIG15cG9zKS5jb25jYXQoaXRlbXMuc2xpY2UobXlwb3MrMSwgaXRlbXMubGVuZ3RoKSk7XG4gICAgICAgICAgICAgICAgdGhpcy5hbWJpZ3Jlc2V0c1thbWJpZ10gPSB0aGlzLmFtYmlnY2l0ZXNbYW1iaWddLmxlbmd0aDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxlbiA9IHRoaXMuYW1iaWdjaXRlc1thbWJpZ10ubGVuZ3RoO1xuICAgICAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgaWQgPSBcIlwiICsgdGhpcy5hbWJpZ2NpdGVzW2FtYmlnXVtwb3NdO1xuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaGVzW2lkXSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5yZWdpc3RyeVtrZXldLnNpYmxpbmdzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucmVnaXN0cnlba2V5XS5zaWJsaW5ncy5sZW5ndGggPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbG9uZVNpYmxpbmdJRCA9IHRoaXMucmVnaXN0cnlba2V5XS5zaWJsaW5nc1swXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeVtsb25lU2libGluZ0lEXS5tYXN0ZXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5W2xvbmVTaWJsaW5nSURdLnNpYmxpbmdzLnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5W2xvbmVTaWJsaW5nSURdLnBhcmFsbGVsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnJlZ2lzdHJ5W2tleV0uc2libGluZ3MubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcmVtb3ZlSURzID0gW2tleV07XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlZ2lzdHJ5W2tleV0ubWFzdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3bWFzdGVySUQgPSB0aGlzLnJlZ2lzdHJ5W2tleV0uc2libGluZ3NbMF07XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3bWFzdGVyID0gdGhpcy5yZWdpc3RyeVtuZXdtYXN0ZXJJRF07XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdtYXN0ZXIubWFzdGVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld21hc3Rlci5wYXJhbGxlbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlSURzLnB1c2gobmV3bWFzdGVySUQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGtsZW4gPSB0aGlzLnJlZ2lzdHJ5W2tleV0uc2libGluZ3MubGVuZ3RoOyBrIDwga2xlbjsgayArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeVt0aGlzLnJlZ2lzdHJ5W2tleV0uc2libGluZ3Nba11dLnBhcmFsbGVsID0gbmV3bWFzdGVySUQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1ZmZlciA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gdGhpcy5yZWdpc3RyeVtrZXldLnNpYmxpbmdzLmxlbmd0aCAtIDE7IGsgPiAtMTsgayArPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNpYmxpbmdJRCA9IHRoaXMucmVnaXN0cnlba2V5XS5zaWJsaW5ncy5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVJRHMuaW5kZXhPZihzaWJsaW5nSUQpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKHNpYmxpbmdJRClcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gYnVmZmVyLmxlbmd0aCAtIDE7IGsgPiAtMTsgayArPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeVtrZXldLnNpYmxpbmdzLnB1c2goYnVmZmVyW2tdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnJlZ2lzdHJ5W2tleV07XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5yZWZoYXNoW2tleV07XG4gICAgICAgICAgICB0aGlzLnJldHVybl9kYXRhLmJpYmNoYW5nZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5kb2luc2VydHMgPSBmdW5jdGlvbiAobXlsaXN0KSB7XG4gICAgdmFyIGxlbiwgcG9zLCBpdGVtLCBJdGVtLCBha2V5LCBuZXdpdGVtLCBhYmFzZSwgaiwgamxlbiwgaywga2xlbiwgaSwgaWxlbjtcbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15bGlzdCkge1xuICAgICAgICBteWxpc3QgPSBbbXlsaXN0XTtcbiAgICB9XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBteWxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGl0ZW0gPSBteWxpc3RbaV07XG4gICAgICAgIGlmICghdGhpcy5yZWdpc3RyeVtpdGVtXSkge1xuICAgICAgICAgICAgSXRlbSA9IHRoaXMuc3RhdGUucmV0cmlldmVJdGVtKGl0ZW0pO1xuICAgICAgICAgICAgYWtleSA9IENTTC5nZXRBbWJpZ3VvdXNDaXRlLmNhbGwodGhpcy5zdGF0ZSwgSXRlbSk7XG4gICAgICAgICAgICB0aGlzLmFtYmlnc1RvdWNoZWRbYWtleV0gPSB0cnVlO1xuICAgICAgICAgICAgaWYgKCFJdGVtLmxlZ2lzbGF0aW9uX2lkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ha2V5c1tha2V5XSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuZXdpdGVtID0ge1xuICAgICAgICAgICAgICAgIFwiaWRcIjogXCJcIiArIGl0ZW0sXG4gICAgICAgICAgICAgICAgXCJzZXFcIjogMCxcbiAgICAgICAgICAgICAgICBcIm9mZnNldFwiOiAwLFxuICAgICAgICAgICAgICAgIFwic29ydGtleXNcIjogZmFsc2UsXG4gICAgICAgICAgICAgICAgXCJhbWJpZ1wiOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBcInJlbmRlcmVkXCI6IGZhbHNlLFxuICAgICAgICAgICAgICAgIFwiZGlzYW1iaWdcIjogZmFsc2UsXG4gICAgICAgICAgICAgICAgXCJyZWZcIjogSXRlbVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMucmVnaXN0cnlbaXRlbV0gPSBuZXdpdGVtO1xuICAgICAgICAgICAgaWYgKHRoaXMuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWQgJiYgdGhpcy5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtpdGVtXSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnlbaXRlbV1bXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIl0gPSB0aGlzLmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW2l0ZW1dWzBdLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYWJhc2UgPSBDU0wuZ2V0QW1iaWdDb25maWcuY2FsbCh0aGlzLnN0YXRlKTtcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJBbWJpZ1Rva2VuKGFrZXksIGl0ZW0sIGFiYXNlKTtcbiAgICAgICAgICAgIHRoaXMudG91Y2hlZFtpdGVtXSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnJldHVybl9kYXRhLmJpYmNoYW5nZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5yZWJ1aWxkbGlzdCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgY291bnQsIGxlbiwgcG9zLCBpdGVtO1xuICAgIHRoaXMucmVmbGlzdCA9IFtdO1xuICAgIGlmICh0aGlzLnN0YXRlLm9wdC5jaXRhdGlvbl9udW1iZXJfc29ydF9kaXJlY3Rpb24gPT09IENTTC5ERVNDRU5ESU5HXG4gICAgICAgJiYgdGhpcy5zdGF0ZS5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnRfdXNlZCkge1xuICAgIH1cbiAgICBsZW4gPSB0aGlzLm15bGlzdC5sZW5ndGg7XG4gICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIGl0ZW0gPSB0aGlzLm15bGlzdFtwb3NdO1xuICAgICAgICB0aGlzLnJlZmxpc3QucHVzaCh0aGlzLnJlZ2lzdHJ5W2l0ZW1dKTtcbiAgICAgICAgdGhpcy5vbGRzZXFbaXRlbV0gPSB0aGlzLnJlZ2lzdHJ5W2l0ZW1dLnNlcTtcbiAgICAgICAgdGhpcy5yZWdpc3RyeVtpdGVtXS5zZXEgPSAocG9zICsgMSk7XG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXRlLm9wdC5jaXRhdGlvbl9udW1iZXJfc29ydF9kaXJlY3Rpb24gPT09IENTTC5ERVNDRU5ESU5HXG4gICAgICAgJiYgdGhpcy5zdGF0ZS5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnRfdXNlZCkge1xuICAgIH1cbn07XG5DU0wuUmVnaXN0cnkucHJvdG90eXBlLmRvcmVmcmVzaGVzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBrZXksIHJlZ3Rva2VuLCBJdGVtLCBvbGRfYWtleSwgYWtleSwgYWJhc2U7XG4gICAgZm9yICh2YXIga2V5IGluIHRoaXMucmVmcmVzaGVzKSB7XG4gICAgICAgIHJlZ3Rva2VuID0gdGhpcy5yZWdpc3RyeVtrZXldO1xuICAgICAgICBpZiAoIXJlZ3Rva2VuKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICByZWd0b2tlbi5zb3J0a2V5cyA9IHVuZGVmaW5lZDtcbiAgICAgICAgSXRlbSA9IHRoaXMuc3RhdGUucmV0cmlldmVJdGVtKGtleSk7XG4gICAgICAgIHZhciBha2V5ID0gcmVndG9rZW4uYW1iaWc7XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgYWtleSkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MgPSBmYWxzZTtcbiAgICAgICAgICAgIGFrZXkgPSBDU0wuZ2V0QW1iaWd1b3VzQ2l0ZS5jYWxsKHRoaXMuc3RhdGUsIEl0ZW0pO1xuICAgICAgICAgICAgYWJhc2UgPSBDU0wuZ2V0QW1iaWdDb25maWcuY2FsbCh0aGlzLnN0YXRlKTtcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJBbWJpZ1Rva2VuKGFrZXksIGtleSwgYWJhc2UpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGFra2V5IGluIHRoaXMuYW1iaWdyZXNldHMpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmFtYmlncmVzZXRzW2Fra2V5XSA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHZhciBsb25lS2V5ID0gdGhpcy5hbWJpZ2NpdGVzW2FrZXldWzBdO1xuICAgICAgICAgICAgICAgIHZhciBJdGVtID0gdGhpcy5zdGF0ZS5yZXRyaWV2ZUl0ZW0obG9uZUtleSk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeVtsb25lS2V5XS5kaXNhbWJpZyA9IG5ldyBDU0wuQW1iaWdDb25maWc7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgYWtleSA9IENTTC5nZXRBbWJpZ3VvdXNDaXRlLmNhbGwodGhpcy5zdGF0ZSwgSXRlbSk7XG4gICAgICAgICAgICAgICAgdmFyIGFiYXNlID0gQ1NMLmdldEFtYmlnQ29uZmlnLmNhbGwodGhpcy5zdGF0ZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlckFtYmlnVG9rZW4oYWtleSwgbG9uZUtleSwgYWJhc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW2tleV0gPSB0cnVlO1xuICAgICAgICB0aGlzLmFtYmlnc1RvdWNoZWRbYWtleV0gPSB0cnVlO1xuICAgICAgICBpZiAoIUl0ZW0ubGVnaXNsYXRpb25faWQpIHtcbiAgICAgICAgICAgIHRoaXMuYWtleXNbYWtleV0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudG91Y2hlZFtrZXldID0gdHJ1ZTtcbiAgICB9XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5zZXRkaXNhbWJpZ3MgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGFrZXksIGxlZnRvdmVycywga2V5LCBwb3MsIGxlbiwgaWQ7XG4gICAgdGhpcy5sZWZ0b3ZlcnMgPSBbXTtcbiAgICBmb3IgKGFrZXkgaW4gdGhpcy5hbWJpZ3NUb3VjaGVkKSB7XG4gICAgICAgIHRoaXMuc3RhdGUuZGlzYW1iaWd1YXRlLnJ1bihha2V5KTtcbiAgICB9XG4gICAgdGhpcy5hbWJpZ3NUb3VjaGVkID0ge307XG4gICAgdGhpcy5ha2V5cyA9IHt9O1xufTtcbkNTTC5SZWdpc3RyeS5wcm90b3R5cGUucmVudW1iZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGxlbiwgcG9zLCBpdGVtO1xuICAgIGlmICh0aGlzLnN0YXRlLm9wdC5jaXRhdGlvbl9udW1iZXJfc29ydF9kaXJlY3Rpb24gPT09IENTTC5ERVNDRU5ESU5HXG4gICAgICAgJiYgdGhpcy5zdGF0ZS5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnRfdXNlZCkge1xuICAgIH1cbiAgICBsZW4gPSB0aGlzLnJlZmxpc3QubGVuZ3RoO1xuICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBpdGVtID0gdGhpcy5yZWZsaXN0W3Bvc107XG4gICAgICAgIGl0ZW0uc2VxID0gKHBvcyArIDEpO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5vcHQudXBkYXRlX21vZGUgPT09IENTTC5OVU1FUklDICYmIGl0ZW0uc2VxICE9IHRoaXMub2xkc2VxW2l0ZW0uaWRdKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC50YWludGVkSXRlbUlEc1tpdGVtLmlkXSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUub3B0LmJpYl9tb2RlID09PSBDU0wuTlVNRVJJQyAmJiBpdGVtLnNlcSAhPSB0aGlzLm9sZHNlcVtpdGVtLmlkXSkge1xuICAgICAgICAgICAgdGhpcy5yZXR1cm5fZGF0YS5iaWJjaGFuZ2UgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXRlLm9wdC5jaXRhdGlvbl9udW1iZXJfc29ydF9kaXJlY3Rpb24gPT09IENTTC5ERVNDRU5ESU5HXG4gICAgICAgJiYgdGhpcy5zdGF0ZS5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnRfdXNlZCkge1xuICAgICAgICB0aGlzLnJlZmxpc3QucmV2ZXJzZSgpO1xuICAgIH1cbn07XG5DU0wuUmVnaXN0cnkucHJvdG90eXBlLnNldHNvcnRrZXlzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBrZXk7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLm15bGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIGtleSA9IHRoaXMubXlsaXN0W2ldO1xuICAgICAgICBpZiAodGhpcy50b3VjaGVkW2tleV0gfHwgdGhpcy5zdGF0ZS50bXAudGFpbnRlZEl0ZW1JRHNba2V5XSB8fCAhdGhpcy5yZWdpc3RyeVtrZXldLnNvcnRrZXlzKSB7XG4gICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5W2tleV0uc29ydGtleXMgPSBDU0wuZ2V0U29ydEtleXMuY2FsbCh0aGlzLnN0YXRlLCB0aGlzLnN0YXRlLnJldHJpZXZlSXRlbShrZXkpLCBcImJpYmxpb2dyYXBoeV9zb3J0XCIpO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5SZWdpc3RyeS5wcm90b3R5cGUuc29ydHRva2VucyA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnJlZmxpc3Quc29ydCh0aGlzLnNvcnRlci5jb21wYXJlS2V5cyk7XG59O1xuQ1NMLlJlZ2lzdHJ5LkNvbXBhcmlmaWVyID0gZnVuY3Rpb24gKHN0YXRlLCBrZXlzZXQpIHtcbiAgICB2YXIgc29ydF9kaXJlY3Rpb25zLCBsZW4sIHBvcywgY29tcGFyZUtleXM7XG4gICAgdmFyIHNvcnRDb21wYXJlID0gQ1NMLmdldFNvcnRDb21wYXJlKHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlLXNvcnRcIl0pO1xuICAgIHNvcnRfZGlyZWN0aW9ucyA9IHN0YXRlW2tleXNldF0ub3B0LnNvcnRfZGlyZWN0aW9ucztcbiAgICB0aGlzLmNvbXBhcmVLZXlzID0gZnVuY3Rpb24gKGEsIGIpIHtcbiAgICAgICAgbGVuID0gYS5zb3J0a2V5cyA/IGEuc29ydGtleXMubGVuZ3RoIDogMDtcbiAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICB2YXIgY21wID0gMDtcbiAgICAgICAgICAgIGlmIChhLnNvcnRrZXlzW3Bvc10gPT09IGIuc29ydGtleXNbcG9zXSkge1xuICAgICAgICAgICAgICAgIGNtcCA9IDA7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBhLnNvcnRrZXlzW3Bvc10pIHtcbiAgICAgICAgICAgICAgICBjbXAgPSBzb3J0X2RpcmVjdGlvbnNbcG9zXVsxXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGIuc29ydGtleXNbcG9zXSkge1xuICAgICAgICAgICAgICAgIGNtcCA9IHNvcnRfZGlyZWN0aW9uc1twb3NdWzBdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjbXAgPSBzb3J0Q29tcGFyZShhLnNvcnRrZXlzW3Bvc10sIGIuc29ydGtleXNbcG9zXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoMCA8IGNtcCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzb3J0X2RpcmVjdGlvbnNbcG9zXVsxXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoMCA+IGNtcCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzb3J0X2RpcmVjdGlvbnNbcG9zXVswXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoYS5zZXEgPiBiLnNlcSkge1xuICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgIH0gZWxzZSBpZiAoYS5zZXEgPCBiLnNlcSkge1xuICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAwO1xuICAgIH07XG4gICAgY29tcGFyZUtleXMgPSB0aGlzLmNvbXBhcmVLZXlzO1xuICAgIHRoaXMuY29tcGFyZUNvbXBvc2l0ZUtleXMgPSBmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICByZXR1cm4gY29tcGFyZUtleXMoYVsxXSwgYlsxXSk7XG4gICAgfTtcbn07XG5DU0wuUmVnaXN0cnkucHJvdG90eXBlLmNvbXBhcmVSZWdpc3RyeVRva2VucyA9IGZ1bmN0aW9uIChhLCBiKSB7XG4gICAgaWYgKGEuc2VxID4gYi5zZXEpIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgfSBlbHNlIGlmIChhLnNlcSA8IGIuc2VxKSB7XG4gICAgICAgIHJldHVybiAtMTtcbiAgICB9XG4gICAgcmV0dXJuIDA7XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5yZWdpc3RlckFtYmlnVG9rZW4gPSBmdW5jdGlvbiAoYWtleSwgaWQsIGFtYmlnX2NvbmZpZykge1xuICAgIGlmICh0aGlzLnJlZ2lzdHJ5W2lkXSAmJiB0aGlzLnJlZ2lzdHJ5W2lkXS5kaXNhbWJpZyAmJiB0aGlzLnJlZ2lzdHJ5W2lkXS5kaXNhbWJpZy5uYW1lcykge1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGFtYmlnX2NvbmZpZy5uYW1lcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHZhciBuZXdfbmFtZXNfcGFyYW1zID0gYW1iaWdfY29uZmlnLm5hbWVzW2ldO1xuICAgICAgICAgICAgdmFyIG9sZF9uYW1lc19wYXJhbXMgPSB0aGlzLnJlZ2lzdHJ5W2lkXS5kaXNhbWJpZy5uYW1lc1tpXTtcbiAgICAgICAgICAgIGlmIChuZXdfbmFtZXNfcGFyYW1zICE9PSBvbGRfbmFtZXNfcGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudGFpbnRlZEl0ZW1JRHNbaWRdID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYW1iaWdfY29uZmlnLmdpdmVuc1tpXSkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPWFtYmlnX2NvbmZpZy5naXZlbnNbaV0ubGVuZ3RoO2o8amxlbjtqKz0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdfZ25hbWVzX3BhcmFtcyA9IGFtYmlnX2NvbmZpZy5naXZlbnNbaV1bal07XG4gICAgICAgICAgICAgICAgICAgIHZhciBvbGRfZ25hbWVzX3BhcmFtcyA9IHRoaXMucmVnaXN0cnlbaWRdLmRpc2FtYmlnLmdpdmVuc1tpXVtqXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ld19nbmFtZXNfcGFyYW1zICE9PSBvbGRfZ25hbWVzX3BhcmFtcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudGFpbnRlZEl0ZW1JRHNbaWRdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXRoaXMuYW1iaWdjaXRlc1tha2V5XSkge1xuICAgICAgICB0aGlzLmFtYmlnY2l0ZXNbYWtleV0gPSBbXTtcbiAgICB9XG4gICAgaWYgKHRoaXMuYW1iaWdjaXRlc1tha2V5XS5pbmRleE9mKFwiXCIgKyBpZCkgPT09IC0xKSB7XG4gICAgICAgIHRoaXMuYW1iaWdjaXRlc1tha2V5XS5wdXNoKFwiXCIgKyBpZCk7XG4gICAgfVxuICAgIHRoaXMucmVnaXN0cnlbaWRdLmFtYmlnID0gYWtleTtcbiAgICB2YXIgZG9tZSA9IGZhbHNlO1xuICAgIHRoaXMucmVnaXN0cnlbaWRdLmRpc2FtYmlnID0gQ1NMLmNsb25lQW1iaWdDb25maWcoYW1iaWdfY29uZmlnKTtcbn07XG5DU0wuZ2V0U29ydEtleXMgPSBmdW5jdGlvbiAoSXRlbSwga2V5X3R5cGUpIHtcbiAgICB2YXIgYXJlYSwgcm9vdCwgZXh0ZW5zaW9uLCBzdHJpcF9wcmVwb3NpdGlvbnMsIHVzZV9wYXJhbGxlbHMsIGxlbiwgcG9zO1xuICAgIGFyZWEgPSB0aGlzLnRtcC5hcmVhO1xuICAgIHJvb3QgPSB0aGlzLnRtcC5yb290O1xuICAgIGV4dGVuc2lvbiA9IHRoaXMudG1wLmV4dGVuc2lvbjtcbiAgICBzdHJpcF9wcmVwb3NpdGlvbnMgPSBDU0wuVXRpbC5Tb3J0LnN0cmlwX3ByZXBvc2l0aW9ucztcbiAgICB0aGlzLnRtcC5hcmVhID0ga2V5X3R5cGU7XG4gICAgdGhpcy50bXAucm9vdCA9IGtleV90eXBlLmluZGV4T2YoXCJfXCIpID4gLTEgPyBrZXlfdHlwZS5zbGljZSgwLC01KSA6IGtleV90eXBlO1xuICAgIHRoaXMudG1wLmV4dGVuc2lvbiA9IFwiX3NvcnRcIjtcbiAgICB0aGlzLnRtcC5kaXNhbWJpZ19vdmVycmlkZSA9IHRydWU7XG4gICAgdGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdCA9IGZhbHNlO1xuICAgIHRoaXMucGFyYWxsZWwudXNlX3BhcmFsbGVscyA9ICh0aGlzLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPT09IHRydWUgfHwgdGhpcy5wYXJhbGxlbC51c2VfcGFyYWxsZWxzID09PSBudWxsKSA/IG51bGwgOiBmYWxzZTtcbiAgICB0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucyA9IHRydWU7XG4gICAgQ1NMLmdldENpdGUuY2FsbCh0aGlzLCBJdGVtKTtcbiAgICB0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucyA9IGZhbHNlO1xuICAgIHRoaXMucGFyYWxsZWwudXNlX3BhcmFsbGVscyA9IHRoaXMucGFyYWxsZWwudXNlX3BhcmFsbGVscyA9PT0gbnVsbCA/IHRydWUgOiBmYWxzZTtcbiAgICB0aGlzLnRtcC5kaXNhbWJpZ19vdmVycmlkZSA9IGZhbHNlO1xuICAgIGxlbiA9IHRoaXNba2V5X3R5cGVdLmtleXMubGVuZ3RoO1xuICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICB0aGlzW2tleV90eXBlXS5rZXlzW3Bvc10gPSBzdHJpcF9wcmVwb3NpdGlvbnModGhpc1trZXlfdHlwZV0ua2V5c1twb3NdKTtcbiAgICB9XG4gICAgdGhpcy50bXAuYXJlYSA9IGFyZWE7XG4gICAgdGhpcy50bXAucm9vdCA9IHJvb3Q7XG4gICAgdGhpcy50bXAuZXh0ZW5zaW9uID0gZXh0ZW5zaW9uO1xuICAgIHJldHVybiB0aGlzW2tleV90eXBlXS5rZXlzO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlJlZ2lzdHJ5Lk5hbWVSZWcgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICB2YXIgcGtleSwgaWtleSwgc2tleSwgZmxvb3IsIGNlaWxpbmcsIGRhZ29wdCwgZ2Ryb3B0LCByZXQsIHBvcywgaXRlbXMsIHN0cmlwX3BlcmlvZHMsIHNldF9rZXlzLCBldmFsbmFtZSwgZGVsaXRlbXMsIGFkZG5hbWUsIGtleSwgbXlpdGVtcywgaSwgaWxlbjtcbiAgICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gICAgdGhpcy5uYW1lcmVnID0ge307XG4gICAgdGhpcy5uYW1laW5kID0ge307XG4gICAgdGhpcy5uYW1laW5kcGtleXMgPSB7fTtcbiAgICB0aGlzLml0ZW1rZXlyZWcgPSB7fTtcbiAgICBzdHJpcF9wZXJpb2RzID0gZnVuY3Rpb24gKHN0cikge1xuICAgICAgICBpZiAoIXN0cikge1xuICAgICAgICAgICAgc3RyID0gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1xcLi9nLCBcIiBcIikucmVwbGFjZSgvXFxzKy9nLCBcIiBcIikucmVwbGFjZSgvXFxzKyQvLFwiXCIpO1xuICAgIH07XG4gICAgc2V0X2tleXMgPSBmdW5jdGlvbiAoc3RhdGUsIGl0ZW1pZCwgbmFtZW9iaikge1xuICAgICAgICBwa2V5ID0gc3RyaXBfcGVyaW9kcyhuYW1lb2JqLmZhbWlseSk7XG4gICAgICAgIHNrZXkgPSBzdHJpcF9wZXJpb2RzKG5hbWVvYmouZ2l2ZW4pO1xuICAgICAgICB2YXIgbSA9IHNrZXkubWF0Y2goL1ssXFwhXSogKFteLF0rKSQvKTtcbiAgICAgICAgaWYgKG0gJiYgbVsxXSA9PT0gbVsxXS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgICBza2V5ID0gc2tleS5yZXBsYWNlKC9bLFxcIV0qIFteLF0rJC8sIFwiXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlrZXkgPSBDU0wuVXRpbC5OYW1lcy5pbml0aWFsaXplV2l0aChzdGF0ZSwgc2tleSwgXCIlc1wiKTtcbiAgICAgICAgaWYgKHN0YXRlLmNpdGF0aW9uLm9wdFtcImdpdmVubmFtZS1kaXNhbWJpZ3VhdGlvbi1ydWxlXCJdID09PSBcImJ5LWNpdGVcIikge1xuICAgICAgICAgICAgcGtleSA9IFwiXCIgKyBpdGVtaWQgKyBwa2V5O1xuICAgICAgICB9XG4gICAgfTtcbiAgICBldmFsbmFtZSA9IGZ1bmN0aW9uIChpdGVtX2lkLCBuYW1lb2JqLCBuYW1lbnVtLCByZXF1ZXN0X2Jhc2UsIGZvcm0sIGluaXRpYWxzKSB7XG4gICAgICAgIHZhciBwb3MsIGxlbiwgaXRlbXMsIHBhcmFtO1xuICAgICAgICBpZiAoc3RhdGUudG1wLmFyZWEuc2xpY2UoMCwgMTIpID09PSBcImJpYmxpb2dyYXBoeVwiICYmICFmb3JtKSB7XG4gICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGluaXRpYWxzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiAyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciByZXMgPSBzdGF0ZS5uYW1lT3V0cHV0LmdldE5hbWUobmFtZW9iaiwgXCJsb2NhbGUtdHJhbnNsaXRcIiwgdHJ1ZSk7XG4gICAgICAgIG5hbWVvYmogPSByZXMubmFtZTtcbiAgICAgICAgc2V0X2tleXModGhpcy5zdGF0ZSwgXCJcIiArIGl0ZW1faWQsIG5hbWVvYmopO1xuICAgICAgICBwYXJhbSA9IDI7XG4gICAgICAgIGRhZ29wdCA9IHN0YXRlLm9wdFtcImRpc2FtYmlndWF0ZS1hZGQtZ2l2ZW5uYW1lXCJdO1xuICAgICAgICBnZHJvcHQgPSBzdGF0ZS5jaXRhdGlvbi5vcHRbXCJnaXZlbm5hbWUtZGlzYW1iaWd1YXRpb24tcnVsZVwiXTtcbiAgICAgICAgdmFyIGdkcm9wdF9vcmlnID0gZ2Ryb3B0O1xuICAgICAgICBpZiAoZ2Ryb3B0ID09PSBcImJ5LWNpdGVcIikge1xuICAgICAgICAgICAgZ2Ryb3B0ID0gXCJhbGwtbmFtZXNcIjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJzaG9ydFwiID09PSBmb3JtKSB7XG4gICAgICAgICAgICBwYXJhbSA9IDA7XG4gICAgICAgIH0gZWxzZSBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGluaXRpYWxzKSB7XG4gICAgICAgICAgICBwYXJhbSA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLm5hbWVyZWdbcGtleV0gfHwgXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldKSB7XG4gICAgICAgICAgICByZXR1cm4gcGFyYW07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGdkcm9wdF9vcmlnID09PSBcImJ5LWNpdGVcIiAmJiBwYXJhbSA8PSByZXF1ZXN0X2Jhc2UpIHtcbiAgICAgICAgICAgIHJldHVybiByZXF1ZXN0X2Jhc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFkYWdvcHQpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJhbTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGdkcm9wdCAmJiBnZHJvcHQuc2xpY2UoMCwgMTIpID09PSBcInByaW1hcnktbmFtZVwiICYmIG5hbWVudW0gPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gcGFyYW07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFnZHJvcHQgfHwgZ2Ryb3B0ID09PSBcImFsbC1uYW1lc1wiIHx8IGdkcm9wdCA9PT0gXCJwcmltYXJ5LW5hbWVcIikge1xuICAgICAgICAgICAgaWYgKHRoaXMubmFtZXJlZ1twa2V5XS5jb3VudCA+IDEpIHtcbiAgICAgICAgICAgICAgICBwYXJhbSA9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoKHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5IFxuICAgICAgICAgICAgICAgICAmJiB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5jb3VudCA+IDEpXG4gICAgICAgICAgICAgICAgfHwgKHRoaXMubmFtZXJlZ1twa2V5XS5jb3VudCA+IDEgXG4gICAgICAgICAgICAgICAgICAgICYmIFwic3RyaW5nXCIgIT09IHR5cGVvZiBpbml0aWFscykpIHtcbiAgICAgICAgICAgICAgICBwYXJhbSA9IDI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZ2Ryb3B0ID09PSBcImFsbC1uYW1lcy13aXRoLWluaXRpYWxzXCIgfHwgZ2Ryb3B0ID09PSBcInByaW1hcnktbmFtZS13aXRoLWluaXRpYWxzXCIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLm5hbWVyZWdbcGtleV0uY291bnQgPiAxKSB7XG4gICAgICAgICAgICAgICAgcGFyYW0gPSAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwYXJhbSA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtpdGVtX2lkXSkge1xuICAgICAgICAgICAgaWYgKGZvcm0gPT0gXCJzaG9ydFwiKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKFwic3RyaW5nXCIgPT0gdHlwZW9mIGluaXRpYWxzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gcGFyYW07XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGRlbGl0ZW1zID0gZnVuY3Rpb24gKGlkcykge1xuICAgICAgICB2YXIgaXRlbSwgcG9zLCBsZW4sIHBvc0EsIHBvc0IsIGlkLCBmdWxsa2V5LCBsbGVuLCBwcG9zLCBvdGhlcmlkO1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGlkcyB8fCBcIm51bWJlclwiID09PSB0eXBlb2YgaWRzKSB7XG4gICAgICAgICAgICBpZHMgPSBbXCJcIiArIGlkc107XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHJldCA9IHt9O1xuICAgICAgICBsZW4gPSBpZHMubGVuZ3RoO1xuICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIGlkID0gXCJcIiArIGlkc1twb3NdO1xuICAgICAgICAgICAgaWYgKCF0aGlzLm5hbWVpbmRbaWRdKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGZ1bGxrZXkgaW4gdGhpcy5uYW1laW5kW2lkXSkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLm5hbWVpbmRbaWRdLmhhc093blByb3BlcnR5KGZ1bGxrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBmdWxsa2V5LnNwbGl0KFwiOjpcIik7XG4gICAgICAgICAgICAgICAgICAgIHBrZXkgPSBrZXlbMF07XG4gICAgICAgICAgICAgICAgICAgIGlrZXkgPSBrZXlbMV07XG4gICAgICAgICAgICAgICAgICAgIHNrZXkgPSBrZXlbMl07XG4gICAgICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5uYW1lcmVnW3BrZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IHRoaXMubmFtZXJlZ1twa2V5XS5pdGVtcztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNrZXkgJiYgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0gJiYgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uc2tleVtza2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbXlpdGVtcyA9IHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLnNrZXlbc2tleV0uaXRlbXM7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3NCID0gbXlpdGVtcy5pbmRleE9mKFwiXCIgKyBpZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zQiA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uc2tleVtza2V5XS5pdGVtcyA9IG15aXRlbXMuc2xpY2UoMCwgcG9zQikuY29uY2F0KG15aXRlbXMuc2xpY2UoWyhwb3NCICsgMSldKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uc2tleVtza2V5XS5pdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uc2tleVtza2V5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5jb3VudCArPSAtMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uY291bnQgPCAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uaXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAudGFpbnRlZEl0ZW1JRHNbdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uaXRlbXNbaV1dID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoaWtleSAmJiB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9zQiA9IHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLml0ZW1zLmluZGV4T2YoXCJcIiArIGlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NCID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLml0ZW1zLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uaXRlbXMgPSBpdGVtcy5zbGljZSgwLCBwb3NCKS5jb25jYXQoaXRlbXMuc2xpY2UoW3Bvc0IgKyAxXSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLml0ZW1zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uY291bnQgKz0gLTE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubmFtZXJlZ1twa2V5XS5jb3VudCA8IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLm5hbWVyZWdbcGtleV0uaXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAudGFpbnRlZEl0ZW1JRHNbdGhpcy5uYW1lcmVnW3BrZXldLml0ZW1zW2ldXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHBrZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvc0IgPSB0aGlzLm5hbWVyZWdbcGtleV0uaXRlbXMuaW5kZXhPZihcIlwiICsgaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc0IgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zID0gdGhpcy5uYW1lcmVnW3BrZXldLml0ZW1zLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLml0ZW1zID0gaXRlbXMuc2xpY2UoMCwgcG9zQikuY29uY2F0KGl0ZW1zLnNsaWNlKFtwb3NCICsgMV0sIGl0ZW1zLmxlbmd0aCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubmFtZXJlZ1twa2V5XS5pdGVtcy5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubmFtZXJlZ1twa2V5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5uYW1laW5kW2lkXVtmdWxsa2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5uYW1laW5kW2lkXTtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5hbWVpbmRwa2V5c1tpZF07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuICAgIGFkZG5hbWUgPSBmdW5jdGlvbiAoaXRlbV9pZCwgbmFtZW9iaiwgcG9zKSB7XG4gICAgICAgIHZhciBpLCBpbGVuO1xuICAgICAgICB2YXIgcmVzID0gc3RhdGUubmFtZU91dHB1dC5nZXROYW1lKG5hbWVvYmosIFwibG9jYWxlLXRyYW5zbGl0XCIsIHRydWUpO1xuICAgICAgICBuYW1lb2JqID0gcmVzLm5hbWU7XG4gICAgICAgIGlmIChzdGF0ZS5jaXRhdGlvbi5vcHRbXCJnaXZlbm5hbWUtZGlzYW1iaWd1YXRpb24tcnVsZVwiXVxuICAgICAgICAgICAgJiYgc3RhdGUuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0uc2xpY2UoMCwgOCkgPT09IFwicHJpbWFyeS1cIlxuICAgICAgICAgICAgJiYgcG9zICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHNldF9rZXlzKHRoaXMuc3RhdGUsIFwiXCIgKyBpdGVtX2lkLCBuYW1lb2JqKTtcbiAgICAgICAgaWYgKHBrZXkpIHtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5uYW1lcmVnW3BrZXldKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldID0ge307XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmNvdW50ID0gMDtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaWtleSA9IHt9O1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pdGVtcyA9IFtpdGVtX2lkXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5uYW1lcmVnW3BrZXldLml0ZW1zLmluZGV4T2YoaXRlbV9pZCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLml0ZW1zLnB1c2goaXRlbV9pZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBrZXkgJiYgaWtleSkge1xuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XSkge1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldID0ge307XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uY291bnQgPSAwO1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLnNrZXkgPSB7fTtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5pdGVtcyA9IFtpdGVtX2lkXTtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uY291bnQgKz0gMTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5uYW1lcmVnW3BrZXldLmNvdW50ID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5uYW1lcmVnW3BrZXldLml0ZW1zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW3RoaXMubmFtZXJlZ1twa2V5XS5pdGVtc1tpXV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5pdGVtcy5pbmRleE9mKGl0ZW1faWQpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLml0ZW1zLnB1c2goaXRlbV9pZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBrZXkgJiYgaWtleSAmJiBza2V5KSB7XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLnNrZXlbc2tleV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5za2V5W3NrZXldID0ge307XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uc2tleVtza2V5XS5pdGVtcyA9IFtpdGVtX2lkXTtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5jb3VudCArPSAxO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5jb3VudCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLml0ZW1zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW3RoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLml0ZW1zW2ldXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLnNrZXlbc2tleV0uaXRlbXMuaW5kZXhPZihpdGVtX2lkKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5za2V5W3NrZXldLml0ZW1zLnB1c2goaXRlbV9pZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLm5hbWVpbmRbaXRlbV9pZF0pIHtcbiAgICAgICAgICAgIHRoaXMubmFtZWluZFtpdGVtX2lkXSA9IHt9O1xuICAgICAgICAgICAgdGhpcy5uYW1laW5kcGtleXNbaXRlbV9pZF0gPSB7fTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocGtleSkge1xuICAgICAgICAgICAgdGhpcy5uYW1laW5kW2l0ZW1faWRdW3BrZXkgKyBcIjo6XCIgKyBpa2V5ICsgXCI6OlwiICsgc2tleV0gPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5uYW1laW5kcGtleXNbaXRlbV9pZF1bcGtleV0gPSB0aGlzLm5hbWVyZWdbcGtleV07XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuYWRkbmFtZSA9IGFkZG5hbWU7XG4gICAgdGhpcy5kZWxpdGVtcyA9IGRlbGl0ZW1zO1xuICAgIHRoaXMuZXZhbG5hbWUgPSBldmFsbmFtZTtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5SZWdpc3RyeS5DaXRhdGlvblJlZyA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIHRoaXMuY2l0YXRpb25CeUlkID0ge307XG4gICAgdGhpcy5jaXRhdGlvbkJ5SW5kZXggPSBbXTtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5EaXNhbWJpZ3VhdGlvbiA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICB0aGlzLnN5cyA9IHRoaXMuc3RhdGUuc3lzO1xuICAgIHRoaXMucmVnaXN0cnkgPSBzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeTtcbiAgICB0aGlzLmFtYmlnY2l0ZXMgPSBzdGF0ZS5yZWdpc3RyeS5hbWJpZ2NpdGVzO1xuICAgIHRoaXMuY29uZmlnTW9kZXMoKTtcbiAgICB0aGlzLmRlYnVnID0gZmFsc2U7XG59O1xuQ1NMLkRpc2FtYmlndWF0aW9uLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbihha2V5KSB7XG4gICAgaWYgKCF0aGlzLm1vZGVzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuYWtleSA9IGFrZXk7XG4gICAgaWYgKHRoaXMuaW5pdFZhcnMoYWtleSkpIHtcbiAgICAgICAgdGhpcy5ydW5EaXNhbWJpZygpO1xuICAgIH1cbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLnJ1bkRpc2FtYmlnID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBwb3MsIGxlbiwgcHBvcywgbGxlbiwgcHBwb3MsIGxsbGVuLCBpc21heDtcbiAgICB0aGlzLmluaXRHaXZlbnMgPSB0cnVlO1xuICAgIHdoaWxlICh0aGlzLmxpc3RzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLmduYW1lc2V0ID0gMDtcbiAgICAgICAgdGhpcy5nbmFtZSA9IDA7XG4gICAgICAgIHRoaXMuY2xhc2hlcyA9IFsxLCAwXTtcbiAgICAgICAgd2hpbGUodGhpcy5saXN0c1swXVsxXS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMubGlzdHBvcyA9IDA7XG4gICAgICAgICAgICBpZiAoIXRoaXMuYmFzZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZSA9IHRoaXMubGlzdHNbMF1bMF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgbmFtZXNfdXNlZCA9IFtdO1xuICAgICAgICAgICAgaXNtYXggPSB0aGlzLmluY3JlbWVudERpc2FtYmlnKCk7XG4gICAgICAgICAgICB0aGlzLnNjYW5JdGVtcyh0aGlzLmxpc3RzWzBdKTtcbiAgICAgICAgICAgIHRoaXMuZXZhbFNjYW4oaXNtYXgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubGlzdHMgPSB0aGlzLmxpc3RzLnNsaWNlKDEpO1xuICAgIH1cbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLnNjYW5JdGVtcyA9IGZ1bmN0aW9uIChsaXN0KSB7XG4gICAgdmFyIHBvcywgbGVuLCBJdGVtLCBvdGhlckl0ZW0sIEl0ZW1DaXRlLCBpZ25vcmUsIGJhc2U7XG4gICAgdGhpcy5JdGVtID0gbGlzdFsxXVswXTtcbiAgICB0aGlzLkl0ZW1DaXRlID0gQ1NMLmdldEFtYmlndW91c0NpdGUuY2FsbCh0aGlzLnN0YXRlLCB0aGlzLkl0ZW0sIHRoaXMuYmFzZSwgdHJ1ZSk7XG4gICAgdGhpcy5zY2FubGlzdCA9IGxpc3RbMV07XG4gICAgdGhpcy5wYXJ0bmVycyA9IFtdO1xuICAgIHRoaXMucGFydG5lcnMucHVzaCh0aGlzLkl0ZW0pO1xuICAgIHRoaXMubm9ucGFydG5lcnMgPSBbXTtcbiAgICB2YXIgY2xhc2hlcyA9IDA7XG4gICAgZm9yICh2YXIgcG9zID0gMSwgbGVuID0gbGlzdFsxXS5sZW5ndGg7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgb3RoZXJJdGVtID0gbGlzdFsxXVtwb3NdO1xuICAgICAgICB2YXIgb3RoZXJJdGVtQ2l0ZSA9IENTTC5nZXRBbWJpZ3VvdXNDaXRlLmNhbGwodGhpcy5zdGF0ZSwgb3RoZXJJdGVtLCB0aGlzLmJhc2UsIHRydWUpO1xuICAgICAgICBpZiAodGhpcy5JdGVtQ2l0ZSA9PT0gb3RoZXJJdGVtQ2l0ZSkge1xuICAgICAgICAgICAgY2xhc2hlcyArPSAxO1xuICAgICAgICAgICAgdGhpcy5wYXJ0bmVycy5wdXNoKG90aGVySXRlbSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm5vbnBhcnRuZXJzLnB1c2gob3RoZXJJdGVtKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmNsYXNoZXNbMF0gPSB0aGlzLmNsYXNoZXNbMV07XG4gICAgdGhpcy5jbGFzaGVzWzFdID0gY2xhc2hlcztcbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLmV2YWxTY2FuID0gZnVuY3Rpb24gKG1heGVkKSB7XG4gICAgdGhpc1t0aGlzLm1vZGVzW3RoaXMubW9kZWluZGV4XV0obWF4ZWQpO1xuICAgIGlmIChtYXhlZCkge1xuICAgICAgICBpZiAodGhpcy5tb2RlaW5kZXggPCB0aGlzLm1vZGVzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIHRoaXMubW9kZWluZGV4ICs9IDE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RzW3RoaXMubGlzdHBvcyArIDFdID0gW3RoaXMuYmFzZSwgW11dO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5EaXNhbWJpZ3VhdGlvbi5wcm90b3R5cGUuZGlzTmFtZXMgPSBmdW5jdGlvbiAoaXNtYXgpIHtcbiAgICB2YXIgcG9zLCBsZW4sIG15YmFzZSwgaSwgaWxlbjtcbiAgICBpZiAodGhpcy5jbGFzaGVzWzFdID09PSAwICYmIHRoaXMubm9ucGFydG5lcnMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHRoaXMuY2FwdHVyZVN0ZXBUb0Jhc2UoKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RlckFtYmlnVG9rZW4odGhpcy5ha2V5LCBcIlwiICsgdGhpcy5ub25wYXJ0bmVyc1swXS5pZCwgdGhpcy5iZXR0ZXJiYXNlKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RlckFtYmlnVG9rZW4odGhpcy5ha2V5LCBcIlwiICsgdGhpcy5wYXJ0bmVyc1swXS5pZCwgdGhpcy5iZXR0ZXJiYXNlKTtcbiAgICAgICAgdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdID0gW3RoaXMuYmV0dGVyYmFzZSwgW11dO1xuICAgIH0gZWxzZSBpZiAodGhpcy5jbGFzaGVzWzFdID09PSAwKSB7XG4gICAgICAgIHRoaXMuY2FwdHVyZVN0ZXBUb0Jhc2UoKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RlckFtYmlnVG9rZW4odGhpcy5ha2V5LCBcIlwiICsgdGhpcy5wYXJ0bmVyc1swXS5pZCwgdGhpcy5iZXR0ZXJiYXNlKTtcbiAgICAgICAgdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdID0gW3RoaXMuYmV0dGVyYmFzZSwgdGhpcy5ub25wYXJ0bmVyc107XG4gICAgICAgIGlmICh0aGlzLm5vbnBhcnRuZXJzLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5pbml0R2l2ZW5zID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGhpcy5ub25wYXJ0bmVycy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgdGhpcy5jYXB0dXJlU3RlcFRvQmFzZSgpO1xuICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdGVyQW1iaWdUb2tlbih0aGlzLmFrZXksIFwiXCIgKyB0aGlzLm5vbnBhcnRuZXJzWzBdLmlkLCB0aGlzLmJldHRlcmJhc2UpO1xuICAgICAgICB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc10gPSBbdGhpcy5iZXR0ZXJiYXNlLCB0aGlzLnBhcnRuZXJzXTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuY2xhc2hlc1sxXSA8IHRoaXMuY2xhc2hlc1swXSkge1xuICAgICAgICB0aGlzLmNhcHR1cmVTdGVwVG9CYXNlKCk7XG4gICAgICAgIHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXSA9IFt0aGlzLmJldHRlcmJhc2UsIHRoaXMucGFydG5lcnNdO1xuICAgICAgICB0aGlzLmxpc3RzLnB1c2goW3RoaXMuYmV0dGVyYmFzZSwgdGhpcy5ub25wYXJ0bmVyc10pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChpc21heCkge1xuICAgICAgICAgICAgdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdID0gW3RoaXMuYmV0dGVyYmFzZSwgdGhpcy5ub25wYXJ0bmVyc107XG4gICAgICAgICAgICB0aGlzLmxpc3RzLnB1c2goW3RoaXMuYmV0dGVyYmFzZSwgdGhpcy5wYXJ0bmVyc10pO1xuICAgICAgICAgICAgaWYgKHRoaXMubW9kZWluZGV4ID09PSB0aGlzLm1vZGVzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMucGFydG5lcnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0ZXJBbWJpZ1Rva2VuKHRoaXMuYWtleSwgXCJcIiArIHRoaXMucGFydG5lcnNbaV0uaWQsIHRoaXMuYmV0dGVyYmFzZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXSA9IFt0aGlzLmJldHRlcmJhc2UsIFtdXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLmRpc0V4dHJhVGV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcG9zLCBsZW4sIG15YmFzZTtcbiAgICB2YXIgZG9uZSA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmNsYXNoZXNbMV0gPT09IDAgJiYgdGhpcy5ub25wYXJ0bmVycy5sZW5ndGggPCAyKSB7XG4gICAgICAgIGRvbmUgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAoIWRvbmUgJiYgKCF0aGlzLmJhc2UuZGlzYW1iaWd1YXRlIHx8IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlndWF0ZV9jb3VudCAhPT0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWd1YXRlX21heE1heCkpIHtcbiAgICAgICAgdGhpcy5tb2RlaW5kZXggPSAwO1xuICAgICAgICB0aGlzLmJhc2UuZGlzYW1iaWd1YXRlID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWd1YXRlX2NvdW50O1xuICAgICAgICB0aGlzLmJldHRlcmJhc2UuZGlzYW1iaWd1YXRlID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWd1YXRlX2NvdW50O1xuICAgICAgICBpZiAoIXRoaXMuYmFzZS5kaXNhbWJpZ3VhdGUpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdEdpdmVucyA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmJhc2UuZGlzYW1iaWd1YXRlID0gMTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdWzFdLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW3RoaXMubGlzdHNbdGhpcy5saXN0cG9zXVsxXVtpXS5pZF0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kaXNOYW1lcygpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmIChkb25lIHx8IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlndWF0ZV9jb3VudCA9PT0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWd1YXRlX21heE1heCkge1xuICAgICAgICBpZiAoZG9uZSB8fCB0aGlzLm1vZGVpbmRleCA9PT0gdGhpcy5tb2Rlcy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICB2YXIgYmFzZSA9IHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXVswXTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdWzFdLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW3RoaXMubGlzdHNbdGhpcy5saXN0cG9zXVsxXVtpXS5pZF0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0ZXJBbWJpZ1Rva2VuKHRoaXMuYWtleSwgXCJcIiArIHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXVsxXVtpXS5pZCwgYmFzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc10gPSBbdGhpcy5iZXR0ZXJiYXNlLCBbXV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm1vZGVpbmRleCA9IHRoaXMubW9kZXMubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgIHZhciBiYXNlID0gdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdWzBdO1xuICAgICAgICAgICAgYmFzZS5kaXNhbWJpZ3VhdGUgPSB0cnVlO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc11bMV0ubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudGFpbnRlZEl0ZW1JRHNbdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdWzFdW2ldLmlkXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RlckFtYmlnVG9rZW4odGhpcy5ha2V5LCBcIlwiICsgdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdWzFdW2ldLmlkLCBiYXNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLmRpc1llYXJzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBwb3MsIGxlbiwgdG9rZW5zLCB0b2tlbiwgaXRlbTtcbiAgICB0b2tlbnMgPSBbXTtcbiAgICB2YXIgYmFzZSA9IHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXVswXTtcbiAgICBpZiAodGhpcy5jbGFzaGVzWzFdKSB7XG5cdFx0Zm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLnN0YXRlLnJlZ2lzdHJ5Lm15bGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcblx0XHRcdHZhciBvcmlnaWQgPSB0aGlzLnN0YXRlLnJlZ2lzdHJ5Lm15bGlzdFtpXTtcblx0XHRcdGZvciAodmFyIGogPSAwLCBqbGVuID0gdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdWzFdLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuXHRcdFx0XHR2YXIgdG9rZW4gPSB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc11bMV1bal07XG5cdFx0XHRcdGlmICh0b2tlbi5pZCA9PSBvcmlnaWQpIHtcblx0XHRcdFx0XHR0b2tlbnMucHVzaCh0aGlzLnJlZ2lzdHJ5W3Rva2VuLmlkXSk7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG4gICAgfVxuICAgIHRva2Vucy5zb3J0KHRoaXMuc3RhdGUucmVnaXN0cnkuc29ydGVyLmNvbXBhcmVLZXlzKTtcbiAgICBmb3IgKHZhciBwb3MgPSAwLCBsZW4gPSB0b2tlbnMubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIGJhc2UueWVhcl9zdWZmaXggPSBcIlwiK3BvcztcbiAgICAgICAgdmFyIG9sZEJhc2UgPSB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W3Rva2Vuc1twb3NdLmlkXS5kaXNhbWJpZztcbiAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RlckFtYmlnVG9rZW4odGhpcy5ha2V5LCBcIlwiICsgdG9rZW5zW3Bvc10uaWQsIGJhc2UpO1xuICAgICAgICBpZiAoQ1NMLmFtYmlnQ29uZmlnRGlmZihvbGRCYXNlLGJhc2UpKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC50YWludGVkSXRlbUlEc1t0b2tlbnNbcG9zXS5pZF0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXSA9IFt0aGlzLmJldHRlcmJhc2UsIFtdXTtcbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLmluY3JlbWVudERpc2FtYmlnID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciB2YWw7XG4gICAgaWYgKHRoaXMuaW5pdEdpdmVucykge1xuICAgICAgICB0aGlzLmluaXRHaXZlbnMgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB2YXIgbWF4ZWQgPSBmYWxzZTtcbiAgICB2YXIgaW5jcmVtZW50X25hbWVzID0gdHJ1ZTtcbiAgICB2YXIgaW5jcmVtZW50X2dpdmVucyA9IHRydWU7XG4gICAgaWYgKFwiZGlzTmFtZXNcIiA9PT0gdGhpcy5tb2Rlc1t0aGlzLm1vZGVpbmRleF0pIHtcbiAgICAgICAgaW5jcmVtZW50X25hbWVzID0gZmFsc2U7XG4gICAgICAgIGlmIChcIm51bWJlclwiICE9PSB0eXBlb2YgdGhpcy5naXZlbnNNYXgpIHtcbiAgICAgICAgICAgIGluY3JlbWVudF9uYW1lcyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGluY3JlbWVudF9uYW1lc2V0cyA9IGZhbHNlO1xuICAgICAgICBpZiAoXCJudW1iZXJcIiAhPT0gdHlwZW9mIHRoaXMubmFtZXNNYXgpIHtcbiAgICAgICAgICAgIGluY3JlbWVudF9uYW1lc2V0cyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwibnVtYmVyXCIgPT09IHR5cGVvZiB0aGlzLmdpdmVuc01heCkge1xuICAgICAgICAgICAgaWYgKHRoaXMuYmFzZS5naXZlbnMubGVuZ3RoICYmIHRoaXMuYmFzZS5naXZlbnNbdGhpcy5nbmFtZXNldF1bdGhpcy5nbmFtZV0gPCB0aGlzLmdpdmVuc01heCkge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZS5naXZlbnNbdGhpcy5nbmFtZXNldF1bdGhpcy5nbmFtZV0gKz0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaW5jcmVtZW50X25hbWVzID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIHRoaXMubmFtZXNNYXggXG4gICAgICAgICAgICAmJiBpbmNyZW1lbnRfbmFtZXMpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLm9wdFtcImRpc2FtYmlndWF0ZS1hZGQtbmFtZXNcIl0pIHtcbiAgICAgICAgICAgICAgICBpbmNyZW1lbnRfbmFtZXNldHMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5nbmFtZSA8IHRoaXMubmFtZXNNYXgpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlLm5hbWVzW3RoaXMuZ25hbWVzZXRdICs9IDE7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ25hbWUgKz0gMTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpbmNyZW1lbnRfbmFtZXNldHMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaW5jcmVtZW50X25hbWVzZXRzID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIHRoaXMubmFtZXNldHNNYXggJiYgaW5jcmVtZW50X25hbWVzZXRzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5nbmFtZXNldCA8IHRoaXMubmFtZXNldHNNYXgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmduYW1lc2V0ICs9IDE7XG4gICAgICAgICAgICAgICAgdGhpcy5iYXNlLm5hbWVzW3RoaXMuZ25hbWVzZXRdID0gMTtcbiAgICAgICAgICAgICAgICB0aGlzLmduYW1lID0gMDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIGluY3JlbWVudF9tb2RlID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoKFwibnVtYmVyXCIgIT09IHR5cGVvZiB0aGlzLm5hbWVzZXRzTWF4IHx8IHRoaXMubmFtZXNldHNNYXggPT09IC0xIHx8IHRoaXMuZ25hbWVzZXQgPT09IHRoaXMubmFtZXNldHNNYXgpXG4gICAgICAgICAgICAmJiAoIXRoaXMuc3RhdGUub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC1uYW1lc1wiXSB8fCBcIm51bWJlclwiICE9PSB0eXBlb2YgdGhpcy5uYW1lc01heCB8fCB0aGlzLmduYW1lID09PSB0aGlzLm5hbWVzTWF4KVxuICAgICAgICAgICAgJiYgKFwibnVtYmVyXCIgIT0gdHlwZW9mIHRoaXMuZ2l2ZW5zTWF4IHx8IFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLmJhc2UuZ2l2ZW5zW3RoaXMuZ25hbWVzZXRdIHx8IFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLmJhc2UuZ2l2ZW5zW3RoaXMuZ25hbWVzZXRdW3RoaXMuZ25hbWVdIHx8IHRoaXMuYmFzZS5naXZlbnNbdGhpcy5nbmFtZXNldF1bdGhpcy5nbmFtZV0gPT09IHRoaXMuZ2l2ZW5zTWF4KSkge1xuICAgICAgICAgICAgbWF4ZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmIChcImRpc0V4dHJhVGV4dFwiID09PSB0aGlzLm1vZGVzW3RoaXMubW9kZWluZGV4XSkge1xuICAgICAgICB0aGlzLmJhc2UuZGlzYW1iaWd1YXRlICs9IDE7XG4gICAgICAgIHRoaXMuYmV0dGVyYmFzZS5kaXNhbWJpZ3VhdGUgKz0gMTtcbiAgICB9XG4gICAgcmV0dXJuIG1heGVkO1xufTtcbkNTTC5EaXNhbWJpZ3VhdGlvbi5wcm90b3R5cGUuaW5pdFZhcnMgPSBmdW5jdGlvbiAoYWtleSkge1xuICAgIHZhciBpLCBpbGVuLCBteUlkcywgbXlJdGVtQnVuZGxlcywgbXlJdGVtcztcbiAgICB0aGlzLmxpc3RzID0gW107XG4gICAgdGhpcy5iYXNlID0gZmFsc2U7XG4gICAgdGhpcy5iZXR0ZXJiYXNlID0gZmFsc2U7XG4gICAgdGhpcy5ha2V5ID0gYWtleTtcbiAgICB0aGlzLm1heE5hbWVzQnlJdGVtSWQgPSB7fTtcbiAgICBteUl0ZW1CdW5kbGVzID0gW107XG4gICAgbXlJZHMgPSB0aGlzLmFtYmlnY2l0ZXNbYWtleV07XG4gICAgaWYgKCFteUlkcyB8fCAhbXlJZHMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdmFyIEl0ZW0gPSBmYWxzZTtcbiAgICB2YXIgbXlJdGVtID0gdGhpcy5zdGF0ZS5yZXRyaWV2ZUl0ZW0oXCJcIiArIG15SWRzWzBdKTtcbiAgICB0aGlzLmdldENpdGVEYXRhKG15SXRlbSk7XG4gICAgdGhpcy5iYXNlID0gQ1NMLmdldEFtYmlnQ29uZmlnLmNhbGwodGhpcy5zdGF0ZSk7XG4gICAgaWYgKG15SWRzICYmIG15SWRzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgbXlJdGVtQnVuZGxlcy5wdXNoKFt0aGlzLm1heE5hbWVzQnlJdGVtSWRbbXlJdGVtLmlkXSwgbXlJdGVtXSk7XG4gICAgICAgIGZvciAodmFyIGkgPSAxLCBpbGVuID0gbXlJZHMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBteUl0ZW0gPSB0aGlzLnN0YXRlLnJldHJpZXZlSXRlbShcIlwiICsgbXlJZHNbaV0pO1xuICAgICAgICAgICAgdGhpcy5nZXRDaXRlRGF0YShteUl0ZW0sIHRoaXMuYmFzZSk7XG4gICAgICAgICAgICBteUl0ZW1CdW5kbGVzLnB1c2goW3RoaXMubWF4TmFtZXNCeUl0ZW1JZFtteUl0ZW0uaWRdLCBteUl0ZW1dKTtcbiAgICAgICAgfVxuICAgICAgICBteUl0ZW1CdW5kbGVzLnNvcnQoXG4gICAgICAgICAgICBmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICAgICAgICAgIGlmIChhWzBdID4gYlswXSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFbMF0gPCBiWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYVsxXS5pZCA+IGJbMV0uaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFbMV0uaWQgPCBiWzFdLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgbXlJdGVtcyA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG15SXRlbUJ1bmRsZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBteUl0ZW1zLnB1c2gobXlJdGVtQnVuZGxlc1tpXVsxXSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5saXN0cy5wdXNoKFt0aGlzLmJhc2UsIG15SXRlbXNdKTtcbiAgICAgICAgdGhpcy5JdGVtID0gdGhpcy5saXN0c1swXVsxXVswXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLkl0ZW0gPSB0aGlzLnN0YXRlLnJldHJpZXZlSXRlbShcIlwiICsgbXlJZHNbMF0pO1xuICAgIH1cbiAgICB0aGlzLm1vZGVpbmRleCA9IDA7XG4gICAgaWYgKHRoaXMuc3RhdGUuY2l0YXRpb24ub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC1uYW1lc1wiXSB8fCB0cnVlKSB7XG4gICAgICAgIHRoaXMubmFtZXNNYXggPSB0aGlzLm1heE5hbWVzQnlJdGVtSWRbdGhpcy5JdGVtLmlkXVswXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgbmFtZXNNYXggPSB0aGlzLmJhc2UubmFtZXNbMF07XG4gICAgICAgIGZvciAodmFyIGk9MSxpbGVuPXRoaXMuYmFzZS5uYW1lcy5sZW5ndGg7aTxpbGVuO2krPTEpe1xuICAgICAgICAgICAgbmFtZXNNYXggPSBNYXRoLm1heChuYW1lc01heCx0aGlzLmJhc2UubmFtZXMubmFtZXNbaV0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMucGFkQmFzZSh0aGlzLmJhc2UpO1xuICAgIHRoaXMucGFkQmFzZSh0aGlzLmJldHRlcmJhc2UpO1xuICAgIHRoaXMuYmFzZS55ZWFyX3N1ZmZpeCA9IGZhbHNlO1xuICAgIHRoaXMuYmFzZS5kaXNhbWJpZ3VhdGUgPSBmYWxzZTtcbiAgICB0aGlzLmJldHRlcmJhc2UueWVhcl9zdWZmaXggPSBmYWxzZTtcbiAgICB0aGlzLmJldHRlcmJhc2UuZGlzYW1iaWd1YXRlID0gZmFsc2U7XG4gICAgaWYgKHRoaXMuc3RhdGUuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0gPT09IFwiYnktY2l0ZVwiXG4gICAgICAgJiYgdGhpcy5zdGF0ZS5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiXSkge1xuICAgICAgICB0aGlzLmdpdmVuc01heCA9IDI7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufTtcbkNTTC5EaXNhbWJpZ3VhdGlvbi5wcm90b3R5cGUucGFkQmFzZSA9IGZ1bmN0aW9uIChiYXNlKSB7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBiYXNlLm5hbWVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAoIWJhc2UuZ2l2ZW5zW2ldKSB7XG4gICAgICAgICAgICBiYXNlLmdpdmVuc1tpXSA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGo9MCxqbGVuPWJhc2UubmFtZXNbaV07ajxqbGVuO2orPTEpIHtcbiAgICAgICAgICAgIGlmICghYmFzZS5naXZlbnNbaV1bal0pIHtcbiAgICAgICAgICAgICAgICBiYXNlLmdpdmVuc1tpXVtqXSA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLmNvbmZpZ01vZGVzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBkYWdvcHQsIGdkcm9wdDtcbiAgICB0aGlzLm1vZGVzID0gW107XG4gICAgZGFnb3B0ID0gdGhpcy5zdGF0ZS5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiXTtcbiAgICBnZHJvcHQgPSB0aGlzLnN0YXRlLmNpdGF0aW9uLm9wdFtcImdpdmVubmFtZS1kaXNhbWJpZ3VhdGlvbi1ydWxlXCJdO1xuICAgIGlmICh0aGlzLnN0YXRlLm9wdFsnZGlzYW1iaWd1YXRlLWFkZC1uYW1lcyddIHx8IChkYWdvcHQgJiYgZ2Ryb3B0ID09PSBcImJ5LWNpdGVcIikpIHtcbiAgICAgICAgdGhpcy5tb2Rlcy5wdXNoKFwiZGlzTmFtZXNcIik7XG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXRlLm9wdC5oYXNfZGlzYW1iaWd1YXRlKSB7XG4gICAgICAgIHRoaXMubW9kZXMucHVzaChcImRpc0V4dHJhVGV4dFwiKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RhdGUub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC15ZWFyLXN1ZmZpeFwiXSkge1xuICAgICAgICB0aGlzLm1vZGVzLnB1c2goXCJkaXNZZWFyc1wiKTtcbiAgICB9XG59O1xuQ1NMLkRpc2FtYmlndWF0aW9uLnByb3RvdHlwZS5nZXRDaXRlRGF0YSA9IGZ1bmN0aW9uKEl0ZW0sIGJhc2UpIHtcbiAgICBpZiAoIXRoaXMubWF4TmFtZXNCeUl0ZW1JZFtJdGVtLmlkXSkge1xuICAgICAgICBDU0wuZ2V0QW1iaWd1b3VzQ2l0ZS5jYWxsKHRoaXMuc3RhdGUsIEl0ZW0sIGJhc2UpO1xuICAgICAgICBiYXNlID0gQ1NMLmdldEFtYmlnQ29uZmlnLmNhbGwodGhpcy5zdGF0ZSk7XG4gICAgICAgIHRoaXMubWF4TmFtZXNCeUl0ZW1JZFtJdGVtLmlkXSA9IENTTC5nZXRNYXhWYWxzLmNhbGwodGhpcy5zdGF0ZSk7XG4gICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZ2l2ZW5zID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zLnNsaWNlKCk7XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZ2l2ZW5zLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5naXZlbnNbaV0gPSB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbaV0uc2xpY2UoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5hbWVzZXRzTWF4ID0gdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5uYW1lcy5sZW5ndGggLSAxO1xuICAgICAgICBpZiAoIXRoaXMuYmFzZSkge1xuICAgICAgICAgICAgdGhpcy5iYXNlID0gYmFzZTtcbiAgICAgICAgICAgIHRoaXMuYmV0dGVyYmFzZSA9IENTTC5jbG9uZUFtYmlnQ29uZmlnKGJhc2UpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChiYXNlLm5hbWVzLmxlbmd0aCA8IHRoaXMuYmFzZS5uYW1lcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuYmFzZSA9IGJhc2U7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHVwZGF0ZSA9IGZhbHNlO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGJhc2UubmFtZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBpZiAoYmFzZS5uYW1lc1tpXSA+IHRoaXMuYmFzZS5uYW1lc1tpXSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZS5naXZlbnNbaV0gPSBiYXNlLmdpdmVuc1tpXS5zbGljZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZS5uYW1lc1tpXSA9IGJhc2UubmFtZXNbaV07XG4gICAgICAgICAgICAgICAgdGhpcy5iZXR0ZXJiYXNlLm5hbWVzID0gdGhpcy5iYXNlLm5hbWVzLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5iZXR0ZXJiYXNlLmdpdmVucyA9IHRoaXMuYmFzZS5naXZlbnMuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBhZEJhc2UodGhpcy5iYXNlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBhZEJhc2UodGhpcy5iZXR0ZXJiYXNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmJldHRlcmJhc2UuZ2l2ZW5zID0gdGhpcy5iYXNlLmdpdmVucy5zbGljZSgpO1xuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IHRoaXMuYmFzZS5naXZlbnMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICB0aGlzLmJldHRlcmJhc2UuZ2l2ZW5zW2pdID0gdGhpcy5iYXNlLmdpdmVuc1tqXS5zbGljZSgpO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5EaXNhbWJpZ3VhdGlvbi5wcm90b3R5cGUuY2FwdHVyZVN0ZXBUb0Jhc2UgPSBmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5zdGF0ZS5jaXRhdGlvbi5vcHRbXCJnaXZlbm5hbWUtZGlzYW1iaWd1YXRpb24tcnVsZVwiXSA9PT0gXCJieS1jaXRlXCJcbiAgICAgICAgJiYgdGhpcy5iYXNlLmdpdmVucyAmJiB0aGlzLmJhc2UuZ2l2ZW5zLmxlbmd0aCkge1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIHRoaXMuYmFzZS5naXZlbnNbdGhpcy5nbmFtZXNldF1bdGhpcy5nbmFtZV0pIHtcbiAgICAgICAgICAgIHRoaXMuYmV0dGVyYmFzZS5naXZlbnNbdGhpcy5nbmFtZXNldF1bdGhpcy5nbmFtZV0gPSB0aGlzLmJhc2UuZ2l2ZW5zW3RoaXMuZ25hbWVzZXRdW3RoaXMuZ25hbWVdO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMuYmV0dGVyYmFzZS5uYW1lc1t0aGlzLmduYW1lc2V0XSA9IHRoaXMuYmFzZS5uYW1lc1t0aGlzLmduYW1lc2V0XTtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmdldEp1cmlzZGljdGlvbkxpc3QgPSBmdW5jdGlvbiAoanVyaXNkaWN0aW9uKSB7XG4gICAgdmFyIGp1cmlzZGljdGlvbkxpc3QgPSBbXTtcbiAgICB2YXIganVyaXNkaWN0aW9uRWxlbXMgPSBqdXJpc2RpY3Rpb24uc3BsaXQoXCI6XCIpO1xuICAgIGZvciAodmFyIGo9anVyaXNkaWN0aW9uRWxlbXMubGVuZ3RoO2o+MDtqLS0pIHtcbiAgICAgICAganVyaXNkaWN0aW9uTGlzdC5wdXNoKGp1cmlzZGljdGlvbkVsZW1zLnNsaWNlKDAsaikuam9pbihcIjpcIikpO1xuICAgIH1cbiAgICBpZiAoanVyaXNkaWN0aW9uTGlzdC5pbmRleE9mKFwidXNcIikgPT09IC0xKSB7XG4gICAgICAgIGp1cmlzZGljdGlvbkxpc3QucHVzaChcInVzXCIpO1xuICAgIH1cbiAgICByZXR1cm4ganVyaXNkaWN0aW9uTGlzdDtcbn1cbkNTTC5FbmdpbmUucHJvdG90eXBlLnJldHJpZXZlQWxsU3R5bGVNb2R1bGVzID0gZnVuY3Rpb24gKGp1cmlzZGljdGlvbkxpc3QpIHtcbiAgICB2YXIgcmV0ID0ge307XG4gICAgdmFyIHByZWZlcmVuY2VzID0gdGhpcy5sb2NhbGVbdGhpcy5vcHQubGFuZ10ub3B0c1tcImp1cmlzZGljdGlvbi1wcmVmZXJlbmNlXCJdO1xuICAgIHByZWZlcmVuY2VzID0gcHJlZmVyZW5jZXMgPyBwcmVmZXJlbmNlcyA6IFtdO1xuICAgIHByZWZlcmVuY2VzID0gW1wiXCJdLmNvbmNhdChwcmVmZXJlbmNlcyk7XG4gICAgZm9yICh2YXIgaT1wcmVmZXJlbmNlcy5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICB2YXIgcHJlZmVyZW5jZSA9IHByZWZlcmVuY2VzW2ldO1xuICAgICAgICBmb3IgKHZhciBqPTAsamxlbj1qdXJpc2RpY3Rpb25MaXN0Lmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICB2YXIganVyaXNkaWN0aW9uID0ganVyaXNkaWN0aW9uTGlzdFtqXTtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdC5qdXJpc2RpY3Rpb25zX3NlZW5banVyaXNkaWN0aW9uXSkgY29udGludWU7XG4gICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5zeXMucmV0cmlldmVTdHlsZU1vZHVsZShqdXJpc2RpY3Rpb24sIHByZWZlcmVuY2UpO1xuICAgICAgICAgICAgaWYgKCghcmVzICYmICFwcmVmZXJlbmNlKSB8fCByZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wdC5qdXJpc2RpY3Rpb25zX3NlZW5banVyaXNkaWN0aW9uXSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXJlcykgY29udGludWU7XG4gICAgICAgICAgICByZXRbanVyaXNkaWN0aW9uXSA9IHJlcztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuUGFydGljbGVMaXN0ID0gZnVuY3Rpb24oKSB7XG5cdHZhciBhbHdheXNfZHJvcHBpbmdfMSA9IFtbWzAsMV0sIG51bGxdXTtcblx0dmFyIGFsd2F5c19kcm9wcGluZ18yID0gW1tbMCwyXSwgbnVsbF1dO1xuXHR2YXIgYWx3YXlzX2Ryb3BwaW5nXzMgPSBbW1swLDNdLCBudWxsXV1cblx0dmFyIGFsd2F5c19ub25fZHJvcHBpbmdfMSA9IFtbbnVsbCwgWzAsMV1dXTtcblx0dmFyIGFsd2F5c19ub25fZHJvcHBpbmdfMiA9IFtbbnVsbCwgWzAsMl1dXTtcblx0dmFyIGFsd2F5c19ub25fZHJvcHBpbmdfMyA9IFtbbnVsbCwgWzAsM11dXTtcblx0dmFyIGVpdGhlcl8xID0gW1tudWxsLCBbMCwxXV0sW1swLDFdLG51bGxdXTtcblx0dmFyIGVpdGhlcl8yID0gW1tudWxsLCBbMCwyXV0sW1swLDJdLG51bGxdXTtcblx0dmFyIGVpdGhlcl8xX2Ryb3BwaW5nX2Jlc3QgPSBbW1swLDFdLG51bGxdLFtudWxsLCBbMCwxXV1dO1xuXHR2YXIgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdCA9IFtbWzAsMl0sbnVsbF0sW251bGwsIFswLDJdXV07XG5cdHZhciBlaXRoZXJfM19kcm9wcGluZ19iZXN0ID0gW1tbMCwzXSxudWxsXSxbbnVsbCwgWzAsM11dXTtcblx0dmFyIG5vbl9kcm9wcGluZ18yX2FsdF9kcm9wcGluZ18xX25vbl9kcm9wcGluZ18xID0gW1tudWxsLCBbMCwyXV0sIFtbMCwxXSwgWzEsMl1dXTtcblx0dmFyIFBBUlRJQ0xFUyA9IFtcblx0XHRbXCInc1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcIidzLVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcIid0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiYVwiLCBcdGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiYWFuICd0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYWFuIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYWFuIGRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImFhbiBkZXJcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJhYW4gaGV0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYWFuIHRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJhYW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJhZC1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImFkaC1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImFmXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJhbFwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYWwtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJhbSBkZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImFtXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiYW4tXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJhci1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImFzLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYXNoLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYXQtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJhdGgtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJhdWYgZGVtXCIsIGVpdGhlcl8yX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcImF1ZiBkZW5cIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1wiYXVmIGRlclwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJhdWYgdGVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYXVmXCIsIGVpdGhlcl8xX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcImF1cyAnbVwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJhdXMgZGVtXCIsIGVpdGhlcl8yX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcImF1cyBkZW5cIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1wiYXVzIGRlclwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJhdXMgbVwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJhdXNcIiwgZWl0aGVyXzFfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1wiYXVzJ21cIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1wiYXotXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJhxaEtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJh4biNLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYeG4jy1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImHhuaMtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJh4bmtLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYeG5ry1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImHhupMtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJiZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJiaWogJ3RcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJiaWogZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJiaWogZGVuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYmlqIGhldFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImJpaiB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYmlqXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiYmluXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiYm92ZW4gZFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImJvdmVuIGQnXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiZFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImQnXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkYVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGFsXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiZGFsJ1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImRhbGwnXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiZGFsbGFcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJkYXNcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRlIGRpZSBsZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzNdLFxuXHRcdFtcImRlIGRpZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImRlIGxcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJkZSBsJ1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImRlIGxhXCIsIG5vbl9kcm9wcGluZ18yX2FsdF9kcm9wcGluZ18xX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJkZSBsYXNcIiwgbm9uX2Ryb3BwaW5nXzJfYWx0X2Ryb3BwaW5nXzFfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImRlIGxlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiZGUgbGlcIiwgZWl0aGVyXzJdLFxuXHRcdFtcImRlIHZhbiBkZXJcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18zXSxcblx0XHRbXCJkZVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGUnXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkZWNhXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiZGVnbGlcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRlaVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGVsXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkZWxhXCIsIGFsd2F5c19kcm9wcGluZ18xXSxcblx0XHRbXCJkZWxsJ1wiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGVsbGFcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRlbGxlXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkZWxsb1wiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGVuXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkZXJcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRlc1wiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGlcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRpZSBsZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImRvXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiZG9uXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiZG9zXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkdVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZWQtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJlZGgtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJlbFwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZWwtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJlbi1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImVyLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZXMtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJlc2gtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJldC1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImV0aC1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImV6LVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZcWhLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZeG4jS1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImXhuI8tXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJl4bmjLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZeG5rS1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImXhua8tXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJl4bqTLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiaGV0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiaVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImlsXCIsIGFsd2F5c19kcm9wcGluZ18xXSxcblx0XHRbXCJpbVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImluICd0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiaW4gZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJpbiBkZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJpbiBkZXJcIiwgZWl0aGVyXzJdLFxuXHRcdFtcImluIGhldFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImluIHRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJpblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImxcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJsJ1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImxhXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wibGFzXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wibGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJsZXNcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImxvXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJsb3NcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJsb3VcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJvZlwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcIm9uZGVyICd0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib25kZXIgZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvbmRlciBkZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvbmRlciBoZXRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvbmRlciB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib25kZXJcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJvcCAndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcIm9wIGRlXCIsIGVpdGhlcl8yXSxcblx0XHRbXCJvcCBkZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvcCBkZXJcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvcCBnZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvcCBoZXRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvcCB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3AgdGVuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3BcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJvdmVyICd0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3ZlciBkZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcIm92ZXIgZGVuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3ZlciBoZXRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvdmVyIHRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvdmVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wic1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInMnXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wic2VuXCIsIGFsd2F5c19kcm9wcGluZ18xXSxcblx0XHRbXCJ0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ0ZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ0ZXJcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ0aG9cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ0aG9lXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widGhvclwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInRvXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widG9lXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widG90XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widWlqdCAndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInVpanQgZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ1aWp0IGRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInVpanQgdGUgZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18zXSxcblx0XHRbXCJ1aWp0IHRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInVpanRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ1aXQgJ3RcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ1aXQgZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ1aXQgZGVuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widWl0IGhldFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInVpdCB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widWl0IHRlIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfM10sXG5cdFx0W1widWl0IHRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInVpdFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInVudGVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widlwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInYuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widi5kLlwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInZhbiAndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZhbiBkZSBsXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfM10sXG5cdFx0W1widmFuIGRlIGwnXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfM10sXG5cdFx0W1widmFuIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widmFuIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widmFuIGRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZhbiBkZXJcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2YW4gZ2VuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widmFuIGhldFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZhbiBsYVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZhbiB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widmFuIHRlclwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZhbiB2YW4gZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18zXSxcblx0XHRbXCJ2YW5cIiwgZWl0aGVyXzFdLFxuXHRcdFtcInZhbmRlclwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInZkXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widmVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widm9tIHVuZCB6dW1cIiwgYWx3YXlzX2Ryb3BwaW5nXzNdLFxuXHRcdFtcInZvbVwiLCBlaXRoZXJfMV0sXG5cdFx0W1widm9uICd0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widm9uIGRlbVwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJ2b24gZGVuXCIsIGVpdGhlcl8yX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcInZvbiBkZXJcIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1widm9uIHRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2b24gdW5kIHp1XCIsIGVpdGhlcl8zX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcInZvbiB6dVwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJ2b25cIiwgZWl0aGVyXzFfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1widm9vciAndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZvb3IgZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2b29yIGRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZvb3IgaW4gJ3RcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18zXSxcblx0XHRbXCJ2b29yIGluIHRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18zXSxcblx0XHRbXCJ2b29yXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widm9yIGRlclwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJ2b3JcIiwgZWl0aGVyXzFfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1wielwiLCBhbHdheXNfZHJvcHBpbmdfMV0sXG5cdFx0W1wiemVcIiwgYWx3YXlzX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInp1XCIsIGVpdGhlcl8xX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcInp1bVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wienVyXCIsIGVpdGhlcl8xXVxuXHRdO1xuICAgIHJldHVybiBQQVJUSUNMRVM7XG59KCk7XG5DU0wucGFyc2VQYXJ0aWNsZXMgPSBmdW5jdGlvbigpe1xuICAgIGZ1bmN0aW9uIHNwbGl0UGFydGljbGVzKG5hbWVWYWx1ZSwgZmlyc3ROYW1lRmxhZywgY2FzZU92ZXJyaWRlKSB7XG5cdFx0dmFyIG9yaWdOYW1lVmFsdWUgPSBuYW1lVmFsdWU7XG5cdFx0bmFtZVZhbHVlID0gY2FzZU92ZXJyaWRlID8gbmFtZVZhbHVlLnRvTG93ZXJDYXNlKCkgOiBuYW1lVmFsdWU7XG5cdFx0dmFyIHBhcnRpY2xlTGlzdCA9IFtdO1xuXHRcdHZhciBhcG9zdHJvcGhlO1xuXHRcdHZhciByZXg7XG5cdFx0aWYgKGZpcnN0TmFtZUZsYWcpIHtcblx0XHRcdG5hbWVWYWx1ZSA9IG5hbWVWYWx1ZS5zcGxpdChcIlwiKS5yZXZlcnNlKCkuam9pbihcIlwiKTtcblx0XHRcdHJleCA9IENTTC5QQVJUSUNMRV9HSVZFTl9SRUdFWFA7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJleCA9IENTTC5QQVJUSUNMRV9GQU1JTFlfUkVHRVhQO1xuXHRcdH1cblx0XHR2YXIgbSA9IG5hbWVWYWx1ZS5tYXRjaChyZXgpO1xuXHRcdHdoaWxlIChtKSB7XG5cdFx0XHR2YXIgbTEgPSBmaXJzdE5hbWVGbGFnID8gbVsxXS5zcGxpdChcIlwiKS5yZXZlcnNlKCkuam9pbihcIlwiKSA6IG1bMV07XG5cdFx0XHR2YXIgZmlyc3RDaGFyID0gbSA/IG0xIDogZmFsc2U7XG5cdFx0XHR2YXIgZmlyc3RDaGFyID0gZmlyc3RDaGFyID8gbTEucmVwbGFjZSgvXlstXFwnXFx1MDJiYlxcdTIwMTlcXHNdKiguKS4qJC8sIFwiJDFcIikgOiBmYWxzZTtcblx0XHRcdHZhciBoYXNQYXJ0aWNsZSA9IGZpcnN0Q2hhciA/IGZpcnN0Q2hhci50b1VwcGVyQ2FzZSgpICE9PSBmaXJzdENoYXIgOiBmYWxzZTtcblx0XHRcdGlmICghaGFzUGFydGljbGUpIGJyZWFrO1xuXHRcdFx0aWYgKGZpcnN0TmFtZUZsYWcpIHtcblx0XHRcdFx0cGFydGljbGVMaXN0LnB1c2gob3JpZ05hbWVWYWx1ZS5zbGljZShtMS5sZW5ndGggKiAtMSkpO1xuXHRcdFx0XHRvcmlnTmFtZVZhbHVlID0gb3JpZ05hbWVWYWx1ZS5zbGljZSgwLG0xLmxlbmd0aCAqIC0xKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHBhcnRpY2xlTGlzdC5wdXNoKG9yaWdOYW1lVmFsdWUuc2xpY2UoMCxtMS5sZW5ndGgpKTtcblx0XHRcdFx0b3JpZ05hbWVWYWx1ZSA9IG9yaWdOYW1lVmFsdWUuc2xpY2UobTEubGVuZ3RoKTtcblx0XHRcdH1cblx0XHRcdG5hbWVWYWx1ZSA9IG1bMl07XG5cdFx0XHRtID0gbmFtZVZhbHVlLm1hdGNoKHJleCk7XG5cdFx0fVxuXHRcdGlmIChmaXJzdE5hbWVGbGFnKSB7XG5cdFx0XHRuYW1lVmFsdWUgPSBuYW1lVmFsdWUuc3BsaXQoXCJcIikucmV2ZXJzZSgpLmpvaW4oXCJcIik7XG5cdFx0XHRwYXJ0aWNsZUxpc3QucmV2ZXJzZSgpO1xuXHRcdFx0Zm9yICh2YXIgaT0xLGlsZW49cGFydGljbGVMaXN0Lmxlbmd0aDtpPGlsZW47aSsrKSB7XG5cdFx0XHRcdGlmIChwYXJ0aWNsZUxpc3RbaV0uc2xpY2UoMCwgMSkgPT0gXCIgXCIpIHtcblx0XHRcdFx0XHRwYXJ0aWNsZUxpc3RbaS0xXSArPSBcIiBcIjtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0Zm9yICh2YXIgaT0wLGlsZW49cGFydGljbGVMaXN0Lmxlbmd0aDtpPGlsZW47aSsrKSB7XG5cdFx0XHRcdGlmIChwYXJ0aWNsZUxpc3RbaV0uc2xpY2UoMCwgMSkgPT0gXCIgXCIpIHtcblx0XHRcdFx0XHRwYXJ0aWNsZUxpc3RbaV0gPSBwYXJ0aWNsZUxpc3RbaV0uc2xpY2UoMSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdG5hbWVWYWx1ZSA9IG9yaWdOYW1lVmFsdWUuc2xpY2UoMCwgbmFtZVZhbHVlLmxlbmd0aCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdG5hbWVWYWx1ZSA9IG9yaWdOYW1lVmFsdWUuc2xpY2UobmFtZVZhbHVlLmxlbmd0aCAqIC0xKTtcblx0XHR9XG5cdFx0cmV0dXJuIFtoYXNQYXJ0aWNsZSwgbmFtZVZhbHVlLCBwYXJ0aWNsZUxpc3RdO1xuXHR9XG4gICAgZnVuY3Rpb24gdHJpbUxhc3Qoc3RyKSB7XG4gICAgICAgIHZhciBsYXN0Q2hhciA9IHN0ci5zbGljZSgtMSk7XG4gICAgICAgIHN0ciA9IHN0ci50cmltKCk7XG4gICAgICAgIGlmIChsYXN0Q2hhciA9PT0gXCIgXCIgJiYgW1wiXFwnXCIsIFwiXFx1MjAxOVwiXS5pbmRleE9mKHN0ci5zbGljZSgtMSkpID4gLTEpIHtcbiAgICAgICAgICAgIHN0ciArPSBcIiBcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RyO1xuICAgIH1cbiAgICBmdW5jdGlvbiBwYXJzZVN1ZmZpeChuYW1lT2JqKSB7XG4gICAgICAgIGlmICghbmFtZU9iai5zdWZmaXggJiYgbmFtZU9iai5naXZlbikge1xuICAgICAgICAgICAgdmFyIG0gPSBuYW1lT2JqLmdpdmVuLm1hdGNoKC8oXFxzKiwhKlxccyopLyk7XG4gICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgIHZhciBpZHggPSBuYW1lT2JqLmdpdmVuLmluZGV4T2YobVsxXSk7XG4gICAgICAgICAgICAgICAgdmFyIHBvc3NpYmxlX3N1ZmZpeCA9IG5hbWVPYmouZ2l2ZW4uc2xpY2UoaWR4ICsgbVsxXS5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIHZhciBwb3NzaWJsZV9jb21tYSA9IG5hbWVPYmouZ2l2ZW4uc2xpY2UoaWR4LCBpZHggKyBtWzFdLmxlbmd0aCkucmVwbGFjZSgvXFxzKi9nLCBcIlwiKTtcbiAgICAgICAgICAgICAgICBpZiAocG9zc2libGVfc3VmZml4LnJlcGxhY2UoL1xcLi9nLCBcIlwiKSA9PT0gJ2V0IGFsJyAmJiAhbmFtZU9ialtcImRyb3BwaW5nLXBhcnRpY2xlXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVPYmpbXCJkcm9wcGluZy1wYXJ0aWNsZVwiXSA9IHBvc3NpYmxlX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICAgICAgbmFtZU9ialtcImNvbW1hLWRyb3BwaW5nLXBhcnRpY2xlXCJdID0gXCIsXCI7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlX2NvbW1hLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZU9ialtcImNvbW1hLXN1ZmZpeFwiXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbmFtZU9iai5zdWZmaXggPSBwb3NzaWJsZV9zdWZmaXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG5hbWVPYmouZ2l2ZW4gPSBuYW1lT2JqLmdpdmVuLnNsaWNlKDAsIGlkeCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZ1bmN0aW9uKG5hbWVPYmopIHtcbiAgICAgICAgdmFyIHJlcyA9IHNwbGl0UGFydGljbGVzKG5hbWVPYmouZmFtaWx5KTtcbiAgICAgICAgdmFyIGhhc0xhc3RQYXJ0aWNsZSA9IHJlc1swXTtcbiAgICAgICAgdmFyIGxhc3ROYW1lVmFsdWUgPSByZXNbMV07XG4gICAgICAgIHZhciBsYXN0UGFydGljbGVMaXN0ID0gcmVzWzJdO1xuICAgICAgICBuYW1lT2JqLmZhbWlseSA9IGxhc3ROYW1lVmFsdWU7XG4gICAgICAgIHZhciBub25Ecm9wcGluZ1BhcnRpY2xlID0gdHJpbUxhc3QobGFzdFBhcnRpY2xlTGlzdC5qb2luKFwiXCIpKTtcbiAgICAgICAgaWYgKG5vbkRyb3BwaW5nUGFydGljbGUpIHtcbiAgICAgICAgICAgIG5hbWVPYmpbJ25vbi1kcm9wcGluZy1wYXJ0aWNsZSddID0gbm9uRHJvcHBpbmdQYXJ0aWNsZTtcbiAgICAgICAgfVxuICAgICAgICBwYXJzZVN1ZmZpeChuYW1lT2JqKTtcbiAgICAgICAgdmFyIHJlcyA9IHNwbGl0UGFydGljbGVzKG5hbWVPYmouZ2l2ZW4sIHRydWUpO1xuICAgICAgICB2YXIgaGFzRmlyc3RQYXJ0aWNsZSA9IHJlc1swXTtcbiAgICAgICAgdmFyIGZpcnN0TmFtZVZhbHVlID0gcmVzWzFdO1xuICAgICAgICB2YXIgZmlyc3RQYXJ0aWNsZUxpc3QgPSByZXNbMl07XG4gICAgICAgIG5hbWVPYmouZ2l2ZW4gPSBmaXJzdE5hbWVWYWx1ZTtcbiAgICAgICAgdmFyIGRyb3BwaW5nUGFydGljbGUgPSBmaXJzdFBhcnRpY2xlTGlzdC5qb2luKFwiXCIpLnRyaW0oKTtcbiAgICAgICAgaWYgKGRyb3BwaW5nUGFydGljbGUpIHtcbiAgICAgICAgICAgIG5hbWVPYmpbJ2Ryb3BwaW5nLXBhcnRpY2xlJ10gPSBkcm9wcGluZ1BhcnRpY2xlO1xuICAgICAgICB9XG4gICAgfVxufSgpO1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG4iXSwic291cmNlUm9vdCI6IiJ9